"use strict";(self.webpackChunklongyu_website=self.webpackChunklongyu_website||[]).push([[4053],{3905:function(e,n,t){t.d(n,{Zo:function(){return p},kt:function(){return d}});var r=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function _(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},l=Object.keys(e);for(r=0;r<l.length;r++)t=l[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)t=l[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var E=r.createContext({}),c=function(e){var n=r.useContext(E),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=c(e.components);return r.createElement(E.Provider,{value:n},e.children)},a={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},u=r.forwardRef((function(e,n){var t=e.components,i=e.mdxType,l=e.originalType,E=e.parentName,p=_(e,["components","mdxType","originalType","parentName"]),u=c(t),d=i,b=u["".concat(E,".").concat(d)]||u[d]||a[d]||l;return t?r.createElement(b,o(o({ref:n},p),{},{components:t})):r.createElement(b,o({ref:n},p))}));function d(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var l=t.length,o=new Array(l);o[0]=u;var _={};for(var E in n)hasOwnProperty.call(n,E)&&(_[E]=n[E]);_.originalType=e,_.mdxType="string"==typeof e?e:i,o[1]=_;for(var c=2;c<l;c++)o[c]=t[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,t)}u.displayName="MDXCreateElement"},4437:function(e,n,t){t.r(n),t.d(n,{assets:function(){return p},contentTitle:function(){return E},default:function(){return d},frontMatter:function(){return _},metadata:function(){return c},toc:function(){return a}});var r=t(7462),i=t(3366),l=(t(7294),t(3905)),o=["components"],_={},E=void 0,c={permalink:"/longyu.github.io/blog/dpdk/I210 \u7f51\u5361\u8bbe\u5b9a force link mode \u5e76\u5173\u95ed EEE mode",editUrl:"https://github.com/longyuwlz/longyu.github.io/blog/dpdk/I210 \u7f51\u5361\u8bbe\u5b9a force link mode \u5e76\u5173\u95ed EEE mode.md",source:"@site/blog/dpdk/I210 \u7f51\u5361\u8bbe\u5b9a force link mode \u5e76\u5173\u95ed EEE mode.md",title:"dpdk/I210 \u7f51\u5361\u8bbe\u5b9a force link mode \u5e76\u5173\u95ed EEE mode",description:"\u524d\u8a00",date:"2022-06-21T00:32:49.000Z",formattedDate:"2022\u5e746\u670821\u65e5",tags:[],readingTime:3.94,truncated:!1,authors:[],frontMatter:{},prevItem:{title:"dpdk/Failed to mmap 2MB hugepages \u4e0e max_map_count limit",permalink:"/longyu.github.io/blog/dpdk/Failed to mmap 2MB hugepages \u4e0e max_map_count limit"},nextItem:{title:"dpdk/Unsupported SFP+ Module",permalink:"/longyu.github.io/blog/dpdk/Unsupported SFP+ Module"}},p={authorsImageUrls:[]},a=[{value:"\u524d\u8a00",id:"\u524d\u8a00",level:2},{value:"I210 \u624b\u518c\u4e2d\u7684\u76f8\u5173\u5185\u5bb9",id:"i210-\u624b\u518c\u4e2d\u7684\u76f8\u5173\u5185\u5bb9",level:2},{value:"igb pmd \u9a71\u52a8 igb_ethdev.c \u7684\u4fee\u6539",id:"igb-pmd-\u9a71\u52a8-igb_ethdevc-\u7684\u4fee\u6539",level:2},{value:"kni \u9a71\u52a8 e1000_82575.c \u4ee3\u7801\u7684\u4fee\u6539",id:"kni-\u9a71\u52a8-e1000_82575c-\u4ee3\u7801\u7684\u4fee\u6539",level:2},{value:"igb_ethtool.c \u7684\u4fee\u6539",id:"igb_ethtoolc-\u7684\u4fee\u6539",level:2},{value:"\u6d4b\u8bd5\u7ed3\u679c",id:"\u6d4b\u8bd5\u7ed3\u679c",level:2}],u={toc:a};function d(e){var n=e.components,t=(0,i.Z)(e,o);return(0,l.kt)("wrapper",(0,r.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h2",{id:"\u524d\u8a00"},"\u524d\u8a00"),(0,l.kt)("p",null,"\u5728\u5b9a\u4f4d I210 \u7f51\u5361\u63a5\u53e3\u9707\u8361\u95ee\u9898\u7684\u65f6\u5019\uff0c\u9605\u8bfb\u624b\u518c\u53d1\u73b0\u7f51\u5361\u652f\u6301\u8bbe\u5b9a force mode\uff0c\u7406\u89e3\u4e3a\u53ef\u4ee5\u5c06\u7f51\u5361\u8bbe\u5b9a\u4e3a\u5f3a\u5236 up \u72b6\u6001\uff0c\u540c\u65f6\u6000\u7591 eee \u8282\u80fd\u6a21\u5f0f\u5bfc\u81f4\u7f51\u5361\u4f11\u7720\u4ece\u800c\u53d1\u751f\u63a5\u53e3 down \u7684\u95ee\u9898\uff0c\u4e8e\u662f\u9700\u8981\u8bbe\u5b9a force mode \u4e3a up \u7684\u65f6\u5019\u540c\u65f6\u5173\u95ed eee \u8282\u80fd\u6a21\u5f0f\uff0c\u9700\u8981\u4fee\u6539 dpdk-16.04 \u4e2d\u7684\u90e8\u5206\u4ee3\u7801\u6765\u8fdb\u884c\u6d4b\u8bd5\u3002"),(0,l.kt)("h2",{id:"i210-\u624b\u518c\u4e2d\u7684\u76f8\u5173\u5185\u5bb9"},"I210 \u624b\u518c\u4e2d\u7684\u76f8\u5173\u5185\u5bb9"),(0,l.kt)("p",null,"I210 \u624b\u518c P107 \u9875\u63cf\u8ff0\u4e86\u8bbe\u5b9a force mode \u9700\u8981\u8bbe\u5b9a\u7684\u5bc4\u5b58\u5668\u5185\u5bb9\u4fe1\u606f\u6458\u5f55\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"}," Move to Force mode by setting the following bits:\n\u2014 CTRL.FD (CSR 0x0 bit 0) = 1b\n\u2014 CTRL.SLU (CSR 0x0 bit 6) = 1b\n\u2014 CTRL.RFCE (CSR 0x0 bit 27) = 0b\n\u2014 CTRL.TFCE (CSR 0x0 bit 28) = 0b\n\u2014 PCS_LCTL.FORCE_LINK (CSR 0X4208 bit 5) = 1b\n\u2014 PCS_LCTL.FSD (CSR 0x4208 bit 4) = 1b\n\u2014 PCS_LCTL.FDV (CSR 0x4208 bit 3) = 1b\n\u2014 PCS_LCTL.FLV (CSR 0x4208 bit 0) = 1b\n\u2014 PCS_LCTL.AN_ENABLE (CSR 0x4208 bit 16) = 0b\n")),(0,l.kt)("p",null,"dpdk-16.04 \u4e2d pmd \u4e0e kni \u5185\u6838\u9a71\u52a8\u540c\u65f6\u4f7f\u7528\uff0c\u9700\u8981\u786e\u5b9a\u8bbe\u5b9a\u771f\u5b9e\u751f\u6548\uff0c\u8fd9\u4e00\u70b9\u901a\u8fc7\u67e5\u770b\u5bc4\u5b58\u5668\u5185\u5bb9\u6765\u786e\u8ba4\u3002"),(0,l.kt)("h2",{id:"igb-pmd-\u9a71\u52a8-igb_ethdevc-\u7684\u4fee\u6539"},"igb pmd \u9a71\u52a8 igb_ethdev.c \u7684\u4fee\u6539"),(0,l.kt)("p",null,"\u901a\u8fc7\u4fee\u6539\u521d\u59cb\u5316\u903b\u8f91\u6765\u5b8c\u6210\uff0cpatch \u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c"},'Index: drivers/net/e1000/igb_ethdev.c\n===================================================================\n--- drivers/net/e1000/igb_ethdev.c\n+++ drivers/net/e1000/igb_ethdev.c\n@@ -1390,7 +1390,28 @@\n        }\n\n        e1000_setup_link(hw);\n+\n+    uint32_t ipcnfg, eeer;\n\n+    ipcnfg &= ~(E1000_IPCNFG_EEE_1G_AN | E1000_IPCNFG_EEE_100M_AN);\n+    eeer &= ~(E1000_EEER_TX_LPI_EN | E1000_EEER_RX_LPI_EN |\n+                  E1000_EEER_LPI_FC);\n+\n+    E1000_WRITE_REG(hw, E1000_IPCNFG, ipcnfg);\n+    E1000_WRITE_REG(hw, E1000_EEER, eeer);\n+\n+    uint32_t pcs_lctl;\n+    pcs_lctl = E1000_READ_REG(hw, E1000_PCS_LCTL);\n+    printf("current PCS_LCTL is %u\\n", pcs_lctl);\n+\n+    /* disable AN_ENABLE */\n+    pcs_lctl &= ~(E1000_PCS_LCTL_AN_ENABLE);\n+\n+    /* enable FORCE_LINK and  FORCE_LINK_UP */\n+    pcs_lctl |= E1000_PCS_LCTL_FORCE_LINK | E1000_PCS_LCTL_FLV_LINK_UP | E1000_PCS_LCTL_FSD;\n+    E1000_WRITE_REG(hw, E1000_PCS_LCTL, pcs_lctl);\n+     printf("after changed PCS_LCTL is %u\\n", E1000_READ_REG(hw, E1000_PCS_LCTL));\n+\n        if (rte_intr_allow_others(intr_handle)) {\n                /* check if lsc interrupt is enabled */\n                if (dev->data->dev_conf.intr_conf.lsc != 0)\n')),(0,l.kt)("h2",{id:"kni-\u9a71\u52a8-e1000_82575c-\u4ee3\u7801\u7684\u4fee\u6539"},"kni \u9a71\u52a8 e1000_82575.c \u4ee3\u7801\u7684\u4fee\u6539"),(0,l.kt)("p",null,"\u540c\u6837\u901a\u8fc7\u4fee\u6539\u521d\u59cb\u5316\u4ee3\u7801\u6765\u5b8c\u6210\uff0cpatch \u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c"},'Index: lib/librte_eal/linuxapp/kni/ethtool/igb/e1000_82575.c\n===================================================================\n--- lib/librte_eal/linuxapp/kni/ethtool/igb/e1000_82575.c\n+++ lib/librte_eal/linuxapp/kni/ethtool/igb/e1000_82575.c\n@@ -2802,6 +2802,7 @@\n        ipcnfg = E1000_READ_REG(hw, E1000_IPCNFG);\n        eeer = E1000_READ_REG(hw, E1000_EEER);\n\n+#if 0\n        /* enable or disable per user setting */\n        if (!(hw->dev_spec._82575.eee_disable)) {\n                u32 eee_su = E1000_READ_REG(hw, E1000_EEE_SU);\n@@ -2818,10 +2819,17 @@\n                eeer &= ~(E1000_EEER_TX_LPI_EN | E1000_EEER_RX_LPI_EN |\n                          E1000_EEER_LPI_FC);\n        }\n+#endif\n+\n+    \u3000\u3000ipcnfg &=  ~(E1000_IPCNFG_EEE_1G_AN | E1000_IPCNFG_EEE_100M_AN);\n+    \u3000\u3000eeer &= ~(E1000_EEER_TX_LPI_EN | E1000_EEER_RX_LPI_EN |\n+                   E1000_EEER_LPI_FC);\n+\n        E1000_WRITE_REG(hw, E1000_IPCNFG, ipcnfg);\n        E1000_WRITE_REG(hw, E1000_EEER, eeer);\n-       E1000_READ_REG(hw, E1000_IPCNFG);\n-       E1000_READ_REG(hw, E1000_EEER);\n+\n+    printk("after set ipcnfg is %x, eeer is %x\\n", E1000_READ_REG(hw, E1000_IPCNFG), E1000_READ_REG(hw, E1000_EEER));\n+\n')),(0,l.kt)("p",null,"\u6d4b\u8bd5\u53d1\u73b0 kni \u4e2d\u9ed8\u8ba4\u662f\u5f00\u542f eee \u6a21\u5f0f\u7684\uff0c\u6ce8\u91ca\u6389\u4e86\u5f00\u542f eee \u6a21\u5f0f\u7684\u4ee3\u7801\uff0c\u5e76\u6e05\u9664\u76f8\u5173\u5bc4\u5b58\u5668\u7684\u8bbe\u5b9a\uff0c\u91cd\u65b0\u8bbe\u5b9a\u540e\u4f7f\u7528 printk \u6253\u5370\u5bc4\u5b58\u5668\u5185\u5bb9\uff0c\u786e\u5b9a\u4fee\u6539\u751f\u6548\u3002"),(0,l.kt)("h2",{id:"igb_ethtoolc-\u7684\u4fee\u6539"},"igb_ethtool.c \u7684\u4fee\u6539"),(0,l.kt)("p",null,"\u4e3a\u4e86\u5728\u7a0b\u5e8f\u6267\u884c\u540e\u8fdb\u4e00\u6b65\u786e\u8ba4 force link mode \u8bbe\u5b9a\u6210\u529f\uff0c\u4e14 EEE mode \u6b63\u5e38\u5173\u95ed\uff0c\u5728 igb \u7f51\u5361\u83b7\u53d6\u5bc4\u5b58\u5668\u7684\u51fd\u6570\u4e2d\u6dfb\u52a0\u6253\u5370\uff0c\u6253\u5370\u51fa ipcnfg \u4e0e eeer \u5bc4\u5b58\u5668\u7684\u5185\u5bb9\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c"},'Index: lib/librte_eal/linuxapp/kni/ethtool/igb/igb_ethtool.c\n===================================================================\n--- lib/librte_eal/linuxapp/kni/ethtool/igb/igb_ethtool.c\n+++ lib/librte_eal/linuxapp/kni/ethtool/igb/igb_ethtool.c\n@@ -495,6 +495,8 @@\n        memset(p, 0, IGB_REGS_LEN * sizeof(u32));\n\n        regs->version = (1 << 24) | (hw->revision_id << 16) | hw->device_id;\n+\n+       printk("ipcnfg is %x, eeer is %x\\n", E1000_READ_REG(hw, E1000_IPCNFG), E1000_READ_REG(hw, E1000_EEER));\n\n        /* General Registers */\n        regs_buff[0] = E1000_READ_REG(hw, E1000_CTRL);\n')),(0,l.kt)("p",null,"\u7a0b\u5e8f\u8fd0\u884c\u540e\uff0c\u901a\u8fc7\u6267\u884c ethtool -d \u67e5\u770b ",(0,l.kt)("strong",{parentName:"p"},"PCS_LCTL \u5bc4\u5b58\u5668\u4e0e dmesg \u7684\u8f93\u51fa\u6765\u786e\u8ba4\u8bbe\u7f6e\u751f\u6548"),"\u3002"),(0,l.kt)("h2",{id:"\u6d4b\u8bd5\u7ed3\u679c"},"\u6d4b\u8bd5\u7ed3\u679c"),(0,l.kt)("p",null,"\u6d4b\u8bd5\u53d1\u73b0 force link mode up \u5e76\u4e0d\u50cf\u6211\u4eec\u60f3\u8c61\u7684\u80fd\u591f\u8ba9\u7f51\u5361\u4e00\u76f4\u5904\u4e8e up \u72b6\u6001\uff0c\u62d4\u4e86\u7f51\u7ebf\u540e\u4ecd\u65e7\u80fd\u591f\u53d8\u4e3a down\uff0c\u63a8\u6d4b\u5f3a\u5236\u7684\u5b9a\u4e49\u5e94\u8be5\u9488\u5bf9\u7684\u662f\u901f\u7387\u4e0e\u53cc\u5de5\u6a21\u5f0f\u3002"))}d.isMDXComponent=!0}}]);