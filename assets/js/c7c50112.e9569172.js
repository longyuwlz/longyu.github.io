"use strict";(self.webpackChunklongyu_website=self.webpackChunklongyu_website||[]).push([[7205],{3905:function(e,n,t){t.d(n,{Zo:function(){return u},kt:function(){return d}});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function m(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var p=a.createContext({}),i=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},u=function(e){var n=i(e.components);return a.createElement(p.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},s=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,p=e.parentName,u=m(e,["components","mdxType","originalType","parentName"]),s=i(t),d=r,g=s["".concat(p,".").concat(d)]||s[d]||c[d]||l;return t?a.createElement(g,o(o({ref:n},u),{},{components:t})):a.createElement(g,o({ref:n},u))}));function d(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,o=new Array(l);o[0]=s;var m={};for(var p in n)hasOwnProperty.call(n,p)&&(m[p]=n[p]);m.originalType=e,m.mdxType="string"==typeof e?e:r,o[1]=m;for(var i=2;i<l;i++)o[i]=t[i];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}s.displayName="MDXCreateElement"},5933:function(e,n,t){t.r(n),t.d(n,{assets:function(){return u},contentTitle:function(){return p},default:function(){return d},frontMatter:function(){return m},metadata:function(){return i},toc:function(){return c}});var a=t(7462),r=t(3366),l=(t(7294),t(3905)),o=["components"],m={},p=void 0,i={permalink:"/longyu.github.io/blog/dpdk/Failed to mmap 2MB hugepages \u4e0e max_map_count limit",editUrl:"https://github.com/longyuwlz/longyu.github.io/blog/dpdk/Failed to mmap 2MB hugepages \u4e0e max_map_count limit.md",source:"@site/blog/dpdk/Failed to mmap 2MB hugepages \u4e0e max_map_count limit.md",title:"dpdk/Failed to mmap 2MB hugepages \u4e0e max_map_count limit",description:"\u95ee\u9898\u63cf\u8ff0",date:"2022-06-21T00:32:49.000Z",formattedDate:"2022\u5e746\u670821\u65e5",tags:[],readingTime:5.305,truncated:!1,authors:[],frontMatter:{},nextItem:{title:"dpdk/I210 \u7f51\u5361\u8bbe\u5b9a force link mode \u5e76\u5173\u95ed EEE mode",permalink:"/longyu.github.io/blog/dpdk/I210 \u7f51\u5361\u8bbe\u5b9a force link mode \u5e76\u5173\u95ed EEE mode"}},u={authorsImageUrls:[]},c=[{value:"\u95ee\u9898\u63cf\u8ff0",id:"\u95ee\u9898\u63cf\u8ff0",level:2},{value:"\u8bbe\u5907\u5185\u5b58\u4fe1\u606f",id:"\u8bbe\u5907\u5185\u5b58\u4fe1\u606f",level:3},{value:"l2fwd \u8fd0\u884c\u62a5\u9519\u4fe1\u606f",id:"l2fwd-\u8fd0\u884c\u62a5\u9519\u4fe1\u606f",level:3},{value:"strace \u8ddf\u8e2a\u6269\u5927\u95ee\u9898\u8f93\u5165",id:"strace-\u8ddf\u8e2a\u6269\u5927\u95ee\u9898\u8f93\u5165",level:2},{value:"vm.max_map_count \u8bbe\u5b9a",id:"vmmax_map_count-\u8bbe\u5b9a",level:2},{value:"vm.max_map_count \u662f\u5e72\u561b\u7684\uff1f",id:"vmmax_map_count-\u662f\u5e72\u561b\u7684",level:2},{value:"dpdk-16.04 -m \u53c2\u6570\u7684\u539f\u7406",id:"dpdk-1604--m-\u53c2\u6570\u7684\u539f\u7406",level:2}],s={toc:c};function d(e){var n=e.components,t=(0,r.Z)(e,o);return(0,l.kt)("wrapper",(0,a.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h2",{id:"\u95ee\u9898\u63cf\u8ff0"},"\u95ee\u9898\u63cf\u8ff0"),(0,l.kt)("h3",{id:"\u8bbe\u5907\u5185\u5b58\u4fe1\u606f"},"\u8bbe\u5907\u5185\u5b58\u4fe1\u606f"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# free -h\n              total        used        free      shared  buff/cache   available\nMem:            15G        8.1G        7.0G         22M        512M        7.4G\nSwap:            0B          0B          0B\n")),(0,l.kt)("h3",{id:"l2fwd-\u8fd0\u884c\u62a5\u9519\u4fe1\u606f"},"l2fwd \u8fd0\u884c\u62a5\u9519\u4fe1\u606f"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# ./l2fwd  -m 64 -- -p0x1\ndpdk revision : 41333\nEAL: Detected lcore 0 as core 0 on socket 0\nEAL: Detected lcore 1 as core 1 on socket 0\nEAL: Detected lcore 2 as core 0 on socket 0\nEAL: Detected lcore 3 as core 1 on socket 0\nEAL: Support maximum 128 logical core(s) by configuration.\nEAL: Detected 4 lcore(s)\nEAL: Probing VFIO support...\nEAL: Module /sys/module/vfio_pci not found! error 2 (No such file or directory)\nEAL: VFIO modules not loaded, skipping VFIO support...\nEAL: Setting up child physically contiguous memory...\nEAL: map_all_hugepages(): mmap failed: Cannot allocate memory\nEAL: Failed to mmap 2 MB hugepages\nPANIC in rte_eal_init():\nCannot init memory\nAborted\n")),(0,l.kt)("p",null,"\u5173\u952e\u4fe1\u606f\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"EAL: map_all_hugepages(): mmap failed: Cannot allocate memory\nEAL: Failed to mmap 2 MB hugepages\n")),(0,l.kt)("p",null,"\u4ece\u8f93\u51fa\u4fe1\u606f\u770b\u95ee\u9898\u662f mmap \u6620\u5c04\u5927\u9875\u7684\u65f6\u5019\u5931\u8d25\u4e86\uff0c\u770b\u4e0d\u51fa\u5176\u5b83\u95ee\u9898\u3002"),(0,l.kt)("h2",{id:"strace-\u8ddf\u8e2a\u6269\u5927\u95ee\u9898\u8f93\u5165"},"strace \u8ddf\u8e2a\u6269\u5927\u95ee\u9898\u8f93\u5165"),(0,l.kt)("p",null,"strace \u8ddf\u8e2a\u786e\u8ba4\u95ee\u9898\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'open("/dev/hugepages/rtemap_3061", O_RDWR|O_CREAT, 0755) = 5\nmmap(0x17ea00000, 2097152, PROT_READ|PROT_WRITE, MAP_SHARED|MAP_POPULATE, 5, 0) = -1 ENOMEM (Cannot allocate memory)\n')),(0,l.kt)("p",null,"\u5728 mmap \u7b2c 3061 \u4e2a hugepage \u7684\u65f6\u5019\u62a5\u9519\uff0c\u6839\u672c\u95ee\u9898\u662f mmap \u6620\u5c04\u5931\u8d25\uff0c\u51fa\u9519 mmap \u7cfb\u7edf\u8c03\u7528\u7684\u8fd4\u56de\u503c\u662f ENOMEM\u3002"),(0,l.kt)("p",null,"man mmap \u627e\u5230\u4e0b\u9762\u8fd9\u4e9b\u4e0e ENOMEM \u76f8\u5173\u7684\u4fe1\u606f\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"       ENOMEM No memory is available.\n\n       ENOMEM The  process's  maximum  number  of mappings would have been exceeded.  This error can also occur for munmap(),\n              when unmapping a region in the middle of an existing mapping, since this results in two smaller mappings on ei\u2010\n              ther side of the region being unmapped.\n\n       ENOMEM (since Linux 4.7) The process's RLIMIT_DATA limit, described in getrlimit(2), would have been exceeded.\n")),(0,l.kt)("p",null,"\u4e0a\u9762\u7684\u4fe1\u606f\u63cf\u8ff0\u4e86\u5982\u4e0b\u4e09\u79cd\u4e0d\u540c\u7684\u95ee\u9898\uff1a"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u6ca1\u6709\u53ef\u7528\u5185\u5b58"),(0,l.kt)("li",{parentName:"ol"},"\u8d85\u8fc7\u4e86\u8fdb\u7a0b\u7684\u6700\u5927\u6620\u5c04\u6570\u76ee"),(0,l.kt)("li",{parentName:"ol"},"\u8d85\u8fc7\u4e86\u8fdb\u7a0b\u7684 RLIMIT_DATA \u9650\u5236")),(0,l.kt)("p",null,"ulimit \u67e5\u770b\u83b7\u53d6\u5230\u5982\u4e0b\u4fe1\u606f\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# ulimit -a\ncore file size          (blocks, -c) 0\ndata seg size           (kbytes, -d) unlimited\nscheduling priority             (-e) 0\nfile size               (blocks, -f) unlimited\npending signals                 (-i) 63812\nmax locked memory       (kbytes, -l) 64\nmax memory size         (kbytes, -m) unlimited\nopen files                      (-n) 1024\npipe size            (512 bytes, -p) 8\nPOSIX message queues     (bytes, -q) 819200\nreal-time priority              (-r) 0\nstack size              (kbytes, -s) 8192\ncpu time               (seconds, -t) unlimited\nmax user processes              (-u) 63812\nvirtual memory          (kbytes, -v) unlimited\nfile locks                      (-x) unlimited\n")),(0,l.kt)("p",null,"\u786e\u8ba4 ulimit \u6ca1\u6709\u76f8\u5173\u7684\u9650\u5236\u8bbe\u5b9a\u5185\u5bb9\u3002"),(0,l.kt)("h2",{id:"vmmax_map_count-\u8bbe\u5b9a"},"vm.max_map_count \u8bbe\u5b9a"),(0,l.kt)("p",null,"\u7ecf\u8fc7\u5927\u4f6c\u63d0\u9192\uff0c\u8fd9\u4e2a\u95ee\u9898\u53ef\u80fd\u4e0e vm.max_map_count \u8bbe\u5b9a\u6709\u5173\uff0c\u67e5\u770b\u7cfb\u7edf\u4e2d\u7684\u8bbe\u5b9a\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"# sysctl -a | grep vm.max_map_count\nvm.max_map_count = 3096\n")),(0,l.kt)("p",null,"\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u589e\u52a0 max_map_count \u503c\u540e\u91cd\u8bd5\uff0c\u95ee\u9898\u5f97\u5230\u89e3\u51b3\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"echo 65535 > /proc/sys/vm/max_map_count\n")),(0,l.kt)("p",null,"\u8fd9\u91cc\u7684\u95ee\u9898\u5b9e\u9645\u4e0a\u4e0e man mmap \u5f97\u5230\u7684\u4fe1\u606f\u4e2d\u5bf9 ENOMEM \u7684\u7b2c\u4e8c\u79cd\u89e3\u91ca\u7b26\u5408\uff0c\u53ea\u4e0d\u8fc7 manual \u4e2d\u6ca1\u6709\u76f4\u63a5\u6307\u51fa max_map_count \u7684\u9650\u5b9a\u3002"),(0,l.kt)("h2",{id:"vmmax_map_count-\u662f\u5e72\u561b\u7684"},"vm.max_map_count \u662f\u5e72\u561b\u7684\uff1f"),(0,l.kt)("p",null,"\u4ece\u5185\u6838 Documentation \u76ee\u5f55\u4e2d sysctl/vm.txt \u6587\u4ef6\u4e2d\u627e\u5230\u4e86\u4e0b\u9762\u8fd9\u4e9b\u63cf\u8ff0\u4fe1\u606f\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-man"},"max_map_count:\n\nThis file contains the maximum number of memory map areas a process\nmay have. Memory map areas are used as a side-effect of calling\nmalloc, directly by mmap and mprotect, and also when loading shared\nlibraries.\n\nWhile most applications need less than a thousand maps, certain\nprograms, particularly malloc debuggers, may consume lots of them,\ne.g., up to one or two maps per allocation.\n\nThe default value is 65536.\n")),(0,l.kt)("p",null,"\u8fd9\u4e2a max_map_count \u662f\u7528\u6765\u9650\u5b9a\u8fdb\u7a0b\u5185\u5b58 map \u533a\u57df\u7684\u6700\u5927\u6570\u91cf\uff0c\u6bcf\u6b21 mmap \u6210\u529f\u5185\u90e8\u7684 map_count \u90fd\u4f1a\u52a0 1\uff0c\u5f53\u5185\u90e8 mmap_count \u5927\u4e8e sysctl \u8bbe\u5b9a\u7684 max_count \u6570\u76ee\u65f6 mmap \u4f1a\u8fd4\u56de -ENOMEM\u3002"),(0,l.kt)("p",null,"mmap \u6d41\u7a0b\u4e2d\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c"},"        /* Too many mappings? */\n        if (mm->map_count > sysctl_max_map_count)\n                return -ENOMEM;\n")),(0,l.kt)("p",null,"\u540c\u65f6 munmap \u7684\u65f6\u5019\u4f1a\u5c06\u5185\u90e8\u7684 map_count \u51cf 1\uff0c\u800c\u8981\u6539\u53d8\u8fd9\u4e2a\u6570\u91cf\uff0c\u53ef\u4ee5\u901a\u8fc7 sysctl \u6765\u91cd\u65b0\u8bbe\u5b9a\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5199\u5165 /proc/sys/vm/max_map_count \u6587\u4ef6\u6765\u5b8c\u6210\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u8fd9\u4e2a\u9650\u5b9a\u662f\u5168\u5c40\u7684\uff0c\u4f1a\u5f71\u54cd\u6240\u6709\u7684\u8fdb\u7a0b\u3002"),(0,l.kt)("p",null,"\u5982\u679c\u9700\u8981\u6c38\u4e45\u751f\u6548\uff0c\u53ef\u4ee5\u5c06\u914d\u7f6e\u5199\u5165\u5230 /etc/sysctl.conf \u6587\u4ef6\u4e2d\u3002"),(0,l.kt)("h2",{id:"dpdk-1604--m-\u53c2\u6570\u7684\u539f\u7406"},"dpdk-16.04 -m \u53c2\u6570\u7684\u539f\u7406"),(0,l.kt)("p",null,"\u5728\u8fd9\u4e2a\u95ee\u9898\u4e2d\uff0cl2fwd \u547d\u4ee4\u8fd0\u884c\u53c2\u6570\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"./l2fwd  -m 64 -- -p0x1\n")),(0,l.kt)("p",null,"\u6307\u5b9a\u4e86 -m \u53c2\u6570\u9650\u5b9a\u6620\u5c04\u7684\u5927\u9875\u7a7a\u95f4\u4e3a 64M\uff0c\u6309\u7167\u4e00\u822c\u7684\u601d\u8def\u4e0d\u5e94\u8be5\u51fa\u8fd9\u79cd\u95ee\u9898\uff0c\u4f46\u5176\u5b9e\u5982\u679c\u8fdb\u4e00\u6b65\u7814\u7a76 16.04 hugepage \u6620\u5c04\u7684\u8fc7\u7a0b\uff0c\u80fd\u591f\u53d1\u73b0\u5982\u4e0b\u4fe1\u606f\uff1a"),(0,l.kt)("p",null,"dpdk-16.04 \u4f1a\u5728\u7a0b\u5e8f\u521d\u59cb\u5316\u7684\u65f6\u5019 map \u6240\u6709\u7684\u5927\u9875\uff0c\u8fd9\u4e2a\u884c\u4e3a\u6ca1\u6709\u53c2\u6570\u6765\u63a7\u5236\u3002-m \u53c2\u6570\u5b9e\u9645\u5728\u6620\u5c04\u6240\u6709\u5927\u9875\u7684\u884c\u4e3a\u4e4b\u540e\u5904\u7406\uff0c\u901a\u8fc7\u89e3\u9664\u8d85\u8fc7\u6570\u91cf\u7684\u6620\u5c04\u6765\u5b9e\u73b0\u3002"),(0,l.kt)("p",null,"\u8fd9\u4e2a\u5b9e\u73b0\u662f\u4e0d\u5408\u7406\u7684\uff0c\u542c\u8bf4\u9ad8\u7248\u672c\u5df2\u7ecf\u89e3\u51b3\u4e86\u8fd9\u4e2a\u95ee\u9898\uff0c\u9700\u8981\u7814\u7a76\u4e00\u4e0b\u3002"))}d.isMDXComponent=!0}}]);