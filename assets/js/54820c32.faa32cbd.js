"use strict";(self.webpackChunklongyu_website=self.webpackChunklongyu_website||[]).push([[9556],{3905:function(e,n,t){t.d(n,{Zo:function(){return c},kt:function(){return k}});var l=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);n&&(l=l.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,l)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function a(e,n){if(null==e)return{};var t,l,r=function(e,n){if(null==e)return{};var t,l,r={},o=Object.keys(e);for(l=0;l<o.length;l++)t=o[l],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(l=0;l<o.length;l++)t=o[l],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var u=l.createContext({}),p=function(e){var n=l.useContext(u),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},c=function(e){var n=p(e.components);return l.createElement(u.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return l.createElement(l.Fragment,{},n)}},s=l.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,u=e.parentName,c=a(e,["components","mdxType","originalType","parentName"]),s=p(t),k=r,f=s["".concat(u,".").concat(k)]||s[k]||d[k]||o;return t?l.createElement(f,i(i({ref:n},c),{},{components:t})):l.createElement(f,i({ref:n},c))}));function k(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,i=new Array(o);i[0]=s;var a={};for(var u in n)hasOwnProperty.call(n,u)&&(a[u]=n[u]);a.originalType=e,a.mdxType="string"==typeof e?e:r,i[1]=a;for(var p=2;p<o;p++)i[p]=t[p];return l.createElement.apply(null,i)}return l.createElement.apply(null,t)}s.displayName="MDXCreateElement"},1716:function(e,n,t){t.r(n),t.d(n,{assets:function(){return c},contentTitle:function(){return u},default:function(){return k},frontMatter:function(){return a},metadata:function(){return p},toc:function(){return d}});var l=t(7462),r=t(3366),o=(t(7294),t(3905)),i=["components"],a={},u=void 0,p={permalink:"/longyu.github.io/blog/dpdk/dpdk \u7a0b\u5e8f\u521b\u5efa kni \u865a\u62df\u7f51\u7edc\u63a5\u53e3\u5931\u8d25\u7684\u95ee\u9898",editUrl:"https://github.com/longyuwlz/longyu.github.io/blog/dpdk/dpdk \u7a0b\u5e8f\u521b\u5efa kni \u865a\u62df\u7f51\u7edc\u63a5\u53e3\u5931\u8d25\u7684\u95ee\u9898.md",source:"@site/blog/dpdk/dpdk \u7a0b\u5e8f\u521b\u5efa kni \u865a\u62df\u7f51\u7edc\u63a5\u53e3\u5931\u8d25\u7684\u95ee\u9898.md",title:"dpdk/dpdk \u7a0b\u5e8f\u521b\u5efa kni \u865a\u62df\u7f51\u7edc\u63a5\u53e3\u5931\u8d25\u7684\u95ee\u9898",description:"\u95ee\u9898\u63cf\u8ff0",date:"2022-06-20T23:48:14.000Z",formattedDate:"2022\u5e746\u670820\u65e5",tags:[],readingTime:4.495,truncated:!1,authors:[],frontMatter:{},prevItem:{title:"uio \u8bbe\u5907\u6587\u4ef6\u521b\u5efa\u7684\u95ee\u9898",permalink:"/longyu.github.io/blog/dpdk/dpdk \u5e38\u89c1\u95ee\u9898\uff1auio \u8bbe\u5907\u6587\u4ef6\u521b\u5efa\u4ee5\u53ca iommu \u5bfc\u81f4 x710 \u7f51\u5361\u521d\u59cb\u5316\u5931\u8d25\u95ee\u9898"},nextItem:{title:"dpdk/dpdk \u95ee\u9898\u6392\u67e5\u7684\u7b2c\u4e00\u5173\uff1a\u57fa\u7840\u73af\u5883\u7684\u6392\u67e5",permalink:"/longyu.github.io/blog/dpdk/dpdk \u95ee\u9898\u6392\u67e5\u7684\u7b2c\u4e00\u5173\uff1a\u57fa\u7840\u73af\u5883\u7684\u6392\u67e5"}},c={authorsImageUrls:[]},d=[{value:"\u95ee\u9898\u63cf\u8ff0",id:"\u95ee\u9898\u63cf\u8ff0",level:2},{value:"\u6392\u67e5\u8fc7\u7a0b",id:"\u6392\u67e5\u8fc7\u7a0b",level:2},{value:"\u662f\u5426\u6253\u5370\u7ea7\u522b\u7684\u95ee\u9898\uff1f",id:"\u662f\u5426\u6253\u5370\u7ea7\u522b\u7684\u95ee\u9898",level:2},{value:"\u5185\u6838\u4e0e\u7528\u6237\u6001\u95ee\u9898\u754c\u5b9a",id:"\u5185\u6838\u4e0e\u7528\u6237\u6001\u95ee\u9898\u754c\u5b9a",level:2},{value:"\u7528\u6237\u6001\u7a0b\u5e8f\u4e2d\u521b\u5efa kni \u53e3\u7684\u6d41\u7a0b",id:"\u7528\u6237\u6001\u7a0b\u5e8f\u4e2d\u521b\u5efa-kni-\u53e3\u7684\u6d41\u7a0b",level:2},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}],s={toc:d};function k(e){var n=e.components,t=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,l.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"\u95ee\u9898\u63cf\u8ff0"},"\u95ee\u9898\u63cf\u8ff0"),(0,o.kt)("p",null,"\u4eca\u5929\u63a5\u5230\u4e86\u540c\u4e8b\u7684\u4e00\u4e2a\u53cd\u9988\uff0c\u8bf4\u66f4\u65b0\u4e86 dpdk \u540e kni \u53e3\u65e0\u6cd5\u6b63\u5e38\u521b\u5efa\u3002\u6000\u7591\u53ef\u80fd\u662f rte_kni.ko \u6a21\u5757\u5b58\u5728\u95ee\u9898\u5bfc\u81f4\u521b\u5efa\u5931\u8d25\u3002"),(0,o.kt)("h2",{id:"\u6392\u67e5\u8fc7\u7a0b"},"\u6392\u67e5\u8fc7\u7a0b"),(0,o.kt)("p",null,"\u8fd0\u884c\u4ea7\u54c1\u7684 dpdk \u7a0b\u5e8f\u540e\u53d1\u73b0\u786e\u5b9e",(0,o.kt)("strong",{parentName:"p"},"\u6ca1\u6709\u521b\u5efa")," kni \u53e3\uff0c\u5e76\u4e14 dpdk \u7a0b\u5e8f\u5728\u4e0d\u65ad\u7684",(0,o.kt)("strong",{parentName:"p"},"\u91cd\u542f"),"\u3002"),(0,o.kt)("p",null,"\u4f7f\u7528 kni \u547d\u4ee4\u4e5f\u80fd\u591f\u590d\u73b0\u95ee\u9898\uff0c\u5728\u8fd9\u79cd\u57fa\u7840\u4e0a\uff0c\u9700\u8981\u6392\u67e5\u95ee\u9898\u51fa\u5728",(0,o.kt)("strong",{parentName:"p"},"\u5185\u6838\u8fd8\u662f\u7528\u6237\u6001\u7a0b\u5e8f"),"\u4e2d\u3002\u8fd9\u65f6\u6211\u60f3\u5230\u5728 kni \u53e3\u521b\u5efa\u8fc7\u7a0b\u4e2d\u5185\u6838\u4f1a\u6709\u4fe1\u606f\u6253\u5370\uff0c\u67e5\u770b dmesg \u4fe1\u606f\uff0c\u53d1\u73b0 ioctl \u7684\u8fc7\u7a0b\u6ca1\u6709\u4efb\u4f55\u76f8\u5173\u7684\u6253\u5370\u3002"),(0,o.kt)("h2",{id:"\u662f\u5426\u6253\u5370\u7ea7\u522b\u7684\u95ee\u9898"},"\u662f\u5426\u6253\u5370\u7ea7\u522b\u7684\u95ee\u9898\uff1f"),(0,o.kt)("p",null,"\u6ca1\u6709\u6253\u5370\u53ef\u80fd\u662f printk \u6253\u5370\u7ea7\u522b\u7684\u95ee\u9898\uff0c\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539 /proc/sys/kernel/printk \u6587\u4ef6\u6765\u89e3\u51b3\u3002manual \u4e2d\u76f8\u5173\u5185\u5bb9\u6458\u5f55\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'   /proc/sys/kernel/printk\n       /proc/sys/kernel/printk  is  a writable file containing four integer values that influence kernel printk() behavior when printing or logging error messages.  The\n       four values are:\n\n       console_loglevel\n              Only messages with a log level lower than this value will be printed to the console.  The default value for this field  is  DEFAULT_CONSOLE_LOGLEVEL  (7),\n              but  it  is set to 4 if the kernel command line contains the word "quiet", 10 if the kernel command line contains the word "debug", and to 15 in case of a\n              kernel fault (the 10 and 15 are just silly, and equivalent to 8).  The value of console_loglevel can be set (to a value in the range 1\u20138)  by  a  syslog()\n              call with a type of 8.\n\n       default_message_loglevel\n              This  value  will be used as the log level for printk() messages that do not have an explicit level.  Up to and including Linux 2.6.38, the hard-coded de\u2010\n              fault value for this field was 4 (KERN_WARNING); since Linux 2.6.39, the default value is a defined by the kernel configuration option CONFIG_DEFAULT_MES\u2010\n              SAGE_LOGLEVEL, which defaults to 4.\n\n       minimum_console_loglevel\n              The value in this field is the minimum value to which console_loglevel can be set.\n\n       default_console_loglevel\n              This is the default value for console_loglevel.\n')),(0,o.kt)("p",null,"\u91cd\u8981\u7684\u4e1c\u897f\u5728\u4e8e console_loglevel \u8fd9\u4e2a\u5b57\u6bb5\uff0c\u53ea\u6709\u5f53\u6d88\u606f\u7684\u65e5\u5fd7\u7ea7\u522b\u4f4e\u4e8e\u8fd9\u4e2a\u503c\u624d\u4f1a\u6253\u5370\uff0c\u6211\u5c06\u8fd9\u4e2a\u503c\u8c03\u9ad8\u5230 7 \u540e\u91cd\u65b0\u6267\u884c\u7a0b\u5e8f\u53d1\u73b0\u8fd8\u662f\u6ca1\u6709\u6253\u5370\uff0c\u4fee\u6539\u4e86 kni \u4e2d\u521b\u5efa\u865a\u62df\u7f51\u7edc\u63a5\u53e3\u7684\u4ee3\u7801\uff0c\u91cd\u65b0\u6d4b\u8bd5\u53d1\u73b0\u4e5f\u6ca1\u6709\u6253\u5370\uff0c\u786e\u5b9a\u662f\u6ca1\u6709\u8c03\u7528\u5230\u3002"),(0,o.kt)("h2",{id:"\u5185\u6838\u4e0e\u7528\u6237\u6001\u95ee\u9898\u754c\u5b9a"},"\u5185\u6838\u4e0e\u7528\u6237\u6001\u95ee\u9898\u754c\u5b9a"),(0,o.kt)("p",null,"\u6839\u636e\u4e0a\u9762\u7684\u7ed3\u679c\uff0c\u6211\u6ca1\u6709\u754c\u5b9a\u51fa\u95ee\u9898\u5230\u5e95\u51fa\u5728\u5185\u6838\u4e2d\u8fd8\u662f\u7528\u6237\u6001\u7a0b\u5e8f\u4e2d\uff0c\u6211\u5bf9 kni \u53e3\u521b\u5efa\u7684\u8fc7\u7a0b\u6bd4\u8f83\u6e05\u695a\uff0c\u77e5\u9053\u8fd9\u4e2a\u662f\u7528\u6237\u6001\u7a0b\u5e8f\u4e2d\u8c03\u7528 ioctl \u53d1 IOCTL_CREATE \u5b50\u547d\u4ee4\u5230\u5185\u6838\u4e2d\uff0c\u8c03\u7528 kni_ioctl_create \u51fd\u6570\u6765\u5b8c\u6210\u7684\u3002"),(0,o.kt)("p",null,"\u90a3\u4e48\u6211\u8981\u754c\u5b9a\u95ee\u9898\u51fa\u5728\u54ea\u91cc\u5176\u5b9e\u5f88\u7b80\u5355\uff0c\u4f7f\u7528 strace \u8ddf\u8e2a\u7cfb\u7edf\u8c03\u7528\u5c31\u53ef\u4ee5\u4e86\u3002\u7528 strace \u8ddf\u8e2a\uff0c\u786e\u8ba4\u7a0b\u5e8f\u6ca1\u6709\u8c03\u7528\u5230 ioctl \u6765\u521b\u5efa kni \u53e3\uff0c\u786e\u5b9a\u95ee\u9898\u51fa\u5728\u7528\u6237\u6001\u3002"),(0,o.kt)("h2",{id:"\u7528\u6237\u6001\u7a0b\u5e8f\u4e2d\u521b\u5efa-kni-\u53e3\u7684\u6d41\u7a0b"},"\u7528\u6237\u6001\u7a0b\u5e8f\u4e2d\u521b\u5efa kni \u53e3\u7684\u6d41\u7a0b"),(0,o.kt)("p",null,"\u7528\u6237\u6001\u7a0b\u5e8f\u4e2d\u521b\u5efa kni \u63a5\u53e3\u7684\u6b65\u9aa4\u4e3b\u8981\u6709\u5982\u4e0b\u4e24\u6b65\uff1a"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"rte_kni_init \u521d\u59cb\u5316\u76f8\u5173\u6570\u636e\u7ed3\u6784"),(0,o.kt)("li",{parentName:"ol"},"rte_kni_alloc \u521b\u5efa kni \u865a\u62df\u63a5\u53e3")),(0,o.kt)("p",null,"dpdk-16.04 \u4e2d rte_kni_alloc \u4e2d\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"    snprintf(mz_name, sizeof(mz_name), RTE_MEMPOOL_OBJ_NAME,\n        pktmbuf_pool->name);\n    mz = rte_memzone_lookup(mz_name);\n    KNI_MEM_CHECK(mz == NULL);\n    dev_info.mbuf_va = mz->addr;\n    dev_info.mbuf_phys = mz->phys_addr;\n    ctx->pktmbuf_pool = pktmbuf_pool;\n    ctx->group_id = conf->group_id;\n    ctx->slot_id = slot->id;\n    ctx->mbuf_size = conf->mbuf_size;\n\n    ret = ioctl(kni_fd, RTE_KNI_IOCTL_CREATE, &dev_info);\n")),(0,o.kt)("p",null,"\u6000\u7591\u662f\u5728\u8fd9\u4e2a KNI_MEM_CHECK \u8fd9\u51fa\u4e86\u95ee\u9898\uff0c\u8fdb\u4e00\u6b65\u6392\u67e5\u786e\u8ba4\u4e86\u95ee\u9898\u786e\u5b9e\u662f mz \u4e3a NULL \u5bfc\u81f4\u6ca1\u6709\u8c03\u7528 ioctl \u5c31\u63d0\u524d\u7ec8\u6b62\u4e86\u3002\u81f3\u4e8e\u4e3a\u5565 rte_memzone_lookup \u6ca1\u6709\u627e\u5230 mz_name\uff0c\u539f\u56e0\u662f\u6ca1\u6709\u4eba\u521b\u5efa\u5b83\u3002"),(0,o.kt)("h2",{id:"\u603b\u7ed3"},"\u603b\u7ed3"),(0,o.kt)("p",null,"\u5728\u5206\u6790\u4e00\u4e2a\u95ee\u9898\u65f6\u9996\u5148\u8981\u5bf9\u95ee\u9898\u8fdb\u884c\u754c\u5b9a\uff0c\u754c\u5b9a\u95ee\u9898\u662f\u4e3a\u4e86\u7f29\u5c0f\u95ee\u9898\u7684\u8303\u56f4\u3002\u5728\u8fd9\u4e2a\u95ee\u9898\u4e2d\u5185\u6838\u4e0e\u7528\u6237\u6001\u5c31\u662f\u9700\u8981\u754c\u5b9a\u7684\u70b9\uff0c\u6ca1\u6709\u8fd9\u4e2a\u754c\u5b9a\u95ee\u9898\u5c31\u4e0d\u597d\u641e\u3002\u5176\u5b9e\u4e5f\u662f\u5728\u8fd9\u91cc\u8fdb\u884c\u4e86\u4e00\u4e2a 2 \u5206\u6cd5\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u53ef\u4ee5\u4e00\u76f4\u6267\u884c\u4e0b\u53bb\uff0c\u76f4\u5230\u89e3\u51b3\u4e86\u95ee\u9898\u3002"))}k.isMDXComponent=!0}}]);