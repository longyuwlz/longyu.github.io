"use strict";(self.webpackChunklongyu_website=self.webpackChunklongyu_website||[]).push([[1624],{2776:function(n){n.exports=JSON.parse('{"blogPosts":[{"id":"/dpdk/dpdk-kni\u4e0eethtool\u8bd5\u73a9\u95ee\u9898\u8bb0\u5f55","metadata":{"permalink":"/longyu.github.io/blog/dpdk/dpdk-kni\u4e0eethtool\u8bd5\u73a9\u95ee\u9898\u8bb0\u5f55","editUrl":"https://github.com/longyuwlz/longyu.github.io/blog/dpdk/dpdk-kni\u4e0eethtool\u8bd5\u73a9\u95ee\u9898\u8bb0\u5f55.md","source":"@site/blog/dpdk/dpdk-kni\u4e0eethtool\u8bd5\u73a9\u95ee\u9898\u8bb0\u5f55.md","title":"dpdk/dpdk-kni\u4e0eethtool\u8bd5\u73a9\u95ee\u9898\u8bb0\u5f55","description":"ethtool  \u80fd\u591f dump \u7f51\u5361\u7684\u5bc4\u5b58\u5668\uff0c\u67e5\u770b\u5176\u5b83\u7f51\u5361\u76f8\u5173\u7684\u4fe1\u606f\u3002\u5728 dpdk \u7a0b\u5e8f\u51fa\u73b0\u5f02\u5e38\u65f6\uff0c\u5e38\u5e38\u9700\u8981\u4f7f\u7528 ethtool \u83b7\u53d6\u7f51\u5361\u7684\u4e00\u4e9b\u4fe1\u606f\u6765\u5b9a\u4f4d\u95ee\u9898\u3002","date":"2022-06-19T07:40:00.000Z","formattedDate":"2022\u5e746\u670819\u65e5","tags":[],"readingTime":4.64,"truncated":false,"authors":[],"frontMatter":{},"nextItem":{"title":"dpdk/dpdk-pdump\u7f16\u8bd1\u8fd0\u884c","permalink":"/longyu.github.io/blog/dpdk/dpdk-pdump\u7f16\u8bd1\u8fd0\u884c"}},"content":"ethtool  \u80fd\u591f dump \u7f51\u5361\u7684\u5bc4\u5b58\u5668\uff0c\u67e5\u770b\u5176\u5b83\u7f51\u5361\u76f8\u5173\u7684\u4fe1\u606f\u3002\u5728 dpdk \u7a0b\u5e8f\u51fa\u73b0\u5f02\u5e38\u65f6\uff0c\u5e38\u5e38\u9700\u8981\u4f7f\u7528 ethtool \u83b7\u53d6\u7f51\u5361\u7684\u4e00\u4e9b\u4fe1\u606f\u6765\u5b9a\u4f4d\u95ee\u9898\u3002\\n\\n\u6211\u6700\u8fd1\u4e5f\u5c1d\u8bd5\u7528\u4e86\u7528 ethtool\uff0c\u4e2d\u95f4\u5374\u9047\u5230\u4e86\u5f88\u591a\u95ee\u9898\u3002**\u6211\u4f7f\u7528\u7684 dpdk \u7248\u672c\u662f 17.05\u3002**\\n\\n**\u7b2c\u4e00\u7c7b\u662f\u7f16\u8bd1\u76f8\u5173\u7684\u95ee\u9898\uff0c\u7b2c\u4e8c\u7c7b\u662f ethtool \u81ea\u8eab\u652f\u6301\u7f51\u5361\u7684\u95ee\u9898\u3002\u4e0b\u9762\u6211\u5c31\u4ece\u8fd9\u4e24\u65b9\u9762\u7684\u95ee\u9898\u5f00\u59cb\u63cf\u8ff0\u3002**\\n\\n## \u4f7f\u7528 ethtool \u65f6\u7684 .config \u914d\u7f6e\\ndpdk \u7684\u5b98\u65b9\u6587\u6863\u4e2d\u8bf4\u660e\uff0c\u8981\u4f7f\u7528 ethtool \u9700\u8981\u4f7f\u80fd KNI_KMOD_ETHTOOL \u529f\u80fd\u9879\u3002\u8fd9\u901a\u8fc7\u4fee\u6539 .config \u914d\u7f6e\u6587\u4ef6\u6765\u5b8c\u6210\u3002\u4fee\u6539\u5b8c\u6210\u4e4b\u540e\u91cd\u65b0\u7f16\u8bd1\u5373\u53ef\uff0c\u8fd9\u4e2a\u95ee\u9898\u76f8\u5bf9\u7b80\u5355\u3002\\n\\n\u6267\u884c\u4e86 kni \u7a0b\u5e8f\u4e4b\u540e\uff0c\u901a\u8fc7 ifconfig \u53ef\u4ee5\u770b\u5230\u591a\u51fa\u4e86\u4e00\u4e2a\u7f51\u5361\uff0c\u8fd9\u4e2a\u7f51\u5361\u5c31\u662f\u4e4b\u540e\u6211\u4f7f\u7528 ethtool \u6765\u67e5\u770b\u7684\u7f51\u5361\u786c\u4ef6\u3002\\n\\n## hugepage \u5185\u5b58\u4e0d\u8db3\u5bfc\u81f4 eal \u521d\u59cb\u5316\u5931\u8d25\u7684\u95ee\u9898\\n\u6267\u884c ifconfig \u547d\u4ee4\u770b\u5230\u591a\u51fa\u6765\u7684\u7f51\u5361\u4e4b\u540e\uff0c\u6211\u4ee5\u4e3a ethtool \u5c31\u80fd\u6b63\u5e38\u5de5\u4f5c\uff0c\u7ed3\u679c\u5b83\u5728\u542f\u52a8\u7684\u65f6\u5019\u5c31\u62a5\u4e86\u9519\uff0c\u9519\u8bef\u4fe1\u606f\u8868\u660e eal \u521d\u59cb\u5316\u5931\u8d25\u3002\\n\\n\u5177\u4f53\u7684\u62a5\u9519\u4fe1\u606f\u8868\u660e\u6ca1\u6709\u8db3\u591f\u7684 hugepage \u5185\u5b58\u4f7f\u7528\u3002\\n\\n\u6211\u731c\u662f\u56e0\u4e3a kni \u7a0b\u5e8f\u5c06\u6240\u6709\u7684 hugepage \u5185\u5b58\u5168\u90e8\u72ec\u5360\u9020\u6210\u4e86\u8fd9\u4e2a\u95ee\u9898\uff0c\u5c31\u4fee\u6539\u4e86 /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages \u6587\u4ef6\uff0c\u8fd9\u4e4b\u540e eal \u521d\u59cb\u5316\u8fd9\u4e00\u6b65\u6ca1\u6709\u62a5\u9519\uff0c\u4f46\u662f\u53c8\u51fa\u73b0\u4e86\u4e00\u4e2a\u65b0\u7684\u9519\u8bef\uff0c\u9519\u8bef\u5185\u5bb9\u5982\u4e0b\uff1a\\n\\n> Cannot create lock on \'/var/run/.rte_config\'. Is another primary process running?\\n\\n\u5728\u7f51\u4e0a\u641c\u7d22\u4e86\u4e0b\u8fd9\u4e2a\u95ee\u9898\uff0c\u6ca1\u6709\u53d1\u73b0\u4ec0\u4e48\u89e3\u51b3\u65b9\u6848\u3002\\n\\n## ethtool \u4e0d\u652f\u6301\u5f53\u524d\u7f51\u5361\\n\u5220\u9664 /var/run/.rte_config \u540e\u91cd\u65b0\u8fd0\u884c kni \u7a0b\u5e8f\uff0c\u6267\u884c ethtool \u547d\u4ee4\u540e\uff0cdmesg \u67e5\u770b\u7cfb\u7edf\u4fe1\u606f\u53d1\u73b0\u4e86\u5982\u4e0b\u5185\u5bb9\uff1a\\n\\n> Device not supported by ethtool\\n\\n\u8fd9\u4e2a\u4fe1\u606f\u8868\u9762\u4e0a\u770b\u6765\u662f\u8bf4 ethtool \u4e0d\u652f\u6301\u6211\u7684\u7f51\u5361\uff0c\u4f46\u662f\u6211\u4f7f\u7528\u7684\u662f e1000 \u7684\u7f51\u5361\u5440\uff0c\u6211\u60f3\u5e94\u8be5\u4e0d\u81f3\u4e8e\u4e0d\u652f\u6301\u5427\u3002\\n\\n\u4e3a\u4e86\u786e\u8ba4 ethtool \u662f\u5426\u652f\u6301\u6211\u7684\u7f51\u5361\uff0c\u6211\u4f7f\u7528 cscope \u5728\u6e90\u7801\u4e2d\u641c\u7d22 Device not supported by ethtool \u8fd9\u4e2a\u5b57\u7b26\u4e32\uff0c\u53d1\u73b0\u5b83\u662f\u5728 kni_misc.c \u4e2d\u7684 kni_ioctl_create \u51fd\u6570\u4e2d\u6253\u5370\u7684\u3002\u8fd9\u4e2a\u51fd\u6570\u4e2d\u4f1a\u7528\u83b7\u53d6\u5230\u7684\u5f53\u524d\u7f51\u5361\u4fe1\u606f\u67e5\u8be2\u4e24\u5f20\u8868\u2014\u2014ixgbe_pci_tbl \u4e0e igb_pci_tbl\u3002\\n\\n\u8fd9\u4e24\u5f20\u8868\u7684\u5185\u5bb9\u5982\u4e0b\uff1a\\n\\n```c\\nconst struct pci_device_id ixgbe_pci_tbl[] = {\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82598)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82598AF_DUAL_PORT)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82598AF_SINGLE_PORT)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82598AT)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82598AT2)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82598EB_CX4)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82598_CX4_DUAL_PORT)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82598_DA_DUAL_PORT)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82598_SR_DUAL_PORT_EM)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82598EB_XF_LR)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82598EB_SFP_LOM)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82598_BX)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82599_KX4)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82599_XAUI_LOM)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82599_KR)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82599_SFP)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82599_SFP_EM)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82599_KX4_MEZZ)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82599_CX4)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82599_BACKPLANE_FCOE)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82599_SFP_FCOE)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82599_T3_LOM)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82599_COMBO_BACKPLANE)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_X540T)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82599_SFP_SF2)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82599_LS)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82599EN_SFP)},\\n\\t{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_82599_QSFP_SF_QP)},\\n\\t/* required last entry */\\n\\t{0, }\\n};\\n\\nconst struct pci_device_id igb_pci_tbl[] = {\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_I354_BACKPLANE_1GBPS) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_I354_SGMII) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_I354_BACKPLANE_2_5GBPS) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_I210_COPPER) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_I210_FIBER) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_I210_SERDES) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_I210_SGMII) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_I210_COPPER_FLASHLESS) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_I210_SERDES_FLASHLESS) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_I211_COPPER) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_I350_COPPER) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_I350_FIBER) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_I350_SERDES) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_I350_SGMII) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82580_COPPER) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82580_FIBER) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82580_QUAD_FIBER) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82580_SERDES) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82580_SGMII) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82580_COPPER_DUAL) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_DH89XXCC_SGMII) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_DH89XXCC_SERDES) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_DH89XXCC_BACKPLANE) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_DH89XXCC_SFP) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82576) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82576_NS) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82576_NS_SERDES) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82576_FIBER) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82576_SERDES) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82576_SERDES_QUAD) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82576_QUAD_COPPER_ET2) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82576_QUAD_COPPER) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82575EB_COPPER) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82575EB_FIBER_SERDES) },\\n\\t{ PCI_VDEVICE(INTEL, E1000_DEV_ID_82575GB_QUAD_COPPER) },\\n\\t/* required last entry */\\n\\t{0, }\\n};\\n\\n```\\n\u6211\u4f7f\u7528 lspci \u547d\u4ee4\u67e5\u770b\u6211\u7684\u7f51\u5361\u578b\u53f7\uff0c\u5f97\u5230\u7684\u4fe1\u606f\u5982\u4e0b\uff1a\\n\\n>e1000 82545EM\\n\\n\u8fd9\u4e2a\u578b\u53f7\u5728 dpdk \u4e2d\u5bf9\u5e94\u7684\u5b8f\u662f E1000_DEV_82545EM\uff0c\u5e76\u4e0d\u5b58\u5728\u4e8e\u4e0a\u9762\u7684\u4e24\u5f20\u8868\u4e2d\uff0c\u8fd9\u8868\u660e ethtool \u786e\u5b9e\u4e0d\u652f\u6301\u6b64\u6b3e\u7f51\u5361\u3002\u4ece\u7b2c\u4e8c\u5f20\u8868\u4e2d\u6211\u53d1\u73b0 e1000 \u7f51\u5361\u662f\u4e00\u4e2a\u7cfb\u5217\uff0c\u5176\u4e2d\u6709\u5f88\u591a\u4e0d\u540c\u578b\u53f7\u7684\u7f51\u5361\uff0c\u8fd9\u662f\u6211\u4e4b\u524d\u6ca1\u6709\u610f\u8bc6\u5230\u7684\u95ee\u9898\u3002\\n\\n\u5176\u5b9e\u8fd9\u662f dpdk \u7684 rte_kni \u6a21\u5757\u4e0d\u652f\u6301\u8fd9\u4e2a\u7f51\u5361\uff0c\u5b98\u65b9\u9a71\u52a8\u662f\u652f\u6301\u7684\u3002"},{"id":"/dpdk/dpdk-pdump\u7f16\u8bd1\u8fd0\u884c","metadata":{"permalink":"/longyu.github.io/blog/dpdk/dpdk-pdump\u7f16\u8bd1\u8fd0\u884c","editUrl":"https://github.com/longyuwlz/longyu.github.io/blog/dpdk/dpdk-pdump\u7f16\u8bd1\u8fd0\u884c.md","source":"@site/blog/dpdk/dpdk-pdump\u7f16\u8bd1\u8fd0\u884c.md","title":"dpdk/dpdk-pdump\u7f16\u8bd1\u8fd0\u884c","description":"dpdk-pdump \u662f\u4ec0\u4e48","date":"2022-06-19T07:40:00.000Z","formattedDate":"2022\u5e746\u670819\u65e5","tags":[],"readingTime":4.57,"truncated":false,"authors":[],"frontMatter":{},"prevItem":{"title":"dpdk/dpdk-kni\u4e0eethtool\u8bd5\u73a9\u95ee\u9898\u8bb0\u5f55","permalink":"/longyu.github.io/blog/dpdk/dpdk-kni\u4e0eethtool\u8bd5\u73a9\u95ee\u9898\u8bb0\u5f55"},"nextItem":{"title":"dpdk/dpdk\u5e93\u6e90\u7801\u4e2d\u5305\u542b\u5185\u6838\u5934\u6587\u4ef6\u7684\u95ee\u9898","permalink":"/longyu.github.io/blog/dpdk/dpdk\u5e93\u6e90\u7801\u4e2d\u5305\u542b\u5185\u6838\u5934\u6587\u4ef6\u7684\u95ee\u9898"}},"content":"## dpdk-pdump \u662f\u4ec0\u4e48\\n\\n**dpdk-pdump \u662f dpdk \u63d0\u4f9b\u7684\u4e00\u4e2a\u5de5\u5177\u3002\u5b83\u53ef\u4ee5\u53ef\u4ee5\u4f5c\u4e3a secondary \u7a0b\u5e8f\u8fd0\u884c\uff0c\u80fd\u591f\u6355\u83b7 dpdk \u7684\u7aef\u53e3\u7684\u6570\u636e\u5305\u3002**\\n\\n## \u7f16\u8bd1 dpdk-pdump \\n\\n**dpdk-pdump** \u5de5\u5177\u7684\u6e90\u7801\u4f4d\u4e8e dpdk \u6e90\u7801\u6839\u76ee\u5f55\u4e0b\u7684 **./app/pdump** \u76ee\u5f55\u4e2d\uff0c\u4e0d\u9700\u8981\u50cf examples \u4e2d\u7684 demo \u4e00\u6837\u5355\u72ec\u7f16\u8bd1\uff0c\u5b83\u4f1a\u5728\u7f16\u8bd1 dpdk \u7684\u540c\u65f6\u4e5f\u88ab\u7f16\u8bd1\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u7f16\u8bd1\u751f\u6210\u7684 app \u76ee\u5f55\u4e2d\u627e\u5230\u8fd9\u4e2a\u7a0b\u5e8f\u3002\\n\\n\u5728\u6211\u7684\u865a\u62df\u673a\u4e2d\uff0c\u7f16\u8bd1 dpdk \u540e\uff0c\u5b83\u7684\u4f4d\u7f6e\u5982\u4e0b\uff1a\\n\\n>/home/longyu/dpdk-stable-17.05.2/x86_64-native-linuxapp-gcc/app/dpdk-pdump\\n\\n## \u4f7f\u7528 dpdk-pdump \\n**dpdk-pdump \u7684\u7528\u6cd5\u5982\u4e0b\uff1a**\\n\\n```bash\\nusage: ./dpdk-pdump [EAL options] -- --pdump \'(port=<port id> | device_id=<pci id or vdev name>),(queue=<queue_id>),(rx-dev=<iface or pcap file> | tx-dev=<iface or pcap file>,[ring-size=<ring size>default:16384],[mbuf-size=<mbuf data size>default:2176],[total-num-mbufs=<number of mbufs>default:65535]\' [--server-socket-path=<server socket dir>default:/var/run/.dpdk/ (or) ~/.dpdk/] [--client-socket-path=<client socket dir>default:/var/run/.dpdk/ (or) ~/.dpdk/]\\n```\\n\\n**dpdk-pdump** \u9700\u8981\u4f9d\u8d56\u4e00\u4e2a **dpdk primary** \u8fdb\u7a0b\uff0c\u6211\u5c31\u4ee5 **l2fwd** \u547d\u4ee4\u4f5c\u4e3a **dpdk primary** \u8fdb\u7a0b\u3002\\n\\n\u6709\u4e86 **dpdk primary** \u8fdb\u7a0b\u4e4b\u540e\uff0c\u6839\u636e\u6211\u7684\u73af\u5883\uff0c\u6211\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u884c\u542f\u52a8 dpdk-pdump\\n```bash\\n\\tsudo ./dpdk-pdump -n 4 -- --pdump \'port=0,queue=*,rx-dev=./rx-pcap\'\\n```\\n## no driver for pcap \u7684\u95ee\u9898\\n\\n\u6211\u7b2c\u4e00\u6b21\u6267\u884c\u4e0a\u9762\u7684\u547d\u4ee4\u65f6\u7a0b\u5e8f\u5f02\u5e38\u7ec8\u6b62\uff0c\u9519\u8bef\u4fe1\u606f\u5982\u4e0b\uff1a\\n\\n> EAL: no driver found for eth_pcap_rx_0\\n> EAL: Driver, cannot attach the device\\n\\n\u901a\u8fc7\u641c\u7d22\uff0c\u6211\u53d1\u73b0\u4e0a\u9762\u7684\u9519\u8bef\u662f\u56e0\u4e3a\u5728\u7f16\u8bd1 dpdk \u65f6\u6ca1\u6709\u542f\u7528 PCAP \u76f8\u5173\u7684\u529f\u80fd\u6240\u81f4\uff0c\u53c2\u8003\u94fe\u63a5\u5982\u4e0b\uff1a\\n\\n[dpdk-pdump-no-driver-found-for-net-pcap](https://stackoverflow.com/questions/44357995/dpdk-pdump-no-driver-found-for-net-pcap-rx-0)\\n\\n\u6839\u636e\u7f51\u9875\u4e2d\u7684\u56de\u7b54\u6211\u5bf9 **.config** \u6587\u4ef6\u505a\u4e86\u5982\u4e0b\u4fee\u6539\u4ee5\u4f7f\u80fd **PCAP** \u7684\u76f8\u5173\u529f\u80fd\uff1a\\n\\n```bash\\nlongyu@longyu-pc:~/dpdk-stable-17.05.2/x86_64-native-linuxapp-gcc$ grep \'PCAP\' .config\\n# Compile software PMD backed by PCAP files\\nCONFIG_RTE_LIBRTE_PMD_PCAP=y\\nCONFIG_RTE_PORT_PCAP=y\\n```\\n\u8fd9\u4e4b\u540e\u91cd\u65b0\u7f16\u8bd1\u540e\u7ee7\u7eed\u6d4b\u8bd5\uff0c\u8fd9\u4e2a\u95ee\u9898\u5f97\u5230\u4e86\u89e3\u51b3\uff0c\u53ef\u53c8\u9047\u5230\u4e86\u4e00\u4e2a\u65b0\u7684\u95ee\u9898\u3002\\n\\n## \u65e0\u6cd5\u4e0e primary server \u7aef\u901a\u4fe1\u7684\u95ee\u9898\\n\\n\u89e3\u51b3\u4e86 **pcap driver** \u7684\u95ee\u9898\u540e\uff0c\u6211\u91cd\u65b0\u6267\u884c **dpdk-pdump** \u65f6\u65b0\u7684\u62a5\u9519\u4fe1\u606f\u5982\u4e0b\uff1a\\n\\n> PDUMP: failed to send to server:No such file or directory,\\n> pdump_create_client_socket:702 PDUMP: client request for pdump\\n> enable/disable failed PDUMP: failed to send to server:No such file or\\n> directory, pdump_create_client_socket:702 PDUMP: client request for\\n> pdump enable/disable failed\\n\\n\u901a\u8fc7\u9605\u8bfb\u5b98\u65b9\u7f51\u9875\u4e2d\u7684\u8bf4\u660e\uff0c\u6211\u53d1\u73b0\u4e86\u95ee\u9898\u6240\u5728\u3002\u5b98\u65b9\u7684\u8bf4\u660e\u4e2d\u63d0\u5230 **dpdk-pdump** \u5de5\u5177\u53ea\u80fd\u4e0e\u521d\u59cb\u5316\u4e86 **packet capture framework** \u7684\u4e3b\u7a0b\u5e8f\u901a\u4fe1\uff0c\u800c **packet capture framework** \u7684\u521d\u59cb\u5316\u9700\u8981\u4fee\u6539\u7a0b\u5e8f\u7684\u6e90\u7801\u3002\\n\\n\u5728 dpdk \u63d0\u4f9b\u7684\u5de5\u5177\u4e2d\uff0c**testpmd** \u5de5\u5177\u7684\u6e90\u7801\u4e2d\u6dfb\u52a0\u4e86 **packet capture framework** \u7684\u521d\u59cb\u5316\u4ee3\u7801\uff0c\u6211\u67e5\u770b\u76f8\u5173\u4ee3\u7801\uff0c\u627e\u5230\u4e86\u5982\u4e0b\u6e90\u7801\u884c\uff1a\\n\\n```c\\n\\tdiag = rte_eal_init(argc, argv);\\n\\t    if (diag < 0)\\n\\t        rte_panic(\\"Cannot init EAL\\\\n\\");\\n\\t\\n\\t#ifdef RTE_LIBRTE_PDUMP\\n\\t    /* initialize packet capture framework */\\n\\t    rte_pdump_init(NULL);\\n\\t#endif\\n```\\n\u4e0a\u9762\u7684\u4ee3\u7801\u4f1a\u5728 **RTE_LIBRTE_PDUMP** \u5b8f\u5b9a\u4e49\u65f6\u6267\u884c **rte_pdump_init** \u51fd\u6570\u6765\u8fdb\u884c\u5fc5\u8981\u7684\u521d\u59cb\u5316\uff0c**RTE_LIBRTE_PDUMP** \u529f\u80fd\u5728 **.config** \u4e2d\u8fdb\u884c\u914d\u7f6e\uff0c\u9ed8\u8ba4\u4e3a\u5f00\u542f\u3002\\n\\n**.config** \u4e2d\u4e0e **RTE_LIBRTE_PDUMP** \u529f\u80fd\u76f8\u5173\u7684\u914d\u7f6e\u5982\u4e0b\uff1a\\n\\n```bash\\n\\t# Compile architecture we compile for. pdump library\\n\\tCONFIG_RTE_LIBRTE_PDUMP=y\\n```\\n\\n\u5f53\u4f7f\u7528\u80fd\u4e86\u8fd9\u4e2a\u53c2\u6570\u540e\uff0c\u7f16\u8bd1\u76ee\u5f55\u4e0b\u7684\u5934\u6587\u4ef6 **rte_config.h** \u4e2d\u4f1a\u5b9a\u4e49 **RTE_LIBRTE_PDUMP** \u5b8f\uff0c\u76f8\u5173\u7684\u4ee3\u7801\u5982\u4e0b\uff1a\\n\\n```c\\n\\t#undef RTE_LIBRTE_PDUMP\\n\\t#define RTE_LIBRTE_PDUMP 1\\n```\\n\u6211\u6309\u7167\u4e0a\u9762\u7684\u63cf\u8ff0\u4fee\u6539\u4e86 dpdk-pdump \u7a0b\u5e8f\u7684\u6e90\u7801\u540e\uff0c\u7ec8\u4e8e\u80fd\u591f\u6b63\u5e38\u6267\u884c\u4e86\uff01\\n\\n## \u67e5\u770b dump \u51fa\u7684\u6570\u636e\u5305\u6587\u4ef6\\n**dpdk-pdump** \u4e2d\u5df2\u7ecf\u5bf9 dump \u51fa\u7684\u539f\u59cb\u6570\u636e\u5305\u8fdb\u884c\u4e86\u8f6c\u5316\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 **tcpdump** \u7684 **-r** \u9009\u9879\u6765\u67e5\u770b\u751f\u6210\u7684\u6587\u4ef6\u3002\\n \\n \u6211\u6307\u5b9a **dpdk-pdump dump** \u7aef\u53e3\u63a5\u6536\u5230\u7684\u5305\uff0c\u6307\u5b9a\u5b58\u50a8\u6587\u4ef6\u4e3a **./rx-pcap**\u3002\u6211\u53ea\u9700\u8981\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5c31\u53ef\u4ee5\u770b\u5230\u63a5\u6536\u5230\u7684\u6570\u636e\u5305\u7684\u8be6\u7ec6\u4fe1\u606f\u3002\\n\\n```bash\\n \\tsudo tcpdump -r ./rx-pcap\\n```\\n\\n## \u603b\u7ed3\\n**dpdk \u63d0\u4f9b\u7684\u7a0b\u5e8f\u5728\u4f7f\u7528\u65f6\u53ef\u80fd\u4f1a\u9047\u5230\u4e00\u4e9b\u95ee\u9898\uff0c\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\u7684\u4e00\u822c\u6b65\u9aa4\u5982\u4e0b\uff1a**\\n\\n1. \u67e5\u770b\u4f9d\u8d56\u7684\u529f\u80fd\u662f\u5426\u5f00\u542f\uff08\u4fee\u6539 .config \u6587\u4ef6\uff09\\n2. \u4fee\u6539\u5fc5\u8981\u7684\u6e90\u4ee3\u7801\u4ee5\u6267\u884c\u5fc5\u8981\u7684\u521d\u59cb\u5316\u5de5\u4f5c\\n3. \u91cd\u65b0\u7f16\u8bd1\u540e\u518d\u6b21\u6267\u884c"},{"id":"/dpdk/dpdk\u5e93\u6e90\u7801\u4e2d\u5305\u542b\u5185\u6838\u5934\u6587\u4ef6\u7684\u95ee\u9898","metadata":{"permalink":"/longyu.github.io/blog/dpdk/dpdk\u5e93\u6e90\u7801\u4e2d\u5305\u542b\u5185\u6838\u5934\u6587\u4ef6\u7684\u95ee\u9898","editUrl":"https://github.com/longyuwlz/longyu.github.io/blog/dpdk/dpdk\u5e93\u6e90\u7801\u4e2d\u5305\u542b\u5185\u6838\u5934\u6587\u4ef6\u7684\u95ee\u9898.md","source":"@site/blog/dpdk/dpdk\u5e93\u6e90\u7801\u4e2d\u5305\u542b\u5185\u6838\u5934\u6587\u4ef6\u7684\u95ee\u9898.md","title":"dpdk/dpdk\u5e93\u6e90\u7801\u4e2d\u5305\u542b\u5185\u6838\u5934\u6587\u4ef6\u7684\u95ee\u9898","description":"\u95ee\u9898\u63cf\u8ff0","date":"2022-06-19T07:40:00.000Z","formattedDate":"2022\u5e746\u670819\u65e5","tags":[],"readingTime":1.415,"truncated":false,"authors":[],"frontMatter":{},"prevItem":{"title":"dpdk/dpdk-pdump\u7f16\u8bd1\u8fd0\u884c","permalink":"/longyu.github.io/blog/dpdk/dpdk-pdump\u7f16\u8bd1\u8fd0\u884c"},"nextItem":{"title":"dpdk/dpdk\u6536\u53d1\u5305\u6d4b\u8bd5\u4e4b\u4f7f\u7528\u5185\u6838\u63a5\u53e3\u7ed9dpdk\u7ed1\u5b9a\u7684\u7aef\u53e3\u53d1\u5305","permalink":"/longyu.github.io/blog/dpdk/dpdk\u6536\u53d1\u5305\u6d4b\u8bd5\u4e4b\u4f7f\u7528\u5185\u6838\u63a5\u53e3\u7ed9dpdk\u7ed1\u5b9a\u7684\u7aef\u53e3\u53d1\u5305"}},"content":"## \u95ee\u9898\u63cf\u8ff0\\ndpdk-16.04 \u4e2d\u7684 eal_vfio.h \u5934\u6587\u4ef6\u4e2d\u6709\u4e0b\u9762\u7684\u9884\u5904\u7406\u8bed\u53e5\uff1a\\n```c\\n#ifdef RTE_EAL_VFIO\\n#include <linux/version.h>\\n#if LINUX_VERSION_CODE >= KERNEL_VERSION(3, 6, 0)\\n#include <linux/vfio.h>\\n```\\n\u5728\u4e0d\u540c\u7684\u73af\u5883\u4e0a\u7f16\u8bd1\u65f6\u53d1\u73b0\u751f\u6210\u7684\u4ee3\u7801\u4e0d\u540c\u3002\u7814\u7a76\u4e86\u4e0b\u53d1\u73b0\u662f\u4e0a\u9762\u9884\u5904\u7406\u8bed\u53e5\u4e2d ```LINUX_VERSION_CODE```\u5224\u65ad\u7684\u95ee\u9898\u3002\\n\\n## \u5206\u6790\u9a8c\u8bc1\\n\u9a8c\u8bc1\u4e0d\u540c\u73af\u5883\u4e0a ```RTE_KERNEL```\u6307\u5b9a\u7684\u5185\u6838\u76ee\u5f55\u4e0b\u7684 ```linux/version.h```\u5934\u6587\u4ef6\uff0c\u53d1\u73b0\u662f\u76f8\u540c\u7684\u3002\\n\\n## \u771f\u6b63\u7684\u95ee\u9898\\n\u4e00\u5f00\u59cb\u6ca1\u6709\u60f3\u5230\u5934\u6587\u4ef6\u641c\u7d22\u8def\u5f84\u7684\u95ee\u9898\uff0c\u6700\u540e\u7ec8\u4e8e\u53d1\u73b0\u5e93\u51fd\u6570\u4e2d ```linux/version.h```\u5e76\u4e0d\u662f\u4ece ```RTE_KERNEL```\u6307\u5b9a\u7684\u5185\u6838\u6e90\u7801\u8def\u5f84\u4e2d\u641c\u7d22\u7684\uff0c\u800c\u662f\u4ece\u7f16\u8bd1\u673a\u5668\u4e0a\u7684 ```/usr/include/linux`` \u76ee\u5f55\u641c\u7d22\u7684\u3002\\n\\n\u5bf9\u6bd4\u4e0d\u540c\u73af\u5883\u4e0a\u7684 ```/usr/include/linux/version.h```\uff0c\u679c\u7136\u53d1\u73b0\u4e86\u4e00\u4e2a\u673a\u5668\u4e0a\u7684 ```version.h```\u7248\u672c\u4e0d\u5bf9\u3002\\n\\n\\n**\u8fd9\u91cc\u7684\u6ce8\u610f\u4e8b\u9879\u5982\u4e0b\uff1a**\\n\\n1. \u7f16\u8bd1 dpdk \u5185\u6838\u76f8\u5173 ko \u7684\u6e90\u6587\u4ef6\u65f6 linux/version.h \u662f\u4ece\u6307\u5b9a\u7684\u5185\u6838\u8def\u5f84\u4e0b\u9762\u641c\u7d22\\n2. \u7f16\u8bd1\u5e93\u51fd\u6570\u65f6\u5305\u542b\u7684 linux/version.h \u5934\u6587\u4ef6\u662f\u4ece\u7f16\u8bd1\u7cfb\u7edf\u4e0a\u7684 /usr/include/linux \u76ee\u5f55\u4e2d\u641c\u7d22\u7684\\n3. \u4e0d\u540c\u673a\u5668\u4e0a\u7684 /usr/include/linux \u8def\u5f84\u4e2d\u7684 version.h \u53ef\u80fd\u5b58\u5728\u5dee\u522b"},{"id":"/dpdk/dpdk\u6536\u53d1\u5305\u6d4b\u8bd5\u4e4b\u4f7f\u7528\u5185\u6838\u63a5\u53e3\u7ed9dpdk\u7ed1\u5b9a\u7684\u7aef\u53e3\u53d1\u5305","metadata":{"permalink":"/longyu.github.io/blog/dpdk/dpdk\u6536\u53d1\u5305\u6d4b\u8bd5\u4e4b\u4f7f\u7528\u5185\u6838\u63a5\u53e3\u7ed9dpdk\u7ed1\u5b9a\u7684\u7aef\u53e3\u53d1\u5305","editUrl":"https://github.com/longyuwlz/longyu.github.io/blog/dpdk/dpdk\u6536\u53d1\u5305\u6d4b\u8bd5\u4e4b\u4f7f\u7528\u5185\u6838\u63a5\u53e3\u7ed9dpdk\u7ed1\u5b9a\u7684\u7aef\u53e3\u53d1\u5305.md","source":"@site/blog/dpdk/dpdk\u6536\u53d1\u5305\u6d4b\u8bd5\u4e4b\u4f7f\u7528\u5185\u6838\u63a5\u53e3\u7ed9dpdk\u7ed1\u5b9a\u7684\u7aef\u53e3\u53d1\u5305.md","title":"dpdk/dpdk\u6536\u53d1\u5305\u6d4b\u8bd5\u4e4b\u4f7f\u7528\u5185\u6838\u63a5\u53e3\u7ed9dpdk\u7ed1\u5b9a\u7684\u7aef\u53e3\u53d1\u5305","description":"\u5982\u4f55\u4f7f\u7528\u5185\u6838\u63a5\u53e3\u7ed9 dpdk \u7ed1\u5b9a\u7684\u7aef\u53e3\u53d1\u5305","date":"2022-06-19T07:40:00.000Z","formattedDate":"2022\u5e746\u670819\u65e5","tags":[],"readingTime":1.045,"truncated":false,"authors":[],"frontMatter":{},"prevItem":{"title":"dpdk/dpdk\u5e93\u6e90\u7801\u4e2d\u5305\u542b\u5185\u6838\u5934\u6587\u4ef6\u7684\u95ee\u9898","permalink":"/longyu.github.io/blog/dpdk/dpdk\u5e93\u6e90\u7801\u4e2d\u5305\u542b\u5185\u6838\u5934\u6587\u4ef6\u7684\u95ee\u9898"},"nextItem":{"title":"dpdk/ethtool\u8bfb\u53d6\u5230\u7684kni\u8bbe\u5907\u72b6\u6001\u4e0edpdk\u8bfb\u5230\u7684\u7f51\u5361\u72b6\u6001\u4e0d\u4e00\u81f4","permalink":"/longyu.github.io/blog/dpdk/ethtool\u8bfb\u53d6\u5230\u7684kni\u8bbe\u5907\u72b6\u6001\u4e0edpdk\u8bfb\u5230\u7684\u7f51\u5361\u72b6\u6001\u4e0d\u4e00\u81f4"}},"content":"## \u5982\u4f55\u4f7f\u7528\u5185\u6838\u63a5\u53e3\u7ed9 dpdk \u7ed1\u5b9a\u7684\u7aef\u53e3\u53d1\u5305\\n\u6700\u8fd1\u4e00\u6b21\u6d4b\u8bd5\u4e2d\uff0c\u9700\u8981\u901a\u8fc7\u5185\u6838\u63a5\u53e3\u7ed9 dpdk \u7ed1\u5b9a\u7684\u7aef\u53e3\u53d1\u5305\u8fdb\u884c\u6d4b\u8bd5\uff0c\u5177\u4f53\u7684\u6d4b\u8bd5\u65b9\u6cd5\u89c1\u4e0b\u6587\u3002\\n\\n## \u786c\u4ef6\u8fde\u63a5\\n\u4e24\u4e2a\u7f51\u5361\u7684\u7aef\u53e3\u8fde\u63a5\u5230\u4e00\u8d77\u3002\\n## \u8f6f\u4ef6\u914d\u7f6e\\n\u4e00\u4e2a\u53e3\u7ed1\u5b9a\u5230\u5185\u6838\u9a71\u52a8\uff0c\u4e00\u4e2a\u53e3\u7ed1\u5b9a igb_uio \u9a71\u52a8\u3002\u7ed1\u5b9a\u5230 igb_uio \u7684\u7f51\u5361\u7aef\u53e3\uff0c\u4f7f\u7528 l2fwd \u7a0b\u5e8f\u6765\u6536\u53d1\u5305\u3002\\n## \u901a\u8fc7\u6307\u5b9a\u7684\u7aef\u53e3\u53d1\u5305\\nping \u547d\u4ee4\u7684 -I \u9009\u9879\u652f\u6301\u6307\u5b9a\u6536\u53d1\u5305\u7684 netdev \u7aef\u53e3\u3002\\n\\n\u4f7f\u7528 ping -I eth0 192.234.234.23 \u5c31\u53ef\u4ee5\u4ece eth0 \u53e3\u5c06\u6570\u636e\u5305\u53d1\u9001\u51fa\u53bb\u3002\u8fd9\u91cc\u7684 eth0 \u53e3\u5c31\u662f\u4e0a\u9762\u6211\u4eec\u7ed1\u5b9a\u5230\u5185\u6838\u9a71\u52a8\u4e0a\u9762\u7684\u53e3\u3002\u7531\u4e8e\u786c\u4ef6\u8fde\u63a5\u5230\u4e86\u4e00\u8d77\uff0cl2fwd \u76d1\u63a7\u7684\u7aef\u53e3\u4f1a\u6536\u5230\u5305\uff0c\u5c31\u53ef\u4ee5\u8fdb\u884c\u6d4b\u8bd5\u4e86\u3002"},{"id":"/dpdk/ethtool\u8bfb\u53d6\u5230\u7684kni\u8bbe\u5907\u72b6\u6001\u4e0edpdk\u8bfb\u5230\u7684\u7f51\u5361\u72b6\u6001\u4e0d\u4e00\u81f4","metadata":{"permalink":"/longyu.github.io/blog/dpdk/ethtool\u8bfb\u53d6\u5230\u7684kni\u8bbe\u5907\u72b6\u6001\u4e0edpdk\u8bfb\u5230\u7684\u7f51\u5361\u72b6\u6001\u4e0d\u4e00\u81f4","editUrl":"https://github.com/longyuwlz/longyu.github.io/blog/dpdk/ethtool\u8bfb\u53d6\u5230\u7684kni\u8bbe\u5907\u72b6\u6001\u4e0edpdk\u8bfb\u5230\u7684\u7f51\u5361\u72b6\u6001\u4e0d\u4e00\u81f4.md","source":"@site/blog/dpdk/ethtool\u8bfb\u53d6\u5230\u7684kni\u8bbe\u5907\u72b6\u6001\u4e0edpdk\u8bfb\u5230\u7684\u7f51\u5361\u72b6\u6001\u4e0d\u4e00\u81f4.md","title":"dpdk/ethtool\u8bfb\u53d6\u5230\u7684kni\u8bbe\u5907\u72b6\u6001\u4e0edpdk\u8bfb\u5230\u7684\u7f51\u5361\u72b6\u6001\u4e0d\u4e00\u81f4","description":"ethtool \u8bfb\u5230\u7684\u94fe\u63a5\u72b6\u6001","date":"2022-06-19T07:40:00.000Z","formattedDate":"2022\u5e746\u670819\u65e5","tags":[],"readingTime":10.775,"truncated":false,"authors":[],"frontMatter":{},"prevItem":{"title":"dpdk/dpdk\u6536\u53d1\u5305\u6d4b\u8bd5\u4e4b\u4f7f\u7528\u5185\u6838\u63a5\u53e3\u7ed9dpdk\u7ed1\u5b9a\u7684\u7aef\u53e3\u53d1\u5305","permalink":"/longyu.github.io/blog/dpdk/dpdk\u6536\u53d1\u5305\u6d4b\u8bd5\u4e4b\u4f7f\u7528\u5185\u6838\u63a5\u53e3\u7ed9dpdk\u7ed1\u5b9a\u7684\u7aef\u53e3\u53d1\u5305"},"nextItem":{"title":"dpdk/\u5c06\u7f51\u5361\u7ed1\u5b9a\u5230\u5b98\u65b9\u9a71\u52a8\u6d4b\u8bd5\u8fc7\u7a0b","permalink":"/longyu.github.io/blog/dpdk/\u5c06\u7f51\u5361\u7ed1\u5b9a\u5230\u5b98\u65b9\u9a71\u52a8\u6d4b\u8bd5\u8fc7\u7a0b"}},"content":"## ethtool \u8bfb\u5230\u7684\u94fe\u63a5\u72b6\u6001\\n\\n\u4f7f\u7528 ethtool \u8bfb\u53d6\u7f51\u5361\u94fe\u63a5\u72b6\u6001\u7684\u4e00\u4e2a\u793a\u4f8b\u5982\u4e0b\uff1a\\n```\\nlongyu@longyu-pc:~$ sudo /sbin/ethtool ens37 \\n[sudo] password for longyu: \\nSettings for ens37:\\n\\tSupported ports: [ TP ]\\n\\tSupported link modes:   10baseT/Half 10baseT/Full \\n\\t                        100baseT/Half 100baseT/Full \\n\\t                        1000baseT/Full \\n\\tSupported pause frame use: No\\n\\tSupports auto-negotiation: Yes\\n\\tSupported FEC modes: Not reported\\n\\tAdvertised link modes:  10baseT/Half 10baseT/Full \\n\\t                        100baseT/Half 100baseT/Full \\n\\t                        1000baseT/Full \\n\\t......                       \\n\\tLink detected: yes\\n```\\n\u4e0a\u9762\u7684\u793a\u4f8b\u4e2d\uff0c\u6700\u540e\u4e00\u884c\u4e2d\u7684 Link detected \u8868\u793a\u94fe\u8def\u7684\u72b6\u6001\uff0c\u4e3a yes \u8868\u793a\u94fe\u8def up\uff0c\u4e3a no \u8868\u793a\u94fe\u8def down\u3002\u76ee\u524d\u94fe\u8def\u4e3a up \u72b6\u6001\u3002\u540c\u65f6\u4e0a\u9762\u7684\u8f93\u51fa\u4e2d\u4e5f\u8868\u660e\u6b64\u7f51\u5361\u652f\u6301\u81ea\u52a8\u534f\u5546\u3002\\n\\n**\u81ea\u52a8\u534f\u5546\u7528\u4e8e\u7f51\u5361\u7aef\u53e3\u4e0e\u5bf9\u7aef\u534f\u5546\u8fde\u63a5\u901f\u5ea6\u548c\u53cc\u5de5\u6a21\u5f0f\uff0c\u901a\u8fc7\u534f\u5546\u786e\u5b9a\u4e24\u7aef\u80fd\u591f\u8fbe\u5230\u7684\u6700\u5927\u8fde\u63a5\u901f\u5ea6\u4e0e\u4e24\u7aef\u90fd\u652f\u6301\u7684\u53cc\u5de5\u6a21\u5f0f\uff0c\u4e3b\u8981\u4e0e phy \u6709\u5173\u3002**\\n\\n\u901a\u8fc7\u641c\u7d22\uff0c\u6211\u53d1\u73b0\u4e86\u5982\u4e0b\u94fe\u63a5\uff1a\\n\\n[\u4ee5\u592a\u7f51\u81ea\u52a8\u534f\u5546\u7684\u539f\u7406](https://blog.csdn.net/skyflying2012/article/details/17557743)\\n \\n \u4e0b\u9762\u7684\u4fe1\u606f\u6765\u4e8e [\u4ee5\u592a\u7f51\u81ea\u52a8\u534f\u5546\u7684\u539f\u7406](https://blog.csdn.net/skyflying2012/article/details/17557743) \u8fd9\u7bc7\u535a\u5ba2\u3002\\n\\n> \u5343\u5146\u5149\u53e3\u81ea\u534f\u5546\u8fc7\u7a0b:\\n> \\n> 1.\u4e24\u7aef\u90fd\u8bbe\u7f6e\u4e3a\u81ea\u534f\u5546\u6a21\u5f0f\\n> \\n> \u53cc\u65b9\u4e92\u76f8\u53d1\u9001/C/\u7801\u6d41\uff0c\u5982\u679c\u8fde\u7eed\u63a5\u6536\u52303\u4e2a\u76f8\u540c\u7684/C/\u7801\u4e14\u63a5\u6536\u5230\u7684\u7801\u6d41\u548c\u672c\u7aef\u5de5\u4f5c\u65b9\u5f0f\u76f8\u5339\u914d\uff0c\u5219\u8fd4\u56de\u7ed9\u5bf9\u65b9\u4e00\u4e2a\u5e26\u6709Ack\u5e94\u7b54\u7684/C/\u7801\uff0c\u5bf9\u7aef\u63a5\u6536\u5230Ack\u4fe1\u606f\u540e\uff0c\u8ba4\u4e3a\u4e24\u8005\u53ef\u4ee5\u4e92\u901a\uff0c\u8bbe\u7f6e\u7aef\u53e3\u4e3aUP\u72b6\u6001\\n> \\n> 2.\u4e00\u7aef\u8bbe\u7f6e\u4e3a\u81ea\u534f\u5546\uff0c\u4e00\u7aef\u8bbe\u7f6e\u4e3a\u5f3a\u5236\\n> \\n> \u81ea\u534f\u5546\u7aef\u53d1\u9001/C/\u7801\u6d41\uff0c\u5f3a\u5236\u7aef\u53d1\u9001/I/\u7801\u6d41\uff0c\u5f3a\u5236\u7aef\u65e0\u6cd5\u7ed9\u5bf9\u7aef\u63d0\u4f9b\u672c\u7aef\u7684\u534f\u5546\u4fe1\u606f\uff0c\u4e5f\u65e0\u6cd5\u7ed9\u5bf9\u7aef\u8fd4\u56deAck\u5e94\u7b54\uff0c\u6545\u81ea\u534f\u5546\u7aefDOWN\u3002\u4f46\u662f\u5f3a\u5236\u7aef\u672c\u8eab\u53ef\u4ee5\u8bc6\u522b/C/\u7801\uff0c\u8ba4\u4e3a\u5bf9\u7aef\u662f\u4e0e\u81ea\u5df1\u76f8\u5339\u914d\u7684\u7aef\u53e3\uff0c\u6240\u4ee5\u76f4\u63a5\u8bbe\u7f6e\u672c\u7aef\u7aef\u53e3\u4e3aUP\u72b6\u6001\\n> \\n> 3.\u4e24\u7aef\u5747\u8bbe\u7f6e\u4e3a\u5f3a\u5236\u6a21\u5f0f\\n> \\n> \u53cc\u65b9\u4e92\u76f8\u53d1\u9001/I/\u7801\u6d41\uff0c\u4e00\u7aef\u63a5\u6536\u5230/I/\u7801\u6d41\u540e\uff0c\u8ba4\u4e3a\u5bf9\u7aef\u662f\u4e0e\u81ea\u5df1\u76f8\u5339\u914d\u7684\u7aef\u53e3\uff0c\u76f4\u63a5\u8bbe\u7f6e\u672c\u7aef\u7aef\u53e3\u4e3aUP\u72b6\u6001\\n> \\n\u9605\u8bfb\u4e0a\u9762\u7684\u4fe1\u606f\u53ef\u4ee5\u53d1\u73b0\uff0c\u5f53**\u4e24\u7aef\u90fd\u8bbe\u7f6e\u4e3a\u81ea\u534f\u5546\u6a21\u5f0f\u65f6\uff0c\u81ea\u534f\u5546\u6210\u529f\u540e\u4e24\u7aef\u7684\u7aef\u53e3\u72b6\u6001\u90fd\u4e3a UP**\uff1b**\u5f53\u4e00\u7aef\u8bbe\u7f6e\u81ea\u534f\u5546\uff0c\u4e00\u7aef\u8bbe\u7f6e\u5f3a\u5236\u65f6\uff0c\u81ea\u534f\u5546\u65f6\u8bbe\u7f6e\u81ea\u534f\u5546\u6a21\u5f0f\u7684\u7aef\u53e3\u72b6\u6001\u4f1a\u53d8\u4e3a DOWN\uff0c\u8bbe\u7f6e\u5f3a\u5236\u7aef\u7684\u7aef\u53e3\u72b6\u6001\u4f1a\u53d8\u4e3a UP\uff1b\u5f53\u4e24\u7aef\u5747\u8bbe\u7f6e\u4e3a\u5f3a\u5236\u6a21\u5f0f\u65f6\uff0c\u8fdb\u884c\u81ea\u534f\u5546\u4f1a\u4f7f\u4e24\u7aef\u7aef\u53e3\u90fd\u53d8\u4e3a UP \u72b6\u6001\u3002**\\n\\n## \u5bf9\u7aef\u53e3\u6267\u884c\u81ea\u534f\u5546\\n\u6709\u4e86\u8fd9\u4e2a\u57fa\u7840\u6211\u4eec\u6765\u8fdb\u884c\u4e0b\u9762\u7684\u64cd\u4f5c\uff0c\u8fd9\u91cc\u6211\u4f7f\u7528\u7684\u7f51\u5361\u578b\u53f7\u5982\u4e0b\uff1a\\n\\n```\\n02:05.0 Ethernet controller: Intel Corporation 82545EM Gigabit Ethernet Controller (Copper) (rev 01)\\n```\\n\u8fd9\u6b3e\u7f51\u5361\u5728\u6211\u7684\u7cfb\u7edf\u4e2d\u5bf9\u5e94\u7684 netdev \u63a5\u53e3\u7684\u540d\u5b57\u4e3a ens37\u3002\\n\\n**1. \u6267\u884c sudo ifconfig ens37 down \u547d\u4ee4\u5c06\u7f51\u5361\u8bbe\u5b9a\u4e3a down** \\n\\n**ethotool \u67e5\u770b\u94fe\u8def\u72b6\u6001\uff0c\u8f93\u51fa\u4fe1\u606f\u622a\u53d6\u5982\u4e0b\uff1a**\\n\\n```bash\\nlongyu@longyu-pc:~$ sudo ethtool ens37 \\n[sudo] password for longyu: \\nSettings for ens37:\\n\\tSupported ports: [ TP ]\\n\\tSupported link modes:   10baseT/Half 10baseT/Full \\n\\t                        100baseT/Half 100baseT/Full \\n\\t                        1000baseT/Full \\n\\tSupported pause frame use: No\\n\\tSupports auto-negotiation: Yes\\n\\t.........\\n\\tLink detected: no\\n```\\nLink detected \u4e3a no \u8868\u793a\u94fe\u8def\u4e3a down \u72b6\u6001\u3002\\n\\n**ethtool dump \u5bc4\u5b58\u5668\u4fe1\u606f\uff0c\u6709\u5982\u4e0b\u4e0e\u94fe\u8def\u72b6\u6001\u76f8\u5173\u7684\u4fe1\u606f\uff1a**\\n\\n```bash\\nlongyu@longyu-pc:~$ sudo ethtool -d ens37  | grep -i \'Link\'\\n      Link reset:                        reset\\n      Set link up:                       1\\n      Link up:                           link config\\n      Link speed:                        1000Mb/s\\n      Link State:                        Down\\n      Force Link Good:                   disabled\\n```\\n\u6b64\u65f6 Link State \u4e3a Down \u4e0e\u4e0a\u9762\u7684 Link detected : no \u4e00\u81f4\u3002\\n\\n**2. \u6267\u884c sudo ethtool -s ens37 autoneg on \u8fdb\u884c\u81ea\u534f\u5546** \\n\\n**ethtool \u67e5\u770b\u94fe\u8def\u72b6\u6001\uff0c\u622a\u53d6\u4e3b\u8981\u4fe1\u606f\u5982\u4e0b\uff1a**\\n\\n```bash\\nlongyu@longyu-pc:~$ sudo ethtool ens37\\nSettings for ens37:\\n\\tSupported ports: [ TP ]\\n\\tSupported link modes:   10baseT/Half 10baseT/Full \\n\\t                        100baseT/Half 100baseT/Full \\n\\t                        1000baseT/Full \\n\\tSupported pause frame use: No\\n\\tSupports auto-negotiation: Yes\\n\\t......\\n\\tLink detected: no\\n```\\nLink detected: no \u8868\u793a\u94fe\u8def\u4e3a down \u7684\u72b6\u6001\u3002\\n\\n**ethtool -d \u67e5\u770b\u5bc4\u5b58\u5668\u4fe1\u606f\uff0c\u76f8\u5173\u5185\u5bb9\u5982\u4e0b\uff1a**\\n\\n```bash\\nlongyu@longyu-pc:~$ sudo ethtool -d ens37  | grep -i \'Link\'\\n      Link reset:                        reset\\n      Set link up:                       1\\n      Link up:                           link config\\n      Link speed:                        1000Mb/s\\n      Link State:                        Up\\n      Force Link Good:                   disabled\\n```\\n\\n\u6ce8\u610f\u8fd9\u91cc Link State \u72b6\u6001\u53d8\u4e3a UP\uff0c\u8fd9\u8868\u660e\u81ea\u534f\u5546\u6210\u529f\u3002\u6839\u636e\u4e0a\u6587\u4e2d\u5f15\u7528\u7684\u5343\u5146\u5149\u53e3\u81ea\u534f\u5546\u7684\u8fc7\u7a0b\uff0c\u540c\u65f6\u6ce8\u610f\u5230\u6211\u4eec\u7684\u7f51\u5361\u652f\u6301\u81ea\u534f\u5546\uff0c\u6211\u4eec\u7528 ethtool -s \u547d\u4ee4\u6253\u5f00\u7f51\u5361\u7684\u81ea\u534f\u5546\u529f\u80fd\uff0c\u8fd9\u4e4b\u540e phy \u7684\u72b6\u6001\u53d8\u4e3a UP \u8868\u660e\u81ea\u534f\u5546\u6210\u529f\uff0c\u8fd9\u4e0e\u5343\u5146\u5149\u53e3\u81ea\u534f\u5546\u8fc7\u7a0b\u7684\u7b2c\u4e00\u79cd\u7c7b\u578b\u4e00\u81f4\uff0c\u4e24\u7aef\u90fd\u652f\u6301\u5e76\u5f00\u542f\u4e86\u81ea\u534f\u5546\uff0c\u534f\u5546\u6210\u529f\u540e\u4e24\u7aef\u7684 phy \u72b6\u6001\u90fd\u53d8\u4e3a\u4e86 UP\u3002\\n\\n\u8fd9\u65f6\u5019 ethtool \u76f4\u63a5\u67e5\u770b\u7f51\u5361\uff0cLink detected \u663e\u793a\u4e3a no \u8868\u660e\u94fe\u8def\u72b6\u6001\u4e3a down\uff0c\u4e3a\u4ec0\u4e48\u4e0d\u662f UP \u5462\uff1f\\n\\n\u8fd9\u91cc phy \u7684\u72b6\u6001\u7531 DOWN \u53d8\u4e3a UP \u8fd9\u662f\u81ea\u534f\u5546\u6210\u529f\u7684\u7ed3\u679c\u3002\u8fd9\u4e2a\u662f\u53ef\u4ee5\u89e3\u91ca\u7684\u3002\u81ea\u534f\u5546\u7684\u76ee\u7684\u5c31\u662f\u4e3a\u4e86\u786e\u5b9a\u8fde\u63a5\u901f\u5ea6\u3001\u53cc\u5de5\u6a21\u5f0f\u8fd9\u4e9b\u914d\u7f6e\uff0c\u800c\u8fd9\u4e9b\u914d\u7f6e\u90fd\u662f\u8981\u5728 phy up \u7684\u72b6\u6001\u4e0b\u624d\u6709\u4f5c\u7528\u3002\\n\\n\u8fd9\u65f6\u5019\u76f4\u63a5\u4f7f\u7528 ifconfig \u67e5\u770b\u7f51\u5361\u4fe1\u606f\uff0c\u8f93\u51fa\u5982\u4e0b\uff1a\\n\\n```bash\\nlongyu@longyu-pc:~$ sudo ifconfig ens37 \\nens37: flags=4098<BROADCAST,MULTICAST>  mtu 1500\\n        ether 00:0c:29:5e:ba:35  txqueuelen 1000  (Ethernet)\\n        RX packets 1154  bytes 672588 (656.8 KiB)\\n        RX errors 0  dropped 0  overruns 0  frame 0\\n        TX packets 136  bytes 16616 (16.2 KiB)\\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\\n```\\n\\n\u4e0a\u9762\u7684\u8f93\u51fa\u8868\u660e\u7f51\u5361\u7684\u94fe\u8def\u72b6\u6001\u4e3a down\uff0c\u8fd9\u4e0e ethtool \u547d\u4ee4\u67e5\u770b\u5230\u7684\u7f51\u5361\u72b6\u6001\u4e3a no \u662f\u4e00\u81f4\u7684\u3002\\n\\n## ethtool: Link detected: no \u662f\u600e\u6837\u68c0\u6d4b\u7684\uff1f\\n\\n\u8fd9\u91cc\u6211\u4f7f\u7528 ethtool-4.19 \u7684\u6e90\u4ee3\u7801\u8fdb\u884c\u5206\u6790\u3002\\n\\n\u9996\u5148\u662f ethtool \u4e2d\u8bbe\u5b9a ETHTOOL_GLINK \u547d\u4ee4\uff0c\u8c03\u7528 ioctl \u51fd\u6570\u83b7\u53d6\u94fe\u8def\u72b6\u6001\u3002\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\uff1a\\n\\n\\tedata.cmd = ETHTOOL_GLINK;\\n\\terr = send_ioctl(ctx, &edata);\\n\\tif (err == 0) {\\n\\t\\tfprintf(stdout, \\"\\tLink detected: %s\\\\n\\",\\n\\t\\t\\tedata.data ? \\"yes\\":\\"no\\");\\n\\t\\tallfail = 0;\\n\\t} else if (errno != EOPNOTSUPP) {\\n\\t\\tperror(\\"Cannot get link status\\");\\n\\t}\\nedata.cmd \u4e2d\u586b\u5145\u7684\u662f ethtool \u4e2d\u7684\u5b50\u547d\u4ee4\uff0c\u5c5e\u4e8e SIOCETHTOOL \u4e0b\u9762\u7684\u5b50\u547d\u4ee4\u3002send_ioctol \u51fd\u6570\u7684\u6e90\u7801\u5982\u4e0b\uff1a\\n\\n\u6ce8\u610f\u8fd9\u91cc\u7684\u5b50\u547d\u4ee4\u901a\u8fc7 ctx->ifr \u6765\u4f20\u9012\u7ed9 ioctl\u3002\\n\\n```c\\nint send_ioctl(struct cmd_context *ctx, void *cmd)\\n{\\n\\tctx->ifr.ifr_data = cmd;\\n\\treturn ioctl(ctx->fd, SIOCETHTOOL, &ctx->ifr);\\n}\\n```\\n\\n\\n\u8fd9\u4e4b\u540e ioctl \u4f1a\u8fdb\u884c\u5206\u53d1\uff0c\u7531 ioctl \u5230 sock_ioctl \u5230 dev_ioctl \u5230 dev_ethtool \u9002\u914d\u5c42\u3002dev_ethtool \u9002\u914d\u5c42\u76f8\u5173\u51fd\u6570\u5728\u5185\u6838\u8def\u5f84\u4e0b\u7684 net/core/ethtool.c \u6587\u4ef6\u4e2d\u3002\\n\\ndev_ethtool \u51fd\u6570\u662f\u4e00\u4e2a\u5927\u7684\u5206\u53d1\u51fd\u6570\uff0c\u901a\u8fc7 switch \u6765\u5c06\u4e0d\u540c\u7684 ethtool \u5b50\u547d\u4ee4\u5206\u53d1\u5230\u4e0d\u540c\u7684\u5b50\u51fd\u6570\u8c03\u7528\u4e4b\u4e0a\u3002\u5b50\u51fd\u6570\u91cc\u9762\u7684\u6838\u5fc3\u903b\u8f91\u5728\u4e8e\u8c03\u7528\u7f51\u5361\u5185\u6838\u63a5\u53e3 net_device \u4e2d\u6ce8\u518c\u7684 ethtool_ops \u865a\u51fd\u6570\u8868\u4e2d\u7684\u51fd\u6570\u3002\\n\\n\u4e0a\u9762 Link detected \u4e2d\u4f7f\u7528\u7684 ethtool \u5b50\u547d\u4ee4\u4e3a ETHTOOL_GLINK\uff0c\u5728 dev_ethtool \u51fd\u6570\u4e2d\u88ab\u5206\u53d1\u5230 ethtool_get_link \u5b50\u51fd\u6570\u3002\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\uff1a \\n\\n```c\\n\\tcase ETHTOOL_GLINK:\\n\\t\\trc = ethtool_get_link(dev, useraddr);\\n\\t\\tbreak;\\n```\\n\\nethtool_get_link \u5b50\u51fd\u6570\u7684\u6838\u5fc3\u5728\u4e8e\u4e0b\u9762\u8fd9\u884c\u4ee3\u7801\uff1a\\n\\n```c\\nedata.data = netif_running(dev) && dev->ethtool_ops->get_link(dev);\\n```\\nnetif_running \u51fd\u6570\u5728\u5185\u6838\u5934\u6587\u4ef6\u8def\u5f84 include/linux/netdevice.h \u4e2d\u5b9a\u4e49\uff0c\u5b83\u901a\u8fc7\u68c0\u6d4b netdev \u7ed3\u6784\u4f53\u4e2d state \u53d8\u91cf\u7684 __LINK_STATE_START \u4f4d\u6765\u786e\u5b9a\u63a5\u53e3\u662f\u5426 running\u3002\\n\\n```c\\nstatic inline bool netif_running(const struct net_device *dev)\\n{\\n\\treturn test_bit(__LINK_STATE_START, &dev->state);\\n}\\n```\\n\u4e86\u89e3\u4e86 ethtool_get_link \u5b50\u51fd\u6570\u7684\u90e8\u5206\u4ee3\u7801\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\uff0c\u4e0a\u6587\u4e2d\u63d0\u5230\u7684\u5728\u7f51\u5361\u63a5\u53e3 down \u7684\u72b6\u6001\u4e0b\u8fdb\u884c\u81ea\u534f\u5546\u540e\uff0cphy \u7684\u72b6\u6001\u53d8\u4e3a UP\uff0c\u800c ethtool \u8f93\u51fa\u7684 Link detected \u9879\u4e3a no \u7684\u60c5\u51b5\u662f\u6b63\u5e38\u7684\u73b0\u8c61\u3002\\n\\n\u6b64\u65f6 ifconfig \u663e\u793a\u7684\u7f51\u5361\u72b6\u6001\u4e0d\u662f RUNNING\uff0cnetif_running \u5c06\u4f1a\u8fd4\u56de false\uff0c&& \u8bed\u53e5\u4e4b\u540e\u7684\u8bfb\u53d6\u786c\u4ef6\u5bc4\u5b58\u5668\u4e2d\u4fdd\u5b58\u7684\u94fe\u8def\u72b6\u6001\u7684\u64cd\u4f5c\u5c06\u88ab\u5ffd\u7565\uff0cedata.data \u5c06\u4f1a\u8fd4\u56de false\uff0c\u5bf9\u5e94 ethtool \u4e2d Link detected \u9879\u7684\u8f93\u51fa\u4e3a no\u3002\\n\\n## dev->ethtool_ops->get_link(dev) vs rte_eth_link_get \\n```dev->ethtool_ops->get_link(dev)```\u6700\u7ec8\u662f\u901a\u8fc7\u8bbf\u95ee\u7f51\u5361\u4e2d\u7684\u5bc4\u5b58\u5668\u6765\u83b7\u53d6\u94fe\u8def\u72b6\u6001\u3002\\n\\n\\n\\ndpdk \u4e2d\u7684 rte_eth_link_get \u51fd\u6570\u6839\u636e lsc \u4e2d\u65ad\u662f\u5426\u5f00\u542f\uff0c\u6709\u4e24\u79cd\u4e0d\u540c\u7684\u5904\u7406\u65b9\u5f0f\u3002\\n\\n1. lsc \u4e2d\u65ad\u4f7f\u80fd\\n\\n\\t\u539f\u5b50\u8bfb\u53d6 dev \u7ed3\u6784\u4f53\u4e2d\u7684 eth_link \u6210\u5458\u3002\u8fd9\u4e2a\u6210\u5458\u53ea\u80fd\u5728 interrupt host \u7ebf\u7a0b\u4e2d\u88ab\u66f4\u65b0\u3002\u7528\u6237\u6ce8\u518c\u7684 lsc \u4e2d\u65ad\u56de\u8c03\u51fd\u6570\u4e5f\u662f\u5728 interrupt host \u7ebf\u7a0b\u4e2d\u88ab\u8c03\u7528\u7684\uff0c\u53ef\u4ee5\u5728 lsc \u4e2d\u65ad\u56de\u8c03\u51fd\u6570\u4e2d\u6539\u53d8 eth_link \u7684\u503c\u3002\\n\\n2. lsc \u4e2d\u65ad\u5173\u95ed\\n\\t\u8c03\u7528 dev_ops \u4e2d\u5b9e\u73b0\u7684 link_update \u51fd\u6570\uff0c\u8be5\u51fd\u6570\u901a\u8fc7\u76f4\u63a5\u8bbf\u95ee\u7f51\u5361\u5bc4\u5b58\u5668\u6765\u83b7\u53d6\u94fe\u8def\u7684\u6700\u65b0\u72b6\u6001\u3002\\n\\n\\n\u5728 lsc \u4e2d\u65ad\u5173\u95ed\u7684\u60c5\u51b5\u4e0b\uff0crte_eth_link_get \u4e0e dev->ethtool-ops->get_link(dev) \u6700\u7ec8\u90fd\u662f\u901a\u8fc7\u8bbf\u95ee\u7f51\u5361\u5bc4\u5b58\u5668\u6765\u786e\u5b9a\u94fe\u8def\u72b6\u6001\u7684\u3002\\n\\n\u81f3\u4e8e\u8bf4 ethtool \u8bfb\u5230\u7684\u72b6\u6001\u4e0e dpdk \u8bfb\u5230\u7684\u7f51\u5361\u72b6\u6001\u4e0d\u4e00\u81f4\uff0c\u8fd9\u662f\u6307 ethtool \u4e2d\u7684 Link detected \u4e2d\u68c0\u6d4b\u5230\u7684\u94fe\u8def\u72b6\u6001\u4e0e rte_eth_link_get \u51fd\u6570\u7684\u8f93\u51fa\u4e0d\u540c\u3002\\n\\n**\u4ece\u4e0a\u9762\u7684\u5206\u6790\u4e2d\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\uff0cethtool \u4e2d\u7684 Link detected \u8f93\u51fa yes \u7684\u5fc5\u5907\u6761\u4ef6\u8fd8\u6709 netif_running \u8fd4\u56de true\uff0c\u800c rte_eth_link_get \u5374\u6ca1\u6709\u4f7f\u7528\u8fd9\u4e2a\u72b6\u6001\uff0c\u8fd9\u4e24\u8005\u4ece\u903b\u8f91\u4e0a\u6765\u8bf4\u4e5f\u4e0d\u662f\u5728\u4efb\u4f55\u65f6\u5019\u90fd\u4f1a\u4e00\u81f4\u7684\u3002**\\n\\n**\u7efc\u4e0a\u6240\u8ff0\uff0c\u8fd9\u4e2a\u95ee\u9898\u5176\u5b9e\u4e0d\u662f\u529f\u80fd\u7684\u95ee\u9898\uff0c\u800c\u662f\u4e0d\u4e86\u89e3\u529f\u80fd\u7684\u5b9e\u73b0\u800c\u8bef\u5224\u7684\u95ee\u9898\u3002**"},{"id":"/dpdk/\u5c06\u7f51\u5361\u7ed1\u5b9a\u5230\u5b98\u65b9\u9a71\u52a8\u6d4b\u8bd5\u8fc7\u7a0b","metadata":{"permalink":"/longyu.github.io/blog/dpdk/\u5c06\u7f51\u5361\u7ed1\u5b9a\u5230\u5b98\u65b9\u9a71\u52a8\u6d4b\u8bd5\u8fc7\u7a0b","editUrl":"https://github.com/longyuwlz/longyu.github.io/blog/dpdk/\u5c06\u7f51\u5361\u7ed1\u5b9a\u5230\u5b98\u65b9\u9a71\u52a8\u6d4b\u8bd5\u8fc7\u7a0b.md","source":"@site/blog/dpdk/\u5c06\u7f51\u5361\u7ed1\u5b9a\u5230\u5b98\u65b9\u9a71\u52a8\u6d4b\u8bd5\u8fc7\u7a0b.md","title":"dpdk/\u5c06\u7f51\u5361\u7ed1\u5b9a\u5230\u5b98\u65b9\u9a71\u52a8\u6d4b\u8bd5\u8fc7\u7a0b","description":"\u5c06\u7f51\u5361\u7ed1\u5b9a\u5230\u5b98\u65b9\u9a71\u52a8\u8fdb\u884c\u6d4b\u8bd5","date":"2022-06-19T07:40:00.000Z","formattedDate":"2022\u5e746\u670819\u65e5","tags":[],"readingTime":6.275,"truncated":false,"authors":[],"frontMatter":{},"prevItem":{"title":"dpdk/ethtool\u8bfb\u53d6\u5230\u7684kni\u8bbe\u5907\u72b6\u6001\u4e0edpdk\u8bfb\u5230\u7684\u7f51\u5361\u72b6\u6001\u4e0d\u4e00\u81f4","permalink":"/longyu.github.io/blog/dpdk/ethtool\u8bfb\u53d6\u5230\u7684kni\u8bbe\u5907\u72b6\u6001\u4e0edpdk\u8bfb\u5230\u7684\u7f51\u5361\u72b6\u6001\u4e0d\u4e00\u81f4"},"nextItem":{"title":"dpdk/\u8bb0\u5f55\u4e00\u6b21\u7f16\u8bd1\u5668\u7248\u672c\u8fc7\u4f4e\u5bfc\u81f4dpdk\u65e0\u6cd5\u6210\u529f\u7f16\u8bd1\u7684\u95ee\u9898","permalink":"/longyu.github.io/blog/dpdk/\u8bb0\u5f55\u4e00\u6b21\u7f16\u8bd1\u5668\u7248\u672c\u8fc7\u4f4e\u5bfc\u81f4dpdk\u65e0\u6cd5\u6210\u529f\u7f16\u8bd1\u7684\u95ee\u9898"}},"content":"## \u5c06\u7f51\u5361\u7ed1\u5b9a\u5230\u5b98\u65b9\u9a71\u52a8\u8fdb\u884c\u6d4b\u8bd5\\n\\n\u5bf9\u4e8e\u7f51\u5361\u7684\u4e00\u4e9b\u5f02\u5e38\u60c5\u51b5\uff0c\u5e38\u5e38\u9700\u8981\u4f7f\u7528\u5b98\u65b9\u9a71\u52a8\u8fdb\u884c\u76f8\u540c\u7684\u6d4b\u8bd5\u4ee5\u786e\u8ba4\u95ee\u9898\u3002\\n\u672c\u6587\u53d9\u8ff0\u4e86\u5c06\u7f51\u5361\u7ed1\u5b9a\u5230\u5b98\u65b9\u9a71\u52a8\u8fdb\u884c\u6d4b\u8bd5\u7684\u8fc7\u7a0b\u3002\\n\\n## \u7f51\u5361\u89e3\u7ed1\u5b9a\\n\\n### 1. lsof /dev/uio* \u627e\u5230\u4f7f\u7528 /dev/uioX \u8bbe\u5907\u6587\u4ef6\u7684\u4ea7\u54c1\u7a0b\u5e8f\u3002\\n\\n```\\n[root]# lsof /dev/uio*\\nCOMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF  NODE NAME\\nl2fwd     21178 root   30u   CHR  248,1      0t0 28807 /dev/uio1\\nl2fwd     21178 root   32u   CHR  248,0      0t0 28805 /dev/uio0\\nl2fwd     21178 root   34u   CHR  248,3      0t0 25875 /dev/uio3\\n........\\n```\\n\\n\u4ece\u4e0a\u9762\u7684\u8f93\u51fa\u91cc\u9762\u53ef\u4ee5\u786e\u8ba4\uff0c\u4ea7\u54c1\u7684 server \u4e3a l2fwd \u7a0b\u5e8f\uff0c\u8fd9\u4e2a l2fwd \u7a0b\u5e8f\u4f7f\u7528\u4e86\\n\u8bbe\u5907\u6587\u4ef6 /dev/uioX\u3002\\n\\n\u6211\u4eec\u9996\u5148\u9700\u8981 kill \u4ea7\u54c1\u7684 server \uff0c\u786e\u4fdd\u5728\u6ca1\u4eba\u4f7f\u7528\u7684\u60c5\u51b5\u4e0b\u89e3\u7ed1\u5b9a\u7f51\u5361\u3002\u4e3a\u4e86\u9632\u6b62 \\nkill \u7a0b\u5e8f\u540e\u5b88\u62a4\u7a0b\u5e8f\u5c06 server \u91cd\u65b0\u62c9\u8d77\u6765\uff0c**\u53ef\u4ee5\u5c06 server \u91cd\u547d\u540d\uff0c\u7136\u540e kill server\u3002**\\n\\n### 2. \u7f51\u5361\u4ece igb_uio \u9a71\u52a8\u89e3\u7ed1\\n\\n\u9996\u5148\u9700\u8981\u786e\u5b9a\u9700\u8981\u89e3\u7ed1\u5b9a\u7f51\u5361\u7684 pci \u53f7\u3002\u4e00\u822c\u53ef\u4ee5\u901a\u8fc7 lspci \u547d\u4ee4\u6765\u67e5\u8be2\u3002\\n\\n\u67d0\u8bbe\u5907\u4e0a X710 \u7f51\u5361\u7684 pci \u53f7\u76f8\u5173\u4fe1\u606f\u793a\u4f8b\u5982\u4e0b\uff1a\\n\\n```\\n[root]# lspci |grep \'Eth\'\\n0f:00.0 Ethernet controller: Intel Corporation Ethernet Controller X710 for 10GbE backplane (rev 02)\\n0f:00.1 Ethernet controller: Intel Corporation Ethernet Controller X710 for 10GbE backplane (rev 02)\\n```\\n\\n\u4e0a\u9762 0f:00.0 \u4e0e 0f:00.1 \u5c31\u662f X710 \u7f51\u5361\u7684 pci \u53f7\u3002\\n\\n\u89e3\u7ed1\u5b9a\u9700\u8981\u4f7f\u7528 dpdk_nic_bind.py \u811a\u672c\u6765\u5b8c\u6210\uff0c\u4e0d\u540c\u7684\u4ea7\u54c1\u8fd9\u4e2a\u811a\u672c\u7684\u4f4d\u7f6e\u53ef\u80fd\u4e0d\u540c\uff0c\u8fd9\u70b9\u9700\u8981\u6ce8\u610f\u3002\\n\\n\u89e3\u7ed1\u5b9a\u793a\u4f8b\u5982\u4e0b\uff1a\\n\\n```\\n[root]# /usr/local/bin/dpdk_nic_bind.py -u 0f:00.0 0f:00.1\\n```\\n\\n\u5728\u4e0a\u9762\u7684\u547d\u4ee4\u884c\u4e2d\uff0c-u \u8868\u793a\u89e3\u9664\u7ed1\u5b9a\uff0c0f:00.0 \u4e0e 0f:00.1 \u8868\u793a\u8981\u89e3\u9664\u7ed1\u5b9a\u7684\u7f51\u53e3\u3002\u6267\u884c\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u6267\u884c\\n\\ndpdk_nic_bind.py -s \u547d\u4ee4\u67e5\u770b\u7ed1\u5b9a\u4fe1\u606f\uff0c\u786e\u8ba4\u662f\u5426\u6210\u529f\u89e3\u7ed1\u3002\\n\\n\u793a\u4f8b\u5982\u4e0b\uff1a\\n\\n```\\n[root]# /usr/local/bin/dpdk_nic_bind.py -s\\n............\\nOther network devices\\n=====================\\n0000:0f:00.0 \'Ethernet Controller X710 for 10GbE backplane\' unused=igb_uio,uio_pci_generic\\n0000:0f:00.1 \'Ethernet Controller X710 for 10GbE backplane\' unused=igb_uio,uio_pci_generic\\n\\n```\\n\\n\u4ece\u4e0a\u9762\u7684\u8f93\u51fa\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c0000:0f:00.0 \u4e0e 0000:0f:00.1 \u7f51\u5361\u63a5\u53e3\u5df2\u7ecf\u89e3\u9664\u4e86\u7ed1\u5b9a\uff0c\u6ca1\u6709\u7ed1\u5b9a\u5230\\n\u4efb\u4f55\u9a71\u52a8\u4e0a\u9762\u3002\\n\\n## \u52a0\u8f7d\u7f51\u5361\u7684\u5b98\u65b9\u9a71\u52a8 ko \u65f6\u81ea\u52a8\u8bc6\u522b\u5e76\u7ed1\u5b9a\\n\\n\u5f53\u6211\u4eec\u5c06\u7f51\u5361\u4ece igb_uio \u9a71\u52a8\u4e0a\u9762\u89e3\u7ed1\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u52a0\u8f7d\u7f51\u5361\u4f7f\u7528\u7684\u5b98\u65b9\u9a71\u52a8\u4e86\u3002\u8fd9\u91cc\u7684\u5b98\u65b9\u9a71\u52a8\\n\u4e00\u822c\u7cfb\u7edf\u4e0a\u4f1a\u5e26\u6709\uff08\u4e00\u822c\u653e\u5728 /bin \u76ee\u5f55\u4e0b\uff09\uff0c\u6ca1\u6709\u7684\u8bdd\u5c31\u9700\u8981\u81ea\u5df1\u7f16\u8bd1\u540e\u4e0a\u4f20\u5230\u8bbe\u5907\u4e0a\u6765\u52a0\u8f7d\u4e86\u3002\\n\\n\u4e0a\u9762\u7684\u793a\u4f8b\u64cd\u4f5c\u4e2d\uff0c\u7f51\u5361\u5df2\u7ecf\u89e3\u9664 igb_uio \u7684\u7ed1\u5b9a\u3002\u8fd9\u6837\u5f53\u6211\u4eec\u5728\u52a0\u8f7d\u5b98\u65b9\u9a71\u52a8\u7684\u65f6\u5019\uff0c\u5185\u6838\u4f1a\u81ea\\n\u52a8\u8bc6\u522b\u5230\u7f51\u5361\uff0c\u5e76\u6267\u884c\u5bf9\u5e94\u7684 probe \u64cd\u4f5c\u3002\\n\\nX710 \u7f51\u5361\u4f7f\u7528\u7684\u5b98\u65b9\u9a71\u52a8\u662f intel \u7684 i40e \u9a71\u52a8\uff0c\u52a0\u8f7d i40e \u9a71\u52a8\u7684\u793a\u4f8b\u5982\u4e0b\uff1a\\n\\n```\\n[root]# insmod /bin/i40e.ko \\n[root]# dmesg | tail -n 20\\n[79357.260739] i40e: Intel(R) Ethernet Connection XL710 Network Driver - version 1.4.25-k\\n[79357.260746] i40e: Copyright (c) 2013 - 2014 Intel Corporation.\\n[79357.279249] i40e 0000:0f:00.0: fw 6.1.49420 api 1.7 nvm 6.80 0x80003cf0 0.0.0\\n[79357.279258] i40e 0000:0f:00.0: The driver for the device detected a newer version of the NVM image than expected. Please install the most recent version of the network driver.\\n[79357.365299] i40e 0000:0f:00.0: MAC address: 98:30:00:1e:42:20\\n[79357.369576] i40e 0000:0f:00.0: SAN MAC: 00:00:00:00:02:00\\n[79357.432223] i40e 0000:0f:00.0 enp15s0f0: renamed from eth2\\n[79357.496835] i40e 0000:0f:00.0: PCI-Express: Speed 8.0GT/s Width x8\\n[79357.502928] i40e 0000:0f:00.0: Features: PF-id[0] VFs: 64 VSIs: 66 QP: 16 RX: 1BUF RSS FD_ATR FD_SB NTUPLE VxLAN PTP VEPA\\n[79357.522602] i40e 0000:0f:00.1: fw 6.1.49420 api 1.7 nvm 6.80 0x80003cf0 0.0.0\\n[79357.522611] i40e 0000:0f:00.1: The driver for the device detected a newer version of the NVM image than expected. Please install the most recent version of the network driver.\\n[79357.610493] i40e 0000:0f:00.1: MAC address: 98:30:00:1e:42:21\\n[79357.614555] i40e 0000:0f:00.1: SAN MAC: 00:00:00:00:02:01\\n[79357.842767] i40e 0000:0f:00.1: PCI-Express: Speed 8.0GT/s Width x8\\n[79357.849279] i40e 0000:0f:00.1: Features: PF-id[1] VFs: 64 VSIs: 66 QP: 16 RX: 1BUF RSS FD_ATR FD_SB NTUPLE VxLAN PTP VEPA\\n[79357.966780] i40e 0000:0f:00.1 enp15s0f1: renamed from eth2\\n```\\n\\n\u4ece\u4e0a\u9762\u7684\u8f93\u51fa\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c\u52a0\u8f7d\u4e86 i40e.ko \u540e\uff0c0f:00.0 \u4e0e 0f:00.1 \u7f51\u5361\u63a5\u53e3\u88ab\u81ea\u52a8\u8bc6\u522b\u5e76\u7ed1\u5b9a\u5230\\n\u4e86 i40e \u9a71\u52a8\uff0c\u5bf9\u5e94\u7684 netdev \u540d\u79f0\u5206\u522b\u4e3a\uff1aenp15s0f0 \u4e0e enp15s0f1\uff0c\u8fd9\u4e4b\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u8fdb\u884c\u6d4b\u8bd5\\n\u4e86\u3002\\n\\n## \u624b\u52a8\u7ed1\u5b9a\u7f51\u5361\u5230\u5b98\u65b9\u9a71\u52a8\u4e0a\\n\\n\u5982\u679c\u6211\u4eec\u5148\u52a0\u8f7d\u4e86\u7f51\u5361\u7684\u5b98\u65b9\u9a71\u52a8\uff0c\u7136\u540e\u518d\u89e3\u9664 igb_uio \u7684\u7ed1\u5b9a\u5e76\u91cd\u65b0\u7ed1\u5b9a\u5230\u5b98\u65b9\u9a71\u52a8\u4e0a\u9762\uff0c\u53ef\u4ee5\\n\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u624b\u52a8\u5c06\u7f51\u5361\u63a5\u53e3\u7ed1\u5b9a\u5230\u5b98\u65b9\u9a71\u52a8\u4e0a\u3002\\n\\n```\\ndpdk_nic_bind.py -b driver_name pcinum\\n```\\n\\ndriver_name \u4e3a\u52a0\u8f7d\u7684\u5b98\u65b9\u9a71\u52a8\u7684\u540d\u79f0\uff0cpcinum \u4e3a\u4ea7\u54c1\u7684 pci \u53f7\uff0c\u591a\u4e2a pcinum \u4e4b\u95f4\u4f7f\u7528\u7a7a\u683c\u5206\u9694\u3002\\n\\n\u4e00\u4e2a\u793a\u4f8b\u5982\u4e0b\uff1a\\n\\n```\\n[root]# /usr/local/bin/dpdk_nic_bind.py -b i40e 0f:00.0 0f:00.1\\n[root]# /usr/local/bin/dpdk_nic_bind.py -s\\n\xb7\xb7\xb7\xb7\xb7\xb7\xb7\xb7\\nNetwork devices using kernel driver\\n===================================\\n0000:0f:00.0 \'Ethernet Controller X710 for 10GbE backplane\' if=enp15s0f0 drv=i40e unused=igb_uio,uio_pci_generic \\n0000:0f:00.1 \'Ethernet Controller X710 for 10GbE backplane\' if=enp15s0f1 drv=i40e unused=igb_uio,uio_pci_generic \\n```\\n\\n\u4e0a\u9762\u7684\u793a\u4f8b\u4e2d\u9996\u5148\u901a\u8fc7 dpdk_nic_bind.py -b \u5c06 0f:00.0 \u4e0e 0f:00.1 \u7ed1\u5b9a\u5230 i40e \u5b98\u65b9\u9a71\u52a8\u4e0a\uff0c\u7136\u540e\\n\u6267\u884c dpdk_nic_bind.py -s \u663e\u793a\u5f53\u524d\u7684\u7f51\u5361\u8bbe\u5907\u72b6\u6001\u3002\u4ece\u8f93\u51fa\u53ef\u4ee5\u53d1\u73b0\uff0c0f:00.0 \u4e0e 0f:00.1 \u5df2\u7ecf\u88ab\\n\u7ed1\u5b9a\u5230\u4e86\u5b98\u65b9\u9a71\u52a8\u4e0a\u9762\u3002\\n\\n## \u91cd\u65b0\u7ed1\u5b9a\u5230 igb_uio \u4e2d\u5e76\u6062\u590d\\n\\n\u6d4b\u8bd5\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u9700\u8981\u91cd\u65b0\u5c06\u7f51\u5361\u7ed1\u5b9a\u5230 igb_uio \u4e0a\uff0c\u6267\u884c dpdk_nic_bind.py -b \u547d\u4ee4\u6765\u5b8c\u6210\u3002\\n\\n\u5982\u679c\u7ed1\u5b9a\u7684\u8fc7\u7a0b\u4e2d\u6709\u5982\u4e0b\u62a5\u8b66\uff0c\u5219\u9700\u8981\u6267\u884c ifconfig netdev down \u547d\u4ee4\u6765\u5c06\u7f51\u5361 down \u6389\uff0c\u518d\u89e3\u9664\\n\u7ed1\u5b9a\u3002\\n\\n```\\n[root]# /usr/local/bin/dpdk_nic_bind.py -b igb_uio 0f:00.0 0f:00.1\\nRouting table indicates that interface 0000:0f:00.0 is active. Not modifying\\n```\\n\\nifconfig down \u6389\u7f51\u5361\u540e\u518d\u91cd\u65b0\u7ed1\u5b9a\u7684\u793a\u4f8b\uff1a\\n\\n```\\n[root]# ifconfig enp15s0f0 down\\n[root]# /usr/local/bin/dpdk_nic_bind.py -b igb_uio 0f:00.0\\n```"},{"id":"/dpdk/\u8bb0\u5f55\u4e00\u6b21\u7f16\u8bd1\u5668\u7248\u672c\u8fc7\u4f4e\u5bfc\u81f4dpdk\u65e0\u6cd5\u6210\u529f\u7f16\u8bd1\u7684\u95ee\u9898","metadata":{"permalink":"/longyu.github.io/blog/dpdk/\u8bb0\u5f55\u4e00\u6b21\u7f16\u8bd1\u5668\u7248\u672c\u8fc7\u4f4e\u5bfc\u81f4dpdk\u65e0\u6cd5\u6210\u529f\u7f16\u8bd1\u7684\u95ee\u9898","editUrl":"https://github.com/longyuwlz/longyu.github.io/blog/dpdk/\u8bb0\u5f55\u4e00\u6b21\u7f16\u8bd1\u5668\u7248\u672c\u8fc7\u4f4e\u5bfc\u81f4dpdk\u65e0\u6cd5\u6210\u529f\u7f16\u8bd1\u7684\u95ee\u9898.md","source":"@site/blog/dpdk/\u8bb0\u5f55\u4e00\u6b21\u7f16\u8bd1\u5668\u7248\u672c\u8fc7\u4f4e\u5bfc\u81f4dpdk\u65e0\u6cd5\u6210\u529f\u7f16\u8bd1\u7684\u95ee\u9898.md","title":"dpdk/\u8bb0\u5f55\u4e00\u6b21\u7f16\u8bd1\u5668\u7248\u672c\u8fc7\u4f4e\u5bfc\u81f4dpdk\u65e0\u6cd5\u6210\u529f\u7f16\u8bd1\u7684\u95ee\u9898","description":"\u7f16\u8bd1 dpdk-20.02 \u65f6\uff0c\u6709\u5982\u4e0b\u62a5\u9519\u4fe1\u606f\uff1a","date":"2022-06-19T07:40:00.000Z","formattedDate":"2022\u5e746\u670819\u65e5","tags":[],"readingTime":1.915,"truncated":false,"authors":[],"frontMatter":{},"prevItem":{"title":"dpdk/\u5c06\u7f51\u5361\u7ed1\u5b9a\u5230\u5b98\u65b9\u9a71\u52a8\u6d4b\u8bd5\u8fc7\u7a0b","permalink":"/longyu.github.io/blog/dpdk/\u5c06\u7f51\u5361\u7ed1\u5b9a\u5230\u5b98\u65b9\u9a71\u52a8\u6d4b\u8bd5\u8fc7\u7a0b"},"nextItem":{"title":"dpdk/\u8bbe\u7f6eEXTRA_CFLAGS\u4ee5\u7f16\u8bd1debug\u7248\u672cdpdk\u5e93","permalink":"/longyu.github.io/blog/dpdk/\u8bbe\u7f6eEXTRA_CFLAGS\u4ee5\u7f16\u8bd1debug\u7248\u672cdpdk\u5e93"}},"content":"\u7f16\u8bd1 dpdk-20.02 \u65f6\uff0c\u6709\u5982\u4e0b\u62a5\u9519\u4fe1\u606f\uff1a\\n```\\nerror: \u2018__ATOMIC_RELAXED\u2019 undeclared (first use in this function)\\nerror: \u2018__ATOMIC_ACQUIRE\u2019 undeclared (first use in this function)\\nerror: \u2018__ATOMIC_RELAXED\u2019 undeclared (first use in this function)\\nerror: \u2018__ATOMIC_ACQUIRE\u2019 undeclared (first use in this function)\\n```\\n## \u5206\u6790\u89e3\u51b3\\n### \u5934\u6587\u4ef6\u7684\u95ee\u9898\\n\u6839\u636e\u8fc7\u53bb\u7684\u7ecf\u9a8c\uff0c\u672a\u58f0\u660e\u7684\u7b26\u53f7\u8fd9\u4e2a\u9519\u8bef\u5f88\u5927\u6982\u7387\u662f\u5934\u6587\u4ef6\u7684\u95ee\u9898\u3002\u9996\u5148\u9700\u8981\u786e\u5b9a\u7684\u662f\u7f16\u8bd1\u7684\u6e90\u7801\u4e2d\u662f\u5426\u6709\u76f8\u5173\u7684\u7b26\u53f7\u58f0\u660e\u3002\\n\\n\u4f7f\u7528\u4e0a\u8ff0\u7b26\u53f7\u5728 dpdk-20.02 \u7684\u6e90\u7801\u91cc\u9762\u641c\u7d22\uff0c\u53ea\u53d1\u73b0\u5f88\u591a\u4f7f\u7528\u7684\u5730\u65b9\uff0c\u6ca1\u6709\u53d1\u73b0\u58f0\u660e\u3002\\n\\n\u8fd9\u610f\u5473\u7740\u4e0a\u9762\u627e\u4e0d\u5230\u7684\u7b26\u53f7\u4e0d\u662f dpdk \u5185\u90e8\u5b9a\u4e49\u7684\u7b26\u53f7\uff0c\u90a3\u4e48\u8fd9\u4e9b\u7b26\u53f7\u53ef\u80fd\u662f dpdk \u4f9d\u8d56\u7684\u5916\u90e8\u5934\u6587\u4ef6\u4e2d\u58f0\u660e\u7684\u3002\\n\\n### \u5185\u6838\u5934\u6587\u4ef6\u662f\u5426\u58f0\u660e\u8fd9\u4e9b\u7b26\u53f7 \\n\u8003\u8651\u5230 dpdk \u7f16\u8bd1\u7684\u65f6\u5019\u9700\u8981\u6307\u5b9a\u5185\u6838\u6e90\u7801\u8def\u5f84\uff0c\u8fd9\u4e9b\u7b26\u53f7\u53ef\u80fd\u5728\u5185\u6838\u5934\u6587\u4ef6\u4e2d\u58f0\u660e\u3002\\n\\n\u4f7f\u7528\u4e0a\u8ff0\u7b26\u53f7\u5728\u5185\u6838\u6e90\u7801\u4e2d\u5168\u5c40\u641c\u7d22\uff0c\u6ca1\u6709\u627e\u5230\u3002\\n\\n### \u5728\u7f51\u4e0a\u641c\u7d22\\n\u641c\u7d22\u4e86\u4e0b\uff0c\u53d1\u73b0\u5982\u4e0b\u94fe\u63a5\u4e2d\u6709\u76f8\u540c\u7684\u95ee\u9898\u6848\u4f8b\uff1a\\n\\n[__ATOMIC_RELAXED undeclared](https://github.com/nim-lang/Nim/issues/2620)\\n\\n\u6d4f\u89c8\u4e0a\u8ff0\u94fe\u63a5\u7f51\u9875\uff0c\u53d1\u73b0\u8fd9\u4e2a\u95ee\u9898\u53ef\u80fd\u662f gcc \u7248\u672c\u8fc7\u4f4e\u5bfc\u81f4\u7684\u3002\u7f51\u9875\u4e2d\u7684\u8ba8\u8bba\u4e2d\u6709\u4e0b\u9762\u8fd9\u4e00\u53e5\uff1a\\n\\n>The atomic builtins referenced in atomic.nim are only available with GCC 4.7+\\n\\n\u6211\u68c0\u67e5\u81ea\u5df1\u7f16\u8bd1\u73af\u5883\u4e0b\u7684 gcc \u7248\u672c\uff0c\u53d1\u73b0\u4f7f\u7528\u7684 gcc \u4e3a 4.5.3 \u7248\u672c\u3002\\n\\n\u8fd9\u4e4b\u540e\u6211\u5728\u53e6\u5916\u4e00\u4e2a\u7f16\u8bd1\u73af\u5883\u4e0a\u91cd\u65b0\u7f16\u8bd1\uff0c\u7f16\u8bd1\u524d\u786e\u8ba4 gcc \u7684\u7248\u672c\u9ad8\u4e8e 4.7\uff0c\u7f16\u8bd1\u6210\u529f\u3002"},{"id":"/dpdk/\u8bbe\u7f6eEXTRA_CFLAGS\u4ee5\u7f16\u8bd1debug\u7248\u672cdpdk\u5e93","metadata":{"permalink":"/longyu.github.io/blog/dpdk/\u8bbe\u7f6eEXTRA_CFLAGS\u4ee5\u7f16\u8bd1debug\u7248\u672cdpdk\u5e93","editUrl":"https://github.com/longyuwlz/longyu.github.io/blog/dpdk/\u8bbe\u7f6eEXTRA_CFLAGS\u4ee5\u7f16\u8bd1debug\u7248\u672cdpdk\u5e93.md","source":"@site/blog/dpdk/\u8bbe\u7f6eEXTRA_CFLAGS\u4ee5\u7f16\u8bd1debug\u7248\u672cdpdk\u5e93.md","title":"dpdk/\u8bbe\u7f6eEXTRA_CFLAGS\u4ee5\u7f16\u8bd1debug\u7248\u672cdpdk\u5e93","description":"\u547d\u4ee4\u884c\u6307\u5b9a CFLAGS \u4e0d\u751f\u6548","date":"2022-06-19T07:40:00.000Z","formattedDate":"2022\u5e746\u670819\u65e5","tags":[],"readingTime":4.585,"truncated":false,"authors":[],"frontMatter":{},"prevItem":{"title":"dpdk/\u8bb0\u5f55\u4e00\u6b21\u7f16\u8bd1\u5668\u7248\u672c\u8fc7\u4f4e\u5bfc\u81f4dpdk\u65e0\u6cd5\u6210\u529f\u7f16\u8bd1\u7684\u95ee\u9898","permalink":"/longyu.github.io/blog/dpdk/\u8bb0\u5f55\u4e00\u6b21\u7f16\u8bd1\u5668\u7248\u672c\u8fc7\u4f4e\u5bfc\u81f4dpdk\u65e0\u6cd5\u6210\u529f\u7f16\u8bd1\u7684\u95ee\u9898"},"nextItem":{"title":"libc/\u4f7f\u7528mtrace\u8ddf\u8e2a\u5185\u5b58\u6cc4\u9732\u95ee\u9898","permalink":"/longyu.github.io/blog/libc/\u4f7f\u7528mtrace\u8ddf\u8e2a\u5185\u5b58\u6cc4\u9732\u95ee\u9898"}},"content":"## \u547d\u4ee4\u884c\u6307\u5b9a CFLAGS \u4e0d\u751f\u6548\\ndpdk \u7684 Makefile \u4e2d\u6709\u5bf9 CFLAGS \u7684\u8bbe\u5b9a\uff0c\u5728\u5f88\u591a Makefile \u5355\u72ec\u8bbe\u5b9a\u4e86 CFLAGS \u589e\u52a0 -O3 \u53c2\u6570\u3002\\n\\n\u4e0b\u9762\u662f dpdk-17.05 \u4e2d\u4e00\u4e9b Makefile \u5728 CFLAGS \u6807\u5fd7\u4e2d\u589e\u52a0 -O3 \u9009\u9879\u7684\u8bed\u53e5\u3002\\n\\n```\\n.......\\n./lib/librte_reorder/Makefile:37:CFLAGS += -O3\\n./drivers/net/fm10k/Makefile:39:CFLAGS += -O3\\n./drivers/net/tap/Makefile:42:CFLAGS += -O3\\n./drivers/net/pcap/Makefile:40:CFLAGS += -O3\\n./drivers/net/sfc/Makefile:38:CFLAGS += -O3\\n./drivers/net/vhost/Makefile:41:CFLAGS += -O3\\n./drivers/net/null/Makefile:39:CFLAGS += -O3\\n./drivers/net/mlx4/Makefile:47:CFLAGS += -O3\\n./drivers/net/af_packet/Makefile:45:CFLAGS += -O3\\n........\\n```\\n\u5168\u5c40\u8bbe\u5b9a ```export CFLAGS=\\" -O0 0g\\"```\u540e\u91cd\u65b0\u7f16\u8bd1\u53d1\u73b0\u8fd8\u662f\u4f7f\u7528\u4e86 -O3 \u7f16\u8bd1\uff0c\u8fd9\u8868\u660e dpdk \u7684\u7f16\u8bd1\u811a\u672c\u4e2d\u5bf9 CFLAGS \u7684\u503c\u91cd\u65b0\u8fdb\u884c\u4e86\u8bbe\u5b9a\uff0c**\u4e0d\u80fd\u901a\u8fc7\u547d\u4ee4\u884c\u6307\u5b9a CFLAGS \u6765\u7f16\u8bd1\u51fa debug \u7248\u672c\u3002**\\n\\n\u5728 doc \u76ee\u5f55\u4e0b\u627e\u5230\u4e86\u5982\u4e0b\u76f8\u5173\u5185\u5bb9\uff1a\\n```rst\\n331 Variables that Can be Set/Overridden in a Makefile Only\\n332 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\\n333 \\n334 *   VPATH: The path list that the build system will search for sources. By default, RTE_SRCDIR will be included in VPATH.\\n335 \\n336 *   CFLAGS: Flags to use for C compilation. The user should use +=  to append data in this variable.\\n337 \\n```\\n\u4ece\u4e0a\u9762\u7684\u5185\u5bb9\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0c\u7528\u6237\u4e0d\u80fd\u901a\u8fc7\u547d\u4ee4\u884c\u8bbe\u5b9a CFLAGS\uff0c\u53ea\u80fd\u901a\u8fc7 Makefile \u6587\u4ef6\u6765\u8bbe\u5b9a\u3002\\n\\n## \u547d\u4ee4\u884c\u8bbe\u7f6e EXTRA_CFLAGS \u6807\u5fd7\u751f\u6210 debug \u7248\\n\u7ee7\u7eed\u9605\u8bfb doc \u76ee\u5f55\u4e2d\u7684\u5e2e\u52a9\u6587\u6863\uff0c\u6211\u53d1\u73b0 EXTRA_CFLAGS \u6807\u5fd7\u53ef\u4ee5\u4f7f\u7528\u3002\u6587\u6863\u4e2d\u76f8\u5173\u7684\u5185\u5bb9\u6458\u53d6\u5982\u4e0b\uff1a\\n\\n```rst\\nVariables that Can be Set/Overridden by the User in a Makefile or Command Line\\n389 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\\n390 \\n391 *   CFLAGS_my_file.o: Specific flags to add for C compilation of my_file.c.\\n392 \\n393 *   LDFLAGS_my_app: Specific flags to add when linking my_app.\\n394     \\n395 *   EXTRA_CFLAGS: The content of this variable is appended after CFLAGS when compiling.\\n396 \\n397 *   EXTRA_LDFLAGS: The content of this variable is appended after LDFLAGS when linking.\\n398 \\n399 *   EXTRA_LDLIBS: The content of this variable is appended after LDLIBS when linking.\\n400 \\n401 *   EXTRA_ASFLAGS: The content of this variable is appended after ASFLAGS when assembling.\\n402 \\n403 *   EXTRA_CPPFLAGS: The content of this variable is appended after CPPFLAGS when using a C preprocessor on assembly files.\\n```\\n\\n\u4e0a\u9762\u7684\u4ecb\u7ecd\u8868\u660e EXTRA_CFLAGS \u53d8\u91cf\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4\u884c\u8fdb\u884c\u8bbe\u5b9a\uff0c\u540c\u65f6\u5b83\u4f1a\u5728\u7f16\u8bd1\u65f6\u8ffd\u52a0\u5230 CFLAGS \u5185\u5bb9\u4e4b\u540e\u3002\\n\\n\u6267\u884c export EXTRA_CFLAGS=\\"-O0 -g\\" \u540e\u91cd\u65b0\u7f16\u8bd1 dpdk \u7684\u5e93\uff0c\u4f7f\u7528 gdb \u8c03\u8bd5 app \u76ee\u5f55\u4e0b\u751f\u6210\u7684\u53ef\u6267\u884c\u6587\u4ef6\u53d1\u73b0 gdb \u80fd\u591f\u8bfb\u53d6\u5230\u8c03\u8bd5\u4fe1\u606f\u3002\\n\\n\u867d\u7136\u6709\u4e86\u8c03\u8bd5\u4fe1\u606f\uff0c\u4f46\u662f Makefile \u4e2d\u5bf9 CFLAGS \u53d8\u91cf\u589e\u52a0\u7684 -O3 \u9009\u9879\u53ef\u80fd\u610f\u5473\u7740\u7f16\u8bd1\u51fa\u6765\u7684\u662f O3 \u7248\u672c\u7684\u7a0b\u5e8f\uff0c\u8fd9\u6837\u5c31\u4e0d\u80fd\u7b97\u4f5c\u662f debug \u7248\u672c\u3002\\n\\n\u6211\u67e5\u770b\u7f16\u8bd1\u7f16\u8bd1\u76ee\u5f55\u4e2d *.o.cmd \u4e2d\u4fdd\u5b58\u7684\u7f16\u8bd1\u547d\u4ee4\uff0c\u53d1\u73b0\u5e93\u51fd\u6570\u7684\u7f16\u8bd1\u547d\u4ee4\u4e2d\u540c\u65f6\u8bbe\u5b9a\u4e86 -O3 \u4e0e -O0 -g \u53c2\u6570\u3002\\n\\n\u793a\u4f8b\u5982\u4e0b\uff1a\\n\\n```bash\\n[longyu@debian-10:22:02:09] x86_64-native-linuxapp-gcc $ cat ./build/lib/librte_eal/linuxapp/eal/.eal_alarm.o.cmd \\ncmd_eal_alarm.o = gcc -Wp,-MD,./.eal_alarm.o.d.tmp  -m64 -pthread  -march=native -DRTE_MACHINE_CPUFLAG_SSE -DRTE_MACHINE_CPUFLAG_SSE2 -DRTE_MACHINE_CPUFLAG_SSE3 -DRTE_MACHINE_CPUFLAG_SSSE3 -DRTE_MACHINE_CPUFLAG_SSE4_1 -DRTE_MACHINE_CPUFLAG_SSE4_2 -DRTE_MACHINE_CPUFLAG_AES -DRTE_MACHINE_CPUFLAG_PCLMULQDQ -DRTE_MACHINE_CPUFLAG_AVX -DRTE_MACHINE_CPUFLAG_RDRAND -DRTE_MACHINE_CPUFLAG_FSGSBASE -DRTE_MACHINE_CPUFLAG_F16C -DRTE_MACHINE_CPUFLAG_AVX2  -I/home/longyu/Downloads/dpdk-stable-17.02.1/x86_64-native-linuxapp-gcc/include -include /home/longyu/Downloads/dpdk-stable-17.02.1/x86_64-native-linuxapp-gcc/include/rte_config.h -I/home/longyu/Downloads/dpdk-stable-17.02.1/lib/librte_eal/linuxapp/eal/include -I/home/longyu/Downloads/dpdk-stable-17.02.1/lib/librte_eal/common -I/home/longyu/Downloads/dpdk-stable-17.02.1/lib/librte_eal/common/include -W -Wall -Wstrict-prototypes -Wmissing-prototypes -Wmissing-declarations -Wold-style-definition -Wpointer-arith -Wcast-align -Wnested-externs -Wcast-qual -Wformat-nonliteral -Wformat-security -Wundef -Wwrite-strings -O3  -O0 -g  -o eal_alarm.o -c /home/longyu/Downloads/dpdk-stable-17.02.1/lib/librte_eal/linuxapp/eal/eal_alarm.c  \\n```\\n\\n\u67e5\u770b\u5230\u7f16\u8bd1\u547d\u4ee4\uff0c\u6211\u60f3\u5230\u4e86\u4e00\u4e2a\u95ee\u9898\u2014\u2014**\u6307\u5b9a\u4e86\u591a\u4e2a\u4f18\u5316\u9009\u9879\u65f6 gcc \u7f16\u8bd1\u65f6\u4f1a\u4f7f\u7528\u54ea\u4e2a\u5462\uff1f**\\n\\n## gcc \u540c\u65f6\u6307\u5b9a\u591a\u4e2a\u4f18\u5316\u9009\u9879\u7684\u95ee\u9898\\n\u7ecf\u8fc7\u641c\u7d22\uff0c\u6211\u53d1\u73b0 gcc \u7684\u5b98\u65b9\u7f51\u9875\u4e2d\u5bf9\u8fd9\u4e2a\u95ee\u9898\u8fdb\u884c\u4e86\u63cf\u8ff0\u3002\u5f53 gcc \u7f16\u8bd1\u547d\u4ee4\u4e2d\u6307\u5b9a\u4e86\u591a\u4e2a\u4f18\u5316\u9009\u9879\u65f6\uff0c\u53ea\u6709\u6700\u540e\u4e00\u4e2a\u4f18\u5316\u9009\u9879\u751f\u6548\u3002\\n\\n-O3 \u662f\u5728 CFLAGS \u53d8\u91cf\u4e2d\u6307\u5b9a\u7684\uff0cEXTRA_CFLAGS \u662f\u6211\u4eec\u5728\u547d\u4ee4\u884c\u4e2d\u6307\u5b9a\u7684\uff0c\u6839\u636e dpdk \u7684\u5e2e\u52a9\u6587\u6863\u4e2d\u7684\u8bf4\u660e\uff0cEXTRA_CFLAGS \u7684\u503c\u4f1a\u5728\u7f16\u8bd1\u65f6\u8ffd\u52a0\u5230 CFLAGS \u7684\u503c\u540e\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u770b\u5230\u4e86\u6709 -O3 ..... -O0 -g \u8fd9\u6837\u7684\u7f16\u8bd1\u547d\u4ee4\u3002\\n\\n-O0 \u662f\u6700\u540e\u4e00\u4e2a\u6307\u5b9a\u7684\u4f18\u5316\u9009\u9879\uff0c\u5b9e\u9645\u751f\u6548\u7684\u662f -O0\uff0c\u800c\u975e -O3\uff0c\u8fd9\u6837\u6211\u4eec\u901a\u8fc7\u8bbe\u5b9a EXTRA_CFLAGS \u4e3a -O0 -g \u5c31\u80fd\u591f\u7f16\u8bd1\u51fa debug \u7248\u672c\u7684 dpdk\u3002\\n\\n\u5907\u6ce8: EXTRA_CFLAGS \u662f\u5728  mk/internal/rte.compile-pre.mk \u4e2d\u4f7f\u7528\u7684\u3002\\n\\n## \u6700\u7ec8\u786e\u5b9a\u7684\u7f16\u8bd1 dpdk debug \u7248\u672c\u7684\u65b9\u6cd5\\n\u547d\u4ee4\u884c\u4e2d\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u8bbe\u5b9a EXTRA_CFLAGS \u540e\u91cd\u65b0\u7f16\u8bd1\u5373\u53ef\u3002\\n\\n```bash\\nexport EXTRA_CFLAGS=\\"-O0 -g\\"\\n```"},{"id":"/libc/\u4f7f\u7528mtrace\u8ddf\u8e2a\u5185\u5b58\u6cc4\u9732\u95ee\u9898","metadata":{"permalink":"/longyu.github.io/blog/libc/\u4f7f\u7528mtrace\u8ddf\u8e2a\u5185\u5b58\u6cc4\u9732\u95ee\u9898","editUrl":"https://github.com/longyuwlz/longyu.github.io/blog/libc/\u4f7f\u7528mtrace\u8ddf\u8e2a\u5185\u5b58\u6cc4\u9732\u95ee\u9898.md","source":"@site/blog/libc/\u4f7f\u7528mtrace\u8ddf\u8e2a\u5185\u5b58\u6cc4\u9732\u95ee\u9898.md","title":"libc/\u4f7f\u7528mtrace\u8ddf\u8e2a\u5185\u5b58\u6cc4\u9732\u95ee\u9898","description":"\u524d\u8a00","date":"2022-06-19T07:40:00.000Z","formattedDate":"2022\u5e746\u670819\u65e5","tags":[],"readingTime":20.065,"truncated":false,"authors":[],"frontMatter":{},"prevItem":{"title":"dpdk/\u8bbe\u7f6eEXTRA_CFLAGS\u4ee5\u7f16\u8bd1debug\u7248\u672cdpdk\u5e93","permalink":"/longyu.github.io/blog/dpdk/\u8bbe\u7f6eEXTRA_CFLAGS\u4ee5\u7f16\u8bd1debug\u7248\u672cdpdk\u5e93"},"nextItem":{"title":"linux-kernel/linux-\u5185\u6838\u6a21\u5757\u4e2d\u5f15\u7528\u7b26\u53f7\u662f\u5982\u4f55\u94fe\u63a5\u7684","permalink":"/longyu.github.io/blog/linux-kernel/linux-\u5185\u6838\u6a21\u5757\u4e2d\u5f15\u7528\u7b26\u53f7\u662f\u5982\u4f55\u94fe\u63a5\u7684"}},"content":"## \u524d\u8a00\\n\u7814\u7a76\u52a8\u6001\u94fe\u63a5\u7684\u539f\u7406\u4e2d\uff0c\u65e0\u610f\u95f4\u53d1\u73b0\u4e86 **mtrace** \u8fd9\u4e2a\u4e1c\u4e1c\u3002\u5b83\u662f\u4e00\u4e2a libc \u5e93\u63d0\u4f9b\u7684\u51fd\u6570\uff0c**\u901a\u8fc7\u5411 malloc\u3001calloc\u3001free \u7b49\u51fd\u6570\u6ce8\u518c hook \u51fd\u6570\u6765\u5b9e\u73b0\u5185\u5b58\u7533\u8bf7\u4e0e\u91ca\u653e\u7684\u8ddf\u8e2a**\uff0c\u53ef\u4ee5\u7528\u6765**\u5b9a\u4f4d\u5185\u5b58\u6cc4\u9732\u95ee\u9898**\u3002\\n\\n\u5728\u672c\u6587\u4e2d\uff0c\u6211\u5c06\u63cf\u8ff0\u4e00\u4e2a\u5177\u4f53\u7684\u4f7f\u7528\u5b9e\u4f8b\uff0c\u53ca\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u9047\u5230\u7684\u4e00\u4e9b\u95ee\u9898\u3002\\n## mtrace \u793a\u4f8b demo\\n**man 3 mtrace** \u67e5\u770b manual \u4fe1\u606f\uff0c\u53d1\u73b0 manual \u4e2d\u5df2\u7ecf\u63d0\u4f9b\u4e86\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u793a\u4f8b demo\uff0c\u5176\u6e90\u7801\u5982\u4e0b\uff1a\\n\\n```c\\n#include <mcheck.h>\\n#include <stdlib.h>\\n#include <stdio.h>\\n\\nint\\nmain(int argc, char *argv[])\\n{\\n    int j;\\n\\n    mtrace();\\n\\n    for (j = 0; j < 2; j++)\\n        malloc(100);            /* Never freed--a memory leak */\\n\\n    calloc(16, 16);             /* Never freed--a memory leak */\\n    exit(EXIT_SUCCESS);\\n}\\n```\\n\u5c06\u4e0a\u8ff0\u4ee3\u7801\u4fdd\u5b58\u4e3a t_mtrace.c \u6e90\u6587\u4ef6\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u7f16\u8bd1\uff1a\\n\\n```bash\\ngcc -g t_mtrace.c -o t_mtrace\\n```\\n\u5728\u8fd0\u884c\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u8bbe\u5b9a **MALLOC_TRACE** \u73af\u5883\u53d8\u91cf\uff0c\u8fd9\u4e2a\u73af\u5883\u53d8\u91cf\u6307\u5411 mtrace \u8f93\u51fa\u8bb0\u5f55\u6587\u4ef6\u7684\u8def\u5f84\u3002\\n\\nMALLOC_TRACE \u8bbe\u5b9a\u793a\u4f8b\u5982\u4e0b\uff1a\\n\\n```bash\\n export MALLOC_TRACE=/tmp/t\\n```\\n\u8bbe\u5b9a\u4e86\u8fd9\u4e2a\u53d8\u91cf\u4e4b\u540e\u5c31\u53ef\u4ee5\u8fd0\u884c **t_mtrace** \u7a0b\u5e8f\uff0c\u8fd0\u884c\u5b8c\u6210\u540e /tmp/t \u6587\u4ef6\u4e2d\u5c06\u4f1a\u4fdd\u5b58\u8f93\u51fa\u7684\u8bb0\u5f55\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a\\n\\n```bash\\n[longyu@debian-10:19:25:40] program-problem $ cat /tmp/t\\n= Start\\n@ ./t_mtrace:[0x55555555518c] + 0x5555555596a0 0x64\\n@ ./t_mtrace:[0x55555555518c] + 0x555555559710 0x64\\n@ ./t_mtrace:[0x5555555551a5] + 0x555555559780 0x100\\n```\\n**/tmp/t** \u7684\u8f93\u51fa\u5e76\u4e0d\u76f4\u89c2\uff0clibc \u5e93\u63d0\u4f9b\u4e86\u4e00\u4e2a\u540c\u6837\u540d\u4e3a mtrace \u7684 perl \u811a\u672c\u6765\u89e3\u6790\u8fd9\u4e2a\u8bb0\u5f55\uff0cmtrace \u811a\u672c\u9700\u8981\u63d0\u4f9b\u4e24\u4e2a\u53c2\u6570\uff0c\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a**\u53ef\u6267\u884c\u7a0b\u5e8f\u7684\u8def\u5f84\u540d**\uff0c\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a **mtrace \u51fd\u6570\u8f93\u51fa\u7684\u8bb0\u5f55\u6587\u4ef6**\u3002\\n\\n\u6267\u884c\u793a\u4f8b\u5982\u4e0b\uff1a\\n\\n```bash\\n[longyu@debian-10:19:29:08] program-problem $ mtrace ./t_mtrace $MALLOC_TRACE\\n\\nMemory not freed:\\n-----------------\\n           Address     Size     Caller\\n0x00005555555596a0     0x64  at 0x55555555518c\\n0x0000555555559710     0x64  at 0x55555555518c\\n0x0000555555559780    0x100  at 0x5555555551a5\\n```\\n\u8fd9\u91cc\u6211\u5f97\u5230\u7684\u8f93\u51fa\u4fe1\u606f\u4e0e manual \u4e2d\u7684\u4fe1\u606f\u4e0d\u540c\uff0c**\u6ca1\u6709\u663e\u793a\u51fa\u8c03\u7528\u8005\u6240\u5728\u6e90\u7801\u4e2d\u7684\u884c\u53f7\u3002**\\n\\nmanual \u4e2d\u7684\u8f93\u51fa\u4fe1\u606f\u5982\u4e0b\uff1a\\n```bash\\n           $ mtrace ./t_mtrace $MALLOC_TRACE\\n           Memory not freed:\\n           -----------------\\n              Address     Size     Caller\\n           0x084c9378     0x64  at /home/cecilia/t_mtrace.c:12\\n           0x084c93e0     0x64  at /home/cecilia/t_mtrace.c:12\\n           0x084c9448    0x100  at /home/cecilia/t_mtrace.c:16\\n```\\n\u91cd\u65b0 **check** \u6211\u7684\u8fd0\u884c\u8fc7\u7a0b\uff0c\u6211\u786e\u5b9a\u4e0e manual \u4e2d\u63cf\u8ff0\u7684\u4e00\u81f4\uff0c\u770b\u6765\u4e00\u5b9a\u662f\u54ea\u91cc\u51fa\u4e86\u95ee\u9898\u4e86\u3002\\n\\n## \u5bf9 mtrace \u811a\u672c\u89e3\u6790\u4e0d\u5230\u884c\u53f7\u95ee\u9898\u7684\u89e3\u51b3\u8fc7\u7a0b\\n\u5bf9\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u6700\u5f00\u59cb\u8fdb\u884c\u4e86\u5982\u4e0b\u5c1d\u8bd5\uff1a\\n\\n1. -O0 -g \u7f16\u8bd1\u540e\u6d4b\u8bd5\u53d1\u73b0\u4ecd\u65e7\u6ca1\u6709\u6253\u5370\\n2. \u4fee\u6539\u6587\u4ef6\u540d\u4e3a\u7edd\u5bf9\u8def\u5f84\u540e\u4e5f\u6ca1\u6709\u6253\u5370\\n3. \u5bf9\u6bd4\u52a0\u4e86-g\u3001\u6ca1\u6709\u52a0 -g  /tmp/t \u6587\u4ef6\u7684\u533a\u522b\uff0c\u53d1\u73b0\u5185\u5bb9\u5b8c\u5168\u76f8\u540c\\n4. \u7f51\u4e0a\u641c\u7d22\u53d1\u73b0\u6709\u76f8\u5173\u7684\u63cf\u8ff0\uff0c\u4e0d\u8fc7\u7f51\u9875\u4e2d\u540c manual \u4e2d\u4e00\u6837\u80fd\u591f\u663e\u793a\u6e90\u4ee3\u7801\u884c\u53f7\\n\\n\u5728\u4e0a\u9762\u7684\u5c1d\u8bd5\u90fd\u5931\u8d25\u540e\uff0c\u6211\u5f00\u59cb\u4f7f\u7528 strace \u5927\u6cd5\u3002\u7528\u4e86 strace \u540e\u770b\u5230\u4e86\u4e00\u5806\u7cfb\u7edf\u8c03\u7528\uff0c\u5176\u4e2d**\u6709\u6267\u884c addr2line \u7684\u8fc7\u7a0b**\uff0c\u770b\u6765\u8fd9\u4e2a mtrace \u811a\u672c\u5b9e\u9645\u662f\u8fd0\u884c addr2line \u547d\u4ee4\u83b7\u53d6\u5230\u7684\u884c\u53f7\uff0c\u90a3**\u95ee\u9898\u662f\u5426\u51fa\u5728 addr2line \u4e2d\u5462\uff1f**\\n\\n\u6211\u5355\u72ec\u4f7f\u7528 addr2line \u83b7\u53d6 /tmp/t \u4e2d\u51fd\u6570\u8c03\u7528\u5730\u5740\u5bf9\u5e94\u7684\u884c\u53f7\uff0c\u53d1\u73b0\u6839\u672c\u83b7\u53d6\u4e0d\u5230\u4efb\u4f55\u4fe1\u606f\uff0c\u8f93\u51fa\u5185\u5bb9\u4e3a ??\u3002\\n\\n\u641e\u5230\u8fd9\u91cc\u6211\u8fd8\u662f\u6ca1\u6709\u53d1\u73b0\u6839\u672c\u95ee\u9898\uff0c\u53ea\u80fd\u786c\u7740\u5934\u76ae\u7528 perl -d \u6765\u8fd0\u884c\u8fd9\u4e2a mtrace \u811a\u672c\uff0c\u8c03\u8bd5\u4e86\u4e0b\u4e5f\u6ca1\u6709\u53d1\u73b0\u5173\u952e\u7684\u70b9\u3002\\n\\n### \u8fdb\u4e00\u6b65\u7684\u5206\u6790\\n\u5728\u4e00\u7cfb\u5217\u7684\u5c1d\u8bd5\u540e\uff0c\u6211\u6682\u65f6\u6ca1\u6709\u627e\u5230\u4e00\u4e2a\u89e3\u51b3\u65b9\u6848\uff0c\u4e0d\u8fc7\u6211\u89c9\u5f97 **addr2line \u662f\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u6000\u7591\u5bf9\u8c61**\u3002\u4e3a\u4e86\u9a8c\u8bc1\u6211\u7684\u731c\u6d4b\uff0c\u6211\u5c06\u4ee3\u7801\u8fdb\u884c\u4e86\u5982\u4e0b\u4fee\u6539\uff1a\\n\\n```c\\n#include <mcheck.h>\\n#include <stdlib.h>\\n#include <stdio.h>\\n\\nint\\nmain(int argc, char *argv[])\\n{\\n    int j;\\n\\n    mtrace();\\n\\t\\t\\t\\t\\n    printf(\\"%p\\\\n\\", mtrace);\\n    for (j = 0; j < 2; j++)\\n        malloc(100);            /* Never freed--a memory leak */\\n\\n    calloc(16, 16);             /* Never freed--a memory leak */\\n    pause();\\n    exit(EXIT_SUCCESS);\\n}\\n```\\n\\n\u6211\u8fd9\u91cc\u6253\u5370\u51fa\u4e86 **mtrace \u51fd\u6570\u7684\u5730\u5740**\uff0c\u7f16\u8bd1\u5e76\u6267\u884c\u540e\u4f1a\u5f97\u5230 mtrace \u51fd\u6570\u7684\u5730\u5740\uff0c\u7136\u540e\u6211\u4f7f\u7528 addr2line \u547d\u4ee4\uff0c\u6307\u5b9a\u8fd9\u4e2a\u5730\u5740\u6765\u83b7\u53d6\u6e90\u7801\u884c\u53f7\uff0c\u53d1\u73b0\u4ecd\u65e7\u6253\u5370\u7684\u662f ??\uff0c\u8fd9\u8ba9\u6211\u89c9\u7684\u5f88\u5927\u6982\u7387\u662f **addr2line \u547d\u4ee4\u7684\u95ee\u9898**\u3002\\n\\n\u5728\u8fd9\u4e2a\u57fa\u7840\u4e0a\uff0c\u6211\u6267\u884c **objdump -d \u53cd\u6c47\u7f16\u53ef\u6267\u884c\u6587\u4ef6**\uff0c\u7136\u540e\u4f7f\u7528 main \u51fd\u6570\u7684**\u76f8\u5bf9\u5730\u5740\u4e3a\u53c2\u6570**\u7ee7\u7eed\u8c03\u7528 addr2line \u547d\u4ee4\u6765\u89e3\u6790\uff0c\u8fd9\u4e00\u6b21**\u80fd\u591f\u89e3\u6790\u5230\u4e86\u3002**\\n\\n\u6d4b\u8bd5\u8fc7\u7a0b\u8bb0\u5f55\u5982\u4e0b\uff1a\\n\\n```bash\\n[longyu@debian-10:19:50:39] program-problem $ objdump -d t_mtrace | grep main\\n    109d:\\t48 8d 3d c1 00 00 00 \\tlea    0xc1(%rip),%rdi        # 1165 <main>\\n    10a4:\\tff 15 2e 2f 00 00    \\tcallq  *0x2f2e(%rip)        # 3fd8 <__libc_start_main@GLIBC_2.2.5>\\n0000000000001165 <main>:\\n    119b:\\teb 0e                \\tjmp    11ab <main+0x46>\\n    11af:\\t7e ec                \\tjle    119d <main+0x38>\\n[longyu@debian-10:19:50:44] program-problem $ addr2line -e ./t_mtrace 1165\\n/home/longyu/problem_and_solution/program-problem/./t_mtrace.c:7\\n```\\n\u53ef\u4ee5\u770b\u5230\u5728\u6700\u540e\u4e00\u884c\uff0caddr2line \u6253\u5370\u51fa\u4e86\u884c\u53f7\uff01\\n\\n\u7136\u540e\u4f7f\u7528 gdb \u8fd0\u884c\uff0cstart \u540e\u5728 main \u51fd\u6570\u5904\u505c\u4e0b\u6765\u540e\uff0c\u53cd\u6c47\u7f16 main \u51fd\u6570\uff0c\u53d1\u73b0 **main \u51fd\u6570\u7684\u5730\u5740\u4e0e objdump -d \u7684\u8f93\u51fa\u5b8c\u5168\u4e0d\u540c**\uff0c\u770b\u6765\u5e94\u8be5\u662f**\u57fa\u5730\u5740\u88ab\u4fee\u6539\u4e86\u3002**\\n\\n\u6d4b\u8bd5\u8bb0\u5f55\u5982\u4e0b\uff1a\\n```bash\\n(gdb) start\\nTemporary breakpoint 1 at 0x1174: file ./mtrace.c, line 10.\\nStarting program: /home/longyu/problem_and_solution/program-problem/t_mtrace \\n\\nTemporary breakpoint 1, main (argc=1, argv=0x7fffffffdae8) at ./mtrace.c:10\\n10\\t               mtrace();\\n(gdb) disass main\\nDump of assembler code for function main:\\n   0x0000555555555165 <+0>:\\tpush   %rbp\\n```\\n\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc main \u51fd\u6570\u7684\u5730\u5740\u53d8\u4e3a\u4e86 **0x0000555555555165**\uff0c\u8fd9\u5c31\u9020\u6210 addr2line \u547d\u4ee4\u4e0d\u80fd\u89e3\u6790\u5230\u6e90\u7801\u884c\u53f7\u3002\\n\\n### \u5173\u95ed ASLR\\n**\u518d\u6b21\u6267\u884c\u6b64\u7a0b\u5e8f**\uff0c\u6211\u53d1\u73b0\u6bcf\u6b21\u6253\u5370\u7684 mtrace \u51fd\u6570\u7684\u5730\u5740\u90fd\u4e0d\u4e00\u6837\uff0c\u8fd9\u70b9\u8ba9\u6211\u60f3\u8d77\u4e86 ASLR \u8fd9\u4e2a\u529f\u80fd\uff0c\u9996\u5148\u67e5\u770b /proc/sys/kernel/randomize_va_space \u6587\u4ef6\u7684\u5185\u5bb9\uff0c\u53d1\u73b0\u503c\u4e3a 2 \u8868\u793a**\u8fd9\u4e2a\u529f\u80fd\u786e\u5b9e\u662f\u6253\u5f00\u7684\u3002**\\n\\n\u4f7f\u7528 root \u6743\u9650\u5411 /proc/sys/kernel/randomize_va_space \u6587\u4ef6\u5199\u5165 0 \u5173\u95ed\u8fd9\u4e2a\u529f\u80fd\u540e\uff0c\u91cd\u65b0\u6267\u884c\u4e0a\u9762\u7684\u6d4b\u8bd5\uff0c\u53d1\u73b0**\u4ecd\u65e7\u4e0d\u80fd\u83b7\u53d6\u5230\u884c\u53f7\u4fe1\u606f**\u3002\\n\\n\u770b\u6765\u8fd8\u662f\u5f97\u4ece addr2line \u547d\u4ee4\u4e0a\u7740\u624b\uff01\\n\\n### \u4ee5 addr2line cannot work \u4e3a\u5173\u952e\u8bcd\u641c\u7d22\u4e92\u8054\u7f51\\n\u4f7f\u7528 addr2line cannot work \u641c\u7d22\u540e\uff0c\u6211\u5728 [addr2line cannot decode addresses that gdb does](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=860394) \u8fd9\u7bc7\u94fe\u63a5\u4e2d\u770b\u5230\u4e86\u5982\u4e0b\u5173\u952e\u4fe1\u606f\uff1a\\n\\n```\\nThere are 2 things going on. First, by default gcc is now building\\nexecutables as position independent (-pie). This can be explicitly\\ndisabled with the -no-pie linking option. Disabling PIE should result in\\nthings working as they did before.\\n\\nThe second thing going on is Address Space Layout Randomization\\n(ASLR). This is now active by default and will cause all PIE executables\\nto be loaded to random addresses. This can be disabled globally with\\nsysctl:\\n\\n    $ sudo sysctl -w kernel.randomize_va_space=0\\n\\nOr with a boot argument:\\n\\n    norandmaps\\n\\nOr (preferrably) locally for the process you are interested:\\n\\n    $ setarch `uname -m` -R /some/program\\n\\nOften it is convenient to use the above command with /bin/bash so as to\\nquickly create a non-randomized environment for yourself.\\n\\nHowever, be aware that even when ASLR is disabled, if it is a PIE\\nexectuable, it will always load to the same address, but that is not the\\naddress within the executable. That means that for PIE executables, many\\nbinutils (such as addr2line) will require you to recalculate the offset.\\n```\\n\u6211**\u5df2\u7ecf\u5173\u95ed\u4e86 ASLR \u529f\u80fd**\uff0c\u5bf9\u5e94\u4e0a\u8ff0\u63cf\u8ff0\u7684\u7b2c\u4e8c\u70b9\uff0c\u7b2c\u4e00\u70b9\u63cf\u8ff0\u8bf4\u4e0e pie \u6709\u5173\uff0c\u901a\u8fc7\u6307\u5b9a **-no-pie** \u53c2\u6570\u91cd\u65b0\u7f16\u8bd1\u4e0a\u8ff0\u7a0b\u5e8f\uff0c\u76f4\u63a5\u5728 gdb \u4e2d\u8fd0\u884c\uff0c\u518d\u6b21\u53cd\u6c47\u7f16 main \u51fd\u6570\uff0c\u8fd9\u6b21\u5f97\u5230\u4e86\u5982\u4e0b\u8f93\u51fa\u4fe1\u606f\uff1a\\n\\n```bash\\n(gdb) start\\nTemporary breakpoint 1 at 0x401171: file ./mtrace.c, line 10.\\nStarting program: /home/longyu/problem_and_solution/program-problem/t_mtrace \\n\\nTemporary breakpoint 1, main (argc=1, argv=0x7fffffffdae8) at ./mtrace.c:10\\n10\\t               mtrace();\\n(gdb) disass main\\nDump of assembler code for function main:\\n   0x0000000000401162 <+0>:\\tpush   %rbp\\n```\\n\u53ef\u4ee5\u770b\u5230\u8fd9\u6b21\uff0cmain \u51fd\u6570\u5730\u5740\u53d8\u4e3a\u4e86 **0x401162**\uff0cobjdump -d \u8f93\u51fa\u7684 main \u51fd\u6570\u5730\u5740\u5982\u4e0b\uff1a\\n\\n```bash\\n0000000000401162 <main>:\\n  401162:\\t55                   \\tpush   %rbp\\n```\\n\u53ef\u4ee5\u770b\u5230\uff0c**\u8fd9\u6b21 objdump \u5f97\u5230\u7684\u51fd\u6570\u5730\u5740\u4e0e\u8fd0\u884c\u65f6\u7684\u5730\u5740\u4e00\u81f4\u4e86**\uff0c\u770b\u6765\u5e94\u8be5\u6ca1\u6709\u95ee\u9898\u4e86\u3002\\n\\n\u8fd0\u884c\u7a0b\u5e8f\u540e\uff0c\u7ee7\u7eed\u67e5\u770b /tmp/t \u7684\u5185\u5bb9\uff0c\u8fd9\u6b21\u5f97\u5230\u4e86\u5982\u4e0b\u4fe1\u606f\uff1a\\n\\n```bash\\n[longyu@debian-10:20:09:00] program-problem $ cat /tmp/t\\n= Start\\n@ /lib/x86_64-linux-gnu/libc.so.6:(_IO_file_doallocate+0x8c)[0x7ffff7e5971c] + 0x4056a0 0x400\\n@ ./t_mtrace:[0x4011a4] + 0x405ab0 0x64\\n@ ./t_mtrace:[0x4011a4] + 0x405b20 0x64\\n@ ./t_mtrace:[0x4011bd] + 0x405b90 0x100\\n@ /lib/x86_64-linux-gnu/libc.so.6:[0x7ffff7f52ad4] - 0x4056a0\\n```\\n\u8fd9\u4e2a\u8f93\u51fa\u770b\u4e0a\u53bb\u975e\u5e38\u6b63\u5e38\uff0c\u770b\u6765\u95ee\u9898\u5e94\u8be5\u80fd\u591f\u5f97\u5230\u89e3\u51b3\u4e86\uff01\u518d\u6b21\u6267\u884c mtrace \u811a\u672c\uff0c\u8fd9\u6b21\u786e\u5b9e\u80fd\u591f\u83b7\u53d6\u5230\u6e90\u7801\u884c\u53f7\u4e86\uff0c\u64cd\u4f5c\u8bb0\u5f55\u5982\u4e0b\uff1a\\n\\n```bash\\n[longyu@debian-10:20:10:06] program-problem $ mtrace ./t_mtrace /tmp/t\\n\\nMemory not freed:\\n-----------------\\n           Address     Size     Caller\\n0x0000000000405ab0     0x64  at /home/longyu/problem_and_solution/program-problem/./t_mtrace.c:13 (discriminator 3)\\n0x0000000000405b20     0x64  at /home/longyu/problem_and_solution/program-problem/./t_mtrace.c:13 (discriminator 3)\\n0x0000000000405b90    0x100  at /home/longyu/problem_and_solution/program-problem/./t_mtrace.c:17\\n```\\n\u5982\u679c\u4f60\u5bf9\u8fd9\u91cc\u7684\u884c\u53f7\u8db3\u591f\u654f\u611f\uff0c\u4f60\u4f1a\u53d1\u73b0\u8fd9\u91cc\u7684\u884c\u53f7\u5e76\u4e0d\u51c6\u786e\uff0c\u5176\u5b9e\u5728 manual \u4e2d\u5df2\u7ecf\u8bf4\u660e\u4e86\u8fd9\u4e2a\u95ee\u9898\u3002\\n\\n\u4e0a\u8ff0 demo \u4e2d\u8c03\u7528\u4e86 malloc \u4e0e calloc \u51fd\u6570\u5e76\u4e14\u90fd\u6ca1\u6709\u8c03\u7528 free \u6765\u91ca\u653e\uff0c**\u6a21\u62df\u5185\u5b58\u6cc4\u9732\u7684\u60c5\u51b5**\uff0c\u6839\u636e mtrace \u7684\u8f93\u51fa\uff0c\u6211\u4eec\u5c31\u80fd\u591f\u9a6c\u4e0a\u5b9a\u4f4d\u5230\u5185\u5b58\u6cc4\u9732\u7684\u4f4d\u7f6e\u3002\\n\\n\u540c\u65f6\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5f53 **MALLOC_TRACE** \u6307\u5411\u4e86\u4e00\u4e2a\u5408\u6cd5\u7684\u53ef\u4ee5\u5199\u7684\u6587\u4ef6\u8def\u5f84\u65f6\uff0cmtrace \u80fd\u591f\u8fd0\u884c\uff0c\u4f46\u662f\u53ef\u80fd\u4f1a\u5e26\u6765**\u6027\u80fd\u4e0a\u7684\u635f\u8017\uff01**\\n## mtrace \u662f\u548b\u6837\u5b9e\u73b0\u7684\uff1f\\n\u89e3\u51b3\u4e86 addr2line \u4e0d\u80fd\u663e\u793a\u6e90\u7801\u884c\u53f7\u7684\u95ee\u9898\uff0cmtrace \u7b97\u6b63\u5f0f\u4e0a\u624b\u4e86\uff0c\u4e0b\u4e00\u4e2a\u95ee\u9898\u662f mtrace \u662f\u5982\u4f55\u5b9e\u73b0\u7684\u5462\uff1f\\n\\nmtrace \u51fd\u6570\u7684\u6e90\u7801\u4f4d\u4e8e glibc \u6e90\u7801\u4e2d\u7684 **malloc/mtrace.c** \u4e2d\uff0c\u6838\u5fc3\u903b\u8f91\u662f\u8bbe\u5b9a malloc\u3001calloc\u3001realloc\u3001free \u7b49\u51e0\u4e2a\u7533\u8bf7\u3001\u91ca\u653e\u5185\u5b58\u7a7a\u95f4\u51fd\u6570\u4f7f\u7528\u7684\u5185\u90e8 hook \u51fd\u6570\u3002\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\uff1a\\n\\n```c\\n308           tr_old_free_hook = __free_hook;\\n309           __free_hook = tr_freehook;\\n310           tr_old_malloc_hook = __malloc_hook;\\n311           __malloc_hook = tr_mallochook;\\n312           tr_old_realloc_hook = __realloc_hook;\\n313           __realloc_hook = tr_reallochook;                                                                                                                               \\n314           tr_old_memalign_hook = __memalign_hook;\\n315           __memalign_hook = tr_memalignhook;\\n```\\n\u90a3\u8fd9\u4e9b hook \u51fd\u6570\u662f\u5728\u54ea\u91cc\u88ab\u8c03\u7528\u7684\u5462\uff1f\u8fd9\u91cc\u6211\u4ee5 malloc \u51fd\u6570\u4e2d\u7684\u8c03\u7528\u4ee3\u7801\u4e3a\u4f8b\u6765\u63cf\u8ff0\uff0c\u65e8\u5728\u629b\u51fa**\u5982\u4f55\u83b7\u53d6\u8fd4\u56de\u5730\u5740**\u8fd9\u4e00\u95ee\u9898\u3002\\n\\n\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\uff1a\\n\\n```c\\n3018 void * \\n3019 __libc_malloc (size_t bytes)\\n3020 { \\n3021   mstate ar_ptr;\\n3022   void *victim;\\n3023   \\n3024   void *(*hook) (size_t, const void *)\\n3025     = atomic_forced_read (__malloc_hook);\\n3026   if (__builtin_expect (hook != NULL, 0))\\n3027     return (*hook)(bytes, RETURN_ADDRESS (0));\\n```\\n\u6ce8\u610f\u5f53 **__malloc_hook** \u4e0d\u4e3a NULL \u7684\u65f6\u5019\uff08\u8c03\u7528\u4e86 mtrace \u51fd\u6570\u4f1a\u8bbe\u5b9a __malloc_hook \u51fd\u6570\u6307\u9488\uff09\uff0c\u8be5 hook \u51fd\u6570\u4f1a\u88ab\u88ab\u8c03\u7528\uff0c\u8c03\u7528 hook \u51fd\u6570\u4f20\u9012\u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570 **RETURN_ADDRESS (0)** \u503c\u5f97\u7814\u7a76\u3002\\n\\n\u8fd9\u4e2a RETURN_ADDRESS(0) \u662f\u4e00\u4e2a\u5b8f\uff0c\u5176\u5b9a\u4e49\u5982\u4e0b\uff1a\\n\\n```c\\n/* Determine the return address.  */\\n#define RETURN_ADDRESS(nr) \\\\\\n  __builtin_extract_return_addr (__builtin_return_address (nr))\\n```\\n\u8fd9\u91cc\u4f7f\u7528\u4e86 gcc \u7684\u6269\u5c55\u529f\u80fd\u6765\u83b7\u53d6\u51fd\u6570\u7684\u8fd4\u56de\u5730\u5740\uff0c\u8fd9\u91cc\u7684 nr \u5bf9\u5e94\u7684\u662f\u6808\u5e27\u7684\u5c42\u7ea7\uff0c0 \u8868\u793a\u5f53\u524d\u51fd\u6570\u7684\u8fd4\u56de\u5730\u5740\uff0c\u653e\u5728\u8fd9\u5c31\u662f **malloc \u51fd\u6570\u6267\u884c\u5b8c\u6210\u540e\u7ee7\u7eed\u6267\u884c\u7684\u4e0b\u4e00\u6761\u6307\u4ee4\u5730\u5740\u3002**\\n\\n## __builtin_return_address \u662f\u5982\u4f55\u5b9e\u73b0\u7684\uff1f\\n\u5199\u5230\u8fd9\u91cc\u4e0e mtrace \u76f8\u5173\u7684\u5185\u5bb9\u544a\u4e00\u6bb5\u843d\uff0c\u5f00\u59cb\u8df3\u5230 __builtin_return_address \u7684\u5b9e\u73b0\u4e0a\u3002\\n\\n\u5173\u4e8e\u8fd9\u4e2a\u51fd\u6570\u7684\u5b9e\u73b0\uff0c\u6839\u636e\u4e4b\u524d\u5b66\u4e60 \u300aCSAPP\u300b\u7684\u5370\u8c61\uff0c\u5176\u5b9e\u5173\u952e\u5728\u4e8e\u83b7\u53d6\u5230\u6808\u4e2d\u4e0d\u540c\u6808\u5e27\u7684 EBP \u4e0e EIP \u7684\u503c\uff0c**EBP \u8868\u793a\u6808\u5e95\uff0c\u800c EIP \u5219\u662f\u8fd4\u56de\u5730\u5740\u3002**\\n\\n\u51fd\u6570\u8c03\u7528\u65f6\uff0c**\u53c2\u6570\u9996\u5148\u538b\u6808\uff0c\u6309\u7167\u4ece\u53f3\u5411\u5de6\u7684\u987a\u5e8f**\uff0c\u7136\u540e**\u8fd4\u56de\u5730\u5740\u5165\u6808**\uff0c\u7136\u540e**\u8c03\u7528\u8005\u7684 EBP \uff08\u65e7\u7684EBP \uff09\u538b\u6808**\u3002x86 \u4e2d\u6808\u662f\u5411\u4e0b\u589e\u957f\u7684\uff0c\u6211\u4eec\u53ea\u9700\u8981\u83b7\u53d6\u5230\u5f53\u524d EBP \u5bc4\u5b58\u5668\u7684\u503c\u5411\u4e0a\u62e8\u52a8\u4e00\u4e2a\u6570\u636e\u5355\u5143\uff0832-bit 4 \u5b57\u8282\uff0c64-bit 8 \u5b57\u8282\uff09\uff0c\u8bbf\u95ee\u8fd9\u4e2a\u5730\u5740\u5c31\u80fd\u591f\u5f97\u5230\u8fd4\u56de\u5730\u5740\u3002\u540c\u65f6\u4e0a\u4e00\u7ea7\u51fd\u6570\u6808\u5e27\u7684 EBP \u53c8\u53ef\u4ee5\u901a\u8fc7\u5f53\u524d\u51fd\u6570\u7684 EBP \u83b7\u53d6\u5230\uff08**\u8bbf\u95ee\u5f53\u524d\u51fd\u6570 EBP \u5bc4\u5b58\u5668\u503c\u6307\u5411\u7684\u5730\u5740**\uff09\u3002\\n\\n\u7531\u4e8e\u51fd\u6570\u8c03\u7528\u5b58\u5728\u5d4c\u5957\u6027\uff0c\u53ef\u80fd\u5b58\u5728\u591a\u4e2a\u51fd\u6570\u6808\u5e27\uff0c\u6211\u4eec\u9700\u8981**\u9012\u5f52\u6267\u884c**\u4e0a\u8ff0\u8fc7\u7a0b\u3002\\n\\n\u66f4\u5177\u4f53\u7684\u4fe1\u606f\u8bf7\u8bbf\u95ee\uff1a\\n\\n[\u7cfb\u7edf\u7a0b\u5e8f\u5458\u6210\u957f\u8ba1\u5212\uff0d\u50cf\u673a\u5668\u4e00\u6837\u601d\u8003(\u4e8c)](https://blog.csdn.net/absurd/article/details/4207357?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522160423542319724836730112%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=160423542319724836730112&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v1~rank_blog_v1-6-4207357.pc_v1_rank_blog_v1&utm_term=%E8%B0%83%E7%94%A8&spm=1018.2118.3001.4450)\\n[](https://blog.csdn.net/absurd/article/details/4207357?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522160423542319724836730112%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=160423542319724836730112&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v1~rank_blog_v1-6-4207357.pc_v1_rank_blog_v1&utm_term=%E8%B0%83%E7%94%A8&spm=1018.2118.3001.4450)\\n\\n\u4e0a\u8ff0\u94fe\u63a5\u4e2d\u7684\u793a\u4f8b\u4ee3\u7801\u76f4\u63a5\u7f16\u8bd1\u8fd0\u884c\u5728\u6211\u7684\u7cfb\u7edf\u4e0a\u4f1a\u62a5\u6bb5\u9519\u8bef\uff0c\u6211\u4fee\u6539\u4e86\u90e8\u5206\u5185\u5bb9\uff0c\u65b0\u7684 demo \u5982\u4e0b\uff1a\\n\\n```c\\n#include <stdio.h> \\n\\n#define NEW_GCC\\n#define MAX_LEVEL 4\\n#ifdef NEW_GCC\\n#define OFFSET 4\\n#else\\n#define OFFSET 0\\n#endif/*NEW_GCC*/ \\n\\nint backtrace(void** buffer, int size)\\n{\\n\\tlong n = 0xfefefefe;\\n\\tlong* p = &n;\\n\\tint\\t i = 0; \\n\\n\\tlong ebp = p[1 + OFFSET];\\n\\tlong eip = p[2 + OFFSET]; \\n\\n\\tfor(i = 0; i < size; i++)\\n\\t{\\n\\t\\tbuffer[i] = (void*)eip;\\n\\t\\tp = (long*)ebp;\\n\\t\\tebp = p[0];\\n\\t\\teip = p[1];\\n\\t} \\n\\n\\treturn size;\\n} \\n\\nstatic void test2()\\n{\\n\\tint i = 0;\\n\\tvoid* buffer[MAX_LEVEL] = {0}; \\n\\n\\tbacktrace(buffer, MAX_LEVEL); \\n\\n\\tfor(i = 0; i < MAX_LEVEL; i++)\\n\\t{\\n\\t\\tprintf(\\"called by %p\\\\n\\",\\tbuffer[i]);\\n\\t} \\n\\n\\treturn;\\n} \\n\\nstatic void test1()\\n{\\n\\tint a=0x11111111;\\n\\tint b=0x11111112; \\n\\n\\ttest2();\\n\\ta = b; \\n\\n\\treturn;\\n} \\n\\nstatic void test()\\n{\\n\\tint a=0x10000000;\\n\\tint b=0x10000002; \\n\\n\\ttest1();\\n\\ta = b; \\n\\n\\treturn;\\n} \\n\\nint main(int argc, char* argv[])\\n{\\n\\ttest(); \\n\\n\\treturn 0;\\n}\\n```\\n\u5c06\u4e0a\u8ff0\u4ee3\u7801\u4fdd\u5b58\u4e3a backtrace.c\uff0c\u7f16\u8bd1\u8fd0\u884c\u80fd\u591f\u6b63\u5e38\uff0c\u8bb0\u5f55\u5982\u4e0b\uff1a\\n```c\\n[longyu@debian-10:21:04:29] program-problem $ gcc ./backtrace.c -o backtrace\\n[longyu@debian-10:21:04:31] program-problem $ ./backtrace\\ncalled by 0x555555555204\\ncalled by 0x555555555258\\ncalled by 0x555555555281\\ncalled by 0x5555555552a3\\n```\\n[\u7cfb\u7edf\u7a0b\u5e8f\u5458\u6210\u957f\u8ba1\u5212\uff0d\u50cf\u673a\u5668\u4e00\u6837\u601d\u8003(\u4e8c)](https://blog.csdn.net/absurd/article/details/4207357?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522160423542319724836730112%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=160423542319724836730112&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v1~rank_blog_v1-6-4207357.pc_v1_rank_blog_v1&utm_term=%E8%B0%83%E7%94%A8&spm=1018.2118.3001.4450)\\n[](https://blog.csdn.net/absurd/article/details/4207357?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522160423542319724836730112%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=160423542319724836730112&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v1~rank_blog_v1-6-4207357.pc_v1_rank_blog_v1&utm_term=%E8%B0%83%E7%94%A8&spm=1018.2118.3001.4450)\u8fd9\u7bc7\u674e\u5148\u9759\u5927\u795e\u7684\u535a\u5ba2\u4e2d\uff0c\u4ece\u6839\u672c\u4e0a\u89e3\u91ca\u4e86\u6211\u4e4b\u524d\u63cf\u8ff0\u7684 addr2line \u547d\u4ee4\u4e0d\u80fd\u83b7\u53d6\u5230\u884c\u53f7\u7684\u95ee\u9898\u3002\\n\\n\u76f8\u5173\u7684\u5185\u5bb9\u6458\u5f55\u5982\u4e0b\uff1a\\n\\n>\u5bf9\u4e8e\u5171\u4eab\u5e93\uff0caddr2line\u65e0\u6cd5\u6839\u636e\u8fd9\u4e2a\u5730\u5740\u627e\u5230\u5bf9\u5e94\u7684\u6e90\u4ee3\u7801\u4f4d\u7f6e\u4e86\u3002\u539f\u56e0\u662f\uff1aaddr2line\u53ea\u80fd\u901a\u8fc7\u5730\u5740\u504f\u79fb\u91cf\u6765\u67e5\u627e\uff0c\u800c\u6253\u5370\u51fa\u7684\u5730\u5740\u662f\u7edd\u5bf9\u5730\u5740\u3002\u7531\u4e8e\u5171\u4eab\u5e93\u52a0\u8f7d\u5230\u5185\u5b58\u7684\u4f4d\u7f6e\u662f\u4e0d\u786e\u5b9a\u7684\uff0c\u4e3a\u4e86\u8ba1\u7b97\u5730\u5740\u504f\u79fb\u91cf\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u8fdb\u7a0bmaps\u6587\u4ef6\u7684\u5e2e\u52a9\\n\\n## \u8fdb\u7a0b maps \u6587\u4ef6\u7684\u4f7f\u7528\\n\u6bcf\u4e00\u4e2a\u8fdb\u7a0b\u90fd\u6709\u81ea\u5df1\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff0c\u5176\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u6620\u5c04\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b /proc/[pid]/maps \u6587\u4ef6\u6765\u786e\u5b9a\u3002\\n\\n\u4e0a\u6587\u4e2d\u5df2\u7ecf\u63cf\u8ff0\u4e86\u8fd0\u884c backtrace \u7a0b\u5e8f\u5f97\u5230\u7684\u5982\u4e0b\u8f93\u51fa\u4fe1\u606f\uff1a\\n\\n```c\\n[longyu@debian-10:21:04:31] program-problem $ ./backtrace\\ncalled by 0x555555555204\\ncalled by 0x555555555258\\ncalled by 0x555555555281\\ncalled by 0x5555555552a3\\n```\\n### \u7528 gdb \u6765\u9a8c\u8bc1\\ngdb \u6302\u8d77\u7a0b\u5e8f\uff0c\u53cd\u6c47\u7f16\u8c03\u7528\u5230\u7684\u4e0d\u540c\u51fd\u6570\uff0c\u8c03\u7528\u6307\u4ee4\u4e0e\u8fd4\u56de\u5730\u5740\u6307\u4ee4\u5217\u4e3e\u5982\u4e0b\uff1a\\n\\n```asm\\n   0x000055555555529e <+20>:\\tcallq  0x555555555261 <test>\\n   **0x00005555555552a3 <+25>:\\tmov    $0x0,%eax**\\n   0x000055555555527c <+27>:\\tcallq  0x555555555238 <test1>\\n   **0x0000555555555281 <+32>:\\tmov    -0x8(%rbp),%eax**\\n   0x0000555555555253 <+27>:\\tcallq  0x5555555551c4 <test2>\\n   **0x0000555555555258 <+32>:\\tmov    -0x8(%rbp),%eax**\\n   0x00005555555551ff <+59>:\\tcallq  0x555555555135 <backtrace>\\n   **0x0000555555555204 <+64>:\\tmovl   $0x0,-0x4(%rbp)**\\n```\\n\\n\u8fd9\u91cc\u52a0\u7c97\u7684\u8868\u793a\u8fd4\u56de\u5730\u5740\uff0c\u53ef\u4ee5\u770b\u5230\u4e0e\u4e0a\u9762\u7684\u8f93\u51fa\u662f\u5bf9\u5e94\u7684\uff0c\u4e0d\u8fc7\u7531\u4e8e backtrace \u662f\u5411\u540e\u56de\u6eaf\u7684\uff0c\u4e0e\u8fd9\u91cc\u7684**\u987a\u5e8f\u521a\u597d\u76f8\u53cd**\u3002\\n\\n### \u4f7f\u7528 maps \u6587\u4ef6\u6765\u9a8c\u8bc1\\n\u4e0a\u9762 backtrace \u7a0b\u5e8f\u8fd0\u884c\u7684\u8f93\u51fa\u4fe1\u606f\u4e2d 0x555555555204 \u8fd9\u4e9b\u5730\u5740\u662f**\u7a0b\u5e8f\u88ab\u6620\u5c04\u5230\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u7684\u865a\u62df\u5730\u5740**\uff0c\u6211\u901a\u8fc7\u6267\u884c\u5982\u4e0b\u6b65\u9aa4\u6765\u83b7\u53d6\u5230\u7a0b\u5e8f\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u5e03\u5c40\uff1a\\n\\n1. \u4f7f\u7528 gdb \u8fd0\u884c backtrace \u7a0b\u5e8f\u5e76\u5728 main \u51fd\u6570\u5904\u505c\u4e0b\u6765\\n2. \u4f7f\u7528 pmap \u67e5\u770b backtrace \u7a0b\u5e8f\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u6620\u5c04\\n\\n\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u6620\u5c04\u8868\u5982\u4e0b\uff1a\\n\\n```bash\\n[longyu@debian-10:21:17:56] glibc-2.28 $ pmap -p 5201\\n5201:   /home/longyu/problem_and_solution/program-problem/backtrace\\n0000555555554000      4K r---- /home/longyu/problem_and_solution/program-problem/backtrace\\n0000555555555000      4K r-x-- /home/longyu/problem_and_solution/program-problem/backtrace\\n0000555555556000      4K r---- /home/longyu/problem_and_solution/program-problem/backtrace\\n0000555555557000      4K r---- /home/longyu/problem_and_solution/program-problem/backtrace\\n0000555555558000      4K rw--- /home/longyu/problem_and_solution/program-problem/backtrace\\n00007ffff7dea000    136K r---- /usr/lib/x86_64-linux-gnu/libc-2.28.so\\n00007ffff7e0c000   1312K r-x-- /usr/lib/x86_64-linux-gnu/libc-2.28.so\\n00007ffff7f54000    304K r---- /usr/lib/x86_64-linux-gnu/libc-2.28.so\\n00007ffff7fa0000      4K ----- /usr/lib/x86_64-linux-gnu/libc-2.28.so\\n00007ffff7fa1000     16K r---- /usr/lib/x86_64-linux-gnu/libc-2.28.so\\n00007ffff7fa5000      8K rw--- /usr/lib/x86_64-linux-gnu/libc-2.28.so\\n00007ffff7fa7000     24K rw---   [ anon ]\\n00007ffff7fd0000     12K r----   [ anon ]\\n00007ffff7fd3000      8K r-x--   [ anon ]\\n00007ffff7fd5000      4K r---- /usr/lib/x86_64-linux-gnu/ld-2.28.so\\n00007ffff7fd6000    120K r-x-- /usr/lib/x86_64-linux-gnu/ld-2.28.so\\n00007ffff7ff4000     32K r---- /usr/lib/x86_64-linux-gnu/ld-2.28.so\\n00007ffff7ffc000      4K r---- /usr/lib/x86_64-linux-gnu/ld-2.28.so\\n00007ffff7ffd000      4K rw--- /usr/lib/x86_64-linux-gnu/ld-2.28.so\\n00007ffff7ffe000      4K rw---   [ anon ]\\n00007ffffffdd000    136K rw---   [ stack ]\\n total             2148K\\n```\\n\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u5173\u6ce8 backtrace \u7a0b\u5e8f\u5728\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u4e2d\u7684\u5e03\u5c40\uff0c\u53ef\u4ee5\u770b\u5230\u6709\u51e0\u4e2a\u9879\u76ee\uff0c\u8d77\u59cb\u5730\u5740\u4e3a 0000555555554000\uff0c\u5bf9\u5e94\u7684\u9879\u76ee\u5982\u4e0b\uff1a\\n\\n```bash\\n0000555555554000      4K r---- /home/longyu/problem_and_solution/program-problem/backtrace\\n```\\n0000555555554000  \u5373\u4e3a backtrace \u7a0b\u5e8f\u6620\u5c04\u7684\u8d77\u59cb\u5730\u5740\uff0c\u6211\u4eec\u7528 backtrace \u7a0b\u5e8f\u7684\u8f93\u51fa\u5730\u5740\u51cf\u6389\u8fd9\u4e2a\u8d77\u59cb\u5730\u5740\uff0c\u5c06\u4f1a\u5f97\u5230\u4e0b\u9762\u51e0\u4e2a\u5730\u5740\uff1a\\n\\n0x1204\\n0x1258\\n0x1281\\n0x12a3\\n\\n\u5c06\u8fd9\u51e0\u4e2a\u5730\u5740\u5199\u5165\u4e00\u4e2a\u540d\u4e3a test \u7684\u6587\u4ef6\u4e2d\uff0c\u4f7f\u7528 xargs \u8bfb\u53d6\u8fd9\u4e2a\u6587\u4ef6\u5236\u4f5c\u53c2\u6570\u8c03\u7528 addr2line \u547d\u4ee4\uff0c\u5f97\u5230\u4e86\u5982\u4e0b\u4fe1\u606f\uff1a\\n\\n```bash\\n[longyu@debian-10:21:37:35] program-problem $ xargs -a ./test  addr2line -e ./backtrace \\n/home/longyu/problem_and_solution/program-problem/./backtrace.c:38\\n/home/longyu/problem_and_solution/program-problem/./backtrace.c:52\\n/home/longyu/problem_and_solution/program-problem/./backtrace.c:63\\n/home/longyu/problem_and_solution/program-problem/./backtrace.c:72\\n```\\n\u53ef\u4ee5\u770b\u5230 addr2line \u6210\u529f\u89e3\u6790\u51fa\u4e86\u6307\u4ee4\u5728\u4ee3\u7801\u4e2d\u7684\u4f4d\u7f6e\u3002\u5bf9\u4e8e\u52a8\u6001\u5e93\u4e2d\u7684\u51fd\u6570\u5730\u5740\uff0c\u6709\u7c7b\u4f3c\u7684\u8fc7\u7a0b\uff01\\n\\n## \u603b\u7ed3\\n\u4e00\u4e2a\u7b80\u5355\u7684\u77e5\u8bc6\u80cc\u540e\u53ef\u80fd\u8574\u85cf\u4e86\u5f88\u591a\u7684\u95ee\u9898\uff0c\u8fd9\u4e9b\u95ee\u9898\u73af\u73af\u76f8\u6263\uff0c\u5f53\u4f60\u5904\u5728\u5206\u6790\u95ee\u9898\u7684\u8fc7\u7a0b\u4e2d\u65f6\uff0c\u5e38\u5e38\u4f1a\u611f\u5230\u5934\u75db\uff0c\u4f46\u5c06\u6574\u4e2a\u8fc7\u7a0b\u4e32\u8054\u8d77\u6765\u540e\uff0c\u5374\u53c8\u4f1a\u6709\u975e\u5e38\u5927\u7684\u6210\u5c31\u611f\u3002\\n\\n\u4ece\u4e00\u4e2a\u95ee\u9898\u8df3\u8dc3\u5230\u53e6\u5916\u4e00\u4e2a\u95ee\u9898\uff0c\u7ed5\u6765\u7ed5\u53bb\u6700\u7ec8\u53c8\u56de\u5230\u6700\u521d\u7684\u95ee\u9898\uff0c\u4e0d\u8fc7\u6b64\u65f6\u77e5\u8bc6\u9762\u5f97\u5230\u4e86\u6269\u5145\uff0c\u8f93\u5165\u589e\u52a0\u4e86\uff0c\u6709\u4e86\u8fd9\u4e2a\u589e\u52a0\u7684\u8f93\u5165\u4fe1\u606f\uff0c\u6700\u521d\u7684\u95ee\u9898\u5df2\u7ecf\u4e0d\u7b97\u662f\u95ee\u9898\u4e86\uff01\\n\\n\u672c\u6587\u7684\u95ee\u9898\u8109\u7edc\u5927\u81f4\u6709\u5982\u4e0b\u51e0\u70b9\uff1a\\n\\n1. \u5982\u4f55\u4f7f\u7528 mtrace\uff1f\\n2. mtrace \u811a\u672c\u4e3a\u4ec0\u4e48\u4e0d\u80fd\u6253\u5370\u6e90\u7801\u884c\u53f7\uff1f\\n3. addr2line \u4e3a\u4ec0\u4e48\u4e0d\u80fd\u6253\u5370\u6e90\u7801\u884c\u53f7\uff1f\\n4. mtrace \u51fd\u6570\u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff1f\\n5. RETURN_ADDRESS \u5b8f\u7684\u5b9a\u4e49\u662f\u4ec0\u4e48\uff1f\\n6. gcc \u5185\u5efa\u7684 __builtin_return_address \u662f\u5982\u4f55\u5b9e\u73b0\u7684\uff1f\\n7. \u4ece backtrace \u7a0b\u5e8f\u518d\u6b21\u56de\u5230\u7b2c\u4e09\u4e2a\u95ee\u9898\\n\\n\u6ce8\u610f\u5728\u7b2c 7 \u4e2a\u5173\u952e\u70b9\u7684\u65f6\u5019\uff0c\u53c8\u56de\u5230\u4e86 3 \u8fd9\u4e2a\u70b9\uff0c\u4e0d\u8fc7\u8fd9\u65f6\u5019\u6211\u6709\u4e86 maps \u6587\u4ef6\u8fd9\u4e2a\u8f93\u5165\uff0c\u8fd9\u4e2a\u8f93\u5165\u8ba9 addr2line \u4e0d\u80fd\u6253\u5370\u884c\u53f7\u7684\u95ee\u9898\u8fce\u5203\u800c\u89e3\uff01\\n\\n\u5217\u51fa\u8fd9\u4e9b\u5173\u952e\u70b9\u53ea\u60f3\u629b\u51fa\u4e00\u4e2a\u95ee\u9898\uff1a**\u4f60\u89c9\u5f97\u81ea\u5df1\u4f1a\u5728\u54ea\u4e2a\u70b9\u7ed3\u675f\u5462\uff1f**"},{"id":"/linux-kernel/linux-\u5185\u6838\u6a21\u5757\u4e2d\u5f15\u7528\u7b26\u53f7\u662f\u5982\u4f55\u94fe\u63a5\u7684","metadata":{"permalink":"/longyu.github.io/blog/linux-kernel/linux-\u5185\u6838\u6a21\u5757\u4e2d\u5f15\u7528\u7b26\u53f7\u662f\u5982\u4f55\u94fe\u63a5\u7684","editUrl":"https://github.com/longyuwlz/longyu.github.io/blog/linux-kernel/linux-\u5185\u6838\u6a21\u5757\u4e2d\u5f15\u7528\u7b26\u53f7\u662f\u5982\u4f55\u94fe\u63a5\u7684.md","source":"@site/blog/linux-kernel/linux-\u5185\u6838\u6a21\u5757\u4e2d\u5f15\u7528\u7b26\u53f7\u662f\u5982\u4f55\u94fe\u63a5\u7684.md","title":"linux-kernel/linux-\u5185\u6838\u6a21\u5757\u4e2d\u5f15\u7528\u7b26\u53f7\u662f\u5982\u4f55\u94fe\u63a5\u7684","description":"\u524d\u8a00","date":"2022-06-19T07:40:00.000Z","formattedDate":"2022\u5e746\u670819\u65e5","tags":[],"readingTime":10.255,"truncated":false,"authors":[],"frontMatter":{},"prevItem":{"title":"libc/\u4f7f\u7528mtrace\u8ddf\u8e2a\u5185\u5b58\u6cc4\u9732\u95ee\u9898","permalink":"/longyu.github.io/blog/libc/\u4f7f\u7528mtrace\u8ddf\u8e2a\u5185\u5b58\u6cc4\u9732\u95ee\u9898"},"nextItem":{"title":"\u5199\u535a\u5ba2\u7684\u610f\u4e49","permalink":"/longyu.github.io/blog/2022/06/12/\u5e8f\u8a00"}},"content":"## \u524d\u8a00\\nlinux \u5185\u6838\u6a21\u5757\u7684\u52a0\u8f7d\u6d41\u7a0b\u53bb\u5e74\u5927\u81f4\u7422\u78e8\u4e86\u4e00\u904d\uff0c\u7b80\u5355\u7684\u5199\u4e86\u4e2a\u8349\u7a3f\u540e\u5c31\u5728\u8349\u7a3f\u7bb1\u91cc\u79ef\u538b\u7740\u3002\u6309\u7167\u4ee5\u5f80\u7684\u98ce\u683c\uff0c\u5e94\u5f53\u4ee5\u4e00\u7bc7\u957f\u6587\u5448\u73b0\uff0c\u4eca\u5929\u60f3\u60f3\u5374\u89c9\u5f97\u4e0d\u592a\u53ef\u53d6\u3002\u4e3a\u4ec0\u4e48\u4e0d\u4ece\u5173\u952e\u7684\u95ee\u9898\u7740\u624b\uff0c\u4f7f\u7528\u8f83\u77ed\u7684\u7bc7\u5e45\u6765\u9010\u4e2a\u51fb\u7834\u5462\uff1f\\n\\n\u6700\u7ec8\u9009\u62e9\u4e86\u4ece\u95ee\u9898\u51fa\u53d1\u7684\u63cf\u8ff0\u65b9\u5f0f\uff0c\u5728\u8fd9\u79cd\u65b9\u5f0f\u4e0b\uff0c\u6211\u9996\u5148\u5f97\u63d0\u51fa\u5173\u952e\u95ee\u9898\uff0c\u8fd9\u9700\u8981\u4e00\u5b9a\u7684\u8bad\u7ec3\uff0c\u672c\u6587\u4fbf\u662f\u8fd9\u6837\u7684\u4e00\u6b21\u5b9e\u8df5\u3002\\n\\n## \u6211\u7684\u95ee\u9898\\n\\n### 1. **linux \u5185\u6838\u6a21\u5757\u662f\u5982\u4f55\u94fe\u63a5\u7684\uff1f**\\n\\n\u6682\u65f6\u65e0\u6cd5\u56de\u7b54\u3002\\n\\n### 2. \u4e3a\u4ec0\u4e48\u8981\u63d0\u8fd9\u4e2a\u95ee\u9898\uff1f\\n\\n\u5e38\u89c4\u7684 c \u7a0b\u5e8f\u8981\u7ecf\u8fc7\u7f16\u8bd1\u94fe\u63a5\u6765\u751f\u6210\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u94fe\u63a5\u7684\u8fc7\u7a0b\u4f1a\u6309\u7167\u94fe\u63a5\u811a\u672c\u7684\u914d\u7f6e\u6765\u5b8c\u6210\u53ef\u6267\u884c\u6587\u4ef6\u7684 layout \u540c\u65f6\u4e5f\u4f1a\u5bf9\u6240\u6709\u7684\u53ef\u91cd\u5b9a\u4f4d\u9879\u76ee\u8fdb\u884c\u91cd\u5b9a\u4f4d\uff0c\u4ee5\u786e\u5b9a\u8bbf\u95ee\u5730\u5740\u504f\u79fb\u3002\\n\\nlinux \u5185\u6838\u6a21\u5757\u4e5f\u6709\u7c7b\u4f3c\u7684\u8fc7\u7a0b\uff0c\u53ef\u7f16\u8bd1\u751f\u6210\u7684\u5185\u6838\u6a21\u5757\u53ea\u662f\u4e00\u4e2a\u3010\u53ef\u91cd\u5b9a\u4f4d\u76ee\u6807\u6587\u4ef6\u3011\uff0c**\u90a3\u5b83\u7684\u94fe\u63a5\u8fc7\u7a0b\u662f\u5728\u54ea\u91cc\u6267\u884c\u7684\u5462\uff1f**\\n\\n## \u7ecf\u9a8c\u4e4b\u8c08\\n\\n\u5185\u6838\u6a21\u5757\u4e00\u822c\u901a\u8fc7 insmod\u3001modprobe \u547d\u4ee4\u52a0\u8f7d\u8fd0\u884c\uff0c\u65e2\u7136\u8981\u8fd0\u884c\uff0c\u80af\u5b9a\u9700\u8981\u786e\u5b9a\u6a21\u5757\u5185\u8c03\u7528\u7684\u5916\u90e8\u7b26\u53f7\u7684\u504f\u79fb\u5730\u5740\uff0c\u8fd9\u4e00\u8fc7\u7a0b\u53ef\u80fd\u5728\u5982\u4e0b\u6d41\u7a0b\u4e2d\u8fdb\u884c\uff1a\\n\\n1. insmod\u3001modprobe \u547d\u4ee4\u4e2d\\n2. \u5185\u6838\u4ee3\u7801\u4e2d\u6a21\u5757\u52a0\u8f7d\u6d41\u7a0b\u4e2d\\n\\n\u66fe\u7ecf strace \u8ddf\u8e2a\u8fc7 insmod \u52a0\u8f7d\u5185\u6838\u6a21\u5757\u7684\u8fc7\u7a0b\uff0c\u6838\u5fc3\u903b\u8f91\u662f\u8c03\u7528 finit_module\u3001init_module \u7cfb\u7edf\u8c03\u7528\uff0c\u6ca1\u6709\u770b\u5230\u5176\u5b83\u64cd\u4f5c\uff0c\u4e8e\u662f\u5224\u65ad\u5185\u6838\u6a21\u5757\u7684\u94fe\u63a5\u5e94\u5f53\u662f\u5728\u5185\u6838\u4ee3\u7801\u4e2d\u505a\u7684\u3002\\n\\n\u4e0b\u9762\u6211\u4ee5\u4e00\u4e2a\u7b80\u5355\u7684 hello world \u5185\u6838\u6a21\u5757\u4e3a\u4f8b\uff0c\u63a2\u8ba8\u5185\u6838\u4e2d\u6267\u884c\u6a21\u5757\u94fe\u63a5\u7684\u8fc7\u7a0b\u3002\\n\\n## \u4e00\u4e2a\u7b80\u5355\u7684\u5185\u6838\u6a21\u5757\u6e90\u7801\\n\\n```c\\n#include <linux/module.h>\\n#include <linux/init.h>\\n\\nstatic int __init my_init(void)\\n{\\n  printk(KERN_INFO \\"Hello from Hello Module\\\\\\\\n\\");\\n  return 0;\\n}\\n\\nstatic void __exit my_exit(void)\\n{\\n  printk(KERN_INFO \\"Bye from Hello Module\\\\\\\\n\\");\\n}\\n\\nmodule_init(my_init);\\nmodule_exit(my_exit);\\n\\nMODULE_DESCRIPTION(\\"Sample Hello World Module\\");\\nMODULE_LICENSE(\\"GPL\\");\\n\\n```\\n\\n\u5c06\u4e0a\u8ff0\u5185\u5bb9\u4fdd\u5b58\u4e3a mymodule.c \u4f7f\u7528\u5982\u4e0b Makefile \u5185\u5bb9\u7f16\u8bd1\uff1a\\n\\n```makefile\\nMODULE_FILENAME=mymodule\\n\\nPWD := $(shell pwd)\\nobj-m += ${MODULE_FILENAME}.o\\nKO_FILE=${MODULE_FILENAME}.ko\\n\\nexport KROOT=/lib/modules/$(shell uname -r)/build\\nmodules:\\n\\t@${MAKE} -C ${KROOT} M=${PWD}\\n\\nmodules_install:\\n\\t@${MAKE} -C ${KROOT} M=${PWD} modules_install\\n\\nclean:\\n\\t@${MAKE} -C ${KROOT} M=${PWD} clean\\n\\trm -rf Modules.symvers modules.order\\n\\ninsert: modules\\n\\tsudo insmod ${KO_FILE}\\n\\nremove:\\n\\tsudo rmmod ${MODULE_FILENAME}\\n\\nprintlog:\\n\\tsudo dmesg -c\\n\\tsudo insmod ${KO_FILE}\\n\\tdmesg\\n```\\n\\n## objdump -d mymodule.ko\\n\\n```bash\\nDisassembly of section .init.text:\\n\\n0000000000000000 <init_module>:\\n   0:\\te8 00 00 00 00       \\tcallq  5 <init_module+0x5>\\n   5:\\t48 c7 c7 00 00 00 00 \\tmov    $0x0,%rdi\\n   c:\\te8 00 00 00 00       \\tcallq  11 <init_module+0x11>\\n  11:\\t31 c0                \\txor    %eax,%eax\\n  13:\\tc3                   \\tretq\\n\\nDisassembly of section .exit.text:\\n\\n0000000000000000 <cleanup_module>:\\n   0:\\t48 c7 c7 00 00 00 00 \\tmov    $0x0,%rdi\\n   7:\\te9 00 00 00 00       \\tjmpq   c <__UNIQUE_ID_description18>\\n\\n```\\n\\ninit_module \u4e3a\u6a21\u5757\u7684\u521d\u59cb\u5316\u51fd\u6570\uff0c\u5728\u5176\u4e2d\u8c03\u7528\u5230\u7684\u4e24\u4e2a **callq** \u6307\u4ee4\u7528\u4e8e\u5b50\u51fd\u6570\u8c03\u7528\u3002**callq** \u6307\u4ee4\u7684\u5b57\u8282\u7801\u4e3a **0xe8**\uff0c\u5176\u540e\u56db\u4e2a\u5b57\u8282\u4e3a\u51fd\u6570\u8df3\u8f6c\u504f\u79fb\uff0c\u8fd9\u91cc\u4e24\u4e2a **callq** \u6307\u4ee4\u7684\u51fd\u6570\u8df3\u8f6c\u504f\u79fb\u503c\u90fd\u4e3a 0\uff0c\u8fd9\u7b26\u5408\u53ef\u91cd\u5b9a\u4f4d\u76ee\u6807\u6587\u4ef6\u7684\u7279\u5f81\uff0c\u8fd9\u91cc\u5c31\u662f\u4e24\u5904\u9700\u8981\u94fe\u63a5\u8fc7\u7a0b\u5b8c\u6210\u7684\u91cd\u5b9a\u4f4d\u5bf9\u8c61\u3002\\n\\n\u7b2c\u4e8c\u4e2a callq \u53ef\u4ee5\u660e\u786e\u662f printk\uff0c\u7b2c\u4e00\u4e2a callq \u6839\u636e readelf -r \u7684\u8f93\u51fa\u5224\u65ad\u662f ```__fentry__ ```\u3002\\n\\n## readelf -r mymodule.ko\\n\\n```bash\\nRelocation section \'.rela.init.text\' at offset 0x1cb30 contains 3 entries:\\n  Offset          Info           Type           Sym. Value    Sym. Name + Addend\\n000000000001  002600000004 R_X86_64_PLT32    0000000000000000 __fentry__ - 4\\n000000000008  00060000000b R_X86_64_32S      0000000000000000 .rodata.str1.1 + 0\\n00000000000d  002800000004 R_X86_64_PLT32    0000000000000000 printk - 4\\n\\nRelocation section \'.rela.exit.text\' at offset 0x1cb78 contains 2 entries:\\n  Offset          Info           Type           Sym. Value    Sym. Name + Addend\\n000000000003  00060000000b R_X86_64_32S      0000000000000000 .rodata.str1.1 + 1b\\n000000000008  002800000004 R_X86_64_PLT32    0000000000000000 printk - 4\\n```\\n\\nreadelf -r \u53c2\u6570\u83b7\u53d6\u53ef\u6267\u884c\u76ee\u6807\u6587\u4ef6\u7684\u53ef\u91cd\u5b9a\u4f4d section \u8868\u9879\u3002\u4e0a\u8ff0\u8f93\u51fa\u4e2d\u6709\u5982\u4e0b\u4e24\u4e2a\u53ef\u91cd\u5b9a\u4f4d section:\\n\\n1. .rela.init.text\\n2. .rela.exit.text\\n\\n\u6bcf\u4e2a section \u4e2d\u90fd\u5217\u4e3e\u51fa\u4e86\u3010\u9700\u8981\u91cd\u5b9a\u4f4d\u7684\u9879\u76ee\u3011\uff0c\u4e00\u4e2a\u9879\u76ee\u6709\u4e94\u4e2a\u65b9\u9762\u7684\u5185\u5bb9\uff0c\u5176\u4e2d **Offset \u4e3a\u53ef\u91cd\u5b9a\u4f4d\u76ee\u6807\u5730\u5740\u76f8\u5bf9\u6587\u4ef6\u8d77\u59cb\u5730\u5740\u7684\u504f\u79fb\u91cf**\uff0c**Type \u4e3a\u91cd\u5b9a\u4f4d\u7684\u7c7b\u578b**\uff0c\u7528\u4e8e\u8ba1\u7b97\u504f\u79fb\u5730\u5740\uff0c**Sym. Name + Addend \u5b57\u6bb5\u4e3a\u7b26\u53f7\u540d\u79f0\u4ee5\u53ca\u8ba1\u7b97\u5730\u5740\u504f\u79fb\u91cf\u65f6\u7684\u4fee\u6b63\u503c\u3002**\\n\\n**.rela.init_text section** \u4e2d\u6709\u4e24\u79cd\u91cd\u5b9a\u4f4d\u7c7b\u578b\uff0c**R_X86_64_PLT32**  \u7528\u4e8e\u51fd\u6570\u504f\u79fb\u8ba1\u7b97\uff0c**R_X86_64_32S** \u7528\u4e8e\u6570\u636e\u504f\u79fb\u8ba1\u7b97\u3002str1.1 \u5b9e\u9645\u6307\u5411 init_module \u51fd\u6570\u4e2d printk \u51fd\u6570\u6253\u5370\u7684\u5b57\u7b26\u4e32\u3002\\n\\n\u51fd\u6570\u504f\u79fb\u7684\u8ba1\u7b97\u53ef\u4ee5\u53c2\u8003\u5982\u4e0b\u5185\u5bb9\u6765\u5b66\u4e60\uff1a\\n\\n>So despite the fact that the type of the relocation entry is R_X86_64_PLT32 the linker will still use the R_X86_64_PC32 computation (S + A - P) for the relocation target being modified, where:\\n>\\n>    S is the value of the symbol (st_value of Elf64_Sym)\\n    A is the addend (-4 in your case)\\n    P is the address of the memory location being relocated (the start of the address of the call to Other)\\n\\n\u4e0a\u8ff0\u82f1\u6587\u6458\u81ea [How does the address of R_X86_64_PLT32 computed?](https://stackoverflow.com/questions/64424692/how-does-the-address-of-r-x86-64-plt32-computed) \u66f4\u591a\u7684\u4fe1\u606f\u53ef\u4ee5\u9605\u8bfb\u300a\u6df1\u5165\u7406\u89e3\u8ba1\u7b97\u673a\u7cfb\u7edf\u300b\u7b2c\u4e09\u7248 7.7 \u8282\u3002\\n\\n\u5728\u4e0b\u6587\u4e2d\u6211\u4f1a\u7528\u4e00\u4e2a\u5b9e\u4f8b\u6765\u8bf4\u660e\u51fd\u6570\u504f\u79fb\u5730\u5740\u7684\u8ba1\u7b97\u8fc7\u7a0b\u3002\\n\\n## \u5728\u5185\u6838\u6e90\u7801\u4e2d\u627e\u5230\u6a21\u5757\u94fe\u63a5\u76f8\u5173\u4ee3\u7801\\n\\n\u4f7f\u7528 R_X86_64_PLT32 \u5173\u952e\u5b57\u8fdb\u884c\u5982\u4e0b\u641c\u7d22\uff1a\\n\\n1. \u641c\u7d22 kernel \u76ee\u5f55\\n2. \u641c\u7d22 arch/x86 \u76ee\u5f55\\n\u786e\u5b9a\u6a21\u5757\u94fe\u63a5\u6d41\u7a0b\u5728 arch/x86/kernel/module.c \u4e2d\u5b9e\u73b0\u3002\\n\\n\u9605\u8bfb module.c \u7684\u4ee3\u7801\uff0c\u53d1\u73b0\u6709\u4e00\u4e2a\u8c03\u8bd5\u4fe1\u606f\uff0c\u4e8e\u662f\u4fee\u6539\u5185\u6838\u4ee3\u7801\uff0c\u5f00\u542f\u8c03\u8bd5\u4fe1\u606f\u3002\\n\\n## \u5185\u6838\u4ee3\u7801\u4fee\u6539 patch\\n\\n```c\\ndiff --git a/arch/x86/kernel/module.c b/arch/x86/kernel/module.c\\nindex b052e883dd8c..11e39304c55f 100644\\n--- a/arch/x86/kernel/module.c\\n+++ b/arch/x86/kernel/module.c\\n@@ -37,7 +37,7 @@\\n #include <asm/setup.h>\\n #include <asm/unwind.h>\\n\\n-#if 0\\n+#if 1\\n #define DEBUGP(fmt, ...)                               \\\\\\\\\\n        printk(KERN_DEBUG fmt, ##__VA_ARGS__)\\n #else\\n@@ -196,6 +196,7 @@ int apply_relocate_add(Elf64_Shdr *sechdrs,\\n                                goto invalid_relocation;\\n                        val -= (u64)loc;\\n                        *(u32 *)loc = val;\\n+\\n #if 0\\n                        if ((s64)val != *(s32 *)loc)\\n                                goto overflow;\\n@@ -212,6 +213,7 @@ int apply_relocate_add(Elf64_Shdr *sechdrs,\\n                               me->name, ELF64_R_TYPE(rel[i].r_info));\\n                        return -ENOEXEC;\\n                }\\n+               DEBUGP(\\"val is 0x%llx\\\\\\\\n\\", val);\\n        }\\n        return 0;\\n\\n```\\n\\n## \u91cd\u65b0\u7f16\u8bd1\u5e76\u66f4\u65b0\u5185\u6838\u540e\u52a0\u8f7d mymodule.ko \u540e dmesg \u90e8\u5206\u6253\u5370\u4fe1\u606f\\n\\n```bash\\n[  109.974417] type 4 st_value ffffffffbda016d0 r_addend fffffffffffffffc loc ffffffffc0106001\\n[  109.974418] val is 0xfffffffffd8fb6cb\\n.........\\n```\\n\\n\u7531\u4e8e\u6253\u5370\u4fe1\u606f\u5f88\u591a\uff0c\u6211\u53ea\u622a\u53d6\u4e86\u5176\u4e2d\u7684\u4e00\u6761\u9879\u76ee\u3002\u5728\u4e0a\u8ff0\u9879\u76ee\u4e2d\u5173\u952e\u7684\u4fe1\u606f\u89e3\u6790\u5982\u4e0b\uff1a\\n\\n1. type 4 \u8868\u793a\u91cd\u5b9a\u4f4d\u7c7b\u578b\u4e3a R_X86_64_PLT32 \\n2. st_value ffffffffbda016d0 \u8868\u793a ```__fentry__```\u7b26\u53f7\u5730\u5740\\n    \\n    \u901a\u8fc7\u8bbf\u95ee /proc/kallsyms \u6587\u4ef6\u786e\u5b9a\uff0c\u76f8\u5173\u4fe1\u606f\u6458\u5f55\u5982\u4e0b\uff1b\\n    \\n\\n\\t```bash\\n\\t[root@debian-10:17:55:34] helloworld_module # grep __fentry__ /proc/kallsyms\\n\\tffffffffbda016d0 T __fentry__\\n\\t```\\n\\n1. r_addend fffffffffffffffc  \u4e3a\u4e0a\u6587\u4e2d readelf -r \u8f93\u51fa\u4e2d ```__fentry__```\u51fd\u6570\u7684 Addend \u503c\u2014\u2014 -4\\n2. loc ffffffffc0106001 \u8868\u793a\u4e0a\u6587\u4e2d readelf -r \u8f93\u51fa\u4e2d```__fentry__```\u88ab\u91cd\u5b9a\u4f4d\u533a\u57df\u5728\u5185\u6838\u7684\u5b9e\u9645\u5730\u5740\\n3. val is 0xfffffffffd8fb6cb\uff0cval \u4e3a\u6700\u7ec8\u8ba1\u7b97\u51fa\u7684\u8bbf\u95ee ```__fentry__```\u51fd\u6570\u7684\u504f\u79fb\u91cf\uff0c\u4f1a\u88ab\u586b\u5145\u5230 loc \u6307\u5411\u7684\u5730\u5740\u4e2d\\n    \\n    val \u8ba1\u7b97\u516c\u5f0f\u4e3a S + A - P: ffffffffbda016d0 + fffffffffffffffc  - ffffffffc0106001 = **0xfffffffffd8fb6cb**\\n    \\n\\n## \u6838\u5fc3\u5185\u6838\u4ee3\u7801\\n\\n\u5185\u6838\u4ee3\u7801\u4e2d\u76f8\u5173\u51fd\u6570\u8c03\u7528\u5173\u7cfb\u5982\u4e0b\uff1a\\n```c\\ninit_module/finit_module\\n\\tload_module\\n       apply_relocations\\n           apply_relocate_add\\n  ```\\napply_relocate_add \u51fd\u6570\u4e2d\u5b8c\u6210\u91cd\u5b9a\u5411\u4efb\u52a1\uff0c\u6838\u5fc3\u4ee3\u7801\u6458\u5f55\u5982\u4e0b\uff1a\\n\\n```c\\n        for (i = 0; i < sechdrs[relsec].sh_size / sizeof(*rel); i++) {\\n                /* This is where to make the change */\\n                loc = (void *)sechdrs[sechdrs[relsec].sh_info].sh_addr\\n                        + rel[i].r_offset;\\n\\n                /* This is the symbol it is referring to.  Note that all\\n                   undefined symbols have been resolved.  */\\n                sym = (Elf64_Sym *)sechdrs[symindex].sh_addr\\n                        + ELF64_R_SYM(rel[i].r_info);\\n\\n                DEBUGP(\\"type %d st_value %Lx r_addend %Lx loc %Lx\\\\\\\\n\\",\\n                       (int)ELF64_R_TYPE(rel[i].r_info),\\n                       sym->st_value, rel[i].r_addend, (u64)loc);\\n\\n                val = sym->st_value + rel[i].r_addend;\\n                switch (ELF64_R_TYPE(rel[i].r_info)) {\\n                case R_X86_64_NONE:\\n                        break;\\n                case R_X86_64_64:\\n                        if (*(u64 *)loc != 0)\\n                                goto invalid_relocation;\\n                        *(u64 *)loc = val;\\n                        break;\\n                case R_X86_64_32:\\n                        if (*(u32 *)loc != 0)\\n                                goto invalid_relocation;\\n                        *(u32 *)loc = val;\\n                        if (val != *(u32 *)loc)\\n                                goto overflow;\\n                        break;\\n                case R_X86_64_32S:\\n                        if (*(s32 *)loc != 0)\\n                                goto invalid_relocation;\\n                        *(s32 *)loc = val;\\n                        if ((s64)val != *(s32 *)loc)\\n                                goto overflow;\\n                        break;\\n                case R_X86_64_PC32:\\n                case R_X86_64_PLT32:\\n                        if (*(u32 *)loc != 0)\\n                                goto invalid_relocation;\\n                        val -= (u64)loc;\\n                        *(u32 *)loc = val;\\n..........\\n\\n```\\n\\n\u4e0a\u8ff0\u4ee3\u7801\u904d\u5386\u6bcf\u4e2a\u53ef\u91cd\u5b9a\u4f4d section \u9879\u76ee\uff0cloc \u6307\u5411\u6a21\u5757\u52a0\u8f7d\u5230\u5185\u6838\u540e\u5b58\u50a8\u6bcf\u4e2a\u53ef\u91cd\u5b9a\u4f4d\u9879\u76ee\u88ab\u91cd\u5b9a\u4f4d\u533a\u57df\u7684\u5185\u5b58\u5730\u5740\uff0c\u4ee3\u8868 **R_X86_64_PLT32**  \u4e2d\u7684\u6807\u53f7 **P**\u3002\\n\\nsym \u4e2d\u4fdd\u5b58\u5df2\u7ecf resolve \u7684\u672a\u5b9a\u4e49\u7b26\u53f7\uff0csym->value \u8868\u793a\u7b26\u53f7\u52a0\u8f7d\u5730\u5740\uff0c\u4ee3\u8868 **R_X86_64_PLT32**  \u4e2d\u7684\u6807\u53f7 **S**\u3002\\n\\nrel[i].r_addend \u4fdd\u5b58\u53ef\u91cd\u5b9a\u4f4d\u9879\u76ee\u7684 **Addend** \u503c\uff0c\u4ee3\u8868 **R_X86_64_PLT32**  \u4e2d\u7684\u6807\u53f7 **A**\u3002\\n\\n\u5728\u786e\u5b9a\u4e86\u8fd9\u4e9b\u4fe1\u606f\u540e\uff0cswitch \u8bed\u53e5\u901a\u8fc7\u53ef\u91cd\u5b9a\u4f4d\u9879\u76ee\u7684 Type \u5b57\u6bb5\u8fdb\u884c\u903b\u8f91\u5206\u53d1\uff0c\u8ba1\u7b97\u5e76\u586b\u5145\u91cd\u5b9a\u4f4d\u540e\u7684\u5730\u5740\u3002\u5bf9\u4e8e R_X86_64_PLT32  \u8fd9\u79cd\u7c7b\u578b\u6765\u8bf4\uff0c\u8ba1\u7b97\u516c\u5f0f\u5c31\u662f **S + A - P**\u3002\\n\\n## \u603b\u7ed3\\n\\n\u5584\u4e8e\u63d0\u95ee\u662f\u4e00\u79cd\u5f88\u597d\u7684\u80fd\u529b\u3002\u4e3b\u52a8\u53d1\u73b0\u5e76\u63d0\u51fa\u95ee\u9898\u7136\u540e\u79ef\u6781\u7684\u5bfb\u627e\u7b54\u6848\uff0c\u6700\u540e\u7ed9\u51fa\u5408\u7406\u7684\u7b54\u6848\uff0c\u6536\u83b7\u6210\u5c31\u611f\u5e76\u63a8\u52a8\u81ea\u5df1\u7ee7\u7eed\u63d0\u51fa\u65b0\u7684\u95ee\u9898\uff0c\u8fd9\u662f\u4e00\u4e2a\u6b63\u53cd\u9988\u3002\u4ece\u81ea\u5df1\u80fd\u591f\u56de\u7b54\u7684\u5c0f\u95ee\u9898\u5f00\u59cb\uff0c\u4e0d\u65ad\u7684\u5faa\u73af\u5f80\u590d\uff0c\u96ea\u7403\u4f1a\u8d8a\u6eda\u8d8a\u5927\uff0c\u65f6\u95f4\u6b63\u7ad9\u5728\u4f60\u8fd9\u8fb9\u3002"},{"id":"/2022/06/12/\u5e8f\u8a00","metadata":{"permalink":"/longyu.github.io/blog/2022/06/12/\u5e8f\u8a00","editUrl":"https://github.com/longyuwlz/longyu.github.io/blog/2022-06-12-\u5e8f\u8a00/index.md","source":"@site/blog/2022-06-12-\u5e8f\u8a00/index.md","title":"\u5199\u535a\u5ba2\u7684\u610f\u4e49","description":"\u6211\u6ca1\u6709\u517b\u6210\u5199\u535a\u5ba2\u7684\u4e60\u60ef\uff0c\u6211\u4e00\u76f4\u5bf9\u81ea\u5df1\u7684\u8bb0\u5fc6\u529b\u62b1\u6709\u67d0\u79cd\u7279\u522b\u7684\u81ea\u4fe1\u3002\u6700\u8fd1\u6211\u53d1\u73b0\uff0c\u6211\u4e5f\u5fd8\u8bb0\u4e86\u5f88\u591a\u4e1c\u897f\u3002\u6211\u5728\u51e0\u5468\u524d\u641c\u96c6\u4e86\u4e00\u4e9b\u8d44\u6599\uff0c\u5b66\u4e60\u4e86\u5982\u4f55\u4f7f\u7528\u865a\u62df\u673a\u6765\u8c03\u8bd5 linux \u5185\u6838\uff0c\u4f46\u6211\u6ca1\u6709\u603b\u7ed3\u3002\u73b0\u5728\u867d\u7136\u73af\u5883\u5df2\u7ecf\u642d\u5efa\u597d\u4e86\uff0c\u4f46\u6211\u5fd8\u8bb0\u4e86\u64cd\u4f5c\u4e32\u53e3\u7684\u547d\u4ee4\u884c\uff0c\u6211\u8fd8\u5f97\u7ee7\u7eed\u67e5\u8d44\u6599\uff0c\u53c8\u5c06\u82b1\u8d39\u5f88\u591a\u65f6\u95f4\u3002\u5982\u679c\u6709\u4e00\u5929\uff0c\u6211\u5347\u7ea7\u4e86\u7cfb\u7edf\uff0c\u90a3\u4e48\u6211\u9700\u8981\u91cd\u65b0\u4ee5\u8fc7\u6765\u4eba\u7684\u8eab\u4efd\u4ece\u96f6\u5f00\u59cb\uff0c\u8fd9\u53ea\u662f\u7b80\u5355\u7684\u91cd\u590d\uff0c\u6ca1\u6709\u5b66\u4e60\u7684\u7a7a\u95f4\u3002","date":"2022-06-12T00:00:00.000Z","formattedDate":"2022\u5e746\u670812\u65e5","tags":[{"label":"blog","permalink":"/longyu.github.io/blog/tags/blog"}],"readingTime":4.705,"truncated":false,"authors":[],"frontMatter":{"title":"\u5199\u535a\u5ba2\u7684\u610f\u4e49","tags":["blog"]},"prevItem":{"title":"linux-kernel/linux-\u5185\u6838\u6a21\u5757\u4e2d\u5f15\u7528\u7b26\u53f7\u662f\u5982\u4f55\u94fe\u63a5\u7684","permalink":"/longyu.github.io/blog/linux-kernel/linux-\u5185\u6838\u6a21\u5757\u4e2d\u5f15\u7528\u7b26\u53f7\u662f\u5982\u4f55\u94fe\u63a5\u7684"}},"content":"\u6211\u6ca1\u6709\u517b\u6210\u5199\u535a\u5ba2\u7684\u4e60\u60ef\uff0c\u6211\u4e00\u76f4\u5bf9\u81ea\u5df1\u7684\u8bb0\u5fc6\u529b\u62b1\u6709\u67d0\u79cd\u7279\u522b\u7684\u81ea\u4fe1\u3002\u6700\u8fd1\u6211\u53d1\u73b0\uff0c\u6211\u4e5f\u5fd8\u8bb0\u4e86\u5f88\u591a\u4e1c\u897f\u3002\u6211\u5728\u51e0\u5468\u524d\u641c\u96c6\u4e86\u4e00\u4e9b\u8d44\u6599\uff0c\u5b66\u4e60\u4e86\u5982\u4f55\u4f7f\u7528\u865a\u62df\u673a\u6765\u8c03\u8bd5 linux \u5185\u6838\uff0c\u4f46\u6211\u6ca1\u6709\u603b\u7ed3\u3002\u73b0\u5728\u867d\u7136\u73af\u5883\u5df2\u7ecf\u642d\u5efa\u597d\u4e86\uff0c\u4f46\u6211\u5fd8\u8bb0\u4e86\u64cd\u4f5c\u4e32\u53e3\u7684\u547d\u4ee4\u884c\uff0c\u6211\u8fd8\u5f97\u7ee7\u7eed\u67e5\u8d44\u6599\uff0c\u53c8\u5c06\u82b1\u8d39\u5f88\u591a\u65f6\u95f4\u3002\u5982\u679c\u6709\u4e00\u5929\uff0c\u6211\u5347\u7ea7\u4e86\u7cfb\u7edf\uff0c\u90a3\u4e48\u6211\u9700\u8981\u91cd\u65b0\u4ee5\u8fc7\u6765\u4eba\u7684\u8eab\u4efd\u4ece\u96f6\u5f00\u59cb\uff0c\u8fd9\u53ea\u662f\u7b80\u5355\u7684\u91cd\u590d\uff0c\u6ca1\u6709\u5b66\u4e60\u7684\u7a7a\u95f4\u3002\\n\\n\u4e8b\u5b9e\u4e0a\uff0c\u6211\u6700\u8fd1\u51e0\u5e74\u5fd8\u8bb0\u4e86\u5b66\u8fc7\u7684\u5f88\u591a\u4e1c\u897f\u3002\u6211\u4e00\u76f4\u90fd\u6ca1\u517b\u6210\u8bb0\u5f55\u7684\u4e60\u60ef\uff0c\u6211\u89c9\u5f97\u8fd9\u6837\u4e0b\u53bb\u6211\u6c38\u8fdc\u5728\u524d\u5b66\u540e\u5fd8\uff0c\u6c38\u8fdc\u91cd\u65b0\u5f00\u59cb\uff0c\u800c\u4e0d\u662f\u7ad9\u5728\u8fc7\u53bb\u7684\u57fa\u7840\u4e4b\u4e0a\u3002\\n\\n\u7ad9\u5728\u5de8\u4eba\u7684\u80a9\u8180\u4e4b\u4e0a\uff0c\u8fd9\u662f\u4e00\u53e5\u5f88\u7ecf\u5178\u7684\u540d\u8a00\u3002\u6211\u5373\u4fbf\u4e0d\u80fd\u7ad9\u5728\u5de8\u4eba\u7684\u80a9\u8180\u4e4b\u4e0a\uff0c\u6211\u53ea\u8981\u80fd\u591f\u7ad9\u5728\u8fc7\u53bb\u52aa\u529b\u7684\u57fa\u7840\u4e4b\u4e0a\u5c31\u80fd\u591f\u770b\u5f97\u66f4\u8fdc\uff0c\u6bd5\u7adf\u6211\u7ad9\u7684\u66f4\u9ad8\u4e86\u5440\u3002\u53ef\u662f\u6211\u53d1\u73b0\u8fc7\u53bb\u6ca1\u6709\u6210\u4e3a\u6211\u8db3\u4e0b\u7684\u571f\u5730\uff0c\u5b83\u4ec5\u4ec5\u6210\u4e3a\u4e86\u6211\u7684\u4e00\u6bb5\u6a21\u7cca\u8bb0\u5fc6\u3002\u4e3a\u6b64\uff0c\u6211\u611f\u5230\u60ed\u6127\uff0c\u66f4\u611f\u5230\u60cb\u60dc\u3002\u6211\u660e\u660e\u53ef\u4ee5\u7ad9\u7684\u66f4\u9ad8\uff0c\u53ef\u4e0d\u597d\u7684\u4e60\u60ef\u5374\u8ba9\u6211\u603b\u662f\u7ad9\u5728\u5e73\u5730\u3002\\n\\n\u4eca\u5929\u6211\u6240\u62e5\u6709\u7684\u4e00\u5207\u90fd\u662f\u6211\u81ea\u5df1\u4e00\u6b65\u6b65\u83b7\u53d6\u7684\uff0c\u8fd9\u4e9b\u4e8b\u60c5\u6709\u597d\u6709\u574f\uff0c\u5b83\u6784\u6210\u4e86\u6211\u73b0\u5728\u6240\u6709\u7684\u751f\u6d3b\u3002\u5982\u679c\u6211\u6709\u4efb\u4f55\u7684\u4e0d\u6ee1\u4e0e\u6094\u6068\uff0c\u6211\u90fd\u53ea\u80fd\u62b1\u6028\u81ea\u5df1\u3002\u6211\u89c9\u5f97\u81ea\u5df1\u5f88\u53ef\u803b\uff0c\u81ea\u5df1\u5f88\u53ef\u60b2\uff0c\u81ea\u5df1\u5f88\u53ef\u601c\u3002\u53ef\u6211\u66f4\u660e\u767d\u53ea\u6709\u6539\u53d8\u80fd\u591f\u8ba9\u6211\u62e5\u6709\u8fdb\u5165\u4e00\u4e2a\u597d\u73af\u5883\u7684\u5165\u573a\u5238\uff0c\u6211\u8981\u8fd9\u6837\u53bb\u505a\u3002\\n\\n\u5199\u535a\u5ba2\u662f\u6587\u5b57\u7684\u4e00\u4e2a\u7a81\u7834\u70b9\u3002\u60f3\u8981\u66f4\u52a0\u51c6\u786e\u3001\u6e05\u695a\u7684\u8868\u8fbe\u51fa\u4e00\u4ef6\u4e8b\u60c5\uff0c\u8fd9\u672c\u8eab\u5c31\u9700\u8981\u5f3a\u5927\u7684\u6587\u7b14\u652f\u6301\u3002\u6211\u786e\u5b9e\u5199\u8fc7\u4e86\u5f88\u591a\u6587\u7ae0\uff0c\u4f46\u6211\u552f\u4e00\u6e05\u695a\u7684\u662f\u6211\u8fd8\u6709\u5f88\u5927\u7684\u4e0a\u5347\u7a7a\u95f4\uff0c\u6211\u7684\u6587\u5b57\u8fd8\u53ef\u4ee5\u66f4\u597d\u3002\u8fd9\u5c31\u662f\u5199\u535a\u5ba2\u5bf9\u6211\u7684\u4e00\u5927\u610f\u4e49\u3002\\n\\n\u540c\u65f6\uff0c\u5199\u535a\u5ba2\u4e5f\u5c06\u5e2e\u52a9\u6211\u4fdd\u7559\u4f4f\u8fc7\u53bb\u7684\u57fa\u7840\uff0c\u8ba9\u6211\u4e0d\u7528\u6bcf\u6b21\u90fd\u91cd\u65b0\u5f00\u59cb\uff0c\u54ea\u6015\u4ec5\u4ec5\u80fd\u591f\u63d0\u4f9b\u8f7b\u5fae\u7684\u53c2\u8003\u4ef7\u503c\uff0c\u8fd9\u4e5f\u80fd\u8282\u7701\u6211\u7684\u65f6\u95f4\u3002\\n\\n\u5199\u535a\u5ba2\u4e5f\u662f\u5411\u4ed6\u4eba\u5c55\u793a\u81ea\u6211\u7684\u4e00\u6b21\u5c1d\u8bd5\uff0c\u867d\u7136\u8fd9\u70b9\u5e76\u4e0d\u662f\u521d\u8877\u6240\u5728\u3002\\n\\n\u73b0\u6709\u535a\u6587\u7684\u6570\u91cf\u5df2\u7ecf\u5341\u5206\u5e9e\u5927\uff0c\u6211\u60f3\u5199\u7684\u4e1c\u897f\u5f88\u591a\u4eba\u90fd\u5df2\u7ecf\u5199\u8fc7\u4e86\u3002\u53ef\u6211\u60f3\u6211\u4ecd\u65e7\u80fd\u591f\u5199\u51fa\u65b0\u7684\u4e1c\u897f\uff0c\u6211\u4ee5\u81ea\u5df1\u7684\u89c6\u89d2\u4e0e\u601d\u7ef4\u6765\u7ec4\u7ec7\u6587\u5b57\uff0c\u81f3\u5c11\u8fd9\u4e9b\u6587\u5b57\u662f\u72ec\u95e8\u72ec\u9662\u7684\uff0c\u5b83\u62e5\u6709\u4ec5\u4ec5\u5c5e\u4e8e\u6211\u7684\u98ce\u683c\u3002\u90a3\u4e48\u5c31\u8ba9\u6211\u4ee5\u535a\u5ba2\u6765\u63cf\u7ed8\u51fa\u5b8c\u6574\u7684\u81ea\u6211\u8096\u50cf\u5427\uff01\\n\\n## \u5199\u535a\u5ba2\u63a8\u52a8\u601d\u8003\\n\u8fd9\u7bc7\u6587\u7ae0\u5df2\u7ecf\u53d1\u4e86\u6709\u4e00\u4e24\u5e74\u4e86\uff0c\u4eca\u5929\u6211\u89c9\u5f97\u5176\u5b9e\u6211\u5199\u535a\u5ba2\u7684\u4e3b\u8981\u76ee\u7684\u662f\u60f3\u51ed\u501f\u8fd9\u4e00\u8fc7\u7a0b\u6765\u63a8\u52a8\u81ea\u6211\u601d\u8003\u3002\u5728\u7814\u7a76\u4e00\u4e9b\u4ee3\u7801\u65f6\uff0c\u53ef\u80fd\u4e0d\u591f\u6df1\u5165\uff0c\u770b\u7684\u6a21\u6a21\u7cca\u7cca\uff0c\u53ef\u771f\u6b63\u603b\u7ed3\u8d77\u6765\uff0c\u5374\u4e0d\u5f97\u4e0d\u6df1\u5165\u7684\u601d\u8003\u4ee5\u514d\u5199\u51fa\u4e91\u91cc\u96fe\u91cc\u7684\u6587\u7ae0\u3002\\n\\n\u6211\u529b\u6c42\u8ba9\u5199\u535a\u5ba2\u6210\u4e3a\u63a8\u52a8\u81ea\u5df1\u601d\u8003\u7684\u4e00\u79cd\u65b9\u5f0f\uff0c\u66f4\u8fdb\u4e00\u6b65\u5c06\u5176\u53d1\u5c55\u4e3a\u4e00\u79cd\u4e60\u60ef\uff0c\u8fd9\u6837\u601d\u8003\u4fbf\u80fd\u591f\u6269\u5927\uff0c\u800c\u8fd9\u6b63\u662f\u6211\u8ba4\u53ef\u7684\u7ade\u4e89\u529b\u6240\u5728\uff01\u6050\u6015\u8fd9\u624d\u662f\u6211\u5199\u535a\u5ba2\u7684\u610f\u4e49\uff01\u81f3\u4e8e\u8bf4\u5f62\u5f0f\u4e0a\u7684\uff0c\u6216\u8005\u522b\u4eba\u8ba4\u4e3a\u7684\uff0c\u6216\u8005\u5176\u5b83\u7684\u4e1c\u897f\u5728\u8fd9\u4e2a\u610f\u4e49\u9762\u524d\u90fd\u53d8\u5f97\u65e0\u5173\u7d27\u8981\u4e86\uff01"}]}')}}]);