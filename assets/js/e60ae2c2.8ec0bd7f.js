"use strict";(self.webpackChunklongyu_website=self.webpackChunklongyu_website||[]).push([[7595],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return g}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},l=Object.keys(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var i=r.createContext({}),_=function(e){var t=r.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=_(e.components);return r.createElement(i.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,l=e.originalType,i=e.parentName,u=p(e,["components","mdxType","originalType","parentName"]),d=_(n),g=a,s=d["".concat(i,".").concat(g)]||d[g]||c[g]||l;return n?r.createElement(s,o(o({ref:t},u),{},{components:n})):r.createElement(s,o({ref:t},u))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=n.length,o=new Array(l);o[0]=d;var p={};for(var i in t)hasOwnProperty.call(t,i)&&(p[i]=t[i]);p.originalType=e,p.mdxType="string"==typeof e?e:a,o[1]=p;for(var _=2;_<l;_++)o[_]=n[_];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},1780:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return i},default:function(){return g},frontMatter:function(){return p},metadata:function(){return _},toc:function(){return c}});var r=n(7462),a=n(3366),l=(n(7294),n(3905)),o=["components"],p={},i=void 0,_={permalink:"/longyu.github.io/blog/dpdk/dpdk-16.04 rte_spinlock.h rte_cpu_get_flag_enabled \u63a5\u53e3\u95ee\u9898",editUrl:"https://github.com/longyuwlz/longyu.github.io/blog/dpdk/dpdk-16.04 rte_spinlock.h rte_cpu_get_flag_enabled \u63a5\u53e3\u95ee\u9898.md",source:"@site/blog/dpdk/dpdk-16.04 rte_spinlock.h rte_cpu_get_flag_enabled \u63a5\u53e3\u95ee\u9898.md",title:"dpdk/dpdk-16.04 rte_spinlock.h rte_cpu_get_flag_enabled \u63a5\u53e3\u95ee\u9898",description:"\u95ee\u9898\u63cf\u8ff0",date:"2022-06-21T00:32:49.000Z",formattedDate:"2022\u5e746\u670821\u65e5",tags:[],readingTime:4.9,truncated:!1,authors:[],frontMatter:{},prevItem:{title:"dpdk/dpdk-16.04 rte_kni \u6a21\u5757\u5206\u6790",permalink:"/longyu.github.io/blog/dpdk/dpdk-16.04 rte_kni \u6a21\u5757\u5206\u6790"},nextItem:{title:"\u7f16\u8bd1\u76f8\u5173\u914d\u7f6e\u6dfb\u52a0",permalink:"/longyu.github.io/blog/dpdk/dpdk-16.04 \u6269\u5c55\u65b0\u7f51\u5361\u9a71\u52a8\u8fc7\u7a0b"}},u={authorsImageUrls:[]},c=[{value:"\u95ee\u9898\u63cf\u8ff0",id:"\u95ee\u9898\u63cf\u8ff0",level:2},{value:"rte_cpu_get_flag_enabled \u5728\u54ea\u91cc\u88ab\u5b9a\u4e49\uff1f",id:"rte_cpu_get_flag_enabled-\u5728\u54ea\u91cc\u88ab\u5b9a\u4e49",level:2},{value:"\u4e3a\u4ec0\u4e48 rte_cpu_get_flag_enabled \u672a\u88ab\u94fe\u63a5\uff1f",id:"\u4e3a\u4ec0\u4e48-rte_cpu_get_flag_enabled-\u672a\u88ab\u94fe\u63a5",level:2},{value:"\u5982\u4f55\u89e3\u51b3\u95ee\u9898\uff1f",id:"\u5982\u4f55\u89e3\u51b3\u95ee\u9898",level:2},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}],d={toc:c};function g(e){var t=e.components,n=(0,a.Z)(e,o);return(0,l.kt)("wrapper",(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h2",{id:"\u95ee\u9898\u63cf\u8ff0"},"\u95ee\u9898\u63cf\u8ff0"),(0,l.kt)("p",null,"dpdk-16.04 \u9002\u914d vpp \u6d4b\u8bd5\u8fc7\u7a0b\u4e2d\uff0c\u6267\u884c vpp \u7a0b\u5e8f\u9047\u5230\u4e86\u5982\u4e0b\u62a5\u9519\u5185\u5bb9\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"load_one_plugin:145: /lib/vpp_plugins/router.so: undefined symbol: rte_cpu_get_flag_enabled\nload_one_plugin:146: Failed to load plugin 'router.so'\n")),(0,l.kt)("p",null,"\u62a5\u9519\u4fe1\u606f\u8868\u660e\u672a\u627e\u5230 rte_cpu_get_flag_enabled \u8fd9\u4e2a\u7b26\u53f7\u7684\u5b9a\u4e49\uff0c\u4f7f\u7528 nm \u67e5\u770b router.so \u4e2d\u76f8\u5173\u7684\u7b26\u53f7\u4fe1\u606f\uff0c\u5f97\u5230\u4e86\u5982\u4e0b\u5185\u5bb9\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"                 U rte_cpu_get_flag_enabled\n00000000000037a0 t rte_rtm_init\n")),(0,l.kt)("p",null,"\u786e\u5b9a rte_cpu_get_flag_enabled \u51fd\u6570\u786e\u5b9e\u6ca1\u6709\u5b9a\u4e49!"),(0,l.kt)("h2",{id:"rte_cpu_get_flag_enabled-\u5728\u54ea\u91cc\u88ab\u5b9a\u4e49"},"rte_cpu_get_flag_enabled \u5728\u54ea\u91cc\u88ab\u5b9a\u4e49\uff1f"),(0,l.kt)("p",null,"\u5728 dpdk 16.04 \u6e90\u7801\u4e2d\u641c\u7d22\u53d1\u73b0\u8fd9\u4e2a\u51fd\u6570\u5728\u4e0b\u9762\u51e0\u4e2a\u6587\u4ef6\u4e2d\u90fd\u6709\u5b9a\u4e49\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"./lib/librte_eal/common/arch/tile/rte_cpuflags.c:44:rte_cpu_get_flag_enabled(__attribute__((unused)) enum rte_cpu_flag_t feature)\n./lib/librte_eal/common/arch/x86/rte_cpuflags.c:187:rte_cpu_get_flag_enabled(enum rte_cpu_flag_t feature)\n./lib/librte_eal/common/arch/arm/rte_cpuflags.c:157:rte_cpu_get_flag_enabled(enum rte_cpu_flag_t feature)\n./lib/librte_eal/common/arch/ppc_64/rte_cpuflags.c:125:rte_cpu_get_flag_enabled(enum rte_cpu_flag_t feature)\n")),(0,l.kt)("p",null,"\u6211\u7f16\u8bd1\u7684\u7248\u672c\u4e3a x86-64 \u67b6\u6784\uff0c\u5bf9\u5e94 ",(0,l.kt)("strong",{parentName:"p"},"./lib/librte_eal/common/arch/x86/rte_cpuflags.c")," \u6587\u4ef6\uff0c\u540c\u65f6\u6211\u7f16\u8bd1\u7684\u76ee\u6807\u67b6\u6784\u4e3a linux \u7cfb\u7edf\uff0cMakefile \u4e2d\u7684\u7f16\u8bd1\u8bed\u53e5\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"./lib/librte_eal/linuxapp/eal/Makefile:104:SRCS-$(CONFIG_RTE_EXEC_ENV_LINUXAPP) += rte_cpuflags.c\n")),(0,l.kt)("p",null,"\u80fd\u591f\u786e\u5b9a ",(0,l.kt)("strong",{parentName:"p"},"rte_cpu_get_flag_enabled")," \u51fd\u6570\u88ab\u7f16\u8bd1\u5230\u4e86 librte_eal.a \u4e2d\uff0c\u53ea\u6709\u94fe\u63a5\u4e86\u8fd9\u4e2a\u5e93\u5e94\u8be5\u80fd\u591f\u627e\u5230\u8fd9\u4e2a\u7b26\u53f7\u3002"),(0,l.kt)("h2",{id:"\u4e3a\u4ec0\u4e48-rte_cpu_get_flag_enabled-\u672a\u88ab\u94fe\u63a5"},"\u4e3a\u4ec0\u4e48 rte_cpu_get_flag_enabled \u672a\u88ab\u94fe\u63a5\uff1f"),(0,l.kt)("p",null,"\u9996\u5148\u68c0\u67e5\u7f16\u8bd1\u53c2\u6570\uff0c\u53d1\u73b0\u7f16\u8bd1\u53c2\u6570\u4e2d\u6ca1\u6709\u94fe\u63a5 librte_eal.a\uff0c\u8fd9\u80fd\u591f\u89e3\u91ca rte_cpu_get_flag_enabled \u51fd\u6570\u627e\u4e0d\u5230\u5b9a\u4e49\u7684\u95ee\u9898\uff0c\u4f46\u662f\u8fd9\u4e2a\u51fd\u6570\u53c8\u5728\u54ea\u91cc\u88ab\u8c03\u7528\u5462\uff1f"),(0,l.kt)("p",null,"\u5728 router.so \u4ee3\u7801\u4e2d\u641c\u7d22\uff0c",(0,l.kt)("strong",{parentName:"p"},"\u6ca1\u6709\u53d1\u73b0\u8c03\u7528\u70b9"),"\uff0c\u9887\u6709\u4e9b\u610f\u5916\u3002\u60f3\u5230\u8fd9\u4e2a\u51fd\u6570\u53ef\u80fd\u662f\u5728 dpdk \u51fd\u6570\u4e2d\u88ab\u8c03\u7528\uff0c\u641c\u7d22\u53d1\u73b0\u5b83\u539f\u6765\u662f\u5728 ",(0,l.kt)("strong",{parentName:"p"},"rte_rtm_init")," \u51fd\u6570\u4e2d\u88ab\u8c03\u7528\u3002x86 \u67b6\u6784\u4e2d\uff0c\u5176\u5b9a\u4e49\u4f4d\u4e8e ",(0,l.kt)("strong",{parentName:"p"},"./lib/librte_eal/common/include/arch/x86/rte_spinlock.h")," \u6587\u4ef6\u4e2d\u3002"),(0,l.kt)("p",null,"rte_spinlock.h \u6587\u4ef6\u4e2d\u7684\u76f8\u5173\u6e90\u7801\u6458\u5f55\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c"},"static uint8_t rtm_supported; /* cache the flag to avoid the overhead\n                                 of the rte_cpu_get_flag_enabled function */\n\nstatic inline void __attribute__((constructor))\nrte_rtm_init(void)\n{\n        rtm_supported = rte_cpu_get_flag_enabled(RTE_CPUFLAG_RTM);\n}\n\nstatic inline int rte_tm_supported(void)\n{\n        rte_cpu_get_flag_enabled(RTE_CPUFLAG_RTM);\n        return rtm_supported;\n}\n")),(0,l.kt)("p",null,"\u8fd9\u4e2a\u5934\u6587\u4ef6\u4e2d\u7684\u5b9a\u4e49\u5185\u5bb9\u6709\u5982\u4e0b\u51e0\u4e2a\u7279\u522b\u4e4b\u5904\uff1a"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u5728\u5934\u6587\u4ef6\u4e2d\u5b9a\u4e49\u4e86\u4e00\u4e2a\u9759\u6001\u53d8\u91cf rtm_supported"),(0,l.kt)("li",{parentName:"ol"},"rte_rtm_init \u88ab\u58f0\u660e\u4e3a\u4e00\u4e2a\u5185\u8054\u51fd\u6570+\u6784\u9020\u51fd\u6570\uff0c\u5c06\u4f1a\u5728 main \u51fd\u6570\u6267\u884c\u524d\u88ab\u8c03\u7528"),(0,l.kt)("li",{parentName:"ol"},"rte_rtm_init \u4e2d\u8c03\u7528\u4e86\u4e00\u4e2a\u975e\u5185\u8054\u51fd\u6570 rte_cpu_get_flag_enabled")),(0,l.kt)("p",null,"\u5728\u5934\u6587\u4ef6\u4e2d\u5b9a\u4e49\u9759\u6001\u53d8\u91cf\uff0c\u5219\u53ea\u8981\u5305\u542b\u4e86\u8fd9\u4e2a\u5934\u6587\u4ef6\u90fd\u4f1a\u6709\u4e00\u4e2a rtm_supported \u7684\u5b9a\u4e49\uff0c\u4e0d\u8fc7\u7531\u4e8e",(0,l.kt)("strong",{parentName:"p"},"\u53d8\u91cf\u7c7b\u578b\u4e3a\u9759\u6001\u53d8\u91cf\uff0c\u6709\u5c40\u90e8\u4f5c\u7528\u57df\u56e0\u800c\u6ca1\u6709\u9020\u6210\u95ee\u9898"),"\u3002"),(0,l.kt)("p",null,"rte_rtm_init \u5728\u5934\u6587\u4ef6\u4e2d\u5b9a\u4e49\u5e76\u88ab\u58f0\u660e\u4e3a",(0,l.kt)("strong",{parentName:"p"},"\u6784\u9020\u51fd\u6570"),"\uff0c\u5219\u53ea\u8981",(0,l.kt)("strong",{parentName:"p"},"\u5305\u542b\u4e86\u8fd9\u4e2a\u5934\u6587\u4ef6"),"\u5c31\u4f1a\u94fe\u63a5 ",(0,l.kt)("strong",{parentName:"p"},"rte_rtm_init"),"\u3002\u6709 ",(0,l.kt)("strong",{parentName:"p"},"inline")," \u7684\u4fee\u9970\u52a0\u5b8c\u6574\u7684\u5b9a\u4e49\uff0c\u4e5f\u80fd\u591f\u8fd9\u6837\u73a9\u3002"),(0,l.kt)("p",null,"\u53ef\u662f\u5728\u8fd9\u91cc\uff0c ",(0,l.kt)("strong",{parentName:"p"},"rte_rtm_init")," \u4e2d\u5374\u8c03\u7528\u4e86\u4e00\u4e2a\u975e\u5185\u8054\u51fd\u6570 ",(0,l.kt)("strong",{parentName:"p"},"rte_cpu_get_flag_enabled"),"\uff0c\u800c ",(0,l.kt)("strong",{parentName:"p"},"rte_cpu_get_flag_enabled")," \u5374\u9700\u8981\u94fe\u63a5 ",(0,l.kt)("strong",{parentName:"p"},"librte_eal.a")," \u624d\u80fd\u627e\u5230\u5b9e\u9645\u7684\u5b9a\u4e49\uff0c\u8fd9\u5c31\u5b58\u5728\u4e00\u79cd\u9690\u5f0f\u7684\u4f9d\u8d56\u3002\u5373",(0,l.kt)("strong",{parentName:"p"},"\u5305\u542b\u4e86 rte_spinlock.h \u5c31\u5fc5\u987b\u94fe\u63a5 librte_eal.a"),"\u3002"),(0,l.kt)("p",null,"router.so \u4e2d\u5b58\u5728\u5305\u542b\u4e86 ",(0,l.kt)("strong",{parentName:"p"},"rte_spinlock.h")," \u7684\u60c5\u51b5\uff0c\u5374\u6ca1\u6709\u94fe\u63a5 ",(0,l.kt)("strong",{parentName:"p"},"librte_eal.a"),"\uff0c\u5c31\u8e29\u5230\u4e86\u8fd9\u4e2a\u5751\uff01"),(0,l.kt)("h2",{id:"\u5982\u4f55\u89e3\u51b3\u95ee\u9898"},"\u5982\u4f55\u89e3\u51b3\u95ee\u9898\uff1f"),(0,l.kt)("p",null,"dpdk 16.04 \u662f\u4e00\u4e2a\u6bd4\u8f83\u8001\u7684\u7248\u672c\uff0c\u8fd9\u4e2a\u95ee\u9898\u53ef\u80fd\u5728\u9ad8\u7248\u672c\u5df2\u7ecf\u88ab\u4fee\u590d\u4e86\u3002\u4e8e\u662f\u67e5\u770b git log\uff0c\u627e\u5230\u4e86\u5982\u4e0b\u63d0\u4ea4\u5185\u5bb9\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'commit a088b5ea35e78d3866d492ed5e8c8f47118696a6\nAuthor: Damjan Marion <damarion@cisco.com>\nDate:   Thu Jul 14 15:27:29 2016 +0200\n\n    spinlock: move constructor out of x86 header file\n    \n    Having constructor function in the header file is generally\n    a bad idea, as it will eventually be implanted to 3rd party\n    library.\n    \n    In this case it causes linking issues with 3rd party libraries\n    when an application is not linked to dpdk, due to missing\n    symbol called by constructor.\n    \n    Fixes: ba7468997ea6 ("spinlock: add HTM lock elision for x86")\n    \n    Signed-off-by: Damjan Marion <damarion@cisco.com>\n    Reviewed-by: Jan Viktorin <viktorin@rehivetech.com>\n    Signed-off-by: Thomas Monjalon <thomas.monjalon@6wind.com>\n')),(0,l.kt)("p",null,"\u4ece\u65f6\u95f4\u4e0a\u770b\u5728 16.07 \u7248\u672c\u5c31\u4fee\u590d\u4e86\u8fd9\u4e2a\u95ee\u9898\uff0c\u4ec5\u4ec5\u5728 16.04 \u53d1\u5e03\u7684 3 \u4e2a\u6708\u540e\uff01\uff01"),(0,l.kt)("p",null,"\u5173\u952e\u4fee\u6539\u5185\u5bb9\u662f\u6dfb\u52a0\u4e00\u4e2a rte_spinlock.c \u6587\u4ef6\uff0c\u5c06\u5934\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\u9759\u6001\u53d8\u91cf\u4e0e rte_rtm_init \u6784\u9020\u51fd\u6570\u653e\u5230 .c \u4e2d\u3002"),(0,l.kt)("p",null,"\u76f8\u5173\u4ee3\u7801\u6458\u5f55\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c"},'#include <stdint.h>\n\n#include "rte_cpuflags.h"\n\nuint8_t rte_rtm_supported; /* cache the flag to avoid the overhead\n                             of the rte_cpu_get_flag_enabled function */\n\nstatic void __attribute__((constructor))\nrte_rtm_init(void)\n{\n       rte_rtm_supported = rte_cpu_get_flag_enabled(RTE_CPUFLAG_RTM);\n}\n')),(0,l.kt)("p",null,"\u4ece\u9ad8\u7248\u672c\u5bfc\u51fa patch \u7136\u540e\u6253\u4e0a\uff0c\u95ee\u9898\u5f97\u5230\u89e3\u51b3\uff01\uff01"),(0,l.kt)("h2",{id:"\u603b\u7ed3"},"\u603b\u7ed3"),(0,l.kt)("p",null,"\u95ee\u9898\u4e00\u76f4\u90fd\u5b58\u5728\uff0c\u800c\u4f60\u80fd\u5426\u53d1\u73b0\u5b83\u5374\u53e6\u5f53\u522b\u8bba\uff01\u53d1\u73b0\u95ee\u9898\uff0c\u89e3\u51b3\u95ee\u9898\uff0c\u6211\u4eec\u624d\u80fd\u4e0d\u65ad\u6210\u957f\u3002\u53d1\u73b0\u4e0d\u4e86\u65b0\u7684\u95ee\u9898\uff0c\u53ef\u80fd\u662f\u5b8c\u5168\u638c\u63e1\uff0c\u4e5f\u53ef\u80fd\u662f\u4e00\u77e5\u534a\u89e3\u3002"))}g.isMDXComponent=!0}}]);