"use strict";(self.webpackChunklongyu_website=self.webpackChunklongyu_website||[]).push([[877],{3905:function(t,r,n){n.d(r,{Zo:function(){return l},kt:function(){return g}});var e=n(7294);function a(t,r,n){return r in t?Object.defineProperty(t,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[r]=n,t}function i(t,r){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var e=Object.getOwnPropertySymbols(t);r&&(e=e.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,e)}return n}function c(t){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?i(Object(n),!0).forEach((function(r){a(t,r,n[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))}))}return t}function o(t,r){if(null==t)return{};var n,e,a=function(t,r){if(null==t)return{};var n,e,a={},i=Object.keys(t);for(e=0;e<i.length;e++)n=i[e],r.indexOf(n)>=0||(a[n]=t[n]);return a}(t,r);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(e=0;e<i.length;e++)n=i[e],r.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(a[n]=t[n])}return a}var s=e.createContext({}),u=function(t){var r=e.useContext(s),n=r;return t&&(n="function"==typeof t?t(r):c(c({},r),t)),n},l=function(t){var r=u(t.components);return e.createElement(s.Provider,{value:r},t.children)},p={inlineCode:"code",wrapper:function(t){var r=t.children;return e.createElement(e.Fragment,{},r)}},_=e.forwardRef((function(t,r){var n=t.components,a=t.mdxType,i=t.originalType,s=t.parentName,l=o(t,["components","mdxType","originalType","parentName"]),_=u(n),g=a,y=_["".concat(s,".").concat(g)]||_[g]||p[g]||i;return n?e.createElement(y,c(c({ref:r},l),{},{components:n})):e.createElement(y,c({ref:r},l))}));function g(t,r){var n=arguments,a=r&&r.mdxType;if("string"==typeof t||a){var i=n.length,c=new Array(i);c[0]=_;var o={};for(var s in r)hasOwnProperty.call(r,s)&&(o[s]=r[s]);o.originalType=t,o.mdxType="string"==typeof t?t:a,c[1]=o;for(var u=2;u<i;u++)c[u]=n[u];return e.createElement.apply(null,c)}return e.createElement.apply(null,n)}_.displayName="MDXCreateElement"},1900:function(t,r,n){n.r(r),n.d(r,{assets:function(){return l},contentTitle:function(){return s},default:function(){return g},frontMatter:function(){return o},metadata:function(){return u},toc:function(){return p}});var e=n(7462),a=n(3366),i=(n(7294),n(3905)),c=["components"],o={},s="gcc x64 \u73af\u5883\u4e2d\u9ed8\u8ba4\u94fe\u63a5\u811a\u672c\u5206\u6790\u4e4b preinit_array\u3001constructor\u3001destructor \u76f8\u5173\u5206\u6790",u={unversionedId:"\u6280\u672f\u535a\u5ba2/linux-system/gcc/\u94fe\u63a5\u5668/gcc x64 \u73af\u5883\u4e2d\u9ed8\u8ba4\u94fe\u63a5\u811a\u672c\u5206\u6790\u4e4b preinit_array\u3001constructor\u3001destructor \u76f8\u5173\u5206\u6790",id:"\u6280\u672f\u535a\u5ba2/linux-system/gcc/\u94fe\u63a5\u5668/gcc x64 \u73af\u5883\u4e2d\u9ed8\u8ba4\u94fe\u63a5\u811a\u672c\u5206\u6790\u4e4b preinit_array\u3001constructor\u3001destructor \u76f8\u5173\u5206\u6790",title:"gcc x64 \u73af\u5883\u4e2d\u9ed8\u8ba4\u94fe\u63a5\u811a\u672c\u5206\u6790\u4e4b preinit_array\u3001constructor\u3001destructor \u76f8\u5173\u5206\u6790",description:"preinit_array \u6bb5\u811a\u672c",source:"@site/docs/\u6280\u672f\u535a\u5ba2/linux-system/gcc/\u94fe\u63a5\u5668/gcc x64 \u73af\u5883\u4e2d\u9ed8\u8ba4\u94fe\u63a5\u811a\u672c\u5206\u6790\u4e4b preinit_array\u3001constructor\u3001destructor \u76f8\u5173\u5206\u6790.md",sourceDirName:"\u6280\u672f\u535a\u5ba2/linux-system/gcc/\u94fe\u63a5\u5668",slug:"/\u6280\u672f\u535a\u5ba2/linux-system/gcc/\u94fe\u63a5\u5668/gcc x64 \u73af\u5883\u4e2d\u9ed8\u8ba4\u94fe\u63a5\u811a\u672c\u5206\u6790\u4e4b preinit_array\u3001constructor\u3001destructor \u76f8\u5173\u5206\u6790",permalink:"/longyu.github.io/\u6280\u672f\u535a\u5ba2/linux-system/gcc/\u94fe\u63a5\u5668/gcc x64 \u73af\u5883\u4e2d\u9ed8\u8ba4\u94fe\u63a5\u811a\u672c\u5206\u6790\u4e4b preinit_array\u3001constructor\u3001destructor \u76f8\u5173\u5206\u6790",draft:!1,editUrl:"https://github.com/longyuwlz/longyu.github.io/docs/\u6280\u672f\u535a\u5ba2/linux-system/gcc/\u94fe\u63a5\u5668/gcc x64 \u73af\u5883\u4e2d\u9ed8\u8ba4\u94fe\u63a5\u811a\u672c\u5206\u6790\u4e4b preinit_array\u3001constructor\u3001destructor \u76f8\u5173\u5206\u6790.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"gcc x64 \u73af\u5883\u4e2d\u9ed8\u8ba4\u94fe\u63a5\u811a\u672c\u5206\u6790\u4e4b ENTRY \u6807\u53f7\u4e0e _start \u51fd\u6570",permalink:"/longyu.github.io/\u6280\u672f\u535a\u5ba2/linux-system/gcc/\u94fe\u63a5\u5668/gcc x64 \u73af\u5883\u4e2d\u9ed8\u8ba4\u94fe\u63a5\u811a\u672c\u5206\u6790\u4e4b ENTRY \u6807\u53f7\u4e0e _start \u51fd\u6570"},next:{title:"gcc x64 \u73af\u5883\u4e2d\u9ed8\u8ba4\u94fe\u63a5\u811a\u672c\u5206\u6790\u4e4b\u94fe\u63a5\u5668\u57fa\u7840\u547d\u4ee4\u529f\u80fd\u4ecb\u7ecd",permalink:"/longyu.github.io/\u6280\u672f\u535a\u5ba2/linux-system/gcc/\u94fe\u63a5\u5668/gcc x64 \u73af\u5883\u4e2d\u9ed8\u8ba4\u94fe\u63a5\u811a\u672c\u5206\u6790\u4e4b\u94fe\u63a5\u5668\u57fa\u7840\u547d\u4ee4\u529f\u80fd\u4ecb\u7ecd"}},l={},p=[{value:"preinit_array \u6bb5\u811a\u672c",id:"preinit_array-\u6bb5\u811a\u672c",level:2},{value:"gcc constructor \u4e0e destructor \u5c5e\u6027",id:"gcc-constructor-\u4e0e-destructor-\u5c5e\u6027",level:3},{value:"init_array \u4e0e fini_array \u6bb5\u811a\u672c",id:"init_array-\u4e0e-fini_array-\u6bb5\u811a\u672c",level:2}],_={toc:p};function g(t){var r=t.components,n=(0,a.Z)(t,c);return(0,i.kt)("wrapper",(0,e.Z)({},_,n,{components:r,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"gcc-x64-\u73af\u5883\u4e2d\u9ed8\u8ba4\u94fe\u63a5\u811a\u672c\u5206\u6790\u4e4b-preinit_arrayconstructordestructor-\u76f8\u5173\u5206\u6790"},"gcc x64 \u73af\u5883\u4e2d\u9ed8\u8ba4\u94fe\u63a5\u811a\u672c\u5206\u6790\u4e4b preinit_array\u3001constructor\u3001destructor \u76f8\u5173\u5206\u6790"),(0,i.kt)("h2",{id:"preinit_array-\u6bb5\u811a\u672c"},"preinit_array \u6bb5\u811a\u672c"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-link"},"  .preinit_array     :\n  {\n    PROVIDE_HIDDEN (__preinit_array_start = .);\n    KEEP (*(.preinit_array))\n    PROVIDE_HIDDEN (__preinit_array_end = .);\n  }\n")),(0,i.kt)("p",null,"preinit_array section \u4e0e init_array section \u529f\u80fd\u7c7b\u4f3c\uff0c\u4e0d\u8fc7",(0,i.kt)("strong",{parentName:"p"},"\u6b64 section \u4e2d\u7684\u51fd\u6570\u5730\u5740\u5bf9\u5e94\u7684\u51fd\u6570\u5728 init_array section \u4e2d\u7684\u51fd\u6570\u6267\u884c\u524d\u6267\u884c"),"\uff0c\u76ee\u524d\u6ca1\u6709\u770b\u5230\u8fc7\u76f8\u5173\u7684\u5e94\u7528\u3002"),(0,i.kt)("h3",{id:"gcc-constructor-\u4e0e-destructor-\u5c5e\u6027"},"gcc constructor \u4e0e destructor \u5c5e\u6027"),(0,i.kt)("p",null,"c \u4ee3\u7801\u4e2d\u4f7f\u7528 gcc  ",(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("strong",{parentName:"strong"},"attribute"),"((constructor))")," \u5c5e\u6027\u4fee\u9970\u7684\u51fd\u6570\uff0c\u5176",(0,i.kt)("strong",{parentName:"p"},"\u51fd\u6570\u5730\u5740"),"\u5c06\u4f1a\u88ab\u653e\u5230 ",(0,i.kt)("strong",{parentName:"p"},"init_array section")," \u4e2d\uff0c\u8fd9\u4e9b\u51fd\u6570\u5728 ",(0,i.kt)("strong",{parentName:"p"},"main \u51fd\u6570\u6267\u884c\u524d"),"\u6267\u884c\uff0c\u8fdb\u884c\u4e00\u4e9b\u5fc5\u8981\u7684",(0,i.kt)("strong",{parentName:"p"},"\u521d\u59cb\u5316"),"\u5de5\u4f5c\u3002"),(0,i.kt)("p",null,"\u4e0e\u4e4b\u7c7b\u4f3c\u7684\u7684\u8fd8\u6709 ",(0,i.kt)("strong",{parentName:"p"},"destructor")," \u5c5e\u6027\uff0c\u8fd9\u4e2a ",(0,i.kt)("strong",{parentName:"p"},"destructor")," \u5c5e\u6027\u4fee\u9970\u7684\u51fd\u6570\u4f1a\u5c06",(0,i.kt)("strong",{parentName:"p"},"\u51fd\u6570\u5730\u5740"),"\u653e\u5230 ",(0,i.kt)("strong",{parentName:"p"},"fini_array section")," \u4e2d\uff0c\u5728 main \u51fd\u6570\u6267\u884c\u5b8c\u6210\u540e\u6216\u5728 exit \u51fd\u6570\u4e2d\u88ab\u8c03\u7528\u3002"),(0,i.kt)("p",null,"\u4e5f\u53ef\u4ee5\u5411 constructor \u4e0e destructor \u5c5e\u6027\u4fee\u9970\u7684\u51fd\u6570\u6307\u5b9a\u4e00\u4e2a\u53ef\u9009\u7684",(0,i.kt)("strong",{parentName:"p"},"\u6574\u578b\u4f18\u5148\u7ea7"),"\u3002\u5bf9\u4e8e constructor \u51fd\u6570\u6765\u8bf4",(0,i.kt)("strong",{parentName:"p"},"\u5c0f\u6570\u5b57\u5bf9\u5e94\u9ad8\u4f18\u5148\u7ea7"),"\uff0c\u76f8\u5173\u7684\u51fd\u6570",(0,i.kt)("strong",{parentName:"p"},"\u4f18\u5148\u6267\u884c"),"\uff0cdestructor \u6b63\u76f8\u53cd\u3002"),(0,i.kt)("p",null,"destructor \u4e00\u822c\u5f88\u5c11\u4f7f\u7528\uff0c\u6211\u5728 glibc \u4e2d\u627e\u5230\u4e86\u4e00\u4e2a\u793a\u4f8b\u51fd\u6570\uff0c\u5176\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"209 static void\n210 __attribute__ ((destructor))\n211 fini (void)\n212 {\n213   check_free (&last_result);\n214 }\n")),(0,i.kt)("p",null,"map \u6587\u4ef6\u4e2d\u7684\u76f8\u5173\u4fe1\u606f\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-map"},"4727  .fini_array    0x00000000004a2118        0x8 /usr/lib/gcc/x86_64-linux-gnu/8/../../../x86_64-linux-gnu/libc.a(sdlerror.o)\n")),(0,i.kt)("p",null,"\u6839\u636e map \u6587\u4ef6\u7684\u4fe1\u606f\u786e\u5b9a\u6b64 fini \u51fd\u6570\u7684\u5730\u5740\u88ab\u653e\u5230\u4e86 fini_array section \u4e2d\u3002"),(0,i.kt)("p",null,"\u9700\u8981\u989d\u5916\u8bf4\u660e\uff0c\u5f53 ",(0,i.kt)("strong",{parentName:"p"},"attribute"),"((constructor)) \u4fee\u9970\u7684\u51fd\u6570\u88ab\u7f16\u8bd1\u5230\u52a8\u6001\u5e93\u4e2d\u65f6\uff0c\u94fe\u63a5\u76f8\u5e94\u52a8\u6001\u5e93\u65f6\uff0c\u5904\u7406\u65b9\u6cd5\u4e0e\u8fd9\u91cc\u63cf\u8ff0\u7684\u5185\u5bb9\u6709\u6240\u533a\u522b\u3002"),(0,i.kt)("h2",{id:"init_array-\u4e0e-fini_array-\u6bb5\u811a\u672c"},"init_array \u4e0e fini_array \u6bb5\u811a\u672c"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-link"},"  .init_array     :\n  {\n    PROVIDE_HIDDEN (__init_array_start = .);\n    KEEP (*(SORT_BY_INIT_PRIORITY(.init_array.*) SORT_BY_INIT_PRIORITY(.ctors.*)))\n    KEEP (*(.init_array EXCLUDE_FILE (*crtbegin.o *crtbegin?.o *crtend.o *crtend?.o ) .ctors))\n    PROVIDE_HIDDEN (__init_array_end = .);\n  }\n  .fini_array     :\n  {\n    PROVIDE_HIDDEN (__fini_array_start = .);\n    KEEP (*(SORT_BY_INIT_PRIORITY(.fini_array.*) SORT_BY_INIT_PRIORITY(.dtors.*)))\n    KEEP (*(.fini_array EXCLUDE_FILE (*crtbegin.o *crtbegin?.o *crtend.o *crtend?.o ) .dtors))\n    PROVIDE_HIDDEN (__fini_array_end = .);\n  }\n")),(0,i.kt)("p",null,"\u4e0a\u9762\u7684\u811a\u672c\u5185\u5bb9\u4e2d\uff0c\u4f7f\u7528\u4e86 KEEP \u547d\u4ee4\uff0c\u8fd9\u662f\u7531\u4e8e ",(0,i.kt)("strong",{parentName:"p"},"finit_array section")," \u5e76\u4e0d\u4f1a\u88ab\u7a0b\u5e8f\u76f4\u63a5\u4f7f\u7528\uff0c\u4e3a\u4e86",(0,i.kt)("strong",{parentName:"p"},"\u907f\u514d\u88ab\u79fb\u9664"),"\u9700\u8981\u6dfb\u52a0 KEEP \u547d\u4ee4\u3002"),(0,i.kt)("p",null,"\u540c\u65f6 init_array \u4e0e fini_array \u90fd\u901a\u8fc7 PROVIDE_HIDDEN \u5728 section \u5185\u5bb9\u524d\u540e\u8bbe\u5b9a\u4e86",(0,i.kt)("strong",{parentName:"p"},"\u5f00\u59cb\u4e0e\u7ed3\u675f\u6807\u53f7\u7684\u5730\u5740"),"\uff0c\u8fd9\u4e24\u4e2a\u5730\u5740\u5728 libc \u7684\u521d\u59cb\u5316\u51fd\u6570\u4e2d\u88ab\u4f7f\u7528\uff0c\u901a\u8fc7\u904d\u5386\u8fd9\u4e24\u4e2a\u6807\u53f7\u5730\u5740\u4e2d\u7684\u51fd\u6570\u5730\u5740\u5e76\u6267\u884c\u5c31\u5b8c\u6210\u4e86\u4efb\u52a1\u3002"),(0,i.kt)("p",null,"\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"}," 86   const size_t size = __init_array_end - __init_array_start;\n 87   for (size_t i = 0; i < size; i++)\n 88       (*__init_array_start [i]) (argc, argv, envp);\n")),(0,i.kt)("p",null,"\u8fd9\u91cc\u4f7f\u7528 PROVIDE_HIDDEN \u65b9\u5f0f\u8bbe\u5b9a\u4e00\u4e2a\u6807\u53f7\u6709\u4e24\u4e2a\u610f\u4e49\uff1a"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"\u7528\u6237\u7a0b\u5e8f\u4e0d\u80fd\u83b7\u53d6\u6807\u53f7\u7684\u5730\u5740\uff08\u6240\u8c13\u7684\u9690\u85cf\uff09"),(0,i.kt)("li",{parentName:"ol"},"\u7528\u6237\u7a0b\u5e8f\u53ef\u4ee5\u91cd\u65b0\u5b9a\u4e49\u8fd9\u4e9b\u6807\u53f7")),(0,i.kt)("p",null,"\u6ce8\u610f\u8fd9\u91cc\u7684\u7b2c\u4e8c\u70b9\u5185\u5bb9\u3002\u7531\u4e8e\u7528\u6237\u7a0b\u5e8f\u80fd\u591f\u91cd\u65b0\u5b9a\u4e49\u8fd9\u4e9b\u6807\u53f7\uff0c\u800c\u8fd9\u4e9b\u6807\u53f7\u53c8\u5728 main \u51fd\u6570\u6267\u884c\u524d\u88ab\u4f7f\u7528\uff0c\u90a3\u4e00\u65e6\u7528\u6237\u7a0b\u5e8f\u91cd\u65b0\u5b9a\u4e49\uff0c\u5728 glibc \u4e2d\u5f15\u7528\u7684\u8fd9\u4e9b\u6807\u53f7\u5c06",(0,i.kt)("strong",{parentName:"p"},"\u4f7f\u7528\u7528\u6237\u7a0b\u5e8f\u4e2d\u5b9a\u4e49"),"\u7684\u503c\uff0c\u8fd9\u4f1a\u5e26\u6765",(0,i.kt)("strong",{parentName:"p"},"\u4e25\u91cd\u7684\u95ee\u9898"),"\u3002"),(0,i.kt)("p",null,"\u6211\u7528\u4e0b\u9762\u8fd9\u4e2a\u975e\u5e38\u7b80\u5355\u7684 hello world \u7a0b\u5e8f\u6765\u8bf4\u660e\u8fd9\u4e2a\u95ee\u9898\uff0c\u7a0b\u5e8f\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},'#include <stdio.h>\n\nvoid __init_array_start(void)\n{\n    return;\n}\n\nint main(void)\n{\n    printf("hello world\\n");\n\n    return 0;\n}\n')),(0,i.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\u7a0b\u5e8f\u4e2d\u5b9a\u4e49\u4e86 ",(0,i.kt)("strong",{parentName:"p"},"__init_array_start")," \u51fd\u6570\uff0c\u8fd9\u4e2a\u51fd\u6570\u5c06\u4f1a\u8986\u76d6\u94fe\u63a5\u811a\u672c\u4e2d\u7684\u5b9a\u4e49\u3002\u7f16\u8bd1\u5e76\u4f7f\u7528 gdb \u6267\u884c\u6b64\u7a0b\u5e8f\u4f1a\u89e6\u53d1\u6bb5\u9519\u8bef\uff0c\u6253\u51fa\u7684\u5806\u6808\u4fe1\u606f\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-gdb"},"#0  0x00005555555551a1 in __libc_csu_init ()\n#1  0x00007ffff7e0e02a in __libc_start_main (main=0x55555555513c <main>, argc=1, argv=0x7fffffffdab8, init=0x555555555160 <__libc_csu_init>, fini=<optimized out>, \n    rtld_fini=<optimized out>, stack_end=0x7fffffffdaa8) at ../csu/libc-start.c:264\n#2  0x000055555555507a in _start ()\n")),(0,i.kt)("p",null,"\u8fd9\u91cc ",(0,i.kt)("strong",{parentName:"p"},"libc_csu_init \u4e2d\u5c31\u8c03\u7528\u4e86\u4e0a\u9762\u904d\u5386 "),"init_array_start \u5230 ",(0,i.kt)("strong",{parentName:"p"},"init_array_end \u4e4b\u95f4\u7684\u5730\u5740\u6267\u884c\u521d\u59cb\u5316\u51fd\u6570\u7684\u903b\u8f91\uff0c\u8fd9\u65f6\u5b83\u5c06 "),"init_array_start \u51fd\u6570\u4e2d\u7684\u6307\u4ee4\u4f5c\u4e3a\u51fd\u6570\u6765\u6267\u884c\uff0c\u4e00\u5b9a\u4f1a\u51fa\u95ee\u9898\u6b27\u3002"))}g.isMDXComponent=!0}}]);