"use strict";(self.webpackChunklongyu_website=self.webpackChunklongyu_website||[]).push([[6716],{3905:function(e,t,r){r.d(t,{Zo:function(){return d},kt:function(){return u}});var n=r(7294);function l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function p(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function _(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?p(Object(r),!0).forEach((function(t){l(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):p(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function a(e,t){if(null==e)return{};var r,n,l=function(e,t){if(null==e)return{};var r,n,l={},p=Object.keys(e);for(n=0;n<p.length;n++)r=p[n],t.indexOf(r)>=0||(l[r]=e[r]);return l}(e,t);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);for(n=0;n<p.length;n++)r=p[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(l[r]=e[r])}return l}var o=n.createContext({}),i=function(e){var t=n.useContext(o),r=t;return e&&(r="function"==typeof e?e(t):_(_({},t),e)),r},d=function(e){var t=i(e.components);return n.createElement(o.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},f=n.forwardRef((function(e,t){var r=e.components,l=e.mdxType,p=e.originalType,o=e.parentName,d=a(e,["components","mdxType","originalType","parentName"]),f=i(r),u=l,m=f["".concat(o,".").concat(u)]||f[u]||c[u]||p;return r?n.createElement(m,_(_({ref:t},d),{},{components:r})):n.createElement(m,_({ref:t},d))}));function u(e,t){var r=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var p=r.length,_=new Array(p);_[0]=f;var a={};for(var o in t)hasOwnProperty.call(t,o)&&(a[o]=t[o]);a.originalType=e,a.mdxType="string"==typeof e?e:l,_[1]=a;for(var i=2;i<p;i++)_[i]=r[i];return n.createElement.apply(null,_)}return n.createElement.apply(null,r)}f.displayName="MDXCreateElement"},3618:function(e,t,r){r.r(t),r.d(t,{assets:function(){return d},contentTitle:function(){return o},default:function(){return u},frontMatter:function(){return a},metadata:function(){return i},toc:function(){return c}});var n=r(7462),l=r(3366),p=(r(7294),r(3905)),_=["components"],a={},o="dpdk ebpf \u5e93\u8de8\u7248\u672c\u79fb\u690d",i={permalink:"/longyu.github.io/blog/dpdk/dpdk ebpf \u5e93\u8de8\u7248\u672c\u79fb\u690d",editUrl:"https://github.com/longyuwlz/longyu.github.io/blog/dpdk/dpdk ebpf \u5e93\u8de8\u7248\u672c\u79fb\u690d.md",source:"@site/blog/dpdk/dpdk ebpf \u5e93\u8de8\u7248\u672c\u79fb\u690d.md",title:"dpdk ebpf \u5e93\u8de8\u7248\u672c\u79fb\u690d",description:"\u76ee\u6807",date:"2022-06-21T00:32:49.000Z",formattedDate:"2022\u5e746\u670821\u65e5",tags:[],readingTime:2.97,truncated:!1,authors:[],frontMatter:{},prevItem:{title:"dpdk/Unsupported SFP+ Module",permalink:"/longyu.github.io/blog/dpdk/Unsupported SFP+ Module"},nextItem:{title:"dpdk/dpdk mempool cache \u673a\u5236\u5206\u6790",permalink:"/longyu.github.io/blog/dpdk/dpdk mempool cache \u673a\u5236\u5206\u6790"}},d={authorsImageUrls:[]},c=[{value:"\u76ee\u6807",id:"\u76ee\u6807",level:2},{value:"\u79fb\u690d\u524d\u8bc4\u4f30\u5de5\u4f5c",id:"\u79fb\u690d\u524d\u8bc4\u4f30\u5de5\u4f5c",level:2},{value:"\u79fb\u690d\u7684\u6ce8\u610f\u4e8b\u9879",id:"\u79fb\u690d\u7684\u6ce8\u610f\u4e8b\u9879",level:2},{value:"1. librte_bpf Makefile \u6587\u4ef6\u4e2d\u8bbe\u7f6e DEPDIRS \u53d8\u91cf\uff0c\u5c06\u4f9d\u8d56\u7684\u9879\u76ee\u5217\u4e3e\u51fa\u6765",id:"1-librte_bpf-makefile-\u6587\u4ef6\u4e2d\u8bbe\u7f6e-depdirs-\u53d8\u91cf\u5c06\u4f9d\u8d56\u7684\u9879\u76ee\u5217\u4e3e\u51fa\u6765",level:3},{value:"2. dpdk-16.04 \u4e0d\u652f\u6301 rte_log_register \u51fd\u6570",id:"2-dpdk-1604-\u4e0d\u652f\u6301-rte_log_register-\u51fd\u6570",level:3},{value:"3. dpdk-16.04 \u4e2d\u7528\u4e8e\u6807\u8bc6\u7f51\u5361 id \u7684 port_id \u4e3a uint8_t \u7c7b\u578b\uff0c\u9ad8\u7248\u672c\u4e3a uint16_t \u7c7b\u578b",id:"3-dpdk-1604-\u4e2d\u7528\u4e8e\u6807\u8bc6\u7f51\u5361-id-\u7684-port_id-\u4e3a-uint8_t-\u7c7b\u578b\u9ad8\u7248\u672c\u4e3a-uint16_t-\u7c7b\u578b",level:3},{value:"4. <strong>rte_experimental \u4e0e </strong>rte_always_inline \u8fd9\u4e24\u4e2a\u5b8f\u5728 dpdk-16.04 \u4e2d\u7f3a\u5c11",id:"4-rte_experimental-\u4e0e-rte_always_inline-\u8fd9\u4e24\u4e2a\u5b8f\u5728-dpdk-1604-\u4e2d\u7f3a\u5c11",level:3},{value:"5. mk/rte.app.mk \u4e2d\u6dfb\u52a0 rte_bpf \u7684\u94fe\u63a5\u9879\u76ee\u4e0e -lelf \u7684\u6761\u4ef6\u63a7\u5236\u94fe\u63a5\u9879\u76ee",id:"5-mkrteappmk-\u4e2d\u6dfb\u52a0-rte_bpf-\u7684\u94fe\u63a5\u9879\u76ee\u4e0e--lelf-\u7684\u6761\u4ef6\u63a7\u5236\u94fe\u63a5\u9879\u76ee",level:3},{value:"6. \u4fee\u6539 config \u76ee\u5f55\u4e2d\u7684\u9ed8\u8ba4 dpdk \u7f16\u8bd1\u914d\u7f6e\u6587\u4ef6\uff0c\u589e\u52a0 CONFIG_RTE_LIBRTE_BPF \u4e0e CONFIG_RTE_LIBRTE_BPF_ELF \u7684\u914d\u7f6e\u9879\u76ee\uff0c\u5e76\u66f4\u65b0 RTE_TARGET \u76ee\u5f55\u4e2d\u7684 .config \u6587\u4ef6",id:"6-\u4fee\u6539-config-\u76ee\u5f55\u4e2d\u7684\u9ed8\u8ba4-dpdk-\u7f16\u8bd1\u914d\u7f6e\u6587\u4ef6\u589e\u52a0-config_rte_librte_bpf-\u4e0e-config_rte_librte_bpf_elf-\u7684\u914d\u7f6e\u9879\u76ee\u5e76\u66f4\u65b0-rte_target-\u76ee\u5f55\u4e2d\u7684-config-\u6587\u4ef6",level:3},{value:"7. \u79fb\u690d bpf_cmd.c \u4e0e bpf_cmd.h \u5230 testpmd \u4e2d\u65f6\uff0c\u9700\u8981\u6839\u636e\u8c03\u6574 bpf_cmd.c \u6587\u4ef6\u5305\u542b\u7684\u5934\u6587\u4ef6",id:"7-\u79fb\u690d-bpf_cmdc-\u4e0e-bpf_cmdh-\u5230-testpmd-\u4e2d\u65f6\u9700\u8981\u6839\u636e\u8c03\u6574-bpf_cmdc-\u6587\u4ef6\u5305\u542b\u7684\u5934\u6587\u4ef6",level:2},{value:"8. bpf arm64 jit \u4ee3\u7801\u7ffb\u8bd1\u76f8\u5173\u6e90\u7801\u9700\u8981\u4f9d\u8d56\u4e24\u4e2a\u9ad8\u7248\u672c\u7684\u5b8f\uff0c\u5728 rte_common.h \u4e2d\u6dfb\u52a0 rte_fls_u64 \u4e0e RTE_ALIGN_MUL_CEIL \u5b8f\u5b9a\u4e49\u5373\u53ef",id:"8-bpf-arm64-jit-\u4ee3\u7801\u7ffb\u8bd1\u76f8\u5173\u6e90\u7801\u9700\u8981\u4f9d\u8d56\u4e24\u4e2a\u9ad8\u7248\u672c\u7684\u5b8f\u5728-rte_commonh-\u4e2d\u6dfb\u52a0-rte_fls_u64-\u4e0e-rte_align_mul_ceil-\u5b8f\u5b9a\u4e49\u5373\u53ef",level:3},{value:"\u79fb\u690d\u540e\u6d4b\u8bd5",id:"\u79fb\u690d\u540e\u6d4b\u8bd5",level:2}],f={toc:c};function u(e){var t=e.components,r=(0,l.Z)(e,_);return(0,p.kt)("wrapper",(0,n.Z)({},f,r,{components:t,mdxType:"MDXLayout"}),(0,p.kt)("h2",{id:"\u76ee\u6807"},"\u76ee\u6807"),(0,p.kt)("p",null,"dpdk-19.11 ebpf \u5e93\u79fb\u690d\u5230 dpdk-16.04 \u4e2d\u5e76\u9002\u914d testpmd \u6765\u6d4b\u8bd5\u3002"),(0,p.kt)("h2",{id:"\u79fb\u690d\u524d\u8bc4\u4f30\u5de5\u4f5c"},"\u79fb\u690d\u524d\u8bc4\u4f30\u5de5\u4f5c"),(0,p.kt)("p",null,"\u8bc4\u4f30\u65b9\u6cd5\uff1a"),(0,p.kt)("ol",null,(0,p.kt)("li",{parentName:"ol"},"\u4f7f\u7528 dpdk-19.11 \u7f16\u8bd1\u751f\u6210 librte_bpf.a"),(0,p.kt)("li",{parentName:"ol"},"nm \u67e5\u770b .a \u4e2d\u7684\u7b26\u53f7"),(0,p.kt)("li",{parentName:"ol"},"\u8fc7\u6ee4\u51fa U \u7c7b\u578b\u7684\u7b26\u53f7\u5e76\u6392\u9664\u5185\u90e8\u7b26\u53f7")),(0,p.kt)("p",null,"\u8bc4\u4f30\u7684\u60c5\u51b5\uff1a"),(0,p.kt)("p",null,(0,p.kt)("a",{parentName:"p",href:"http://libelf.so/"},"libelf.so")," \u63d0\u4f9b\u7684\u7b26\u53f7\uff1a"),(0,p.kt)("pre",null,(0,p.kt)("code",{parentName:"pre",className:"language-c"},"elf64_getehdr\nelf64_getshdr\nelf_begin\nelf_end\nelf_errmsg\nelf_errno\nelf_getdata\nelf_getscn\nelf_ndxscn\nelf_nextscn\nelf_strptr\nelf_version\n")),(0,p.kt)("p",null,"dpdk \u9700\u8981\u652f\u6301\u7684\u63a5\u53e3\uff1a"),(0,p.kt)("pre",null,(0,p.kt)("code",{parentName:"pre",className:"language-c"},"rte_eth_add_rx_callback\nrte_eth_add_tx_callback\nrte_eth_dev_is_valid_port\nrte_eth_remove_rx_callback\nrte_eth_remove_tx_callback\nrte_log\nrte_log_register\nrte_log_set_level\nrte_mempool_ops_table\n")),(0,p.kt)("p",null,"dpdk-16.04 \u5df2\u7ecf\u5177\u5907\u7684\u7b26\u53f7\uff1a"),(0,p.kt)("pre",null,(0,p.kt)("code",{parentName:"pre",className:"language-c"},"rte_eth_add_rx_callback\nrte_eth_add_tx_callback\nrte_eth_dev_is_valid_port\nrte_eth_remove_rx_callback\nrte_eth_remove_tx_callback\nrte_log\n")),(0,p.kt)("p",null,"\u7ecf\u8fc7\u786e\u8ba4\u9700\u8981\u9002\u914d\u7684\u7b26\u53f7\u5982\u4e0b\uff1a"),(0,p.kt)("pre",null,(0,p.kt)("code",{parentName:"pre",className:"language-c"},"rte_log_register\nrte_mempool_ops_table\nrte_log_set_level\n")),(0,p.kt)("p",null,"\u6839\u636e\u4e0a\u8ff0\u4fe1\u606f\uff0c\u8bc4\u4f30\u9002\u914d\u7684\u5de5\u4f5c\u91cf\u5f88\u5c11\uff0c\u98ce\u9669\u53ef\u63a7\u3002"),(0,p.kt)("h2",{id:"\u79fb\u690d\u7684\u6ce8\u610f\u4e8b\u9879"},"\u79fb\u690d\u7684\u6ce8\u610f\u4e8b\u9879"),(0,p.kt)("h3",{id:"1-librte_bpf-makefile-\u6587\u4ef6\u4e2d\u8bbe\u7f6e-depdirs-\u53d8\u91cf\u5c06\u4f9d\u8d56\u7684\u9879\u76ee\u5217\u4e3e\u51fa\u6765"},"1. librte_bpf Makefile \u6587\u4ef6\u4e2d\u8bbe\u7f6e DEPDIRS \u53d8\u91cf\uff0c\u5c06\u4f9d\u8d56\u7684\u9879\u76ee\u5217\u4e3e\u51fa\u6765"),(0,p.kt)("p",null,"   \u4f9d\u8d56 lib/librte_net lib/librte_eal lib/librte_mbuf  lib/librte_ether \u8fd9\u51e0\u4e2a\u9879\u76ee"),(0,p.kt)("h3",{id:"2-dpdk-1604-\u4e0d\u652f\u6301-rte_log_register-\u51fd\u6570"},"2. dpdk-16.04 \u4e0d\u652f\u6301 rte_log_register \u51fd\u6570"),(0,p.kt)("p",null," dpdk \u9ad8\u7248\u672c\u4f7f\u7528 rte_log_register \u6765\u6ce8\u518c\u4e00\u79cd\u7c7b\u578b\u7684 log \u4e8b\u4ef6\uff0cdpdk-16.04 \u7684 log \u7cfb\u7edf\u6bd4\u8f83\u843d\u540e\uff0c\u8fd9\u90e8\u5206\u903b\u8f91\u9700\u8981\u53bb\u6389\uff0c\u540c\u65f6 RTE_BPF_LOG \u5b8f\u5b9a\u4e49\u4e5f\u9700\u8981\u4fee\u6539\u3002"),(0,p.kt)("p",null," \u53ef\u4ee5\u5728 ",(0,p.kt)("strong",{parentName:"p"},"rte_log.h")," \u4e2d\u6dfb\u52a0\u4e00\u4e2a ",(0,p.kt)("strong",{parentName:"p"},"RTE_LOGTYPE_BPF")," \u7684\u5b8f\u5b9a\u4e49\u5e76\u4fee\u6539 ",(0,p.kt)("strong",{parentName:"p"},"RTE_BPF_LOG")," \u7684\u5b9e\u73b0\u3002"),(0,p.kt)("h3",{id:"3-dpdk-1604-\u4e2d\u7528\u4e8e\u6807\u8bc6\u7f51\u5361-id-\u7684-port_id-\u4e3a-uint8_t-\u7c7b\u578b\u9ad8\u7248\u672c\u4e3a-uint16_t-\u7c7b\u578b"},"3. dpdk-16.04 \u4e2d\u7528\u4e8e\u6807\u8bc6\u7f51\u5361 id \u7684 port_id \u4e3a uint8_t \u7c7b\u578b\uff0c\u9ad8\u7248\u672c\u4e3a uint16_t \u7c7b\u578b"),(0,p.kt)("p",null," \u53ef\u4ee5\u5199\u4e00\u884c sed \u547d\u4ee4\u4e00\u952e\u66ff\u6362"),(0,p.kt)("h3",{id:"4-rte_experimental-\u4e0e-rte_always_inline-\u8fd9\u4e24\u4e2a\u5b8f\u5728-dpdk-1604-\u4e2d\u7f3a\u5c11"},"4. ",(0,p.kt)("strong",{parentName:"h3"},"rte_experimental \u4e0e "),"rte_always_inline \u8fd9\u4e24\u4e2a\u5b8f\u5728 dpdk-16.04 \u4e2d\u7f3a\u5c11"),(0,p.kt)("p",null,(0,p.kt)("strong",{parentName:"p"},"rte_always_inline \u7684\u5b9a\u4e49\u53ef\u4ee5\u4ece\u9ad8\u7248\u672c ",(0,p.kt)("strong",{parentName:"strong"},"copy")," \u8fc7\u6765\uff0c"),"rte_experimental  \u4e5f\u53ef\u4ee5\u4ece\u9ad8\u7248\u672c copy \u8fc7\u6765\uff0c\u6700\u597d\u662f\u52a0\u6761\u4ef6\u7f16\u8bd1\u63a7\u5236\u5b9a\u4e49\u4e3a\u7a7a"),(0,p.kt)("h3",{id:"5-mkrteappmk-\u4e2d\u6dfb\u52a0-rte_bpf-\u7684\u94fe\u63a5\u9879\u76ee\u4e0e--lelf-\u7684\u6761\u4ef6\u63a7\u5236\u94fe\u63a5\u9879\u76ee"},"5. mk/rte.app.mk \u4e2d\u6dfb\u52a0 rte_bpf \u7684\u94fe\u63a5\u9879\u76ee\u4e0e -lelf \u7684\u6761\u4ef6\u63a7\u5236\u94fe\u63a5\u9879\u76ee"),(0,p.kt)("p",null,"   \u793a\u4f8b\u5982\u4e0b\uff1a"),(0,p.kt)("pre",null,(0,p.kt)("code",{parentName:"pre",className:"language-c"},"  +_LDLIBS-$(CONFIG_RTE_LIBRTE_BPF)            += -lrte_bpf\n  \n  +ifeq ($(CONFIG_RTE_LIBRTE_BPF_ELF),y)\n  +_LDLIBS-$(CONFIG_RTE_LIBRTE_BPF)            += -lelf\n  +endif\n")),(0,p.kt)("h3",{id:"6-\u4fee\u6539-config-\u76ee\u5f55\u4e2d\u7684\u9ed8\u8ba4-dpdk-\u7f16\u8bd1\u914d\u7f6e\u6587\u4ef6\u589e\u52a0-config_rte_librte_bpf-\u4e0e-config_rte_librte_bpf_elf-\u7684\u914d\u7f6e\u9879\u76ee\u5e76\u66f4\u65b0-rte_target-\u76ee\u5f55\u4e2d\u7684-config-\u6587\u4ef6"},"6. \u4fee\u6539 config \u76ee\u5f55\u4e2d\u7684\u9ed8\u8ba4 dpdk \u7f16\u8bd1\u914d\u7f6e\u6587\u4ef6\uff0c\u589e\u52a0 CONFIG_RTE_LIBRTE_BPF \u4e0e CONFIG_RTE_LIBRTE_BPF_ELF \u7684\u914d\u7f6e\u9879\u76ee\uff0c\u5e76\u66f4\u65b0 RTE_TARGET \u76ee\u5f55\u4e2d\u7684 .config \u6587\u4ef6"),(0,p.kt)("h2",{id:"7-\u79fb\u690d-bpf_cmdc-\u4e0e-bpf_cmdh-\u5230-testpmd-\u4e2d\u65f6\u9700\u8981\u6839\u636e\u8c03\u6574-bpf_cmdc-\u6587\u4ef6\u5305\u542b\u7684\u5934\u6587\u4ef6"},"7. \u79fb\u690d bpf_cmd.c \u4e0e bpf_cmd.h \u5230 testpmd \u4e2d\u65f6\uff0c\u9700\u8981\u6839\u636e\u8c03\u6574 bpf_cmd.c \u6587\u4ef6\u5305\u542b\u7684\u5934\u6587\u4ef6"),(0,p.kt)("h3",{id:"8-bpf-arm64-jit-\u4ee3\u7801\u7ffb\u8bd1\u76f8\u5173\u6e90\u7801\u9700\u8981\u4f9d\u8d56\u4e24\u4e2a\u9ad8\u7248\u672c\u7684\u5b8f\u5728-rte_commonh-\u4e2d\u6dfb\u52a0-rte_fls_u64-\u4e0e-rte_align_mul_ceil-\u5b8f\u5b9a\u4e49\u5373\u53ef"},"8. bpf arm64 jit \u4ee3\u7801\u7ffb\u8bd1\u76f8\u5173\u6e90\u7801\u9700\u8981\u4f9d\u8d56\u4e24\u4e2a\u9ad8\u7248\u672c\u7684\u5b8f\uff0c\u5728 rte_common.h \u4e2d\u6dfb\u52a0 rte_fls_u64 \u4e0e RTE_ALIGN_MUL_CEIL \u5b8f\u5b9a\u4e49\u5373\u53ef"),(0,p.kt)("h2",{id:"\u79fb\u690d\u540e\u6d4b\u8bd5"},"\u79fb\u690d\u540e\u6d4b\u8bd5"),(0,p.kt)("p",null,"\u5728\u865a\u62df\u673a\u4e2d\u4f7f\u7528 testpmd \u6d4b\u8bd5\u79fb\u690d\u7684 bpf \u5e93\u3002"),(0,p.kt)("p",null,"bpf-load \u52a0\u8f7d\uff1a"),(0,p.kt)("pre",null,(0,p.kt)("code",{parentName:"pre",className:"language-c"},'testpmd> bpf-load  rx 0 0 J ./dummy.o\nvalidate(0x7ffd0c107740) stats:\nnb_nodes=2;\nnb_jcc_nodes=0;\nnode_color={[WHITE]=0, [GREY]=0,, [BLACK]=2};\nedge_type={[UNKNOWN]=0, [TREE]=1, [BACK]=0, [CROSS]=0};\nrte_bpf_elf_load(fname="./dummy.o", sname=".text") successfully creates 0x7f141b176000(jit={.func=0x7f141b14c000,.sz=8});\n0:Success\n')),(0,p.kt)("p",null,"dummy.o bpf \u6307\u4ee4\u7801\u6210\u529f\u52a0\u8f7d\u3002"),(0,p.kt)("p",null,"perf \u89c2\u6d4b\u51fd\u6570\u8c03\u7528\uff1a"),(0,p.kt)("pre",null,(0,p.kt)("code",{parentName:"pre",className:"language-c"},"  52.96%  testpmd   [.] bpf_rx_callback_jit\n  30.99%  testpmd   [.] pkt_burst_io_forward\n  15.02%  testpmd   [.] eth_em_recv_pkts\n   0.95%  testpmd   [.] start_pkt_forward_on_core\n")),(0,p.kt)("p",null,"bpf_rx_callback_jit \u51fd\u6570\u6b63\u5e38\u8c03\u7528\uff0c\u79fb\u690d\u6210\u529f\u3002"))}u.isMDXComponent=!0}}]);