"use strict";(self.webpackChunklongyu_website=self.webpackChunklongyu_website||[]).push([[8476],{3905:function(n,e,t){t.d(e,{Zo:function(){return u},kt:function(){return f}});var r=t(7294);function o(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function i(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function l(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?i(Object(t),!0).forEach((function(e){o(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function a(n,e){if(null==n)return{};var t,r,o=function(n,e){if(null==n)return{};var t,r,o={},i=Object.keys(n);for(r=0;r<i.length;r++)t=i[r],e.indexOf(t)>=0||(o[t]=n[t]);return o}(n,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);for(r=0;r<i.length;r++)t=i[r],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(o[t]=n[t])}return o}var s=r.createContext({}),p=function(n){var e=r.useContext(s),t=e;return n&&(t="function"==typeof n?n(e):l(l({},e),n)),t},u=function(n){var e=p(n.components);return r.createElement(s.Provider,{value:e},n.children)},d={inlineCode:"code",wrapper:function(n){var e=n.children;return r.createElement(r.Fragment,{},e)}},c=r.forwardRef((function(n,e){var t=n.components,o=n.mdxType,i=n.originalType,s=n.parentName,u=a(n,["components","mdxType","originalType","parentName"]),c=p(t),f=o,b=c["".concat(s,".").concat(f)]||c[f]||d[f]||i;return t?r.createElement(b,l(l({ref:e},u),{},{components:t})):r.createElement(b,l({ref:e},u))}));function f(n,e){var t=arguments,o=e&&e.mdxType;if("string"==typeof n||o){var i=t.length,l=new Array(i);l[0]=c;var a={};for(var s in e)hasOwnProperty.call(e,s)&&(a[s]=e[s]);a.originalType=n,a.mdxType="string"==typeof n?n:o,l[1]=a;for(var p=2;p<i;p++)l[p]=t[p];return r.createElement.apply(null,l)}return r.createElement.apply(null,t)}c.displayName="MDXCreateElement"},799:function(n,e,t){t.r(e),t.d(e,{assets:function(){return u},contentTitle:function(){return s},default:function(){return f},frontMatter:function(){return a},metadata:function(){return p},toc:function(){return d}});var r=t(7462),o=t(3366),i=(t(7294),t(3905)),l=["components"],a={},s="tun \u4e0e tap \u8bbe\u5907\uff0c\u7f51\u6865\u3001VLAN\u3001bonding \u7684\u5b66\u4e60",p={unversionedId:"\u6280\u672f\u535a\u5ba2/linux-system/network/\u57fa\u7840\u77e5\u8bc6/tun \u4e0e tap \u8bbe\u5907\uff0c\u7f51\u6865\u3001VLAN\u3001bonding \u7684\u5b66\u4e60",id:"\u6280\u672f\u535a\u5ba2/linux-system/network/\u57fa\u7840\u77e5\u8bc6/tun \u4e0e tap \u8bbe\u5907\uff0c\u7f51\u6865\u3001VLAN\u3001bonding \u7684\u5b66\u4e60",title:"tun \u4e0e tap \u8bbe\u5907\uff0c\u7f51\u6865\u3001VLAN\u3001bonding \u7684\u5b66\u4e60",description:"tun \u4e0e tap \u8bbe\u5907",source:"@site/docs/\u6280\u672f\u535a\u5ba2/linux-system/network/\u57fa\u7840\u77e5\u8bc6/tun \u4e0e tap \u8bbe\u5907\uff0c\u7f51\u6865\u3001VLAN\u3001bonding \u7684\u5b66\u4e60.md",sourceDirName:"\u6280\u672f\u535a\u5ba2/linux-system/network/\u57fa\u7840\u77e5\u8bc6",slug:"/\u6280\u672f\u535a\u5ba2/linux-system/network/\u57fa\u7840\u77e5\u8bc6/tun \u4e0e tap \u8bbe\u5907\uff0c\u7f51\u6865\u3001VLAN\u3001bonding \u7684\u5b66\u4e60",permalink:"/longyu.github.io/\u6280\u672f\u535a\u5ba2/linux-system/network/\u57fa\u7840\u77e5\u8bc6/tun \u4e0e tap \u8bbe\u5907\uff0c\u7f51\u6865\u3001VLAN\u3001bonding \u7684\u5b66\u4e60",draft:!1,editUrl:"https://github.com/longyuwlz/longyu.github.io/docs/\u6280\u672f\u535a\u5ba2/linux-system/network/\u57fa\u7840\u77e5\u8bc6/tun \u4e0e tap \u8bbe\u5907\uff0c\u7f51\u6865\u3001VLAN\u3001bonding \u7684\u5b66\u4e60.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"\u9650\u5236\u5185\u6838 udp bad checksum \u5931\u8d25\u544a\u8b66\u4fe1\u606f",permalink:"/longyu.github.io/\u6280\u672f\u535a\u5ba2/linux-system/network/\u5185\u6838\u914d\u7f6e/\u9650\u5236\u5185\u6838 udp bad checksum \u5931\u8d25\u544a\u8b66\u4fe1\u606f"},next:{title:"\u7f51\u5361 promiscuous mode \u4e0e MAC \u7684\u4e00\u4e9b filter \u529f\u80fd",permalink:"/longyu.github.io/\u6280\u672f\u535a\u5ba2/linux-system/network/\u57fa\u7840\u77e5\u8bc6/\u7f51\u5361 promiscuous mode \u4e0e MAC \u7684\u4e00\u4e9b filter \u529f\u80fd"}},u={},d=[{value:"tun \u4e0e tap \u8bbe\u5907",id:"tun-\u4e0e-tap-\u8bbe\u5907",level:2},{value:"\u7f51\u6865",id:"\u7f51\u6865",level:2},{value:"VLAN",id:"vlan",level:2},{value:"bonding \u9a71\u52a8\u7a0b\u5e8f",id:"bonding-\u9a71\u52a8\u7a0b\u5e8f",level:2}],c={toc:d};function f(n){var e=n.components,t=(0,o.Z)(n,l);return(0,i.kt)("wrapper",(0,r.Z)({},c,t,{components:e,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"tun-\u4e0e-tap-\u8bbe\u5907\u7f51\u6865vlanbonding-\u7684\u5b66\u4e60"},"tun \u4e0e tap \u8bbe\u5907\uff0c\u7f51\u6865\u3001VLAN\u3001bonding \u7684\u5b66\u4e60"),(0,i.kt)("h2",{id:"tun-\u4e0e-tap-\u8bbe\u5907"},"tun \u4e0e tap \u8bbe\u5907"),(0,i.kt)("p",null,"\u8fd9\u4e24\u4e2a\u90fd\u662f\u865a\u62df\u7f51\u7edc\u8bbe\u5907\uff0ctun \u8bbe\u5907\u7528\u6765\u5b9e\u73b0\u4e09\u5c42\u96a7\u9053\uff08\u4e09\u5c42 ip \u6570\u636e\u62a5\uff09\uff0ctap \u8bbe\u5907\u7528\u6765\u5b9e\u73b0\u4e8c\u5c42\u96a7\u9053\uff08\u4e8c\u5c42\u4ee5\u592a\u7f51\u6570\u636e\u5e27\uff09\u3002"),(0,i.kt)("p",null,"tun \u793a\u4f8b\u7a0b\u5e8f\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'#include <fcntl.h>\n#include <sys/ioctl.h>\n#include <sys/socket.h>\n#include <linux/if.h>\n#include <linux/if_tun.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n\nint tun_open(void)\n{\n    struct ifreq ifr;\n    int fd;\n    char dev[IFNAMSIZ];\n    char buf[512];\n\n    fd = open("/dev/net/tun", O_RDWR);\n\n    memset(&ifr, 0, sizeof(ifr));\n    ifr.ifr_flags = IFF_TUN | IFF_NO_PI;\n    strncpy(ifr.ifr_name, "tun%d", IFNAMSIZ);\n    ioctl(fd, TUNSETIFF, &ifr);\n\n    strncpy(dev, ifr.ifr_name, IFNAMSIZ);\n    sprintf(buf, "ifconfig %s 192.168.1.1 pointopoint 192.168.1.2", dev);\n    system(buf);\n    \n    return fd;\n}\n\nvoid dump_pkt(unsigned char *pkt, int len)\n{\n    int i;\n\n    for (i = 0; i < len; i++) \n        printf("%02x ", pkt[i]);\n\n    printf("\\n");\n}\n\nvoid pingpong(int fd)\n{\n    fd_set fds;\n    int len;\n    unsigned char pkt[512];\n\n    FD_ZERO(&fds);\n    FD_SET(fd, &fds);\n\n    select(fd + 1, &fds, NULL, NULL, NULL);\n\n    if (FD_ISSET(fd, &fds)) {\n        len = read(fd, pkt, 512);\n        dump_pkt(pkt, len);\n        \n        /* echo request */\n        if (pkt[20] != 0x08)\n            return;\n        \n        /* \u4fee\u6539 ip \u5934\u7684 src */\n        pkt[15] = 0x02;\n        pkt[19] = 0x01;\n        pkt[20] = 0x00;\n        write(fd, pkt, len);\n    }\n}\n\nint main(int argc, char *argv[])\n{\n    int fd;\n\n    fd = tun_open();\n\n    for (;;) \n        pingpong(fd);\n\n    return 0;\n}\n')),(0,i.kt)("p",null,"\u7b2c\u4e00\u6b65\u9700\u8981\u52a0\u8f7d tun.ko \u6a21\u5757\uff0c\u6267\u884c modprobe tun \u5373\u53ef\u3002\u52a0\u8f7d\u6b64\u6a21\u5757\u540e /dev/net/tun \u8bbe\u5907\u6587\u4ef6\u4f1a\u88ab\u751f\u6210\uff0c\u8fd9\u6837\u4e0a\u8ff0\u7a0b\u5e8f\u624d\u80fd\u6b63\u5e38\u5de5\u4f5c\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"longyu@virt-debian10:~$ ls -lh /dev/net/tun\ncrw-rw-rw- 1 root root 10, 200 7\u6708  28 08:23 /dev/net/tun\n")),(0,i.kt)("p",null,"\u4f7f\u7528 root \u6743\u9650\u6267\u884c\u4e0a\u8ff0\u7a0b\u5e8f\uff0c\u6267\u884c\u540e\u5728\u53e6\u5916\u4e00\u4e2a\u7ec8\u7aef\u4e2d\u6267\u884c ifconfig \u547d\u4ee4\u67e5\u770b\uff0c\u7cfb\u7edf\u4e2d\u589e\u52a0\u4e86\u4e00\u4e2a tun0 \u8fd9\u4e2a\u865a\u62df\u63a5\u53e3\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"tun0: flags=4305<UP,POINTOPOINT,RUNNING,NOARP,MULTICAST>  mtu 1500\n        inet 192.168.1.1  netmask 255.255.255.255  destination 192.168.1.2\n        inet6 fe80::f384:8174:9911:8438  prefixlen 64  scopeid 0x20<link>\n        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 500  (UNSPEC)\n        RX packets 0  bytes 0 (0.0 B)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 2  bytes 96 (96.0 B)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n")),(0,i.kt)("p",null,"\u6267\u884c ping 192.168.1.2 \u540e\u6709\u5982\u4e0b\u62a5\u8b66\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"64 bytes from 192.168.1.2: icmp_seq=122 ttl=64 time=0.105 ms (BAD CHECKSUM!)\n64 bytes from 192.168.1.2: icmp_seq=123 ttl=64 time=0.110 ms (BAD CHECKSUM!)\n64 bytes from 192.168.1.2: icmp_seq=124 ttl=64 time=0.111 ms (BAD CHECKSUM!)\n")),(0,i.kt)("p",null,"BAD CHECKSUM \u8fd9\u4e2a\u63d0\u793a\u8868\u793a\u6570\u636e\u5305\u5934\u90e8\u6821\u9a8c\u5931\u8d25\u3002\u6709\u4e86\u8fd9\u4e2a\u63d0\u793a\u518d\u6765\u5ba1\u89c6\u4e0a\u9762\u7684\u4ee3\u7801\uff0c\u6211\u53d1\u73b0\u4e0a\u9762\u7684\u4ee3\u7801\u5728\u4fee\u6539\u4e86 ip header \u4e2d\u7684 src \u4e0e dst \u5730\u5740\u540e\u5e76\u6ca1\u6709\u91cd\u65b0\u751f\u6210 chechsum \u5e76\u66f4\u65b0\u5c31\u76f4\u63a5\u53d1\u9001\u4e86\u3002\u5f53 ping \u6536\u5230\u8fd9\u4e2a\u62a5\u6587\u65f6\uff0c\u6821\u9a8c checksum \u5c31\u4f1a\u5931\u8d25\u3002"),(0,i.kt)("p",null,"\u8fd9\u91cc\u6211\u76f4\u63a5\u5c06 write \u8c03\u7528\u6ce8\u91ca\u6389\uff0c\u7136\u540e\u91cd\u65b0\u7f16\u8bd1\u5e76\u8fd0\u884c\u7a0b\u5e8f\uff0c\u8fd9\u6b21\u7ee7\u7eed ping \u4f1a\u62a5\u5730\u5740\u4e0d\u53ef\u8fbe\u7684\u8b66\u544a\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"From 192.168.1.5 icmp_seq=141 Destination Host Unreachable\n")),(0,i.kt)("p",null,"\u8fd9\u662f\u6b63\u5e38\u7684\u3002"),(0,i.kt)("p",null,"ping \u4e86\u51e0\u4e2a\u5305\u540e\uff0c\u89c2\u5bdf ifconfig \u6536\u5305\u60c5\u51b5\uff0c\u53ef\u4ee5\u770b\u5230\u6709\u7edf\u8ba1\u6570\u76ee\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"longyu@virt-debian10:~$ sudo ifconfig tun0\ntun0: flags=4305<UP,POINTOPOINT,RUNNING,NOARP,MULTICAST>  mtu 1500\n        inet 192.168.1.1  netmask 255.255.255.255  destination 192.168.1.2\n        inet6 fe80::f6fe:2e04:68c7:dfd3  prefixlen 64  scopeid 0x20<link>\n        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 500  (UNSPEC)\n        RX packets 5  bytes 420 (420.0 B)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 8  bytes 564 (564.0 B)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n")),(0,i.kt)("p",null,"\u6267\u884c ethtool \u547d\u4ee4\u8f93\u51fa\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"longyu@virt-debian10:~$ sudo ethtool tun0\nSettings for tun0:\n    Supported ports: [ ]\n    Supported link modes:   Not reported\n    Supported pause frame use: No\n    Supports auto-negotiation: No\n    Supported FEC modes: Not reported\n    Advertised link modes:  Not reported\n    Advertised pause frame use: No\n    Advertised auto-negotiation: No\n    Advertised FEC modes: Not reported\n    Speed: 10Mb/s\n    Duplex: Full\n    Port: Twisted Pair\n    PHYAD: 0\n    Transceiver: internal\n    Auto-negotiation: off\n    MDI-X: Unknown\n    Current message level: 0xffffffa1 (-95)\n                   drv ifup tx_err tx_queued intr tx_done rx_status pktdata hw wol 0xffff8000\n    Link detected: yes\n")),(0,i.kt)("p",null,"\u4e0a\u8ff0\u8f93\u51fa\u662f\u7531 tun \u7684\u5b9e\u73b0\u51b3\u5b9a\u7684\uff0c\u5728\u5176 ethtool_ops \u7684\u5b9e\u73b0\u4e2d\uff0cspeed\u3001duplex\u3001port \u7b49\u7b49\u4fe1\u606f\u90fd\u662f\u56fa\u5b9a\u7684\uff0c\u4e0d\u4f1a\u6539\u53d8\uff0c\u8fd9\u4e0e\u5e38\u89c1\u7684\u7269\u7406\u7f51\u5361\u6709\u6240\u533a\u522b\u3002"),(0,i.kt)("h2",{id:"\u7f51\u6865"},"\u7f51\u6865"),(0,i.kt)("p",null,"\u4f7f\u7528\u7f51\u6865\u53ef\u4ee5\u5c06\u591a\u4e2a\u63a5\u53e3\u8fde\u63a5\u5230\u540c\u4e00\u7f51\u6bb5\u5185\uff0c\u8fd9\u4e00\u529f\u80fd\u7b49\u540c\u4e8e\u4ea4\u6362\u5f0f\u96c6\u7ebf\u5668\u3002"),(0,i.kt)("p",null,"\u4f7f\u7528 brctl \u547d\u4ee4\u6765\u521b\u5efa\u7f51\u6865\u63a5\u53e3\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"       The command brctl addbr <name> creates a new instance of the ethernet bridge. The network interface corresponding to the bridge will be called <name>.\n\n       The  command  brctl delbr <name> deletes the instance <name> of the ethernet bridge. The network interface corresponding to the bridge must be down before it can\n       be deleted!\n\n       The command brctl show shows all current instances of the ethernet bridge.\n\nPORTS\n       Each bridge has a number of ports attached to it. Network traffic coming in on any of these ports will be forwarded to the other ports transparently, so that the\n       bridge is invisible to the rest of the network (i.e. it will not show up in traceroute(8) ).\n\n       The command brctl addif <brname> <ifname> will make the interface <ifname> a port of the bridge <brname>. This means that all frames received on <ifname> will be\n       processed as if destined for the bridge. Also, when sending frames on <brname>, <ifname> will be considered as a potential output interface.\n\n       The command brctl delif <brname> <ifname> will detach the interface <ifname> from the bridge <brname>.\n\n       The command brctl show <brname> will show some information on the bridge and its attached ports.\n")),(0,i.kt)("p",null,"\u4f7f\u7528\u6b64\u547d\u4ee4\u524d\uff0c\u9700\u8981\u52a0\u8f7d bridge.ko \u5185\u6838\u6a21\u5757\uff0c\u76f4\u63a5\u6267\u884c modprobe bridge.ko \u5373\u53ef\u3002"),(0,i.kt)("p",null,"\u5728\u6211\u7684\u865a\u62df\u673a\u4e2d\u6709\u56db\u4e2a\u7f51\u5361\u63a5\u53e3\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"longyu@virt-debian10:~$ sudo ifconfig -a\nenp1s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500\n        inet 192.168.122.29  netmask 255.255.255.0  broadcast 192.168.122.255\n        inet6 fe80::5054:ff:fe71:c999  prefixlen 64  scopeid 0x20<link>\n        ether 52:54:00:71:c9:99  txqueuelen 1000  (Ethernet)\n        RX packets 2188027  bytes 208647751 (198.9 MiB)\n        RX errors 0  dropped 3  overruns 0  frame 0\n        TX packets 5180286  bytes 856255243 (816.5 MiB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n\nenp4s0: flags=4098<BROADCAST,MULTICAST>  mtu 1500\n        ether 52:54:00:d9:bf:99  txqueuelen 1000  (Ethernet)\n        RX packets 0  bytes 0 (0.0 B)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 0  bytes 0 (0.0 B)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n        device interrupt 22  memory 0xfca40000-fca60000  \n\nenp8s0: flags=4098<BROADCAST,MULTICAST>  mtu 1500\n        ether 52:54:00:df:a9:b0  txqueuelen 1000  (Ethernet)\n        RX packets 0  bytes 0 (0.0 B)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 0  bytes 0 (0.0 B)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n        device interrupt 22  memory 0xfc240000-fc260000  \n\nenp9s0: flags=4098<BROADCAST,MULTICAST>  mtu 1500\n        ether 52:54:00:08:3f:ef  txqueuelen 1000  (Ethernet)\n        RX packets 0  bytes 0 (0.0 B)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 0  bytes 0 (0.0 B)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n        device interrupt 23  memory 0xfc040000-fc060000  \n")),(0,i.kt)("p",null,"\u521b\u5efa br0 \u5e76\u8bbe\u7f6e ip \u5730\u5740\u7b49\u4fe1\u606f\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"longyu@virt-debian10:~$ sudo brctl addbr br0\nlongyu@virt-debian10:~$ sudo ifconfig br0\nbr0: flags=4098<BROADCAST,MULTICAST>  mtu 1500\n        ether c2:7e:25:a0:16:f7  txqueuelen 1000  (Ethernet)\n        RX packets 0  bytes 0 (0.0 B)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 0  bytes 0 (0.0 B)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n\nlongyu@virt-debian10:~$ sudo ifconfig br0 10.1.0.100 netmask 255.255.255.0 broadmask 10.1.0.255 up\nlongyu@virt-debian10:~$ sudo ifconfig br0\nbr0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500\n        inet 10.1.0.255  netmask 255.0.0.0  broadcast 10.255.255.255\n        inet6 fe80::c07e:25ff:fea0:16f7  prefixlen 64  scopeid 0x20<link>\n        ether c2:7e:25:a0:16:f7  txqueuelen 1000  (Ethernet)\n        RX packets 0  bytes 0 (0.0 B)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 6  bytes 516 (516.0 B)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n")),(0,i.kt)("p",null,"\u6dfb\u52a0\u63a5\u53e3\u5230 br0 \u4e2d\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"longyu@virt-debian10:~$ sudo brctl addif br0 enp4s0\nlongyu@virt-debian10:~$ sudo brctl addif br0 enp8s0 \nlongyu@virt-debian10:~$ sudo brctl addif br0 enp9s0 \nlongyu@virt-debian10:~$ sudo brctl show\nbridge name bridge id       STP enabled interfaces\nbr0     8000.525400083fef   no      enp4s0\n                            enp8s0\n                            enp9s0\n")),(0,i.kt)("p",null,"\u5c06\u6dfb\u52a0\u5230\u7684\u63a5\u53e3\u6fc0\u6d3b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"longyu@virt-debian10:~$ sudo ifconfig enp4s0 up\nlongyu@virt-debian10:~$ sudo ifconfig enp8s0 up\nlongyu@virt-debian10:~$ sudo ifconfig enp9s0 up\n")),(0,i.kt)("p",null,"/etc/network/interfaces \u6587\u4ef6\u4e2d\u6dfb\u52a0 br0 \u914d\u7f6e\u9879\u76ee\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"auto br0\niface br0 inet dhcp \n    bridge_ports enp4s0 enp8s0 enp9s0\n    bridge_stp off\n")),(0,i.kt)("p",null,"br0 \u4e2d\u4f1a\u5b58\u50a8\u4e00\u5f20\u8f6c\u53d1\u8868\uff0c\u53ef\u4ee5\u7528 brctl showmacs \u547d\u4ee4\u6765\u67e5\u770b\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"longyu@virt-debian10:~$ sudo brctl showmacs br0\nport no mac addr        is local?   ageing timer\n  3 52:54:00:08:3f:ef   yes        0.00\n  3 52:54:00:08:3f:ef   yes        0.00\n  1 52:54:00:22:e3:e6   no         1.48\n  1 52:54:00:d9:bf:99   yes        0.00\n  1 52:54:00:d9:bf:99   yes        0.00\n  2 52:54:00:df:a9:b0   yes        0.00\n  2 52:54:00:df:a9:b0   yes        0.00\n  1 fe:54:00:d9:bf:99   no         0.62\n  2 fe:54:00:df:a9:b0   no       182.63\nlongyu@virt-debian10:~$ \n")),(0,i.kt)("p",null,"\u7f51\u7edc\u7aef\u53e3\u53ef\u80fd\u4f1a\u4e0d\u65ad\u7684\u53d8\u5316\uff0c\u5f53 bridge \u5b66\u4e60\u5230\u4e86\u4e00\u4e2a\u5730\u5740\u65f6\uff0c\u4e00\u4e2a\u5b9a\u65f6\u5668\u4e5f\u4f1a\u81ea\u52a8\u542f\u52a8\uff0c\u7ecf\u9a8c\u503c\u662f 5 \u5206\u949f\uff0c\u8fd9\u4e2a\u65f6\u95f4\u79f0\u4e3a ageing time\u3002\u5728\u4e00\u4e2a ageing time \u65f6\u95f4\u5185\u5982\u679c\u4e00\u4e2a\u5730\u5740\u5165\u53e3\u4e0d\u53ef\u89c1\uff0c\u8fd9\u4e2a\u5730\u5740\u5c06\u4ece bridge \u7684\u6570\u636e\u5e93\u4e2d\u79fb\u9664\u3002"),(0,i.kt)("p",null,"\u53ef\u4ee5\u6267\u884c brctl setageing \u547d\u4ee4\u6765\u8bbe\u5b9a ageing time."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"longyu@virt-debian10:~$ sudo brctl setageing br0 1\nlongyu@virt-debian10:~$ sudo brctl showmacs br0\nport no mac addr        is local?   ageing timer\n  3 52:54:00:08:3f:ef   yes        0.00\n  3 52:54:00:08:3f:ef   yes        0.00\n  1 52:54:00:d9:bf:99   yes        0.00\n  1 52:54:00:d9:bf:99   yes        0.00\n  2 52:54:00:df:a9:b0   yes        0.00\n  2 52:54:00:df:a9:b0   yes        0.00\n")),(0,i.kt)("h2",{id:"vlan"},"VLAN"),(0,i.kt)("p",null,"vlan \u5168\u7a0b virtual lan\uff0c\u80fd\u591f\u7528\u6765\u865a\u62df\u5206\u914d\u4ee5\u592a\u7f51\u3002\u5f52\u5c5e\u4e8e\u4e0d\u540c\u7684 VLAN ID \u7684\u8bbe\u5907\u4e4b\u95f4\u9700\u8981\u4e00\u4e2a\u8def\u7531\u624d\u80fd\u591f\u901a\u4fe1\uff0c\u8fd9\u610f\u5473\u8fd9\u4e0d\u540c\u7684 VLAN ID \u5c06\u4ee5\u592a\u7f51\u5212\u5206\u6210\u4e86\u4e0d\u540c\u7684\u5206\u7ec4\u3002"),(0,i.kt)("p",null,"\u5373\u4f7f\u5c06 LAN \u7684\u8fde\u7ebf\u8857\u9053\u76f8\u540c\u96c6\u7ebf\u5668\u6216\u4ea4\u6362\u673a\u4e0a\uff0cVLAN ID \u4e0d\u540c\u4e5f\u4e0d\u80fd\u76f8\u4e92\u901a\u4fe1\u3002"),(0,i.kt)("p",null,"vconfig \u547d\u4ee4\u751f\u6210 vlan \u63a5\u53e3\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"sudo ip link add link enp4s0 name enp4s0.100 type vlan id 100\nlongyu@virt-debian10:~$ sudo ip link add link enp8s0 name enp8s0.100 type vlan id 100\nlongyu@virt-debian10:~$ sudo ip link add link enp9s0 name enp9s0.101 type vlan id 101\n")),(0,i.kt)("p",null,"\u751f\u6210 vlan \u63a5\u53e3\u540e\u67e5\u770b proc \u6587\u4ef6\u4fe1\u606f\uff0c\u6709\u5982\u4e0b\u5185\u5bb9\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"longyu@virt-debian10:~$ ls /proc/net/vlan/\nconfig      enp4s0.100  enp8s0.100  enp9s0.101 \nlongyu@virt-debian10:~$ sudo cat /proc/net/vlan/config \nVLAN Dev name    | VLAN ID\nName-Type: VLAN_NAME_TYPE_RAW_PLUS_VID_NO_PAD\nenp4s0.100     | 100  | enp4s0\nenp8s0.100     | 100  | enp8s0\nenp9s0.101     | 101  | enp9s0\n")),(0,i.kt)("p",null,"\u5220\u9664\u63a5\u53e3\u7684 vlan \u5206\u7ec4\u53ef\u4ee5\u7ee7\u7eed\u6267\u884c ip \u547d\u4ee4\u6765\u5b8c\u6210\uff0c\u5c06 add \u6539\u4e3a delete \u5e76\u53ea\u52a0\u4e0a vlan \u63a5\u53e3\u540d\u3002"),(0,i.kt)("p",null,"\u793a\u4f8b\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"ip link delete enp4s0.100\n")),(0,i.kt)("p",null,"VLAN \u63a5\u53e3\u540d\u7684\u79cd\u7c7b\uff1a"),(0,i.kt)("p",null,"1, VLAN_PLUS_VID \u5b57\u7b26\u4e32 vlan + 0 padding+ VLAN ID\n2. VLAN_PLUS_VID_NO_PAD \u5b57\u7b26\u4e32 vlan + VLAN ID\n3. DEV_PLUS_VID \u7269\u7406\u63a5\u53e3\u540d+\u70b9+0 padding + VLAN ID\n4. DEV_PLUS_VID_NO_PAD \u7269\u7406\u63a5\u53e3\u540d+\u70b9+VLAN ID"),(0,i.kt)("p",null,"\u6211\u4eec\u4e0a\u9762\u7684 vlan \u63a5\u53e3\u540d\u5c31\u662f\u7528\u4e86\u7b2c 4 \u79cd\u547d\u540d\u65b9\u5f0f\u3002"),(0,i.kt)("h2",{id:"bonding-\u9a71\u52a8\u7a0b\u5e8f"},"bonding \u9a71\u52a8\u7a0b\u5e8f"),(0,i.kt)("p",null,"bonding \u7528\u4e8e\u805a\u5408\u591a\u4e2a\u7269\u7406\u7f51\u7edc\u7aef\u53e3\u3002"),(0,i.kt)("p",null,"bonding \u6709 7 \u79cd\u6a21\u5f0f\uff0c\u5217\u4e3e\u5982\u4e0b\uff1a"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"balance-rr"),(0,i.kt)("li",{parentName:"ol"},"active-backup"),(0,i.kt)("li",{parentName:"ol"},"balance-xor"),(0,i.kt)("li",{parentName:"ol"},"broadcast"),(0,i.kt)("li",{parentName:"ol"},"802.3ad"),(0,i.kt)("li",{parentName:"ol"},"balance-tlb"),(0,i.kt)("li",{parentName:"ol"},"balance-alb")),(0,i.kt)("p",null,"\u53ef\u4ee5\u5728\u6a21\u5757\u52a0\u8f7d\u7684\u65f6\u5019\u6267\u884c mode \u53c2\u6570\u6765\u8bbe\u5b9a\u4e0d\u540c\u7684\u6a21\u5f0f\uff0c\u65e2\u53ef\u4ee5\u6307\u5b9a\u5b57\u7b26\u4e32\uff0c\u4e5f\u53ef\u4ee5\u6307\u5b9a\u6570\u5b57\u3002"),(0,i.kt)("p",null,"\u547d\u4ee4\u793a\u4f8b\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"modprobe bonding mode=active-backup\nmodprobe bonding mode=1\n")),(0,i.kt)("p",null,"\u5185\u6838\u6e90\u7801\u76ee\u5f55\u4e2d\u6709\u5982\u4e0b\u5bf9 bonding \u529f\u80fd\u7684\u8bf4\u660e\u6587\u6863\uff1a"),(0,i.kt)("p",null,"Documentation/networking/bonding.txt "),(0,i.kt)("p",null,"\u9605\u8bfb\u4e0a\u8ff0\u6587\u4ef6\uff0c\u624b\u52a8\u521b\u5efa\u4e00\u4e2a bond0 \u63a5\u53e3\u53ef\u4ee5\u901a\u8fc7\u5411 /sys/class/net/bonding_masters \u5199\u503c\u6765\u5b8c\u6210\u3002\u547d\u4ee4\u793a\u4f8b\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"su -c 'echo +bond0 > /sys/class/net/bonding_masters'\n")),(0,i.kt)("p",null,"\u521b\u5efa\u540e\u67e5\u770b dmesg \u4fe1\u606f\u53ef\u4ee5\u770b\u5230\u521b\u5efa\u6210\u529f\u4e86\uff0cifconfig bond0 \u80fd\u591f\u770b\u5230\u63a5\u53e3\u4fe1\u606f\uff0c\u8fd9\u4e2a bod0 \u662f master \u63a5\u53e3\u3002\u64cd\u4f5c\u65e5\u5fd7\u8bb0\u5f55\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"longyu@virt-debian10:~/linux-source-4.19/Documentation/networking$ sudo dmesg | tail -n 1\n[93154.264172] bonding: bond0 is being created...\nlongyu@virt-debian10:~/linux-source-4.19/Documentation/networking$ sudo ifconfig bond0\nbond0: flags=5122<BROADCAST,MASTER,MULTICAST>  mtu 1500\n        ether c6:75:a1:27:73:1c  txqueuelen 1000  (Ethernet)\n        RX packets 0  bytes 0 (0.0 B)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 0  bytes 0 (0.0 B)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n")),(0,i.kt)("p",null,"\u6b64\u65f6 /proc/net/bonding \u76ee\u5f55\u4e2d\u4e5f\u6dfb\u52a0\u4e86 bond0 \u7684\u5185\u5bb9\uff0c\u67e5\u770b\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"ls /proc/net/bonding/\nbond0\n")),(0,i.kt)("p",null,"\u8fd9\u4e4b\u540e\u53ef\u4ee5\u5c06\u591a\u4e2a\u7f51\u53e3\u6dfb\u52a0\u5230 bond0 \u4e2d\uff0c\u8fd9\u53ef\u4ee5\u901a\u8fc7\u6267\u884c ifenslave \u547d\u4ee4\u6765\u5b8c\u6210\u3002\u6211\u7684\u7cfb\u7edf\u4e2d\u6ca1\u6709\u9884\u88c5\u8fd9\u4e2a\u8f6f\u4ef6\uff0c\u6267\u884c sudo apt-get install ifenslave \u5b8c\u6210\u5b89\u88c5\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"longyu@virt-debian10:~/linux-source-4.19/Documentation/networking$ sudo ifenslave bond0 enp8s0 enp9s0\nlongyu@virt-debian10:~/linux-source-4.19/Documentation/networking$ sudo dmesg | tail -n 10\n[93659.999911] bond0: Enslaving enp8s0 as an active interface with an up link\n[93660.091509] 8021q: adding VLAN 0 to HW filter on device enp9s0\n[93660.101759] bond0: Enslaving enp9s0 as an active interface with an up link\n[93662.056500] e1000e: enp9s0 NIC Link is Up 1000 Mbps Full Duplex, Flow Control: Rx/Tx\n[93662.217044] e1000e: enp8s0 NIC Link is Up 1000 Mbps Full Duplex, Flow Control: Rx/Tx\n")),(0,i.kt)("p",null,"\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u6267\u884c ifenslave \u5c06 enp8s0 \u4e0e enp9s0 \u6dfb\u52a0\u5230\u4e86 bond0 \u4e2d\uff0c\u5e76\u67e5\u770b\u4e86 demsg \u4fe1\u606f\u3002\u8fd9\u4e24\u4e2a\u7f51\u7edc\u63a5\u53e3\u6dfb\u52a0\u540e\uff0c\u518d\u6b21\u6267\u884c ifconfig \u67e5\u770b\u63a5\u53e3\u4fe1\u606f\uff0c\u53d1\u73b0\u90fd\u589e\u52a0\u4e86 SLAVE \u6807\u5fd7\u3002\u793a\u4f8b\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"longyu@virt-debian10:~/linux-source-4.19/Documentation/networking$ sudo ifconfig enp8s0 \nenp8s0: flags=6211<UP,BROADCAST,RUNNING,SLAVE,MULTICAST>  mtu 1500\n        ether 52:54:00:df:a9:b0  txqueuelen 1000  (Ethernet)\n        RX packets 18027  bytes 1217882 (1.1 MiB)\n        RX errors 1005  dropped 0  overruns 0  frame 1005\n        TX packets 19884  bytes 3872849553 (3.6 GiB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n        device interrupt 22  memory 0xfc240000-fc260000  \n\nlongyu@virt-debian10:~/linux-source-4.19/Documentation/networking$ sudo ifconfig enp9s0 \nenp9s0: flags=6211<UP,BROADCAST,RUNNING,SLAVE,MULTICAST>  mtu 1500\n        ether 52:54:00:df:a9:b0  txqueuelen 1000  (Ethernet)\n        RX packets 215721  bytes 19494398 (18.5 MiB)\n        RX errors 997  dropped 0  overruns 0  frame 997\n        TX packets 3766  bytes 415268735 (396.0 MiB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n        device interrupt 23  memory 0xfc040000-fc060000  \n")),(0,i.kt)("p",null,"\u67e5\u770b /proc/net/bonding/bond0 \u6587\u4ef6\uff0c\u53d1\u73b0\u5176\u4e2d\u6dfb\u52a0\u4e86 slave \u63a5\u53e3\u7684\u4fe1\u606f\uff0c\u547d\u4ee4\u793a\u4f8b\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"longyu@virt-debian10:~/linux-source-4.19/Documentation/networking$ cat /proc/net/bonding/bond0 \nEthernet Channel Bonding Driver: v3.7.1 (April 27, 2011)\n\nBonding Mode: load balancing (round-robin)\nMII Status: up\nMII Polling Interval (ms): 0\nUp Delay (ms): 0\nDown Delay (ms): 0\n\nSlave Interface: enp8s0\nMII Status: up\nSpeed: 1000 Mbps\nDuplex: full\nLink Failure Count: 0\nPermanent HW addr: 52:54:00:df:a9:b0\nSlave queue ID: 0\n\nSlave Interface: enp9s0\nMII Status: up\nSpeed: 1000 Mbps\nDuplex: full\nLink Failure Count: 0\nPermanent HW addr: 52:54:00:08:3f:ef\nSlave queue ID: 0\n")),(0,i.kt)("p",null,"\u53ef\u4ee5\u770b\u5230 enp8s0 \u4e0e enp9s0 \u90fd\u4f5c\u4e3a\u4e86 Slave \u5e76\u5904\u4e8e up \u72b6\u6001\u3002"))}f.isMDXComponent=!0}}]);