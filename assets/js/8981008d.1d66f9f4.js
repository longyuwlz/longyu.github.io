"use strict";(self.webpackChunklongyu_website=self.webpackChunklongyu_website||[]).push([[231],{3905:function(e,t,i){i.d(t,{Zo:function(){return v},kt:function(){return u}});var r=i(7294);function n(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function p(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?_(Object(i),!0).forEach((function(t){n(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):_(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function a(e,t){if(null==e)return{};var i,r,n=function(e,t){if(null==e)return{};var i,r,n={},_=Object.keys(e);for(r=0;r<_.length;r++)i=_[r],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var _=Object.getOwnPropertySymbols(e);for(r=0;r<_.length;r++)i=_[r],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}var d=r.createContext({}),l=function(e){var t=r.useContext(d),i=t;return e&&(i="function"==typeof e?e(t):p(p({},t),e)),i},v=function(e){var t=l(e.components);return r.createElement(d.Provider,{value:t},e.children)},o={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var i=e.components,n=e.mdxType,_=e.originalType,d=e.parentName,v=a(e,["components","mdxType","originalType","parentName"]),c=l(i),u=n,k=c["".concat(d,".").concat(u)]||c[u]||o[u]||_;return i?r.createElement(k,p(p({ref:t},v),{},{components:i})):r.createElement(k,p({ref:t},v))}));function u(e,t){var i=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var _=i.length,p=new Array(_);p[0]=c;var a={};for(var d in t)hasOwnProperty.call(t,d)&&(a[d]=t[d]);a.originalType=e,a.mdxType="string"==typeof e?e:n,p[1]=a;for(var l=2;l<_;l++)p[l]=i[l];return r.createElement.apply(null,p)}return r.createElement.apply(null,i)}c.displayName="MDXCreateElement"},4169:function(e,t,i){i.r(t),i.d(t,{assets:function(){return v},contentTitle:function(){return d},default:function(){return u},frontMatter:function(){return a},metadata:function(){return l},toc:function(){return o}});var r=i(7462),n=i(3366),_=(i(7294),i(3905)),p=["components"],a={},d="dpdk \u7528\u6237\u6001\u9a71\u52a8\u6846\u67b6\u53ca\u5176\u90e8\u5206\u6f14\u8fdb\u8fc7\u7a0b",l={permalink:"/longyu.github.io/blog/dpdk/dpdk \u7528\u6237\u6001\u9a71\u52a8\u6846\u67b6\u53ca\u5176\u6f14\u8fdb\u8fc7\u7a0b\u5206\u6790",editUrl:"https://github.com/longyuwlz/longyu.github.io/blog/dpdk/dpdk \u7528\u6237\u6001\u9a71\u52a8\u6846\u67b6\u53ca\u5176\u6f14\u8fdb\u8fc7\u7a0b\u5206\u6790.md",source:"@site/blog/dpdk/dpdk \u7528\u6237\u6001\u9a71\u52a8\u6846\u67b6\u53ca\u5176\u6f14\u8fdb\u8fc7\u7a0b\u5206\u6790.md",title:"dpdk \u7528\u6237\u6001\u9a71\u52a8\u6846\u67b6\u53ca\u5176\u90e8\u5206\u6f14\u8fdb\u8fc7\u7a0b",description:"dpdk \u7528\u6237\u6001\u9a71\u52a8\u6846\u67b6\u662f dpdk \u76f8\u5bf9\u6838\u5fc3\u7684\u529f\u80fd\uff0c\u672c\u6587\u5c06\u4ece\u8001\u7248\u672c\u9a71\u52a8\u6846\u67b6\u5f00\u59cb\u63cf\u8ff0\uff0c\u4ece\u6f14\u8fdb\u8fc7\u7a0b\u4e2d\u4e00\u6b65\u6b65\u903c\u8fd1\u9ad8\u7248\u672c\u4e2d\u76f8\u5bf9\u5b8c\u5584\u7684\u9a71\u52a8\u6846\u67b6\u7684\u8bbe\u8ba1\u539f\u7406\u3002",date:"2022-06-21T00:32:49.000Z",formattedDate:"2022\u5e746\u670821\u65e5",tags:[],readingTime:26.05,truncated:!1,authors:[],frontMatter:{},prevItem:{title:"dpdk/dpdk \u6b7b\u9501\u95ee\u9898\u540e\u7eed\u4e4b\u521d\u59cb\u5316\u5047\u8bbe\u4e0d\u53ef\u8fc1\u79fb\u95ee\u9898",permalink:"/longyu.github.io/blog/dpdk/dpdk \u6b7b\u9501\u95ee\u9898\u540e\u7eed\u4e4b\u521d\u59cb\u5316\u5047\u8bbe\u4e0d\u53ef\u8fc1\u79fb\u95ee\u9898"},nextItem:{title:"dpdk/dpdk \u7a0b\u5e8f\u6027\u80fd\u95ee\u9898\u6392\u67e5\u7684\u4e00\u822c\u6d41\u7a0b",permalink:"/longyu.github.io/blog/dpdk/dpdk \u7a0b\u5e8f\u6027\u80fd\u95ee\u9898\u6392\u67e5\u7684\u4e00\u822c\u6d41\u7a0b"}},v={authorsImageUrls:[]},o=[{value:"dpdk v1.2.3 r0 \u7248\u672c",id:"dpdk-v123-r0-\u7248\u672c",level:2},{value:"\u4ece l2fwd \u793a\u4f8b\u7a0b\u5e8f\u4ee3\u7801\u5904\u63a2\u7a76",id:"\u4ece-l2fwd-\u793a\u4f8b\u7a0b\u5e8f\u4ee3\u7801\u5904\u63a2\u7a76",level:3},{value:"eth_driver \u7ed3\u6784",id:"eth_driver-\u7ed3\u6784",level:3},{value:"rte_pci_driver \u7ed3\u6784",id:"rte_pci_driver-\u7ed3\u6784",level:3},{value:"rte_pci_driver \u7ed3\u6784\u4f53\u4e2d\u7684 devinit \u51fd\u6570",id:"rte_pci_driver-\u7ed3\u6784\u4f53\u4e2d\u7684-devinit-\u51fd\u6570",level:3},{value:"rte_eth_dev_init \u51fd\u6570",id:"rte_eth_dev_init-\u51fd\u6570",level:3},{value:"\u4ee5\u4e00\u4e2a igb \u7f51\u5361\u63a5\u53e3\u6765\u4e32\u8d77 dpdk v1.2.3 r0 \u7248\u672c\u63a5\u53e3\u521d\u59cb\u5316\u7684\u6574\u4e2a\u8fc7\u7a0b",id:"\u4ee5\u4e00\u4e2a-igb-\u7f51\u5361\u63a5\u53e3\u6765\u4e32\u8d77-dpdk-v123-r0-\u7248\u672c\u63a5\u53e3\u521d\u59cb\u5316\u7684\u6574\u4e2a\u8fc7\u7a0b",level:3},{value:"\u603b\u7ed3 v1.2.3 r0 \u7248\u672c\u7528\u6237\u6001\u9a71\u52a8\u6846\u67b6\u5173\u952e\u77e5\u8bc6\u4e0e\u9690\u542b\u95ee\u9898",id:"\u603b\u7ed3-v123-r0-\u7248\u672c\u7528\u6237\u6001\u9a71\u52a8\u6846\u67b6\u5173\u952e\u77e5\u8bc6\u4e0e\u9690\u542b\u95ee\u9898",level:3},{value:"dpdk v1.4.0r0 \u7248\u672c",id:"dpdk-v140r0-\u7248\u672c",level:2},{value:"dpdk v1.5.0r0 \u7248\u672c",id:"dpdk-v150r0-\u7248\u672c",level:2},{value:"dpdk v1.7.0",id:"dpdk-v170",level:2},{value:"rte_driver \u7ed3\u6784",id:"rte_driver-\u7ed3\u6784",level:3},{value:"VDEV \u7c7b\u9a71\u52a8",id:"vdev-\u7c7b\u9a71\u52a8",level:3},{value:"PDEV \u7c7b\u9a71\u52a8",id:"pdev-\u7c7b\u9a71\u52a8",level:3},{value:"BDEV \u7c7b\u9a71\u52a8",id:"bdev-\u7c7b\u9a71\u52a8",level:3},{value:"rte_eal_dev_init \u51fd\u6570",id:"rte_eal_dev_init-\u51fd\u6570",level:3},{value:"igb_uio \u4e2d\u79fb\u9664 pci id table",id:"igb_uio-\u4e2d\u79fb\u9664-pci-id-table",level:3},{value:"VFIO \u6a21\u5757\u7684\u652f\u6301",id:"vfio-\u6a21\u5757\u7684\u652f\u6301",level:3},{value:"v1.8.0",id:"v180",level:2},{value:"dpdk-16.04",id:"dpdk-1604",level:2},{value:"dpdk 17.x bus \u62bd\u8c61\u5c42\u7684\u5f15\u5165",id:"dpdk-17x-bus-\u62bd\u8c61\u5c42\u7684\u5f15\u5165",level:2},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}],c={toc:o};function u(e){var t=e.components,i=(0,n.Z)(e,p);return(0,_.kt)("wrapper",(0,r.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,_.kt)("p",null,"dpdk \u7528\u6237\u6001\u9a71\u52a8\u6846\u67b6\u662f dpdk \u76f8\u5bf9\u6838\u5fc3\u7684\u529f\u80fd\uff0c\u672c\u6587\u5c06\u4ece\u8001\u7248\u672c\u9a71\u52a8\u6846\u67b6\u5f00\u59cb\u63cf\u8ff0\uff0c\u4ece\u6f14\u8fdb\u8fc7\u7a0b\u4e2d\u4e00\u6b65\u6b65\u903c\u8fd1\u9ad8\u7248\u672c\u4e2d\u76f8\u5bf9\u5b8c\u5584\u7684\u9a71\u52a8\u6846\u67b6\u7684\u8bbe\u8ba1\u539f\u7406\u3002"),(0,_.kt)("h2",{id:"dpdk-v123-r0-\u7248\u672c"},"dpdk v1.2.3 r0 \u7248\u672c"),(0,_.kt)("p",null,"dpdk git \u4e2d\u6700\u8001\u7684\u7248\u672c\u4e3a v1.2.3 r0 \u7248\u672c\uff0c\u6b64\u7248\u672c\u4e2d\u7528\u6237\u6001\u9a71\u52a8\u6846\u67b6\u5b9e\u73b0\u7684\u5173\u952e\u73af\u8282\u5982\u4e0b\uff1a"),(0,_.kt)("ol",null,(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"igb_uio \u4e2d\u5b8c\u6210\u5c06\u4e2d\u65ad\u6620\u5c04\u5230\u7528\u6237\u6001\u7684\u4efb\u52a1\uff0c\u5e76\u586b\u5145 uio \u7ed3\u6784\u4f53\u4e2d pci \u8d44\u6e90\u7a7a\u95f4\u7684\u5730\u5740\u4e0e\u957f\u5ea6\uff0c\u5b83\u6ce8\u518c\u7684 pci_driver \u4e2d\uff0c id_table \u5b57\u6bb5\u4e0d\u4e3a\u7a7a\uff0c\u5176\u503c\u5982\u4e0b\uff1a"),(0,_.kt)("pre",{parentName:"li"},(0,_.kt)("code",{parentName:"pre",className:"language-c"},"static struct pci_device_id igbuio_pci_ids[] = {\n#define RTE_PCI_DEV_ID_DECL(vend, dev) {PCI_DEVICE(vend, dev)},\n#include <rte_pci_dev_ids.h>\n{ 0, },\n};\n"))),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"rte_eal_init \u51fd\u6570\u4e2d\u5b8c\u6210\u626b\u63cf pci \u8bbe\u5907\u7684\u8fc7\u7a0b\uff0c\u626b\u63cf\u5230\u7684 pci \u8bbe\u5907\u4f1a\u586b\u5145\u5230 device_list \u94fe\u8868\u4e2d\uff0crte_eal_init \u51fd\u6570\u4e2d\u5e76\u4e0d\u8fdb\u884c\u9a71\u52a8 probe \u8fc7\u7a0b\uff0c\u56e0\u4e3a\u6b64\u65f6\u8fd8\u672a\u6ce8\u518c\u4efb\u4f55\u4e00\u4e2a\u9a71\u52a8\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"\u8fd9\u4e2a\u7248\u672c\u7684 dpdk \u53ea\u652f\u6301 igb \u4e0e ixgbe \u4e24\u4e2a\u7cfb\u5217\u7684\u7528\u6237\u6001\u9a71\u52a8\uff0c\u6bcf\u4e2a\u9a71\u52a8\u4f1a\u5b9e\u73b0\u4e00\u4e2a\u6ce8\u518c\u51fd\u6570\u5e76\u5c06\u6ce8\u518c\u51fd\u6570\u66b4\u9732\u7ed9 dpdk \u7a0b\u5e8f\u4f7f\u7528\uff0c\u663e\u5f0f\u5b8c\u6210\u9a71\u52a8\u6ce8\u518c\u8fc7\u7a0b\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"\u7531\u4e8e\u9a71\u52a8\u6ce8\u518c\u662f\u5728 dpdk \u7a0b\u5e8f\u4e2d\u5b8c\u6210\u7684\uff0c\u9a71\u52a8 probe pci \u8bbe\u5907\u7684\u8fc7\u7a0b\u4e5f\u662f\u5728 dpdk \u7a0b\u5e8f\u4e2d\u663e\u5f0f\u8c03\u7528 probe \u51fd\u6570\u5b8c\u6210\u7684\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"rte_eal_pci_probe \u51fd\u6570\u904d\u5386\u5728 rte_eal_init \u4e2d\u521b\u5efa\u7684 device_list pci \u8bbe\u5907\u94fe\u8868\uff0c\u4f7f\u7528\u8fd9\u4e2a\u94fe\u8868\u4e2d\u7684\u6bcf\u4e2a pci \u8bbe\u5907\u53bb match \u6ce8\u518c\u7684 pci \u9a71\u52a8\u94fe\u8868\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"\u5f53\u4e00\u4e2a pci \u8bbe\u5907 match \u5230\u4e00\u4e2a\u9a71\u52a8\u540e\uff0c\u9996\u5148\u8c03\u7528 pci_uio_map_resource \u51fd\u6570\u6765\u901a\u8fc7 map /dev/uioX \u6587\u4ef6\u6765\u6620\u5c04 pci \u7684 resource \u8d44\u6e90\u5e76\u586b\u5145\u5230 pci \u8bbe\u5907\u7ed3\u6784\u4f53\u4e2d\uff0c\u7136\u540e\u8c03\u7528 pci \u9a71\u52a8\u4e2d\u7684 devinit \u51fd\u6570\u5b8c\u6210\u63a5\u53e3\u521d\u59cb\u5316\u8fc7\u7a0b\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"pci \u9a71\u52a8\u4e2d\u5e76\u4e0d\u5b9a\u4e49 devinit \u51fd\u6570\uff0c\u5b83\u5728\u663e\u793a\u6ce8\u518c\u9a71\u52a8\u65f6\uff0c\u901a\u8fc7\u8c03\u7528 rte_eth_driver_register \u51fd\u6570\u6765\u8bbe\u5b9a\uff0c\u5176\u503c\u88ab\u8bbe\u5b9a\u4e3a rte_eth_dev_init \u51fd\u6570\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"\u7b2c \uff16\u70b9\u4e2d\u63cf\u8ff0\u7684 pci \u9a71\u52a8\u4e2d\u7684 devinit \u51fd\u6570\u5c31\u662f\u7b2c 7 \u70b9\u4e2d\u7684 rte_eth_dev_init \u51fd\u6570\uff0crte_eth_dev_init \u51fd\u6570\u5b9e\u73b0 pci \u8bbe\u5907\u7ed3\u6784\u4f53\u4e0e dpdk \u5185\u90e8 rte_eth_dev \u8bbe\u5907\u7ed3\u6784\u4f53\u7684\u5bf9\u63a5\u8fc7\u7a0b\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"\u5728 pci \u8fd9\u4e00\u4fa7\u6bcf\u4e00\u4e2a\u8bbe\u5907\u7531\u4e00\u4e2a rte_pci_device \u7ed3\u6784\u63cf\u8ff0\u3002\u7531\u4e8e dpdk \u9700\u8981\u5bf9\u5916\u63d0\u4f9b\u7f51\u5361\u63a7\u5236\u63a5\u53e3\uff0c\u8fd9\u4e9b\u63a7\u5236\u8fc7\u7a0b\u4e2d\u7684\u53c2\u6570\u662f\u4e0e\u9a71\u52a8\u65e0\u5173\u7684\uff0c\u4e0d\u80fd\u901a\u8fc7\u76f4\u63a5\u64cd\u4f5c pci \u8fd9\u4e00\u5c42\u7684\u6570\u636e\u7ed3\u6784\u6765\u5b8c\u6210\uff0c\u4e3a\u6b64 dpdk \u5728\u6b64\u57fa\u7840\u4e0a\u8fdb\u884c\u4e86\u62bd\u8c61\uff0c\u62bd\u8c61\u51fa\u4e86 rte_eth_dev \u8bbe\u5907\u7ed3\u6784\u4f53\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"\u6bcf\u4e00\u4e2a dpdk \u521d\u59cb\u5316\u7684 pci \u63a5\u53e3\u90fd\u4f1a\u5206\u914d\u4e00\u4e2a\u552f\u4e00\u7684 rte_eth_dev \u7ed3\u6784\u4f53\uff0cdpdk \u5185\u90e8\u7ef4\u62a4\u4e86\u4e00\u4e2a rte_eth_devices \u5168\u5c40\u53d8\u91cf\uff0c\u5b83\u662f\u4e00\u4e2a rte_eth_dev \u7ed3\u6784\u4f53\u6570\u7ec4\uff0c\u6bcf\u4e2a\u63a5\u53e3\u90fd\u4ece\u8fd9\u4e2a\u6570\u7ec4\u4e2d\u5206\u914d\u4e00\u4e2a rte_eth_dev \u7ed3\u6784\u4f53\uff0c\u5916\u90e8\u63a5\u53e3\u901a\u8fc7\u6307\u5b9a\u4e00\u4e2a port_id \u6765\u8ba9 rte_ethdev \u8fd9\u4e00\u5c42\u83b7\u53d6\u5230 rte_eth_dev \u7ed3\u6784\uff0c\u8c03\u7528\u5e95\u5c42\u7684\u51fd\u6570\u6765\u5b8c\u6210\u529f\u80fd\u3002"))),(0,_.kt)("h3",{id:"\u4ece-l2fwd-\u793a\u4f8b\u7a0b\u5e8f\u4ee3\u7801\u5904\u63a2\u7a76"},"\u4ece l2fwd \u793a\u4f8b\u7a0b\u5e8f\u4ee3\u7801\u5904\u63a2\u7a76"),(0,_.kt)("p",null,"\u5982\u4e0b\u6e90\u7801\u6458\u81ea\u6b64\u7248\u672c\u7684 l2fwd \u793a\u4f8b\u7a0b\u5e8f\uff1a"),(0,_.kt)("pre",null,(0,_.kt)("code",{parentName:"pre",className:"language-c"},'            /* init EAL */\n            ret = rte_eal_init(argc, argv);\n    ..........................................\n    #ifdef RTE_LIBRTE_IGB_PMD\n            if (rte_igb_pmd_init() < 0)\n                    rte_exit(EXIT_FAILURE, "Cannot init igb pmd\\n");\n    #endif\n    #ifdef RTE_LIBRTE_IXGBE_PMD\n            if (rte_ixgbe_pmd_init() < 0)\n                    rte_exit(EXIT_FAILURE, "Cannot init ixgbe pmd\\n");\n    #endif\n    \n            if (rte_eal_pci_probe() < 0)\n                    rte_exit(EXIT_FAILURE, "Cannot probe PCI\\n");\n')),(0,_.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\uff0cigb \u7f51\u5361\u4e0e ixgbe \u7f51\u5361\u9a71\u52a8\u8c03\u7528\u9a71\u52a8\u63d0\u4f9b\u7684\u521d\u59cb\u5316\u51fd\u6570\u6765\u663e\u793a\u6ce8\u518c\uff0c\u6ce8\u518c\u5b8c\u6210\u540e\uff0c\u8c03\u7528 rte_eal_pci_probe \u6765\u5b8c\u6210 probe \u8fc7\u7a0b\u3002"),(0,_.kt)("h3",{id:"eth_driver-\u7ed3\u6784"},"eth_driver \u7ed3\u6784"),(0,_.kt)("p",null,(0,_.kt)("strong",{parentName:"p"},"\u6b64\u7248\u672c\u4ec5\u652f\u6301 pci \u9a71\u52a8"),"\uff0c\u6bcf\u4e2a\u9a71\u52a8\u9700\u8981\u5b9e\u4f8b\u5316\u4e00\u4e2a eth_driver \u7ed3\u6784\uff0c\u6b64\u7ed3\u6784\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a"),(0,_.kt)("pre",null,(0,_.kt)("code",{parentName:"pre",className:"language-c"},"    struct eth_driver {\n        struct rte_pci_driver pci_drv;    /**< The PMD is also a PCI driver. */\n        eth_dev_init_t eth_dev_init;      /**< Device init function. */\n        unsigned int dev_private_size;    /**< Size of device private data. */\n    };\n")),(0,_.kt)("p",null,"pci_drv \u662f\u5bf9\u7528\u6237\u6001 pci \u8bbe\u5907\u9a71\u52a8\u7684\u62bd\u8c61\uff0ceth_dev_init \u7528\u6237\u6001\u9a71\u52a8\u7684\u521d\u59cb\u5316\u51fd\u6570\uff0cdev_private_size \u662f\u6bcf\u4e2a\u8bbe\u5907\u7684\u79c1\u6709\u6570\u636e\u5927\u5c0f\u3002"),(0,_.kt)("p",null,"\u6bcf\u4e2a\u9a71\u52a8\u90fd\u8981\u5b9e\u4f8b\u5316\u4e00\u4e2a eth_driver \u7ed3\u6784\u4f53\uff0c\u5e76\u663e\u793a\u7684\u8c03\u7528\u6ce8\u518c\u51fd\u6570\u8fdb\u884c\u6ce8\u518c\u3002igb \u7f51\u5361\u7684 eth_driver \u7ed3\u6784\u4f53\u5b9e\u4f8b\u5982\u4e0b\uff1a"),(0,_.kt)("pre",null,(0,_.kt)("code",{parentName:"pre",className:"language-c"},'static struct eth_driver rte_igb_pmd = {\n    {\n        .name = "rte_igb_pmd",\n        .id_table = pci_id_igb_map,\n        .drv_flags = RTE_PCI_DRV_NEED_IGB_UIO,\n    },\n    .eth_dev_init = eth_igb_dev_init,\n    .dev_private_size = sizeof(struct e1000_adapter),\n};\n')),(0,_.kt)("p",null,(0,_.kt)("strong",{parentName:"p"},"\u7531\u4e8e eth_driver \u7ed3\u6784\u4f53\u7684\u7b2c\u4e00\u4e2a\u5143\u7d20\u4e3a rte_pci_driver \u7ed3\u6784\uff0c\u53ef\u4ee5\u5f88\u5bb9\u6613\u7684\u5c06\u4e00\u4e2a eth_driver \u7ed3\u6784\u5730\u5740\u8f6c\u5316\u4e3a\u4e00\u4e2a rte_pci_driver \u7ed3\u6784\u5730\u5740\uff08\u901a\u8fc7\u5f3a\u8f6c\uff09"),"\u3002"),(0,_.kt)("h3",{id:"rte_pci_driver-\u7ed3\u6784"},"rte_pci_driver \u7ed3\u6784"),(0,_.kt)("p",null,"rte_pci_driver \u7ed3\u6784\u662f\u5bf9 pci \u9a71\u52a8\u7684\u62bd\u8c61\uff0c\u5176\u5b9a\u4e49\u5982\u4e0b\uff1a"),(0,_.kt)("pre",null,(0,_.kt)("code",{parentName:"pre",className:"language-c"},"/**\n * A structure describing a PCI driver.\n */\nstruct rte_pci_driver {\n    TAILQ_ENTRY(rte_pci_driver) next;       /**< Next in list. */\n    const char *name;                       /**< Driver name. */\n    pci_devinit_t *devinit;                 /**< Device init. function. */\n    struct rte_pci_id *id_table;            /**< ID table, NULL terminated. */\n    uint32_t drv_flags;                     /**< Flags contolling handling of device. */\n};\n")),(0,_.kt)("p",null,"rte_pci_driver \u7684 next \u5b57\u6bb5\u7528\u4e8e\u5c06\u6ce8\u518c\u7684 pci \u9a71\u52a8\u4e32\u8054\u8d77\u6765\uff0cdevinit \u51fd\u6570\u7528\u4e8e\u8bbe\u5907\u521d\u59cb\u5316\u3002"),(0,_.kt)("h3",{id:"rte_pci_driver-\u7ed3\u6784\u4f53\u4e2d\u7684-devinit-\u51fd\u6570"},"rte_pci_driver \u7ed3\u6784\u4f53\u4e2d\u7684 devinit \u51fd\u6570"),(0,_.kt)("p",null,"igb \u9a71\u52a8\u5b9e\u73b0\u7684 rte_pci_driver \u7ed3\u6784\u4e2d\u5e76\u6ca1\u6709\u8bbe\u5b9a devinit \u5b57\u6bb5\uff0c\u8fd9\u4e2a\u5b57\u6bb5\u5728 dpdk \u7a0b\u5e8f\u663e\u5f0f\u8c03\u7528 rte_igb_pmd_init \u6ce8\u518c igb \u9a71\u52a8\u7684\u65f6\u5019\u88ab\u8d4b\u503c\u3002"),(0,_.kt)("p",null,"rte_igb_pmd_init \u51fd\u6570\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,_.kt)("pre",null,(0,_.kt)("code",{parentName:"pre",className:"language-c"},"int\nrte_igb_pmd_init(void)\n{\n    rte_eth_driver_register(&rte_igb_pmd);\n    return 0;\n}\n")),(0,_.kt)("p",null,"rte_eth_driver_register \u51fd\u6570\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,_.kt)("pre",null,(0,_.kt)("code",{parentName:"pre",className:"language-c"},"void\nrte_eth_driver_register(struct eth_driver *eth_drv)\n{\n    eth_drv->pci_drv.devinit = rte_eth_dev_init;\n    rte_eal_pci_register(&eth_drv->pci_drv);\n}\n")),(0,_.kt)("p",null,"\u5982\u4e0a\u4ee3\u7801\u80fd\u591f\u8bf4\u660e rte_pci_driver \u4e2d\u7684 devinit \u51fd\u6570\u5728\u9a71\u52a8\u663e\u793a\u6ce8\u518c\u65f6\u88ab\u8d4b\u503c\u4e3a rte_eth_dev_init \u51fd\u6570\uff0c\u90a3\u4e48 ",(0,_.kt)("strong",{parentName:"p"},"eth_driver \u4e2d\u6ce8\u518c\u7684 eth_dev_init \u51fd\u6570\u5728\u54ea\u91cc\u88ab\u8c03\u7528\u5462\uff1f")),(0,_.kt)("h3",{id:"rte_eth_dev_init-\u51fd\u6570"},"rte_eth_dev_init \u51fd\u6570"),(0,_.kt)("p",null,"eth_driver \u7ed3\u6784\u4f53\u4e2d\u6ce8\u518c\u7684 eth_dev_init \u51fd\u6570\u5728 rte_eth_dev_init \u51fd\u6570\u4e2d\u88ab\u8c03\u7528\uff0crte_eth_dev_init \u51fd\u6570\u7684\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,_.kt)("pre",null,(0,_.kt)("code",{parentName:"pre",className:"language-c"},'static int\nrte_eth_dev_init(struct rte_pci_driver *pci_drv,\n         struct rte_pci_device *pci_dev)\n{\n    struct eth_driver    *eth_drv;\n    struct rte_eth_dev *eth_dev;\n    int diag;\n\n    eth_drv = (struct eth_driver *)pci_drv;\n\n    eth_dev = rte_eth_dev_allocate();\n    if (eth_dev == NULL)\n        return -ENOMEM;\n\n\n    if (rte_eal_process_type() == RTE_PROC_PRIMARY){\n        eth_dev->data->dev_private = rte_zmalloc("ethdev private structure",\n                  eth_drv->dev_private_size,\n                  CACHE_LINE_SIZE);\n        if (eth_dev->data->dev_private == NULL)\n            return -ENOMEM;\n    }\n    eth_dev->pci_dev = pci_dev;\n    eth_dev->driver = eth_drv;\n    eth_dev->data->rx_mbuf_alloc_failed = 0;\n\n    /* init user callbacks */\n    TAILQ_INIT(&(eth_dev->callbacks));\n\n    /*\n     * Set the default maximum frame size.\n     */\n    eth_dev->data->max_frame_size = ETHER_MAX_LEN;\n\n    /* Invoke PMD device initialization function */\n    diag = (*eth_drv->eth_dev_init)(eth_drv, eth_dev);\n    if (diag == 0)\n        return (0);\n\n    PMD_DEBUG_TRACE("driver %s: eth_dev_init(vendor_id=0x%u device_id=0x%x)"\n            " failed\\n", pci_drv->name,\n            (unsigned) pci_dev->id.vendor_id,\n            (unsigned) pci_dev->id.device_id);\n    if (rte_eal_process_type() == RTE_PROC_PRIMARY)\n        rte_free(eth_dev->data->dev_private);\n    nb_ports--;\n    return diag;\n}\n')),(0,_.kt)("p",null,"\u6b64\u51fd\u6570\u4e2d\u9996\u5148\u4e3a\u5f53\u524d\u7684 pci \u8bbe\u5907\u5206\u914d\u4e00\u4e2a rte_eth_dev \u7ed3\u6784\uff0c\u7136\u540e\u4f7f\u7528 eth_drv \u7ed3\u6784\u4f53\u4e2d\u5b9a\u4e49\u7684 dev_private_size \u5b57\u6bb5\u6765\u521b\u5efa\u9a71\u52a8\u5185\u90e8\u6570\u636e\u7ed3\u6784\u3002"),(0,_.kt)("p",null,"\u6b64\u540e\uff0c\u7ee7\u7eed\u521d\u59cb\u5316 rte_eth_dev \u7ed3\u6784\u4f53\u4e2d\u7684\u5b57\u6bb5\uff0c\u6700\u540e\u8c03\u7528 eth_driver \u7ed3\u6784\u4f53\u4e2d\u7684 eth_dev_init \u51fd\u6570\u6307\u9488\u6307\u5411\u7684\u51fd\u6570\uff0c\u5b8c\u6210\u63a5\u53e3\u5e95\u5c42\u521d\u59cb\u5316\u8fc7\u7a0b\u3002"),(0,_.kt)("h3",{id:"\u4ee5\u4e00\u4e2a-igb-\u7f51\u5361\u63a5\u53e3\u6765\u4e32\u8d77-dpdk-v123-r0-\u7248\u672c\u63a5\u53e3\u521d\u59cb\u5316\u7684\u6574\u4e2a\u8fc7\u7a0b"},"\u4ee5\u4e00\u4e2a igb \u7f51\u5361\u63a5\u53e3\u6765\u4e32\u8d77 dpdk v1.2.3 r0 \u7248\u672c\u63a5\u53e3\u521d\u59cb\u5316\u7684\u6574\u4e2a\u8fc7\u7a0b"),(0,_.kt)("p",null,"\u5047\u5b9a\u67d0 linux \u7cfb\u7edf\u4e2d\u6709\u4e00\u4e2a igb \u7f51\u5361\uff0c\u5b83\u53ea\u6709\u4e24\u4e2a\u53e3\uff0c\u8fd9\u4e24\u4e2a\u53e3\u7684 pci \u53f7\u5206\u522b\u4e3a 0000:01:00.0\u30010000:01:00.1\uff0c0000:01:00.0 \u8fd9\u4e2a\u53e3\u7531\u5185\u6838\u9a71\u52a8\u63a5\u7ba1\uff0c0000:01:00.1 \u8fd9\u4e2a\u53e3\u7528\u4e8e dpdk \u8f6c\u5305\uff08\u786e\u8ba4 igb_uio \u7f51\u5361\u652f\u6301\u6b64\u7f51\u5361\uff09\u3002"),(0,_.kt)("p",null,"\u5047\u5b9a igb_uio \u9a71\u52a8\u6b63\u5e38\u52a0\u8f7d\uff0c\u5927\u9875\u5185\u5b58\u6b63\u5e38\u914d\u7f6e\uff0c\u5206\u6790\u6a21\u578b\u57fa\u4e8e primary \u8fdb\u7a0b\u3002"),(0,_.kt)("p",null,"\u4e0b\u9762\u662f\u5177\u4f53\u8fc7\u7a0b\uff1a"),(0,_.kt)("ol",null,(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"\u5c06 0000:01:00.1 \u4ece igb \u9a71\u52a8\u89e3\u7ed1")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"\u5c06 0000:01:00.1 \u5199\u5165\u5230 /sys \u76ee\u5f55\u4e2d igb_uio \u7684 bind \u6587\u4ef6\u4e2d\uff0c\u7ed1\u5b9a\u63a5\u53e3\u5230 igb_uio\uff0c\u7ed1\u5b9a\u540e /dev/uio0 \u6587\u4ef6\u88ab\u521b\u5efa\uff0c/sys \u76ee\u5f55\u4e2d\u76f8\u5e94\u7684\u6587\u4ef6\u88ab\u521b\u5efa\uff0cuio map \u5730\u5740\u76f8\u5173\u6587\u4ef6\u88ab\u521b\u5efa\uff0c\u793a\u4f8b\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,_.kt)("pre",{parentName:"li"},(0,_.kt)("code",{parentName:"pre",className:"language-bash"}," [root] # pwd\n/sys/bus/pci/drivers/igb_uio/0000:01:00.0\n [root] # cat ./uio/uio0/maps/map0/addr ./uio/uio0/maps/map0/name  ./uio/uio0/maps/map0/size ./uio/uio0/maps/map0/offset\n0xfebf3000\nBAR1\n0x1000\n0x0\n"))),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"dpdk \u7a0b\u5e8f\u8c03\u7528 rte_eal_init \u521d\u59cb\u5316\uff0c\u626b\u63cf /sys/bus/pci/devices \u76ee\u5f55\uff0c\u89e3\u6790\u5b50\u76ee\u5f55 0000:01:00.1 \u4e2d\u7684\u6587\u4ef6\uff0c\u586b\u5145\u5230\u4e00\u4e2a\u65b0\u521b\u5efa\u7684 rte_pci_device \u7ed3\u6784\u4f53\u4e2d\uff0c\u586b\u5145\u5b8c\u6210\u540e\u5c06\u6b64\u7ed3\u6784\u4f53\u94fe\u5165\u5230 device_list \u8bbe\u5907\u94fe\u8868\u4e2d\u30020000:01:00.1 \u76ee\u5f55\u4e2d\u7684\u91cd\u8981\u6587\u4ef6\u542b\u4e49\u89c1\u4e0b\u8868\uff1a"),(0,_.kt)("table",{parentName:"li"},(0,_.kt)("thead",{parentName:"table"},(0,_.kt)("tr",{parentName:"thead"},(0,_.kt)("th",{parentName:"tr",align:null},"file"),(0,_.kt)("th",{parentName:"tr",align:null},"function"))),(0,_.kt)("tbody",{parentName:"table"},(0,_.kt)("tr",{parentName:"tbody"},(0,_.kt)("td",{parentName:"tr",align:null},"class"),(0,_.kt)("td",{parentName:"tr",align:null},"PCI class (ascii, ro)")),(0,_.kt)("tr",{parentName:"tbody"},(0,_.kt)("td",{parentName:"tr",align:null},"config"),(0,_.kt)("td",{parentName:"tr",align:null},"PCI config space (binary, rw)")),(0,_.kt)("tr",{parentName:"tbody"},(0,_.kt)("td",{parentName:"tr",align:null},"device"),(0,_.kt)("td",{parentName:"tr",align:null},"PCI device (ascii, ro)")),(0,_.kt)("tr",{parentName:"tbody"},(0,_.kt)("td",{parentName:"tr",align:null},"enable"),(0,_.kt)("td",{parentName:"tr",align:null},"Whether the device is enabled (ascii, rw)")),(0,_.kt)("tr",{parentName:"tbody"},(0,_.kt)("td",{parentName:"tr",align:null},"irq"),(0,_.kt)("td",{parentName:"tr",align:null},"IRQ number (ascii, ro)")),(0,_.kt)("tr",{parentName:"tbody"},(0,_.kt)("td",{parentName:"tr",align:null},"local_cpus"),(0,_.kt)("td",{parentName:"tr",align:null},"nearby CPU mask (cpumask, ro)")),(0,_.kt)("tr",{parentName:"tbody"},(0,_.kt)("td",{parentName:"tr",align:null},"remove"),(0,_.kt)("td",{parentName:"tr",align:null},"remove device from kernel's list (ascii, wo)")),(0,_.kt)("tr",{parentName:"tbody"},(0,_.kt)("td",{parentName:"tr",align:null},"resource"),(0,_.kt)("td",{parentName:"tr",align:null},"PCI resource host addresses (ascii, ro)")),(0,_.kt)("tr",{parentName:"tbody"},(0,_.kt)("td",{parentName:"tr",align:null},"resource0..N"),(0,_.kt)("td",{parentName:"tr",align:null},"PCI resource N, if present (binary, mmap, rw","[1]",")")),(0,_.kt)("tr",{parentName:"tbody"},(0,_.kt)("td",{parentName:"tr",align:null},"resource0_wc..N_wc"),(0,_.kt)("td",{parentName:"tr",align:null},"PCI WC map resource N, if prefetchable (binary, mmap)")),(0,_.kt)("tr",{parentName:"tbody"},(0,_.kt)("td",{parentName:"tr",align:null},"rom"),(0,_.kt)("td",{parentName:"tr",align:null},"PCI ROM resource, if present (binary, ro)")),(0,_.kt)("tr",{parentName:"tbody"},(0,_.kt)("td",{parentName:"tr",align:null},"subsystem_device"),(0,_.kt)("td",{parentName:"tr",align:null},"PCI subsystem device (ascii, ro)")),(0,_.kt)("tr",{parentName:"tbody"},(0,_.kt)("td",{parentName:"tr",align:null},"subsystem_vendor"),(0,_.kt)("td",{parentName:"tr",align:null},"PCI subsystem vendor (ascii, ro)")),(0,_.kt)("tr",{parentName:"tbody"},(0,_.kt)("td",{parentName:"tr",align:null},"vendor"),(0,_.kt)("td",{parentName:"tr",align:null},"PCI vendor (ascii, ro)"))))),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"dpdk \u7a0b\u5e8f\u6267\u884c rte_igb_pmd_init \u6ce8\u518c igb \u9a71\u52a8\uff0crte_igb_pmd \u7ed3\u6784\u4f53\u4e2d pci_drv \u7ed3\u6784\u7684 devinit \u51fd\u6570\u6307\u9488\u88ab\u8bbe\u7f6e\u4e3a rte_eth_dev_init \u51fd\u6570\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"dpdk \u7a0b\u5e8f\u8c03\u7528 rte_eal_pci_probe \u51fd\u6570\u5b8c\u6210\u9a71\u52a8 probe \u8fc7\u7a0b\uff0crte_eal_pci_probe \u51fd\u6570\u4f9d\u6b21\u904d\u5386 device_list \u94fe\u8868\uff0c\u83b7\u53d6\u5230 0000:01:00.1 \u63a5\u53e3\u586b\u5145\u7684 rte_pci_device \u7ed3\u6784\u4f53\uff0c\u7136\u540e\u8c03\u7528 pci_probe_all_drivers \u51fd\u6570\u5b8c\u6210\u9a71\u52a8 probe \u8fc7\u7a0b\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"pci_probe_all_drivers \u51fd\u6570\u904d\u5386 driver_list \u94fe\u8868\uff0c\u9996\u5148\u5224\u65ad\u5f53\u524d\u8bbe\u5907\u662f\u5426\u88ab\u52a0\u5165\u5230\u9ed1\u540d\u5355\uff0c\u662f\u5219\u8df3\u8fc7\u6b64\u8bbe\u5907\uff0c\u8fd9\u91cc\u7531\u4e8e\u7a0b\u5e8f\u6267\u884c\u65f6\u6ca1\u6709\u914d\u7f6e\u9ed1\u540d\u5355\uff0c\u4e0d\u4f1a\u8d70\u5165\u8fd9\u4e2a\u903b\u8f91\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"pci_probe_all_drivers \u51fd\u6570\u83b7\u53d6\u5230\u6ce8\u518c\u7684 igb \u9a71\u52a8\u7684 rte_pci_driver \u7ed3\u6784\uff0c\u4f7f\u7528\u6b64\u7ed3\u6784\u4e0e rte_pci_device \u7ed3\u6784\u4e3a\u53c2\u6570\u8c03\u7528 rte_eal_pci_probe_one_driver \u51fd\u6570")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"rte_eal_pci_probe_one_driver \u51fd\u6570\u4f7f\u7528 rte_pci_device \u7ed3\u6784\u4f53\u4e2d\u4fdd\u5b58\u7684\u8bbe\u5907\u7684 vendor id \u4e0e device id \u5728 pci_id_igb_map \u5217\u8868\u4e2d\u8fdb\u884c\u5339\u914d\uff0c\u6210\u529f\u5339\u914d\u540e\u8c03\u7528 pci_uio_map_resource \u6765 mmap pci resource \u5730\u5740\u5230\u7528\u6237\u6001\u4e2d\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"pci_uio_map_resource \u9996\u5148\u627e\u5230\u5e76\u89e3\u6790 /sys/bus/pci/drivers/igb_uio/0000:01:00.0/uio/uio0/maps/map0/ \u4e0b\u7684 offset \u4e0e size \u6587\u4ef6\uff0c\u83b7\u53d6 pci resource \u7684\u504f\u79fb\u4e0e\u5927\u5c0f\uff0c\u89e3\u6790\u5230 offset \u4e3a 0x0\uff0csize \u4e3a 0x1000\uff0c\u6253\u5f00 /dev/uio0 \u6587\u4ef6\uff0c\u901a\u8fc7 mmap \u6620\u5c04 pci resource \u5230\u7528\u6237\u6001\u4e2d\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"mmap \u6210\u529f\u540e\u5f97\u5230\u7684\u865a\u62df\u5730\u5740\u586b\u5145\u5230 rte_pci_device \u4e2d\u7684 mem_resource.addr \u4e2d\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a uio_res \u7ed3\u6784\uff0c\u4fdd\u5b58\u6620\u5c04\u540e\u7684\u865a\u62df\u5730\u5740\u4e0e offset\u3001size\uff0c\u5e76\u586b\u5145 path \u4e0e pci_addr \u552f\u4e00\u6807\u8bc6\u5230 uio_res \u7ed3\u6784\uff0c\u6700\u540e\u5c06\u6b64\u7ed3\u6784\u94fe\u5165\u5230 uio_res_list \u94fe\u8868\u4e2d\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"\u518d\u6b21\u56de\u5230 rte_eal_pci_probe_one_driver \u4e2d\uff0c\u8c03\u7528 pci_drv \u4e2d\u7684 devinit \u51fd\u6570\uff0c\u5373 rte_eth_dev_init \u51fd\u6570\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"rte_eth_dev_init \u51fd\u6570\u586b\u5145\u5f53\u524d\u63a5\u53e3\u7684 rte_eth_dev \u7ed3\u6784\u4f53\u540e\u8c03\u7528 eth_igb_dev_init \u51fd\u6570\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"eth_igb_dev_init \u51fd\u6570\u7ee7\u7eed\u521d\u59cb\u5316 rte_eth_dev \u7ed3\u6784\u4e2d\u4e0e\u9a71\u52a8\u76f8\u5173\u7684\u91cd\u8981\u6570\u636e\u7ed3\u6784\uff0c\u5c06 rte_eth_dev_init \u51fd\u6570\u4e2d\u521b\u5efa\u7684\u9a71\u52a8\u5185\u90e8\u6570\u636e\u7ed3\u6784\u5730\u5740 eth_dev->data->dev_private \u8f6c\u5316\u4e3a e1000_adapter \u7ed3\u6784\uff0c\u5e76\u83b7\u53d6 e1000_adpater \u7ed3\u6784\u4f53\u4e2d e1000_hw \u7684\u5730\u5740\uff0c\u5b8c\u6210\u540e\u5c06\u7b2c 10 \u6b65\u4e2d mmap \u5230\u7684 pci resource \u5730\u5740\u8d4b\u503c\u7ed9 hw->hw_addr \u7ed3\u6784\uff0c\u6b64\u540e\u8bfb\u5199\u7f51\u5361\u5bc4\u5b58\u5668\u90fd\u662f\u4ee5\u8fd9\u4e2a hw_addr \u4e3a\u57fa\u5730\u5740\u5b8c\u6210\u7684\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"eth_igb_dev_init \u5b8c\u6210\u786c\u4ef6\u521d\u59cb\u5316\u8fc7\u7a0b\u5e76\u6ce8\u518c\u4e2d\u65ad\u56de\u8c03\u51fd\u6570\u3002")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"dpdk \u7a0b\u5e8f\u7ee7\u7eed\u8c03\u7528 rte_ethdev.c \u4e2d\u5b9e\u73b0\u7684\u7f51\u5361\u63a7\u5236\u63a5\u53e3\uff0c\u914d\u7f6e\u7f51\u5361\u7684\u6536\u53d1\u961f\u5217\u5e76\u5c06\u63a5\u53e3 up \u8d77\u6765")),(0,_.kt)("li",{parentName:"ol"},(0,_.kt)("p",{parentName:"li"},"dpdk \u7a0b\u5e8f\u5b8c\u6210\u63a5\u53e3\u7684\u914d\u7f6e\u540e\uff0c\u6d3e\u53d1\u81ea\u5df1\u5b9e\u73b0\u7684 loop \u51fd\u6570\u5230\u6bcf\u4e2a\u4f7f\u80fd\u7684 lcore \u7ebf\u7a0b\u4e0a\uff0c\u6267\u884c\u6536\u53d1\u5305\u8fc7\u7a0b\u3002"))),(0,_.kt)("h3",{id:"\u603b\u7ed3-v123-r0-\u7248\u672c\u7528\u6237\u6001\u9a71\u52a8\u6846\u67b6\u5173\u952e\u77e5\u8bc6\u4e0e\u9690\u542b\u95ee\u9898"},"\u603b\u7ed3 v1.2.3 r0 \u7248\u672c\u7528\u6237\u6001\u9a71\u52a8\u6846\u67b6\u5173\u952e\u77e5\u8bc6\u4e0e\u9690\u542b\u95ee\u9898"),(0,_.kt)("ol",null,(0,_.kt)("li",{parentName:"ol"},"v1.2.3 r0 \u7248\u672c\u901a\u8fc7 mmap /dev/uio \u6587\u4ef6\u6765\u6620\u5c04 pci resource \u8d44\u6e90"),(0,_.kt)("li",{parentName:"ol"},"v1.2.3 r0 \u7248\u672c\u9700\u8981\u663e\u5f0f\u8c03\u7528\u6bcf\u4e2a\u9a71\u52a8\u7684\u6ce8\u518c\u51fd\u6570\uff0c\u6269\u5c55\u6027\u8f83\u5dee\uff0c\u8fd9\u79cd\u67b6\u6784\u4e0b\u6bcf\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7c7b\u522b\u7684\u9a71\u52a8\uff0cdpdk \u7a0b\u5e8f\u9700\u8981\u4fee\u6539\u6e90\u7801\u540e\u91cd\u65b0\u7f16\u8bd1"),(0,_.kt)("li",{parentName:"ol"},"rte_eth_driver\u3001rte_pci_driver \u4e2d\u53ea\u6709\u521d\u59cb\u5316\u51fd\u6570\uff0c\u6ca1\u6709\u89e3\u521d\u59cb\u5316\u51fd\u6570\uff0c\u7f3a\u5c11\u4e3b\u52a8\u91ca\u653e\u8d44\u6e90\u7684\u8fc7\u7a0b"),(0,_.kt)("li",{parentName:"ol"},"\u6b64\u7248\u672c\u4ec5\u652f\u6301 pci \u9a71\u52a8\uff0c\u6ca1\u6709\u62bd\u8c61\u51fa bus \u5c42\uff0cbus \u5c42\u529f\u80fd\u96f6\u6563\u5206\u5e03\u5728\u626b\u63cf pci \u8bbe\u5907\u4e0e probe \u8bbe\u5907\u8fc7\u7a0b\u4e2d\uff0c\u4e0d\u592a\u5408\u7406"),(0,_.kt)("li",{parentName:"ol"},"\u7f3a\u5c11 ethtool\u3001ifconfig \u7b49 linux \u4e2d\u4f20\u7edf\u7f51\u7edc\u63a5\u53e3\u63a7\u5236\u547d\u4ee4\u7684\u66ff\u4ee3\u5de5\u5177")),(0,_.kt)("p",null,"\u4ee5\u4e0a\u51e0\u4e2a\u95ee\u9898\u5728\u540e\u7eed\u7248\u672c\u4e2d\u6e10\u6e10\u5b8c\u5584\uff0c\u4e0b\u9762\u6211\u5c06\u5bf9\u540e\u7eed\u7248\u672c\u4e2d\u7684\u4e00\u4e9b\u5173\u952e\u4fee\u6539\u8fdb\u884c\u63cf\u8ff0\u3002"),(0,_.kt)("h2",{id:"dpdk-v140r0-\u7248\u672c"},"dpdk v1.4.0r0 \u7248\u672c"),(0,_.kt)("p",null,"\u6b64\u7248\u672c\u89e3\u51b3\u4e86\u663e\u5f0f\u8c03\u7528\u6bcf\u4e2a\u9a71\u52a8\u6ce8\u518c\u51fd\u6570\u7684\u95ee\u9898\uff0c\u5411\u5916\u754c\u63d0\u4f9b\u4e86 rte_pmd_init_all \u63a5\u53e3\uff0c\u9002\u914d\u65b0\u7684\u9a71\u52a8\u65f6\uff0c\u4e0d\u9700\u8981\u4fee\u6539\u4e0a\u5c42\u7a0b\u5e8f\u7684\u4ee3\u7801\uff0c\u53ea\u9700\u8981\u91cd\u65b0\u94fe\u63a5\u65b0\u7684 dpdk \u5373\u53ef\u3002"),(0,_.kt)("p",null,"rte_pmd_init_all \u51fd\u6570\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,_.kt)("pre",null,(0,_.kt)("code",{parentName:"pre",className:"language-c"},'static inline\nint rte_pmd_init_all(void)\n{\n    int ret = -ENODEV;\n\n#ifdef RTE_LIBRTE_IGB_PMD\n    if ((ret = rte_igb_pmd_init()) != 0) {\n        RTE_LOG(ERR, PMD, "Cannot init igb PMD\\n");\n        return (ret);\n    }\n    if ((ret = rte_igbvf_pmd_init()) != 0) {\n        RTE_LOG(ERR, PMD, "Cannot init igbvf PMD\\n");\n        return (ret);\n    }\n#endif /* RTE_LIBRTE_IGB_PMD */\n\n#ifdef RTE_LIBRTE_EM_PMD\n    if ((ret = rte_em_pmd_init()) != 0) {\n        RTE_LOG(ERR, PMD, "Cannot init em PMD\\n");\n        return (ret);\n    }\n#endif /* RTE_LIBRTE_EM_PMD */\n\n#ifdef RTE_LIBRTE_IXGBE_PMD\n    if ((ret = rte_ixgbe_pmd_init()) != 0) {\n        RTE_LOG(ERR, PMD, "Cannot init ixgbe PMD\\n");\n        return (ret);\n    }\n    if ((ret = rte_ixgbevf_pmd_init()) != 0) {\n        RTE_LOG(ERR, PMD, "Cannot init ixgbevf PMD\\n");\n        return (ret);\n    }\n#endif /* RTE_LIBRTE_IXGBE_PMD */\n\n    if (ret == -ENODEV)\n        RTE_LOG(ERR, PMD, "No PMD(s) are configured\\n");\n    return (ret);\n}\n')),(0,_.kt)("p",null,"\u8fd9\u4e2a\u7248\u672c\u589e\u52a0\u4e86\u5bf9 e1000 \u4e0e igb vf\u3001ixgbe vf \u9a71\u52a8\u7684\u652f\u6301\uff0cpci resource \u5730\u5740\u4ecd\u65e7\u901a\u8fc7 mmap /dev/uioX \u6587\u4ef6\u6765\u5b8c\u6210\u3002"),(0,_.kt)("h2",{id:"dpdk-v150r0-\u7248\u672c"},"dpdk v1.5.0r0 \u7248\u672c"),(0,_.kt)("p",null,"\u6b64\u7248\u672c\u589e\u52a0\u4e86\u66f4\u591a\u7684 pmd \u9a71\u52a8\uff0c\u589e\u52a0\u4e86\u5bf9\u8bf8\u5982 pcap \u7b49\u975e pci \u7f51\u5361\u9a71\u52a8\u7684\u652f\u6301\u3002\u975e pci \u7f51\u5361\u9a71\u52a8\u6709\u5355\u72ec\u7684\u521d\u59cb\u5316\u51fd\u6570 rte_eal_non_pci_ethdev_init\uff0c\u6b64\u51fd\u6570\u5728 rte_eal_init \u51fd\u6570\u4e2d\u88ab\u8c03\u7528\u3002"),(0,_.kt)("p",null,"\u5176\u6e90\u7801\u5982\u4e0b\uff1a"),(0,_.kt)("pre",null,(0,_.kt)("code",{parentName:"pre",className:"language-c"},'int\nrte_eal_non_pci_ethdev_init(void)\n{\n    uint8_t i, j;\n    for (i = 0; i < NUM_DEV_TYPES; i++) {\n        for (j = 0; j < RTE_MAX_ETHPORTS; j++) {\n            const char *params;\n            char buf[16];\n            rte_snprintf(buf, sizeof(buf), "%s%"PRIu8,\n                    dev_types[i].dev_prefix, j);\n            if (eal_dev_is_whitelisted(buf, &params))\n                dev_types[i].init_fn(buf, params);\n        }\n    }\n    return 0;\n}\n')),(0,_.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\u5b83\u5b9e\u9645\u662f\u901a\u8fc7\u904d\u5386 dev_types \u8fd9\u4e2a\u6570\u7ec4\u6765\u521d\u59cb\u5316\u7684\uff0c\u5176\u5b83\u7684\u53c2\u6570\u901a\u8fc7\u547d\u4ee4\u884c\u83b7\u53d6\u3002"),(0,_.kt)("p",null,"dev_types \u6570\u7ec4\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,_.kt)("pre",null,(0,_.kt)("code",{parentName:"pre",className:"language-c"},'struct device_init dev_types[] = {\n#ifdef RTE_LIBRTE_PMD_RING\n        {\n            .dev_prefix = RTE_ETH_RING_PARAM_NAME,\n            .init_fn = rte_pmd_ring_init\n        },\n#endif\n#ifdef RTE_LIBRTE_PMD_PCAP\n        {\n            .dev_prefix = RTE_ETH_PCAP_PARAM_NAME,\n            .init_fn = rte_pmd_pcap_init\n        },\n#endif\n        {\n            .dev_prefix = "-nodev-",\n            .init_fn = NULL\n        }\n};\n')),(0,_.kt)("p",null,"dev_prefix \u7528\u4e8e\u6807\u8bc6 vdev \u9a71\u52a8\uff0cinit_fn \u662f\u9a71\u52a8\u7684\u521d\u59cb\u5316\u51fd\u6570\u3002\u8fd9\u6837\u7684\u5b9e\u73b0\u5b58\u5728\u7684\u95ee\u9898\u662f vdev \u4e0e pci \u7b49\u7269\u7406\u7f51\u5361\u9a71\u52a8\u7684\u6ce8\u518c\u4e0e\u521d\u59cb\u5316\u8fc7\u7a0b\u6ca1\u6709\u7edf\u4e00\uff0c\u9700\u8981\u4e00\u4e2a\u65b0\u7684\u62bd\u8c61\u5c42\u6b21\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002"),(0,_.kt)("p",null,"\u540c\u65f6\uff0c\u8fd9\u4e2a\u7248\u672c\u5f15\u5165\u4e86 kni \u6a21\u5757\uff0c\u5f53\u4f7f\u7528\u4e86 kni \u6a21\u5757\u540e\uff0c\u652f\u6301\u901a\u8fc7 ethtool\u3001ifconfig \u8fd9\u4e9b\u6807\u51c6\u547d\u4ee4\u63a7\u5236\u7f51\u5361\u63a5\u53e3\uff0c\u5f25\u8865\u4e86\u73b0\u6709\u5de5\u5177\u7684\u4e0d\u8db3\uff0c\u540c\u65f6\u4e5f\u6253\u901a\u4e86 dpdk \u7a0b\u5e8f\u4e0e\u5185\u6838\u534f\u8bae\u6808\u7684\u4ea4\u4e92\u8fc7\u7a0b\u3002"),(0,_.kt)("p",null,"kni \u652f\u6301 ethtool \u83b7\u53d6\u6570\u636e\u5b9e\u8d28\u4e0a\u662f\u7ef4\u62a4\u4e86\u4e00\u5957\u5185\u6838\u6001\u7684\u9a71\u52a8\uff0c\u540c\u65f6\u4e3a\u4e86\u907f\u514d\u4e0e\u7528\u6237\u6001\u540c\u65f6\u4f7f\u7528\u9020\u6210\u95ee\u9898\uff0c\u5bf9\u5185\u6838\u9a71\u52a8\u8fdb\u884c\u4e86\u4e00\u7cfb\u5217\u5b9a\u5236\u5316\u4fee\u6539\uff0c\u5e26\u6765\u65b0\u529f\u80fd\u7684\u540c\u65f6\u4e5f\u5f15\u5165\u4e86\u65b0\u7684\u95ee\u9898\u3002"),(0,_.kt)("h2",{id:"dpdk-v170"},"dpdk v1.7.0"),(0,_.kt)("p",null,"v1.7.0 \u5bf9\u7528\u6237\u6001\u9a71\u52a8\u67b6\u6784\u8fdb\u884c\u4e86\u8f83\u5927\u5e45\u5ea6\u7684\u8c03\u6574\uff0c\u62bd\u8c61\u51fa\u4e86\u4e00\u4e2a rte_driver \u7ed3\u6784\u6765\u5c4f\u853d vdev \u4e0e pdev \u7684\u5dee\u522b\uff0c\u7edf\u4e00\u4e86\u6ce8\u518c\u8fc7\u7a0b\u3002"),(0,_.kt)("p",null,"\u540c\u65f6\u4e5f\u5254\u9664\u4e86\u663e\u5f0f\u8c03\u7528\u9a71\u52a8\u6ce8\u518c\u51fd\u6570\u7684\u5b9e\u73b0\uff0c\u6539\u4e3a\u901a\u8fc7 gcc \u7684 constructor \u5c5e\u6027\u5728 main \u51fd\u6570\u6267\u884c\u524d\u81ea\u52a8\u6ce8\u518c\uff0c\u540c\u65f6 probe \u7684\u903b\u8f91\u4e5f\u5408\u5e76\u5230\u4e86 rte_eal_init \u51fd\u6570\u4e2d\u8c03\u7528\uff0c\u4e0a\u5c42\u7a0b\u5e8f\u5bf9\u5e95\u5c42\u9a71\u52a8\u7684\u6ce8\u518c\u4e0e probe \u8fc7\u7a0b\u5b8c\u5168\u4e0d\u611f\u77e5\u3002"),(0,_.kt)("h3",{id:"rte_driver-\u7ed3\u6784"},"rte_driver \u7ed3\u6784"),(0,_.kt)("p",null,"rte_driver \u7ed3\u6784\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a"),(0,_.kt)("pre",null,(0,_.kt)("code",{parentName:"pre",className:"language-c"},"struct rte_driver {\n    TAILQ_ENTRY(rte_driver) next;  /**< Next in list. */\n    enum pmd_type type;        /**< PMD Driver type */\n    const char *name;                   /**< Driver name. */\n    rte_dev_init_t *init;              /**< Device init. function. */\n};\n")),(0,_.kt)("p",null,"next \u5b57\u6bb5\u5c06\u4e0d\u540c\u7684 rte_driver \u94fe\u8d77\u6765\uff0ctype \u5b57\u6bb5\u7528\u4e8e\u533a\u5206 PMD \u9a71\u52a8\u7684\u7c7b\u578b\uff0c\u5982 PDEV\u3001VDEV\u3001BDEV\uff0cinit \u51fd\u6570\u662f\u5bf9\u8001\u7248\u672c\u6bcf\u4e2a\u9a71\u52a8\u7684\u6ce8\u518c\u51fd\u6570\u7684\u62bd\u8c61\u3002"),(0,_.kt)("p",null,"igb pmd \u9a71\u52a8\u5b9e\u4f8b\u5316\u7684\u7ed3\u6784\u5982\u4e0b\uff1a"),(0,_.kt)("pre",null,(0,_.kt)("code",{parentName:"pre",className:"language-c"},"3061 static struct rte_driver pmd_igb_drv = {\n3062     .type = PMD_PDEV,\n3063     .init = rte_igb_pmd_init,\n3064 };\n")),(0,_.kt)("p",null,"\u8bbe\u5b9a type \u4e3a PMD_PDEV \u8868\u793a\u8fd9\u662f\u4e00\u4e2a\u7269\u7406\u7f51\u5361\u9a71\u52a8\uff0cinit \u51fd\u6570\u6307\u5411 rte_igb_pmd_init\uff0crte_igb_pmd_init \u672c\u8eab\u5b8c\u6210\u81ea\u8001\u7248\u672c\u7ee7\u627f\u7684 eth_driver \u9a71\u52a8\u7684\u6ce8\u518c\uff0c\u8fd9\u91cc\u4e3a\u4e86\u5b9e\u73b0\u4e0e VDEV \u9a71\u52a8\u6ce8\u518c\u8fc7\u7a0b\u7684\u7edf\u4e00\uff0c\u5728\u6bcf\u4e2a PDEV \u9a71\u52a8\u4e2d\u4f7f\u7528 eth_driver \u9a71\u52a8\u7684\u6ce8\u518c\u63a5\u53e3\u5b9e\u4f8b\u5316\u4e00\u4e2a rte_driver \u7ed3\u6784\uff0c\u5c06\u6b64\u7ed3\u6784\u5728 main \u51fd\u6570\u4e4b\u524d\u6ce8\u518c\u5230 dev_driver_list \u94fe\u8868\u4e2d\u3002"),(0,_.kt)("p",null,"\u5f53 main \u51fd\u6570\u6267\u884c\u65f6\uff0cdev_driver_list \u94fe\u8868\u4e2d\u4fdd\u5b58\u4e86\u6240\u6709\u6ce8\u518c\u7684 rte_driver \u9a71\u52a8\uff0c\u8fd9\u4e9b rte_driver \u9a71\u52a8\u80fd\u591f\u5206\u4e3a\u4e09\u4e2a\u7c7b\u522b\uff1a"),(0,_.kt)("ol",null,(0,_.kt)("li",{parentName:"ol"},"PDEV \u6807\u5fd7\u7684 pci \u7269\u7406\u8bbe\u5907\u9a71\u52a8\u5b9e\u4f8b\u5316\u7684 rte_driver"),(0,_.kt)("li",{parentName:"ol"},"VDEV \u6807\u5fd7\u7684\u865a\u62df\u8bbe\u5907\u9a71\u52a8\u5b9e\u4f8b\u5316\u7684 rte_driver"),(0,_.kt)("li",{parentName:"ol"},"BDEV \u6807\u5fd7 bond \u865a\u62df\u8bbe\u5907\u9a71\u52a8\u5b9e\u4f8b\u5316\u7684 rte_driver")),(0,_.kt)("h3",{id:"vdev-\u7c7b\u9a71\u52a8"},"VDEV \u7c7b\u9a71\u52a8"),(0,_.kt)("p",null,"VDEV \u7c7b\u9a71\u52a8\u7684\u4ee3\u8868\u662f pcap \u9a71\u52a8\uff0c\u5176 rte_driver \u7ed3\u6784\u5982\u4e0b\uff1a"),(0,_.kt)("pre",null,(0,_.kt)("code",{parentName:"pre",className:"language-c"},'static struct rte_driver pmd_pcap_drv = {\n    .name = "eth_pcap",\n    .type = PMD_VDEV,\n    .init = rte_pmd_pcap_devinit,\n};\n')),(0,_.kt)("p",null,"type \u4e3a PMD_VDEV \u8868\u793a\u8fd9\u662f\u4e2a\u865a\u62df\u7f51\u5361\u9a71\u52a8\uff0crte_pmd_pcap_devinit \u51fd\u6570\u5b9e\u9645\u4e0a\u5c31\u662f\u6b64\u9a71\u52a8\u7684\u521d\u59cb\u5316\u51fd\u6570\uff0c\u5e76\u4e0d\u9700\u8981\u518d\u8fdb\u884c\u4efb\u4f55\u7684\u6ce8\u518c\u8fc7\u7a0b\u3002"),(0,_.kt)("h3",{id:"pdev-\u7c7b\u9a71\u52a8"},"PDEV \u7c7b\u9a71\u52a8"),(0,_.kt)("p",null,"PDEV \u7c7b\u9a71\u52a8\u7684\u4ee3\u8868\u662f igb \u9a71\u52a8\uff0c\u8fd9\u7c7b\u9a71\u52a8\u5b9e\u4f8b\u5316\u7684 rte_driver \u7ed3\u6784\u4e2d\u7684 init \u51fd\u6570\u672c\u8eab\u53c8\u662f\u4e00\u4e2a\u6ce8\u518c eth_driver \u9a71\u52a8\u7684\u51fd\u6570\uff0c\u8fd9\u5c31\u5c06\u539f\u6765 PDEV \u7c7b\u9a71\u52a8\u7684\u6ce8\u518c\u8fc7\u7a0b\u590d\u6742\u5316\u4e86\uff0c\u662f\u7edf\u4e00\u63a5\u53e3\u5e26\u6765\u7684\u4e00\u4e9b\u574f\u5904\u3002"),(0,_.kt)("p",null,"\u8fd9\u65f6\u5019 PDEV \u7c7b\u9a71\u52a8\u7684\u6ce8\u518c\u8fc7\u7a0b\u53ef\u4ee5\u603b\u7ed3\u4e3a\u5982\u4e0b\u6b65\u9aa4\uff1a"),(0,_.kt)("ol",null,(0,_.kt)("li",{parentName:"ol"},"\u5b9e\u4f8b\u5316 rte_driver \u7ed3\u6784\uff0c\u5e76\u5c06 init \u51fd\u6570\u8bbe\u5b9a\u4e3a eth_driver \u51fd\u6570\u7684\u6ce8\u518c\u51fd\u6570"),(0,_.kt)("li",{parentName:"ol"},"\u901a\u8fc7 PMD_REGISTER_DRIVER \u5b8f\u6ce8\u518c rte_driver \u7ed3\u6784\uff0c\u6b64\u7ed3\u6784\u5728 main \u51fd\u6570\u6267\u884c\u524d\u88ab\u6ce8\u518c\u5230 dev_driver_list \u94fe\u8868\u4e2d"),(0,_.kt)("li",{parentName:"ol"},"rte_eal_init \u4e2d\u904d\u5386 dev_driver_list \u94fe\u8868\u8c03\u7528 PDEV \u9a71\u52a8\u4e2d\u6ce8\u518c eth_driver \u7ed3\u6784\u7684\u51fd\u6570\uff0c\u5b8c\u6210\u4e0e\u8001\u7248\u672c\u76f8\u540c\u7684\u6ce8\u518c\u6d41\u7a0b")),(0,_.kt)("p",null,"PMD_REGISTER_DRIVER \u5b8f\u7684\u539f\u7406\u8be6\u89c1\uff1a",(0,_.kt)("a",{parentName:"p",href:"https://blog.csdn.net/Longyu_wlz/article/details/113725959?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161961368916780357248787%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=161961368916780357248787&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v2~rank_v29-1-113725959.pc_v2_rank_blog_default&utm_term=%E6%9E%84%E9%80%A0"},"gcc constructor \u5c5e\u6027\u4fee\u9970\u7684\u6784\u9020\u51fd\u6570\u672a\u88ab\u94fe\u63a5\u95ee\u9898")),(0,_.kt)("h3",{id:"bdev-\u7c7b\u9a71\u52a8"},"BDEV \u7c7b\u9a71\u52a8"),(0,_.kt)("p",null,"1.7.0 \u4e2d\u5b9e\u73b0\u4e86 bond \u865a\u62df\u63a5\u53e3\u9a71\u52a8\uff0cbond \u9a71\u52a8\u5b8c\u5168\u662f\u8f6f\u4ef6\u5b9e\u73b0\uff0c\u4f46\u662f\u6700\u521d\u7684\u7248\u672c\u9700\u8981\u5c06 bond \u9a71\u52a8\u521d\u59cb\u5316\u8fc7\u7a0b\u653e\u5728 pci \u8bbe\u5907 probe \u4e4b\u540e\u6765\u5b8c\u6210\u5176\u529f\u80fd\uff0c\u8fd9\u79cd\u7279\u6b8a\u7684\u4f9d\u8d56\u5173\u7cfb\u50ac\u751f\u4e86 BDEV \u7c7b\u9a71\u52a8\uff0c\u4e0d\u8fc7\u8fd9\u53ea\u662f\u4e00\u4e2a\u4e2d\u95f4\u7684\u8fc7\u6e21\u7248\u672c\uff0c\u540e\u9762\u7684\u7248\u672c\u89e3\u51b3\u4e86\u8fd9\u4e2a\u95ee\u9898\uff0cBDEV \u4e0e VDEV \u521d\u59cb\u5316\u8fc7\u7a0b\u5f97\u5230\u4e86\u7edf\u4e00\u3002"),(0,_.kt)("h3",{id:"rte_eal_dev_init-\u51fd\u6570"},"rte_eal_dev_init \u51fd\u6570"),(0,_.kt)("p",null,"1.7.0 \u7248\u672c\u5b9e\u73b0\u4e86\u9a71\u52a8\u7684\u81ea\u52a8\u6ce8\u518c\u8fc7\u7a0b\uff0c\u8fd9\u4e00\u8fc7\u7a0b\u53ef\u4ee5\u5206\u4e3a\u4e24\u4e2a\u9636\u6bb5\uff0c\u7b2c\u4e00\u4e2a\u9636\u6bb5\u662f\u6784\u9020\u51fd\u6570\u6267\u884c\u9636\u6bb5\uff0c\u7b2c\u4e8c\u9636\u6bb5\u662f pci \u9a71\u52a8\u7684\u6ce8\u518c\u8fc7\u7a0b\u3002"),(0,_.kt)("p",null,"\u7b2c\u4e8c\u9636\u6bb5\u7684\u6ce8\u518c\u8fc7\u7a0b\u4e0e\u9a71\u52a8\u7684 probe \u8fc7\u7a0b\u90fd\u5408\u5e76\u5230\u4e86 rte_eal_init \u51fd\u6570\u4e2d\uff0c\u4e0a\u5c42\u7a0b\u5e8f\u5b8c\u5168\u4e0d\u611f\u77e5\u3002"),(0,_.kt)("p",null,"rte_eal_init \u51fd\u6570\u8c03\u7528 rte_eal_dev_init \u51fd\u6570\u5b8c\u6210 VDEV \u8bbe\u5907\u7684\u521d\u59cb\u5316\u4ee5\u53ca pci \u9a71\u52a8\u7684\u6ce8\u518c\u8fc7\u7a0b\uff0c\u7531\u4e8e BOND \u9a71\u52a8\u7684\u7279\u6b8a\u6027\uff0crte_eal_dev_init \u4e5f\u88ab\u5212\u5206\u4e3a\u4e86\u4e24\u4e2a\u9636\u6bb5\u3002"),(0,_.kt)("p",null,"PMD_INIT_PRE_PCI_PROBE \u9636\u6bb5\u521d\u59cb\u5316\u90a3\u4e9b\u4e0d\u4f9d\u8d56 pci \u7f51\u5361\u7684 VDEV \u8bbe\u5907\uff0c\u8fd9\u4e00\u9636\u6bb5\u5728 pci \u8bbe\u5907 probe \u4e4b\u524d\u6267\u884c\uff0cPMD_INIT_POST_PCI_PROBE \u9636\u6bb5\u4ec5\u7528\u4e8e bond \u8bbe\u5907\u521d\u59cb\u5316\u3002"),(0,_.kt)("h3",{id:"igb_uio-\u4e2d\u79fb\u9664-pci-id-table"},"igb_uio \u4e2d\u79fb\u9664 pci id table"),(0,_.kt)("p",null,"1.7.0 \u7248\u672c\u4e2d igb_uio \u6a21\u5757\u6ce8\u518c\u7684 pci \u9a71\u52a8\u79fb\u9664\u4e86 pci id table\uff0c\u6b64\u65f6\u7ed1\u5b9a\u7f51\u5361\u5230 igb_uio \u9700\u8981\u5148\u5c06\u7f51\u5361\u7684 vendor id \u4e0e device id \u62fc\u63a5\u5f97\u5230\u7684\u5b57\u7b26\u4e32\u5199\u5165\u5230 igb_uio \u5728 /sys \u5b50\u76ee\u5f55\u4e2d\u7684 new_id \u6587\u4ef6\u4e2d\u624d\u80fd\u8fdb\u884c\u7ed1\u5b9a\u3002"),(0,_.kt)("h3",{id:"vfio-\u6a21\u5757\u7684\u652f\u6301"},"VFIO \u6a21\u5757\u7684\u652f\u6301"),(0,_.kt)("p",null,"v1.7.0 \u9664\u4e86\u652f\u6301 igb_uio \u8fd9\u79cd\u6807\u51c6\u7684 uio \u6620\u5c04 pci \u8d44\u6e90\u7a7a\u95f4\u4e0e\u4e2d\u65ad\u5230\u7528\u6237\u6001\u5916\uff0c\u4e5f\u652f\u6301 vfio \u6a21\u5757\u3002"),(0,_.kt)("p",null,"\u6211\u5bf9 vfio \u8fd9\u5757\u6ca1\u6709\u6df1\u5165\u7814\u7a76\uff0c\u4e0d\u8fdb\u4e00\u6b65\u63cf\u8ff0\u4e86\u3002"),(0,_.kt)("h2",{id:"v180"},"v1.8.0"),(0,_.kt)("p",null,"\u6b64\u7248\u672c\u89e3\u51b3\u4e86 bond \u529f\u80fd\u7684\u9650\u5236\uff0c\u7edf\u4e00\u4e86\u6240\u6709 VDEV \u7684\u521d\u59cb\u5316\u8fc7\u7a0b\u3002"),(0,_.kt)("h2",{id:"dpdk-1604"},"dpdk-16.04"),(0,_.kt)("p",null,"dpdk-16.04 \u7528\u6237\u6001\u9a71\u52a8\u67b6\u6784\u4e3b\u4f53\u7ee7\u7eed\u6cbf\u7528 v1.8.0 \u7248\u672c\u4ee3\u7801\uff0c\u5728\u7edf\u4e00 linux \u5e73\u53f0\u4e0e bsd \u5e73\u53f0 uio \u51fd\u6570\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4fee\u6539\u4e86 pci resource \u7684\u6620\u5c04\u903b\u8f91\uff0c\u4e0d\u518d\u901a\u8fc7 mmap /dev/uiox \u6587\u4ef6\u6765\u5b8c\u6210\u3002"),(0,_.kt)("p",null,"\u5177\u4f53\u7684\u539f\u7406\u53ef\u4ee5\u9605\u8bfb ",(0,_.kt)("a",{parentName:"p",href:"https://blog.csdn.net/Longyu_wlz/article/details/115956761?spm=1001.2014.3001.5501"},"dpdk-16.04 igb_uio \u6a21\u5757\u5206\u6790")," \u3002"),(0,_.kt)("p",null,"dpdk-16.04 \u4e2d\u9488\u5bf9\u6807\u51c6 viritio \u9a71\u52a8\u8bbf\u95ee io \u7aef\u53e3\u7684\u9700\u6c42\u5b9e\u73b0\u4e86 rte_eal_pci_ioport_map \u7b49 ioport \u76f8\u5173\u7684\u51fd\u6570\u63a5\u53e3\uff0c\u5f53 virtio \u7f51\u5361\u88ab\u7ed1\u5b9a\u5230 igb_uio \u65f6\uff0cioport \u7684\u57fa\u5730\u5740\u901a\u8fc7\u8bbf\u95ee /sys \u76ee\u5f55\u4e2d virtio \u8bbe\u5907\u5b50\u76ee\u5f55\u4e2d uio \u5b50\u76ee\u5f55\u4e2d\u7684 port \u63a5\u53e3\u6765\u83b7\u53d6\u3002"),(0,_.kt)("p",null,"vtpci_init \u51fd\u6570\u4e2d\u8c03\u7528 legacy_virtio_resource_init \u51fd\u6570\u6765 map virtio ioport\uff0c\u6b64\u8fc7\u7a0b\u5b9e\u9645\u4e0a\u662f\u901a\u8fc7\u8c03\u7528 rte_eal_pci_ioport_map \u51fd\u6570\u5b8c\u6210\u7684\u3002"),(0,_.kt)("p",null,"\u6b64\u51fd\u6570\u6e90\u7801\u5982\u4e0b\uff1a"),(0,_.kt)("pre",null,(0,_.kt)("code",{parentName:"pre",className:"language-c"},"int\nrte_eal_pci_ioport_map(struct rte_pci_device *dev, int bar,\n               struct rte_pci_ioport *p)\n{\n    int ret = -1;\n\n    switch (dev->kdrv) {\n#ifdef VFIO_PRESENT\n    case RTE_KDRV_VFIO:\n        if (pci_vfio_is_enabled())\n            ret = pci_vfio_ioport_map(dev, bar, p);\n        break;\n#endif\n    case RTE_KDRV_IGB_UIO:\n        ret = pci_uio_ioport_map(dev, bar, p);\n        break;\n    case RTE_KDRV_UIO_GENERIC:\n#if defined(RTE_ARCH_X86)\n        ret = pci_ioport_map(dev, bar, p);\n#else\n        ret = pci_uio_ioport_map(dev, bar, p);\n#endif\n        break;\n    case RTE_KDRV_NONE:\n#if defined(RTE_ARCH_X86)\n        ret = pci_ioport_map(dev, bar, p);\n#endif\n        break;\n    default:\n        break;\n    }\n\n    if (!ret)\n        p->dev = dev;\n\n    return ret;\n}\n")),(0,_.kt)("p",null,"\u5f53 virtio \u7ed1\u5b9a\u5230 igb_uio \u7684\u65f6\u5019\u8c03\u7528 pci_uio_ioport_map \u6765\u83b7\u53d6 ioport \u7684\u57fa\u5730\u5740\uff0cpci_uio_ioport_map \u901a\u8fc7\u8bbf\u95ee\u5e76\u89e3\u6790 /sys/bus/pci/devices/0000:xx:xx.x/uio/uioX/portio/portX/start \u6587\u4ef6\u6765\u5b8c\u6210\uff0cstart \u6587\u4ef6\u7684\u503c\u5373\u4e3a portio \u7684\u57fa\u5730\u5740\u3002"),(0,_.kt)("h2",{id:"dpdk-17x-bus-\u62bd\u8c61\u5c42\u7684\u5f15\u5165"},"dpdk 17.x bus \u62bd\u8c61\u5c42\u7684\u5f15\u5165"),(0,_.kt)("p",null,"dpdk 17.x \u7248\u672c\u6700\u521d\u5408\u5165\u4e86 nxp \u516c\u53f8\u7684 fsl-mc bus driver\uff0c\u5728\u6b64\u57fa\u7840\u4e0a\uff0cbus \u62bd\u8c61\u5c42\u4e0d\u65ad\u5b8c\u5584\uff0c\u6700\u7ec8 pci\u3001vdev bus \u4e5f\u5f97\u5230\u4e86\u652f\u6301\uff0c\u7528\u6237\u6001\u9a71\u52a8\u67b6\u6784\u7684\u4f7f\u7528\u573a\u666f\u8fdb\u4e00\u6b65\u62d3\u5bbd\uff0c\u65e7\u7684\u67b6\u6784\u88ab\u91cd\u6784\uff0c\u65b0\u6846\u67b6\u590d\u6742\u6027\u8fdb\u4e00\u6b65\u589e\u52a0\u3002"),(0,_.kt)("p",null,"\u76ee\u524d\u8fd8\u6ca1\u6709\u6df1\u5165\u7814\u7a76\uff0c\u672a\u6765\u5355\u72ec\u5199\u4e00\u7bc7\u535a\u5ba2\u63cf\u8ff0\u65b0\u7248\u672c bus \u6846\u67b6\u4e0b\u7528\u6237\u6001\u9a71\u52a8\u7684\u67b6\u6784\u3002"),(0,_.kt)("h2",{id:"\u603b\u7ed3"},"\u603b\u7ed3"),(0,_.kt)("p",null,"\u672c\u6587\u4ece\u8001\u7248\u672c dpdk \u7740\u624b\uff0c\u63cf\u8ff0\u4e86\u5728\u7248\u672c\u6f14\u8fdb\u8fc7\u7a0b\u4e2d dpdk \u7528\u6237\u6001\u9a71\u52a8\u67b6\u6784\u7684\u6f14\u53d8\u8fc7\u7a0b\u3002"),(0,_.kt)("p",null,"\u7528\u6237\u6001\u9a71\u52a8\u67b6\u6784\u662f dpdk \u975e\u5e38\u6838\u5fc3\u7684\u8bbe\u8ba1\uff0c\u5bf9\u5b83\u7684\u7814\u7a76\u662f\u6211\u4eec\u4e0e\u8bbe\u8ba1\u8005\u5bf9\u8bdd\u7684\u8fc7\u7a0b\u3002\u4ece\u672c\u6587\u7684\u5206\u6790\u4e2d\u80fd\u591f\u770b\u51fa\u8fd9\u4e00\u5957\u6846\u67b6\u5e76\u4e0d\u662f\u4ece\u4e00\u5f00\u59cb\u5c31\u8fd9\u6837\u590d\u6742\uff0c\u5c31\u80fd\u591f\u517c\u5bb9\u591a\u79cd\u573a\u666f\u5e76\u5177\u5907\u9ad8\u5ea6\u7684\u53ef\u6269\u5c55\u6027\uff0c\u8fd9\u4e9b\u5143\u7d20\u662f\u5728\u7a0b\u5e8f\u7684\u8fed\u4ee3\u4e2d\u4e0d\u65ad\u4f18\u5316\u7684\u3002\u4e0d\u540c\u7684\u67b6\u6784\u6709\u81ea\u5df1\u652f\u6301\u7684\u7279\u5b9a\u573a\u666f\uff0c\u6211\u4eec\u4e5f\u5e94\u8be5\u4ee5\u53d8\u5316\u7684\u89d2\u5ea6\u6765\u770b\u5f85\u4e0d\u540c\u7248\u672c\u7684\u4f18\u52a3\u4e4b\u5904\u3002"),(0,_.kt)("p",null,"dpdk \u7684\u5e94\u7528\u573a\u666f\u5c31\u662f\u4e00\u79cd\u73af\u5883\uff0c\u73af\u5883\u7684\u53d8\u5316\u50ac\u5316\u4e86\u7a0b\u5e8f\u5185\u90e8\u67b6\u6784\u7684\u4e0d\u65ad\u91cd\u6784\uff0c\u6211\u4eec\u4e0d\u4e5f\u5728\u7ecf\u5386\u7c7b\u4f3c\u7684\u8fc7\u7a0b\u5417\uff1f\u6838\u5fc3\u53ea\u662f\u73af\u5883\u4e0d\u540c\u7f62\u4e86\uff01"))}u.isMDXComponent=!0}}]);