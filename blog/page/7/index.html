<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/longyu.github.io/blog/rss.xml" title="龙瑜的文字世界 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/longyu.github.io/blog/atom.xml" title="龙瑜的文字世界 Atom Feed"><title data-rh="true">龙瑜的博客 | 龙瑜的文字世界</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://longyuwlz.github.io/longyu.github.io/blog/page/7"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="龙瑜的博客 | 龙瑜的文字世界"><meta data-rh="true" name="description" content="美好的时光在文字中停滞不前"><meta data-rh="true" property="og:description" content="美好的时光在文字中停滞不前"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="canonical" href="https://longyuwlz.github.io/longyu.github.io/blog/page/7"><link data-rh="true" rel="alternate" href="https://longyuwlz.github.io/longyu.github.io/blog/page/7" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://longyuwlz.github.io/longyu.github.io/blog/page/7" hreflang="x-default"><link rel="stylesheet" href="/longyu.github.io/assets/css/styles.f233e9eb.css">
<link rel="preload" href="/longyu.github.io/assets/js/runtime~main.9bcca1a9.js" as="script">
<link rel="preload" href="/longyu.github.io/assets/js/main.4339af60.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/longyu.github.io/"><div class="navbar__logo"><img src="/longyu.github.io/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/longyu.github.io/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">龙瑜的文字世界</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/longyu.github.io/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">历史发布</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/Failed to mmap 2MB hugepages 与 max_map_count limit">dpdk/Failed to mmap 2MB hugepages 与 max_map_count limit</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/I210 网卡设定 force link mode 并关闭 EEE mode">dpdk/I210 网卡设定 force link mode 并关闭 EEE mode</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/Unsupported SFP+ Module">dpdk/Unsupported SFP+ Module</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk ebpf 库跨版本移植">dpdk ebpf 库跨版本移植</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk mempool cache 机制分析">dpdk/dpdk mempool cache 机制分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 不同版本下载地址">dpdk/dpdk 不同版本下载地址</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 多进程模型共享队列收发包 virtio 网卡段错误问题">dpdk 多进程模型</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 官方 bugzilla 导出信息">dpdk/dpdk 官方 bugzilla 导出信息</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 对 numa 的使用与多 numa 架构下性能调优的基础">dpdk/dpdk 对 numa 的使用与多 numa 架构下性能调优的基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 收发包函数分析：dpdk-20.11 ice sse 向量收发包函数关键过程分析">收发包向量函数实现分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 死锁问题后续之初始化假设不可迁移问题">dpdk/dpdk 死锁问题后续之初始化假设不可迁移问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 用户态驱动框架及其演进过程分析">dpdk 用户态驱动框架及其部分演进过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序性能问题排查的一般流程">dpdk/dpdk 程序性能问题排查的一般流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序接口 down、up 问题定位的一般流程">接口 up、down 失败问题排查</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序收发包问题排查的一般流程">dpdk 程序收发包问题排查</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序绑不同的核性能有明显差异问题分析">dpdk/dpdk 程序绑不同的核性能有明显差异问题分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序绑核失败问题：EAL: pthread_setaffinity_np failed">问题描述</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 问题分析：不兼容光模块导致 dpdk 程序运行失败问题定位">dpdk/dpdk 问题分析：不兼容光模块导致 dpdk 程序运行失败问题定位</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 驱动移植叩开 kni 模块那些黑暗的角落">dpdk/dpdk 驱动移植叩开 kni 模块那些黑暗的角落</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 eal lcore 多线程机制分析">dpdk 多线程流水线</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 eal 初始化 log 信息解析">dpdk/dpdk-16.04 eal 初始化 log 信息解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 igb crc length 统计问题">dpdk/dpdk-16.04 igb crc length 统计问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 igb_uio 模块分析">dpdk/dpdk-16.04 igb_uio 模块分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 l2fwd 源码分析">dpdk/dpdk-16.04 l2fwd 源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 rte_kni 模块与内核内存泄露问题">问题描述</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 rte_kni 模块分析">dpdk/dpdk-16.04 rte_kni 模块分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 rte_spinlock.h rte_cpu_get_flag_enabled 接口问题">dpdk/dpdk-16.04 rte_spinlock.h rte_cpu_get_flag_enabled 接口问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 扩展新网卡驱动过程">编译相关配置添加</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 根目录中 .git 目录对编译参数的影响">dpdk/dpdk-16.04 根目录中 .git 目录对编译参数的影响</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 监听 uio 文件检测中断的示例 demo 与内部实现解析">dpdk/dpdk-16.04 监听 uio 文件检测中断的示例 demo 与内部实现解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 虚拟化环境 virtio 网卡 secondary 进程段错误问题分析定位">dpdk/dpdk-16.04 虚拟化环境 virtio 网卡 secondary 进程段错误问题分析定位</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 解初始化过程">dpdk/dpdk-16.04 解初始化过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 配置与编译过程分析">dpdk/dpdk-16.04 配置与编译过程分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-19.11 armv8 l2fwd 在某 arm 内核上无法运行问题">dpdk/dpdk-19.11 armv8 l2fwd 在某 arm 内核上无法运行问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-19.11 支持接口配置速率双工的方法">前言</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk程序启动顺序引发的血案">dpdk/dpdk程序启动顺序引发的血案</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/ethtool 命令指定的网络设备名在哪里被使用？">dpdk/ethtool 命令指定的网络设备名在哪里被使用？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/gcc constructor 属性修饰的构造函数未被链接问题">dpdk/gcc constructor 属性修饰的构造函数未被链接问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/igb_uio.ko 的 md5sum 为啥又变化了？">dpdk/igb_uio.ko 的 md5sum 为啥又变化了？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/l2fwd 支持 x710 通过 fdir 过滤非分片 ipv4 udp 报文">dpdk/l2fwd 支持 x710 通过 fdir 过滤非分片 ipv4 udp 报文</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/x710 hash 分片与非分片 tcp 报文异常问题">dpdk/x710 hash 分片与非分片 tcp 报文异常问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/不懂 dpdk mbuf 结构？此篇文章带你超神">dpdk 中 mbuf 的结构</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/以 ixgbe pmd 驱动为例研究 dpdk pmd 驱动中注册中断回调函数并使能中断的过程">dpdk/以 ixgbe pmd 驱动为例研究 dpdk pmd 驱动中注册中断回调函数并使能中断的过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/以 rte_mempool_ops_table 为例描述 dpdk 程序库链接顺序对程序执行的影响">dpdk mempool_ops</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/使用内核驱动上手 x710 flow directory 功能">环境介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/关闭 stdout 引发的灾难">dpdk/关闭 stdout 引发的灾难</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/杀掉数通引擎导致虚拟机重启问题定位">dpdk/杀掉数通引擎导致虚拟机重启问题定位</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/网卡接口绑定驱动及其使用的 bind、unbind、new_id 等 sys 文件">dpdk/网卡接口绑定驱动及其使用的 bind、unbind、new_id 等 sys 文件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/试玩 dpdk ebfp 功能">dpdk/试玩 dpdk ebfp 功能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk kni 口 ifconfig up down 的执行流程">dpdk/dpdk kni 口 ifconfig up down 的执行流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 中 rte_config.h 配置文件生成的问题">dpdk/dpdk 中 rte_config.h 配置文件生成的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 中 rte_eth_link_get_wait、nowait 函数研究">dpdk/dpdk 中 rte_eth_link_get_wait、nowait 函数研究</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 常见问题：uio 设备文件创建以及 iommu 导致 x710 网卡初始化失败问题">uio 设备文件创建的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序创建 kni 虚拟网络接口失败的问题">dpdk/dpdk 程序创建 kni 虚拟网络接口失败的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 问题排查的第一关：基础环境的排查">dpdk/dpdk 问题排查的第一关：基础环境的排查</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/编译dpdk-19.10时遇到的问题">dpdk/编译dpdk-19.10时遇到的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-kni与ethtool试玩问题记录">dpdk/dpdk-kni与ethtool试玩问题记录</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-pdump工具编译运行">dpdk/dpdk-pdump工具编译运行</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-pdump编译运行">dpdk/dpdk-pdump编译运行</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk库源码中包含内核头文件的问题">dpdk/dpdk库源码中包含内核头文件的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk收发包测试之使用内核接口给dpdk绑定的端口发包">dpdk/dpdk收发包测试之使用内核接口给dpdk绑定的端口发包</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/ethtool 读到的状态与 dpdk 读到的网卡状态不一致">dpdk/ethtool 读到的状态与 dpdk 读到的网卡状态不一致</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/将网卡绑定到官方驱动测试过程">dpdk/将网卡绑定到官方驱动测试过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/记录一次编译器版本过低导致 dpdk 无法成功编译的问题">dpdk/记录一次编译器版本过低导致 dpdk 无法成功编译的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/设置 EXTRA_CFLAGS 以编译 debug 版本 dpdk 库">dpdk/设置 EXTRA_CFLAGS 以编译 debug 版本 dpdk 库</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/libc/使用mtrace跟踪内存泄露问题">libc/使用mtrace跟踪内存泄露问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/linux-kernel/linux-内核模块中引用符号是如何链接的">linux-kernel/linux-内核模块中引用符号是如何链接的</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/2022/06/12/序言">写博客的意义</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk收发包测试之使用内核接口给dpdk绑定的端口发包">dpdk/dpdk收发包测试之使用内核接口给dpdk绑定的端口发包</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-19T07:40:00.000Z" itemprop="datePublished">2022年6月19日</time> · <!-- -->2 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何使用内核接口给-dpdk-绑定的端口发包">如何使用内核接口给 dpdk 绑定的端口发包<a class="hash-link" href="#如何使用内核接口给-dpdk-绑定的端口发包" title="标题的直接链接">​</a></h2><p>最近一次测试中，需要通过内核接口给 dpdk 绑定的端口发包进行测试，具体的测试方法见下文。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="硬件连接">硬件连接<a class="hash-link" href="#硬件连接" title="标题的直接链接">​</a></h2><p>两个网卡的端口连接到一起。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="软件配置">软件配置<a class="hash-link" href="#软件配置" title="标题的直接链接">​</a></h2><p>一个口绑定到内核驱动，一个口绑定 igb_uio 驱动。绑定到 igb_uio 的网卡端口，使用 l2fwd 程序来收发包。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="通过指定的端口发包">通过指定的端口发包<a class="hash-link" href="#通过指定的端口发包" title="标题的直接链接">​</a></h2><p>ping 命令的 -I 选项支持指定收发包的 netdev 端口。</p><p>使用 ping -I eth0 192.234.234.23 就可以从 eth0 口将数据包发送出去。这里的 eth0 口就是上面我们绑定到内核驱动上面的口。由于硬件连接到了一起，l2fwd 监控的端口会收到包，就可以进行测试了。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/ethtool 读到的状态与 dpdk 读到的网卡状态不一致">dpdk/ethtool 读到的状态与 dpdk 读到的网卡状态不一致</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-19T07:40:00.000Z" itemprop="datePublished">2022年6月19日</time> · <!-- -->11 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ethtool-读到的链接状态">ethtool 读到的链接状态<a class="hash-link" href="#ethtool-读到的链接状态" title="标题的直接链接">​</a></h2><p>使用 ethtool 读取网卡链接状态的一个示例如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~$ sudo /sbin/ethtool ens37 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[sudo] password for longyu: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Settings for ens37:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Supported ports: [ TP ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Supported link modes:   10baseT/Half 10baseT/Full </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            100baseT/Half 100baseT/Full </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            1000baseT/Full </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Supported pause frame use: No</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Supports auto-negotiation: Yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Supported FEC modes: Not reported</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Advertised link modes:  10baseT/Half 10baseT/Full </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            100baseT/Half 100baseT/Full </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            1000baseT/Full </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......                       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Link detected: yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的示例中，最后一行中的 Link detected 表示链路的状态，为 yes 表示链路 up，为 no 表示链路 down。目前链路为 up 状态。同时上面的输出中也表明此网卡支持自动协商。</p><p><strong>自动协商用于网卡端口与对端协商连接速度和双工模式，通过协商确定两端能够达到的最大连接速度与两端都支持的双工模式，主要与 phy 有关。</strong></p><p>通过搜索，我发现了如下链接：</p><p><a href="https://blog.csdn.net/skyflying2012/article/details/17557743" target="_blank" rel="noopener noreferrer">以太网自动协商的原理</a></p><p> 下面的信息来于 <a href="https://blog.csdn.net/skyflying2012/article/details/17557743" target="_blank" rel="noopener noreferrer">以太网自动协商的原理</a> 这篇博客。</p><blockquote><p>千兆光口自协商过程:</p><p>1.两端都设置为自协商模式</p><p>双方互相发送/C/码流，如果连续接收到3个相同的/C/码且接收到的码流和本端工作方式相匹配，则返回给对方一个带有Ack应答的/C/码，对端接收到Ack信息后，认为两者可以互通，设置端口为UP状态</p><p>2.一端设置为自协商，一端设置为强制</p><p>自协商端发送/C/码流，强制端发送/I/码流，强制端无法给对端提供本端的协商信息，也无法给对端返回Ack应答，故自协商端DOWN。但是强制端本身可以识别/C/码，认为对端是与自己相匹配的端口，所以直接设置本端端口为UP状态</p><p>3.两端均设置为强制模式</p><p>双方互相发送/I/码流，一端接收到/I/码流后，认为对端是与自己相匹配的端口，直接设置本端端口为UP状态</p><p>阅读上面的信息可以发现，当<strong>两端都设置为自协商模式时，自协商成功后两端的端口状态都为 UP</strong>；<strong>当一端设置自协商，一端设置强制时，自协商时设置自协商模式的端口状态会变为 DOWN，设置强制端的端口状态会变为 UP；当两端均设置为强制模式时，进行自协商会使两端端口都变为 UP 状态。</strong></p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="对端口执行自协商">对端口执行自协商<a class="hash-link" href="#对端口执行自协商" title="标题的直接链接">​</a></h2><p>有了这个基础我们来进行下面的操作，这里我使用的网卡型号如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">02:05.0 Ethernet controller: Intel Corporation 82545EM Gigabit Ethernet Controller (Copper) (rev 01)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这款网卡在我的系统中对应的 netdev 接口的名字为 ens37。</p><p><strong>1. 执行 sudo ifconfig ens37 down 命令将网卡设定为 down</strong> </p><p><strong>ethotool 查看链路状态，输出信息截取如下：</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ethtool</span><span class="token plain"> ens37 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">sudo</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> password </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> longyu: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Settings </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> ens37:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Supported ports: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> TP </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Supported </span><span class="token function" style="color:#d73a49">link</span><span class="token plain"> modes:   10baseT/Half 10baseT/Full </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            100baseT/Half 100baseT/Full </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            1000baseT/Full </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Supported pause frame use: No</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Supports auto-negotiation: Yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Link detected: no</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Link detected 为 no 表示链路为 down 状态。</p><p><strong>ethtool dump 寄存器信息，有如下与链路状态相关的信息：</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ethtool</span><span class="token plain"> -d ens37  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;Link&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Link reset:                        reset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Set </span><span class="token function" style="color:#d73a49">link</span><span class="token plain"> up:                       </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Link up:                           </span><span class="token function" style="color:#d73a49">link</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Link speed:                        1000Mb/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Link State:                        Down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Force Link Good:                   disabled</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此时 Link State 为 Down 与上面的 Link detected : no 一致。</p><p><strong>2. 执行 sudo ethtool -s ens37 autoneg on 进行自协商</strong> </p><p><strong>ethtool 查看链路状态，截取主要信息如下：</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ethtool</span><span class="token plain"> ens37</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Settings </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> ens37:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Supported ports: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> TP </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Supported </span><span class="token function" style="color:#d73a49">link</span><span class="token plain"> modes:   10baseT/Half 10baseT/Full </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            100baseT/Half 100baseT/Full </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            1000baseT/Full </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Supported pause frame use: No</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Supports auto-negotiation: Yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Link detected: no</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Link detected: no 表示链路为 down 的状态。</p><p><strong>ethtool -d 查看寄存器信息，相关内容如下：</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ethtool</span><span class="token plain"> -d ens37  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;Link&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Link reset:                        reset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Set </span><span class="token function" style="color:#d73a49">link</span><span class="token plain"> up:                       </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Link up:                           </span><span class="token function" style="color:#d73a49">link</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Link speed:                        1000Mb/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Link State:                        Up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Force Link Good:                   disabled</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意这里 Link State 状态变为 UP，这表明自协商成功。根据上文中引用的千兆光口自协商的过程，同时注意到我们的网卡支持自协商，我们用 ethtool -s 命令打开网卡的自协商功能，这之后 phy 的状态变为 UP 表明自协商成功，这与千兆光口自协商过程的第一种类型一致，两端都支持并开启了自协商，协商成功后两端的 phy 状态都变为了 UP。</p><p>这时候 ethtool 直接查看网卡，Link detected 显示为 no 表明链路状态为 down，为什么不是 UP 呢？</p><p>这里 phy 的状态由 DOWN 变为 UP 这是自协商成功的结果。这个是可以解释的。自协商的目的就是为了确定连接速度、双工模式这些配置，而这些配置都是要在 phy up 的状态下才有作用。</p><p>这时候直接使用 ifconfig 查看网卡信息，输出如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ifconfig</span><span class="token plain"> ens37 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ens37: </span><span class="token assign-left variable" style="color:#36acaa">flags</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">409</span><span class="token operator file-descriptor important" style="color:#393A34">8</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">BROADCAST,MULTICAST</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">  mtu </span><span class="token number" style="color:#36acaa">1500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ether 00:0c:29:5e:ba:35  txqueuelen </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ethernet</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX packets </span><span class="token number" style="color:#36acaa">1154</span><span class="token plain">  bytes </span><span class="token number" style="color:#36acaa">672588</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">656.8</span><span class="token plain"> KiB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX errors </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  dropped </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  overruns </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  frame </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX packets </span><span class="token number" style="color:#36acaa">136</span><span class="token plain">  bytes </span><span class="token number" style="color:#36acaa">16616</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">16.2</span><span class="token plain"> KiB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX errors </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  dropped </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> overruns </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  carrier </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  collisions </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的输出表明网卡的链路状态为 down，这与 ethtool 命令查看到的网卡状态为 no 是一致的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ethtool-link-detected-no-是怎样检测的">ethtool: Link detected: no 是怎样检测的？<a class="hash-link" href="#ethtool-link-detected-no-是怎样检测的" title="标题的直接链接">​</a></h2><p>这里我使用 ethtool-4.19 的源代码进行分析。</p><p>首先是 ethtool 中设定 ETHTOOL_GLINK 命令，调用 ioctl 函数获取链路状态。相关代码如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">edata.cmd = ETHTOOL_GLINK;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">err = send_ioctl(ctx, &amp;edata);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (err == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fprintf(stdout, &quot;   Link detected: %s\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        edata.data ? &quot;yes&quot;:&quot;no&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    allfail = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} else if (errno != EOPNOTSUPP) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    perror(&quot;Cannot get link status&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>edata.cmd 中填充的是 ethtool 中的子命令，属于 SIOCETHTOOL 下面的子命令。send_ioctol 函数的源码如下：</p><p>注意这里的子命令通过 ctx-&gt;ifr 来传递给 ioctl。</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">send_ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">cmd_context</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">cmd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ifr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ifr_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cmd</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SIOCETHTOOL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ctx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ifr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这之后 ioctl 会进行分发，由 ioctl 到 sock_ioctl 到 dev_ioctl 到 dev_ethtool 适配层。dev_ethtool 适配层相关函数在内核路径下的 net/core/ethtool.c 文件中。</p><p>dev_ethtool 函数是一个大的分发函数，通过 switch 来将不同的 ethtool 子命令分发到不同的子函数调用之上。子函数里面的核心逻辑在于调用网卡内核接口 net_device 中注册的 ethtool_ops 虚函数表中的函数。</p><p>上面 Link detected 中使用的 ethtool 子命令为 ETHTOOL_GLINK，在 dev_ethtool 函数中被分发到 ethtool_get_link 子函数。相关代码如下： </p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> ETHTOOL_GLINK</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ethtool_get_link</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> useraddr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ethtool_get_link 子函数的核心在于下面这行代码：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">edata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">netif_running</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ethtool_ops</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">get_link</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>netif_running 函数在内核头文件路径 include/linux/netdevice.h 中定义，它通过检测 netdev 结构体中 state 变量的 __LINK_STATE_START 位来确定接口是否 running。</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> bool </span><span class="token function" style="color:#d73a49">netif_running</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">net_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">test_bit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__LINK_STATE_START</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>了解了 ethtool_get_link 子函数的部分代码，我们可以发现，上文中提到的在网卡接口 down 的状态下进行自协商后，phy 的状态变为 UP，而 ethtool 输出的 Link detected 项为 no 的情况是正常的现象。</p><p>此时 ifconfig 显示的网卡状态不是 RUNNING，netif_running 将会返回 false，&amp;&amp; 语句之后的读取硬件寄存器中保存的链路状态的操作将被忽略，edata.data 将会返回 false，对应 ethtool 中 Link detected 项的输出为 no。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dev-ethtool_ops-get_linkdev-vs-rte_eth_link_get">dev-&gt;ethtool_ops-&gt;get_link(dev) vs rte_eth_link_get<a class="hash-link" href="#dev-ethtool_ops-get_linkdev-vs-rte_eth_link_get" title="标题的直接链接">​</a></h2><p><code>dev-&gt;ethtool_ops-&gt;get_link(dev)</code>最终是通过访问网卡中的寄存器来获取链路状态。</p><p>dpdk 中的 rte_eth_link_get 函数根据 lsc 中断是否开启，有两种不同的处理方式。</p><ol><li><p>lsc 中断使能</p><p>原子读取 dev 结构体中的 eth_link 成员。这个成员只能在 interrupt host 线程中被更新。用户注册的 lsc 中断回调函数也是在 interrupt host 线程中被调用的，可以在 lsc 中断回调函数中改变 eth_link 的值。</p></li><li><p>lsc 中断关闭
调用 dev_ops 中实现的 link_update 函数，该函数通过直接访问网卡寄存器来获取链路的最新状态。</p></li></ol><p>在 lsc 中断关闭的情况下，rte_eth_link_get 与 dev-&gt;ethtool-ops-&gt;get_link(dev) 最终都是通过访问网卡寄存器来确定链路状态的。</p><p>至于说 ethtool 读到的状态与 dpdk 读到的网卡状态不一致，这是指 ethtool 中的 Link detected 中检测到的链路状态与 rte_eth_link_get 函数的输出不同。</p><p><strong>从上面的分析中我们可以发现，ethtool 中的 Link detected 输出 yes 的必备条件还有 netif_running 返回 true，而 rte_eth_link_get 却没有使用这个状态，这两者从逻辑上来说也不是在任何时候都会一致的。</strong></p><p><strong>综上所述，这个问题其实不是功能的问题，而是不了解功能的实现而误判的问题。</strong></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/将网卡绑定到官方驱动测试过程">dpdk/将网卡绑定到官方驱动测试过程</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-19T07:40:00.000Z" itemprop="datePublished">2022年6月19日</time> · <!-- -->7 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="将网卡绑定到官方驱动进行测试">将网卡绑定到官方驱动进行测试<a class="hash-link" href="#将网卡绑定到官方驱动进行测试" title="标题的直接链接">​</a></h2><p>对于网卡的一些异常情况，常常需要使用官方驱动进行相同的测试以确认问题。
本文叙述了将网卡绑定到官方驱动进行测试的过程。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="网卡解绑定">网卡解绑定<a class="hash-link" href="#网卡解绑定" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-lsof-devuio-找到使用-devuiox-设备文件的产品程序">1. lsof /dev/uio* 找到使用 /dev/uioX 设备文件的产品程序。<a class="hash-link" href="#1-lsof-devuio-找到使用-devuiox-设备文件的产品程序" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root]# lsof /dev/uio*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF  NODE NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">l2fwd     21178 root   30u   CHR  248,1      0t0 28807 /dev/uio1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">l2fwd     21178 root   32u   CHR  248,0      0t0 28805 /dev/uio0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">l2fwd     21178 root   34u   CHR  248,3      0t0 25875 /dev/uio3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">........</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从上面的输出里面可以确认，产品的 server 为 l2fwd 程序，这个 l2fwd 程序使用了
设备文件 /dev/uioX。</p><p>我们首先需要 kill 产品的 server ，确保在没人使用的情况下解绑定网卡。为了防止
kill 程序后守护程序将 server 重新拉起来，<strong>可以将 server 重命名，然后 kill server。</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-网卡从-igb_uio-驱动解绑">2. 网卡从 igb_uio 驱动解绑<a class="hash-link" href="#2-网卡从-igb_uio-驱动解绑" title="标题的直接链接">​</a></h3><p>首先需要确定需要解绑定网卡的 pci 号。一般可以通过 lspci 命令来查询。</p><p>某设备上 X710 网卡的 pci 号相关信息示例如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root]# lspci |grep &#x27;Eth&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0f:00.0 Ethernet controller: Intel Corporation Ethernet Controller X710 for 10GbE backplane (rev 02)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0f:00.1 Ethernet controller: Intel Corporation Ethernet Controller X710 for 10GbE backplane (rev 02)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面 0f:00.0 与 0f:00.1 就是 X710 网卡的 pci 号。</p><p>解绑定需要使用 dpdk_nic_bind.py 脚本来完成，不同的产品这个脚本的位置可能不同，这点需要注意。</p><p>解绑定示例如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root]# /usr/local/bin/dpdk_nic_bind.py -u 0f:00.0 0f:00.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在上面的命令行中，-u 表示解除绑定，0f:00.0 与 0f:00.1 表示要解除绑定的网口。执行完成后，可以执行</p><p>dpdk_nic_bind.py -s 命令查看绑定信息，确认是否成功解绑。</p><p>示例如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root]# /usr/local/bin/dpdk_nic_bind.py -s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">............</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Other network devices</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=====================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000:0f:00.0 &#x27;Ethernet Controller X710 for 10GbE backplane&#x27; unused=igb_uio,uio_pci_generic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000:0f:00.1 &#x27;Ethernet Controller X710 for 10GbE backplane&#x27; unused=igb_uio,uio_pci_generic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从上面的输出中可以看到，0000:0f:00.0 与 0000:0f:00.1 网卡接口已经解除了绑定，没有绑定到
任何驱动上面。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="加载网卡的官方驱动-ko-时自动识别并绑定">加载网卡的官方驱动 ko 时自动识别并绑定<a class="hash-link" href="#加载网卡的官方驱动-ko-时自动识别并绑定" title="标题的直接链接">​</a></h2><p>当我们将网卡从 igb_uio 驱动上面解绑之后，就可以加载网卡使用的官方驱动了。这里的官方驱动
一般系统上会带有（一般放在 /bin 目录下），没有的话就需要自己编译后上传到设备上来加载了。</p><p>上面的示例操作中，网卡已经解除 igb_uio 的绑定。这样当我们在加载官方驱动的时候，内核会自
动识别到网卡，并执行对应的 probe 操作。</p><p>X710 网卡使用的官方驱动是 intel 的 i40e 驱动，加载 i40e 驱动的示例如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root]# insmod /bin/i40e.ko </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root]# dmesg | tail -n 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.260739] i40e: Intel(R) Ethernet Connection XL710 Network Driver - version 1.4.25-k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.260746] i40e: Copyright (c) 2013 - 2014 Intel Corporation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.279249] i40e 0000:0f:00.0: fw 6.1.49420 api 1.7 nvm 6.80 0x80003cf0 0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.279258] i40e 0000:0f:00.0: The driver for the device detected a newer version of the NVM image than expected. Please install the most recent version of the network driver.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.365299] i40e 0000:0f:00.0: MAC address: 98:30:00:1e:42:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.369576] i40e 0000:0f:00.0: SAN MAC: 00:00:00:00:02:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.432223] i40e 0000:0f:00.0 enp15s0f0: renamed from eth2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.496835] i40e 0000:0f:00.0: PCI-Express: Speed 8.0GT/s Width x8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.502928] i40e 0000:0f:00.0: Features: PF-id[0] VFs: 64 VSIs: 66 QP: 16 RX: 1BUF RSS FD_ATR FD_SB NTUPLE VxLAN PTP VEPA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.522602] i40e 0000:0f:00.1: fw 6.1.49420 api 1.7 nvm 6.80 0x80003cf0 0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.522611] i40e 0000:0f:00.1: The driver for the device detected a newer version of the NVM image than expected. Please install the most recent version of the network driver.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.610493] i40e 0000:0f:00.1: MAC address: 98:30:00:1e:42:21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.614555] i40e 0000:0f:00.1: SAN MAC: 00:00:00:00:02:01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.842767] i40e 0000:0f:00.1: PCI-Express: Speed 8.0GT/s Width x8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.849279] i40e 0000:0f:00.1: Features: PF-id[1] VFs: 64 VSIs: 66 QP: 16 RX: 1BUF RSS FD_ATR FD_SB NTUPLE VxLAN PTP VEPA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[79357.966780] i40e 0000:0f:00.1 enp15s0f1: renamed from eth2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从上面的输出中可以看到，加载了 i40e.ko 后，0f:00.0 与 0f:00.1 网卡接口被自动识别并绑定到
了 i40e 驱动，对应的 netdev 名称分别为：enp15s0f0 与 enp15s0f1，这之后我们就可以进行测试
了。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="手动绑定网卡到官方驱动上">手动绑定网卡到官方驱动上<a class="hash-link" href="#手动绑定网卡到官方驱动上" title="标题的直接链接">​</a></h2><p>如果我们先加载了网卡的官方驱动，然后再解除 igb_uio 的绑定并重新绑定到官方驱动上面，可以
执行下面的命令手动将网卡接口绑定到官方驱动上。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dpdk_nic_bind.py -b driver_name pcinum</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>driver_name 为加载的官方驱动的名称，pcinum 为产品的 pci 号，多个 pcinum 之间使用空格分隔。</p><p>一个示例如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root]# /usr/local/bin/dpdk_nic_bind.py -b i40e 0f:00.0 0f:00.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root]# /usr/local/bin/dpdk_nic_bind.py -s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">········</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Network devices using kernel driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">===================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000:0f:00.0 &#x27;Ethernet Controller X710 for 10GbE backplane&#x27; if=enp15s0f0 drv=i40e unused=igb_uio,uio_pci_generic </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000:0f:00.1 &#x27;Ethernet Controller X710 for 10GbE backplane&#x27; if=enp15s0f1 drv=i40e unused=igb_uio,uio_pci_generic </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的示例中首先通过 dpdk_nic_bind.py -b 将 0f:00.0 与 0f:00.1 绑定到 i40e 官方驱动上，然后
执行 dpdk_nic_bind.py -s 显示当前的网卡设备状态。从输出可以发现，0f:00.0 与 0f:00.1 已经被
绑定到了官方驱动上面。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="重新绑定到-igb_uio-中并恢复">重新绑定到 igb_uio 中并恢复<a class="hash-link" href="#重新绑定到-igb_uio-中并恢复" title="标题的直接链接">​</a></h2><p>测试完成后，我们需要重新将网卡绑定到 igb_uio 上，执行 dpdk_nic_bind.py -b 命令来完成。</p><p>如果绑定的过程中有如下报警，则需要执行 ifconfig netdev down 命令来将网卡 down 掉，再解除
绑定。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root]# /usr/local/bin/dpdk_nic_bind.py -b igb_uio 0f:00.0 0f:00.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Routing table indicates that interface 0000:0f:00.0 is active. Not modifying</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ifconfig down 掉网卡后再重新绑定的示例：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root]# ifconfig enp15s0f0 down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root]# /usr/local/bin/dpdk_nic_bind.py -b igb_uio 0f:00.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/记录一次编译器版本过低导致 dpdk 无法成功编译的问题">dpdk/记录一次编译器版本过低导致 dpdk 无法成功编译的问题</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-19T07:40:00.000Z" itemprop="datePublished">2022年6月19日</time> · <!-- -->2 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><p>编译 dpdk-20.02 时，有如下报错信息：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">error: ‘__ATOMIC_RELAXED’ undeclared (first use in this function)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">error: ‘__ATOMIC_ACQUIRE’ undeclared (first use in this function)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">error: ‘__ATOMIC_RELAXED’ undeclared (first use in this function)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">error: ‘__ATOMIC_ACQUIRE’ undeclared (first use in this function)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="分析解决">分析解决<a class="hash-link" href="#分析解决" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="头文件的问题">头文件的问题<a class="hash-link" href="#头文件的问题" title="标题的直接链接">​</a></h3><p>根据过去的经验，未声明的符号这个错误很大概率是头文件的问题。首先需要确定的是编译的源码中是否有相关的符号声明。</p><p>使用上述符号在 dpdk-20.02 的源码里面搜索，只发现很多使用的地方，没有发现声明。</p><p>这意味着上面找不到的符号不是 dpdk 内部定义的符号，那么这些符号可能是 dpdk 依赖的外部头文件中声明的。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="内核头文件是否声明这些符号">内核头文件是否声明这些符号<a class="hash-link" href="#内核头文件是否声明这些符号" title="标题的直接链接">​</a></h3><p>考虑到 dpdk 编译的时候需要指定内核源码路径，这些符号可能在内核头文件中声明。</p><p>使用上述符号在内核源码中全局搜索，没有找到。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="在网上搜索">在网上搜索<a class="hash-link" href="#在网上搜索" title="标题的直接链接">​</a></h3><p>搜索了下，发现如下链接中有相同的问题案例：</p><p><a href="https://github.com/nim-lang/Nim/issues/2620" target="_blank" rel="noopener noreferrer">__ATOMIC_RELAXED undeclared</a></p><p>浏览上述链接网页，发现这个问题可能是 gcc 版本过低导致的。网页中的讨论中有下面这一句：</p><blockquote><p>The atomic builtins referenced in atomic.nim are only available with GCC 4.7+</p></blockquote><p>我检查自己编译环境下的 gcc 版本，发现使用的 gcc 为 4.5.3 版本。</p><p>这之后我在另外一个编译环境上重新编译，编译前确认 gcc 的版本高于 4.7，编译成功。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/设置 EXTRA_CFLAGS 以编译 debug 版本 dpdk 库">dpdk/设置 EXTRA_CFLAGS 以编译 debug 版本 dpdk 库</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-19T07:40:00.000Z" itemprop="datePublished">2022年6月19日</time> · <!-- -->5 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="命令行指定-cflags-不生效">命令行指定 CFLAGS 不生效<a class="hash-link" href="#命令行指定-cflags-不生效" title="标题的直接链接">​</a></h2><p>dpdk 的 Makefile 中有对 CFLAGS 的设定，在很多 Makefile 单独设定了 CFLAGS 增加 -O3 参数。</p><p>下面是 dpdk-17.05 中一些 Makefile 在 CFLAGS 标志中增加 -O3 选项的语句。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./lib/librte_reorder/Makefile:37:CFLAGS += -O3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./drivers/net/fm10k/Makefile:39:CFLAGS += -O3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./drivers/net/tap/Makefile:42:CFLAGS += -O3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./drivers/net/pcap/Makefile:40:CFLAGS += -O3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./drivers/net/sfc/Makefile:38:CFLAGS += -O3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./drivers/net/vhost/Makefile:41:CFLAGS += -O3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./drivers/net/null/Makefile:39:CFLAGS += -O3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./drivers/net/mlx4/Makefile:47:CFLAGS += -O3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./drivers/net/af_packet/Makefile:45:CFLAGS += -O3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">........</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>全局设定 <code>export CFLAGS=&quot; -O0 0g&quot;</code>后重新编译发现还是使用了 -O3 编译，这表明 dpdk 的编译脚本中对 CFLAGS 的值重新进行了设定，<strong>不能通过命令行指定 CFLAGS 来编译出 debug 版本。</strong></p><p>在 doc 目录下找到了如下相关内容：</p><div class="language-rst codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rst codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">331 Variables that Can be Set/Overridden in a Makefile Only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">332 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">333 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">334 *   VPATH: The path list that the build system will search for sources. By default, RTE_SRCDIR will be included in VPATH.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">335 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">336 *   CFLAGS: Flags to use for C compilation. The user should use +=  to append data in this variable.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">337 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从上面的内容中可以看出，用户不能通过命令行设定 CFLAGS，只能通过 Makefile 文件来设定。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="命令行设置-extra_cflags-标志生成-debug-版">命令行设置 EXTRA_CFLAGS 标志生成 debug 版<a class="hash-link" href="#命令行设置-extra_cflags-标志生成-debug-版" title="标题的直接链接">​</a></h2><p>继续阅读 doc 目录中的帮助文档，我发现 EXTRA_CFLAGS 标志可以使用。文档中相关的内容摘取如下：</p><div class="language-rst codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rst codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Variables that Can be Set/Overridden by the User in a Makefile or Command Line</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">389 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">390 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">391 *   CFLAGS_my_file.o: Specific flags to add for C compilation of my_file.c.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">392 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">393 *   LDFLAGS_my_app: Specific flags to add when linking my_app.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">394     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">395 *   EXTRA_CFLAGS: The content of this variable is appended after CFLAGS when compiling.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">396 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">397 *   EXTRA_LDFLAGS: The content of this variable is appended after LDFLAGS when linking.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">398 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">399 *   EXTRA_LDLIBS: The content of this variable is appended after LDLIBS when linking.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">400 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">401 *   EXTRA_ASFLAGS: The content of this variable is appended after ASFLAGS when assembling.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">402 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">403 *   EXTRA_CPPFLAGS: The content of this variable is appended after CPPFLAGS when using a C preprocessor on assembly files.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的介绍表明 EXTRA_CFLAGS 变量可以通过命令行进行设定，同时它会在编译时追加到 CFLAGS 内容之后。</p><p>执行 export EXTRA_CFLAGS=&quot;-O0 -g&quot; 后重新编译 dpdk 的库，使用 gdb 调试 app 目录下生成的可执行文件发现 gdb 能够读取到调试信息。</p><p>虽然有了调试信息，但是 Makefile 中对 CFLAGS 变量增加的 -O3 选项可能意味着编译出来的是 O3 版本的程序，这样就不能算作是 debug 版本。</p><p>我查看编译编译目录中 *.o.cmd 中保存的编译命令，发现库函数的编译命令中同时设定了 -O3 与 -O0 -g 参数。</p><p>示例如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:22:02:09</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> x86_64-native-linuxapp-gcc $ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> ./build/lib/librte_eal/linuxapp/eal/.eal_alarm.o.cmd </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cmd_eal_alarm.o </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gcc -Wp,-MD,./.eal_alarm.o.d.tmp  -m64 -pthread  -march</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">native -DRTE_MACHINE_CPUFLAG_SSE -DRTE_MACHINE_CPUFLAG_SSE2 -DRTE_MACHINE_CPUFLAG_SSE3 -DRTE_MACHINE_CPUFLAG_SSSE3 -DRTE_MACHINE_CPUFLAG_SSE4_1 -DRTE_MACHINE_CPUFLAG_SSE4_2 -DRTE_MACHINE_CPUFLAG_AES -DRTE_MACHINE_CPUFLAG_PCLMULQDQ -DRTE_MACHINE_CPUFLAG_AVX -DRTE_MACHINE_CPUFLAG_RDRAND -DRTE_MACHINE_CPUFLAG_FSGSBASE -DRTE_MACHINE_CPUFLAG_F16C -DRTE_MACHINE_CPUFLAG_AVX2  -I/home/longyu/Downloads/dpdk-stable-17.02.1/x86_64-native-linuxapp-gcc/include -include /home/longyu/Downloads/dpdk-stable-17.02.1/x86_64-native-linuxapp-gcc/include/rte_config.h -I/home/longyu/Downloads/dpdk-stable-17.02.1/lib/librte_eal/linuxapp/eal/include -I/home/longyu/Downloads/dpdk-stable-17.02.1/lib/librte_eal/common -I/home/longyu/Downloads/dpdk-stable-17.02.1/lib/librte_eal/common/include -W -Wall -Wstrict-prototypes -Wmissing-prototypes -Wmissing-declarations -Wold-style-definition -Wpointer-arith -Wcast-align -Wnested-externs -Wcast-qual -Wformat-nonliteral -Wformat-security -Wundef -Wwrite-strings -O3  -O0 -g  -o eal_alarm.o -c /home/longyu/Downloads/dpdk-stable-17.02.1/lib/librte_eal/linuxapp/eal/eal_alarm.c  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查看到编译命令，我想到了一个问题——<strong>指定了多个优化选项时 gcc 编译时会使用哪个呢？</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gcc-同时指定多个优化选项的问题">gcc 同时指定多个优化选项的问题<a class="hash-link" href="#gcc-同时指定多个优化选项的问题" title="标题的直接链接">​</a></h2><p>经过搜索，我发现 gcc 的官方网页中对这个问题进行了描述。当 gcc 编译命令中指定了多个优化选项时，只有最后一个优化选项生效。</p><p>-O3 是在 CFLAGS 变量中指定的，EXTRA_CFLAGS 是我们在命令行中指定的，根据 dpdk 的帮助文档中的说明，EXTRA_CFLAGS 的值会在编译时追加到 CFLAGS 的值后，这样我们就看到了有 -O3 ..... -O0 -g 这样的编译命令。</p><p>-O0 是最后一个指定的优化选项，实际生效的是 -O0，而非 -O3，这样我们通过设定 EXTRA_CFLAGS 为 -O0 -g 就能够编译出 debug 版本的 dpdk。</p><p>备注: EXTRA_CFLAGS 是在  mk/internal/rte.compile-pre.mk 中使用的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="最终确定的编译-dpdk-debug-版本的方法">最终确定的编译 dpdk debug 版本的方法<a class="hash-link" href="#最终确定的编译-dpdk-debug-版本的方法" title="标题的直接链接">​</a></h2><p>命令行中执行如下命令设定 EXTRA_CFLAGS 后重新编译即可。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">EXTRA_CFLAGS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;-O0 -g&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/libc/使用mtrace跟踪内存泄露问题">libc/使用mtrace跟踪内存泄露问题</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-19T07:40:00.000Z" itemprop="datePublished">2022年6月19日</time> · <!-- -->21 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a class="hash-link" href="#前言" title="标题的直接链接">​</a></h2><p>研究动态链接的原理中，无意间发现了 <strong>mtrace</strong> 这个东东。它是一个 libc 库提供的函数，<strong>通过向 malloc、calloc、free 等函数注册 hook 函数来实现内存申请与释放的跟踪</strong>，可以用来<strong>定位内存泄露问题</strong>。</p><p>在本文中，我将描述一个具体的使用实例，及使用过程中遇到的一些问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mtrace-示例-demo">mtrace 示例 demo<a class="hash-link" href="#mtrace-示例-demo" title="标题的直接链接">​</a></h2><p><strong>man 3 mtrace</strong> 查看 manual 信息，发现 manual 中已经提供了一个非常简单的示例 demo，其源码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;mcheck.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdlib.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> j</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">mtrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">j </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">/* Never freed--a memory leak */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">calloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">/* Never freed--a memory leak */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">EXIT_SUCCESS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>将上述代码保存为 t_mtrace.c 源文件，执行如下命令进行编译：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gcc -g t_mtrace.c -o t_mtrace</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在运行之前，我们需要设定 <strong>MALLOC_TRACE</strong> 环境变量，这个环境变量指向 mtrace 输出记录文件的路径。</p><p>MALLOC_TRACE 设定示例如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">MALLOC_TRACE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/t</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>设定了这个变量之后就可以运行 <strong>t_mtrace</strong> 程序，运行完成后 /tmp/t 文件中将会保存输出的记录，示例如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:19:25:40</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> program-problem $ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /tmp/t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ ./t_mtrace:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0x55555555518c</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> + 0x5555555596a0 0x64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ ./t_mtrace:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0x55555555518c</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> + 0x555555559710 0x64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ ./t_mtrace:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0x5555555551a5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> + 0x555555559780 0x100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>/tmp/t</strong> 的输出并不直观，libc 库提供了一个同样名为 mtrace 的 perl 脚本来解析这个记录，mtrace 脚本需要提供两个参数，第一个参数为<strong>可执行程序的路径名</strong>，第二个参数为 <strong>mtrace 函数输出的记录文件</strong>。</p><p>执行示例如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:19:29:08</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> program-problem $ mtrace ./t_mtrace </span><span class="token variable" style="color:#36acaa">$MALLOC_TRACE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Memory not freed:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           Address     Size     Caller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00005555555596a0     0x64  at 0x55555555518c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000555555559710     0x64  at 0x55555555518c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000555555559780    0x100  at 0x5555555551a5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里我得到的输出信息与 manual 中的信息不同，<strong>没有显示出调用者所在源码中的行号。</strong></p><p>manual 中的输出信息如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">           $ mtrace ./t_mtrace </span><span class="token variable" style="color:#36acaa">$MALLOC_TRACE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           Memory not freed:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           -----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Address     Size     Caller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           0x084c9378     0x64  at /home/cecilia/t_mtrace.c:12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           0x084c93e0     0x64  at /home/cecilia/t_mtrace.c:12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           0x084c9448    0x100  at /home/cecilia/t_mtrace.c:16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>重新 <strong>check</strong> 我的运行过程，我确定与 manual 中描述的一致，看来一定是哪里出了问题了。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="对-mtrace-脚本解析不到行号问题的解决过程">对 mtrace 脚本解析不到行号问题的解决过程<a class="hash-link" href="#对-mtrace-脚本解析不到行号问题的解决过程" title="标题的直接链接">​</a></h2><p>对这个问题，我最开始进行了如下尝试：</p><ol><li>-O0 -g 编译后测试发现仍旧没有打印</li><li>修改文件名为绝对路径后也没有打印</li><li>对比加了-g、没有加 -g  /tmp/t 文件的区别，发现内容完全相同</li><li>网上搜索发现有相关的描述，不过网页中同 manual 中一样能够显示源代码行号</li></ol><p>在上面的尝试都失败后，我开始使用 strace 大法。用了 strace 后看到了一堆系统调用，其中<strong>有执行 addr2line 的过程</strong>，看来这个 mtrace 脚本实际是运行 addr2line 命令获取到的行号，那<strong>问题是否出在 addr2line 中呢？</strong></p><p>我单独使用 addr2line 获取 /tmp/t 中函数调用地址对应的行号，发现根本获取不到任何信息，输出内容为 ??。</p><p>搞到这里我还是没有发现根本问题，只能硬着头皮用 perl -d 来运行这个 mtrace 脚本，调试了下也没有发现关键的点。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="进一步的分析">进一步的分析<a class="hash-link" href="#进一步的分析" title="标题的直接链接">​</a></h3><p>在一系列的尝试后，我暂时没有找到一个解决方案，不过我觉得 <strong>addr2line 是个非常重要的怀疑对象</strong>。为了验证我的猜测，我将代码进行了如下修改：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;mcheck.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdlib.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> j</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">mtrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%p\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mtrace</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">j </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">/* Never freed--a memory leak */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">calloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">/* Never freed--a memory leak */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">pause</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">EXIT_SUCCESS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我这里打印出了 <strong>mtrace 函数的地址</strong>，编译并执行后会得到 mtrace 函数的地址，然后我使用 addr2line 命令，指定这个地址来获取源码行号，发现仍旧打印的是 ??，这让我觉的很大概率是 <strong>addr2line 命令的问题</strong>。</p><p>在这个基础上，我执行 <strong>objdump -d 反汇编可执行文件</strong>，然后使用 main 函数的<strong>相对地址为参数</strong>继续调用 addr2line 命令来解析，这一次<strong>能够解析到了。</strong></p><p>测试过程记录如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:19:50:39</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> program-problem $ objdump -d t_mtrace </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    109d:   </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"> 8d 3d c1 00 00 00    lea    0xc1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">%rip</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">,%rdi        </span><span class="token comment" style="color:#999988;font-style:italic"># 1165 &lt;main&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10a4:   ff </span><span class="token number" style="color:#36acaa">15</span><span class="token plain"> 2e 2f 00 00       callq  *0x2f2e</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">%rip</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 3fd8 &lt;__libc_start_main@GLIBC_2.2.5&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000001165 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">main</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    119b:   eb 0e                   jmp    11ab </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">main+0x4</span><span class="token operator file-descriptor important" style="color:#393A34">6</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    11af:   7e ec                   jle    119d </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">main+0x3</span><span class="token operator file-descriptor important" style="color:#393A34">8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:19:50:44</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> program-problem $ addr2line -e ./t_mtrace </span><span class="token number" style="color:#36acaa">1165</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/longyu/problem_and_solution/program-problem/./t_mtrace.c:7</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到在最后一行，addr2line 打印出了行号！</p><p>然后使用 gdb 运行，start 后在 main 函数处停下来后，反汇编 main 函数，发现 <strong>main 函数的地址与 objdump -d 的输出完全不同</strong>，看来应该是<strong>基地址被修改了。</strong></p><p>测试记录如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Temporary breakpoint </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> at 0x1174: </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> ./mtrace.c, line </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting program: /home/longyu/problem_and_solution/program-problem/t_mtrace </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Temporary breakpoint </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, main </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">argv</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">0x7fffffffdae8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> at ./mtrace.c:10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10</span><span class="token plain">                 mtrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> disass main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Dump of assembler code </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> main:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x0000555555555165 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">+</span><span class="token operator file-descriptor important" style="color:#393A34">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">: push   %rbp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到这里 main 函数的地址变为了 <strong>0x0000555555555165</strong>，这就造成 addr2line 命令不能解析到源码行号。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="关闭-aslr">关闭 ASLR<a class="hash-link" href="#关闭-aslr" title="标题的直接链接">​</a></h3><p><strong>再次执行此程序</strong>，我发现每次打印的 mtrace 函数的地址都不一样，这点让我想起了 ASLR 这个功能，首先查看 /proc/sys/kernel/randomize_va_space 文件的内容，发现值为 2 表示<strong>这个功能确实是打开的。</strong></p><p>使用 root 权限向 /proc/sys/kernel/randomize_va_space 文件写入 0 关闭这个功能后，重新执行上面的测试，发现<strong>仍旧不能获取到行号信息</strong>。</p><p>看来还是得从 addr2line 命令上着手！</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="以-addr2line-cannot-work-为关键词搜索互联网">以 addr2line cannot work 为关键词搜索互联网<a class="hash-link" href="#以-addr2line-cannot-work-为关键词搜索互联网" title="标题的直接链接">​</a></h3><p>使用 addr2line cannot work 搜索后，我在 <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=860394" target="_blank" rel="noopener noreferrer">addr2line cannot decode addresses that gdb does</a> 这篇链接中看到了如下关键信息：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">There are 2 things going on. First, by default gcc is now building</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">executables as position independent (-pie). This can be explicitly</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">disabled with the -no-pie linking option. Disabling PIE should result in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">things working as they did before.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The second thing going on is Address Space Layout Randomization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(ASLR). This is now active by default and will cause all PIE executables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">to be loaded to random addresses. This can be disabled globally with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sysctl:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $ sudo sysctl -w kernel.randomize_va_space=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Or with a boot argument:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    norandmaps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Or (preferrably) locally for the process you are interested:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $ setarch `uname -m` -R /some/program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Often it is convenient to use the above command with /bin/bash so as to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quickly create a non-randomized environment for yourself.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">However, be aware that even when ASLR is disabled, if it is a PIE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exectuable, it will always load to the same address, but that is not the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">address within the executable. That means that for PIE executables, many</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binutils (such as addr2line) will require you to recalculate the offset.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我<strong>已经关闭了 ASLR 功能</strong>，对应上述描述的第二点，第一点描述说与 pie 有关，通过指定 <strong>-no-pie</strong> 参数重新编译上述程序，直接在 gdb 中运行，再次反汇编 main 函数，这次得到了如下输出信息：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Temporary breakpoint </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> at 0x401171: </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> ./mtrace.c, line </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting program: /home/longyu/problem_and_solution/program-problem/t_mtrace </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Temporary breakpoint </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, main </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">argv</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">0x7fffffffdae8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> at ./mtrace.c:10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10</span><span class="token plain">                 mtrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> disass main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Dump of assembler code </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> main:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x0000000000401162 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">+</span><span class="token operator file-descriptor important" style="color:#393A34">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">: push   %rbp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到这次，main 函数地址变为了 <strong>0x401162</strong>，objdump -d 输出的 main 函数地址如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0000000000401162 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">main</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">401162</span><span class="token plain">:   </span><span class="token number" style="color:#36acaa">55</span><span class="token plain">                      push   %rbp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到，<strong>这次 objdump 得到的函数地址与运行时的地址一致了</strong>，看来应该没有问题了。</p><p>运行程序后，继续查看 /tmp/t 的内容，这次得到了如下信息：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:20:09:00</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> program-problem $ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /tmp/t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ /lib/x86_64-linux-gnu/libc.so.6:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_IO_file_doallocate+0x8c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0x7ffff7e5971c</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> + 0x4056a0 0x400</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ ./t_mtrace:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0x4011a4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> + 0x405ab0 0x64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ ./t_mtrace:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0x4011a4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> + 0x405b20 0x64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ ./t_mtrace:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0x4011bd</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> + 0x405b90 0x100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ /lib/x86_64-linux-gnu/libc.so.6:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0x7ffff7f52ad4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> - 0x4056a0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个输出看上去非常正常，看来问题应该能够得到解决了！再次执行 mtrace 脚本，这次确实能够获取到源码行号了，操作记录如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:20:10:06</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> program-problem $ mtrace ./t_mtrace /tmp/t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Memory not freed:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           Address     Size     Caller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000405ab0     0x64  at /home/longyu/problem_and_solution/program-problem/./t_mtrace.c:13 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">discriminator </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000405b20     0x64  at /home/longyu/problem_and_solution/program-problem/./t_mtrace.c:13 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">discriminator </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000405b90    0x100  at /home/longyu/problem_and_solution/program-problem/./t_mtrace.c:17</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果你对这里的行号足够敏感，你会发现这里的行号并不准确，其实在 manual 中已经说明了这个问题。</p><p>上述 demo 中调用了 malloc 与 calloc 函数并且都没有调用 free 来释放，<strong>模拟内存泄露的情况</strong>，根据 mtrace 的输出，我们就能够马上定位到内存泄露的位置。</p><p>同时需要注意的是，当 <strong>MALLOC_TRACE</strong> 指向了一个合法的可以写的文件路径时，mtrace 能够运行，但是可能会带来<strong>性能上的损耗！</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mtrace-是咋样实现的">mtrace 是咋样实现的？<a class="hash-link" href="#mtrace-是咋样实现的" title="标题的直接链接">​</a></h2><p>解决了 addr2line 不能显示源码行号的问题，mtrace 算正式上手了，下一个问题是 mtrace 是如何实现的呢？</p><p>mtrace 函数的源码位于 glibc 源码中的 <strong>malloc/mtrace.c</strong> 中，核心逻辑是设定 malloc、calloc、realloc、free 等几个申请、释放内存空间函数使用的内部 hook 函数。相关代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">308</span><span class="token plain">           tr_old_free_hook </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> __free_hook</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">309</span><span class="token plain">           __free_hook </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tr_freehook</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">310</span><span class="token plain">           tr_old_malloc_hook </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> __malloc_hook</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">311</span><span class="token plain">           __malloc_hook </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tr_mallochook</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">312</span><span class="token plain">           tr_old_realloc_hook </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> __realloc_hook</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">313</span><span class="token plain">           __realloc_hook </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tr_reallochook</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                                                                                                                               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">314</span><span class="token plain">           tr_old_memalign_hook </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> __memalign_hook</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">315</span><span class="token plain">           __memalign_hook </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tr_memalignhook</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>那这些 hook 函数是在哪里被调用的呢？这里我以 malloc 函数中的调用代码为例来描述，旨在抛出<strong>如何获取返回地址</strong>这一问题。</p><p>相关代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">3018</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3019</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__libc_malloc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">size_t</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3020</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3021</span><span class="token plain">   mstate ar_ptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3022</span><span class="token plain">   </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">victim</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3023</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3024</span><span class="token plain">   </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">hook</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">size_t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3025</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">atomic_forced_read</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__malloc_hook</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3026</span><span class="token plain">   </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">__builtin_expect</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hook </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3027</span><span class="token plain">     </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">hook</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bytes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">RETURN_ADDRESS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意当 <strong>__malloc_hook</strong> 不为 NULL 的时候（调用了 mtrace 函数会设定 __malloc_hook 函数指针），该 hook 函数会被被调用，调用 hook 函数传递的第二个参数 <strong>RETURN_ADDRESS (0)</strong> 值得研究。</p><p>这个 RETURN_ADDRESS(0) 是一个宏，其定义如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* Determine the return address.  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">RETURN_ADDRESS</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">nr</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression function" style="color:#d73a49">__builtin_extract_return_addr</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression function" style="color:#d73a49">__builtin_return_address</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">nr</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里使用了 gcc 的扩展功能来获取函数的返回地址，这里的 nr 对应的是栈帧的层级，0 表示当前函数的返回地址，放在这就是 <strong>malloc 函数执行完成后继续执行的下一条指令地址。</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="__builtin_return_address-是如何实现的">__builtin_return_address 是如何实现的？<a class="hash-link" href="#__builtin_return_address-是如何实现的" title="标题的直接链接">​</a></h2><p>写到这里与 mtrace 相关的内容告一段落，开始跳到 __builtin_return_address 的实现上。</p><p>关于这个函数的实现，根据之前学习 《CSAPP》的印象，其实关键在于获取到栈中不同栈帧的 EBP 与 EIP 的值，<strong>EBP 表示栈底，而 EIP 则是返回地址。</strong></p><p>函数调用时，<strong>参数首先压栈，按照从右向左的顺序</strong>，然后<strong>返回地址入栈</strong>，然后<strong>调用者的 EBP （旧的EBP ）压栈</strong>。x86 中栈是向下增长的，我们只需要获取到当前 EBP 寄存器的值向上拨动一个数据单元（32-bit 4 字节，64-bit 8 字节），访问这个地址就能够得到返回地址。同时上一级函数栈帧的 EBP 又可以通过当前函数的 EBP 获取到（<strong>访问当前函数 EBP 寄存器值指向的地址</strong>）。</p><p>由于函数调用存在嵌套性，可能存在多个函数栈帧，我们需要<strong>递归执行</strong>上述过程。</p><p>更具体的信息请访问：</p><p><a href="https://blog.csdn.net/absurd/article/details/4207357?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522160423542319724836730112%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=160423542319724836730112&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v1~rank_blog_v1-6-4207357.pc_v1_rank_blog_v1&amp;utm_term=%E8%B0%83%E7%94%A8&amp;spm=1018.2118.3001.4450" target="_blank" rel="noopener noreferrer">系统程序员成长计划－像机器一样思考(二)</a>
<a href="https://blog.csdn.net/absurd/article/details/4207357?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522160423542319724836730112%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=160423542319724836730112&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v1~rank_blog_v1-6-4207357.pc_v1_rank_blog_v1&amp;utm_term=%E8%B0%83%E7%94%A8&amp;spm=1018.2118.3001.4450" target="_blank" rel="noopener noreferrer"></a></p><p>上述链接中的示例代码直接编译运行在我的系统上会报段错误，我修改了部分内容，新的 demo 如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token macro property" style="color:#36acaa"> </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">NEW_GCC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">MAX_LEVEL</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">NEW_GCC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">OFFSET</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">OFFSET</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token macro property comment" style="color:#999988;font-style:italic">/*NEW_GCC*/</span><span class="token macro property" style="color:#36acaa"> </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">backtrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfefefefe</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">long</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">n</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain">  i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> ebp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> OFFSET</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> eip </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> OFFSET</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        buffer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">eip</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">long</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">ebp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ebp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eip </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">test2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">MAX_LEVEL</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">backtrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MAX_LEVEL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> MAX_LEVEL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;called by %p\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    buffer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">test1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> a</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x11111111</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> b</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x11111112</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">test2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> a</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x10000000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> b</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x10000002</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">test1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>将上述代码保存为 backtrace.c，编译运行能够正常，记录如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">10</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">21</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">04</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">29</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> program</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">problem $ gcc </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">backtrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o backtrace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">10</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">21</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">04</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">31</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> program</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">problem $ </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">backtrace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">called by </span><span class="token number" style="color:#36acaa">0x555555555204</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">called by </span><span class="token number" style="color:#36acaa">0x555555555258</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">called by </span><span class="token number" style="color:#36acaa">0x555555555281</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">called by </span><span class="token number" style="color:#36acaa">0x5555555552a3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="https://blog.csdn.net/absurd/article/details/4207357?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522160423542319724836730112%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=160423542319724836730112&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v1~rank_blog_v1-6-4207357.pc_v1_rank_blog_v1&amp;utm_term=%E8%B0%83%E7%94%A8&amp;spm=1018.2118.3001.4450" target="_blank" rel="noopener noreferrer">系统程序员成长计划－像机器一样思考(二)</a>
<a href="https://blog.csdn.net/absurd/article/details/4207357?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522160423542319724836730112%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=160423542319724836730112&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v1~rank_blog_v1-6-4207357.pc_v1_rank_blog_v1&amp;utm_term=%E8%B0%83%E7%94%A8&amp;spm=1018.2118.3001.4450" target="_blank" rel="noopener noreferrer"></a>这篇李先静大神的博客中，从根本上解释了我之前描述的 addr2line 命令不能获取到行号的问题。</p><p>相关的内容摘录如下：</p><blockquote><p>对于共享库，addr2line无法根据这个地址找到对应的源代码位置了。原因是：addr2line只能通过地址偏移量来查找，而打印出的地址是绝对地址。由于共享库加载到内存的位置是不确定的，为了计算地址偏移量，我们还需要进程maps文件的帮助</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="进程-maps-文件的使用">进程 maps 文件的使用<a class="hash-link" href="#进程-maps-文件的使用" title="标题的直接链接">​</a></h2><p>每一个进程都有自己的虚拟内存空间，其虚拟内存空间映射可以通过查看 /proc/<!-- -->[pid]<!-- -->/maps 文件来确定。</p><p>上文中已经描述了运行 backtrace 程序得到的如下输出信息：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">10</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">21</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">04</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">31</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> program</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">problem $ </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">backtrace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">called by </span><span class="token number" style="color:#36acaa">0x555555555204</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">called by </span><span class="token number" style="color:#36acaa">0x555555555258</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">called by </span><span class="token number" style="color:#36acaa">0x555555555281</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">called by </span><span class="token number" style="color:#36acaa">0x5555555552a3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="用-gdb-来验证">用 gdb 来验证<a class="hash-link" href="#用-gdb-来验证" title="标题的直接链接">​</a></h3><p>gdb 挂起程序，反汇编调用到的不同函数，调用指令与返回地址指令列举如下：</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   0x000055555555529e &lt;+20&gt;:    callq  0x555555555261 &lt;test&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   **0x00005555555552a3 &lt;+25&gt;:  mov    $0x0,%eax**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x000055555555527c &lt;+27&gt;:    callq  0x555555555238 &lt;test1&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   **0x0000555555555281 &lt;+32&gt;:  mov    -0x8(%rbp),%eax**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x0000555555555253 &lt;+27&gt;:    callq  0x5555555551c4 &lt;test2&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   **0x0000555555555258 &lt;+32&gt;:  mov    -0x8(%rbp),%eax**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x00005555555551ff &lt;+59&gt;:    callq  0x555555555135 &lt;backtrace&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   **0x0000555555555204 &lt;+64&gt;:  movl   $0x0,-0x4(%rbp)**</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里加粗的表示返回地址，可以看到与上面的输出是对应的，不过由于 backtrace 是向后回溯的，与这里的<strong>顺序刚好相反</strong>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用-maps-文件来验证">使用 maps 文件来验证<a class="hash-link" href="#使用-maps-文件来验证" title="标题的直接链接">​</a></h3><p>上面 backtrace 程序运行的输出信息中 0x555555555204 这些地址是<strong>程序被映射到虚拟内存空间的虚拟地址</strong>，我通过执行如下步骤来获取到程序虚拟内存空间布局：</p><ol><li>使用 gdb 运行 backtrace 程序并在 main 函数处停下来</li><li>使用 pmap 查看 backtrace 程序的虚拟内存空间映射</li></ol><p>虚拟内存空间映射表如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:21:17:56</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> glibc-2.28 $ pmap -p </span><span class="token number" style="color:#36acaa">5201</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5201</span><span class="token plain">:   /home/longyu/problem_and_solution/program-problem/backtrace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000555555554000      4K r---- /home/longyu/problem_and_solution/program-problem/backtrace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000555555555000      4K r-x-- /home/longyu/problem_and_solution/program-problem/backtrace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000555555556000      4K r---- /home/longyu/problem_and_solution/program-problem/backtrace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000555555557000      4K r---- /home/longyu/problem_and_solution/program-problem/backtrace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000555555558000      4K rw--- /home/longyu/problem_and_solution/program-problem/backtrace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffff7dea000    136K r---- /usr/lib/x86_64-linux-gnu/libc-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffff7e0c000   1312K r-x-- /usr/lib/x86_64-linux-gnu/libc-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffff7f54000    304K r---- /usr/lib/x86_64-linux-gnu/libc-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffff7fa0000      4K ----- /usr/lib/x86_64-linux-gnu/libc-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffff7fa1000     16K r---- /usr/lib/x86_64-linux-gnu/libc-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffff7fa5000      8K rw--- /usr/lib/x86_64-linux-gnu/libc-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffff7fa7000     24K rw---   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> anon </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffff7fd0000     12K r----   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> anon </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffff7fd3000      8K r-x--   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> anon </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffff7fd5000      4K r---- /usr/lib/x86_64-linux-gnu/ld-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffff7fd6000    120K r-x-- /usr/lib/x86_64-linux-gnu/ld-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffff7ff4000     32K r---- /usr/lib/x86_64-linux-gnu/ld-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffff7ffc000      4K r---- /usr/lib/x86_64-linux-gnu/ld-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffff7ffd000      4K rw--- /usr/lib/x86_64-linux-gnu/ld-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffff7ffe000      4K rw---   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> anon </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffffffdd000    136K rw---   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> stack </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> total             2148K</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里我们需要关注 backtrace 程序在虚拟内存空间中的布局，可以看到有几个项目，起始地址为 0000555555554000，对应的项目如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0000555555554000      4K r---- /home/longyu/problem_and_solution/program-problem/backtrace</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>0000555555554000  即为 backtrace 程序映射的起始地址，我们用 backtrace 程序的输出地址减掉这个起始地址，将会得到下面几个地址：</p><p>0x1204
0x1258
0x1281
0x12a3</p><p>将这几个地址写入一个名为 test 的文件中，使用 xargs 读取这个文件制作参数调用 addr2line 命令，得到了如下信息：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:21:37:35</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> program-problem $ </span><span class="token function" style="color:#d73a49">xargs</span><span class="token plain"> -a ./test  addr2line -e ./backtrace </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/longyu/problem_and_solution/program-problem/./backtrace.c:38</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/longyu/problem_and_solution/program-problem/./backtrace.c:52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/longyu/problem_and_solution/program-problem/./backtrace.c:63</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/longyu/problem_and_solution/program-problem/./backtrace.c:72</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到 addr2line 成功解析出了指令在代码中的位置。对于动态库中的函数地址，有类似的过程！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="标题的直接链接">​</a></h2><p>一个简单的知识背后可能蕴藏了很多的问题，这些问题环环相扣，当你处在分析问题的过程中时，常常会感到头痛，但将整个过程串联起来后，却又会有非常大的成就感。</p><p>从一个问题跳跃到另外一个问题，绕来绕去最终又回到最初的问题，不过此时知识面得到了扩充，输入增加了，有了这个增加的输入信息，最初的问题已经不算是问题了！</p><p>本文的问题脉络大致有如下几点：</p><ol><li>如何使用 mtrace？</li><li>mtrace 脚本为什么不能打印源码行号？</li><li>addr2line 为什么不能打印源码行号？</li><li>mtrace 函数是如何工作的？</li><li>RETURN_ADDRESS 宏的定义是什么？</li><li>gcc 内建的 __builtin_return_address 是如何实现的？</li><li>从 backtrace 程序再次回到第三个问题</li></ol><p>注意在第 7 个关键点的时候，又回到了 3 这个点，不过这时候我有了 maps 文件这个输入，这个输入让 addr2line 不能打印行号的问题迎刃而解！</p><p>列出这些关键点只想抛出一个问题：<strong>你觉得自己会在哪个点结束呢？</strong></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/linux-kernel/linux-内核模块中引用符号是如何链接的">linux-kernel/linux-内核模块中引用符号是如何链接的</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-19T07:40:00.000Z" itemprop="datePublished">2022年6月19日</time> · <!-- -->11 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a class="hash-link" href="#前言" title="标题的直接链接">​</a></h2><p>linux 内核模块的加载流程去年大致琢磨了一遍，简单的写了个草稿后就在草稿箱里积压着。按照以往的风格，应当以一篇长文呈现，今天想想却觉得不太可取。为什么不从关键的问题着手，使用较短的篇幅来逐个击破呢？</p><p>最终选择了从问题出发的描述方式，在这种方式下，我首先得提出关键问题，这需要一定的训练，本文便是这样的一次实践。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="我的问题">我的问题<a class="hash-link" href="#我的问题" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-linux-内核模块是如何链接的">1. <strong>linux 内核模块是如何链接的？</strong><a class="hash-link" href="#1-linux-内核模块是如何链接的" title="标题的直接链接">​</a></h3><p>暂时无法回答。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-为什么要提这个问题">2. 为什么要提这个问题？<a class="hash-link" href="#2-为什么要提这个问题" title="标题的直接链接">​</a></h3><p>常规的 c 程序要经过编译链接来生成可执行文件，链接的过程会按照链接脚本的配置来完成可执行文件的 layout 同时也会对所有的可重定位项目进行重定位，以确定访问地址偏移。</p><p>linux 内核模块也有类似的过程，可编译生成的内核模块只是一个【可重定位目标文件】，<strong>那它的链接过程是在哪里执行的呢？</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="经验之谈">经验之谈<a class="hash-link" href="#经验之谈" title="标题的直接链接">​</a></h2><p>内核模块一般通过 insmod、modprobe 命令加载运行，既然要运行，肯定需要确定模块内调用的外部符号的偏移地址，这一过程可能在如下流程中进行：</p><ol><li>insmod、modprobe 命令中</li><li>内核代码中模块加载流程中</li></ol><p>曾经 strace 跟踪过 insmod 加载内核模块的过程，核心逻辑是调用 finit_module、init_module 系统调用，没有看到其它操作，于是判断内核模块的链接应当是在内核代码中做的。</p><p>下面我以一个简单的 hello world 内核模块为例，探讨内核中执行模块链接的过程。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一个简单的内核模块源码">一个简单的内核模块源码<a class="hash-link" href="#一个简单的内核模块源码" title="标题的直接链接">​</a></h2><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;linux/module.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;linux/init.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> __init </span><span class="token function" style="color:#d73a49">my_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">printk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">KERN_INFO </span><span class="token string" style="color:#e3116c">&quot;Hello from Hello Module\\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> __exit </span><span class="token function" style="color:#d73a49">my_exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">printk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">KERN_INFO </span><span class="token string" style="color:#e3116c">&quot;Bye from Hello Module\\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">module_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">my_init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">module_exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">my_exit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">MODULE_DESCRIPTION</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Sample Hello World Module&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">MODULE_LICENSE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;GPL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>将上述内容保存为 mymodule.c 使用如下 Makefile 内容编译：</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MODULE_FILENAME</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">mymodule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PWD </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">shell</span><span class="token plain"> pwd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-m </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">MODULE_FILENAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KO_FILE</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">MODULE_FILENAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">.ko</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> KROOT</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/lib/modules/</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">shell</span><span class="token plain"> uname -r</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">/build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token target symbol" style="color:#36acaa">modules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">@</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">MAKE</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> -C </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">KROOT</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> M</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token target symbol" style="color:#36acaa">modules_install</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">@</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">MAKE</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> -C </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">KROOT</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> M</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> modules_install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token target symbol" style="color:#36acaa">clean</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">@</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">MAKE</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> -C </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">KROOT</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> M</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> clean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rm -rf Modules.symvers modules.order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token target symbol" style="color:#36acaa">insert</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> modules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo insmod </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">KO_FILE</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token target symbol" style="color:#36acaa">remove</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo rmmod </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">MODULE_FILENAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token target symbol" style="color:#36acaa">printlog</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo dmesg -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo insmod </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">KO_FILE</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dmesg</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="objdump--d-mymoduleko">objdump -d mymodule.ko<a class="hash-link" href="#objdump--d-mymoduleko" title="标题的直接链接">​</a></h2><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .init.text:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000000 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">init_module</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">:   e8 00 00 00 00          callq  </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">init_module+0x</span><span class="token operator file-descriptor important" style="color:#393A34">5</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">:   </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"> c7 c7 00 00 00 00    mov    </span><span class="token variable" style="color:#36acaa">$0x0</span><span class="token plain">,%rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   c:   e8 00 00 00 00          callq  </span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">init_module+0x1</span><span class="token operator file-descriptor important" style="color:#393A34">1</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:   </span><span class="token number" style="color:#36acaa">31</span><span class="token plain"> c0                   xor    %eax,%eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:   c3                      retq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .exit.text:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000000 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">cleanup_module</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">:   </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"> c7 c7 00 00 00 00    mov    </span><span class="token variable" style="color:#36acaa">$0x0</span><span class="token plain">,%rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">:   e9 00 00 00 00          jmpq   c </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">__UNIQUE_ID_description1</span><span class="token operator file-descriptor important" style="color:#393A34">8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>init_module 为模块的初始化函数，在其中调用到的两个 <strong>callq</strong> 指令用于子函数调用。<strong>callq</strong> 指令的字节码为 <strong>0xe8</strong>，其后四个字节为函数跳转偏移，这里两个 <strong>callq</strong> 指令的函数跳转偏移值都为 0，这符合可重定位目标文件的特征，这里就是两处需要链接过程完成的重定位对象。</p><p>第二个 callq 可以明确是 printk，第一个 callq 根据 readelf -r 的输出判断是 <code>__fentry__ </code>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="readelf--r-mymoduleko">readelf -r mymodule.ko<a class="hash-link" href="#readelf--r-mymoduleko" title="标题的直接链接">​</a></h2><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Relocation section </span><span class="token string" style="color:#e3116c">&#x27;.rela.init.text&#x27;</span><span class="token plain"> at offset 0x1cb30 contains </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> entries:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000000000001  002600000004 R_X86_64_PLT32    0000000000000000 __fentry__ - </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000000000008  00060000000b R_X86_64_32S      0000000000000000 .rodata.str1.1 + </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000000000d  002800000004 R_X86_64_PLT32    0000000000000000 printk - </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Relocation section </span><span class="token string" style="color:#e3116c">&#x27;.rela.exit.text&#x27;</span><span class="token plain"> at offset 0x1cb78 contains </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> entries:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000000000003  00060000000b R_X86_64_32S      0000000000000000 .rodata.str1.1 + 1b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000000000008  002800000004 R_X86_64_PLT32    0000000000000000 printk - </span><span class="token number" style="color:#36acaa">4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>readelf -r 参数获取可执行目标文件的可重定位 section 表项。上述输出中有如下两个可重定位 section:</p><ol><li>.rela.init.text</li><li>.rela.exit.text</li></ol><p>每个 section 中都列举出了【需要重定位的项目】，一个项目有五个方面的内容，其中 <strong>Offset 为可重定位目标地址相对文件起始地址的偏移量</strong>，<strong>Type 为重定位的类型</strong>，用于计算偏移地址，<strong>Sym. Name + Addend 字段为符号名称以及计算地址偏移量时的修正值。</strong></p><p><strong>.rela.init_text section</strong> 中有两种重定位类型，<strong>R_X86_64_PLT32</strong>  用于函数偏移计算，<strong>R_X86_64_32S</strong> 用于数据偏移计算。str1.1 实际指向 init_module 函数中 printk 函数打印的字符串。</p><p>函数偏移的计算可以参考如下内容来学习：</p><blockquote><p>So despite the fact that the type of the relocation entry is R_X86_64_PLT32 the linker will still use the R_X86_64_PC32 computation (S + A - P) for the relocation target being modified, where:</p><p>   S is the value of the symbol (st_value of Elf64_Sym)
A is the addend (-4 in your case)
P is the address of the memory location being relocated (the start of the address of the call to Other)</p></blockquote><p>上述英文摘自 <a href="https://stackoverflow.com/questions/64424692/how-does-the-address-of-r-x86-64-plt32-computed" target="_blank" rel="noopener noreferrer">How does the address of R_X86_64_PLT32 computed?</a> 更多的信息可以阅读《深入理解计算机系统》第三版 7.7 节。</p><p>在下文中我会用一个实例来说明函数偏移地址的计算过程。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="在内核源码中找到模块链接相关代码">在内核源码中找到模块链接相关代码<a class="hash-link" href="#在内核源码中找到模块链接相关代码" title="标题的直接链接">​</a></h2><p>使用 R_X86_64_PLT32 关键字进行如下搜索：</p><ol><li>搜索 kernel 目录</li><li>搜索 arch/x86 目录
确定模块链接流程在 arch/x86/kernel/module.c 中实现。</li></ol><p>阅读 module.c 的代码，发现有一个调试信息，于是修改内核代码，开启调试信息。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="内核代码修改-patch">内核代码修改 patch<a class="hash-link" href="#内核代码修改-patch" title="标题的直接链接">​</a></h2><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">diff </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">git a</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">arch</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">x86</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">module</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c b</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">arch</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">x86</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">module</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index b052e883dd8c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">.11e39304</span><span class="token plain">c55f </span><span class="token number" style="color:#36acaa">100644</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> a</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">arch</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">x86</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">module</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">++</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> b</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">arch</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">x86</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">module</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">37</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">37</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> @@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;asm/setup.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;asm/unwind.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">#</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">#</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">DEBUGP</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">fmt</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">                               \\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">printk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">KERN_DEBUG fmt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ##__VA_ARGS__</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">196</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">196</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> @@ </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apply_relocate_add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Elf64_Shdr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sechdrs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> invalid_relocation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        val </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">if</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> overflow</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">212</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">213</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> @@ </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apply_relocate_add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Elf64_Shdr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sechdrs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               me</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ELF64_R_TYPE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rel</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ENOEXEC</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">               </span><span class="token function" style="color:#d73a49">DEBUGP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;val is 0x%llx\\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="重新编译并更新内核后加载-mymoduleko-后-dmesg-部分打印信息">重新编译并更新内核后加载 mymodule.ko 后 dmesg 部分打印信息<a class="hash-link" href="#重新编译并更新内核后加载-mymoduleko-后-dmesg-部分打印信息" title="标题的直接链接">​</a></h2><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">109.974417</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token builtin class-name">type</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> st_value ffffffffbda016d0 r_addend fffffffffffffffc loc ffffffffc0106001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">109.974418</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> val is 0xfffffffffd8fb6cb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由于打印信息很多，我只截取了其中的一条项目。在上述项目中关键的信息解析如下：</p><ol><li><p>type 4 表示重定位类型为 R_X86_64_PLT32 </p></li><li><p>st_value ffffffffbda016d0 表示 <code>__fentry__</code>符号地址</p><p>通过访问 /proc/kallsyms 文件确定，相关信息摘录如下；</p></li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">```bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@debian-10:17:55:34] helloworld_module # grep __fentry__ /proc/kallsyms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ffffffffbda016d0 T __fentry__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li><p>r_addend fffffffffffffffc  为上文中 readelf -r 输出中 <code>__fentry__</code>函数的 Addend 值—— -4</p></li><li><p>loc ffffffffc0106001 表示上文中 readelf -r 输出中<code>__fentry__</code>被重定位区域在内核的实际地址</p></li><li><p>val is 0xfffffffffd8fb6cb，val 为最终计算出的访问 <code>__fentry__</code>函数的偏移量，会被填充到 loc 指向的地址中</p><p>val 计算公式为 S + A - P: ffffffffbda016d0 + fffffffffffffffc  - ffffffffc0106001 = <strong>0xfffffffffd8fb6cb</strong></p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="核心内核代码">核心内核代码<a class="hash-link" href="#核心内核代码" title="标题的直接链接">​</a></h2><p>内核代码中相关函数调用关系如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">init_module</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">finit_module</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load_module</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       apply_relocations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           apply_relocate_add</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>apply_relocate_add 函数中完成重定向任务，核心代码摘录如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> sechdrs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">relsec</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_size </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">/* This is where to make the change */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                loc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">sechdrs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">sechdrs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">relsec</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_info</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> rel</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r_offset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">/* This is the symbol it is referring to.  Note that all</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                   undefined symbols have been resolved.  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sym </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Elf64_Sym </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">sechdrs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">symindex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ELF64_R_SYM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rel</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">DEBUGP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;type %d st_value %Lx r_addend %Lx loc %Lx\\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">ELF64_R_TYPE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rel</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       sym</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">st_value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rel</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r_addend</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sym</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">st_value </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> rel</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r_addend</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">ELF64_R_TYPE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rel</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> R_X86_64_NONE</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> R_X86_64_64</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u64 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> invalid_relocation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u64 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> R_X86_64_32</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> invalid_relocation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> overflow</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> R_X86_64_32S</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> invalid_relocation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> overflow</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> R_X86_64_PC32</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> R_X86_64_PLT32</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> invalid_relocation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        val </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述代码遍历每个可重定位 section 项目，loc 指向模块加载到内核后存储每个可重定位项目被重定位区域的内存地址，代表 <strong>R_X86_64_PLT32</strong>  中的标号 <strong>P</strong>。</p><p>sym 中保存已经 resolve 的未定义符号，sym-&gt;value 表示符号加载地址，代表 <strong>R_X86_64_PLT32</strong>  中的标号 <strong>S</strong>。</p><p>rel<!-- -->[i]<!-- -->.r_addend 保存可重定位项目的 <strong>Addend</strong> 值，代表 <strong>R_X86_64_PLT32</strong>  中的标号 <strong>A</strong>。</p><p>在确定了这些信息后，switch 语句通过可重定位项目的 Type 字段进行逻辑分发，计算并填充重定位后的地址。对于 R_X86_64_PLT32  这种类型来说，计算公式就是 <strong>S + A - P</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="标题的直接链接">​</a></h2><p>善于提问是一种很好的能力。主动发现并提出问题然后积极的寻找答案，最后给出合理的答案，收获成就感并推动自己继续提出新的问题，这是一个正反馈。从自己能够回答的小问题开始，不断的循环往复，雪球会越滚越大，时间正站在你这边。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/2022/06/12/序言">写博客的意义</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-12T00:00:00.000Z" itemprop="datePublished">2022年6月12日</time> · <!-- -->5 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><p>我没有养成写博客的习惯，我一直对自己的记忆力抱有某种特别的自信。最近我发现，我也忘记了很多东西。我在几周前搜集了一些资料，学习了如何使用虚拟机来调试 linux 内核，但我没有总结。现在虽然环境已经搭建好了，但我忘记了操作串口的命令行，我还得继续查资料，又将花费很多时间。如果有一天，我升级了系统，那么我需要重新以过来人的身份从零开始，这只是简单的重复，没有学习的空间。</p><p>事实上，我最近几年忘记了学过的很多东西。我一直都没养成记录的习惯，我觉得这样下去我永远在前学后忘，永远重新开始，而不是站在过去的基础之上。</p><p>站在巨人的肩膀之上，这是一句很经典的名言。我即便不能站在巨人的肩膀之上，我只要能够站在过去努力的基础之上就能够看得更远，毕竟我站的更高了呀。可是我发现过去没有成为我足下的土地，它仅仅成为了我的一段模糊记忆。为此，我感到惭愧，更感到惋惜。我明明可以站的更高，可不好的习惯却让我总是站在平地。</p><p>今天我所拥有的一切都是我自己一步步获取的，这些事情有好有坏，它构成了我现在所有的生活。如果我有任何的不满与悔恨，我都只能抱怨自己。我觉得自己很可耻，自己很可悲，自己很可怜。可我更明白只有改变能够让我拥有进入一个好环境的入场券，我要这样去做。</p><p>写博客是文字的一个突破点。想要更加准确、清楚的表达出一件事情，这本身就需要强大的文笔支持。我确实写过了很多文章，但我唯一清楚的是我还有很大的上升空间，我的文字还可以更好。这就是写博客对我的一大意义。</p><p>同时，写博客也将帮助我保留住过去的基础，让我不用每次都重新开始，哪怕仅仅能够提供轻微的参考价值，这也能节省我的时间。</p><p>写博客也是向他人展示自我的一次尝试，虽然这点并不是初衷所在。</p><p>现有博文的数量已经十分庞大，我想写的东西很多人都已经写过了。可我想我仍旧能够写出新的东西，我以自己的视角与思维来组织文字，至少这些文字是独门独院的，它拥有仅仅属于我的风格。那么就让我以博客来描绘出完整的自我肖像吧！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="写博客推动思考">写博客推动思考<a class="hash-link" href="#写博客推动思考" title="标题的直接链接">​</a></h2><p>这篇文章已经发了有一两年了，今天我觉得其实我写博客的主要目的是想凭借这一过程来推动自我思考。在研究一些代码时，可能不够深入，看的模模糊糊，可真正总结起来，却不得不深入的思考以免写出云里雾里的文章。</p><p>我力求让写博客成为推动自己思考的一种方式，更进一步将其发展为一种习惯，这样思考便能够扩大，而这正是我认可的竞争力所在！恐怕这才是我写博客的意义！至于说形式上的，或者别人认为的，或者其它的东西在这个意义面前都变得无关紧要了！</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/longyu.github.io/blog/tags/blog">blog</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/longyu.github.io/blog/page/6"><div class="pagination-nav__label">较新的博文</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="footer__link-item">longyuwlz<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/longyu.github.io/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 龙瑜的文字世界, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/longyu.github.io/assets/js/runtime~main.9bcca1a9.js"></script>
<script src="/longyu.github.io/assets/js/main.4339af60.js"></script>
</body>
</html>