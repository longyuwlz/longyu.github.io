<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/longyu.github.io/blog/rss.xml" title="龙瑜的文字世界 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/longyu.github.io/blog/atom.xml" title="龙瑜的文字世界 Atom Feed"><title data-rh="true">龙瑜的博客 | 龙瑜的文字世界</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://longyuwlz.github.io/longyu.github.io/blog/page/2"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="龙瑜的博客 | 龙瑜的文字世界"><meta data-rh="true" name="description" content="美好的时光在文字中停滞不前"><meta data-rh="true" property="og:description" content="美好的时光在文字中停滞不前"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="canonical" href="https://longyuwlz.github.io/longyu.github.io/blog/page/2"><link data-rh="true" rel="alternate" href="https://longyuwlz.github.io/longyu.github.io/blog/page/2" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://longyuwlz.github.io/longyu.github.io/blog/page/2" hreflang="x-default"><link rel="stylesheet" href="/longyu.github.io/assets/css/styles.f233e9eb.css">
<link rel="preload" href="/longyu.github.io/assets/js/runtime~main.9bcca1a9.js" as="script">
<link rel="preload" href="/longyu.github.io/assets/js/main.4339af60.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/longyu.github.io/"><div class="navbar__logo"><img src="/longyu.github.io/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/longyu.github.io/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">龙瑜的文字世界</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/longyu.github.io/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">历史发布</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/Failed to mmap 2MB hugepages 与 max_map_count limit">dpdk/Failed to mmap 2MB hugepages 与 max_map_count limit</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/I210 网卡设定 force link mode 并关闭 EEE mode">dpdk/I210 网卡设定 force link mode 并关闭 EEE mode</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/Unsupported SFP+ Module">dpdk/Unsupported SFP+ Module</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk ebpf 库跨版本移植">dpdk ebpf 库跨版本移植</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk mempool cache 机制分析">dpdk/dpdk mempool cache 机制分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 不同版本下载地址">dpdk/dpdk 不同版本下载地址</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 多进程模型共享队列收发包 virtio 网卡段错误问题">dpdk 多进程模型</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 官方 bugzilla 导出信息">dpdk/dpdk 官方 bugzilla 导出信息</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 对 numa 的使用与多 numa 架构下性能调优的基础">dpdk/dpdk 对 numa 的使用与多 numa 架构下性能调优的基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 收发包函数分析：dpdk-20.11 ice sse 向量收发包函数关键过程分析">收发包向量函数实现分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 死锁问题后续之初始化假设不可迁移问题">dpdk/dpdk 死锁问题后续之初始化假设不可迁移问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 用户态驱动框架及其演进过程分析">dpdk 用户态驱动框架及其部分演进过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序性能问题排查的一般流程">dpdk/dpdk 程序性能问题排查的一般流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序接口 down、up 问题定位的一般流程">接口 up、down 失败问题排查</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序收发包问题排查的一般流程">dpdk 程序收发包问题排查</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序绑不同的核性能有明显差异问题分析">dpdk/dpdk 程序绑不同的核性能有明显差异问题分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序绑核失败问题：EAL: pthread_setaffinity_np failed">问题描述</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 问题分析：不兼容光模块导致 dpdk 程序运行失败问题定位">dpdk/dpdk 问题分析：不兼容光模块导致 dpdk 程序运行失败问题定位</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 驱动移植叩开 kni 模块那些黑暗的角落">dpdk/dpdk 驱动移植叩开 kni 模块那些黑暗的角落</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 eal lcore 多线程机制分析">dpdk 多线程流水线</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 eal 初始化 log 信息解析">dpdk/dpdk-16.04 eal 初始化 log 信息解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 igb crc length 统计问题">dpdk/dpdk-16.04 igb crc length 统计问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 igb_uio 模块分析">dpdk/dpdk-16.04 igb_uio 模块分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 l2fwd 源码分析">dpdk/dpdk-16.04 l2fwd 源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 rte_kni 模块与内核内存泄露问题">问题描述</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 rte_kni 模块分析">dpdk/dpdk-16.04 rte_kni 模块分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 rte_spinlock.h rte_cpu_get_flag_enabled 接口问题">dpdk/dpdk-16.04 rte_spinlock.h rte_cpu_get_flag_enabled 接口问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 扩展新网卡驱动过程">编译相关配置添加</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 根目录中 .git 目录对编译参数的影响">dpdk/dpdk-16.04 根目录中 .git 目录对编译参数的影响</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 监听 uio 文件检测中断的示例 demo 与内部实现解析">dpdk/dpdk-16.04 监听 uio 文件检测中断的示例 demo 与内部实现解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 虚拟化环境 virtio 网卡 secondary 进程段错误问题分析定位">dpdk/dpdk-16.04 虚拟化环境 virtio 网卡 secondary 进程段错误问题分析定位</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 解初始化过程">dpdk/dpdk-16.04 解初始化过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 配置与编译过程分析">dpdk/dpdk-16.04 配置与编译过程分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-19.11 armv8 l2fwd 在某 arm 内核上无法运行问题">dpdk/dpdk-19.11 armv8 l2fwd 在某 arm 内核上无法运行问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-19.11 支持接口配置速率双工的方法">前言</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk程序启动顺序引发的血案">dpdk/dpdk程序启动顺序引发的血案</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/ethtool 命令指定的网络设备名在哪里被使用？">dpdk/ethtool 命令指定的网络设备名在哪里被使用？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/gcc constructor 属性修饰的构造函数未被链接问题">dpdk/gcc constructor 属性修饰的构造函数未被链接问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/igb_uio.ko 的 md5sum 为啥又变化了？">dpdk/igb_uio.ko 的 md5sum 为啥又变化了？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/l2fwd 支持 x710 通过 fdir 过滤非分片 ipv4 udp 报文">dpdk/l2fwd 支持 x710 通过 fdir 过滤非分片 ipv4 udp 报文</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/x710 hash 分片与非分片 tcp 报文异常问题">dpdk/x710 hash 分片与非分片 tcp 报文异常问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/不懂 dpdk mbuf 结构？此篇文章带你超神">dpdk 中 mbuf 的结构</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/以 ixgbe pmd 驱动为例研究 dpdk pmd 驱动中注册中断回调函数并使能中断的过程">dpdk/以 ixgbe pmd 驱动为例研究 dpdk pmd 驱动中注册中断回调函数并使能中断的过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/以 rte_mempool_ops_table 为例描述 dpdk 程序库链接顺序对程序执行的影响">dpdk mempool_ops</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/使用内核驱动上手 x710 flow directory 功能">环境介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/关闭 stdout 引发的灾难">dpdk/关闭 stdout 引发的灾难</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/杀掉数通引擎导致虚拟机重启问题定位">dpdk/杀掉数通引擎导致虚拟机重启问题定位</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/网卡接口绑定驱动及其使用的 bind、unbind、new_id 等 sys 文件">dpdk/网卡接口绑定驱动及其使用的 bind、unbind、new_id 等 sys 文件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/试玩 dpdk ebfp 功能">dpdk/试玩 dpdk ebfp 功能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk kni 口 ifconfig up down 的执行流程">dpdk/dpdk kni 口 ifconfig up down 的执行流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 中 rte_config.h 配置文件生成的问题">dpdk/dpdk 中 rte_config.h 配置文件生成的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 中 rte_eth_link_get_wait、nowait 函数研究">dpdk/dpdk 中 rte_eth_link_get_wait、nowait 函数研究</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 常见问题：uio 设备文件创建以及 iommu 导致 x710 网卡初始化失败问题">uio 设备文件创建的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序创建 kni 虚拟网络接口失败的问题">dpdk/dpdk 程序创建 kni 虚拟网络接口失败的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 问题排查的第一关：基础环境的排查">dpdk/dpdk 问题排查的第一关：基础环境的排查</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/编译dpdk-19.10时遇到的问题">dpdk/编译dpdk-19.10时遇到的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-kni与ethtool试玩问题记录">dpdk/dpdk-kni与ethtool试玩问题记录</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-pdump工具编译运行">dpdk/dpdk-pdump工具编译运行</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-pdump编译运行">dpdk/dpdk-pdump编译运行</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk库源码中包含内核头文件的问题">dpdk/dpdk库源码中包含内核头文件的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk收发包测试之使用内核接口给dpdk绑定的端口发包">dpdk/dpdk收发包测试之使用内核接口给dpdk绑定的端口发包</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/ethtool 读到的状态与 dpdk 读到的网卡状态不一致">dpdk/ethtool 读到的状态与 dpdk 读到的网卡状态不一致</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/将网卡绑定到官方驱动测试过程">dpdk/将网卡绑定到官方驱动测试过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/记录一次编译器版本过低导致 dpdk 无法成功编译的问题">dpdk/记录一次编译器版本过低导致 dpdk 无法成功编译的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/设置 EXTRA_CFLAGS 以编译 debug 版本 dpdk 库">dpdk/设置 EXTRA_CFLAGS 以编译 debug 版本 dpdk 库</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/libc/使用mtrace跟踪内存泄露问题">libc/使用mtrace跟踪内存泄露问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/linux-kernel/linux-内核模块中引用符号是如何链接的">linux-kernel/linux-内核模块中引用符号是如何链接的</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/2022/06/12/序言">写博客的意义</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 死锁问题后续之初始化假设不可迁移问题">dpdk/dpdk 死锁问题后续之初始化假设不可迁移问题</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->16 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a class="hash-link" href="#前言" title="标题的直接链接">​</a></h2><p>在 <a href="https://blog.csdn.net/Longyu_wlz/article/details/124261738" target="_blank" rel="noopener noreferrer">程序启动顺序引发的血案之 dpdk 进程死锁</a> 这篇博客中，我描述了 dpdk 多进程之间共享的用户态锁在临界区被异常杀死后无法再获取到锁的问题。修改的方案是将这些在多个进程之间共享的锁修改为 pthread mutex 互斥锁。</p><p>前期的测试验证与代码 review 及集成测试都没有发现异常，最近却发现又出现了死锁的问题。最开始我的想法是现在使用了 mutex 锁，出现了死锁也能够找到是谁占有了锁，问题应该不太困难，实际操作起来却发现有些想当然。</p><p>在本文中我将完整地描述这一新死锁问题定位的过程。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题描述">问题描述<a class="hash-link" href="#问题描述" title="标题的直接链接">​</a></h2><p>问题的表面现象是某个运行在 docker 容器内的 dpdk 业务程序一直无法启动，使用 gdb 查看调用栈，发现卡在如下位置处：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff14034ed</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">__lll_lock_wait</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from target</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib64</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">libpthread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff13fedcb</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">_L_lock_883</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from target</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib64</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">libpthread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff13fec98</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">pthread_mutex_lock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from target</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib64</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">libpthread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff22267d9</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_mutex_lock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from target</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib64</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">libdpdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff223835f</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">malloc_heap_alloc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from target</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib64</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">libdpdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff2233337</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_malloc_socket</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from target</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib64</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">libdpdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">6</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff223bd1d</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_service_init</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from target</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib64</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">libdpdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">7</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff22160c1</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_eal_init</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from target</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib64</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">libdpdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x000000000043e51d</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">main</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>rte_mutex_lock 函数是对 pthread_mutex_lock</strong> 函数的【封装】，从函数调用栈上看，进程无法正常启动的原因是无法成功获取到 mutex 锁。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题定位过程">问题定位过程<a class="hash-link" href="#问题定位过程" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-哪一把锁获取不到">1. 哪一把锁获取不到？<a class="hash-link" href="#1-哪一把锁获取不到" title="标题的直接链接">​</a></h3><p>相关代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* this will try lower page sizes first */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">malloc_heap_alloc_on_heap_id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">size_t</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> heap_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">size_t</span><span class="token plain"> align</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">size_t</span><span class="token plain"> bound</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bool contig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mem_config</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mcfg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_eal_get_configuration</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mem_config</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">malloc_heap</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">heap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mcfg</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">malloc_heaps</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">heap_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> size_flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flags </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">RTE_MEMZONE_SIZE_HINT_ONLY</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> socket_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">rte_spinlock_lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">heap</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>确认是获取不到 rte_mem_config 中某个 malloc_heaps 的多进程共享锁。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-获取不到的锁到底是被谁占用的">2. 获取不到的锁到底是被谁占用的？<a class="hash-link" href="#2-获取不到的锁到底是被谁占用的" title="标题的直接链接">​</a></h3><p>编译相同版本的 dpdk-procinfo 调试获取到如下信息：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> bt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff6eacbfc</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">__lll_lock_wait</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">usr</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">local</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">libpthread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff6ea84df</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">_L_lock_520</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">usr</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">local</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">libpthread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff6ea82df</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">pthread_mutex_lock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">usr</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">local</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">libpthread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000066e3b9</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_mutex_lock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mutex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x3fffdcffd180</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">eal_common_mcfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">93</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000067ff3f</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">malloc_heap_alloc_on_heap_id</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bound</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> align</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> flags</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> heap_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8192</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x3fffdcffa000</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\356o.\001c\001\v\023\004&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">malloc_heap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">646</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">  </span><span class="token function" style="color:#d73a49">malloc_heap_alloc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">type@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0xc02a2e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rte_services&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8192</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> socket_arg</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">optimized out</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> socket_arg@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> flags</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">flags@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> align</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bound</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">bound@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    contig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">malloc_heap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">724</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">6</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000067af17</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_malloc_socket</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">type@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0xc02a2e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rte_services&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">size@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8192</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> align</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">align@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> socket_arg</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">optimized out</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> socket_arg@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rte_malloc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">7</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000067afa5</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_zmalloc_socket</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">type@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0xc02a2e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rte_services&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">size@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8192</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> align</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">align@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> socket</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">socket@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rte_malloc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">79</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">8</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000067afba</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_zmalloc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">type@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0xc02a2e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rte_services&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">size@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8192</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> align</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">align@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rte_malloc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">99</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">9</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000067afee</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_calloc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">type@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0xc02a2e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rte_services&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> num</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">num@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">size@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> align</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">align@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rte_malloc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">117</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00000000006838fd</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_service_init</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rte_service</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">84</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x000000000065dca1</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_eal_init</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">optimized out</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> argv</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">optimized out</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">linux</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">eal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1266</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0000000000558a1c</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">main</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> argv</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x7fffffffe8c8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">app</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">proc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">info</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">main</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1771</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> frame </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000066e3b9</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_mutex_lock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mutex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x3fffdcffd180</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">eal_common_mcfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">93</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">93</span><span class="token plain">      dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">eal_common_mcfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> No such file or directory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> print mutex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">pthread_mutex_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3fffdcffd180</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> print </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mutex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">__data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">__lock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __owner </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14901</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __nusers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __kind </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __spins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">__prev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\002\000\000\000\000\000\000\000\065:\000\000\001&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">&#x27;\000&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">repeats </span><span class="token number" style="color:#36acaa">26</span><span class="token plain"> times</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __align </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由于我对 mutex 中不同结构的含义并不清楚，我先在本地写了一个简单的 demo，然后观察占有了锁之后 mutex 一些字段的含义，确认 <strong>__owner</strong> 字段表示【占有锁的线程、进程 id】。</p><p>于是能够确认这把锁被 <strong>14901</strong> 线程持有，然而这个线程在系统中<strong>并不存在</strong>，也没有看到其它的异常信息，表明这个进程早已经被 kill 掉了。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-gdb-查看-rte_mem_config-文件的内容">3. gdb 查看 rte_mem_config 文件的内容<a class="hash-link" href="#3-gdb-查看-rte_mem_config-文件的内容" title="标题的直接链接">​</a></h3><p>曾经定位过一个 rte_mem_config文件内容被破坏导致死锁的问题，此后每次都会先确认下 rte_mem_config 文件的内容是否正常。于是用 gdb 打印相关信息，部分摘录如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> print </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">x  </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rte_config</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mem_config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  magic </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x12e6fee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x130b0163</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nchannel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nrank </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mlock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __lock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __owner </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __nusers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __kind </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x90</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __spins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __prev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">repeats </span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> times</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x90</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">repeats </span><span class="token number" style="color:#36acaa">23</span><span class="token plain"> times</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __align </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x100000000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  memzones </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0x6d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x65</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x6d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x7a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x6f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x6e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x65</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">repeats </span><span class="token number" style="color:#36acaa">57</span><span class="token plain"> times</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x27</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xa00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    elt_sz </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3fffdd000000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rwlock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __lock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __owner </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __nusers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __kind </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x90</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __spins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __prev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">repeats </span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> times</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x90</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">repeats </span><span class="token number" style="color:#36acaa">23</span><span class="token plain"> times</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __align </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x100000000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  memsegs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        base_va </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3fffdd200000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addr_64 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3fffdd200000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      page_sz </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x200000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      socket_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xa1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x400000000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      external </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      heap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      memseg_arr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0x6d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x65</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x6d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x73</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x65</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x67</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x34</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x38</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x6b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">repeats </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"> times</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        elt_sz </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3fffdd02e000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rwlock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __lock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __owner </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __nusers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __kind </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x90</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __spins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              __prev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              __next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">repeats </span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> times</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x90</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">repeats </span><span class="token number" style="color:#36acaa">23</span><span class="token plain"> times</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __align </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x100000000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  malloc_heaps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __lock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __owner </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3a35</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __nusers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __kind </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __spins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __prev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0x2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x35</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">repeats </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> times</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __align </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>初次浏览并没有发现啥异常，但其实问题已经隐含在上面收集的信息里了，这里容我先卖个关子，这样才更贴切定位此问题的真实过程。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-还能做些什么">4. 还能做些什么？<a class="hash-link" href="#4-还能做些什么" title="标题的直接链接">​</a></h3><p>定位到这一步，尽管能够确定锁确实是被其它进程占用而无法被获取到，但占用进程早已经<strong>消失得无影无踪</strong>，只留下个无用的现场根本定位不了问题。于是我判断已经啥都做不了了，只能先恢复环境继续测试了。</p><p>同时我想到了如下几个问题：</p><ol><li><p>需要确定占着锁的进程到底是哪个，重新复现问题，复现前不断 ps aux 保存结果，问题复现后即可以判断是哪个程序没有释放</p><p>做这个测试的目的主要是为了缩小范围，却并不能一次就定位到问题。</p></li><li><p>前期对锁异常回收的验证过程是否存在问题？
前期各种临界区异常退出都测试过，均测试通过，存在问题的概率很小。</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题出现几次后发现的关键信息">问题出现几次后发现的关键信息<a class="hash-link" href="#问题出现几次后发现的关键信息" title="标题的直接链接">​</a></h2><p>此后，问题又复现了几次，每次复现时，我基本上都查看类似的信息，查看了几次后，我突然发现了一个明显的问题——malloc_heaps 中的 mutex lock 的 <strong>__kind</strong> 字段为 0x0，而其它类似的 <strong>mutex lock</strong> 的 <strong>__kind</strong> 字段为 <strong>0x90</strong>。重新翻了下几次复现时收集到的信息，发现都有这个特征。上文中卖的关子到此揭晓。</p><p>具体的对比如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   rwlock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __lock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __owner </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __nusers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __kind </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x90</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __spins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              __prev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              __next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">malloc_heaps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __lock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __owner </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3a35</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __nusers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __kind </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __spins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __prev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当时我在尝试用 mutex 替换 dpdk 多进程之间用户态锁时曾经分析过 <strong>__kind</strong> 这个字段，确定它是<strong>在设置 mutex 属性的时候被赋值</strong>。</p><p>对于 dpdk 多进程共享锁的场景，<strong>初始化 mutex 锁的时候需要设定 PTHREAD_PROCESS_SHARED 与 PTHREAD_MUTEX_ROBUST 属性</strong>，正常的 <strong>__kind</strong> 应该是 <strong>0x90</strong>。</p><p>在这个问题里这把 mutex 锁【未初始化】就被使用，它不支持异常回收，这样在获取到这把锁后没有释放锁进程就被异常杀死时就会导致其它需要再次获取这把锁的进程死锁。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="存在问题的代码在哪里">存在问题的代码在哪里？<a class="hash-link" href="#存在问题的代码在哪里" title="标题的直接链接">​</a></h2><p>阅读代码，确认如下 dpdk 代码存在问题：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rte_eal_malloc_heap_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mem_config</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mcfg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_eal_get_configuration</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mem_config</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">internal_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">match_allocations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">RTE_LOG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DEBUG</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> EAL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Hugepages will be freed exactly as allocated.\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">rte_eal_process_type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> RTE_PROC_PRIMARY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* assign min socket ID to external heaps */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mcfg</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">next_socket_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> EXTERNAL_HEAP_MIN_SOCKET_ID</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* assign names to default DPDK heaps */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_socket_count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">malloc_heap</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">heap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mcfg</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">malloc_heaps</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> heap_name</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">RTE_HEAP_NAME_MAX_LEN</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> socket_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_socket_id_by_idx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">snprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">heap_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">heap_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;socket_%i&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> socket_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">strlcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">heap</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> heap_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> RTE_HEAP_NAME_MAX_LEN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            heap</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">socket_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> socket_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>dpdk 原生使用 <strong>spinlock</strong> 保护 <strong>malloc_heaps</strong> 结构，<strong>spinlock</strong> 的初始化值为 0。由于 rte_mem_config 中 malloc_heaps 所有字段的初值就是 0，所以它并没有显示调用 rte_spinlock_init 函数来初始化 spinlock，<strong>而rte_spinlock_init 本身就会将 spinlock cnt 值初始化为 0，没有初始化也不影响正常执行。</strong></p><p>但是当把 <strong>spinlock</strong> 换为 <strong>mutex</strong> 时就【必须初始化】，不然锁【不能回收】，这样进程在临界区中被杀掉就会导致死锁，这就是本文所描述问题的根本原因。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="本地模拟问题">本地模拟问题<a class="hash-link" href="#本地模拟问题" title="标题的直接链接">​</a></h2><p>将 dpdk 代码修改如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">malloc_heap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">malloc_heap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">++</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">malloc_heap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">645</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">645</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> @@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">#ifndef F_OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">#define F_OK </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">       </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">access</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/tmp/abnormal_exit&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> F_OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">               </span><span class="token function" style="color:#d73a49">exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        align </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> align </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> align</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>测试步骤：</p><ol><li>重新编译 dpdk 后运行 l2wd</li><li>创建 /tmp/abnormal_exit</li><li>运行 dpdk-procinfo</li><li>重新运行 dpdk-procinfo</li></ol><p>dpdk-procinfo 测试过程记录如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@debian</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">home</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">longyu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mutex</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lock</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">test# touch </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tmp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">abnormal_exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@debian</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">home</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">longyu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mutex</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lock</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">test# </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">procinfo </span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">stats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Detected </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lcore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Detected </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> NUMA nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Multi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">process socket </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">run</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rte</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mp_socket_3885_1494910686fd8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Selected IOVA mode </span><span class="token char">&#x27;PA&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Probing VFIO support</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@debian</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">home</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">longyu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mutex</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lock</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">test# gdb </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">args </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">procinfo </span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">stats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GNU </span><span class="token function" style="color:#d73a49">gdb</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Debian </span><span class="token number" style="color:#36acaa">10.1</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1.7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.1</span><span class="token number" style="color:#36acaa">.90</span><span class="token number" style="color:#36acaa">.20210103</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reading symbols from </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">procinfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Continuing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Detected </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lcore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Detected </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> NUMA nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">New Thread </span><span class="token number" style="color:#36acaa">0x7ffff77e3700</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LWP </span><span class="token number" style="color:#36acaa">3905</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Multi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">process socket </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">run</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rte</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mp_socket_3901_1494f794ad440</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">New Thread </span><span class="token number" style="color:#36acaa">0x7ffff6fe2700</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LWP </span><span class="token number" style="color:#36acaa">3906</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Selected IOVA mode </span><span class="token char">&#x27;PA&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Probing VFIO support</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">^</span><span class="token plain">C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;dpdk-procinfo&quot;</span><span class="token plain"> received signal SIGINT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Interrupt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">__lll_lock_wait</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">futex</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">futex@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x3ffe92ffd180</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> private</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> at lowlevellock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">52</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">52</span><span class="token plain">      lowlevellock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> No such file or directory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> bt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  </span><span class="token function" style="color:#d73a49">__lll_lock_wait</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">futex</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">futex@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x3ffe92ffd180</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> private</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> at lowlevellock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">52</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff79d5843</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">__GI___pthread_mutex_lock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mutex</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">mutex@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x3ffe92ffd180</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> at </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nptl</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pthread_mutex_lock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000066e3b9</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_mutex_lock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mutex</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">mutex@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x3ffe92ffd180</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">eal_common_mcfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">93</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000067ff51</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">malloc_heap_alloc_on_heap_id</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bound</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> align</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> flags</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> heap_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8192</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x3ffe92ffd180</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\002&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">malloc_heap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">646</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">  </span><span class="token function" style="color:#d73a49">malloc_heap_alloc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">type@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0xc02a7e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rte_services&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8192</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> socket_arg</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">optimized out</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> socket_arg@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flags</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">flags@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> align</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bound</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">bound@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> contig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">malloc_heap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">730</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000067af17</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_malloc_socket</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">type@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0xc02a7e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rte_services&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">size@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8192</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> align</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">align@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    socket_arg</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">optimized out</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> socket_arg@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rte_malloc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">6</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000067afa5</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_zmalloc_socket</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">type@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0xc02a7e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rte_services&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">size@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8192</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> align</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">align@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    socket</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">socket@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rte_malloc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">79</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">7</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000067afba</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_zmalloc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">type@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0xc02a7e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rte_services&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">size@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8192</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> align</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">align@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rte_malloc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">99</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">8</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000067afee</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_calloc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">type@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0xc02a7e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rte_services&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> num</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">num@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">size@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    align</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">align@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rte_malloc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">117</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">9</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000068392d</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_service_init</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rte_service</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">84</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x000000000065dca1</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_eal_init</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">optimized out</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> argv</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">optimized out</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">linux</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">eal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1266</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0000000000558a1c</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">main</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> argv</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x7fffffffe5b8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">app</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">proc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">info</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">main</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1771</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> frame </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000066e3b9</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_mutex_lock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mutex</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">mutex@entry</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x3ffe92ffd180</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">eal_common_mcfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">93</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">93</span><span class="token plain">      dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">eal_common_mcfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> No such file or directory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> print </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mutex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">__data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">__lock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __owner </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3885</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __nusers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __kind </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __spins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">__prev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\002\000\000\000\000\000\000\000-\017\000\000\001&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">&#x27;\000&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">repeats </span><span class="token number" style="color:#36acaa">26</span><span class="token plain"> times</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __align </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过控制 <strong>/tmp/abnormal_exit</strong> 文件的创建触发临界区异常退出，退出后重新运行 <strong>dpdk-procinfo</strong> 程序确认能够复现出与本文描述的问题完全一样的现象，而此时 <strong>3885</strong> 进程已经不存在，锁不能释放。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="修改代码测试">修改代码测试<a class="hash-link" href="#修改代码测试" title="标题的直接链接">​</a></h2><p>测试代码示例如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">malloc_heap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">malloc_heap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">++</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">malloc_heap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">645</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">645</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> @@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">#ifndef F_OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">#define F_OK </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">       </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">access</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/tmp/abnormal_exit&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> F_OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">               </span><span class="token function" style="color:#d73a49">exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        align </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> align </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> align</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1391</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1397</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> @@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token string" style="color:#e3116c">&quot;socket_%i&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> socket_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token function" style="color:#d73a49">strlcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">heap</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> heap_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> RTE_HEAP_NAME_MAX_LEN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        heap</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">socket_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> socket_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">                       </span><span class="token function" style="color:#d73a49">rte_mutex_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">heap</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>核心修改是在<strong>初始化 malloc_heaps 的时候调用 rte_mutex_init 函数初始化 mutex 互斥锁</strong>。</p><p>重新编译 l2fwd 与 dpdk-procinfo 进行测试，测试步骤如下：</p><ol><li>运行 l2wd</li><li>创建 /tmp/abnormal_exit</li><li>运行 dpdk-procinfo</li><li>删除 /tmp/abnormal_exit 文件并重新运行 dpdk-procinfo</li></ol><p>第四步 dpdk-procinfo 能够正常运行表明锁被释放，问题得到修复！测试过程记录如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@debian</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">home</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">longyu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mutex</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lock</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">test# rm </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rf </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tmp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">abnormal_exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@debian</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">home</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">longyu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mutex</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lock</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">test# touch </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tmp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">abnormal_exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@debian</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">home</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">longyu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mutex</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lock</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">test# </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">procinfo </span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">stats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Detected </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lcore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Detected </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> NUMA nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Multi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">process socket </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">run</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rte</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mp_socket_3936_14a881225806c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Selected IOVA mode </span><span class="token char">&#x27;PA&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Probing VFIO support</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@debian</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">home</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">longyu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mutex</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lock</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">test# rm </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rf </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tmp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">abnormal_exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@debian</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">home</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">longyu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">19.11</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mutex</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lock</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">test# </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">procinfo </span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">stats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Detected </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lcore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Detected </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> NUMA nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Multi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">process socket </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">run</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dpdk</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rte</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mp_socket_3946_14a91b7d40de5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Selected IOVA mode </span><span class="token char">&#x27;PA&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Probing VFIO support</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> PCI device </span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">00</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">11.0</span><span class="token plain"> on NUMA socket </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">   Invalid NUMA socket</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">   probe driver</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8086</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">100f</span><span class="token plain"> net_e1000_em</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> PCI device </span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">00</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">12.0</span><span class="token plain"> on NUMA socket </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">   Invalid NUMA socket</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">   probe driver</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8086</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">100f</span><span class="token plain"> net_e1000_em</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> PCI device </span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">00</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">13.0</span><span class="token plain"> on NUMA socket </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">   Invalid NUMA socket</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">   probe driver</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8086</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">100f</span><span class="token plain"> net_e1000_em</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ######################## NIC statistics </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> port </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  ########################</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当程序未释放锁退出后，重新运行 dpdk-procinfo 程序能够获得锁，测试通过！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="是否有其它类似问题">是否有其它类似问题？<a class="hash-link" href="#是否有其它类似问题" title="标题的直接链接">​</a></h2><p>review 代码，相关的问题只有一处，其它位置正常初始化。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="标题的直接链接">​</a></h2><p>尽管本文描述的问题听上去有些高大上，可真正触发问题的点却非常小，尽管它小却也说明了一些关键的问题。</p><p>在编码的时候尽量【不做隐式地假设】，这种假设带来了非常差的扩展性，当其他人改造存在假设的代码时不容易发现这些依赖就可能带来严重的后果。</p><p>除了正向解决这个问题之外，从反面来看其实需要在测试的时候审视相关【修改的一致性】，即运行时<strong>特征字段值的一致性</strong>，而不是只验证功能。拿本文描述的问题来说，就是不同的 mutex 的 __kind 字段的值是否一致。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 用户态驱动框架及其演进过程分析">dpdk 用户态驱动框架及其部分演进过程</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->27 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><p>dpdk 用户态驱动框架是 dpdk 相对核心的功能，本文将从老版本驱动框架开始描述，从演进过程中一步步逼近高版本中相对完善的驱动框架的设计原理。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-v123-r0-版本">dpdk v1.2.3 r0 版本<a class="hash-link" href="#dpdk-v123-r0-版本" title="标题的直接链接">​</a></h2><p>dpdk git 中最老的版本为 v1.2.3 r0 版本，此版本中用户态驱动框架实现的关键环节如下：</p><ol><li><p>igb_uio 中完成将中断映射到用户态的任务，并填充 uio 结构体中 pci 资源空间的地址与长度，它注册的 pci_driver 中， id_table 字段不为空，其值如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">pci_device_id</span><span class="token plain"> igbuio_pci_ids</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">RTE_PCI_DEV_ID_DECL</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">vend</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> dev</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression function" style="color:#d73a49">PCI_DEVICE</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">vend</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> dev</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;rte_pci_dev_ids.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>rte_eal_init 函数中完成扫描 pci 设备的过程，扫描到的 pci 设备会填充到 device_list 链表中，rte_eal_init 函数中并不进行驱动 probe 过程，因为此时还未注册任何一个驱动。</p></li><li><p>这个版本的 dpdk 只支持 igb 与 ixgbe 两个系列的用户态驱动，每个驱动会实现一个注册函数并将注册函数暴露给 dpdk 程序使用，显式完成驱动注册过程。</p></li><li><p>由于驱动注册是在 dpdk 程序中完成的，驱动 probe pci 设备的过程也是在 dpdk 程序中显式调用 probe 函数完成的。</p></li><li><p>rte_eal_pci_probe 函数遍历在 rte_eal_init 中创建的 device_list pci 设备链表，使用这个链表中的每个 pci 设备去 match 注册的 pci 驱动链表。</p></li><li><p>当一个 pci 设备 match 到一个驱动后，首先调用 pci_uio_map_resource 函数来通过 map /dev/uioX 文件来映射 pci 的 resource 资源并填充到 pci 设备结构体中，然后调用 pci 驱动中的 devinit 函数完成接口初始化过程。</p></li><li><p>pci 驱动中并不定义 devinit 函数，它在显示注册驱动时，通过调用 rte_eth_driver_register 函数来设定，其值被设定为 rte_eth_dev_init 函数。</p></li><li><p>第 ６点中描述的 pci 驱动中的 devinit 函数就是第 7 点中的 rte_eth_dev_init 函数，rte_eth_dev_init 函数实现 pci 设备结构体与 dpdk 内部 rte_eth_dev 设备结构体的对接过程。</p></li><li><p>在 pci 这一侧每一个设备由一个 rte_pci_device 结构描述。由于 dpdk 需要对外提供网卡控制接口，这些控制过程中的参数是与驱动无关的，不能通过直接操作 pci 这一层的数据结构来完成，为此 dpdk 在此基础上进行了抽象，抽象出了 rte_eth_dev 设备结构体。</p></li><li><p>每一个 dpdk 初始化的 pci 接口都会分配一个唯一的 rte_eth_dev 结构体，dpdk 内部维护了一个 rte_eth_devices 全局变量，它是一个 rte_eth_dev 结构体数组，每个接口都从这个数组中分配一个 rte_eth_dev 结构体，外部接口通过指定一个 port_id 来让 rte_ethdev 这一层获取到 rte_eth_dev 结构，调用底层的函数来完成功能。</p></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="从-l2fwd-示例程序代码处探究">从 l2fwd 示例程序代码处探究<a class="hash-link" href="#从-l2fwd-示例程序代码处探究" title="标题的直接链接">​</a></h3><p>如下源码摘自此版本的 l2fwd 示例程序：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">/* init EAL */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_eal_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">RTE_LIBRTE_IGB_PMD</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">rte_igb_pmd_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token function" style="color:#d73a49">rte_exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">EXIT_FAILURE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Cannot init igb pmd\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">RTE_LIBRTE_IXGBE_PMD</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">rte_ixgbe_pmd_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token function" style="color:#d73a49">rte_exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">EXIT_FAILURE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Cannot init ixgbe pmd\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">rte_eal_pci_probe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token function" style="color:#d73a49">rte_exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">EXIT_FAILURE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Cannot probe PCI\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到，igb 网卡与 ixgbe 网卡驱动调用驱动提供的初始化函数来显示注册，注册完成后，调用 rte_eal_pci_probe 来完成 probe 过程。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="eth_driver-结构">eth_driver 结构<a class="hash-link" href="#eth_driver-结构" title="标题的直接链接">​</a></h3><p><strong>此版本仅支持 pci 驱动</strong>，每个驱动需要实例化一个 eth_driver 结构，此结构的定义如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">eth_driver</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_pci_driver</span><span class="token plain"> pci_drv</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; The PMD is also a PCI driver. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">eth_dev_init_t</span><span class="token plain"> eth_dev_init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; Device init function. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> dev_private_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; Size of device private data. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>pci_drv 是对用户态 pci 设备驱动的抽象，eth_dev_init 用户态驱动的初始化函数，dev_private_size 是每个设备的私有数据大小。</p><p>每个驱动都要实例化一个 eth_driver 结构体，并显示的调用注册函数进行注册。igb 网卡的 eth_driver 结构体实例如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">eth_driver</span><span class="token plain"> rte_igb_pmd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rte_igb_pmd&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id_table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pci_id_igb_map</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">drv_flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RTE_PCI_DRV_NEED_IGB_UIO</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eth_dev_init </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> eth_igb_dev_init</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dev_private_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">e1000_adapter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>由于 eth_driver 结构体的第一个元素为 rte_pci_driver 结构，可以很容易的将一个 eth_driver 结构地址转化为一个 rte_pci_driver 结构地址（通过强转）</strong>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rte_pci_driver-结构">rte_pci_driver 结构<a class="hash-link" href="#rte_pci_driver-结构" title="标题的直接链接">​</a></h3><p>rte_pci_driver 结构是对 pci 驱动的抽象，其定义如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * A structure describing a PCI driver.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_pci_driver</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">TAILQ_ENTRY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rte_pci_driver</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; Next in list. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                       </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; Driver name. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">pci_devinit_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">devinit</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; Device init. function. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_pci_id</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">id_table</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; ID table, NULL terminated. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint32_t</span><span class="token plain"> drv_flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                     </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; Flags contolling handling of device. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>rte_pci_driver 的 next 字段用于将注册的 pci 驱动串联起来，devinit 函数用于设备初始化。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rte_pci_driver-结构体中的-devinit-函数">rte_pci_driver 结构体中的 devinit 函数<a class="hash-link" href="#rte_pci_driver-结构体中的-devinit-函数" title="标题的直接链接">​</a></h3><p>igb 驱动实现的 rte_pci_driver 结构中并没有设定 devinit 字段，这个字段在 dpdk 程序显式调用 rte_igb_pmd_init 注册 igb 驱动的时候被赋值。</p><p>rte_igb_pmd_init 函数代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rte_igb_pmd_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">rte_eth_driver_register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">rte_igb_pmd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>rte_eth_driver_register 函数代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rte_eth_driver_register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">eth_driver</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">eth_drv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eth_drv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pci_drv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">devinit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rte_eth_dev_init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">rte_eal_pci_register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">eth_drv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pci_drv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如上代码能够说明 rte_pci_driver 中的 devinit 函数在驱动显示注册时被赋值为 rte_eth_dev_init 函数，那么 <strong>eth_driver 中注册的 eth_dev_init 函数在哪里被调用呢？</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rte_eth_dev_init-函数">rte_eth_dev_init 函数<a class="hash-link" href="#rte_eth_dev_init-函数" title="标题的直接链接">​</a></h3><p>eth_driver 结构体中注册的 eth_dev_init 函数在 rte_eth_dev_init 函数中被调用，rte_eth_dev_init 函数的代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rte_eth_dev_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_pci_driver</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pci_drv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_pci_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pci_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">eth_driver</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">eth_drv</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_eth_dev</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">eth_dev</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> diag</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eth_drv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">eth_driver</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">pci_drv</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eth_dev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_eth_dev_allocate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eth_dev </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ENOMEM</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">rte_eal_process_type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> RTE_PROC_PRIMARY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eth_dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev_private </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_zmalloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ethdev private structure&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  eth_drv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev_private_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  CACHE_LINE_SIZE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eth_dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev_private </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ENOMEM</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eth_dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pci_dev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pci_dev</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eth_dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">driver </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> eth_drv</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eth_dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rx_mbuf_alloc_failed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* init user callbacks */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">TAILQ_INIT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eth_dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">callbacks</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Set the default maximum frame size.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eth_dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">max_frame_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ETHER_MAX_LEN</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Invoke PMD device initialization function */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    diag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">eth_drv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">eth_dev_init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eth_drv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eth_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">diag </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">PMD_DEBUG_TRACE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;driver %s: eth_dev_init(vendor_id=0x%u device_id=0x%x)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot; failed\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pci_drv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> pci_dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vendor_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> pci_dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">device_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">rte_eal_process_type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> RTE_PROC_PRIMARY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">rte_free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eth_dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev_private</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nb_ports</span><span class="token operator" style="color:#393A34">--</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> diag</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此函数中首先为当前的 pci 设备分配一个 rte_eth_dev 结构，然后使用 eth_drv 结构体中定义的 dev_private_size 字段来创建驱动内部数据结构。</p><p>此后，继续初始化 rte_eth_dev 结构体中的字段，最后调用 eth_driver 结构体中的 eth_dev_init 函数指针指向的函数，完成接口底层初始化过程。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="以一个-igb-网卡接口来串起-dpdk-v123-r0-版本接口初始化的整个过程">以一个 igb 网卡接口来串起 dpdk v1.2.3 r0 版本接口初始化的整个过程<a class="hash-link" href="#以一个-igb-网卡接口来串起-dpdk-v123-r0-版本接口初始化的整个过程" title="标题的直接链接">​</a></h3><p>假定某 linux 系统中有一个 igb 网卡，它只有两个口，这两个口的 pci 号分别为 0000:01:00.0、0000:01:00.1，0000:01:00.0 这个口由内核驱动接管，0000:01:00.1 这个口用于 dpdk 转包（确认 igb_uio 网卡支持此网卡）。</p><p>假定 igb_uio 驱动正常加载，大页内存正常配置，分析模型基于 primary 进程。</p><p>下面是具体过程：</p><ol><li><p>将 0000:01:00.1 从 igb 驱动解绑</p></li><li><p>将 0000:01:00.1 写入到 /sys 目录中 igb_uio 的 bind 文件中，绑定接口到 igb_uio，绑定后 /dev/uio0 文件被创建，/sys 目录中相应的文件被创建，uio map 地址相关文件被创建，示例内容如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># pwd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/sys/bus/pci/drivers/igb_uio/0000:01:00.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># cat ./uio/uio0/maps/map0/addr ./uio/uio0/maps/map0/name  ./uio/uio0/maps/map0/size ./uio/uio0/maps/map0/offset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xfebf3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BAR1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>dpdk 程序调用 rte_eal_init 初始化，扫描 /sys/bus/pci/devices 目录，解析子目录 0000:01:00.1 中的文件，填充到一个新创建的 rte_pci_device 结构体中，填充完成后将此结构体链入到 device_list 设备链表中。0000:01:00.1 目录中的重要文件含义见下表：</p><table><thead><tr><th>file</th><th>function</th></tr></thead><tbody><tr><td>class</td><td>PCI class (ascii, ro)</td></tr><tr><td>config</td><td>PCI config space (binary, rw)</td></tr><tr><td>device</td><td>PCI device (ascii, ro)</td></tr><tr><td>enable</td><td>Whether the device is enabled (ascii, rw)</td></tr><tr><td>irq</td><td>IRQ number (ascii, ro)</td></tr><tr><td>local_cpus</td><td>nearby CPU mask (cpumask, ro)</td></tr><tr><td>remove</td><td>remove device from kernel&#x27;s list (ascii, wo)</td></tr><tr><td>resource</td><td>PCI resource host addresses (ascii, ro)</td></tr><tr><td>resource0..N</td><td>PCI resource N, if present (binary, mmap, rw<!-- -->[1]<!-- -->)</td></tr><tr><td>resource0_wc..N_wc</td><td>PCI WC map resource N, if prefetchable (binary, mmap)</td></tr><tr><td>rom</td><td>PCI ROM resource, if present (binary, ro)</td></tr><tr><td>subsystem_device</td><td>PCI subsystem device (ascii, ro)</td></tr><tr><td>subsystem_vendor</td><td>PCI subsystem vendor (ascii, ro)</td></tr><tr><td>vendor</td><td>PCI vendor (ascii, ro)</td></tr></tbody></table></li><li><p>dpdk 程序执行 rte_igb_pmd_init 注册 igb 驱动，rte_igb_pmd 结构体中 pci_drv 结构的 devinit 函数指针被设置为 rte_eth_dev_init 函数。</p></li><li><p>dpdk 程序调用 rte_eal_pci_probe 函数完成驱动 probe 过程，rte_eal_pci_probe 函数依次遍历 device_list 链表，获取到 0000:01:00.1 接口填充的 rte_pci_device 结构体，然后调用 pci_probe_all_drivers 函数完成驱动 probe 过程。</p></li><li><p>pci_probe_all_drivers 函数遍历 driver_list 链表，首先判断当前设备是否被加入到黑名单，是则跳过此设备，这里由于程序执行时没有配置黑名单，不会走入这个逻辑。</p></li><li><p>pci_probe_all_drivers 函数获取到注册的 igb 驱动的 rte_pci_driver 结构，使用此结构与 rte_pci_device 结构为参数调用 rte_eal_pci_probe_one_driver 函数</p></li><li><p>rte_eal_pci_probe_one_driver 函数使用 rte_pci_device 结构体中保存的设备的 vendor id 与 device id 在 pci_id_igb_map 列表中进行匹配，成功匹配后调用 pci_uio_map_resource 来 mmap pci resource 地址到用户态中。</p></li><li><p>pci_uio_map_resource 首先找到并解析 /sys/bus/pci/drivers/igb_uio/0000:01:00.0/uio/uio0/maps/map0/ 下的 offset 与 size 文件，获取 pci resource 的偏移与大小，解析到 offset 为 0x0，size 为 0x1000，打开 /dev/uio0 文件，通过 mmap 映射 pci resource 到用户态中。</p></li><li><p>mmap 成功后得到的虚拟地址填充到 rte_pci_device 中的 mem_resource.addr 中，然后创建一个 uio_res 结构，保存映射后的虚拟地址与 offset、size，并填充 path 与 pci_addr 唯一标识到 uio_res 结构，最后将此结构链入到 uio_res_list 链表中。</p></li><li><p>再次回到 rte_eal_pci_probe_one_driver 中，调用 pci_drv 中的 devinit 函数，即 rte_eth_dev_init 函数。</p></li><li><p>rte_eth_dev_init 函数填充当前接口的 rte_eth_dev 结构体后调用 eth_igb_dev_init 函数。</p></li><li><p>eth_igb_dev_init 函数继续初始化 rte_eth_dev 结构中与驱动相关的重要数据结构，将 rte_eth_dev_init 函数中创建的驱动内部数据结构地址 eth_dev-&gt;data-&gt;dev_private 转化为 e1000_adapter 结构，并获取 e1000_adpater 结构体中 e1000_hw 的地址，完成后将第 10 步中 mmap 到的 pci resource 地址赋值给 hw-&gt;hw_addr 结构，此后读写网卡寄存器都是以这个 hw_addr 为基地址完成的。</p></li><li><p>eth_igb_dev_init 完成硬件初始化过程并注册中断回调函数。</p></li><li><p>dpdk 程序继续调用 rte_ethdev.c 中实现的网卡控制接口，配置网卡的收发队列并将接口 up 起来</p></li><li><p>dpdk 程序完成接口的配置后，派发自己实现的 loop 函数到每个使能的 lcore 线程上，执行收发包过程。</p></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="总结-v123-r0-版本用户态驱动框架关键知识与隐含问题">总结 v1.2.3 r0 版本用户态驱动框架关键知识与隐含问题<a class="hash-link" href="#总结-v123-r0-版本用户态驱动框架关键知识与隐含问题" title="标题的直接链接">​</a></h3><ol><li>v1.2.3 r0 版本通过 mmap /dev/uio 文件来映射 pci resource 资源</li><li>v1.2.3 r0 版本需要显式调用每个驱动的注册函数，扩展性较差，这种架构下每添加一个新类别的驱动，dpdk 程序需要修改源码后重新编译</li><li>rte_eth_driver、rte_pci_driver 中只有初始化函数，没有解初始化函数，缺少主动释放资源的过程</li><li>此版本仅支持 pci 驱动，没有抽象出 bus 层，bus 层功能零散分布在扫描 pci 设备与 probe 设备过程中，不太合理</li><li>缺少 ethtool、ifconfig 等 linux 中传统网络接口控制命令的替代工具</li></ol><p>以上几个问题在后续版本中渐渐完善，下面我将对后续版本中的一些关键修改进行描述。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-v140r0-版本">dpdk v1.4.0r0 版本<a class="hash-link" href="#dpdk-v140r0-版本" title="标题的直接链接">​</a></h2><p>此版本解决了显式调用每个驱动注册函数的问题，向外界提供了 rte_pmd_init_all 接口，适配新的驱动时，不需要修改上层程序的代码，只需要重新链接新的 dpdk 即可。</p><p>rte_pmd_init_all 函数代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_pmd_init_all</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ENODEV</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">RTE_LIBRTE_IGB_PMD</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_igb_pmd_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">RTE_LOG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ERR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PMD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Cannot init igb PMD\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_igbvf_pmd_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">RTE_LOG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ERR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PMD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Cannot init igbvf PMD\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property comment" style="color:#999988;font-style:italic">/* RTE_LIBRTE_IGB_PMD */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">RTE_LIBRTE_EM_PMD</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_em_pmd_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">RTE_LOG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ERR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PMD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Cannot init em PMD\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property comment" style="color:#999988;font-style:italic">/* RTE_LIBRTE_EM_PMD */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">RTE_LIBRTE_IXGBE_PMD</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_ixgbe_pmd_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">RTE_LOG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ERR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PMD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Cannot init ixgbe PMD\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_ixgbevf_pmd_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">RTE_LOG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ERR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PMD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Cannot init ixgbevf PMD\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property comment" style="color:#999988;font-style:italic">/* RTE_LIBRTE_IXGBE_PMD */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ENODEV</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">RTE_LOG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ERR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PMD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;No PMD(s) are configured\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个版本增加了对 e1000 与 igb vf、ixgbe vf 驱动的支持，pci resource 地址仍旧通过 mmap /dev/uioX 文件来完成。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-v150r0-版本">dpdk v1.5.0r0 版本<a class="hash-link" href="#dpdk-v150r0-版本" title="标题的直接链接">​</a></h2><p>此版本增加了更多的 pmd 驱动，增加了对诸如 pcap 等非 pci 网卡驱动的支持。非 pci 网卡驱动有单独的初始化函数 rte_eal_non_pci_ethdev_init，此函数在 rte_eal_init 函数中被调用。</p><p>其源码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rte_eal_non_pci_ethdev_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint8_t</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> j</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> NUM_DEV_TYPES</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">j </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> RTE_MAX_ETHPORTS</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">params</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rte_snprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;%s%&quot;</span><span class="token plain">PRIu8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    dev_types</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dev_prefix</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> j</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">eal_dev_is_whitelisted</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">params</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                dev_types</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">init_fn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到它实际是通过遍历 dev_types 这个数组来初始化的，其它的参数通过命令行获取。</p><p>dev_types 数组代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">device_init</span><span class="token plain"> dev_types</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">RTE_LIBRTE_PMD_RING</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dev_prefix </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RTE_ETH_RING_PARAM_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init_fn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rte_pmd_ring_init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">RTE_LIBRTE_PMD_PCAP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dev_prefix </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RTE_ETH_PCAP_PARAM_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init_fn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rte_pmd_pcap_init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dev_prefix </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-nodev-&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init_fn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>dev_prefix 用于标识 vdev 驱动，init_fn 是驱动的初始化函数。这样的实现存在的问题是 vdev 与 pci 等物理网卡驱动的注册与初始化过程没有统一，需要一个新的抽象层次来解决这个问题。</p><p>同时，这个版本引入了 kni 模块，当使用了 kni 模块后，支持通过 ethtool、ifconfig 这些标准命令控制网卡接口，弥补了现有工具的不足，同时也打通了 dpdk 程序与内核协议栈的交互过程。</p><p>kni 支持 ethtool 获取数据实质上是维护了一套内核态的驱动，同时为了避免与用户态同时使用造成问题，对内核驱动进行了一系列定制化修改，带来新功能的同时也引入了新的问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-v170">dpdk v1.7.0<a class="hash-link" href="#dpdk-v170" title="标题的直接链接">​</a></h2><p>v1.7.0 对用户态驱动架构进行了较大幅度的调整，抽象出了一个 rte_driver 结构来屏蔽 vdev 与 pdev 的差别，统一了注册过程。</p><p>同时也剔除了显式调用驱动注册函数的实现，改为通过 gcc 的 constructor 属性在 main 函数执行前自动注册，同时 probe 的逻辑也合并到了 rte_eal_init 函数中调用，上层程序对底层驱动的注册与 probe 过程完全不感知。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rte_driver-结构">rte_driver 结构<a class="hash-link" href="#rte_driver-结构" title="标题的直接链接">​</a></h3><p>rte_driver 结构的定义如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_driver</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">TAILQ_ENTRY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rte_driver</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; Next in list. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token class-name">pmd_type</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; PMD Driver type */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                   </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; Driver name. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">rte_dev_init_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; Device init. function. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>next 字段将不同的 rte_driver 链起来，type 字段用于区分 PMD 驱动的类型，如 PDEV、VDEV、BDEV，init 函数是对老版本每个驱动的注册函数的抽象。</p><p>igb pmd 驱动实例化的结构如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">3061</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_driver</span><span class="token plain"> pmd_igb_drv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3062</span><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> PMD_PDEV</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3063</span><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rte_igb_pmd_init</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3064</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>设定 type 为 PMD_PDEV 表示这是一个物理网卡驱动，init 函数指向 rte_igb_pmd_init，rte_igb_pmd_init 本身完成自老版本继承的 eth_driver 驱动的注册，这里为了实现与 VDEV 驱动注册过程的统一，在每个 PDEV 驱动中使用 eth_driver 驱动的注册接口实例化一个 rte_driver 结构，将此结构在 main 函数之前注册到 dev_driver_list 链表中。</p><p>当 main 函数执行时，dev_driver_list 链表中保存了所有注册的 rte_driver 驱动，这些 rte_driver 驱动能够分为三个类别：</p><ol><li>PDEV 标志的 pci 物理设备驱动实例化的 rte_driver</li><li>VDEV 标志的虚拟设备驱动实例化的 rte_driver</li><li>BDEV 标志 bond 虚拟设备驱动实例化的 rte_driver</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vdev-类驱动">VDEV 类驱动<a class="hash-link" href="#vdev-类驱动" title="标题的直接链接">​</a></h3><p>VDEV 类驱动的代表是 pcap 驱动，其 rte_driver 结构如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_driver</span><span class="token plain"> pmd_pcap_drv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eth_pcap&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> PMD_VDEV</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rte_pmd_pcap_devinit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>type 为 PMD_VDEV 表示这是个虚拟网卡驱动，rte_pmd_pcap_devinit 函数实际上就是此驱动的初始化函数，并不需要再进行任何的注册过程。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pdev-类驱动">PDEV 类驱动<a class="hash-link" href="#pdev-类驱动" title="标题的直接链接">​</a></h3><p>PDEV 类驱动的代表是 igb 驱动，这类驱动实例化的 rte_driver 结构中的 init 函数本身又是一个注册 eth_driver 驱动的函数，这就将原来 PDEV 类驱动的注册过程复杂化了，是统一接口带来的一些坏处。</p><p>这时候 PDEV 类驱动的注册过程可以总结为如下步骤：</p><ol><li>实例化 rte_driver 结构，并将 init 函数设定为 eth_driver 函数的注册函数</li><li>通过 PMD_REGISTER_DRIVER 宏注册 rte_driver 结构，此结构在 main 函数执行前被注册到 dev_driver_list 链表中</li><li>rte_eal_init 中遍历 dev_driver_list 链表调用 PDEV 驱动中注册 eth_driver 结构的函数，完成与老版本相同的注册流程</li></ol><p>PMD_REGISTER_DRIVER 宏的原理详见：<a href="https://blog.csdn.net/Longyu_wlz/article/details/113725959?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161961368916780357248787%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=161961368916780357248787&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v2~rank_v29-1-113725959.pc_v2_rank_blog_default&amp;utm_term=%E6%9E%84%E9%80%A0" target="_blank" rel="noopener noreferrer">gcc constructor 属性修饰的构造函数未被链接问题</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bdev-类驱动">BDEV 类驱动<a class="hash-link" href="#bdev-类驱动" title="标题的直接链接">​</a></h3><p>1.7.0 中实现了 bond 虚拟接口驱动，bond 驱动完全是软件实现，但是最初的版本需要将 bond 驱动初始化过程放在 pci 设备 probe 之后来完成其功能，这种特殊的依赖关系催生了 BDEV 类驱动，不过这只是一个中间的过渡版本，后面的版本解决了这个问题，BDEV 与 VDEV 初始化过程得到了统一。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rte_eal_dev_init-函数">rte_eal_dev_init 函数<a class="hash-link" href="#rte_eal_dev_init-函数" title="标题的直接链接">​</a></h3><p>1.7.0 版本实现了驱动的自动注册过程，这一过程可以分为两个阶段，第一个阶段是构造函数执行阶段，第二阶段是 pci 驱动的注册过程。</p><p>第二阶段的注册过程与驱动的 probe 过程都合并到了 rte_eal_init 函数中，上层程序完全不感知。</p><p>rte_eal_init 函数调用 rte_eal_dev_init 函数完成 VDEV 设备的初始化以及 pci 驱动的注册过程，由于 BOND 驱动的特殊性，rte_eal_dev_init 也被划分为了两个阶段。</p><p>PMD_INIT_PRE_PCI_PROBE 阶段初始化那些不依赖 pci 网卡的 VDEV 设备，这一阶段在 pci 设备 probe 之前执行，PMD_INIT_POST_PCI_PROBE 阶段仅用于 bond 设备初始化。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="igb_uio-中移除-pci-id-table">igb_uio 中移除 pci id table<a class="hash-link" href="#igb_uio-中移除-pci-id-table" title="标题的直接链接">​</a></h3><p>1.7.0 版本中 igb_uio 模块注册的 pci 驱动移除了 pci id table，此时绑定网卡到 igb_uio 需要先将网卡的 vendor id 与 device id 拼接得到的字符串写入到 igb_uio 在 /sys 子目录中的 new_id 文件中才能进行绑定。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vfio-模块的支持">VFIO 模块的支持<a class="hash-link" href="#vfio-模块的支持" title="标题的直接链接">​</a></h3><p>v1.7.0 除了支持 igb_uio 这种标准的 uio 映射 pci 资源空间与中断到用户态外，也支持 vfio 模块。</p><p>我对 vfio 这块没有深入研究，不进一步描述了。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="v180">v1.8.0<a class="hash-link" href="#v180" title="标题的直接链接">​</a></h2><p>此版本解决了 bond 功能的限制，统一了所有 VDEV 的初始化过程。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-1604">dpdk-16.04<a class="hash-link" href="#dpdk-1604" title="标题的直接链接">​</a></h2><p>dpdk-16.04 用户态驱动架构主体继续沿用 v1.8.0 版本代码，在统一 linux 平台与 bsd 平台 uio 函数的过程中，修改了 pci resource 的映射逻辑，不再通过 mmap /dev/uiox 文件来完成。</p><p>具体的原理可以阅读 <a href="https://blog.csdn.net/Longyu_wlz/article/details/115956761?spm=1001.2014.3001.5501" target="_blank" rel="noopener noreferrer">dpdk-16.04 igb_uio 模块分析</a> 。</p><p>dpdk-16.04 中针对标准 viritio 驱动访问 io 端口的需求实现了 rte_eal_pci_ioport_map 等 ioport 相关的函数接口，当 virtio 网卡被绑定到 igb_uio 时，ioport 的基地址通过访问 /sys 目录中 virtio 设备子目录中 uio 子目录中的 port 接口来获取。</p><p>vtpci_init 函数中调用 legacy_virtio_resource_init 函数来 map virtio ioport，此过程实际上是通过调用 rte_eal_pci_ioport_map 函数完成的。</p><p>此函数源码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rte_eal_pci_ioport_map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_pci_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> bar</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_pci_ioport</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">kdrv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">VFIO_PRESENT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> RTE_KDRV_VFIO</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">pci_vfio_is_enabled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pci_vfio_ioport_map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bar</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> RTE_KDRV_IGB_UIO</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pci_uio_ioport_map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bar</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> RTE_KDRV_UIO_GENERIC</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">if</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">defined</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">RTE_ARCH_X86</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pci_ioport_map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bar</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pci_uio_ioport_map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bar</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> RTE_KDRV_NONE</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">if</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">defined</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">RTE_ARCH_X86</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pci_ioport_map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bar</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        p</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dev</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当 virtio 绑定到 igb_uio 的时候调用 pci_uio_ioport_map 来获取 ioport 的基地址，pci_uio_ioport_map 通过访问并解析 /sys/bus/pci/devices/0000:xx:xx.x/uio/uioX/portio/portX/start 文件来完成，start 文件的值即为 portio 的基地址。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-17x-bus-抽象层的引入">dpdk 17.x bus 抽象层的引入<a class="hash-link" href="#dpdk-17x-bus-抽象层的引入" title="标题的直接链接">​</a></h2><p>dpdk 17.x 版本最初合入了 nxp 公司的 fsl-mc bus driver，在此基础上，bus 抽象层不断完善，最终 pci、vdev bus 也得到了支持，用户态驱动架构的使用场景进一步拓宽，旧的架构被重构，新框架复杂性进一步增加。</p><p>目前还没有深入研究，未来单独写一篇博客描述新版本 bus 框架下用户态驱动的架构。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="标题的直接链接">​</a></h2><p>本文从老版本 dpdk 着手，描述了在版本演进过程中 dpdk 用户态驱动架构的演变过程。</p><p>用户态驱动架构是 dpdk 非常核心的设计，对它的研究是我们与设计者对话的过程。从本文的分析中能够看出这一套框架并不是从一开始就这样复杂，就能够兼容多种场景并具备高度的可扩展性，这些元素是在程序的迭代中不断优化的。不同的架构有自己支持的特定场景，我们也应该以变化的角度来看待不同版本的优劣之处。</p><p>dpdk 的应用场景就是一种环境，环境的变化催化了程序内部架构的不断重构，我们不也在经历类似的过程吗？核心只是环境不同罢了！</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 程序性能问题排查的一般流程">dpdk/dpdk 程序性能问题排查的一般流程</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->2 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-程序性能问题排查">dpdk 程序性能问题排查<a class="hash-link" href="#dpdk-程序性能问题排查" title="标题的直接链接">​</a></h2><ol><li>确定网卡类型与性能要求，与硬件组沟通确认网卡性能基线数据，基线数据符合要求则执行下面的步骤</li><li>使用 perf 确定当前使用的收发包函数，未使用向量收发包函数，开启向量收发包函数后问题得到解决则终止</li><li>确定当前收发包线程绑核情况，修改 grub 配置，添加 isolcpus、nohz_full、rcu_nocbs 配置，隔离收发包线程绑定核后重新测试，达到要求则终止</li><li>修改 irq 亲和性后重新测试，达到要求则终止</li><li>重复 3 与 4 过程，绑定不同的核，采集绑定到奇数核，偶数核，相邻核上性能数据，获取收发包统计，查看 imissed 字段与 nombuf 字段</li><li>观测第 5 步收集到的信息，判断是否在绑定某个核时性能较优，设定最优的绑核情况</li><li>将网卡更换到不同的槽位，采集性能数据，验证是否存在性能差异</li><li>杀掉无关进程，排查是否其它进程影响，无影响则继续向下排查</li><li>执行上述步骤仍旧达不到要求时，开启多队列，问题得到解决则终止</li><li>执行上述步骤无效后，观测测试数据中 imissed 较高则调大 rx、tx 描述符数量，达到要求则终止</li><li>第 8 步无效后，执行 perf、vtune 采集性能热点，从软件侧优化</li></ol></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 程序接口 down、up 问题定位的一般流程">接口 up、down 失败问题排查</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->3 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="接口-up-失败问题">接口 up 失败问题<a class="hash-link" href="#接口-up-失败问题" title="标题的直接链接">​</a></h2><ol><li>排查硬件接线情况</li><li>确认网卡是否 bypass 卡，检查 bypass 状态</li><li>收集 ifconfig x/x、ethtool x/x、ethtool -i x/x、ethtool -S x/x、ethtool -d x/x 信息</li><li>查看 dmesg 信息是否有异常</li><li>判断接口对应关系是否一致</li><li>观察接口灯状态</li><li>判断是否软件问题：mbuf 泄露导致问题</li><li>软件排查无效后查看光模块型号，判断光模块型号是否兼容</li><li>判断光模块型号没有问题后，将接口绑定到官方驱动进行测试</li><li>官方驱动不能正常工作则判定为硬件问题，官方驱动能够正常则判断为驱动问题</li></ol><p>备注信息：当接口已经处于 up 状态时，要成功 up，必须先执行 down 操作。</p><h1>接口 down 失败问题</h1><p>接口 down 问题一般表现为执行了 down 接口后网卡 link 灯还是亮的、down 了接口后，获取到的接口链路状态还是 up 的。</p><ol><li>确定网卡型号与对端设备及接口与对端灯的当前状态</li><li>收集 ifconfig x/x、ethtool x/x、ethtool -i x/x、ethtool -S x/x、ethtool -d x/x 信息</li><li>查看 dmesg 信息是否有异常</li><li>查看 dpdk 程序接口日志信息是否有异常</li><li>查看接口对应关系是否一致</li><li>上述操作没有异常后，重新执行 up、down 复现问题，硬件问题一般能够必现</li><li>问题必现后，查看 dpdk 程序是否使能 lsc 中断，使能则关闭重试，未使能继续下一步</li><li>有条件则使用 dpdk_proc_info 程序收集光模块型号信息，判断是否是兼容的光模块，无条件则执行第 8 步</li><li>将 down 不掉的网卡接口绑定到官方驱动测试，判断是否有相同问题</li><li>官方驱动也有相同问题时，排除单个网卡的影响，官方驱动没有问题时，对比驱动代码</li><li>在多张卡上绑定官方驱动能够复现问题后，协同厂商处理</li></ol></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 程序收发包问题排查的一般流程">dpdk 程序收发包问题排查</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->5 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="接口不收包问题排查">接口不收包问题排查<a class="hash-link" href="#接口不收包问题排查" title="标题的直接链接">​</a></h2><p>1.确认网卡类型与异常接口</p><p>2.收集 ethtool -i x/x、ifconfig x/x、ethtool x/x、ethtool -d x/x、ethtool -S x/x 信息</p><p>3.确认接口连线是否正常，接口是否 up，接口处于 down 状态不能说明收包存在异常</p><p>4.确认对端是否在发流，对端没有发流则不能说明存在异常</p><p>5.dmesg 信息中是否有下面类似的信息：</p><div class="language-dmesg codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dmesg codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    dmar: DMAR:[DMA Read] Request device [01:00.0] fault addr 37ae5000 DMAR:[fault reason 02] Present bit in context entry is clear </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>   device pci 号是 dpdk 程序使用的网卡接口的 pci 号，符合这个问题的特征是<strong>从一开始就不能收包，而且是必现的</strong>，有这个前提则修改 grug.cfg 文件，内核 cmdline 中添加 intel_iommu=off 配置后重试。</p><p>6.判断 ethtool -d dump 的寄存器信息中是否有异常如控制寄存器全 F，有异常则判定为硬件问题，可绑定官方驱动进一步排查</p><p>7.判断接口的混淆模式是否开启，当接口 up 部分失败时，混淆模式不会被开启，这时网卡会丢掉没有发给自己的报文</p><p>8.使用 dpdk_proc_info 判断接口的 RX-nombuf 字段是否一直增加，当存在 mbuf 泄露时，申请 mbuf 失败则无法收包</p><p>9.多次执行 ethtool -d dump 寄存器，查看网卡 TAIL 与 HEAD 指针的变化情况，当 HEAD 值 &gt; TAIL 值时，队列 hung 住，无法收包</p><p>10.使用 gdb dump 收包队列信息、接收描述符信息查找异常点</p><p>11.hung 住的问题需要注意问题出现的环境，是打了一段时间的流后出现的，还是杀 dpdk 程序出现的</p><p>12.确认是杀 dpdk 程序出现的则检查程序参数，打了一段时间的流后则重点排查是否异常流量导致队列 hung 住</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="接口不发包问题排查">接口不发包问题排查<a class="hash-link" href="#接口不发包问题排查" title="标题的直接链接">​</a></h2><p>1.确认网卡类型与异常接口</p><p>2.收集 ethtool -i x/x、ifconfig x/x、ethtool x/x、ethtool -d x/x、ethtool -S x/x 信息</p><p>3.确认接口连线是否正常，接口是否 up，接口处于 down 状态不能发包是正常情况</p><p>4.确认接口有流量转出，tx_drop 等字段在增加</p><p>5.dmesg 信息中是否有下面类似的信息：</p><div class="language-dmesg codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dmesg codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    dmar: DMAR:[DMA Read] Request device [01:00.0] fault addr 37ae5000 DMAR:[fault reason 02] Present bit in context entry is clear </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> device pci 号是 dpdk 程序使用的网卡接口的 pci 号，符合这个问题的特征是从一开始就不能收包，而且是必现的，有这个前提则修改 grug.conf 文件，内核 cmdline 中添加 intel_iommu=off 配置后重试。</p><p>6.判断 ethtool -d dump 的寄存器信息中是否有异常如控制寄存器全 F，有异常则判定为硬件问题，可绑定官方驱动进一步排查</p><p>9.多次执行 ethtool -d dump 寄存器，查看网卡 tx TAIL 与 HEAD 指针的变化情况，当 HEAD 值 &gt; TAIL 值时，队列 hung 住，无法发包</p><p>10.使用 gdb dump 发包队列信息、发送描述符信息查找异常点</p><p>11.hung 住的问题需要注意问题出现的环境，是打了一段时间的流后出现的，还是杀 dpdk 程序出现的</p><p>12.确认是杀 dpdk 程序出现的则检查程序参数，打了一段时间的流后则重点排查是否异常流量导致队列 hung 住</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 程序绑不同的核性能有明显差异问题分析">dpdk/dpdk 程序绑不同的核性能有明显差异问题分析</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->9 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a class="hash-link" href="#前言" title="标题的直接链接">​</a></h2><p>dpdk 程序会将<strong>收发包线程绑定到指定的 cpu 核上</strong>，在多核环境中执行就要配置需要使用的核。在性能测试的时候，发现当收发包线程绑定到 0 核、1 核对应的 cpu 上后，<strong>性能会有明显的下降</strong>，而绑定到 0 核、1 核之后的核上却没有这个问题。</p><p>在排查这个问题的时候发现，<strong>系统中的一些中断只在 0 核上有统计计数</strong>，表明其中断处理程序只在 0 核上执行，当 dpdk 程序也使用 0 核进行收发包的时候，这些中断处理程序就会与 dpdk 程序共享 cpu 核，从而导致 dpdk 程序性能下降。</p><p>在定位这个问题中，有对 irq smp_affinity 的设定过程，通过设定多个中断的 irq smp_affinity 让其在 0 核与 1 核之后的核上运行，重新测试后有明显的改善但是还是差一点，继续定位发现 0 核上有很多的 soft irq 程序在运行。</p><p>在本文中我将探讨一下 irq smp_affinity 的知识，同时引出 soft irq 的内容。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="内核文档中与-irq-smp_affinity-相关的信息">内核文档中与 irq smp_affinity 相关的信息<a class="hash-link" href="#内核文档中与-irq-smp_affinity-相关的信息" title="标题的直接链接">​</a></h2><p>一手资料源自内核 Documentation 目录中，摘录如下：</p><div class="language-manual codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-manual codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SMP IRQ affinity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/proc/irq/IRQ#/smp_affinity and /proc/irq/IRQ#/smp_affinity_list specify</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">which target CPUs are permitted for a given IRQ source.  It&#x27;s a bitmask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(smp_affinity) or cpu list (smp_affinity_list) of allowed CPUs.  It&#x27;s not</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">allowed to turn off all CPUs, and if an IRQ controller does not support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IRQ affinity then the value will not change from the default of all cpus.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/proc/irq/default_smp_affinity specifies default affinity mask that applies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">to all non-active IRQs. Once IRQ is allocated/activated its affinity bitmask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">will be set to the default mask. It can then be changed as described above.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Default mask is 0xffffffff.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Here is an example of limiting that same irq (44) to cpus 1024 to 1031::</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [root@moon 44]# echo 1024-1031 &gt; smp_affinity_list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [root@moon 44]# cat smp_affinity_list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        1024-1031</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note that to do this with a bitmask would require 32 bitmasks of zero</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">to follow the pertinent one.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>smp_affinity 设定了单个中断被允许执行的 cpu 掩码，内核会以中断号为标识符在 /proc/irq/ 为每一个中断创建一个子目录，我们可以通过读写 /proc/irq/IRQ 子目录中的文件来控制每一个中断允许被执行的 cpu 列表。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一个示例">一个示例<a class="hash-link" href="#一个示例" title="标题的直接链接">​</a></h2><p>这里我以 iwlwifi 无线网卡设备的中断来演示如何查看并修改 irq smp_affinity，达到让设定的中断服务程序在指定的 cpu 核上执行的目的。</p><p>首先通过访问 /proc/interrupts 确认 iwlwifi 的中断计数在增加，操作记录如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:20:20:25</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> $ </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;141:&#x27;</span><span class="token plain"> /proc/interrupts </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">141</span><span class="token plain">:     </span><span class="token number" style="color:#36acaa">486315</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">596832</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  IR-PCI-MSI </span><span class="token number" style="color:#36acaa">333824</span><span class="token plain">-edge      iwlwifi: default queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:20:21:07</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> $ </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;141:&#x27;</span><span class="token plain"> /proc/interrupts </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">141</span><span class="token plain">:     </span><span class="token number" style="color:#36acaa">486405</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">596832</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  IR-PCI-MSI </span><span class="token number" style="color:#36acaa">333824</span><span class="token plain">-edge      iwlwifi: default queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:20:21:08</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> $ </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;141:&#x27;</span><span class="token plain"> /proc/interrupts </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">141</span><span class="token plain">:     </span><span class="token number" style="color:#36acaa">486703</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">596832</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  IR-PCI-MSI </span><span class="token number" style="color:#36acaa">333824</span><span class="token plain">-edge      iwlwifi: default queue</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的操作查了三次 141 号中断的统计计数，输出信息表明中断服务程序在 0 核上与 3 核上执行，141 号中断的 smp_affinity 内容如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:20:27:01</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> $ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /proc/irq/141/smp_affinity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ff</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从上面的内容可以确定，<strong>141 号中断的中断服务程序被允许在前 8 个核上运行，但是中断统计计数的变化情况表明，它只在 0 核与 3 核上执行。</strong></p><p>下面我通过向 /proc/irq/141/smp_affinity 中写入值来修改中断的 cpu 亲和性，<strong>指定只允许 141 中断服务程序在 4 核上运行。</strong></p><p>操作记录如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:20:29:44</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> $ </span><span class="token function" style="color:#d73a49">su</span><span class="token plain"> -c </span><span class="token string" style="color:#e3116c">&#x27; echo &#x27;</span><span class="token number" style="color:#36acaa">10</span><span class="token string" style="color:#e3116c">&#x27; &gt; /proc/irq/141/smp_affinity&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">密码：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:20:29:56</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> $ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /proc/irq/141/smp_affinity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>写入 proc 下的文件需要有 root 权限，<strong>smp_affinity 是以十六进制的形式传递数据的，每一位表示一个 cpu 核，10 表示只允许在 4 核上执行</strong>。</p><p>第二行命令查询到的结果表明写入 10 到 141 中断的 smp_affinity 文件成功，继续查看 /proc/interrupts 来确定是否真正生效。</p><p>操作记录如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:20:30:02</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> $ </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;141:&#x27;</span><span class="token plain"> /proc/interrupts </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">141</span><span class="token plain">:     </span><span class="token number" style="color:#36acaa">520162</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">596832</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">1465</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  IR-PCI-MSI </span><span class="token number" style="color:#36acaa">333824</span><span class="token plain">-edge      iwlwifi: default queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:20:30:28</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> $ </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;141:&#x27;</span><span class="token plain"> /proc/interrupts </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">141</span><span class="token plain">:     </span><span class="token number" style="color:#36acaa">520162</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">596832</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">1639</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  IR-PCI-MSI </span><span class="token number" style="color:#36acaa">333824</span><span class="token plain">-edge      iwlwifi: default queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">longyu@debian-10:20:30:31</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> $ </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;141:&#x27;</span><span class="token plain"> /proc/interrupts </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">141</span><span class="token plain">:     </span><span class="token number" style="color:#36acaa">520162</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">596832</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">1805</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  IR-PCI-MSI </span><span class="token number" style="color:#36acaa">333824</span><span class="token plain">-edge      iwlwifi: default queue</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到 0 核与 3 核上的中断计数不再增加，4 核上的中断计数在增加表明<strong>设定生效</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="默认-irq_mask-下的中断执行情况">默认 irq_mask 下的中断执行情况<a class="hash-link" href="#默认-irq_mask-下的中断执行情况" title="标题的直接链接">​</a></h2><p>上面的示例中选择 iwlwifi 的中断是有意为之的，在修改其中断亲和性前，查看 smp_affinity 确认使用的是默认的 irq_mask，值为全 F，表示中断服务程序可以在每一个核上运行，理想情况是<strong>每个核上都有统计数据且负载均衡</strong>，但是实际执行情况却是只在 0 核与 3 核上运行。</p><p>中断程序本身执行的代码少的可怜，只有当中断频繁到来的时候其影响才能表现出来，但是中断服务程序中会触发 soft irq，soft irq 做了很多工作且没有 irq_smp 来设定，网上搜索有说它会在被触发的核上执行，照这样来说那 <strong>soft irq 也会随着 irq_smp 的改变而联动改变，但实际测试发现并没有这种效果</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="soft-irq-服务程序执行的-cpu">soft irq 服务程序执行的 cpu<a class="hash-link" href="#soft-irq-服务程序执行的-cpu" title="标题的直接链接">​</a></h2><p>前言中我有描述过，在定位 dpdk 程序绑定到 0 核与 1 核上性能明显下降问题时，通过设定 smp_irq，性能有所提高，但是还是比使用后面的核低一些，<strong>perf 查看发现 0 核上有较多的 softirq 负载</strong>，这些 softirq 将会与测试程序一起共享 0 核，也会造成 dpdk 程序性能下降。</p><p><strong>那么 softirq 在哪个 cpu 上执行呢，它有与 irq smp_affinity 类似的设定接口吗？</strong></p><p>网上搜索了一下获取到了下面的信息：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">softirq 选择执行 cpu 的原则是在哪个 cpu 触发就在哪个 cpu 上执行</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>softirq 会在中断服务程序中触发，而 <strong>smp_affinity</strong> 掩码决定了中断服务程序的执行的 cpu 核，如果上面的描述成立，那么<strong>只要修改了某个中断的 smp_affinity，此中断触发的 softirq 的执行 cpu 也应该随之变化</strong>，而<strong>实际情况是它没有变化</strong>，这里就存在问题。</p><p>一段时候后我重新想了想这个问题，有下面两个方面的怀疑：</p><ol><li><p>网上的说法不可信</p><p>我只简单看过 softirq 的代码，对具体的原理并不清楚，网上的说法存疑！</p></li><li><p>我们的观测方法存在问题</p><p>观测到 softirq 在某个核上执行，但是具体执行的 softirq 是哪个中断的 softirq 并没有深究</p></li></ol><p>softirq 的工作过程有时间了要研究研究！扩展了这个知识，或许这里的问题便有了答案！</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 程序绑核失败问题：EAL: pthread_setaffinity_np failed">问题描述</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->8 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><p>在某系统中，运行原生 dpdk 示例程序会报如下错误：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">EAL: pthread_setaffinity_np failed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PANIC </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> eal_thread_loop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cannot </span><span class="token builtin class-name">set</span><span class="token plain"> affinity</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>将当前进程的 cgroup 切换为系统默认的 cgroup 组就能够解决此问题，但是<strong>为什么要这样做呢？本篇文章中我将对这个问题进行描述。</strong></p><h1>strace 跟踪程序执行</h1><p>strace 跟踪，得到如下相关信息：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20758</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> sched_setaffinity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20758</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">128</span><span class="token plain">, </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unfinished </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20750</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unfinished </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20758</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. sched_setaffinity resumed</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20750</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. close resumed</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20758</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> access</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/sys/devices/system/node/node0/cpu1&quot;</span><span class="token plain">, F_OK </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unfinished </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20750</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> pipe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unfinished </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20758</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. access resumed</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">      </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20750</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. pipe resumed</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">12</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20758</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> access</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/sys/devices/system/node/node0/cpu1&quot;</span><span class="token plain">, F_OK </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unfinished </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20750</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> pipe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unfinished </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20758</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. access resumed</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">      </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20750</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. pipe resumed</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">14</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">15</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20758</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;EAL: lcore 1 is ready (tid=f6902&quot;</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">., </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unfinished </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20750</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> mmap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NULL, </span><span class="token number" style="color:#36acaa">8392704</span><span class="token plain">, PROT_READ</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">PROT_WRITE, MAP_PRIVATE</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">MAP_ANONYMOUS</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">MAP_STACK, -1, 0EAL: lcore </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> is ready </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tid</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">f6902700</span><span class="token punctuation" style="color:#393A34">;</span><span class="token assign-left variable" style="color:#36acaa">cpuset</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20759</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> gettid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unfinished </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20760</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> set_robust_list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">0x7ffff59009e0, </span><span class="token number" style="color:#36acaa">24</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unfinished </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20759</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. gettid resumed</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">      </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20759</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20760</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. set_robust_list resumed</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20759</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> sched_setaffinity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20759</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">128</span><span class="token plain">, </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unfinished </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20760</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> gettid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unfinished </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">20759</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. sched_setaffinity resumed</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> -1 EINVAL </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Invalid argument</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的内容有两个关键点：</p><ol><li>20758 线程设置 cpu 亲和性为 1 核成功</li><li>20759 线程设置 cpu 亲和性为 2 失败，sched_setaffinity 系统调用返回值为 EINVAL</li><li>两个线程都是通过 sched_setaffinity 线程来设置 cpu 亲和性</li></ol><p>sched_setaffinity 系统调用的【返回值】是一个关键信息，man sched_setaffinity 查看返回值的具体含义。</p><h1>man sched_setaffinity</h1><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">EINVAL The affinity bit mask mask contains no processors that are currently physically on the system and  permitted  to  the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              thread  according  to  any  restrictions that may be imposed by cpuset cgroups or the </span><span class="token string" style="color:#e3116c">&quot;cpuset&quot;</span><span class="token plain"> mechanism described </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cpuset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EINVAL </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sched_getaffinity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> and, </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> kernels before </span><span class="token number" style="color:#36acaa">2.6</span><span class="token plain">.9, sched_setaffinity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">))</span><span class="token plain"> cpusetsize is smaller than the  size  of  the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              affinity mask used by the kernel.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我这里的情况符合第一种描述，同时确定设置的 cpu 核是存在的，这样问题就指向了 <strong>cpuset(7)</strong>。</p><h1>man 7 cpuset</h1><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Every  process  </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> the system belongs to exactly one cpuset.  A process is confined to run only on the CPUs </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> the cpuset it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">belongs to, and to allocate memory only on the memory nodes </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> that cpuset.  When a process fork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">s, the child  process  is</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">placed  </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain">  the same cpuset as its parent.  With sufficient privilege, a process may be moved from one cpuset to another and</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">the allowed CPUs and memory nodes of an existing cpuset may be changed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">When the system begins booting, a single cpuset is defined that includes all CPUs and memory nodes on the  system,  and  all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">processes  are  </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> that cpuset.  During the boot process, or later during normal system operation, other cpusets may be cre‐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ated, as subdirectories of this </span><span class="token function" style="color:#d73a49">top</span><span class="token plain"> cpuset, under the control of the system administrator, and processes may  be  placed  </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">these other cpusets.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cpusets  are  integrated  with  the sched_setaffinity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> scheduling affinity mechanism and the mbind</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> and set_mempolicy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">memory-placement mechanisms </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> the kernel.  Neither of these mechanisms </span><span class="token builtin class-name">let</span><span class="token plain"> a process </span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> use of a CPU or memory </span><span class="token function" style="color:#d73a49">node</span><span class="token plain">  that</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">is  not  allowed by that process</span><span class="token string" style="color:#e3116c">&#x27;s cpuset.  If changes to a process&#x27;</span><span class="token plain">s cpuset placement conflict with these other mechanisms,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> cpuset placement is enforced even </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> it means overriding these other mechanisms.  The kernel accomplishes this overrid‐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ing  by  silently restricting the CPUs and memory nodes requested by these other mechanisms to those allowed by the invoking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">process</span><span class="token string" style="color:#e3116c">&#x27;s cpuset.  This can result in these other calls returning an error, if for example, such a call ends  up  requesting</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">an empty set of CPUs or memory nodes, after that request is restricted to the invoking process&#x27;</span><span class="token plain">s cpuset.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>总结得出如下几点关键信息：</p><ol><li>linux 系统中的每一个进程都归属于【唯一的】一个 cpuset，程序被限定为<strong>只能</strong>在归属 cpuset 组允许的 cpu 上执行，也只能从归属 cpuset 组允许的内存节点申请内存</li><li>子进程默认【继承】父进程的 cpuset 配置</li><li>系统启动时，包含所有 cpu 核与内存节点的 cpuset 被创建，此时所有的进程都归属于这个 cpuset，其它后续创建的 cpuset 都位于此 cpuset 的子目录中，这个 cpuset 被称为 【top cpuset】</li><li>当 cpuset 与其它的 cpu、内存分配机制冲突时，cpuset 配置会默认【覆盖】其它机制的配置，内核会限定进程只能使用所加入的 cpuset 允许的 cpu 核与内存节点</li></ol><h1>重新描述问题</h1><p>根据上面的信息能够确定问题为<strong>执行的 dpdk 程序所在的 cpuset 不允许程序在 2 号核上执行</strong>。查看父进程归属的 cgroup 内容如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root-10:10:27:33</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># cat /proc/$$/cgroup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:freezer:/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10</span><span class="token plain">:cpu,cpuacct:/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">9</span><span class="token plain">:pids:/user.slice/user-1000.slice/session-2.scope</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">8</span><span class="token plain">:cpuset:/Isolate_Cpus_Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">7</span><span class="token plain">:net_cls,net_prio:/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">6</span><span class="token plain">:rdma:/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain">:memory:/user.slice/user-1000.slice/session-2.scope</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">:devices:/user.slice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">:blkio:/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">:perf_event:/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token plain">:name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">systemd:/user.slice/user-1000.slice/session-2.scope</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token plain">::/user.slice/user-1000.slice/session-2.scope</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到，父进程归属的 cpuset 为 Isolate_Cpus_Service，此 cpuset 允许执行的 cpu 核如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root-10:10:27:44</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># cat /sys/fs/cgroup/cpuset/Isolate_Cpus_Service/cpuset.cpus</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token plain">-1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>能够确定，<strong>它只允许程序在 0 核跟 1 核执行</strong>，且<strong>内核中 cpuset 的优先级【高于】 sched_setaffinity</strong>，这样使用 sched_setaffinity 设置线程 cpu 亲和性为 2 核的时候就会失败！</p><h1>不修改 dpdk 程序让程序能够执行的方法</h1><p>有时候不方便修改 dpdk 程序，此时可以通过修改父进程（终端 bash 程序）所属的 cpuset 允许的 cpu 核、将父进程的 cpuset 【切换】为 top cpuset 来解决此问题。</p><p>将父进程的 cpuset 切换为 top cpuset，可以执行如下命令：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$$</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /sys/fs/cgroup/cpuset/tasks</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>修改父进程所在的 cpuset 允许的 cpu 核与 top cpuset 一致，可以执行如下命令：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /sys/fs/cgroup/cpuset/cpuset.cpus </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /sys/fs/cgroup/cpuset/Isolate_Cpus_Service/cpuset.cpus</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>为什么要进行 cpu 隔离</h1><p>dpdk 程序在进行 2544 测性能的时候，<strong>当收发包线程所在的 cpu 核上有其它用户态进程也被调度运行时就会产生抖动</strong>，从而造成<strong>丢包</strong>，导致 <strong>2544 的性能变差</strong>，为了消除这种影响，需要对用户态程序进行 cpu 隔离。</p><h1>cpu 核隔离的对象</h1><p>cpu 核隔离针对所有的用户态程序，这种隔离的目的是为了<strong>让 dpdk 程序独占某个 cpu 核</strong>。</p><p>dpdk 程序【缺省】也是被执行了 cpu 隔离的，为此需要将 dpdk 程序归属的 cpuset 设置为 top cpuset，以<strong>允许</strong> dpdk 程序使用<strong>所有的</strong> cpu 核与内存节点。</p><h1>有没有其它 cpu 隔离的方法？</h1><p>除了上面的方法外，我们也可以通过内核启动参数来实现，例如在 grub.conf 中，在内核引导参数中添加 isolcpus=xxx 的配置，然后重启系统就能够生效。</p><p>但是这种方式的操作成本较高，一旦内核启动参数修改存在问题可能无法进入系统，推荐专业人士操作。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 问题分析：不兼容光模块导致 dpdk 程序运行失败问题定位">dpdk/dpdk 问题分析：不兼容光模块导致 dpdk 程序运行失败问题定位</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->5 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题描述">问题描述<a class="hash-link" href="#问题描述" title="标题的直接链接">​</a></h2><p>82599 万兆网卡，一个正常工作，另外一个口不能正常工作，初始化失败，导致 dpdk 程序不能正常启动。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题排查过程">问题排查过程<a class="hash-link" href="#问题排查过程" title="标题的直接链接">​</a></h2><ol><li>检查程序使用的配置文件</li><li>检查 /dev/uioX 设备文件</li><li>检查 dmesg 信息</li></ol><p>排查了上面的三点内容，没有发现异常。首先使用 ethool 收集异常接口的信息，然后准备用官方驱动测试。</p><p>在使用官方驱动测试之前，我想到了可能是光模块的问题，但是客户现场没有支持的同事，且我们没有工具直接获取光模块信息，这一点暂时不能排查。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用-l2fwd-测试">使用 l2fwd 测试<a class="hash-link" href="#使用-l2fwd-测试" title="标题的直接链接">​</a></h2><p>在初步的排查没有定位到问题后，我想使用 l2fwd 程序测试了一下，排查下软件问题。</p><p>运行 l2fwd 后，注意到 l2fwd 启动中有打印探测到的光模块类型信息，记录如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PMD: eth_ixgbe_dev_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">: MAC: </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, PHY: </span><span class="token number" style="color:#36acaa">15</span><span class="token plain">, SFP+: </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PMD: eth_ixgbe_dev_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">: port </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">vendorID</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">0x8086 </span><span class="token assign-left variable" style="color:#36acaa">deviceID</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">0x10fb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: PCI device 0000:04:00.1 on NUMA socket -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL:   probe driver: </span><span class="token number" style="color:#36acaa">8086</span><span class="token plain">:10fb rte_ixgbe_pmd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL:   PCI memory mapped at 0x4001af234000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL:   PCI memory mapped at 0x4001af254000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PMD: eth_ixgbe_dev_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">: MAC: </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, PHY: </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">, SFP+: </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PMD: eth_ixgbe_dev_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">: port </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">vendorID</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">0x8086 </span><span class="token assign-left variable" style="color:#36acaa">deviceID</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">0x10fb</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>port 5 就是出问题的接口，ixgbe 初始化打印出了 SFP+ 的值为 14，这个 14 是在 sfp_type 枚举结构中定义的，此结构内容如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token class-name">ixgbe_sfp_type</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_da_cu </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_sr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_lr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_da_cu_core0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_da_cu_core1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_srlr_core0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_srlr_core1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_da_act_lmt_core0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_da_act_lmt_core1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_1g_cu_core0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_1g_cu_core1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_1g_sx_core0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_1g_sx_core1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_1g_lx_core0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_1g_lx_core1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_1g_lha_core0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_1g_lha_core1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_not_present </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFFFE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_sfp_type_unknown </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFFFF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>14 对应的是 <code>ixgbe_sfp_type_1g_lx_core1</code>看这个名称应该是个千兆的光模块。</p><p>继续在代码中搜索，发现在 ixgbe_identify_sfp_module_generic 中识别 sfp 模块类型的时候有下面相关代码：</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/20201212105203219.png" alt="在这里插入图片描述" class="img_ev3q">
这个代码基本上能够确定 dpdk 程序不能正常运行的原因，这些信息明确指向光模块，于是对这个问题有了如下结论：</p><p>这个问题为在<strong>万兆光口上接了一个千兆的光模块导致万兆接口初始化失败</strong>。</p><p>最终确定的问题与上面的结论一致！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="标题的直接链接">​</a></h2><p>其实光模块的问题我已经遇到好多次了，客户现场偶尔会有这种问题，前期遇到这类问题，需要花不少的时间来定位。</p><p>针对这种问题，我们梳理了公司导入的光模块，输出了 excel 表格，当问题出现时，<strong>首先获取客户现场使用的光模块型号，然后查 excel 表格就能立刻得出结论</strong>。</p><p>输出一个光模块型号列表花了<strong>一个小时左右</strong>，但梳理出这个流程后，下一次遇到相同问题时分分钟就能够解决了，无疑提<strong>高了我们解决问题的效率</strong>。</p><p>其实这里还可以进一步优化，可以写一个<strong>能够直接获取光模块型号等信息的工具</strong>，这样就能够打破前场的某些限制条件。</p><p>进一步再想，其实可以搞一个整合这个获取光模块型号信息的工具与兼容光模块 excel 列表的工具。这个工具首先<strong>使用获取光模块型号信息的工具获取接口的模块信息</strong>，然后<strong>使用某种方式获取兼容的光模块型号列表</strong>，<strong>直接判断模块是否支持并输出结果</strong>。</p><p>有了这种工具光模块问题解决时间可能能够控制在 10 分钟以内，比起之前的几周、几天，这种效率不可同日而语！</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 驱动移植叩开 kni 模块那些黑暗的角落">dpdk/dpdk 驱动移植叩开 kni 模块那些黑暗的角落</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->9 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a class="hash-link" href="#前言" title="标题的直接链接">​</a></h2><p>kni 模块是早期 dpdk 版本中一个非常重要的功能，它充当了用户态驱动与内核协议栈之间的桥梁，让 dpdk 程序能够上送流量到内核协议栈，同时也支持使用ethtool、ifconfig 等重要的网络管理命令。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kni-支持-ethtool-带来的问题">kni 支持 ethtool 带来的问题<a class="hash-link" href="#kni-支持-ethtool-带来的问题" title="标题的直接链接">​</a></h2><p>kni 为了实现 ethtool 获取网卡信息的功能，对 igb、ixgbe 等系列网卡的官方驱动进行修改，意味着 dpdk 内部维护着<strong>两套驱动代码</strong>，一套是<strong>用户态驱动代码</strong>，另一套是 kni 模块中的<strong>内核驱动代码</strong>。这样的情况提高了维护的成本，同时也更容易带来问题。</p><p>高版本 dpdk 中 kni 模块已经<strong>移除了内核驱动的代码</strong>，不再支持 ethtool 获取诸多网卡信息，可是也没有其它替代 ethtool 的工具提供，不由地让人感慨套路之深！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="为什么要修改-kni">为什么要修改 kni?<a class="hash-link" href="#为什么要修改-kni" title="标题的直接链接">​</a></h2><p>既然高版本已经干掉了 kni 的大部分功能，那我们应该追随高版本的发展方向。奈何公司内部使用的 dpdk 版本为 16.04，许多产品仍旧使用 kni 模块来通过ethtool 获取信息，最近遇到了需要适配 x553 新网卡的问题，为了<strong>避免产品代码改动</strong>，需要适配 kni，只能与 kni 短兵相接了！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="新网卡的型号">新网卡的型号<a class="hash-link" href="#新网卡的型号" title="标题的直接链接">​</a></h2><p>新网卡为 x553 网卡，属于 ixgbe 网卡系列，dpdk 16.04 并不支持此款网卡。<strong>pmd 驱动代码从高版本合入，kni 中的代码从 ixgbe-5.8.1 内核驱动合入</strong>。</p><p>下文对适配过程中遇到的一些具体的问题进行记录</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-添加新的-device-id">1. 添加新的 device id<a class="hash-link" href="#1-添加新的-device-id" title="标题的直接链接">​</a></h3><p>dpdk-16.04 支持的网卡型号在 <strong>rte_pci_dev_ids.h</strong> 头文件中被定义，适配新网卡需要<strong>在 rte_pci_dev_ids.h 中添加相应的项目</strong>。</p><p>kni 中使用官方驱动适配，正常方式应该是使用 <strong>pci_device_table</strong> 来定义支持的网卡型号，可是这个 pci_device_table 并没有被使用。</p><p><strong>kni_ioctl_create</strong> 函数中<strong>也通过包含 rte_pci_dev_ids.h 来匹配网卡</strong>，这与pmd 保持一致。</p><p>x553 属于 ixgbe 网卡，<strong>dpdk-16.04 kni</strong> 驱动中在 <strong>ixgbe_pci_tbl</strong> 中定义支持的网卡型号，这里的定义表明<strong>适配的 ixgbe 驱动支持的网卡型号</strong>，阅读代码发现 <strong>ixgbe_pci_tbl</strong> 表中支持的网卡型号与 <strong>rte_pci_dev_ids.h</strong> 中定义的 ixgbe 网卡型号并<strong>不一致</strong>，是其中的一个<strong>子集</strong>。</p><p>当 <strong>rte_pci_dev_ids.h</strong> 中添加了新的 <strong>ixgbe</strong> 网卡，却没有适配 kni 时，在 dpdk 程序初始化的时候仍旧会执行 ixgbe 驱动的 probe 函数，就可能造成问题，</p><p>为此首先在 <strong>ixgbe_pci_tbl 中添加新网卡项</strong>目，然后在 <strong>probe 函数中也使用当前设备的 vendor id 与 device id 在 ixgbe_pci_tbl 中匹配</strong>，匹配成功则执行后续流程，失败则直接返回。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ixgbe_init_shared_code-函数">ixgbe_init_shared_code 函数<a class="hash-link" href="#ixgbe_init_shared_code-函数" title="标题的直接链接">​</a></h3><p>kni 适配中重点修改 <strong>ixgbe_init_shared_code</strong> 函数，此函数中关键过程如下：</p><ol><li>根据 vendor id 与 device id 设置 mac_type</li><li>根据 mac_type 调用不同的初始化函数</li></ol><p>针对 x553 网卡，初始化过程如下：</p><ol><li>ixgbe_set_mac_type 中设定 mac_type 为 ixgbe_mac_X550EM_a</li><li>调用 ixgbe_init_ops_X550EM_a 函数完成初始化过程</li></ol><p>ixgbe_init_ops_X550EM_a 函数调用层次如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ixgbe_init_ops_X550EM_a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ixgbe_init_ops_X550EM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ixgbe_init_ops_X550</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ixgbe_init_ops_X540</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ixgbe_init_phy_ops_generic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ixgbe_init_ops_generic</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在初始化过程中完成对 <strong>phy、mac、eeprom</strong> 等结构虚函数表的赋值，一些函数的<strong>赋值过程可能有多次</strong>！</p><p>完成其它函数的适配后，使用 kni 程序进行测试，结果发现系统崩溃了，一通分析发现问题与网卡的 <strong>reset</strong> 函数有关。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ixgbe_reset_hw_82599-函数中的注释">ixgbe_reset_hw_82599 函数中的注释<a class="hash-link" href="#ixgbe_reset_hw_82599-函数中的注释" title="标题的直接链接">​</a></h3><p>首先找到一个<strong>正常的版本</strong>进行<strong>对比</strong>，82599 测试过能够正常工作，于是阅读 <strong>ixgbe_reset_hw_82599</strong> 函数，发现它的大部分内容都被注释掉了，注释的截止位置如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">/* Store the permanent mac address */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     hw</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mac</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ops</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get_mac_addr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hw</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mac</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">perm_addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>直接完全注释 <strong>ixgbe_reset_hw_X550em</strong> 后测试发现，ifconfig 看到的接口信息中 <strong>mac</strong> 地址不正常，于是参照 <strong>ixgbe_reset_hw_82599</strong> 的代码进行修改，注释掉 <strong>get_mac_addr</strong> 之前的代码，测试正常。</p><p>问题在于网卡在 dpdk 程序调用 <strong>rte_eal_init</strong> 的时候<strong>已经被初始化</strong>了，并且已经被用户态程序使用，kni 中<strong>重新初始化正在被使用的网卡</strong>就会导致异常。</p><p>阅读其它代码，也能够看到注释的项目，大部分内容都跟硬件操作有关，且注释格式凌乱，像某种非法地带～</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ixgbe_get_settings-函数的修改">ixgbe_get_settings 函数的修改<a class="hash-link" href="#ixgbe_get_settings-函数的修改" title="标题的直接链接">​</a></h3><p>初始化过程搞定后，运行 kni 程序，然后执行 ethtool 进行测试，发现输出的链路模式不正确，想到应该要适配 <strong>ixgbe_get_settings</strong> 函数。</p><p><strong>ixgbe_get_settings</strong> 中的细节非常多，为了避免造成问题，对 x553 型号的网
卡单独判断，使用新的 <strong>ixgbe_get_settings</strong> 函数。</p><p>执行 ethtool 的测试结果如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Settings </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> vEth0_0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Supported ports: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> TP </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Supported </span><span class="token function" style="color:#d73a49">link</span><span class="token plain"> modes:   10baseT/Full</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                100baseT/Full</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                1000baseT/Full</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Supported pause frame use: Symmetric</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Supports auto-negotiation: Yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Advertised </span><span class="token function" style="color:#d73a49">link</span><span class="token plain"> modes:  10baseT/Full</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                100baseT/Full</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                1000baseT/Full</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Advertised pause frame use: Symmetric</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Advertised auto-negotiation: Yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Speed: Unknown</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Duplex: Full</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Port: Twisted Pair</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PHYAD: </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Transceiver: external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Auto-negotiation: on</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MDI-X: Unknown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Supports Wake-on: d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Wake-on: d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Current message level: 0x00000007 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               drv probe </span><span class="token function" style="color:#d73a49">link</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Link detected: </span><span class="token function" style="color:#d73a49">yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Link detected 的输出结果为 yes，而 Speed 的值却为 Unknown，这看上去就不太对，不过支持的链路模式与接口类型都正确了。</p><p>阅读 ixgbe_get_settings 函数代码，发现了如下语句：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">332</span><span class="token plain">     </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">in_interrupt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">333</span><span class="token plain">         hw</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mac</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ops</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">check_link</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">link_speed</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">link_up</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">334</span><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">335</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> 336          * this case is a special workaround for RHEL5 bonding</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> 337          * that calls this routine from interrupt context</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> 338          */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">339</span><span class="token plain">         link_speed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> adapter</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">link_speed</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">340</span><span class="token plain">         link_up </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> adapter</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">link_up</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">341</span><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>大多数情况下都会走到 if 判断中，调用 <strong>check_link</strong> 来获取当前网卡的状态，
基于这个点进行修改，能够获取到速率了！</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="check_link-同时调用的问题">check_link 同时调用的问题？<a class="hash-link" href="#check_link-同时调用的问题" title="标题的直接链接">​</a></h3><p>在解决上述问题的过程中，我想到了一个问题:当关闭网卡 lsc 中断时，dpdk 程序中调用 <strong>rte_eth_link_get_nowait</strong> 获取状态也会调用到 ixgbe 的 check_link 函数，同时业务脚本中调用 <strong>ethtool</strong> 获取网卡状态也会调用 <strong>check_link</strong> 函数，可能存在同时调用的问题。</p><p>阅读代码确认，ixgbe 驱动的 <strong>check_link</strong> 函数实质上是通过获取 <strong>IXGBE_LINKS</strong> 寄存器来确定接口状态的，这个寄存器手册中没有说明不能同时读取，理论上没有太大问题！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="标题的直接链接">​</a></h2><p>新网卡的适配带来了 dpdk 升级的问题，这是产品的痛点。为了解决这个痛点常常要做一些移植工作，这些移植工作总结起来有如下几个类别：</p><ol><li>dpdk 高版本驱动、功能移植到低版本</li><li>内核驱动移植到 kni</li><li>内核驱动移植到 pmd 中</li></ol><p>这些工作是一个深入研究 dpdk 的机会，其难点在于理清楚某功能、网卡从初始化到被使用的全过程，对这些过程越了解，做起这些工作来越有底气！</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk-16.04 eal lcore 多线程机制分析">dpdk 多线程流水线</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->17 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><p>dpdk 抽象的 eal 环境在初始化的时候会探测系统上可用的 cpu 核，为每个核创建一个线程，并初始化相应的数据结构。</p><p>一般来说，多线程创建的时候传入的 start_routine 函数指针就限定了多线程程序执行的入口，并且当程序调用 pthread_create 成功后线程就开始执行。</p><p>对于 dpdk 来说在初始化 eal 环境时，<strong>并不确定针对每个核创建的线程将要执行哪些任务</strong>，这些任务的确定<strong>推迟到 dpdk 程序编码中</strong>，这是 dpdk 不同于常见多线程处理模型的特点。</p><p>为此，dpdk 提供接口让 dpdk 程序将需要执行的任务分发到 dpdk 内部为每个逻辑核创建的线程上，可以称为 dpdk 多线程流水线机制。</p><p>分发任务后又引入了新的问题，即这些分发的任务什么时候执行？其执行终止的状态该如何控制等等，这些都是 dpdk 多线程流水线机制需要解决的问题。</p><p>本文将从以上问题开始探讨，基于 dpdk-16.04 的 linuxapp 实现，逐步分析 dpdk 多线程流水线机制的工作原理。</p><h1>如何动态的分发任务到多线程中？</h1><p>上文已经提及，使用 pthread_create 创建的线程，一经创建成功便从 pthread_create 函数的 start_routine 参数指定的函数处开始执行。dpdk 为每个逻辑核创建的线程都指定了一个<strong>统一的入口</strong>，即 <strong>eal_thread_loop</strong> 函数，此函数负责执行下发到每个逻辑核线程的函数。</p><p>dpdk 程序下发的函数可以看做是针对逻辑核线程的配置，那这个配置在 dpdk 中有怎样的形式呢？</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="lcore_config-结构">lcore_config 结构<a class="hash-link" href="#lcore_config-结构" title="标题的直接链接">​</a></h2><p>dpdk 内部抽象出的 lcore_config 结构定义了每个逻辑核线程的配置及一些私有的变量，其定义如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * Structure storing internal configuration (per-lcore)</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">lcore_config</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> detected</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; true if lcore was detected */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">pthread_t</span><span class="token plain"> thread_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; pthread identifier */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> pipe_master2slave</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; communication pipe with master */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> pipe_slave2master</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; communication pipe with master */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">lcore_function_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">volatile</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; function to call */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">volatile</span><span class="token plain"> arg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; argument of function */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">volatile</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; return value of function */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">volatile</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token class-name">rte_lcore_state_t</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; lcore state */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> socket_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; physical socket id for this lcore */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> core_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; core number on socket for this lcore */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> core_index</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; relative index, starting from 0 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">rte_cpuset_t</span><span class="token plain"> cpuset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; cpu set which the lcore affinity to */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这些数据结构可以分为如下几类：</p><ol><li>标识绑定到的线程的成员</li><li>用于控制、描述 lcore 线程执行状态的成员</li><li>代表分发到 lcore 线程中的执行单元的成员</li><li>用于描述 cpu 亲和性及 numa 节点的成员</li></ol><p>上述不同类别的成员一起抽象出了 dpdk 下发到每个 lcore 线程的配置，<strong>dpdk 内部维护了一个 lcore_config 结构体数组，每个使能的逻辑核都会占据这个数组中的一项。</strong></p><p>下面我针对 lcore_config 结构的几个类别的成员进行分析。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lcore_config-中标识绑定到的线程的成员">lcore_config 中标识绑定到的线程的成员<a class="hash-link" href="#lcore_config-中标识绑定到的线程的成员" title="标题的直接链接">​</a></h3><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> detected</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; true if lcore was detected */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">pthread_t</span><span class="token plain"> thread_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; pthread identifier */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>detected 标志这个 lcore 是否可用，thread_id 代表绑定到当前 lcore_config 上的线程 id。</p><p>thread_id 不足为奇，dpdk 在创建需要的逻辑核线程时为 thread_id 赋值，但<strong>为何要创建一个 detected 成员呢</strong>？</p><p>由于 dpdk 程序在运行前<strong>并不确定系统上的逻辑核数目</strong>，但是它内部实现为需要提前分配每个逻辑核的 lcore_config 结构的方式，而分配多少个逻辑核的 lcore_config 就成为了一个必须的参数，为此 dpdk 预设了一个参数，<strong>默认支持 128 个逻辑核，同时这项配置也导出到 .config 中让用户动态配置</strong>。</p><p>这样当 dpdk 程序运行时，需要根据运行环境的实际逻辑核来设定特定的 lcore_config 结构，这就需要标识出哪些 lcore_config 结构是可用的，这就是 detected 成员的功能。</p><p>dpdk 通过在 rte_eal_init 函数中调用 rte_eal_cpu_init 函数来初始化预设的每个 lcore_config 结构中的 detected 字段，此外 cpuset、 core_id 、 socket_id 也都在这个函数中被设定。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="用于控制描述-lcore-线程执行状态的成员">用于控制、描述 lcore 线程执行状态的成员<a class="hash-link" href="#用于控制描述-lcore-线程执行状态的成员" title="标题的直接链接">​</a></h3><p>dpdk 需要分发执行单元到 lcore 线程中，这就涉及到与每个 lcore 线程的交互，需要控制执行单元执行的时机，并能够通过某个内部成员表示出每个 lcore 线程的当前状态。</p><p>如上功能对应 lcore_config 中的如下成员：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> pipe_master2slave</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; communication pipe with master */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> pipe_slave2master</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; communication pipe with master */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">volatile</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token class-name">rte_lcore_state_t</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; lcore state */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>pipe_master2slave 与 pipe_slave2master 建立起了主线程与每个 lcore 逻辑线程之间的通信管道。</p><p><strong>为什么要创建两个匿名管道呢？</strong></p><p>pipe 是半双工的进程间通信方式，它的工作原理如下：
<img loading="lazy" src="https://img-blog.csdnimg.cn/20210506214520105.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xvbmd5dV93bHo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" class="img_ev3q">
一般来说，pipe 的一端负责读，一端负责写，数据的流动是单向的。dpdk 为了实现 master 线程与 slave 线程之间的<strong>双向通信</strong>就为每个 lcore 线程创建了<strong>两个</strong>匿名管道。</p><p>state 变量表示 lcore 线程的状态，有如下几种类型：</p><ol><li>WAIT 状态，等待下发任务</li><li>RUNNING 状态，正在执行下发的任务</li><li>FINISHED 状态，下发任务执行完成</li></ol><p>rte_eal_init 创建每个逻辑核线程时，将 state 设置为 WAIT 状态，表示线程等待任务下发。</p><p>rte_eal_init 中的相关代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">RTE_LCORE_FOREACH_SLAVE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">         * create communication pipes between master thread</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">         * and children</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">         */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">pipe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pipe_master2slave</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rte_panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Cannot create pipe\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">pipe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pipe_slave2master</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rte_panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Cannot create pipe\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> WAIT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* create a thread for each lcore */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pthread_create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">thread_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     eal_thread_loop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rte_panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Cannot create thread\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* Set thread_name for aid in debugging. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">snprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">thread_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> RTE_MAX_THREAD_NAME_LEN</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;lcore-slave-%d&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_thread_setname</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">thread_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        thread_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">RTE_LOG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ERR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> EAL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;Cannot set name for lcore thread\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述代码为每个逻辑核创建两个匿名管道，并将 lcore_config 数组中的对应项目的 state 变量设定为 WAIT 状态，然后调用 pthread_create 创建逻辑核线程，将 thread_id 保存在 lcore_config 数组中当前项目的 thread_id 中，并指定线程入口为 eal_thread_loop。最后通过 rte_thread_setname 设置线程的名称，<strong>每个逻辑核线程在这里被称为 slave 线程</strong>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代表分发到-lcore-线程中的执行单元的成员">代表分发到 lcore 线程中的执行单元的成员<a class="hash-link" href="#代表分发到-lcore-线程中的执行单元的成员" title="标题的直接链接">​</a></h3><p>lcore_config 结构的如下成员描述了下发到 lcore 线程中的执行单元：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">lcore_function_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">volatile</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; function to call */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">volatile</span><span class="token plain"> arg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; argument of function */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">volatile</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; return value of function */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>f 指向待执行的任务单元，arg 指向任务单元附属的参数，ret 保存执行单元执行的返回值。</p><p><strong>eal_common_launch.c</strong> 中实现了下发任务与获取逻辑核状态的接口，下发任务通过调用 <strong>rte_eal_mp_remote_launch</strong> 函数来完成。</p><p>此函数的代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rte_eal_mp_remote_launch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">arg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token class-name">rte_rmt_call_master_t</span><span class="token plain"> call_master</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> lcore_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> master </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_get_master_lcore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* check state of lcores */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">RTE_LCORE_FOREACH_SLAVE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lcore_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lcore_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> WAIT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">EBUSY</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* send messages to cores */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">RTE_LCORE_FOREACH_SLAVE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lcore_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">rte_eal_remote_launch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lcore_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">call_master </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> CALL_MASTER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">master</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">master</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FINISHED</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此函数将任务分发到每个逻辑核线程上，分发前先检查每个逻辑核线程的状态，没有处于 WAIT 状态表明逻辑核线程已经有任务正在执行，函数直接返回。</p><p>当逻辑核线程空闲时，遍历每个逻辑核，调用 rte_eal_remote_launch 将 f 参数代表的执行单元分发到相应的逻辑核线程中。</p><p>rte_eal_remote_launch 函数的主要逻辑如下：</p><ol><li>获取 rte_eal_init 中为当前逻辑核线程创建的匿名管道，master 到 slave 的管道为 m2s，slave 到 master 的管道为 s2m。</li><li>判断 slave 线程是否处于 WAIT 状态，否，则返回 -EBUSY。</li><li>将 f 与 arg 参数设定到当前逻辑核线程对应的 lcore_config 项目的 f 与 arg 成员上。</li><li>通过 m2s 向 slave 线程的管道写入字符 &#x27;0&#x27;。</li><li>从 s2m 管道读取 slave 线程向 master 线程回复的 ack，收到回复则成功返回，未收到回复、其它异常情况则直接终止程序。</li></ol><p>rte_eal_remote_launch 函数执行完成后，返回到 rte_eal_mp_remote_launch 函数中，判断 <strong>call_master</strong> 参数是否为 <strong>CALL_MASTER</strong>，是则在当前线程上调用 f 函数并保存返回值到 master 线程对应的 lcore_config 结构的 ret 变量中，执行完成后将 master 线程对应的 lcore_config 数组中的 state 变量设定为 FINISHED。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="用于描述线程-cpu-亲和性及-numa-节点的成员">用于描述线程 cpu 亲和性及 numa 节点的成员<a class="hash-link" href="#用于描述线程-cpu-亲和性及-numa-节点的成员" title="标题的直接链接">​</a></h3><p>相关数据成员如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> socket_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; physical socket id for this lcore */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> core_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; core number on socket for this lcore */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> core_index</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; relative index, starting from 0 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">rte_cpuset_t</span><span class="token plain"> cpuset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; cpu set which the lcore affinity to */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>socket_id 表示逻辑核所在的物理 numa id，core_id 表示当前逻辑核所在的 numa 节点上的核数，core_index 表示从 0 开始的核下标，cpuset 表示当前逻辑核的 cpu 亲和性设置。</p><p>socket_id、core_id、core_index、cpuset 在 rte_eal_init 函数的子函数调用中被初始化，cpuset 在 eal_thread_loop 函数中被设定到对应的线程上。</p><p>eal_thread_loop 函数源码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* main loop of threads */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">__attribute__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">noreturn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">eal_thread_loop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">__attribute__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unused</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">arg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> lcore_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">pthread_t</span><span class="token plain"> thread_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> m2s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s2m</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> cpuset</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">RTE_CPU_AFFINITY_STR_LEN</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    thread_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pthread_self</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* retrieve our lcore_id from the configuration structure */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">RTE_LCORE_FOREACH_SLAVE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lcore_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">thread_id </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lcore_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">thread_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lcore_id </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> RTE_MAX_LCORE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">rte_panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;cannot retrieve lcore id\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    m2s </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lcore_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pipe_master2slave</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s2m </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lcore_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pipe_slave2master</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* set the lcore ID in per-lcore memory area */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">RTE_PER_LCORE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_lcore_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lcore_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* set CPU affinity */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">eal_thread_set_affinity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">rte_panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;cannot set affinity\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">eal_thread_dump_affinity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cpuset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> RTE_CPU_AFFINITY_STR_LEN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">RTE_LOG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DEBUG</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> EAL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;lcore %u is ready (tid=%x;cpuset=[%s%s])\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lcore_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">thread_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cpuset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ret </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;...&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* read on our pipe to get commands */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">fct_arg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* wait command */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            n </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m2s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> errno </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> EINTR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rte_panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;cannot read on configuration pipe\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lcore_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RUNNING</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* send ack */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        n </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> errno </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> EINTR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            n </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s2m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rte_panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;cannot write on configuration pipe\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lcore_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rte_panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;NULL function pointer\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* call the function and store the return value */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fct_arg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lcore_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">arg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lcore_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fct_arg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lcore_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">rte_wmb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lcore_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lcore_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FINISHED</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* never reached */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* pthread_exit(NULL); */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* return NULL; */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此函数的关键过程如下：</p><ol><li><p>获取当前线程的 thread_id</p></li><li><p>使用获取到的 thread_id 在 lcore_config 数组中匹配，确定对应的 lcore_id，lcore_id 不合法则终止程序，合法则获取 m2s（主线程到从线程的匿名管道）与 s2m （从线程到主线程的匿名管道）</p></li><li><p>设定每线程变量 per_lcore__lcore_id，设定后调用 pthread 库的函数设定当前线程的 cpu 亲和性</p></li><li><p>dump 当前线程的 cpu 亲和性</p></li><li><p>从 m2s 读取主线程发送的数据，失败则直接终止程序，成功则继续执行下一步</p></li><li><p>设定当前线程 lcore_config 结构中的 state 变量为 RUNNING，标志下发任务即将执行</p></li><li><p>通过 s2m 向主线程发送 ack，失败则直接终止程序，成功则继续执行下一步</p></li><li><p>判断当前线程 lcore_config 结构中的 f 变量值是否为空，为空则终止程序，不为空则继续执行下一步</p></li><li><p>调用当前线程 lcore_config 结构中设定的 f 函数，并保存其返回值到 lcore_config 结构中的 ret 变量中，最后将 lcore_config 结构中的 state 变量设定为 FINISHED 标志下发任务执行完成。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用每线程数据-lcore_id-的意义">使用每线程数据 lcore_id 的意义<a class="hash-link" href="#使用每线程数据-lcore_id-的意义" title="标题的直接链接">​</a></h3><p>dpdk 定义了每线程数据 lcore_id，这个 lcore_id 是每个线程的本地数据，它被用于快速获取 lcore_config 数组、其它全局数组中，当前线程占据的元素。</p></li></ol><p>最初创建逻辑核线程时，每个 lcore_config 数组中不同项目的 thread_id 中保存了绑定到的线程的 id 号。dpdk 需要在逻辑核线程的执行函数中获取当前线程对应的 lcore_config 结构，如果每次都遍历 lcore_config 数组来确定，效率很差，同时每个逻辑核对应的 lcore_config 结构已经创建并关联后就是确定的，不会再变化。</p><p>按照我的理解，基于这两点原因，dpdk 定义了每线程数据 lcore_id，在 eal_thread_loop 函数中为这个每线程 id 赋值，赋值完成后，在每个线程中就可以以 lcore_id 为下标来获取到诸如 lcore_config 这种每个线程的结构。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="为什么不将-lcore_config-结构也定义为每线程数据">为什么不将 lcore_config 结构也定义为每线程数据？<a class="hash-link" href="#为什么不将-lcore_config-结构也定义为每线程数据" title="标题的直接链接">​</a></h2><p>按照上文的描述，每个逻辑核线程都需要分配一个 lcore_config 结构，那为什么要通过全局数组，能否将 lcore_config 结构也定义为一个每线程数据来实现呢？</p><p>仔细想想这是不合理的，lcore_config 结构中的一些成员如执行单元相关的成员需要在其它线程中被访问并赋值，而在其它线程中访问到的 lcore_config 结构是本线程的 tls 变量，这样就设定不了其它线程的 lcore_config 结构的成员，故而不能将 lcore_config 结构定义为每线程数据。</p></div></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/longyu.github.io/blog"><div class="pagination-nav__label">较新的博文</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/longyu.github.io/blog/page/3"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="footer__link-item">longyuwlz<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/longyu.github.io/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 龙瑜的文字世界, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/longyu.github.io/assets/js/runtime~main.9bcca1a9.js"></script>
<script src="/longyu.github.io/assets/js/main.4339af60.js"></script>
</body>
</html>