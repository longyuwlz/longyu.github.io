<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/longyu.github.io/blog/rss.xml" title="龙瑜的文字世界 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/longyu.github.io/blog/atom.xml" title="龙瑜的文字世界 Atom Feed"><title data-rh="true">龙瑜的博客 | 龙瑜的文字世界</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://longyuwlz.github.io/longyu.github.io/blog/page/6"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="龙瑜的博客 | 龙瑜的文字世界"><meta data-rh="true" name="description" content="美好的时光在文字中停滞不前"><meta data-rh="true" property="og:description" content="美好的时光在文字中停滞不前"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="canonical" href="https://longyuwlz.github.io/longyu.github.io/blog/page/6"><link data-rh="true" rel="alternate" href="https://longyuwlz.github.io/longyu.github.io/blog/page/6" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://longyuwlz.github.io/longyu.github.io/blog/page/6" hreflang="x-default"><link rel="stylesheet" href="/longyu.github.io/assets/css/styles.f233e9eb.css">
<link rel="preload" href="/longyu.github.io/assets/js/runtime~main.9bcca1a9.js" as="script">
<link rel="preload" href="/longyu.github.io/assets/js/main.4339af60.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/longyu.github.io/"><div class="navbar__logo"><img src="/longyu.github.io/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/longyu.github.io/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">龙瑜的文字世界</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/longyu.github.io/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">历史发布</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/Failed to mmap 2MB hugepages 与 max_map_count limit">dpdk/Failed to mmap 2MB hugepages 与 max_map_count limit</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/I210 网卡设定 force link mode 并关闭 EEE mode">dpdk/I210 网卡设定 force link mode 并关闭 EEE mode</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/Unsupported SFP+ Module">dpdk/Unsupported SFP+ Module</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk ebpf 库跨版本移植">dpdk ebpf 库跨版本移植</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk mempool cache 机制分析">dpdk/dpdk mempool cache 机制分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 不同版本下载地址">dpdk/dpdk 不同版本下载地址</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 多进程模型共享队列收发包 virtio 网卡段错误问题">dpdk 多进程模型</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 官方 bugzilla 导出信息">dpdk/dpdk 官方 bugzilla 导出信息</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 对 numa 的使用与多 numa 架构下性能调优的基础">dpdk/dpdk 对 numa 的使用与多 numa 架构下性能调优的基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 收发包函数分析：dpdk-20.11 ice sse 向量收发包函数关键过程分析">收发包向量函数实现分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 死锁问题后续之初始化假设不可迁移问题">dpdk/dpdk 死锁问题后续之初始化假设不可迁移问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 用户态驱动框架及其演进过程分析">dpdk 用户态驱动框架及其部分演进过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序性能问题排查的一般流程">dpdk/dpdk 程序性能问题排查的一般流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序接口 down、up 问题定位的一般流程">接口 up、down 失败问题排查</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序收发包问题排查的一般流程">dpdk 程序收发包问题排查</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序绑不同的核性能有明显差异问题分析">dpdk/dpdk 程序绑不同的核性能有明显差异问题分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序绑核失败问题：EAL: pthread_setaffinity_np failed">问题描述</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 问题分析：不兼容光模块导致 dpdk 程序运行失败问题定位">dpdk/dpdk 问题分析：不兼容光模块导致 dpdk 程序运行失败问题定位</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 驱动移植叩开 kni 模块那些黑暗的角落">dpdk/dpdk 驱动移植叩开 kni 模块那些黑暗的角落</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 eal lcore 多线程机制分析">dpdk 多线程流水线</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 eal 初始化 log 信息解析">dpdk/dpdk-16.04 eal 初始化 log 信息解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 igb crc length 统计问题">dpdk/dpdk-16.04 igb crc length 统计问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 igb_uio 模块分析">dpdk/dpdk-16.04 igb_uio 模块分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 l2fwd 源码分析">dpdk/dpdk-16.04 l2fwd 源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 rte_kni 模块与内核内存泄露问题">问题描述</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 rte_kni 模块分析">dpdk/dpdk-16.04 rte_kni 模块分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 rte_spinlock.h rte_cpu_get_flag_enabled 接口问题">dpdk/dpdk-16.04 rte_spinlock.h rte_cpu_get_flag_enabled 接口问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 扩展新网卡驱动过程">编译相关配置添加</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 根目录中 .git 目录对编译参数的影响">dpdk/dpdk-16.04 根目录中 .git 目录对编译参数的影响</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 监听 uio 文件检测中断的示例 demo 与内部实现解析">dpdk/dpdk-16.04 监听 uio 文件检测中断的示例 demo 与内部实现解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 虚拟化环境 virtio 网卡 secondary 进程段错误问题分析定位">dpdk/dpdk-16.04 虚拟化环境 virtio 网卡 secondary 进程段错误问题分析定位</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 解初始化过程">dpdk/dpdk-16.04 解初始化过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 配置与编译过程分析">dpdk/dpdk-16.04 配置与编译过程分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-19.11 armv8 l2fwd 在某 arm 内核上无法运行问题">dpdk/dpdk-19.11 armv8 l2fwd 在某 arm 内核上无法运行问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-19.11 支持接口配置速率双工的方法">前言</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk程序启动顺序引发的血案">dpdk/dpdk程序启动顺序引发的血案</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/ethtool 命令指定的网络设备名在哪里被使用？">dpdk/ethtool 命令指定的网络设备名在哪里被使用？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/gcc constructor 属性修饰的构造函数未被链接问题">dpdk/gcc constructor 属性修饰的构造函数未被链接问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/igb_uio.ko 的 md5sum 为啥又变化了？">dpdk/igb_uio.ko 的 md5sum 为啥又变化了？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/l2fwd 支持 x710 通过 fdir 过滤非分片 ipv4 udp 报文">dpdk/l2fwd 支持 x710 通过 fdir 过滤非分片 ipv4 udp 报文</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/x710 hash 分片与非分片 tcp 报文异常问题">dpdk/x710 hash 分片与非分片 tcp 报文异常问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/不懂 dpdk mbuf 结构？此篇文章带你超神">dpdk 中 mbuf 的结构</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/以 ixgbe pmd 驱动为例研究 dpdk pmd 驱动中注册中断回调函数并使能中断的过程">dpdk/以 ixgbe pmd 驱动为例研究 dpdk pmd 驱动中注册中断回调函数并使能中断的过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/以 rte_mempool_ops_table 为例描述 dpdk 程序库链接顺序对程序执行的影响">dpdk mempool_ops</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/使用内核驱动上手 x710 flow directory 功能">环境介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/关闭 stdout 引发的灾难">dpdk/关闭 stdout 引发的灾难</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/杀掉数通引擎导致虚拟机重启问题定位">dpdk/杀掉数通引擎导致虚拟机重启问题定位</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/网卡接口绑定驱动及其使用的 bind、unbind、new_id 等 sys 文件">dpdk/网卡接口绑定驱动及其使用的 bind、unbind、new_id 等 sys 文件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/试玩 dpdk ebfp 功能">dpdk/试玩 dpdk ebfp 功能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk kni 口 ifconfig up down 的执行流程">dpdk/dpdk kni 口 ifconfig up down 的执行流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 中 rte_config.h 配置文件生成的问题">dpdk/dpdk 中 rte_config.h 配置文件生成的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 中 rte_eth_link_get_wait、nowait 函数研究">dpdk/dpdk 中 rte_eth_link_get_wait、nowait 函数研究</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 常见问题：uio 设备文件创建以及 iommu 导致 x710 网卡初始化失败问题">uio 设备文件创建的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序创建 kni 虚拟网络接口失败的问题">dpdk/dpdk 程序创建 kni 虚拟网络接口失败的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 问题排查的第一关：基础环境的排查">dpdk/dpdk 问题排查的第一关：基础环境的排查</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/编译dpdk-19.10时遇到的问题">dpdk/编译dpdk-19.10时遇到的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-kni与ethtool试玩问题记录">dpdk/dpdk-kni与ethtool试玩问题记录</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-pdump工具编译运行">dpdk/dpdk-pdump工具编译运行</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-pdump编译运行">dpdk/dpdk-pdump编译运行</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk库源码中包含内核头文件的问题">dpdk/dpdk库源码中包含内核头文件的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk收发包测试之使用内核接口给dpdk绑定的端口发包">dpdk/dpdk收发包测试之使用内核接口给dpdk绑定的端口发包</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/ethtool 读到的状态与 dpdk 读到的网卡状态不一致">dpdk/ethtool 读到的状态与 dpdk 读到的网卡状态不一致</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/将网卡绑定到官方驱动测试过程">dpdk/将网卡绑定到官方驱动测试过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/记录一次编译器版本过低导致 dpdk 无法成功编译的问题">dpdk/记录一次编译器版本过低导致 dpdk 无法成功编译的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/设置 EXTRA_CFLAGS 以编译 debug 版本 dpdk 库">dpdk/设置 EXTRA_CFLAGS 以编译 debug 版本 dpdk 库</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/libc/使用mtrace跟踪内存泄露问题">libc/使用mtrace跟踪内存泄露问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/linux-kernel/linux-内核模块中引用符号是如何链接的">linux-kernel/linux-内核模块中引用符号是如何链接的</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/2022/06/12/序言">写博客的意义</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 中 rte_config.h 配置文件生成的问题">dpdk/dpdk 中 rte_config.h 配置文件生成的问题</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-20T23:48:14.000Z" itemprop="datePublished">2022年6月20日</time> · <!-- -->8 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="为什么要生成-rte_configh-头文件">为什么要生成 rte_config.h 头文件<a class="hash-link" href="#为什么要生成-rte_configh-头文件" title="标题的直接链接">​</a></h2><p>dpdk 有单独的一套 config 配置文件，在 RTE_TARGET 变量指定的目标目录下需要生成一个 .config 文件，这个 .config 文件用来配置 dpdk 中不同组件的功能。</p><p>dpdk 大部分代码都是用 C 语言编写的，不能够直接使用 .config 文件。在 dpdk 编译过程中会根据 RTE_TARGET 变量指定的目标目录中的 .config 文件生成 rte_config.h 文件，dpdk 内部实际是使用 rte_config.h 文件工作的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-编译过程中生成-rte_target-目录中的-include-目录">dpdk 编译过程中生成 RTE_TARGET 目录中的 include 目录<a class="hash-link" href="#dpdk-编译过程中生成-rte_target-目录中的-include-目录" title="标题的直接链接">​</a></h2><p>dpdk 编译时首先会在 include 目录中生成需要使用的头文件，一个标准的目录内容如下：
<img loading="lazy" src="https://img-blog.csdnimg.cn/20200805105306287.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xvbmd5dV93bHo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" class="img_ev3q">从上图中可以发现 rte_config.h 文件的颜色与其他文件、目录的颜色不同，这里 ls 用不同的颜色标注了不同的文件类型。</p><p>rte_config.h 是个<strong>普通文件</strong>，其他的头文件都是<strong>链接文件</strong>，这是 rte_config.h 的特别之处。</p><p>ls -l 查看 rte_config.h 与任意一个其它的头文件信息，输出如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[localhost include]$ ls -lh rte_eal.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx 1 xx xx 45 Aug  4 19:15 rte_eal.h -&gt; ../../lib/librte_eal/common/include/rte_eal.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[localhost include]$ ls -lh ./rte_config.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-rw-r-- 1 xx xx 11K Aug  4 15:55 ./rte_config.h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到 rte_eal.h 是一个链接文件，指向 dpdk 源码目录中的头文件；rte_config.h 则是一个普通文件。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rte_configh-文件的生成过程">rte_config.h 文件的生成过程<a class="hash-link" href="#rte_configh-文件的生成过程" title="标题的直接链接">​</a></h3><p>上文中已经提到过 rte_config.h 文件是使用 .config 文件生成的，这里分析下具体的生成过程。</p><p>dpdk 源码目录下 mk 子目录中的  rte.sdkconfig.mk Makefile 文件中描述了 rte_config.h 的生成过程。</p><p>相关的 Makefile 脚本内容如下：</p><div class="language-Makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$(RTE_OUTPUT)/include/rte_config.h: $(RTE_OUTPUT)/.config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $(Q)rm -rf $(RTE_OUTPUT)/include $(RTE_OUTPUT)/app \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $(RTE_OUTPUT)/hostapp $(RTE_OUTPUT)/lib \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $(RTE_OUTPUT)/hostlib $(RTE_OUTPUT)/kmod $(RTE_OUTPUT)/build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $(Q)mkdir -p $(RTE_OUTPUT)/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $(Q)$(RTE_SDK)/scripts/gen-config-h.sh $(RTE_OUTPUT)/.config \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &gt; $(RTE_OUTPUT)/include/rte_config.h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的格式是 Makefile 文件的写法。可以看到目标 rte_config.h 文件依赖 .config 文件来生成。
需要更新 rte_config.h 文件时，会执行如下步骤：</p><ol><li>删除 RTE_TARGET 目录中的 include app lib hostlib kmod 等中间生成的目录</li><li>重新创建 RTE_TARGET include 目录</li><li>调用 gen-config-h.sh 文件生成 rte_config.h，重定向会清空已经存在的 rte_config.h 文件内容</li></ol><p>gen-config-h.sh 脚本内容如下：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;#ifndef __RTE_CONFIG_H&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;#define __RTE_CONFIG_H&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> CONFIG_ </span><span class="token variable" style="color:#36acaa">$1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> -v </span><span class="token string" style="color:#e3116c">&#x27;^[ \t]*#&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;s,CONFIG_\(.*\)=y.*$,#undef \1\</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#define \1 1,&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;s,CONFIG_\(.*\)=n.*$,#undef \1,&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;s,CONFIG_\(.*\)=\(.*\)$,#undef \1\</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#define \1 \2,&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;s,\# CONFIG_\(.*\) is not set$,#undef \1,&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;#endif /* __RTE_CONFIG_H */&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述脚本中的 $1 就是 .config 文件的路径，这个脚本用来生成 rte_config.h 文件。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="什么时候需要生成-rte_configh-文件">什么时候需要生成 rte_config.h 文件？<a class="hash-link" href="#什么时候需要生成-rte_configh-文件" title="标题的直接链接">​</a></h3><p>按照 Makefile 的规则，目标文件并不是在任何时候都会更新。只有在以下两种情况下 rte_config.h 文件会更新：</p><ol><li>目标文件不存在时</li><li>目标文件存在且时间戳落后于依赖文件时</li></ol><p>当 rte_config.h 文件不存在时，dpdk 在编译时需要首先根据 rte_config.h 文件生成，这样的逻辑没有问题。</p><p>当 rte_config.h 文件存在时，dpdk 在编译时需要检查时间戳来判断是否需要重新生成，这里就会判断 .config 文件与 rte_config.h 文件的时间戳，只有当 rte_config.h 时间戳比 .config 文件早时（落后于依赖文件时）才会重新生成。</p><p>这里就有一个潜在的问题。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="svn-库中-rte_target-目标目录中-include-目录存在-rte_configh-的情况">svn 库中 RTE_TARGET 目标目录中 include 目录存在 rte_config.h 的情况<a class="hash-link" href="#svn-库中-rte_target-目标目录中-include-目录存在-rte_configh-的情况" title="标题的直接链接">​</a></h3><p>上面我已经说明了 rte_config.h 文件更新的时机，在我们维护的 dpdk 版本中 RTE_TARGET 目标目录中 include 存在 rte_config，因此只有当 rte_config.h 时间戳比 .config 文件早的时候，rte_config.h 文件才会重新生成，否则它会使用 svn 库中存在的版本。</p><p>我重新拉取一个 dpdk 版本，然后查看 .config 文件与 rte_config.h 文件的时间戳，输出信息如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ls -l --full-time .config ./include/rte_config.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-rw-r-- 1 xx xx 15969 2020-08-05 11:37:11.780409454 +0800 .config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-rw-r-- 1 xx xx 10695 2020-08-05 11:37:11.781409454 +0800 ./include/rte_config.h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到 rte_config.h 的时间戳要比 .config 晚，所以在这种情况下 rte_config.h 文件不会更新。</p><p>目标目录中执行 make V=1 打印详细信息，有如下输出</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[localhost x86_64-native-linuxapp-gcc]$ make V=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make -f /tmp/dpdk-16.04/mk/rte.sdkconfig.mk checkconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make -f /tmp/dpdk-16.04/mk/rte.sdkconfig.mk \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headerconfig NODOTCONF=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make -s depdirs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make -f /tmp/dpdk-16.04/mk/rte.sdkbuild.mk all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">== Build lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make S=lib -f /tmp/dpdk-16.04/lib/Makefile -C /tmp/dpdk-16.04/x86_64-native-linuxapp-gcc/build/lib all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">== Build lib/librte_compat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SYMLINK-FILE include/rte_compat.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ln -nsf `/tmp/dpdk-16.04/scripts/relpath.sh /tmp/dpdk-16.04/lib/librte_compat/rte_compat.h /tmp/dpdk-16.04/x86_64-native-linuxapp-gcc/include` /tmp/dpdk-16.04/x86_64-native-linuxapp-gcc/include</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述输出中没有执行生成 rte_config.h 的操作。</p><p>这时我们修改 .config 文件的内容，例如修改 MAX_ETHPORTS 为 128，相关修改如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Index: .config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">===================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- .config     (revision 19876)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ .config     (working copy)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ -129,7 +129,7 @@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # Compile generic ethernet library</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> CONFIG_RTE_LIBRTE_ETHER=y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> CONFIG_RTE_LIBRTE_ETHDEV_DEBUG=n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-CONFIG_RTE_MAX_ETHPORTS=64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+CONFIG_RTE_MAX_ETHPORTS=128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> CONFIG_RTE_MAX_QUEUES_PER_PORT=1024</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> CONFIG_RTE_LIBRTE_IEEE1588=n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> CONFIG_RTE_ETHDEV_QUEUE_STAT_CNTRS=16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 修改完成后，重新执行 make V=1 有如下输出：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make -f /tmp/dpdk-16.04/mk/rte.sdkconfig.mk checkconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make -f /tmp/dpdk-16.04/mk/rte.sdkconfig.mk \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headerconfig NODOTCONF=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf /tmp/dpdk-16.04/x86_64-native-linuxapp-gcc/include /tmp/dpdk-16.04/x86_64-native-linuxapp-gcc/app \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /tmp/dpdk-16.04/x86_64-native-linuxapp-gcc/hostapp /tmp/dpdk-16.04/x86_64-native-linuxapp-gcc/lib \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /tmp/dpdk-16.04/x86_64-native-linuxapp-gcc/hostlib /tmp/dpdk-16.04/x86_64-native-linuxapp-gcc/kmod /tmp/dpdk-16.04/x86_64-native-linuxapp-gcc/build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p /tmp/dpdk-16.04/x86_64-native-linuxapp-gcc/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/dpdk-16.04/scripts/gen-config-h.sh /tmp/dpdk-16.04/x86_64-native-linuxapp-gcc/.config \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &gt; /tmp/dpdk-16.04/x86_64-native-linuxapp-gcc/include/rte_config.h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到这次 rte_config.h 文件确实更新了。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="需要提交-rte_configh-文件的修改吗">需要提交 rte_config.h 文件的修改吗？<a class="hash-link" href="#需要提交-rte_configh-文件的修改吗" title="标题的直接链接">​</a></h2><p>上面的操作是没有问题的，在这个基础上进行 release 也是没有问题的。</p><p><strong>但是我们在提交对 .config 文件的修改时，很少有人会同步修改 svn 中的 rte_config.h 文件，这样就存在了一个隐患。</strong></p><p>当其他人<strong>重新拉取 dpdk svn 编译时</strong>，由于 svn 中<strong>存在 rte_config.h 且 rte_config.h 文件的时间戳比 .config 文件晚</strong>，这次编译将<strong>不会重新成 rte_config.h 文件</strong>，这样<strong>一直使用的就是 svn 库中存在的 rte_config.h 文件</strong>，这就可能<strong>造成问题</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="最终的解决方案">最终的解决方案<a class="hash-link" href="#最终的解决方案" title="标题的直接链接">​</a></h2><p>同步修改 svn 库中的 rte_config.h 文件能够避免这个问题，但是不是很好的解决方案。</p><p>实际上，我们不应该在 svn 的源码路径中管理这些编译过程中会<strong>自动生成的文件</strong>，这样一方面可能<strong>干扰到正常的编译过程</strong>，另一方面也可能在我们提交修改时出现遗漏从而埋下一个隐患。</p><p>故而针对这个问题，选择直接删除 dpdk svn 库中的 include 目录即可，这样每次 rte_config.h 文件都能根据 .config 文件来更新，不会产生 .config 文件不生效的问题。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 中 rte_eth_link_get_wait、nowait 函数研究">dpdk/dpdk 中 rte_eth_link_get_wait、nowait 函数研究</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-20T23:48:14.000Z" itemprop="datePublished">2022年6月20日</time> · <!-- -->5 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="对-rte_eth_link_get_waitnowait-函数的研究">对 rte_eth_link_get_wait\nowait 函数的研究<a class="hash-link" href="#对-rte_eth_link_get_waitnowait-函数的研究" title="标题的直接链接">​</a></h2><p>与 rte_eth_link_get_nowait 函数功能类似的函数是 rte_eth_link_get 函数。 这两个函数的主要逻辑如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_eth_dev</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">RTE_ETH_VALID_PORTID_OR_RET</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">port_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">rte_eth_devices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">port_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev_conf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intr_conf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lsc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">rte_eth_dev_atomic_read_link_status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eth_link</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">RTE_FUNC_PTR_OR_RET</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev_ops</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">link_update</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev_ops</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">link_update</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* 1 =&gt; wait，0 =&gt; no wait */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">eth_link </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev_link</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="使能-lsc-中断的情况">使能 lsc 中断的情况<a class="hash-link" href="#使能-lsc-中断的情况" title="标题的直接链接">​</a></h2><p>如果使能了 lsc——link status change 中断，则直接原子读取 dev 中的 data-&gt;dev_link 成员，根据读取到的结果来判断链接状态是否改变。使用这种方式的应用程序需要注册一个 lsc 中断的回调函数，可以参考 examples/link_status_interrupt。</p><p>在 link_status_interrupt 的 demo 中，注册 lsc 中断回调函数的语句如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">rte_eth_dev_callback_register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">portid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        RTE_ETH_EVENT_INTR_LSC</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lsi_event_callback</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 lsi_event_callback 函数的核心是调用 rte_eth_link_get_nowait 来获取链路 状态。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="未使能-lsc-中断的情况">未使能 lsc 中断的情况<a class="hash-link" href="#未使能-lsc-中断的情况" title="标题的直接链接">​</a></h2><p>如果没有使用 lsc 中断，则调用 pmd 驱动中实现的 dev_ops-&gt;link_update 函数来完成。 wait 与 nowait 的区别就是在 link_update 函数中体现的。</p><p><strong>一般来说 wait 方式倾向于检测到接口 up 状态</strong>，在设定的时间内（9s) 内不断的轮询接口状态，当<strong>获取到一次 up 就立刻返回</strong>，或者<strong>当时间耗尽时仍旧为 down 则返回 down 的状态</strong>。</p><p>nowait 方式则不存在这种倾向，它直接读取接口的当前状态返回。</p><p>这里 link_update 的返回值表示<strong>链路状态与上一次的状态相比是否有变化</strong>，有变化则返回 0，无变化则返回 -1。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ixgbe-驱动中-link_update-函数的实现">ixgbe 驱动中 link_update 函数的实现<a class="hash-link" href="#ixgbe-驱动中-link_update-函数的实现" title="标题的直接链接">​</a></h2><p>ixgbe pmd 驱动中 link_update 函数的源码在 ixgbe_ethdev.c 文件中实现，摘录如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ixgbe_dev_link_update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_eth_dev</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> wait_to_complete</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ixgbe_hw</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">hw </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">IXGBE_DEV_PRIVATE_TO_HW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev_private</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_eth_link</span><span class="token plain"> link</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> old</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ixgbe_link_speed link_speed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IXGBE_LINK_SPEED_UNKNOWN</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> link_up</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> diag</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ETH_LINK_DOWN</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_speed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_duplex </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ETH_LINK_HALF_DUPLEX</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">old</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">old</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">rte_ixgbe_dev_atomic_read_link_status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">old</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hw</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mac</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_link_status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* check if it needs to wait to complete, if lsc interrupt is enabled */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wait_to_complete </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev_conf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intr_conf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lsc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                diag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ixgbe_check_link</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">link_speed</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">link_up</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                diag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ixgbe_check_link</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">link_speed</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">link_up</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">diag </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_speed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ETH_SPEED_NUM_100M</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_duplex </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ETH_LINK_FULL_DUPLEX</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">rte_ixgbe_dev_atomic_write_link_status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">link</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_status </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> old</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">link_up </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">rte_ixgbe_dev_atomic_write_link_status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">link</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_status </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> old</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ETH_LINK_UP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_duplex </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ETH_LINK_FULL_DUPLEX</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">link_speed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> IXGBE_LINK_SPEED_UNKNOWN</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_duplex </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ETH_LINK_FULL_DUPLEX</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_speed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ETH_SPEED_NUM_100M</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> IXGBE_LINK_SPEED_100_FULL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_speed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ETH_SPEED_NUM_100M</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> IXGBE_LINK_SPEED_1GB_FULL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_speed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ETH_SPEED_NUM_1G</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> IXGBE_LINK_SPEED_10GB_FULL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_speed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ETH_SPEED_NUM_10G</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">rte_ixgbe_dev_atomic_write_link_status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">link</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_status </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> old</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">link_status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ixgbe_check_link 函数中会读取硬件寄存器来获取链路状态内容。这之后链路的当前状态会被更新到 dev 中的 data-&gt;dev_link 成员中，update_link 函数执行完成后，rte_eth_link_get_nowait、rte_eth_link_get 函数会将 <strong>dev 中更新后 的 data-&gt;dev_link 成员的值写入到传入的 eth_link 参数中</strong>，上层通过该参数就能获取到当前的链路状态。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-获取到的链路状态到底是什么组件的状态">dpdk 获取到的链路状态到底是什么组件的状态？<a class="hash-link" href="#dpdk-获取到的链路状态到底是什么组件的状态" title="标题的直接链接">​</a></h2><p>dpdk 中获取到的链路状态实际上是 phy 的状态，在实际应用中这个状态会产生的震荡现象，这其实也是 phy 状态的抖动造成的结果，阅读网卡手册能够找到 MAC 寄存器中也存在 LINK status 寄存器，是否可以考虑获取 MAC 中与链路状态相关的寄存器来作为网卡链路状态呢？这种方式是否能够行得通呢？这需要进一步的思考与尝试了！</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 常见问题：uio 设备文件创建以及 iommu 导致 x710 网卡初始化失败问题">uio 设备文件创建的问题</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-20T23:48:14.000Z" itemprop="datePublished">2022年6月20日</time> · <!-- -->2 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><p>使用 dpdk 程序进行收发包需要依赖 uio 设备文件，这个设备文件在一些系统中并不会自动创建，我们需要在启动流程中添加相应的创建流程。一般来说我们会在绑定驱动前来完成这个任务。</p><p>可以使用如下脚本来完成：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">uiomajor_id</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">awk</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&#x27;/ uio$/ {print $1}&#x27;</span><span class="token variable" style="color:#36acaa"> /proc/devices</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#36acaa">id</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">seq</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">0</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">63</span><span class="token variable" style="color:#36acaa">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">mknod</span><span class="token plain"> /dev/uio</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$id</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> c </span><span class="token variable" style="color:#36acaa">$uiomajor_id</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里需要注意，uio 设备文件的 major 号可能会改变，因此我们最好每次都从 /proc/devices 文件中获取最新的，避免造成问题。</p><p>同时注意这里我创建了 64 个 uio 设备文件，这意味着系统中最多使用 64 个网络接口。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="iommu-导致-x710-网卡初始化失败问题">iommu 导致 x710 网卡初始化失败问题<a class="hash-link" href="#iommu-导致-x710-网卡初始化失败问题" title="标题的直接链接">​</a></h2><p>网上搜索了下，这个问题与 iommu 相关，按照这个思路，进行了如下尝试：</p><ol><li>bios 中关闭 VT-d 后进行测试问题仍旧存在</li><li>修改 grub.cfg 脚本，设定 linux 启动参数 intel_iommu=off </li></ol><p>添加 <strong>intel_iommu=off</strong> 参数后 x710 网卡能够正常使用，这个 iommu 导致问题的情况在 dpdk known issues 中应该是有说明的。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 程序创建 kni 虚拟网络接口失败的问题">dpdk/dpdk 程序创建 kni 虚拟网络接口失败的问题</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-20T23:48:14.000Z" itemprop="datePublished">2022年6月20日</time> · <!-- -->5 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题描述">问题描述<a class="hash-link" href="#问题描述" title="标题的直接链接">​</a></h2><p>今天接到了同事的一个反馈，说更新了 dpdk 后 kni 口无法正常创建。怀疑可能是 rte_kni.ko 模块存在问题导致创建失败。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="排查过程">排查过程<a class="hash-link" href="#排查过程" title="标题的直接链接">​</a></h2><p>运行产品的 dpdk 程序后发现确实<strong>没有创建</strong> kni 口，并且 dpdk 程序在不断的<strong>重启</strong>。</p><p>使用 kni 命令也能够复现问题，在这种基础上，需要排查问题出在<strong>内核还是用户态程序</strong>中。这时我想到在 kni 口创建过程中内核会有信息打印，查看 dmesg 信息，发现 ioctl 的过程没有任何相关的打印。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="是否打印级别的问题">是否打印级别的问题？<a class="hash-link" href="#是否打印级别的问题" title="标题的直接链接">​</a></h2><p>没有打印可能是 printk 打印级别的问题，可以通过修改 /proc/sys/kernel/printk 文件来解决。manual 中相关内容摘录如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   /proc/sys/kernel/printk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       /proc/sys/kernel/printk  is  a writable file containing four integer values that influence kernel printk() behavior when printing or logging error messages.  The</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       four values are:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       console_loglevel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Only messages with a log level lower than this value will be printed to the console.  The default value for this field  is  DEFAULT_CONSOLE_LOGLEVEL  (7),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              but  it  is set to 4 if the kernel command line contains the word &quot;quiet&quot;, 10 if the kernel command line contains the word &quot;debug&quot;, and to 15 in case of a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              kernel fault (the 10 and 15 are just silly, and equivalent to 8).  The value of console_loglevel can be set (to a value in the range 1–8)  by  a  syslog()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              call with a type of 8.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       default_message_loglevel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              This  value  will be used as the log level for printk() messages that do not have an explicit level.  Up to and including Linux 2.6.38, the hard-coded de‐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              fault value for this field was 4 (KERN_WARNING); since Linux 2.6.39, the default value is a defined by the kernel configuration option CONFIG_DEFAULT_MES‐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              SAGE_LOGLEVEL, which defaults to 4.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       minimum_console_loglevel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              The value in this field is the minimum value to which console_loglevel can be set.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       default_console_loglevel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              This is the default value for console_loglevel.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>重要的东西在于 console_loglevel 这个字段，只有当消息的日志级别低于这个值才会打印，我将这个值调高到 7 后重新执行程序发现还是没有打印，修改了 kni 中创建虚拟网络接口的代码，重新测试发现也没有打印，确定是没有调用到。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="内核与用户态问题界定">内核与用户态问题界定<a class="hash-link" href="#内核与用户态问题界定" title="标题的直接链接">​</a></h2><p>根据上面的结果，我没有界定出问题到底出在内核中还是用户态程序中，我对 kni 口创建的过程比较清楚，知道这个是用户态程序中调用 ioctl 发 IOCTL_CREATE 子命令到内核中，调用 kni_ioctl_create 函数来完成的。</p><p>那么我要界定问题出在哪里其实很简单，使用 strace 跟踪系统调用就可以了。用 strace 跟踪，确认程序没有调用到 ioctl 来创建 kni 口，确定问题出在用户态。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="用户态程序中创建-kni-口的流程">用户态程序中创建 kni 口的流程<a class="hash-link" href="#用户态程序中创建-kni-口的流程" title="标题的直接链接">​</a></h2><p>用户态程序中创建 kni 接口的步骤主要有如下两步：</p><ol><li>rte_kni_init 初始化相关数据结构</li><li>rte_kni_alloc 创建 kni 虚拟接口</li></ol><p>dpdk-16.04 中 rte_kni_alloc 中相关代码如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    snprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mz_name, sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mz_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, RTE_MEMPOOL_OBJ_NAME,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pktmbuf_pool-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mz </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rte_memzone_lookup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mz_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KNI_MEM_CHECK</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mz </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev_info.mbuf_va </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mz-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev_info.mbuf_phys </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mz-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">phys_addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">pktmbuf_pool </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pktmbuf_pool</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">group_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> conf-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">group_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">slot_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> slot-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">mbuf_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> conf-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">mbuf_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kni_fd, RTE_KNI_IOCTL_CREATE, </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">dev_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>怀疑是在这个 KNI_MEM_CHECK 这出了问题，进一步排查确认了问题确实是 mz 为 NULL 导致没有调用 ioctl 就提前终止了。至于为啥 rte_memzone_lookup 没有找到 mz_name，原因是没有人创建它。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="标题的直接链接">​</a></h2><p>在分析一个问题时首先要对问题进行界定，界定问题是为了缩小问题的范围。在这个问题中内核与用户态就是需要界定的点，没有这个界定问题就不好搞。其实也是在这里进行了一个 2 分法，这个过程可以一直执行下去，直到解决了问题。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 问题排查的第一关：基础环境的排查">dpdk/dpdk 问题排查的第一关：基础环境的排查</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-20T23:48:14.000Z" itemprop="datePublished">2022年6月20日</time> · <!-- -->12 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="uio-驱动是否加载">uio 驱动是否加载<a class="hash-link" href="#uio-驱动是否加载" title="标题的直接链接">​</a></h2><p>igb_uio 驱动依赖 uio 驱动，<strong>实际上 igb_uio 可以看做是一个使用 uio 驱动映射硬件设备到用户态的实例</strong>。</p><p>一般来说 uio 驱动大多都是直接编译到内核中的，不过也存在将这个驱动编译为模块的方式。</p><p>检查 uio 驱动是否加载可以通过查看 <strong>/sys/class/uio 文件是否存在</strong>来判断。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="igb_uio-与-rte_kni-驱动是否加载">igb_uio 与 rte_kni 驱动是否加载<a class="hash-link" href="#igb_uio-与-rte_kni-驱动是否加载" title="标题的直接链接">​</a></h2><p>编译 dpdk 时一般会生成两个内核模块：</p><ol><li>igb_uio.ko</li><li>rte_kni.ko</li></ol><p>igb_uio 驱动负责<strong>将硬件设备映射到用户态</strong>，rte_kni 负责<strong>创建虚拟网络设备用于 ifconfig、ethtool 命令控制、获取接口状态</strong>。</p><p>一般来说 igb_uio.ko 是<strong>必须加载</strong>的，而 rte_kni.ko 是否加载则看业务需求，在一些不需要创建 kni 虚拟网络接口的程序中，不需要加载 rte_kni.ko。</p><p>可以通过查看 /<strong>sys/module/igb_uio</strong> 与 <strong>/sys/module/rte_kn</strong>i 目录是否存在来判断这两个驱动是否正常加载，或者执行 <strong>lsmod | grep igb_uio</strong>、l<strong>smod | grep rte_kni</strong> 来判断。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="网卡是否绑定驱动">网卡是否绑定驱动<a class="hash-link" href="#网卡是否绑定驱动" title="标题的直接链接">​</a></h2><p>dpdk 控制的硬件是网卡接口，网卡在 linux 内核中一般都有自己的内核驱动，dpdk 要正常使用的话，需要<strong>将这些网卡接口绑定到 igb_uio 驱动中</strong>以在<strong>用户态控制硬件</strong>。</p><p>dpdk 中提供了一个 dpdk-devbind.py 的脚本来完成接口绑定的工作，在老版本中这个脚本的名字是 dpdk_nic_bind.py。</p><p>执行 -s 命令来查看需要使用的网卡接口是否绑定到了 igb_uio 中，执行示例如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@virt-debian10:~/dpdk-test$ dpdk-devbind.py -s </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Network devices using DPDK-compatible driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000:04:00.0 </span><span class="token string" style="color:#e3116c">&#x27;82574L Gigabit Network Connection&#x27;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">drv</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">igb_uio </span><span class="token assign-left variable" style="color:#36acaa">unused</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000:08:00.0 </span><span class="token string" style="color:#e3116c">&#x27;82574L Gigabit Network Connection&#x27;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">drv</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">igb_uio </span><span class="token assign-left variable" style="color:#36acaa">unused</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000:09:00.0 </span><span class="token string" style="color:#e3116c">&#x27;82574L Gigabit Network Connection&#x27;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">drv</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">igb_uio </span><span class="token assign-left variable" style="color:#36acaa">unused</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Network devices using kernel driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000:01:00.0 </span><span class="token string" style="color:#e3116c">&#x27;Virtio network device&#x27;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">if</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">enp1s0 </span><span class="token assign-left variable" style="color:#36acaa">drv</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">virtio-pci </span><span class="token assign-left variable" style="color:#36acaa">unused</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">igb_uio *Active*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Other network devices</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>drv=igb_uio 表示接口绑定到了 igb_uio 驱动上，可以看到我上面的示例中 04:00.0、08:00.0、09:00.0 这三个 e100e 的 82574L 网卡都绑定到了 igb_uio 中。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="devuiox-设备文件是否正常生成">/dev/uioX 设备文件是否正常生成<a class="hash-link" href="#devuiox-设备文件是否正常生成" title="标题的直接链接">​</a></h2><p>在一些内核中，在将网卡接口绑定到 igb_uio 的时候会自动生成 /dev/uioX 文件，在另外一些内核中 /dev/uioX 文件不会自动生成，需要手动创建。</p><p>这种需要手动创建的情况可能会出现 major 设备号不一致的情况，这常常会导致 dpdk 程序运行异常。</p><p>首先我们查看 /dev/uioX 字符设备文件中 major id 的值，可以执行 ls -lh 来查看。执行示例如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@virt-debian10:~/dpdk-test$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -lh /dev/uio*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">crw------- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">244</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:46 /dev/uio0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">crw------- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">244</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:41 /dev/uio1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">crw------- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">244</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:41 /dev/uio2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">longyu@virt-debian10:~/dpdk-test$ </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里 244 就是 uio 设备 major_id 的值，0, 1, 2 为 minor_id 的值，这里的 major_id 要与 /proc/devices 文件中 uio 设备的 major_id 对应。</p><p>我们可以执行如下命令查看当前系统中 uio 设备文件的 major_id:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@virt-debian10:~/dpdk-test$ </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27; uio$&#x27;</span><span class="token plain"> /proc/devices </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">244</span><span class="token plain"> uio</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里 244 表示 major_id 的值，uio 表示一类设备名称，可以看到这里的 244 与上面 /dev/uioX 中的 major_id 能够对应的上，这就是正常的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="devuiox-能否正常访问">/dev/uiox 能否正常访问<a class="hash-link" href="#devuiox-能否正常访问" title="标题的直接链接">​</a></h2><p>dpdk 程序中通过 uio 设备文件映射物理硬件的硬件资源，同时监听 uio 设备文件事件来捕获中断，在一些情况中，/dev/uiox 文件尽管已经创建了但是不能正常访问，这也会造成问题。</p><p>可以 cat /dev/uiox 文件来查看是否能够正常访问此文件。执行示例如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@virt-debian10:/home/longyu/dpdk-test</span><span class="token comment" style="color:#999988;font-style:italic"># cat /dev/uio2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat: /dev/uio2: Invalid argument</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里 Invalid argument 表示我们可以正常打开文件，不过因为 /dev/uiox 文件并不像普通的文件那样能够直接读取字符，会报 Invalid argument 的错误。</p><p>一个异常情况如下所示：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@virt-debian10:/home/longyu/dpdk-test</span><span class="token comment" style="color:#999988;font-style:italic"># cat /dev/uio4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat: /dev/uio4: No such device</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@virt-debian10:/home/longyu/dpdk-test</span><span class="token comment" style="color:#999988;font-style:italic"># ls -lh /dev/uio4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">crw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">244</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:52 /dev/uio4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到当我们 cat /dev/uio4 的时候报了 No such device 的错误，而我们 ls 查看发现这个设备文件确实是存在的，这就是一个异常的状态。这种状态多半还是某个网卡接口没有绑定到 igb_uio 上的结果。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="devkni-文件是否创建">/dev/kni 文件是否创建<a class="hash-link" href="#devkni-文件是否创建" title="标题的直接链接">​</a></h2><p>对于要使用 rte_kni 程序创建虚拟网络接口的设备来说，/dev/kni 文件需要正常创建。</p><p>kni 中注册了一个 misc 设备，并且动态分配了 misc 设备的 minor id。我们可以提通过执行如下命令获取 misc 的 major id 与 kni 动态分配的 minor id。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@virt-debian10:/home/longyu/dpdk-test</span><span class="token comment" style="color:#999988;font-style:italic"># grep &#x27;misc&#x27; /proc/devices </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> misc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@virt-debian10:/home/longyu/dpdk-test</span><span class="token comment" style="color:#999988;font-style:italic"># grep &#x27;kni&#x27; /proc/misc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">58</span><span class="token plain"> kni</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到在我的系统中，misc 的 major id 为 10，kni 动态分配的 minor id 为 58，有了这个信息我们查看 /dev/kni 文件信息来判断是否正确生成。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@virt-debian10:/home/longyu/dpdk-test</span><span class="token comment" style="color:#999988;font-style:italic"># ls -lh /dev/kni</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">crw------- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">58</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> 08:52 /dev/kni</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到，/dev/kni 设备文件存在，且 major id 与 minor id 正常。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="大页内存是否正常">大页内存是否正常<a class="hash-link" href="#大页内存是否正常" title="标题的直接链接">​</a></h2><p>dpdk 程序的启动一般都会依赖大页内存，使用大页内存能够<strong>降低缺页带来的性能损耗达到提高性能的目的</strong>。</p><p>dpdk 程序运行前需要配置好大页内存，一些系统在启动时指定启动参数预留指定大小的大页内存数目，一些系统在启动过程中写入 <strong>/sys/kernel/mm/hugepages/hugepages-*/nr_hugepages</strong> 来创建大页内存。</p><p>我们可以通过查看 <strong>/proc/meinfo</strong> 来查看系统中大页内存的使用情况，示例信息如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HugePages_Total:     </span><span class="token number" style="color:#36acaa">512</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HugePages_Free:      </span><span class="token number" style="color:#36acaa">512</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HugePages_Rsvd:        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HugePages_Surp:        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hugepagesize:       </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"> kB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hugetlb:         </span><span class="token number" style="color:#36acaa">1048576</span><span class="token plain"> kB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述字段的含义如下表：</p><table><thead><tr><th>名称</th><th>含义</th></tr></thead><tbody><tr><td>HugePages_Total</td><td>大页总数</td></tr><tr><td>HugePages_Free</td><td>空闲的大页数目</td></tr><tr><td>HugePages_Rsvd</td><td>保留的大页内存数目（已经提交 alloc 申请但是没有真正 alloc 的大页数目）</td></tr><tr><td>HugePages_Surp</td><td>大页内存池中超过 /proc/sys/vm/nr_hugepages 的大页数目</td></tr><tr><td>Hugepagesize</td><td>大页的单个页面大小</td></tr><tr><td>Hugetlb</td><td>大页的总大小</td></tr></tbody></table><p>我们需要关注 HugePages_total 的数目，在一些情况下可能会有大页内存数目过少导致 dpdk 程序无法正常启动的问题。</p><p>确认了大页内存的数目后，还需要检查 hugetlbfs 文件系统是否正常挂载。可以通过查看 /etc/mtab 来判断。一个正常的示例如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@virt-debian10:/home/longyu</span><span class="token comment" style="color:#999988;font-style:italic"># grep &#x27;huge&#x27; /etc/mtab</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nodev /mnt/huge hugetlbfs rw,relatime,pagesize</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">2M </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里 /mnt/huge 的目录并不固定，在一些系统中它也可能是 /dev/huge 等目录。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="网卡接口类型是否正确">网卡接口类型是否正确<a class="hash-link" href="#网卡接口类型是否正确" title="标题的直接链接">​</a></h2><p>dpdk 官方的 demo 中通过获取 pci 的信息来判断网卡的型号。产品的业务可能需要针对每个接口写额外的配置信息，这样一般会生成一个配置文件，这个配置文件中描述了网卡接口的配置信息，其中与 dpdk 关联比较大的就是网卡的型号，需要确定<strong>网卡的接口类型与真实类型对应</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一个简单的检测脚本">一个简单的检测脚本<a class="hash-link" href="#一个简单的检测脚本" title="标题的直接链接">​</a></h2><p>上文中我描述了排查 dpdk 程序运行的环境是否正常的基本点，这些基本点就是<strong>检测脚本的需求</strong>，我们可以预先针对不同的点编写检测脚本，要定位问题时，直接刷脚本看结果。</p><p>一个简单的示例如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">check_failed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\033</span><span class="token string" style="color:#e3116c">[31m</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string entity" style="color:#36acaa">\033</span><span class="token string" style="color:#e3116c">[0m&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /dev/stderr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">check_passed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">&quot;[</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">]</span><span class="token string entity" style="color:#36acaa">\033</span><span class="token string" style="color:#e3116c">[32m check passed </span><span class="token string entity" style="color:#36acaa">\033</span><span class="token string" style="color:#e3116c">[0m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">check_uio_module</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">uio_major_id</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">awk</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&#x27;/ uio$/{print $1}&#x27;</span><span class="token variable" style="color:#36acaa"> /proc/devices</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -z </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$uio_major_id</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        check_failed </span><span class="token string" style="color:#e3116c">&quot;uio module not loaded&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    check_passed </span><span class="token string" style="color:#e3116c">&quot;uio module loaded&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">return</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$uio_major_id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">check_specified_module_loaded</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -z </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Invalid module_name </span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /dev/stderr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">return</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -d </span><span class="token string" style="color:#e3116c">&quot;/sys/module/</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        check_passed </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c"> module loaded&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        check_failed </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c"> module not loaded&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">check_uiofile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">uiofile</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">ls</span><span class="token variable" style="color:#36acaa"> /dev/uio* </span><span class="token variable operator file-descriptor important" style="color:#393A34">2</span><span class="token variable operator" style="color:#393A34">&gt;</span><span class="token variable" style="color:#36acaa">/dev/null</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">uio_major_id</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -z </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$uio_major_id</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Invalid parameters </span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /dev/stderr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -z </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$uiofile</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        check_failed </span><span class="token string" style="color:#e3116c">&quot;/dev/uio* file not created&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    check_passed </span><span class="token string" style="color:#e3116c">&quot;/dev/uioX file exist&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#36acaa">file</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$uiofile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">major_id</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">ls</span><span class="token variable" style="color:#36acaa"> -l $file </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">awk</span><span class="token variable" style="color:#36acaa"> -F </span><span class="token variable string" style="color:#e3116c">&#x27;,| &#x27;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&#x27;{printf(&quot;%s&quot;,$5)}&#x27;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$major_id</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -ne </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$uio_major_id</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        check_failed </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$file</span><span class="token string" style="color:#e3116c"> major id </span><span class="token string variable" style="color:#36acaa">$major_id</span><span class="token string" style="color:#e3116c"> invalid, should be </span><span class="token string variable" style="color:#36acaa">$uio_major_id</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        check_passed </span><span class="token string" style="color:#e3116c">&quot;check </span><span class="token string variable" style="color:#36acaa">$file</span><span class="token string" style="color:#e3116c"> major_id checked passed&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># TODO check cat /dev/uioX</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 1. check uio module</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">check_uio_module</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">uio_device_major_id</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 2. check dpdk module</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">check_specified_module_loaded igb_uio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">check_specified_module_loaded rte_kni</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 3. check /dev/uioX file </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">check_uiofile </span><span class="token variable" style="color:#36acaa">$uio_device_major_id</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>运行示例如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@virt-debian10:/home/longyu/dpdk-test</span><span class="token comment" style="color:#999988;font-style:italic"># ./check_dev_uio.sh </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">uio module loaded</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> check passed </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">igb_uio module loaded</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> check passed </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">rte_kni module loaded</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> check passed </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">/dev/uioX </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> exist</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> check passed </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">check /dev/uio0 major_id checked passed</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> check passed </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">check /dev/uio1 major_id checked passed</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> check passed </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">check /dev/uio2 major_id checked passed</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> check passed </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">check /dev/uio4 major_id checked passed</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> check passed </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="标题的直接链接">​</a></h2><p>dpdk 程序的执行依赖诸多环节，在定位问题时我们首先要排查这些基本环节是否正确，也就是所谓的 <strong>dpdk 程序运行的基础环境是否正常</strong>。</p><p>根据我的经验 dpdk 程序运行出现的很多问题都<strong>集中</strong>在这个<strong>基础环境</strong>中，通过排查这些基本点，我们能够解决一部分问题，同时也能够为定位疑难问题清除一定的盲区。</p><p>这些排查点不能跳过，唯有当这些基础环境正常时我们才应该做进一步的排查。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/编译dpdk-19.10时遇到的问题">dpdk/编译dpdk-19.10时遇到的问题</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-20T23:48:14.000Z" itemprop="datePublished">2022年6月20日</time> · <!-- -->8 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="未安装-numa-库的问题">未安装 numa 库的问题<a class="hash-link" href="#未安装-numa-库的问题" title="标题的直接链接">​</a></h2><div class="language-make codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-make codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/home/longyu/dpdk-19.08/lib/librte_eal/linux/eal/eal_memory.c:32:10: fatal error: numa.h: No such file or directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> #include &lt;numa.h&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>官方网页中的相关说明内容如下：</p><blockquote><p>Library for handling NUMA (Non Uniform Memory Access).
numactl-devel in Red Hat/Fedora;
libnuma-dev in Debian/Ubuntu;</p></blockquote><p>我是在 Debian 系统中编译，需要安装 libnuma-dev 库，安装示例如下：</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08$ sudo apt-get install libnuma-dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="加载编译出的内核模块">加载编译出的内核模块<a class="hash-link" href="#加载编译出的内核模块" title="标题的直接链接">​</a></h2><p>加载 igb_uio 之前需要先加载 uio 内核模块。uio 模块一般都已经安装到了系统中的 /usr/lib/modules/$(uname -r)/ 目录中，只是一般没有被使用，这里可以通过 modprobe uio 直接加载此内核模块。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="编译-examples-目录下的-demo">编译 examples 目录下的 demo<a class="hash-link" href="#编译-examples-目录下的-demo" title="标题的直接链接">​</a></h2><ol><li><p>检查 RTE_SDK 与 RTE_TARGET 环境变量是否设定</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08/examples/helloworld$ echo -e  $RTE_SDK &quot;\n&quot; $RTE_TARGET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/longyu/dpdk-19.08 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> x86_64-native-linuxapp-gcc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>注意这里的 RTE_SDK 为 dpdk 源码的根目录，RTE_RARGET 为编译的目标设备全名。</strong></p></li><li><p>编译 examples 目录下的 helloworld demo</p><p>进入到 helloworld 子目录中，执行 make 命令，输出报错信息如下：</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08/examples/helloworld$ make </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/bin/sh: 1: pkg-config: not found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/longyu/dpdk-19.08/mk/internal/rte.extvars.mk:29: *** Cannot find .config in /home/longyu/dpdk-19.08/x86_64-native-linuxapp-gcc.  Stop.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08/examples/helloworld$ echo $RTE_SDK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/longyu/dpdk-19.08</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>解决 pkg-config not found 的问题</strong></p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 查看文件是否存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08/examples/helloworld$ sudo updatedb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08/examples/helloworld$ locate &#x27;pkg-config&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/dpkg/dpkg.cfg.d/pkg-config-hook-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/var/cache/apt/archives/pkg-config_0.29-6_amd64.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/var/lib/dpkg/info/pkg-config.list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 文件不存在则安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08/examples/helloworld$ sudo apt-get install pkg-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 存在则检查环境变量配置</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>解决找不到 .config 文件的问题</strong></p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08/examples/helloworld$ make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/longyu/dpdk-19.08/mk/internal/rte.extvars.mk:29: *** Cannot find .config in /home/longyu/dpdk-19.08/x86_64-native-linuxapp-gcc.  Stop.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果编译时有上面的错误，那么你需要检查编译出的目标与 RTE_TARGET 变量设定的是否一致。</p></li><li><p>编译成功的输出</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08/examples/helloworld$ make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CC main.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LD helloworld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  INSTALL-APP helloworld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  INSTALL-MAP helloworld.map</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08/examples/helloworld$ ls ./build/helloworld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./build/helloworld</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>执行 helloworld 时程序 panic </p><p>我在执行 helloworld 程序时遇到了如下错误：</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08/examples/helloworld$ sudo ./build/helloworld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Detected 2 lcore(s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Detected 1 NUMA nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Multi-process socket /var/run/dpdk/rte/mp_socket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Selected IOVA mode &#x27;PA&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: No free hugepages reported in hugepages-2048kB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: No available hugepages reported in hugepages-2048kB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: No available hugepages reported in hugepages-1048576kB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: FATAL: Cannot get hugepage information.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Cannot get hugepage information.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PANIC in main():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cannot init EAL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5: [./build/helloworld(_start+0x2a) [0x55d9e3802e3a]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4: [/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xeb) [0x7fa75466d09b]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3: [./build/helloworld(+0xa9e0c) [0x55d9e364ee0c]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2: [./build/helloworld(__rte_panic+0xba) [0x55d9e365f480]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1: [./build/helloworld(rte_dump_stack+0x1b) [0x55d9e38dfa7b]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Aborted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从上面的输出中我发现是 hugepage 相关的问题，浏览官方网页文档，我执行了下面的操作：</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08/examples/helloworld$ sudo su -c &#x27;echo 128 &gt; /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这之后我重新执行 helloworld 程序，得到的输出如下：</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08/examples/helloworld$ sudo ./build/helloworld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Detected 2 lcore(s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Detected 1 NUMA nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Multi-process socket /var/run/dpdk/rte/mp_socket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Selected IOVA mode &#x27;PA&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: No available hugepages reported in hugepages-1048576kB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Probing VFIO support...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: WARNING: cpu flags constant_tsc=yes nonstop_tsc=no -&gt; using unreliable clock cycles !</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: PCI device 0000:00:03.0 on NUMA socket -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL:   Invalid NUMA socket, default to 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL:   probe driver: 8086:100e net_e1000_em</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello from core 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello from core 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08/examples/helloworld$ </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>尽管执行了上面的操作之后，helloworld 能够正常执行，但是对于上述操作背后涉及的东西我却没有进一步的认识，这有待我对 dpdk 的进一步研究。 	</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="绑定网络端口到内核模块的问题">绑定网络端口到内核模块的问题<a class="hash-link" href="#绑定网络端口到内核模块的问题" title="标题的直接链接">​</a></h2><ol><li><p>lspci not found 的问题</p><p>绑定网络端口到内核模块时有如下报错信息：</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08$ sudo ./usertools/dpdk-devbind.py --bind=igb_uio ens33</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;lspci&#x27; not found - please install &#x27;pciutils&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>根据提示信息执行如下命令，安装 pciutils。</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08$ sudo apt-get install pciutils</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>接口正在使用导致绑定端口失败的问题</p><p>解决了 lspci 命令找不到的问题之后我重新执行绑定端口的命令，有如下输出：</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08$ sudo ./usertools/dpdk-devbind.py --bind=igb_uio ens3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: routing table indicates that interface 0000:00:03.0 is active. Not modifying</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从上面的输出中，我确定绑定端口失败了，我望文生义的抓住了 routing table 这个名词，觉得应该清除路由表的内容，在网上搜了一下没有发现该如何去做。这之后我想起了 TCP/IP 协议栈中对关闭网络设备的描述，记得在关闭网络设备的时候会清空路由表。基于这样的认识，我执行了如下命令 down 掉待使用的网络设备：</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08$ sudo ifconfig ens3 down</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 执行了这一步后我发现 ssh 连接异常了，这才让我意识到我就是通过这个网卡设备连接到虚拟机中的，关闭了设备之后网络断开，ssh 就失效了。</p><p>这个问题的解决方法如下：</p><blockquote><p>在虚拟机中添加两块网卡，一块用于正常的连接，一块用于测试。</p></blockquote></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="执行-testpmd-测试程序">执行 testpmd 测试程序<a class="hash-link" href="#执行-testpmd-测试程序" title="标题的直接链接">​</a></h2><p>指定如下参数，执行 testpmd 命令。</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-19.08/x86_64-native-linux-gcc/app$ sudo ./testpmd -l 0-1 -n 1 -- -i --portmask=0x1 --nb-cores=1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上参数需要根据执行的环境进行修改！</p><p>查看端口信息：</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">testpmd&gt; show port info 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">********************* Infos for port 0  *********************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MAC address: 52:54:00:CE:BA:AD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Device name: 0000:00:03.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Driver name: net_e1000_em</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connect to socket: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">memory allocation on the socket: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Link status: up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Link speed: 1000 Mbps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Link duplex: full-duplex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MTU: 1500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Promiscuous mode: enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Allmulticast mode: disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Maximum number of MAC addresses: 15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Maximum number of MAC addresses of hash filtering: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VLAN offload: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  strip off </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter off </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  qinq(extend) off </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No RSS offload flow type is supported.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Minimum size of RX buffer: 256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Maximum configurable length of RX packet: 16128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current number of RX queues: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Max possible RX queues: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Max possible number of RXDs per queue: 4096</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Min possible number of RXDs per queue: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RXDs number alignment: 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current number of TX queues: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Max possible TX queues: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Max possible number of TXDs per queue: 4096</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Min possible number of TXDs per queue: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TXDs number alignment: 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Max segment number per packet: 255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Max segment number per MTU/TSO: 255</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="标题的直接链接">​</a></h2><p><strong>编译 latest dpdk 的过程中会遇到很多的问题，一些问题是因为缺少必要的库与工具所致，一些问题是对某些功能的工作原理不清楚所致，最终这些问题得到了解决。在解决问题的过程中也体现出了我对 linux 中的一些基础知识有了陌生感，需要及时的复习复习。</strong></p><p><strong>下面是我对 dpdk 的一些认识：</strong></p><p><strong>dpdk 依赖 uio 内核模块来将网络设备映射到用户空间，通过重新绑定网络设备驱动到 pmd 来构建从用户空间操作网络设备的桥梁。这里的 pmd 全称为 polling mode driver，它来源于驱动设计模型中的轮询模型。</strong></p><p><strong>dpdk 使用 pmd 来拦截网络设备的硬件中断，这是轮询式数据处理的基础，也是 dpdk 所要解决的一大难题。</strong></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk-kni与ethtool试玩问题记录">dpdk/dpdk-kni与ethtool试玩问题记录</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-19T07:40:00.000Z" itemprop="datePublished">2022年6月19日</time> · <!-- -->4 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><p>ethtool  能够 dump 网卡的寄存器，查看其它网卡相关的信息。在 dpdk 程序出现异常时，常常需要使用 ethtool 获取网卡的一些信息来定位问题。</p><p>我最近也尝试用了用 ethtool，中间却遇到了很多问题。<strong>我使用的 dpdk 版本是 17.05。</strong></p><p><strong>第一类是编译相关的问题，第二类是 ethtool 自身支持网卡的问题。下面我就从这两方面的问题开始描述。</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用-ethtool-时的-config-配置">使用 ethtool 时的 .config 配置<a class="hash-link" href="#使用-ethtool-时的-config-配置" title="标题的直接链接">​</a></h2><p>dpdk 的官方文档中说明，要使用 ethtool 需要使能 KNI_KMOD_ETHTOOL 功能项。这通过修改 .config 配置文件来完成。修改完成之后重新编译即可，这个问题相对简单。</p><p>执行了 kni 程序之后，通过 ifconfig 可以看到多出了一个网卡，这个网卡就是之后我使用 ethtool 来查看的网卡硬件。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hugepage-内存不足导致-eal-初始化失败的问题">hugepage 内存不足导致 eal 初始化失败的问题<a class="hash-link" href="#hugepage-内存不足导致-eal-初始化失败的问题" title="标题的直接链接">​</a></h2><p>执行 ifconfig 命令看到多出来的网卡之后，我以为 ethtool 就能正常工作，结果它在启动的时候就报了错，错误信息表明 eal 初始化失败。</p><p>具体的报错信息表明没有足够的 hugepage 内存使用。</p><p>我猜是因为 kni 程序将所有的 hugepage 内存全部独占造成了这个问题，就修改了 /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages 文件，这之后 eal 初始化这一步没有报错，但是又出现了一个新的错误，错误内容如下：</p><blockquote><p>Cannot create lock on &#x27;/var/run/.rte_config&#x27;. Is another primary process running?</p></blockquote><p>在网上搜索了下这个问题，没有发现什么解决方案。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ethtool-不支持当前网卡">ethtool 不支持当前网卡<a class="hash-link" href="#ethtool-不支持当前网卡" title="标题的直接链接">​</a></h2><p>删除 /var/run/.rte_config 后重新运行 kni 程序，执行 ethtool 命令后，dmesg 查看系统信息发现了如下内容：</p><blockquote><p>Device not supported by ethtool</p></blockquote><p>这个信息表面上看来是说 ethtool 不支持我的网卡，但是我使用的是 e1000 的网卡呀，我想应该不至于不支持吧。</p><p>为了确认 ethtool 是否支持我的网卡，我使用 cscope 在源码中搜索 Device not supported by ethtool 这个字符串，发现它是在 kni_misc.c 中的 kni_ioctl_create 函数中打印的。这个函数中会用获取到的当前网卡信息查询两张表——ixgbe_pci_tbl 与 igb_pci_tbl。</p><p>这两张表的部分内容摘录如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">pci_device_id</span><span class="token plain"> ixgbe_pci_tbl</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token function" style="color:#d73a49">PCI_VDEVICE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">INTEL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IXGBE_DEV_ID_82598</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token function" style="color:#d73a49">PCI_VDEVICE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">INTEL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IXGBE_DEV_ID_82598AF_DUAL_PORT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token function" style="color:#d73a49">PCI_VDEVICE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">INTEL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IXGBE_DEV_ID_82598AF_SINGLE_PORT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token function" style="color:#d73a49">PCI_VDEVICE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">INTEL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IXGBE_DEV_ID_82598AT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* required last entry */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">pci_device_id</span><span class="token plain"> igb_pci_tbl</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">PCI_VDEVICE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">INTEL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_DEV_ID_I354_BACKPLANE_1GBPS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">PCI_VDEVICE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">INTEL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_DEV_ID_I354_SGMII</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">PCI_VDEVICE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">INTEL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_DEV_ID_I354_BACKPLANE_2_5GBPS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* required last entry */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我使用 lspci 命令查看我的网卡型号，得到的信息如下：</p><blockquote><p>e1000 82545EM</p></blockquote><p>这个型号在 dpdk 中对应的宏是 E1000_DEV_82545EM，并不存在于上面的两张表中，这表明 ethtool 确实不支持此款网卡。从第二张表中我发现 e1000 网卡是一个系列，其中有很多不同型号的网卡，这是我之前没有意识到的问题。</p><p>其实这是 dpdk 的 rte_kni 模块不支持这个网卡，官方驱动是支持的。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk-pdump工具编译运行">dpdk/dpdk-pdump工具编译运行</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-19T07:40:00.000Z" itemprop="datePublished">2022年6月19日</time> · <!-- -->5 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-pdump-是什么">dpdk-pdump 是什么<a class="hash-link" href="#dpdk-pdump-是什么" title="标题的直接链接">​</a></h2><p><strong>dpdk-pdump 是 dpdk 提供的一个工具。它可以可以作为 secondary 程序运行，能够捕获 dpdk 的端口的数据包。</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="编译-dpdk-pdump">编译 dpdk-pdump<a class="hash-link" href="#编译-dpdk-pdump" title="标题的直接链接">​</a></h2><p><strong>dpdk-pdump</strong> 工具的源码位于 dpdk 源码根目录下的 <strong>./app/pdump</strong> 目录中，不需要像 examples 中的 demo 一样单独编译，它会在编译 dpdk 的同时也被编译，我们可以在编译生成的 app 目录中找到这个程序。</p><p>在我的虚拟机中，编译 dpdk 后，它的位置如下：</p><blockquote><p>/home/longyu/dpdk-stable-17.05.2/x86_64-native-linuxapp-gcc/app/dpdk-pdump</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用-dpdk-pdump">使用 dpdk-pdump<a class="hash-link" href="#使用-dpdk-pdump" title="标题的直接链接">​</a></h2><p><strong>dpdk-pdump 的用法如下：</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">usage: ./dpdk-pdump </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">EAL options</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> -- --pdump </span><span class="token string" style="color:#e3116c">&#x27;(port=&lt;port id&gt; | device_id=&lt;pci id or vdev name&gt;),(queue=&lt;queue_id&gt;),(rx-dev=&lt;iface or pcap file&gt; | tx-dev=&lt;iface or pcap file&gt;,[ring-size=&lt;ring size&gt;default:16384],[mbuf-size=&lt;mbuf data size&gt;default:2176],[total-num-mbufs=&lt;number of mbufs&gt;default:65535]&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">--server-socket-path</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">server socket dir</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">default:/var/run/.dpdk/ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">or</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ~/.dpdk/</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">--client-socket-path</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">client socket dir</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">default:/var/run/.dpdk/ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">or</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ~/.dpdk/</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">``</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="display:inline-block;color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">**dpdk-pdump** 需要依赖一个 **dpdk primary** 进程，我就以 **l2fwd** 命令作为 **dpdk primary** 进程。</span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="display:inline-block;color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">有了 **dpdk primary** 进程之后，根据我的环境，我使用如下命令行启动 dpdk-pdump</span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa"></span><span class="token variable" style="color:#36acaa">`</span><span class="token plain">``bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> ./dpdk-pdump -n </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> -- --pdump </span><span class="token string" style="color:#e3116c">&#x27;port=0,queue=*,rx-dev=./rx-pcap&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="no-driver-for-pcap-的问题">no driver for pcap 的问题<a class="hash-link" href="#no-driver-for-pcap-的问题" title="标题的直接链接">​</a></h2><p>我第一次执行上面的命令时程序异常终止，错误信息如下：</p><blockquote><p>EAL: no driver found for eth_pcap_rx_0
EAL: Driver, cannot attach the device</p></blockquote><p>通过搜索，我发现上面的错误是因为在编译 dpdk 时没有启用 PCAP 相关的功能所致，参考链接如下：</p><p><a href="https://stackoverflow.com/questions/44357995/dpdk-pdump-no-driver-found-for-net-pcap-rx-0" target="_blank" rel="noopener noreferrer">dpdk-pdump-no-driver-found-for-net-pcap</a></p><p>根据网页中的回答我对 <strong>.config</strong> 文件做了如下修改以使能 <strong>PCAP</strong> 的相关功能：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-stable-17.05.2/x86_64-native-linuxapp-gcc$ </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;PCAP&#x27;</span><span class="token plain"> .config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Compile software PMD backed by PCAP files</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">CONFIG_RTE_LIBRTE_PMD_PCAP</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">CONFIG_RTE_PORT_PCAP</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">y</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这之后重新编译后继续测试，这个问题得到了解决，可又遇到了一个新的问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="无法与-primary-server-端通信的问题">无法与 primary server 端通信的问题<a class="hash-link" href="#无法与-primary-server-端通信的问题" title="标题的直接链接">​</a></h2><p>解决了 <strong>pcap driver</strong> 的问题后，我重新执行 <strong>dpdk-pdump</strong> 时新的报错信息如下：</p><blockquote><p>PDUMP: failed to send to server:No such file or directory,
pdump_create_client_socket:702 PDUMP: client request for pdump
enable/disable failed PDUMP: failed to send to server:No such file or
directory, pdump_create_client_socket:702 PDUMP: client request for
pdump enable/disable failed</p></blockquote><p>通过阅读官方网页中的说明，我发现了问题所在。官方的说明中提到 <strong>dpdk-pdump</strong> 工具只能与初始化了 <strong>packet capture framework</strong> 的主程序通信，而 <strong>packet capture framework</strong> 的初始化需要修改程序的源码。</p><p>在 dpdk 提供的工具中，<strong>testpmd</strong> 工具的源码中添加了 <strong>packet capture framework</strong> 的初始化代码，我查看相关代码，找到了如下源码行：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    diag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_eal_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">diag </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rte_panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Cannot init EAL\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">RTE_LIBRTE_PDUMP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* initialize packet capture framework */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">rte_pdump_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的代码会在 <strong>RTE_LIBRTE_PDUMP</strong> 宏定义时执行 <strong>rte_pdump_init</strong> 函数来进行必要的初始化，<strong>RTE_LIBRTE_PDUMP</strong> 功能在 <strong>.config</strong> 中进行配置，默认为开启。</p><p><strong>.config</strong> 中与 <strong>RTE_LIBRTE_PDUMP</strong> 功能相关的配置如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Compile architecture we compile for. pdump library</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">CONFIG_RTE_LIBRTE_PDUMP</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">y</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当使用能了这个参数后，编译目录下的头文件 <strong>rte_config.h</strong> 中会定义 <strong>RTE_LIBRTE_PDUMP</strong> 宏，相关的代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">undef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">RTE_LIBRTE_PDUMP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">RTE_LIBRTE_PDUMP</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我按照上面的描述修改了 dpdk-pdump 程序的源码后，终于能够正常执行了！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="查看-dump-出的数据包文件">查看 dump 出的数据包文件<a class="hash-link" href="#查看-dump-出的数据包文件" title="标题的直接链接">​</a></h2><p><strong>dpdk-pdump</strong> 中已经对 dump 出的原始数据包进行了转化，我们可以直接使用 <strong>tcpdump</strong> 的 <strong>-r</strong> 选项来查看生成的文件。</p><p> 我指定 <strong>dpdk-pdump dump</strong> 端口接收到的包，指定存储文件为 <strong>./rx-pcap</strong>。我只需要执行下面的命令就可以看到接收到的数据包的详细信息。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> tcpdump -r ./rx-pcap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="标题的直接链接">​</a></h2><p><strong>dpdk 提供的程序在使用时可能会遇到一些问题，解决这些问题的一般步骤如下：</strong></p><ol><li>查看依赖的功能是否开启（修改 .config 文件）</li><li>修改必要的源代码以执行必要的初始化工作</li><li>重新编译后再次执行</li></ol></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk-pdump编译运行">dpdk/dpdk-pdump编译运行</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-19T07:40:00.000Z" itemprop="datePublished">2022年6月19日</time> · <!-- -->5 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-pdump-是什么">dpdk-pdump 是什么<a class="hash-link" href="#dpdk-pdump-是什么" title="标题的直接链接">​</a></h2><p><strong>dpdk-pdump 是 dpdk 提供的一个工具。它可以可以作为 secondary 程序运行，能够捕获 dpdk 的端口的数据包。</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="编译-dpdk-pdump">编译 dpdk-pdump<a class="hash-link" href="#编译-dpdk-pdump" title="标题的直接链接">​</a></h2><p><strong>dpdk-pdump</strong> 工具的源码位于 dpdk 源码根目录下的 <strong>./app/pdump</strong> 目录中，不需要像 examples 中的 demo 一样单独编译，它会在编译 dpdk 的同时也被编译，我们可以在编译生成的 app 目录中找到这个程序。</p><p>在我的虚拟机中，编译 dpdk 后，它的位置如下：</p><blockquote><p>/home/longyu/dpdk-stable-17.05.2/x86_64-native-linuxapp-gcc/app/dpdk-pdump</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用-dpdk-pdump">使用 dpdk-pdump<a class="hash-link" href="#使用-dpdk-pdump" title="标题的直接链接">​</a></h2><p><strong>dpdk-pdump 的用法如下：</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">usage: ./dpdk-pdump </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">EAL options</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> -- --pdump </span><span class="token string" style="color:#e3116c">&#x27;(port=&lt;port id&gt; | device_id=&lt;pci id or vdev name&gt;),(queue=&lt;queue_id&gt;),(rx-dev=&lt;iface or pcap file&gt; | tx-dev=&lt;iface or pcap file&gt;,[ring-size=&lt;ring size&gt;default:16384],[mbuf-size=&lt;mbuf data size&gt;default:2176],[total-num-mbufs=&lt;number of mbufs&gt;default:65535]&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">--server-socket-path</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">server socket dir</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">default:/var/run/.dpdk/ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">or</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ~/.dpdk/</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">--client-socket-path</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">client socket dir</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">default:/var/run/.dpdk/ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">or</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ~/.dpdk/</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>dpdk-pdump</strong> 需要依赖一个 <strong>dpdk primary</strong> 进程，我就以 <strong>l2fwd</strong> 命令作为 <strong>dpdk primary</strong> 进程。</p><p>有了 <strong>dpdk primary</strong> 进程之后，根据我的环境，我使用如下命令行启动 dpdk-pdump</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> ./dpdk-pdump -n </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> -- --pdump </span><span class="token string" style="color:#e3116c">&#x27;port=0,queue=*,rx-dev=./rx-pcap&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="no-driver-for-pcap-的问题">no driver for pcap 的问题<a class="hash-link" href="#no-driver-for-pcap-的问题" title="标题的直接链接">​</a></h2><p>我第一次执行上面的命令时程序异常终止，错误信息如下：</p><blockquote><p>EAL: no driver found for eth_pcap_rx_0
EAL: Driver, cannot attach the device</p></blockquote><p>通过搜索，我发现上面的错误是因为在编译 dpdk 时没有启用 PCAP 相关的功能所致，参考链接如下：</p><p><a href="https://stackoverflow.com/questions/44357995/dpdk-pdump-no-driver-found-for-net-pcap-rx-0" target="_blank" rel="noopener noreferrer">dpdk-pdump-no-driver-found-for-net-pcap</a></p><p>根据网页中的回答我对 <strong>.config</strong> 文件做了如下修改以使能 <strong>PCAP</strong> 的相关功能：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longyu@longyu-pc:~/dpdk-stable-17.05.2/x86_64-native-linuxapp-gcc$ </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;PCAP&#x27;</span><span class="token plain"> .config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Compile software PMD backed by PCAP files</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">CONFIG_RTE_LIBRTE_PMD_PCAP</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">CONFIG_RTE_PORT_PCAP</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">y</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这之后重新编译后继续测试，这个问题得到了解决，可又遇到了一个新的问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="无法与-primary-server-端通信的问题">无法与 primary server 端通信的问题<a class="hash-link" href="#无法与-primary-server-端通信的问题" title="标题的直接链接">​</a></h2><p>解决了 <strong>pcap driver</strong> 的问题后，我重新执行 <strong>dpdk-pdump</strong> 时新的报错信息如下：</p><blockquote><p>PDUMP: failed to send to server:No such file or directory,
pdump_create_client_socket:702 PDUMP: client request for pdump
enable/disable failed PDUMP: failed to send to server:No such file or
directory, pdump_create_client_socket:702 PDUMP: client request for
pdump enable/disable failed</p></blockquote><p>通过阅读官方网页中的说明，我发现了问题所在。官方的说明中提到 <strong>dpdk-pdump</strong> 工具只能与初始化了 <strong>packet capture framework</strong> 的主程序通信，而 <strong>packet capture framework</strong> 的初始化需要修改程序的源码。</p><p>在 dpdk 提供的工具中，<strong>testpmd</strong> 工具的源码中添加了 <strong>packet capture framework</strong> 的初始化代码，我查看相关代码，找到了如下源码行：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    diag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_eal_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">diag </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rte_panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Cannot init EAL\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">RTE_LIBRTE_PDUMP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* initialize packet capture framework */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">rte_pdump_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的代码会在 <strong>RTE_LIBRTE_PDUMP</strong> 宏定义时执行 <strong>rte_pdump_init</strong> 函数来进行必要的初始化，<strong>RTE_LIBRTE_PDUMP</strong> 功能在 <strong>.config</strong> 中进行配置，默认为开启。</p><p><strong>.config</strong> 中与 <strong>RTE_LIBRTE_PDUMP</strong> 功能相关的配置如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Compile architecture we compile for. pdump library</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">CONFIG_RTE_LIBRTE_PDUMP</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">y</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当使用能了这个参数后，编译目录下的头文件 <strong>rte_config.h</strong> 中会定义 <strong>RTE_LIBRTE_PDUMP</strong> 宏，相关的代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">undef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">RTE_LIBRTE_PDUMP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">RTE_LIBRTE_PDUMP</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我按照上面的描述修改了 dpdk-pdump 程序的源码后，终于能够正常执行了！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="查看-dump-出的数据包文件">查看 dump 出的数据包文件<a class="hash-link" href="#查看-dump-出的数据包文件" title="标题的直接链接">​</a></h2><p><strong>dpdk-pdump</strong> 中已经对 dump 出的原始数据包进行了转化，我们可以直接使用 <strong>tcpdump</strong> 的 <strong>-r</strong> 选项来查看生成的文件。</p><p> 我指定 <strong>dpdk-pdump dump</strong> 端口接收到的包，指定存储文件为 <strong>./rx-pcap</strong>。我只需要执行下面的命令就可以看到接收到的数据包的详细信息。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> tcpdump -r ./rx-pcap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="标题的直接链接">​</a></h2><p><strong>dpdk 提供的程序在使用时可能会遇到一些问题，解决这些问题的一般步骤如下：</strong></p><ol><li>查看依赖的功能是否开启（修改 .config 文件）</li><li>修改必要的源代码以执行必要的初始化工作</li><li>重新编译后再次执行</li></ol></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk库源码中包含内核头文件的问题">dpdk/dpdk库源码中包含内核头文件的问题</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-19T07:40:00.000Z" itemprop="datePublished">2022年6月19日</time> · <!-- -->5 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题描述">问题描述<a class="hash-link" href="#问题描述" title="标题的直接链接">​</a></h2><ol><li>在 A 环境上与 B 环境上使用相同版本的 gcc 编译 dpdk 程序</li><li>测试发现 A 环境上编译的版本能够正常工作，B 环境上编译的版本不能工作</li></ol><p>调试确认，<strong>A 环境上编译的 dpdk 程序初始化了 vfio 的 tailq，而 B 环境上编译的 dpdk 程序没有初始化 vfio 的 tailq。</strong></p><p>dpdk 版本信息：<strong>dpdk-16.04</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="从源码着手分析">从源码着手分析<a class="hash-link" href="#从源码着手分析" title="标题的直接链接">​</a></h2><p>vfio 的 tailq 在 eal_pci_vfio.c 中通过 <strong>EAL_REGISTER_TAILQ</strong> 来注册，代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">VFIO_PRESENT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">PAGE_SIZE</span><span class="token macro property" style="color:#36acaa">   </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression function" style="color:#d73a49">sysconf</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_SC_PAGESIZE</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">PAGE_MASK</span><span class="token macro property" style="color:#36acaa">   </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression operator" style="color:#393A34">~</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">PAGE_SIZE </span><span class="token macro property expression operator" style="color:#393A34">-</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_tailq_elem</span><span class="token plain"> rte_vfio_tailq </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;VFIO_RESOURCE_LIST&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">EAL_REGISTER_TAILQ</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rte_vfio_tailq</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述代码说明，<strong>只有定义了 VFIO_PRESENT 宏才会注册 vfio 的 tailq!</strong> 重新描述问题：</p><p><strong>A 环境上编译时 VFIO_PRESENT 宏被定义，B 环境上编译时 VFIO_PRESENT 宏没有被定义。</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="提问环节">提问环节<a class="hash-link" href="#提问环节" title="标题的直接链接">​</a></h2><ol><li>再次确认编译器是否一致
确认一致</li><li>确认编译的 dpdk 代码一致
确认一致</li><li>VFIO_PRESENT 在哪里被定义的？</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="对提问的回答">对提问的回答<a class="hash-link" href="#对提问的回答" title="标题的直接链接">​</a></h2><p>搜索确定 <strong>VFIO_PRESENT</strong> 在 <strong>eal_vfio.h</strong> 中被定义，代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">RTE_EAL_VFIO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;linux/version.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">if</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">LINUX_VERSION_CODE </span><span class="token macro property expression operator" style="color:#393A34">&gt;=</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">KERNEL_VERSION</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">3</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">6</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;linux/vfio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">VFIO_PRESENT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property comment" style="color:#999988;font-style:italic">/* kernel version */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property comment" style="color:#999988;font-style:italic">/* RTE_EAL_VFIO */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>根据代码内容，VFIO_PRESENT 要被定义需要满足如下条件：</p><ol><li>config 中配置 CONFIG_RTE_EAL_VFIO 为 y</li><li>内核版本大于等于 3.6.0</li></ol><p>检查环境得到如下信息：</p><ol><li>config 中使用了 RTE_EAL_VFIO 配置</li><li>RTE_KERNELDIR 指向的内核 kernel_devel 版本一致</li></ol><p>确认了这两点信息后，得出<strong>不应该存在问题的</strong>结论。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="linuxversionh-是哪个-linuxversionh">linux/version.h 是哪个 linux/version.h?<a class="hash-link" href="#linuxversionh-是哪个-linuxversionh" title="标题的直接链接">​</a></h2><p>一通研究发现 eal_vfio.h 中包含的 linux/version.h <strong>并不是从 RTE_KERNELDIR 变量指定的路径下搜索的！</strong></p><p>总结两点问题：</p><ol><li>编译内核 ko 的源文件时 linux/version.h 从指定的内核路径下面搜索 </li><li>编译库函数时包含的 linux/version.h 头文件是<strong>从编译环境上的 /usr/include 目录搜索</strong></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="真正的问题是啥">真正的问题是啥？<a class="hash-link" href="#真正的问题是啥" title="标题的直接链接">​</a></h2><p>绕了一圈后，我确认真正的问题是不同编译机器上的 <strong>/usr/include/linux/version.h</strong> 文件不同，<strong>A 机器上 version.h 中定义的版本高于 3.6.0，B 机器上 version.h 中定义的版本低于 3.6.0</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="库函数中包含内核头文件的坏处">库函数中包含内核头文件的坏处<a class="hash-link" href="#库函数中包含内核头文件的坏处" title="标题的直接链接">​</a></h2><p>编译库函数时，库函数中包含的内核头文件会从编译环境上的 /usr/include 目录中搜索，不同的编译环境上内核头文件版本不同就是潜在的风险。</p><p><strong>更具体点说其实是将库函数与内核头文件耦合了，随之而来的是与编译环境的耦合</strong>。库函数中包含内核头文件是有需求的，如 ip 命令就依赖内核的 netlink 相关头文件，不过它本地维护了一个特定的 netlink 头文件版本，就消除了与编译环境中部署的内核头文件的耦合性。</p><p>从 eal_vfio.h 的需求来分析，它实现了不支持 3.6.0 以下内核版本的需求，而这个内核版本是 <strong>dpdk 程序运行环境的内核版本</strong>，<strong>并不要求与编译环境内核版本一致</strong>，最好的方法是使用 RTE_KERNELDIR 变量路径中的 linux/version.h 头文件，可也有些不好的地方，如何取舍不易决定！</p></div></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/longyu.github.io/blog/page/5"><div class="pagination-nav__label">较新的博文</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/longyu.github.io/blog/page/7"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="footer__link-item">longyuwlz<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/longyu.github.io/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 龙瑜的文字世界, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/longyu.github.io/assets/js/runtime~main.9bcca1a9.js"></script>
<script src="/longyu.github.io/assets/js/main.4339af60.js"></script>
</body>
</html>