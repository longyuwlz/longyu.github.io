<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/longyu.github.io/blog/rss.xml" title="龙瑜的文字世界 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/longyu.github.io/blog/atom.xml" title="龙瑜的文字世界 Atom Feed"><title data-rh="true">龙瑜的博客 | 龙瑜的文字世界</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://longyuwlz.github.io/longyu.github.io/blog"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="龙瑜的博客 | 龙瑜的文字世界"><meta data-rh="true" name="description" content="美好的时光在文字中停滞不前"><meta data-rh="true" property="og:description" content="美好的时光在文字中停滞不前"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="canonical" href="https://longyuwlz.github.io/longyu.github.io/blog"><link data-rh="true" rel="alternate" href="https://longyuwlz.github.io/longyu.github.io/blog" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://longyuwlz.github.io/longyu.github.io/blog" hreflang="x-default"><link rel="stylesheet" href="/longyu.github.io/assets/css/styles.f233e9eb.css">
<link rel="preload" href="/longyu.github.io/assets/js/runtime~main.9bcca1a9.js" as="script">
<link rel="preload" href="/longyu.github.io/assets/js/main.4339af60.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/longyu.github.io/"><div class="navbar__logo"><img src="/longyu.github.io/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/longyu.github.io/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">龙瑜的文字世界</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/longyu.github.io/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">历史发布</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/Failed to mmap 2MB hugepages 与 max_map_count limit">dpdk/Failed to mmap 2MB hugepages 与 max_map_count limit</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/I210 网卡设定 force link mode 并关闭 EEE mode">dpdk/I210 网卡设定 force link mode 并关闭 EEE mode</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/Unsupported SFP+ Module">dpdk/Unsupported SFP+ Module</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk ebpf 库跨版本移植">dpdk ebpf 库跨版本移植</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk mempool cache 机制分析">dpdk/dpdk mempool cache 机制分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 不同版本下载地址">dpdk/dpdk 不同版本下载地址</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 多进程模型共享队列收发包 virtio 网卡段错误问题">dpdk 多进程模型</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 官方 bugzilla 导出信息">dpdk/dpdk 官方 bugzilla 导出信息</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 对 numa 的使用与多 numa 架构下性能调优的基础">dpdk/dpdk 对 numa 的使用与多 numa 架构下性能调优的基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 收发包函数分析：dpdk-20.11 ice sse 向量收发包函数关键过程分析">收发包向量函数实现分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 死锁问题后续之初始化假设不可迁移问题">dpdk/dpdk 死锁问题后续之初始化假设不可迁移问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 用户态驱动框架及其演进过程分析">dpdk 用户态驱动框架及其部分演进过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序性能问题排查的一般流程">dpdk/dpdk 程序性能问题排查的一般流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序接口 down、up 问题定位的一般流程">接口 up、down 失败问题排查</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序收发包问题排查的一般流程">dpdk 程序收发包问题排查</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序绑不同的核性能有明显差异问题分析">dpdk/dpdk 程序绑不同的核性能有明显差异问题分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序绑核失败问题：EAL: pthread_setaffinity_np failed">问题描述</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 问题分析：不兼容光模块导致 dpdk 程序运行失败问题定位">dpdk/dpdk 问题分析：不兼容光模块导致 dpdk 程序运行失败问题定位</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 驱动移植叩开 kni 模块那些黑暗的角落">dpdk/dpdk 驱动移植叩开 kni 模块那些黑暗的角落</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 eal lcore 多线程机制分析">dpdk 多线程流水线</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 eal 初始化 log 信息解析">dpdk/dpdk-16.04 eal 初始化 log 信息解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 igb crc length 统计问题">dpdk/dpdk-16.04 igb crc length 统计问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 igb_uio 模块分析">dpdk/dpdk-16.04 igb_uio 模块分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 l2fwd 源码分析">dpdk/dpdk-16.04 l2fwd 源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 rte_kni 模块与内核内存泄露问题">问题描述</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 rte_kni 模块分析">dpdk/dpdk-16.04 rte_kni 模块分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 rte_spinlock.h rte_cpu_get_flag_enabled 接口问题">dpdk/dpdk-16.04 rte_spinlock.h rte_cpu_get_flag_enabled 接口问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 扩展新网卡驱动过程">编译相关配置添加</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 根目录中 .git 目录对编译参数的影响">dpdk/dpdk-16.04 根目录中 .git 目录对编译参数的影响</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 监听 uio 文件检测中断的示例 demo 与内部实现解析">dpdk/dpdk-16.04 监听 uio 文件检测中断的示例 demo 与内部实现解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 虚拟化环境 virtio 网卡 secondary 进程段错误问题分析定位">dpdk/dpdk-16.04 虚拟化环境 virtio 网卡 secondary 进程段错误问题分析定位</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 解初始化过程">dpdk/dpdk-16.04 解初始化过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-16.04 配置与编译过程分析">dpdk/dpdk-16.04 配置与编译过程分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-19.11 armv8 l2fwd 在某 arm 内核上无法运行问题">dpdk/dpdk-19.11 armv8 l2fwd 在某 arm 内核上无法运行问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-19.11 支持接口配置速率双工的方法">前言</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk程序启动顺序引发的血案">dpdk/dpdk程序启动顺序引发的血案</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/ethtool 命令指定的网络设备名在哪里被使用？">dpdk/ethtool 命令指定的网络设备名在哪里被使用？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/gcc constructor 属性修饰的构造函数未被链接问题">dpdk/gcc constructor 属性修饰的构造函数未被链接问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/igb_uio.ko 的 md5sum 为啥又变化了？">dpdk/igb_uio.ko 的 md5sum 为啥又变化了？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/l2fwd 支持 x710 通过 fdir 过滤非分片 ipv4 udp 报文">dpdk/l2fwd 支持 x710 通过 fdir 过滤非分片 ipv4 udp 报文</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/x710 hash 分片与非分片 tcp 报文异常问题">dpdk/x710 hash 分片与非分片 tcp 报文异常问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/不懂 dpdk mbuf 结构？此篇文章带你超神">dpdk 中 mbuf 的结构</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/以 ixgbe pmd 驱动为例研究 dpdk pmd 驱动中注册中断回调函数并使能中断的过程">dpdk/以 ixgbe pmd 驱动为例研究 dpdk pmd 驱动中注册中断回调函数并使能中断的过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/以 rte_mempool_ops_table 为例描述 dpdk 程序库链接顺序对程序执行的影响">dpdk mempool_ops</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/使用内核驱动上手 x710 flow directory 功能">环境介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/关闭 stdout 引发的灾难">dpdk/关闭 stdout 引发的灾难</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/杀掉数通引擎导致虚拟机重启问题定位">dpdk/杀掉数通引擎导致虚拟机重启问题定位</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/网卡接口绑定驱动及其使用的 bind、unbind、new_id 等 sys 文件">dpdk/网卡接口绑定驱动及其使用的 bind、unbind、new_id 等 sys 文件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/试玩 dpdk ebfp 功能">dpdk/试玩 dpdk ebfp 功能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk kni 口 ifconfig up down 的执行流程">dpdk/dpdk kni 口 ifconfig up down 的执行流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 中 rte_config.h 配置文件生成的问题">dpdk/dpdk 中 rte_config.h 配置文件生成的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 中 rte_eth_link_get_wait、nowait 函数研究">dpdk/dpdk 中 rte_eth_link_get_wait、nowait 函数研究</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 常见问题：uio 设备文件创建以及 iommu 导致 x710 网卡初始化失败问题">uio 设备文件创建的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 程序创建 kni 虚拟网络接口失败的问题">dpdk/dpdk 程序创建 kni 虚拟网络接口失败的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk 问题排查的第一关：基础环境的排查">dpdk/dpdk 问题排查的第一关：基础环境的排查</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/编译dpdk-19.10时遇到的问题">dpdk/编译dpdk-19.10时遇到的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-kni与ethtool试玩问题记录">dpdk/dpdk-kni与ethtool试玩问题记录</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-pdump工具编译运行">dpdk/dpdk-pdump工具编译运行</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk-pdump编译运行">dpdk/dpdk-pdump编译运行</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk库源码中包含内核头文件的问题">dpdk/dpdk库源码中包含内核头文件的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/dpdk收发包测试之使用内核接口给dpdk绑定的端口发包">dpdk/dpdk收发包测试之使用内核接口给dpdk绑定的端口发包</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/ethtool 读到的状态与 dpdk 读到的网卡状态不一致">dpdk/ethtool 读到的状态与 dpdk 读到的网卡状态不一致</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/将网卡绑定到官方驱动测试过程">dpdk/将网卡绑定到官方驱动测试过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/记录一次编译器版本过低导致 dpdk 无法成功编译的问题">dpdk/记录一次编译器版本过低导致 dpdk 无法成功编译的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/dpdk/设置 EXTRA_CFLAGS 以编译 debug 版本 dpdk 库">dpdk/设置 EXTRA_CFLAGS 以编译 debug 版本 dpdk 库</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/libc/使用mtrace跟踪内存泄露问题">libc/使用mtrace跟踪内存泄露问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/linux-kernel/linux-内核模块中引用符号是如何链接的">linux-kernel/linux-内核模块中引用符号是如何链接的</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/longyu.github.io/blog/2022/06/12/序言">写博客的意义</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/Failed to mmap 2MB hugepages 与 max_map_count limit">dpdk/Failed to mmap 2MB hugepages 与 max_map_count limit</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->6 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题描述">问题描述<a class="hash-link" href="#问题描述" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="设备内存信息">设备内存信息<a class="hash-link" href="#设备内存信息" title="标题的直接链接">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># free -h</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              total        used        </span><span class="token function" style="color:#d73a49">free</span><span class="token plain">      shared  buff/cache   available</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Mem:            15G        </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">.1G        </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">.0G         22M        512M        </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">.4G</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Swap:            0B          0B          0B</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="l2fwd-运行报错信息">l2fwd 运行报错信息<a class="hash-link" href="#l2fwd-运行报错信息" title="标题的直接链接">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ./l2fwd  -m 64 -- -p0x1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dpdk revision </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">41333</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Detected lcore </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> as core </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> on socket </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Detected lcore </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> as core </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> on socket </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Detected lcore </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> as core </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> on socket </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Detected lcore </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> as core </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> on socket </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Support maximum </span><span class="token number" style="color:#36acaa">128</span><span class="token plain"> logical core</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> by configuration.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Detected </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> lcore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Probing VFIO support</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Module /sys/module/vfio_pci not found</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> error </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">No such </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> or directory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: VFIO modules not loaded, skipping VFIO support</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Setting up child physically contiguous memory</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: map_all_hugepages</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">: mmap failed: Cannot allocate memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Failed to mmap </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> MB hugepages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PANIC </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> rte_eal_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cannot init memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Aborted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>关键信息如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">EAL: map_all_hugepages(): mmap failed: Cannot allocate memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Failed to mmap 2 MB hugepages</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从输出信息看问题是 mmap 映射大页的时候失败了，看不出其它问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="strace-跟踪扩大问题输入">strace 跟踪扩大问题输入<a class="hash-link" href="#strace-跟踪扩大问题输入" title="标题的直接链接">​</a></h2><p>strace 跟踪确认问题如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/dev/hugepages/rtemap_3061&quot;</span><span class="token plain">, O_RDWR</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">O_CREAT, 0755</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">0x17ea00000, </span><span class="token number" style="color:#36acaa">2097152</span><span class="token plain">, PROT_READ</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">PROT_WRITE, MAP_SHARED</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">MAP_POPULATE, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> -1 ENOMEM </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Cannot allocate memory</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 mmap 第 3061 个 hugepage 的时候报错，根本问题是 mmap 映射失败，出错 mmap 系统调用的返回值是 ENOMEM。</p><p>man mmap 找到下面这些与 ENOMEM 相关的信息：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       ENOMEM No memory is available.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ENOMEM The  process</span><span class="token string" style="color:#e3116c">&#x27;s  maximum  number  of mappings would have been exceeded.  This error can also occur for munmap(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">              when unmapping a region in the middle of an existing mapping, since this results in two smaller mappings on ei‐</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">              ther side of the region being unmapped.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">       ENOMEM (since Linux 4.7) The process&#x27;</span><span class="token plain">s RLIMIT_DATA limit, described </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> getrlimit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, would have been exceeded.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的信息描述了如下三种不同的问题：</p><ol><li>没有可用内存</li><li>超过了进程的最大映射数目</li><li>超过了进程的 RLIMIT_DATA 限制</li></ol><p>ulimit 查看获取到如下信息：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ulimit -a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">core </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> size          </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blocks, -c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data seg size           </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kbytes, -d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> unlimited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scheduling priority             </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">-e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> size               </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blocks, -f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> unlimited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pending signals                 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">-i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">63812</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">max locked memory       </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kbytes, -l</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">max memory size         </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kbytes, -m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> unlimited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">open</span><span class="token plain"> files                      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">-n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1024</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pipe size            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">512</span><span class="token plain"> bytes, -p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POSIX message queues     </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bytes, -q</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">819200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">real-time priority              </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">-r</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stack size              </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kbytes, -s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8192</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpu </span><span class="token function" style="color:#d73a49">time</span><span class="token plain">               </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seconds, -t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> unlimited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">max user processes              </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">-u</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">63812</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">virtual memory          </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kbytes, -v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> unlimited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> locks                      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">-x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> unlimited</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>确认 ulimit 没有相关的限制设定内容。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="vmmax_map_count-设定">vm.max_map_count 设定<a class="hash-link" href="#vmmax_map_count-设定" title="标题的直接链接">​</a></h2><p>经过大佬提醒，这个问题可能与 vm.max_map_count 设定有关，查看系统中的设定内容如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># sysctl -a | grep vm.max_map_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm.max_map_count = 3096</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行如下命令增加 max_map_count 值后重试，问题得到解决。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">65535</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /proc/sys/vm/max_map_count</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里的问题实际上与 man mmap 得到的信息中对 ENOMEM 的第二种解释符合，只不过 manual 中没有直接指出 max_map_count 的限定。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="vmmax_map_count-是干嘛的">vm.max_map_count 是干嘛的？<a class="hash-link" href="#vmmax_map_count-是干嘛的" title="标题的直接链接">​</a></h2><p>从内核 Documentation 目录中 sysctl/vm.txt 文件中找到了下面这些描述信息：</p><div class="language-man codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-man codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">max_map_count:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This file contains the maximum number of memory map areas a process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">may have. Memory map areas are used as a side-effect of calling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">malloc, directly by mmap and mprotect, and also when loading shared</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libraries.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">While most applications need less than a thousand maps, certain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">programs, particularly malloc debuggers, may consume lots of them,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e.g., up to one or two maps per allocation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The default value is 65536.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个 max_map_count 是用来限定进程内存 map 区域的最大数量，每次 mmap 成功内部的 map_count 都会加 1，当内部 mmap_count 大于 sysctl 设定的 max_count 数目时 mmap 会返回 -ENOMEM。</p><p>mmap 流程中相关代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* Too many mappings? */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mm</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">map_count </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> sysctl_max_map_count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ENOMEM</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>同时 munmap 的时候会将内部的 map_count 减 1，而要改变这个数量，可以通过 sysctl 来重新设定，也可以通过写入 /proc/sys/vm/max_map_count 文件来完成，需要注意的是这个限定是全局的，会影响所有的进程。</p><p>如果需要永久生效，可以将配置写入到 /etc/sysctl.conf 文件中。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-1604--m-参数的原理">dpdk-16.04 -m 参数的原理<a class="hash-link" href="#dpdk-1604--m-参数的原理" title="标题的直接链接">​</a></h2><p>在这个问题中，l2fwd 命令运行参数如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./l2fwd  -m </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> -- -p0x1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>指定了 -m 参数限定映射的大页空间为 64M，按照一般的思路不应该出这种问题，但其实如果进一步研究 16.04 hugepage 映射的过程，能够发现如下信息：</p><p>dpdk-16.04 会在程序初始化的时候 map 所有的大页，这个行为没有参数来控制。-m 参数实际在映射所有大页的行为之后处理，通过解除超过数量的映射来实现。</p><p>这个实现是不合理的，听说高版本已经解决了这个问题，需要研究一下。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/I210 网卡设定 force link mode 并关闭 EEE mode">dpdk/I210 网卡设定 force link mode 并关闭 EEE mode</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->4 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a class="hash-link" href="#前言" title="标题的直接链接">​</a></h2><p>在定位 I210 网卡接口震荡问题的时候，阅读手册发现网卡支持设定 force mode，理解为可以将网卡设定为强制 up 状态，同时怀疑 eee 节能模式导致网卡休眠从而发生接口 down 的问题，于是需要设定 force mode 为 up 的时候同时关闭 eee 节能模式，需要修改 dpdk-16.04 中的部分代码来进行测试。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="i210-手册中的相关内容">I210 手册中的相关内容<a class="hash-link" href="#i210-手册中的相关内容" title="标题的直接链接">​</a></h2><p>I210 手册 P107 页描述了设定 force mode 需要设定的寄存器内容信息摘录如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> Move to Force mode by setting the following bits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">— CTRL.FD (CSR 0x0 bit 0) = 1b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">— CTRL.SLU (CSR 0x0 bit 6) = 1b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">— CTRL.RFCE (CSR 0x0 bit 27) = 0b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">— CTRL.TFCE (CSR 0x0 bit 28) = 0b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">— PCS_LCTL.FORCE_LINK (CSR 0X4208 bit 5) = 1b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">— PCS_LCTL.FSD (CSR 0x4208 bit 4) = 1b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">— PCS_LCTL.FDV (CSR 0x4208 bit 3) = 1b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">— PCS_LCTL.FLV (CSR 0x4208 bit 0) = 1b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">— PCS_LCTL.AN_ENABLE (CSR 0x4208 bit 16) = 0b</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>dpdk-16.04 中 pmd 与 kni 内核驱动同时使用，需要确定设定真实生效，这一点通过查看寄存器内容来确认。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="igb-pmd-驱动-igb_ethdevc-的修改">igb pmd 驱动 igb_ethdev.c 的修改<a class="hash-link" href="#igb-pmd-驱动-igb_ethdevc-的修改" title="标题的直接链接">​</a></h2><p>通过修改初始化逻辑来完成，patch 如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> drivers</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">net</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">e1000</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">igb_ethdev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> drivers</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">net</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">e1000</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">igb_ethdev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">++</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> drivers</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">net</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">e1000</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">igb_ethdev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1390</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1390</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">28</span><span class="token plain"> @@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">e1000_setup_link</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    </span><span class="token class-name">uint32_t</span><span class="token plain"> ipcnfg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eeer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    ipcnfg </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">E1000_IPCNFG_EEE_1G_AN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> E1000_IPCNFG_EEE_100M_AN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    eeer </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">E1000_EEER_TX_LPI_EN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> E1000_EEER_RX_LPI_EN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">                  E1000_EEER_LPI_FC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    </span><span class="token function" style="color:#d73a49">E1000_WRITE_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_IPCNFG</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ipcnfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    </span><span class="token function" style="color:#d73a49">E1000_WRITE_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_EEER</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eeer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    </span><span class="token class-name">uint32_t</span><span class="token plain"> pcs_lctl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    pcs_lctl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">E1000_READ_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_PCS_LCTL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;current PCS_LCTL is %u\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pcs_lctl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* disable AN_ENABLE */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    pcs_lctl </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">E1000_PCS_LCTL_AN_ENABLE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* enable FORCE_LINK and  FORCE_LINK_UP */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    pcs_lctl </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> E1000_PCS_LCTL_FORCE_LINK </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> E1000_PCS_LCTL_FLV_LINK_UP </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> E1000_PCS_LCTL_FSD</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    </span><span class="token function" style="color:#d73a49">E1000_WRITE_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_PCS_LCTL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pcs_lctl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">     </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;after changed PCS_LCTL is %u\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">E1000_READ_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_PCS_LCTL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">rte_intr_allow_others</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">intr_handle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">/* check if lsc interrupt is enabled */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev_conf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intr_conf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lsc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kni-驱动-e1000_82575c-代码的修改">kni 驱动 e1000_82575.c 代码的修改<a class="hash-link" href="#kni-驱动-e1000_82575c-代码的修改" title="标题的直接链接">​</a></h2><p>同样通过修改初始化代码来完成，patch 如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">linuxapp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kni</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ethtool</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">igb</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">e1000_82575</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">linuxapp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kni</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ethtool</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">igb</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">e1000_82575</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">++</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">linuxapp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kni</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ethtool</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">igb</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">e1000_82575</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2802</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">2802</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> @@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ipcnfg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">E1000_READ_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_IPCNFG</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eeer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">E1000_READ_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_EEER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">#</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* enable or disable per user setting */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev_spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_82575</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eee_disable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                u32 eee_su </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">E1000_READ_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_EEE_SU</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2818</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">2819</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">17</span><span class="token plain"> @@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                eeer </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">E1000_EEER_TX_LPI_EN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> E1000_EEER_RX_LPI_EN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          E1000_EEER_LPI_FC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    　　ipcnfg </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">E1000_IPCNFG_EEE_1G_AN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> E1000_IPCNFG_EEE_100M_AN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    　　eeer </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">E1000_EEER_TX_LPI_EN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> E1000_EEER_RX_LPI_EN </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">                   E1000_EEER_LPI_FC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">E1000_WRITE_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_IPCNFG</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ipcnfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">E1000_WRITE_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_EEER</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eeer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">       </span><span class="token function" style="color:#d73a49">E1000_READ_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_IPCNFG</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">       </span><span class="token function" style="color:#d73a49">E1000_READ_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_EEER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    </span><span class="token function" style="color:#d73a49">printk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;after set ipcnfg is %x, eeer is %x\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">E1000_READ_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_IPCNFG</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">E1000_READ_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_EEER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>测试发现 kni 中默认是开启 eee 模式的，注释掉了开启 eee 模式的代码，并清除相关寄存器的设定，重新设定后使用 printk 打印寄存器内容，确定修改生效。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="igb_ethtoolc-的修改">igb_ethtool.c 的修改<a class="hash-link" href="#igb_ethtoolc-的修改" title="标题的直接链接">​</a></h2><p>为了在程序执行后进一步确认 force link mode 设定成功，且 EEE mode 正常关闭，在 igb 网卡获取寄存器的函数中添加打印，打印出 ipcnfg 与 eeer 寄存器的内容。</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">linuxapp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kni</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ethtool</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">igb</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">igb_ethtool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">linuxapp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kni</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ethtool</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">igb</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">igb_ethtool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">++</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">librte_eal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">linuxapp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kni</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ethtool</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">igb</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">igb_ethtool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">495</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">495</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> @@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IGB_REGS_LEN </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        regs</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">revision_id </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> hw</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">device_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">       </span><span class="token function" style="color:#d73a49">printk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ipcnfg is %x, eeer is %x\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">E1000_READ_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_IPCNFG</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">E1000_READ_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_EEER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* General Registers */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        regs_buff</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">E1000_READ_REG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E1000_CTRL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>程序运行后，通过执行 ethtool -d 查看 <strong>PCS_LCTL 寄存器与 dmesg 的输出来确认设置生效</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="测试结果">测试结果<a class="hash-link" href="#测试结果" title="标题的直接链接">​</a></h2><p>测试发现 force link mode up 并不像我们想象的能够让网卡一直处于 up 状态，拔了网线后仍旧能够变为 down，推测强制的定义应该针对的是速率与双工模式。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/Unsupported SFP+ Module">dpdk/Unsupported SFP+ Module</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->2 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题描述">问题描述<a class="hash-link" href="#问题描述" title="标题的直接链接">​</a></h2><p>ixgbe 网卡使用了不兼容的光模块后，dpdk 程序启动报 Unsupported SFP+ Module 错误，程序无法正常工作。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="经验之谈">经验之谈<a class="hash-link" href="#经验之谈" title="标题的直接链接">​</a></h2><p>dpdk 的不同版本对光模块的兼容性存在着差别，不同版本的 dpdk pmd 驱动支持的光模块型号存在着差别。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-ixgbe-pmd-allow_unsupported_sfp-参数">dpdk ixgbe pmd allow_unsupported_sfp 参数<a class="hash-link" href="#dpdk-ixgbe-pmd-allow_unsupported_sfp-参数" title="标题的直接链接">​</a></h2><p>dpdk 中的 ixgbe 驱动中可以设置允许使用不支持的 sfp 模块。</p><p>在 eth_ixgbe_dev_init 函数中有如下语句：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hw</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">allow_unsupported_sfp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里将 allow_unsupported_sfp 设置为 1 允许 ixgbe 驱动使用不支持的 sfp 模块。这种配置下的 ixgbe pmd 驱动可以使用的光模块型号会得到扩充，但使用官方未支持的 sfp 型号可能会引入新的问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ixgbe-官方驱动-allow_unsupported_sfp-参数">ixgbe 官方驱动 allow_unsupported_sfp 参数<a class="hash-link" href="#ixgbe-官方驱动-allow_unsupported_sfp-参数" title="标题的直接链接">​</a></h2><p>ixgbe 官方驱动也支持 allow_unsupported_sfp 参数，在 insmod ixgbe 驱动的时候可以设置 allow_unsupported_sfp 参数。</p><p>modinfo 查看 ixgbe.ko 的参数得到如下相关的信息i：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">parm:           allow_unsupported_sfp:Allow unsupported and untested SFP+ modules on 82599-based adapters (uint)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在使用 ixgbe 官方驱动的时候可以在加载模块时设置这个参数，不同的驱动版本支持的光模块型号可能也存在着差别。</p><p>注意，设置了 allow_unsupported_sfp 并不代表 sfp 模块就能够正常使用，需要以实际的测试结果为准。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk ebpf 库跨版本移植">dpdk ebpf 库跨版本移植</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->3 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="目标">目标<a class="hash-link" href="#目标" title="标题的直接链接">​</a></h2><p>dpdk-19.11 ebpf 库移植到 dpdk-16.04 中并适配 testpmd 来测试。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="移植前评估工作">移植前评估工作<a class="hash-link" href="#移植前评估工作" title="标题的直接链接">​</a></h2><p>评估方法：</p><ol><li>使用 dpdk-19.11 编译生成 librte_bpf.a</li><li>nm 查看 .a 中的符号</li><li>过滤出 U 类型的符号并排除内部符号</li></ol><p>评估的情况：</p><p><a href="http://libelf.so/" target="_blank" rel="noopener noreferrer">libelf.so</a> 提供的符号：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">elf64_getehdr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elf64_getshdr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elf_begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elf_end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elf_errmsg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elf_errno</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elf_getdata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elf_getscn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elf_ndxscn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elf_nextscn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elf_strptr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elf_version</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>dpdk 需要支持的接口：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rte_eth_add_rx_callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rte_eth_add_tx_callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rte_eth_dev_is_valid_port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rte_eth_remove_rx_callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rte_eth_remove_tx_callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rte_log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rte_log_register</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rte_log_set_level</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rte_mempool_ops_table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>dpdk-16.04 已经具备的符号：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rte_eth_add_rx_callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rte_eth_add_tx_callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rte_eth_dev_is_valid_port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rte_eth_remove_rx_callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rte_eth_remove_tx_callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rte_log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>经过确认需要适配的符号如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rte_log_register</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rte_mempool_ops_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rte_log_set_level</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>根据上述信息，评估适配的工作量很少，风险可控。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="移植的注意事项">移植的注意事项<a class="hash-link" href="#移植的注意事项" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-librte_bpf-makefile-文件中设置-depdirs-变量将依赖的项目列举出来">1. librte_bpf Makefile 文件中设置 DEPDIRS 变量，将依赖的项目列举出来<a class="hash-link" href="#1-librte_bpf-makefile-文件中设置-depdirs-变量将依赖的项目列举出来" title="标题的直接链接">​</a></h3><p>   依赖 lib/librte_net lib/librte_eal lib/librte_mbuf  lib/librte_ether 这几个项目</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-dpdk-1604-不支持-rte_log_register-函数">2. dpdk-16.04 不支持 rte_log_register 函数<a class="hash-link" href="#2-dpdk-1604-不支持-rte_log_register-函数" title="标题的直接链接">​</a></h3><p> dpdk 高版本使用 rte_log_register 来注册一种类型的 log 事件，dpdk-16.04 的 log 系统比较落后，这部分逻辑需要去掉，同时 RTE_BPF_LOG 宏定义也需要修改。</p><p> 可以在 <strong>rte_log.h</strong> 中添加一个 <strong>RTE_LOGTYPE_BPF</strong> 的宏定义并修改 <strong>RTE_BPF_LOG</strong> 的实现。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-dpdk-1604-中用于标识网卡-id-的-port_id-为-uint8_t-类型高版本为-uint16_t-类型">3. dpdk-16.04 中用于标识网卡 id 的 port_id 为 uint8_t 类型，高版本为 uint16_t 类型<a class="hash-link" href="#3-dpdk-1604-中用于标识网卡-id-的-port_id-为-uint8_t-类型高版本为-uint16_t-类型" title="标题的直接链接">​</a></h3><p> 可以写一行 sed 命令一键替换</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-rte_experimental-与-rte_always_inline-这两个宏在-dpdk-1604-中缺少">4. <strong>rte_experimental 与 </strong>rte_always_inline 这两个宏在 dpdk-16.04 中缺少<a class="hash-link" href="#4-rte_experimental-与-rte_always_inline-这两个宏在-dpdk-1604-中缺少" title="标题的直接链接">​</a></h3><p><strong>rte_always_inline 的定义可以从高版本 <strong>copy</strong> 过来，</strong>rte_experimental  也可以从高版本 copy 过来，最好是加条件编译控制定义为空</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-mkrteappmk-中添加-rte_bpf-的链接项目与--lelf-的条件控制链接项目">5. mk/rte.app.mk 中添加 rte_bpf 的链接项目与 -lelf 的条件控制链接项目<a class="hash-link" href="#5-mkrteappmk-中添加-rte_bpf-的链接项目与--lelf-的条件控制链接项目" title="标题的直接链接">​</a></h3><p>   示例如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">+</span><span class="token plain">_LDLIBS</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_RTE_LIBRTE_BPF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">            </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lrte_bpf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">+</span><span class="token function" style="color:#d73a49">ifeq</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_RTE_LIBRTE_BPF_ELF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">+</span><span class="token plain">_LDLIBS</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONFIG_RTE_LIBRTE_BPF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">            </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lelf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">+</span><span class="token plain">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="6-修改-config-目录中的默认-dpdk-编译配置文件增加-config_rte_librte_bpf-与-config_rte_librte_bpf_elf-的配置项目并更新-rte_target-目录中的-config-文件">6. 修改 config 目录中的默认 dpdk 编译配置文件，增加 CONFIG_RTE_LIBRTE_BPF 与 CONFIG_RTE_LIBRTE_BPF_ELF 的配置项目，并更新 RTE_TARGET 目录中的 .config 文件<a class="hash-link" href="#6-修改-config-目录中的默认-dpdk-编译配置文件增加-config_rte_librte_bpf-与-config_rte_librte_bpf_elf-的配置项目并更新-rte_target-目录中的-config-文件" title="标题的直接链接">​</a></h3><h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-移植-bpf_cmdc-与-bpf_cmdh-到-testpmd-中时需要根据调整-bpf_cmdc-文件包含的头文件">7. 移植 bpf_cmd.c 与 bpf_cmd.h 到 testpmd 中时，需要根据调整 bpf_cmd.c 文件包含的头文件<a class="hash-link" href="#7-移植-bpf_cmdc-与-bpf_cmdh-到-testpmd-中时需要根据调整-bpf_cmdc-文件包含的头文件" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="8-bpf-arm64-jit-代码翻译相关源码需要依赖两个高版本的宏在-rte_commonh-中添加-rte_fls_u64-与-rte_align_mul_ceil-宏定义即可">8. bpf arm64 jit 代码翻译相关源码需要依赖两个高版本的宏，在 rte_common.h 中添加 rte_fls_u64 与 RTE_ALIGN_MUL_CEIL 宏定义即可<a class="hash-link" href="#8-bpf-arm64-jit-代码翻译相关源码需要依赖两个高版本的宏在-rte_commonh-中添加-rte_fls_u64-与-rte_align_mul_ceil-宏定义即可" title="标题的直接链接">​</a></h3><h2 class="anchor anchorWithStickyNavbar_LWe7" id="移植后测试">移植后测试<a class="hash-link" href="#移植后测试" title="标题的直接链接">​</a></h2><p>在虚拟机中使用 testpmd 测试移植的 bpf 库。</p><p>bpf-load 加载：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">testpmd</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> bpf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">load  rx </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> J </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dummy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">validate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x7ffd0c107740</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> stats</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nb_nodes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nb_jcc_nodes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node_color</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">WHITE</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">GREY</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">BLACK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">edge_type</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">UNKNOWN</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">TREE</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">BACK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CROSS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rte_bpf_elf_load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;./dummy.o&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;.text&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> successfully creates </span><span class="token number" style="color:#36acaa">0x7f141b176000</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jit</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">func</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x7f141b14c000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sz</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">Success</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>dummy.o bpf 指令码成功加载。</p><p>perf 观测函数调用：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">52.96</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">  testpmd   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> bpf_rx_callback_jit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">30.99</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">  testpmd   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> pkt_burst_io_forward</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">15.02</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">  testpmd   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> eth_em_recv_pkts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">0.95</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">  testpmd   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> start_pkt_forward_on_core</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>bpf_rx_callback_jit 函数正常调用，移植成功。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk mempool cache 机制分析">dpdk/dpdk mempool cache 机制分析</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->12 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a class="hash-link" href="#前言" title="标题的直接链接">​</a></h2><p>池是一种常见的设计技术，它将程序中常用的核心资源提前申请出来，放到一个【池子】里面，由程序自行管理资源的释放与申请。</p><p>dpdk 作为一种高性能数据转发套件，其中的关键资源是以 <strong>mbuf</strong> 结构描述的报文。程序收发包与中间的处理涉及到【频繁】的 mbuf 申请、释放操作，为了优化这一过程，dpdk 内部也使用了池技术来管理 mbuf。</p><p>dpdk 提供了类似内存池的结构，这一结构在 dpdk 内部称为 <strong>mempool</strong>，【专用】于 mbuf 的 mempool 又称为 <strong>pktmbuf pool</strong>。</p><p>dpdk 中 mbuf 使用的常见流程如下：</p><ol><li>程序初始化时创建一个 pktmbuf pool，按照特定的模式初始化创建的每个 mbuf 结构</li><li>程序运行时从 pktmbuf pool 中申请 mbuf，释放 mbuf 时，mbuf 重新被添加到内存池中</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-内存池的-cache-功能">dpdk 内存池的 cache 功能<a class="hash-link" href="#dpdk-内存池的-cache-功能" title="标题的直接链接">​</a></h2><p>cache 是计算机体系中的一个非常重要的概念，它充当了 cpu 与主存之间的缓冲，平衡了 cpu 访问寄存器与访问主存之间的巨大差异，带了更好的性能。</p><p>cache 在计算机内存架构中的位置如下图所示：</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/58157219eb4b4d5fb0fad60c60065f90.png" alt="在这里插入图片描述" class="img_ev3q">上图摘自 《CSAPP》。</p><p>上面的图形为正金字塔型，向上的方向上存储结构空间更小、访问速度更快、价格更昂贵，向下的方向存储结构空间更大、访问速度更慢、价格更便宜。</p><p>cache 的一般工作流程如下：</p><ol><li>当程序第一次访问某一字节存储空间时，这块空间不在 cache 中</li><li>cpu 以 cache line 为大小加载这一存储空间周围 64-byte（一个 cache line 的大小）长度的内容到 cache 中</li><li>此后继续访问这 64-byte 字节中的内容就能够直接在 cache 中找到，不用去访问主存，进而带来更好的性能</li></ol><p>cache 技术可以抽象为一种缓冲技术，它将少部分访问非常频繁的数据缓存起来，对这些数据的访问通过缓冲区完成，不用访问更底层的结构。</p><p>dpdk mempool 中就使用了缓冲技术，在 dpdk 内部称为 mempool cache，类比 cache 内存结构图，画了一个简单的 mempool cache 结构图如下：
<img loading="lazy" src="https://img-blog.csdnimg.cn/9d7922964ffa4b2ab886dee04a486c43.jpeg#pic_center" alt="在这里插入图片描述" class="img_ev3q"></p><p>与 cache 类似，mempool cache 中的元素更少，访问速度更快，在软件上的意义是执行更少的代码逻辑。</p><p>dpdk mempool 使用过程有些类似 cache 预取。</p><p>最开始的时候 mempool cache 中并<strong>没有元素</strong>，当你需要申请 n 个 mem 元素的时候不能在 cache 中找到（类似 cache miss），此时会访问外部的内存池，从内存池中直接出队 n + cache_size 大小个元素，加载到 cache 中，然后从 cache 中分配 n 个元素给上层。</p><p>这样当下一次分配的时候，当数目不超过 cache_size 时就可以直接从 cache 中分配，而不用再从外部内存池中分配。</p><p>下面我使用一个具体的实例，描述下 dpdk mempool cache 的工作原理。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-mempool-cache-结构">1. mempool cache 结构<a class="hash-link" href="#1-mempool-cache-结构" title="标题的直接链接">​</a></h2><p>rte_mempool_cache 结构体描述一个 mempool cache，其结构如下图所示：</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/2c81faa1e9c6448ba3c998d4b5d2bade.jpeg#pic_center" alt="在这里插入图片描述" class="img_ev3q">
size 表示 cache 的容量，flushthresh 表示将多余的元素 flush 到内存池的门限值，len 表示当前 cache 中的元素个数，objs 用于存储每个元素（以地址的形式储存）。</p><p>flushthresh 的计算公式如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">CACHE_FLUSHTHRESH_MULTIPLIER</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1.5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">CALC_CACHE_FLUSHTHRESH</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">c</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">   </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">     </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression keyword" style="color:#00009f">typeof</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">c</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">c</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">*</span><span class="token macro property expression" style="color:#36acaa"> CACHE_FLUSHTHRESH_MULTIPLIER</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其数量为 cache 大小的 <strong>1.5 倍</strong>！</p><p>objs 的大小为 <strong>RTE_MEMPOOL_CACHE_MAX_SIZE * 3</strong>，而在创建 mempool cache 时会限制最大为 <strong>RTE_MEMPOOL_CACHE_MAX_SIZE</strong>，<strong>多出来的存储空间用于临时保存超过 cache size 数目的元素</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-创建一个-pktmbuf-mempool-并为每个逻辑核配置-mempool-cache">2. 创建一个 pktmbuf mempool 并为每个逻辑核配置 mempool cache<a class="hash-link" href="#2-创建一个-pktmbuf-mempool-并为每个逻辑核配置-mempool-cache" title="标题的直接链接">​</a></h2><p>dpdk 创建 pktmbuf pool 的示例代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">MEMPOOL_CACHE_SIZE</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">NB_MBUFS</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1024</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* create the mbuf pool */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">rte_pktmbuf_pool_create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;mbuf_pool&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            NB_MBUFS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MEMPOOL_CACHE_SIZE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RTE_MBUF_DEFAULT_BUF_SIZE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_socket_id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里约定 cache size 为 6，NB_MBUFS 为 1024，同时约定使用了三个逻辑核,其它的参数不展开描述。</p><p>此函数调用后，dpdk 会在每个逻辑核上创建如下 mempool cache 结构：
<img loading="lazy" src="https://img-blog.csdnimg.cn/0ff3be5c27dc4be2bb9d621544a91080.png" alt="在这里插入图片描述" class="img_ev3q">
size 为 6 表明 cache 容量为 6 ，len 为 0 表明当前 cache 中没有元素。此时内存池的结构如下：</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/228445d5b640419fb536242905b6d476.jpeg#pic_center" alt="在这里插入图片描述" class="img_ev3q">
如上图所示，pktmbuf pool 会为每个 lcore 按照传入的 cache_size 创建 mempool cache，此 cache 空间中保存内存池中单个元素的地址，初始化的时候 cache 的元素为空，内存池中的元素都在 <strong>ring</strong> 中入队。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-第一次从-mempool-中分配空间时-mempool-cache-的变化">3. 第一次从 mempool 中分配空间时 mempool cache 的变化<a class="hash-link" href="#3-第一次从-mempool-中分配空间时-mempool-cache-的变化" title="标题的直接链接">​</a></h2><p>约定绑定在逻辑核 1 上的线程调用 <code>rte_mempool_get_bulk</code><strong>申请 5 个 mbuf</strong> ，实际从 mempool 中申请的 mbuf 数量为 cache_size + 5——11 个。</p><p>由于 <strong>mempool cache</strong> 与每个逻辑核绑定，首先要获取当前线程所在的逻辑核，然后获取此逻辑核上的 <strong>mempool cache</strong>。</p><p>然后判断要申请的 mem 的数量小于 cache 的缓存数目，则申请 <strong>cache_size - cache_len + n</strong> (6 + 5 - 0 = 11 ) 个数量的元素。</p><p>此后调用底层的出队函数，从内存池中拿出 11 个元素存储到 cache 中，如果失败则 bypass cache，直接从内存池中重新分配。</p><p>成功分配时后将 cache_len 递增 req（11） 个数目，然后从 cache 中拿走 n（5） 个元素，并调整 cache_len 为 6。</p><p>此时当前 lcore 上的 mempool_cache 内容如下：</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/65b9606a27c6459c8b479b70c742d016.jpeg#pic_center" alt="在这里插入图片描述" class="img_ev3q">
cache 中保存了 memaddr0 ~memaddr5 共 6 个元素。</p><p>此时 mempool 中的元素如下：</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/5218010a31024d30a8e43674a5a8e293.jpeg#pic_center" alt="在这里插入图片描述" class="img_ev3q">
mempool 中的前 11 个元素为空表示被分配出去，其中 6 个元素缓存在 cache 中，剩下的 5 个元素被上层程序占用，其它的元素仍旧在 mempool 中。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-第二次从-mempool-中分配-mubf-时-mempool-cache-的变化">4. 第二次从 mempool 中分配 mubf 时 mempool cache 的变化<a class="hash-link" href="#4-第二次从-mempool-中分配-mubf-时-mempool-cache-的变化" title="标题的直接链接">​</a></h2><p>约定绑定在逻辑核 1 上的线程调用 <code>rte_mempool_get_bulk</code><strong>继续申请 5 个 mbuf</strong> ，此时 cache 中有 6 个元素，直接从 cache 中分配。</p><p>分配后逻辑核 1 上的 mempool_cache 状态如下：</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/0e43273936cc471089bc71fd00305ee7.jpeg#pic_center" alt="在这里插入图片描述" class="img_ev3q">
此时 mempool 中的元素如下：</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/0ebbb5200b8642f3ab9aed97d1a70688.jpeg#pic_center" alt="在这里插入图片描述" class="img_ev3q"> 此时，上层占用了 10 个 mbuf，lcore1 mempool  cache 中存储了 1 个 mbuf，剩下的 1013 个 mbuf 都在 mempool 中。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-上层释放-mbuf-到-mempool-中">5. 上层释放 mbuf 到 mempool 中<a class="hash-link" href="#5-上层释放-mbuf-到-mempool-中" title="标题的直接链接">​</a></h2><p>当上述 mbuf 使用完成后，上层释放 mbuf，约定上层在逻<strong>辑核 1 上运行的线程中同时释放占用的 10 个 mbuf</strong>。</p><p>释放过程的逻辑如下：</p><ol><li>获取线程所在逻辑核上的 mempool cache 结构</li><li>判断传入的释放元素个数是否大于 RTE_MEMPOOL_CACHE_MAX_SIZE(512)，大于则直接放到 mempool 中，小于则放到 mempool cache 中</li><li>判断 mempool cache 中存放的元素数目是否超过 flushthresh 值，超过后则将【超过 cache_size】 的部分重新放入 mempool 中并调整 cache_len 的值为 cache_size</li></ol><p>当同时释放 10 个 mbuf 时，首先 mbuf 被放到逻辑核 1 上的 mempool cache 中，此时此 cache 中共有 10+1 个元素，然后判断到 11 大于 flushthresh(9)，则将多出来的 5 个元素放回 mempool 中。</p><p>执行此操作后 mempool cache 的状态如下：
<img loading="lazy" src="https://img-blog.csdnimg.cn/65b9606a27c6459c8b479b70c742d016.jpeg#pic_center" alt="在这里插入图片描述" class="img_ev3q">
mempool 的状态如下：</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/229518eb437f429398e0e91925e19ad8.jpeg#pic_center" alt="在这里插入图片描述" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-mempool-cache-使用的一些问题">dpdk mempool cache 使用的一些问题<a class="hash-link" href="#dpdk-mempool-cache-使用的一些问题" title="标题的直接链接">​</a></h2><ol><li>dpdk mempool 针对每个 lcore 配置 cache，dpdk lcore 机制可以参考 <a href="https://blog.csdn.net/Longyu_wlz/article/details/116398708" target="_blank" rel="noopener noreferrer">dpdk-16.04 eal lcore 多线程机制分析</a>，对于单独使用 pthread_create 创建的线程，由于 lcore_id 为 -1，不能获取到 mempool cache，在这些线程中申请、释放元素到 mempool 中不会经过 cache</li><li>每一个 lcore 上 mempool cache 的使用没有任何互斥保护，多个线程使用同一个 lcore 的情况下对 mempool cache 的访问会存在不一致性，这种场景下需要关闭 mempool cache 功能</li><li>申请元素的线程所在的 lcore 要与释放元素的线程所在的 lcore <strong>一致</strong>，如果不一致就可能存在<strong>泄露</strong>部分元素的情况
假设程序仅在 lcore 1 上申请 mbuf，而释放 mbuf 却在 lcore 2 上，这样就会泄露最多 mempool cache 初始化配置的容量大小个 mbuf</li><li>在 cache 中分配、释放的概率越大性能越好</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="标题的直接链接">​</a></h2><p>这篇文章的背景是在实际的工作场景中遇到了一个 dpdk mbuf 泄露的问题，在这个问题中，将 mempool cache 的 size 改为 0 后问题得到解决，但是这只是个表面现象，不由得让人追问<strong>难道 dpdk mempool cache 功能真的有严重的缺陷吗？</strong></p><p>于是带着这一疑问深入分析了下 mempool cache 的处理过程，结果发现确实存在一些限制因素，但是却没有找到所谓的严重缺陷，看来问题并没有这么简单，表面的现象说明不了太多问题。</p><p>写的过程中想到这个过程跟 cache 的一些原理有些相似，就类比着描述下，这个过程是在逐渐从具象走向抽象，当能完全理解抽象的模型后，就容易在不同的场景中迁移了。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考链接">参考链接<a class="hash-link" href="#参考链接" title="标题的直接链接">​</a></h2><p><a href="https://zhuanlan.zhihu.com/p/375537583" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/375537583</a></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 不同版本下载地址">dpdk/dpdk 不同版本下载地址</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->1 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><p>版本回退需要，整理了下 dpdk 多个版本的下载链接。</p><p><a href="https://static.dpdk.org/rel/dpdk-1.7.1.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-1.7.1.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-1.8.0.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-1.8.0.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.04.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.04.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.07.1.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.07.1.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.07.2.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.07.2.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.07.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.07.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.11.1.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.11.1.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.11.10.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.11.10.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.11.11.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.11.11.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.11.2.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.11.2.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.11.3.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.11.3.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.11.4.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.11.4.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.11.5.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.11.5.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.11.6.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.11.6.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.11.7.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.11.7.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.11.8.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.11.8.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.11.9.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.11.9.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-16.11.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-16.11.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.02.1.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.02.1.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.02.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.02.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.05.1.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.05.1.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.05.2.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.05.2.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.05.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.05.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.08.1.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.08.1.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.08.2.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.08.2.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.08.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.08.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.11.1.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.11.1.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.11.10.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.11.10.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.11.2.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.11.2.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.11.3.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.11.3.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.11.4.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.11.4.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.11.5.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.11.5.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.11.6.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.11.6.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.11.7.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.11.7.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.11.8.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.11.8.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.11.9.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.11.9.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-17.11.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-17.11.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.02.1.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.02.1.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.02.2.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.02.2.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.02.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.02.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.05.1.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.05.1.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.05.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.05.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.08.1.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.08.1.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.08.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.08.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.11.1.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.11.1.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.11.2.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.11.2.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.11.3.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.11.3.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.11.4.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.11.4.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.11.5.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.11.5.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.11.6.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.11.6.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.11.7.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.11.7.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.11.8.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.11.8.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.11.9.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.11.9.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-18.11.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-18.11.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-19.02.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-19.02.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-19.05.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-19.05.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-19.08.1.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-19.08.1.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-19.08.2.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-19.08.2.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-19.08.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-19.08.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-19.11.1.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-19.11.1.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-19.11.2.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-19.11.2.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-19.11.3.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-19.11.3.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-19.11.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-19.11.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-2.0.0.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-2.0.0.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-2.1.0.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-2.1.0.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-2.2.0.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-2.2.0.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-20.02.1.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-20.02.1.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-20.02.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-20.02.tar.xz</a>
<a href="https://static.dpdk.org/rel/dpdk-20.05.tar.xz" target="_blank" rel="noopener noreferrer">https://static.dpdk.org/rel/dpdk-20.05.tar.xz</a></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 多进程模型共享队列收发包 virtio 网卡段错误问题">dpdk 多进程模型</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->4 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><p>dpdk 原生支持<strong>多进程模型</strong>，主进程为 <strong>primary</strong> 进程，<strong>只有一个</strong>，从进程为 <strong>secondary</strong> 进程，可以有多个。</p><p>dpdk 业务口的<strong>共享数据结构</strong>，如收发包队列，驱动内部的数据结构等由 <strong>primary</strong> 进程创建，<strong>secondary</strong> 进程通过与 <strong>primary</strong> 进程<strong>共享内存</strong>来 attach 到相应的数据结构上。</p><p>实际场景中，primary 进程完成<strong>接口配置、并提供接口控制如接口 up、down、接口状态检测等功能</strong>，<strong>secondary 进程可以用于 dump primary 进程创建的一些共享数据结构</strong>，<strong>也可以用于收发包以及基于报文的一些处理逻辑</strong>。</p><p>本文中描述的问题为 secondary 进程共享 primary 进程的收发队列收发包时出现<strong>段错误</strong>的问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题描述">问题描述<a class="hash-link" href="#问题描述" title="标题的直接链接">​</a></h2><p><strong>业务口类型</strong>：virtio 虚拟网卡
<strong>业务模型</strong>：多进程模型，secondary 进程用于收发包，收发包时出现段错误。
<strong>dpdk 版本</strong>：dpdk-16.11</p><p><strong>段错误信息：</strong></p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Thread </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;lcore-slave-0&quot;</span><span class="token plain"> received signal SIGSEGV</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Segmentation fault</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Switching to LWP </span><span class="token number" style="color:#36acaa">23400</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x00007ffff69b5a4d</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">virtio_recv_mergeable_pkts</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from libdpdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">so</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> bt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff69b5a4d</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">virtio_recv_mergeable_pkts</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from libdpdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x000000000042c291</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">dpdk_recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00000000004158e6</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">process_launch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff67ea297</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">eal_thread_loop</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from libdpdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff5c96da4</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">start_thread</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">usr</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">local</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">libpthread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00007ffff59c820d</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">clone</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> from </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">usr</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">local</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">6</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>复现概率</strong>：必现！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="编译-debug-版本确定段错误的位置">编译 debug 版本确定段错误的位置<a class="hash-link" href="#编译-debug-版本确定段错误的位置" title="标题的直接链接">​</a></h2><p>确定在如下函数中触发段错误：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">virtqueue_notify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">virtqueue</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Ensure updated avail-&gt;idx is visible to host.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * For virtio on IA, the notificaiton is through io port operation</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * which is a serialization instruction itself.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vq</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">hw</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vtpci_ops</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">notify_queue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vq</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>secondary 进程中接口的 hw 数据结构从 primary 进程共享，primary 进程中的 <strong>vtpci_ops-&gt;notify_queue</strong> <strong>函数指针</strong>在 <strong>secondary</strong> <strong>进程中指向一个非法位置，导致段错误</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="真正的问题">真正的问题<a class="hash-link" href="#真正的问题" title="标题的直接链接">​</a></h2><p>primary 进程与 secondary 进程共享的队列信息中，<strong>共享的内容为数据结构</strong>，<strong>不共享代码段。</strong></p><p>primary 进程中函数指针指向的函数在 secondary 进程中指向其它非法位置，导致段错误。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="修复方案">修复方案<a class="hash-link" href="#修复方案" title="标题的直接链接">​</a></h2><p>在接口初始化的时候，根据 hw-&gt;modern 的值<strong>配置某函数指针</strong>，将 virtio 收发包函数中调用到的 <strong>vtpci_ops-&gt;notify_queue</strong> 函数指针改为<strong>调用程序本地的函数指针</strong>，此指针指向的代码段在每个程序内部是合法的，它的地址不通过队列共享获取。</p><p>简单示例如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> virtqueue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">h</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">revision </span><span class="token number" style="color:#36acaa">51811</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">++</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> virtqueue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">h</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">working copy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">330</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">330</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">13</span><span class="token plain"> @@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> For virtio on IA</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> the notificaiton is through io port operation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> which is a serialization instruction itself</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">       vq</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">hw</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vtpci_ops</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">notify_queue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vq</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">       </span><span class="token function" style="color:#d73a49">vtpci_notify_queue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vq</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">hw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题引申">问题引申<a class="hash-link" href="#问题引申" title="标题的直接链接">​</a></h2><p>dpdk 多进程收发队列共享存在限制，不能共享代码段，只能共享数据区域，对于<strong>共享函数指针的情况，会在其他进程中触发段错误</strong>。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 官方 bugzilla 导出信息">dpdk/dpdk 官方 bugzilla 导出信息</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->42 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Bug ID  Product Component   Assignee    Status  Resolution  Summary Changed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">42  DPDK    cryptodev   akhil.gupta@puresoftware.com    IN_PROGRESS  ---    Crypto_mrvl error with multiple instances   2018/7/15 6:42</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100 DPDK    testpmd alejandro.lucero@netronome.com  RESOLVED    FIXED   testpmd deadlock    2018/11/8 12:43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">122 lab UNH infra   ci@dpdk.org RESOLVED    INVALID Performance results are not correct on Intel I40E environments  2020/4/21 15:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">193 DPDK    ethdev  mk@semihalf.com RESOLVED    FIXED   symmetric_mp example application crashes for Amazon ENA in multiple process mode    2019/1/26 0:54</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">278 DPDK    ethdev  3chas3@gmail.com    CONFIRMED    ---    bond_ethdev_rx_burst multithread access bond&#x27;s different queue will crash   2019/5/15 22:59</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">301 DPDK    ethdev  rasland@nvidia.com  RESOLVED    INVALID DPDK driver is crashing for Mellanox-5 NIC card 2019/7/12 10:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">431 lab job scripts ci@dpdk.org RESOLVED    FIXED   Missing performance results in Patchwork checks, and possible false positives   2020/6/2 13:53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">442 SPP main    yasufum.o@gmail.com CONFIRMED    ---    disable ASLR is been highly recommended 2020/8/3 6:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">443 SPP main    yasufum.o@gmail.com CONFIRMED    ---    spp primary takes up the complete hugepages 2020/8/5 7:52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">82  DPDK    examples    honnappa.nagarahalli@arm.com    RESOLVED    FIXED   Failure to compile l3fwd example on ARM 2020/4/26 2:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">104 DPDK    core    reshma.pattan@intel.com RESOLVED    WORKSFORME  &quot;dpdk-procinfo&quot; received signal SIGSEGV, Segmentation fault.    2018/11/2 9:54</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">259 DPDK    testpmd konstantin.ananyev@intel.com    RESOLVED    DUPLICATE   unable to run sample t3 as bpf-load for testpmd 2019/7/25 10:54</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">315 DPDK    vhost/virtio    dev@dpdk.org    RESOLVED    WORKSFORME  Virtio crypto does not work . Tried with vhost crypto as backend and dpdk test application (cryptodev_virtio_autotest ) 2019/11/21 3:09</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">352 DPDK    examples    Muthurajan.Jayakumar@intel.com  UNCONFIRMED  ---    Bifurcated Driver X710 for ipv6 flow rule addition not working  2019/10/11 19:49</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">425 lab job scripts ci@dpdk.org RESOLVED    WONTFIX Eth Tests - Link Status Checks  2020/6/30 22:27</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">426 lab job scripts ci@dpdk.org RESOLVED    FIXED   Eth Tests - MTU Checks  2020/6/30 20:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">439 DPDK    ethdev  marko.kovacevic@intel.com   UNCONFIRMED  ---    memif pmd is allocating from Node 0, even after passing Node 1 in eal args  2020/4/10 10:48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">453 SPP ctl yasufum.o@gmail.com CONFIRMED    ---    SPP-CTL does not run with python2.7 2020/4/24 4:17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">500 lab Intel Lab   zhaoyan.chen@intel.com  RESOLVED    FIXED   Compilation failing in Intel CI since 07/04 2020/7/16 15:26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">505 DPDK    core    jerinjacobk@gmail.com   CONFIRMED    ---    [dpdk-20.08] meson build 32-bits failed on ubuntu20.04  2020/7/10 11:55</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">515 DTS tests   dts@dpdk.org    UNCONFIRMED  ---    DTS must _not_ modify DPDK sources  2020/8/3 9:37</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">375 lab job scripts ci@dpdk.org RESOLVED    WONTFIX run basic DTS functional tests  2020/4/21 16:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">427 lab job scripts ci@dpdk.org RESOLVED    WONTFIX Eth Tests - Promiscuous Support 2020/6/30 20:01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">428 lab job scripts ci@dpdk.org RESOLVED    FIXED   Eth Tests - Hardware Checksum Checks    2020/6/30 20:02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">451 lab job scripts blo@iol.unh.edu CONFIRMED    ---    Split dpdk-ci and dpdklab-ci scripts    2020/6/30 20:10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">459 lab UNH infra   ci@dpdk.org RESOLVED    FIXED   Performance Turning and Results Stability Issues on NXP test environment    2020/6/16 14:51</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">468 DPDK    ethdev  kevuzaj@gmail.com   RESOLVED    FIXED   bnxt: build fail with gcc10 default fno-common  2020/5/6 15:29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">476 lab job scripts ci@dpdk.org RESOLVED    FIXED   Run mingw-w64 compilation on windows    2020/6/25 15:12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">489 lab UNH infra   blo@iol.unh.edu IN_PROGRESS  ---    Broadcom 100Gbe NIC Upgrade 2020/7/14 22:51</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">149 lab dashboard   ci@dpdk.org CONFIRMED    ---    Add GA Performance results to the database  2018/12/10 20:44</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">169 lab job scripts dpdklab@iol.unh.edu RESOLVED    WONTFIX Create GA performance Jenkins Job   2020/4/7 15:23</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2   DPDK    eventdev    dev@dpdk.org    RESOLVED    INVALID Test bugs for checking the bug flow, no need any fix    2018/7/18 19:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5   DPDK    other   dev@dpdk.org    RESOLVED    WONTFIX This is a Bug, Please Disabled Create new Account   2018/7/15 6:50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6   DPDK    other   dev@dpdk.org    CONFIRMED    ---    dpdk-pdump leads to ovs-vswitchd crash  2020/1/9 8:19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14  DPDK    other   batmanustc@gmail.com    CONFIRMED    ---    Kernel Crash bug of ixgbevf kernel module in &quot;Intel(R) 10GbE PCI Express Virtual Function Driver Version: 4.0.3 Release: 1&quot; and the latest version  2018/9/16 0:13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">15  DPDK    core    dev@dpdk.org    CONFIRMED    ---    Kernel crash after &quot;Detected Tx Unit Hang&quot; report   2018/2/6 14:28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">56  DPDK    other   dev@dpdk.org    RESOLVED    FIXED   crash when freeing memory with no mlx5 device attached  2018/6/28 21:01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">88  DPDK    eventdev    harry.van.haaren@intel.com  CONFIRMED    ---    DPDK service core getting crashed with eventdev scheduler   2018/9/21 11:53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">89  DPDK    ethdev  qi.z.zhang@intel.com    RESOLVED    WONTFIX XL710 DPDK i40evf : Ping is not working when RSS enabled for IP 2018/10/23 3:04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">97  DPDK    core    dev@dpdk.org    RESOLVED    FIXED   rte_memcpy() moves data incorrectly on Ubuntu 18.04 on Intel Skylake    2019/7/11 9:52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">106 DPDK    core    dev@dpdk.org    RESOLVED    FIXED   running dpdk-procinfo or any secondary leading to system memory exhaustion  2018/11/13 18:03</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">179 DPDK    other   anatoly.burakov@intel.com   RESOLVED    FIXED   mp_socket is not well handled when secondary process is exited  2019/1/10 13:50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">188 DPDK    testpmd yskoh@mellanox.com  RESOLVED    FIXED   significant multi-core performance degradation with SR-IOV/macswap in some cases    2019/1/14 20:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">194 DPDK    vhost/virtio    maxime.coquelin@redhat.com  CONFIRMED    ---    vhost pmd has become unusable from secondary processes. 2019/7/9 13:55</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">199 DPDK    examples    qi.z.zhang@intel.com    RESOLVED    FIXED   Azure DPDK 18.11 Multiple Processes Example Support 2019/7/11 10:14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">240 lab job scripts alialnu@mellanox.com    RESOLVED    FIXED   nic_single_core_perf test reports 0&#x27;s for absolute values when it should fail   2020/7/9 15:42</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">333 DPDK    core    thomas@monjalon.net UNCONFIRMED  ---    PCI devices not found when DPDK is linked as dynamic libraries  2019/7/22 9:35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">363 DPDK    other   maxime.coquelin@redhat.com  RESOLVED    FIXED   CVE-2019-14818  2019/12/2 13:32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">371 DPDK    testpmd asafp@nvidia.com    RESOLVED    INVALID mlx5: failed to probe the port at testpmd (DPDK 19.11-rc3)  2020/6/23 14:18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">379 DPDK    other   dev@dpdk.org    RESOLVED    INVALID Build fail using dpdk-setup.sh in RedHat version 3.10.0-862.rt56.804.el7.x86_64 2020/1/3 11:31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">389 DPDK    core    scott_wasson@affirmednetworks.com   RESOLVED    FIXED   Crash in librte_kni driver due to noncontiguous pages   2020/4/26 2:40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">405 DPDK    ethdev  matan@mellanox.com  CONFIRMED    ---    mlx5: the guest driver doesn&#x27;t enforce the MTU set by rte_eth_dev_set_mtu() 2020/6/23 14:14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">461 DPDK    ethdev  qi.z.zhang@intel.com    UNCONFIRMED  ---    i40evf link status is always down with the Intel XL710 driver   2020/5/15 15:50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">471 DPDK    other   dev@dpdk.org    RESOLVED    DUPLICATE   failing to build test from app/test 2020/5/13 10:43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">478 DPDK    ethdev  jeanprincemello@gmail.com   RESOLVED    FIXED   Unable to build igb_uio kernel module on Ubuntu 18.04   2020/5/15 15:52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">486 DPDK    ethdev  dev@dpdk.org    RESOLVED    INVALID i40e driver has very bad performance when VXLAN TSO is enabled  2020/7/30 5:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">495 lab job scripts blo@iol.unh.edu RESOLVED    FIXED   make builds are getting stuck   2020/7/13 15:25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">518 DPDK    ethdev  jia.guo@intel.com   UNCONFIRMED  ---    Disabling a VF with XL710 still sees the traffic and the link is still high 2020/8/3 7:51</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4   DPDK    testpmd salehals@mellanox.com   CONFIRMED    ---    Segfault while running txonly mode with 4 16B SGEs packets  2018/8/2 8:04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7   DPDK    ethdev  motih@mellanox.com  RESOLVED    FIXED   mlx4 PMD does not receive broadcast packets in promiscuous mode.    2020/5/12 15:55</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9   DPDK    other   dev@dpdk.org    RESOLVED    INVALID qays    2018/6/16 2:28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">27  DPDK    core    yskoh@mellanox.com  RESOLVED    INVALID Can&#x27;t build mlx5 from 18.02 on CentOS Linux release 7.4.1708 with kernel 3.10.0-693.11.1.el7.x86_64 2019/10/25 9:28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">49  DPDK    mk  dev@dpdk.org    RESOLVED    FIXED   Compile error kni_net.c unknown field ‘ndo_change_mtu’  2018/5/31 6:53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">53  DPDK    core    bruce.richardson@intel.com  RESOLVED    WONTFIX rte abort issue on FreeBSD  2018/9/28 14:52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">54  DPDK    ethdev  dev@dpdk.org    VERIFIED    FIXED   i40e port link status no updated for interrupt mode 2018/5/31 16:11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">55  DPDK    ethdev  qi.z.zhang@intel.com    RESOLVED    FIXED   I40E PMD driver in vector mode implicitly requires number of RX descriptors in a ring to be power of two    2018/11/13 4:24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">59  DPDK    core    dev@dpdk.org    RESOLVED    INVALID Cannot start secondary processes anyhow on Redhat EL7   2018/7/10 0:14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">60  DPDK    eventdev    harry.van.haaren@intel.com  RESOLVED    FIXED   rte_event_port_unlink() causes subsequent events to end up in wrong port    2018/9/26 16:28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">63  DPDK    other   mk@semihalf.com RESOLVED    FIXED   AWS ENA driver does not work with zero rx queues.   2018/7/20 9:57</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">65  DPDK    ethdev  beilei.xing@intel.com   RESOLVED    WORKSFORME  Tx VLAN offload not working on DPDK 17.11 LTS i40e PMD  2018/10/23 3:03</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">77  DPDK    examples    dev@dpdk.org    RESOLVED    FIXED   [Interrupt app]: failed to start interrupt app. 2018/7/26 17:21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">85  DPDK    core    geoffrey.lv@gmail.com   RESOLVED    FIXED   pci_scan_one() issue    2019/1/24 14:16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">86  DPDK    ethdev  konstantin.ananyev@intel.com    RESOLVED    FIXED   Requested device cannot be used 2018/9/14 14:30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">90  DPDK    meson   ferruh.yigit@intel.com  IN_PROGRESS  ---    DPDK Installation fails on Centos   2018/9/20 16:25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">93  DPDK    cryptodev   pablo.de.lara.guarch@intel.com  CONFIRMED    ---    crypto vdev create will reset the dev_started flag  when one dpdk process has been up the crypto vdev   2019/1/5 16:25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">101 DPDK    testpmd alejandro.lucero@netronome.com  RESOLVED    FIXED   18.11-RC1/ Testpmd start fail   2018/11/8 12:44</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">110 DPDK    other   xueqin.lin@intel.com    RESOLVED    FIXED   system hang when device deleted for hotplug function(igb uio)   2018/11/28 2:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">115 DPDK    other   a.latifi.al@gmail.com   CONFIRMED    ---    pktgen panic when using big sized pcap file 2018/12/2 17:25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">116 DPDK    ethdev  konstantin.ananyev@intel.com    RESOLVED    FIXED   Single-port, multi-core and multi-queue mode (open RSS), when configuring IP, may cause dpdk coredump   2019/1/16 10:40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">191 DPDK    other   maria.lingemark@ericsson.com    RESOLVED    FIXED   Sometimes timers (rte_timer) do not expire  2019/1/21 12:41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">196 DPDK    ethdev  konstantin.ananyev@intel.com    RESOLVED    WONTFIX IXGBE Driver Tx Packet/Bytes counters Sent returns Zero even though link-partner received valid packets 2019/6/3 7:30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">204 DPDK    core    beilei.xing@intel.com   CONFIRMED    ---    Crash on Vmware esxi host when dpdk guest reboots.  2019/3/16 14:51</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">210 lab job scripts ferruh.yigit@intel.com  CONFIRMED    ---    Patches with dependency fails to apply  2020/7/1 13:36</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">216 DPDK    examples    gain1974@gmail.com  RESOLVED    FIXED   rte_eth_rx_burst   nb_pkts   issue  2019/3/16 14:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">236 DPDK    core    anatoly.burakov@intel.com   RESOLVED    INVALID primary-secondary model is failing  2019/4/2 12:42</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">241 DPDK    vhost/virtio    dev@dpdk.org    CONFIRMED    ---    QEMU (vIOMMU+virtio) crashes when DPDK exits    2020/3/16 7:07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">248 DPDK    ethdev  p.oltarzewski@gmail.com CONFIRMED    ---    Bonding PMD: Invalid array dimension in TX burst for 802.3ad mode with fast queue leads to SEGFAULT 2019/4/15 12:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">256 DPDK    ethdev  3chas3@gmail.com    RESOLVED    FIXED   Transmit or receive packets use the bond MAC is failed when switch backup port to active    2020/7/23 22:30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">265 DPDK    ethdev  qi.z.zhang@intel.com    RESOLVED    FIXED   i40e flow flush &amp; add new flow will occur segfault  2020/4/26 2:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">280 DPDK    doc beilei.xing@intel.com   CONFIRMED    ---    X710 PF Reset Issue with DPDK VF Driver 2019/7/15 21:02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">284 DPDK    other   ferruh.yigit@intel.com  CONFIRMED    ---    Secondary not able to Rx/TX after primary dies in symmetric multiprocess    2019/8/14 16:36</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">285 DPDK    other   jananeex.m.parthasarathy@intel.com  RESOLVED    FIXED   rte_table unit test crashes in ipv6 2019/7/15 20:58</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">296 DPDK    ethdev  dev@dpdk.org    CONFIRMED    ---    max_rx_pkt_len issues with i40e dpdk SRIOV driver net_i40e_vf.  2019/9/12 7:07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">297 DPDK    ethdev  lavaraj@gmail.com   CONFIRMED    ---    max_rx_pkt_len issues with i40e dpdk SRIOV driver net_i40e_vf.  2019/7/15 20:51</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">304 DPDK    ethdev  ullas-d.bhat@hpe.com    RESOLVED    INVALID [bnx2x_init] Initialization failed, stack notified driver is NOT running!   2019/8/6 19:55</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">312 DPDK    ethdev  beilei.xing@intel.com   RESOLVED    FIXED   i40evf could not receive mulicast packets   2020/4/26 2:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">319 DPDK    ethdev  beilei.xing@intel.com   UNCONFIRMED  ---    dpdk-i40e could not receive vlan packet whose ip_len was bigger than 1496   2019/11/7 7:42</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">355 DPDK    meson   dev@dpdk.org    RESOLVED    FIXED   Meson build failure 2019/12/2 18:16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">366 DPDK    ethdev  ajit.khaparde@broadcom.com  CONFIRMED    ---    i40e PMD returns 0 for secondary invoking rx_burst on queue 0, when Primary dies    2020/1/27 5:40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">369 DPDK    examples    pbhagavatula@marvell.com    UNCONFIRMED  ---    l2fwd-event fails for service core mask 2019/11/26 20:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">372 DPDK    ethdev  konstantin.ananyev@intel.com    UNCONFIRMED  ---    ixgbevf: cannot probe or start port if PF link is unstable  2019/11/27 20:34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">378 DPDK    core    dev@dpdk.org    UNCONFIRMED  ---    takes more than 500ms to allocate memory from numa node1    2020/1/2 4:43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">393 DPDK    core    anatoly.burakov@intel.com   UNCONFIRMED  ---    rte_zmalloc_socket does not zero memory 2020/2/20 12:46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">397 DPDK    ethdev  dev@dpdk.org    RESOLVED    WORKSFORME  support-multi-driver=1 does not work in i40e PMD    2020/3/23 12:48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">418 DPDK    ethdev  dev@dpdk.org    UNCONFIRMED  ---    failsafe/tap PMD drops first UDP packet 2020/3/11 2:29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">433 SPP main    yasufum.o@gmail.com CONFIRMED    ---    suggested URL for DPDK-Suricata is limited or not working   2020/8/5 6:29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">441 SPP main    yasufum.o@gmail.com CONFIRMED    ---    link is broken  2020/4/8 11:10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">447 DPDK    ethdev  konstantin.ananyev@intel.com    IN_PROGRESS  ---    ixgbe: ixgbe_dev_link_update_share() leaks memory and memory mappings due to not cleaning up pthreads   2020/4/14 12:33</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">449 DPDK    ethdev  dev@dpdk.org    CONFIRMED    ---    Fortville X710 FDIR with flow APIs broken   2020/5/15 10:24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">454 SPP ctl yasufum.o@gmail.com UNCONFIRMED  ---    Documentation does callout the dependency for python modules in SPP-CTL 2020/4/23 10:28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">455 SPP ctl yasufum.o@gmail.com UNCONFIRMED  ---    spp does not run with python3   2020/4/23 10:32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">457 SPP main    yasufum.o@gmail.com UNCONFIRMED  ---    rte_mempool_create is based on lcore socketid and not the port socketid 2020/4/23 7:04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">463 DPDK    testpmd suanmingm@mellanox.com  RESOLVED    FIXED   In Mellanox MLX5 driver, NULL pointer access in mlx5_ipool_malloc() 2020/5/13 4:50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">472 DPDK    other   david.marchand@redhat.com   UNCONFIRMED  ---    failure in unit/self test   2020/5/13 19:31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">473 DPDK    other   thomas@monjalon.net UNCONFIRMED  ---    variance in test case fail for static and shared build binaries 2020/5/19 13:32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">474 DPDK    other   thomas@monjalon.net UNCONFIRMED  ---    auto-test report crash while manual test skips  2020/5/18 17:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">484 DPDK    other   hrvoje.habjanic@zg.ht.hr    UNCONFIRMED  ---    rte_sched_subport_free function does not free subport memory    2020/5/26 20:12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">485 DPDK    other   hrvoje.habjanic@zg.ht.hr    UNCONFIRMED  ---    pipe_profile_check function have wrong argument size    2020/6/15 19:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">488 DPDK    other   matan@mellanox.com  CONFIRMED    ---    mlx4: cannot reattach devices   2020/6/23 14:03</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">499 DPDK    meson   ferruh.yigit@intel.com  RESOLVED    FIXED   failed to start example after use meson/ninja build 32-bit app on x86 system    2020/8/19 3:11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">501 DPDK    ethdev  jia.guo@intel.com   RESOLVED    FIXED   igb: segfault in rte_eth_tx_done_cleanup() when using advanced descriptors  2020/8/4 18:43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">502 lab UNH infra   blo@iol.unh.edu RESOLVED    FIXED   False negative for Windows compilation  2020/7/6 20:17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">503 DPDK    core    dev@dpdk.org    RESOLVED    FIXED   can not detected device when use meson build dpdk   2020/7/13 7:25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">517 DPDK    testpmd jia.guo@intel.com   UNCONFIRMED  ---    Traffic Class Assignment    2020/8/3 10:07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1   DPDK    other   dev@dpdk.org    CONFIRMED    ---    Green goal: power efficiency with all hardwares 2018/2/7 15:38</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3   DPDK    doc qian.q.xu@intel.com RESOLVED    INVALID Test bug    2017/9/14 11:46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8   DPDK    core    ferruh.yigit@intel.com  IN_PROGRESS  ---    Debug/error output should go to stderr  2018/12/20 20:12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10  DPDK    testpmd nounoussma@hotmail.com  CONFIRMED    ---    [Testpmd] NUMA, speed issue 2018/8/29 20:14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">12  DPDK    ethdev  dev@dpdk.org    RESOLVED    INVALID Request for submit in Kernel Upstream   2020/5/10 18:25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">13  DPDK    ethdev  beilei.xing@intel.com   IN_PROGRESS  ---    Cannot initialize Intel XL710 40G interface 2018/12/4 14:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16  DPDK    doc dev@dpdk.org    RESOLVED    INVALID Hacked by Turkish Hacker SpawN #siberordu.biz   2018/2/25 19:43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">17  DPDK    ethdev  beilei.xing@intel.com   RESOLVED    INVALID vhost example VLAN offloading not working on igb tx 2018/11/30 14:35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">20  DPDK    core    anatoly.burakov@intel.com   RESOLVED    FIXED   Undefined behavior caused by NUMA function in eal_memory    2018/10/25 14:57</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">21  DPDK    ethdev  konstantin.ananyev@intel.com    RESOLVED    WONTFIX Ixgbe driver changes FCTRL without first disabling RXCTRL.RXEN  2018/10/18 9:40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">22  DPDK    ethdev  konstantin.ananyev@intel.com    RESOLVED    WONTFIX Ixgbe driver sets RDRXCTL with the wrong RSCACKC and FCOE_WRFIX values  2018/10/18 9:39</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">25  DPDK    ethdev  konstantin.ananyev@intel.com    CONFIRMED    ---    Ixgbe driver sets TDH register after TXDCTL.ENABLE is set   2018/11/16 8:34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">26  DPDK    ethdev  konstantin.ananyev@intel.com    CONFIRMED    ---    Ixgbe driver does not ensure FWSM firmware mode is valid before using it    2019/10/3 5:52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">28  DPDK    eventdev    pbhagavatula@caviumnetworks.com RESOLVED    FIXED   event/octeontx: snprintf() overflow 2018/4/25 16:53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">29  DPDK    ethdev  keith.wiles@intel.com   CONFIRMED    ---    pktgen hangs when it tries to send packets through libvirt driver, works for all other drivers  2019/6/26 15:43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">31  DPDK    core    bruce.richardson@intel.com  RESOLVED    FIXED   Does not compile with musl libc: lib/librte_eal/linuxapp/eal/eal_memory.c   2020/4/26 2:46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">32  DPDK    mk  dev@dpdk.org    CONFIRMED    ---    Does not cross-compile: buildtools/check-experimental-syms.sh assumes `objdump` 2020/3/11 10:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">33  DPDK    core    bruce.richardson@intel.com  RESOLVED    FIXED   Does not compile with musl libc: lib/librte_eal/linuxapp/eal/eal_hugepage_info.c    2020/4/26 2:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">34  DPDK    core    bruce.richardson@intel.com  RESOLVED    FIXED   Does not compile with musl libc: lib/librte_eal/common/eal_common_fbarray.c 2020/4/26 2:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">35  DPDK    ethdev  ferruh.yigit@intel.com  CONFIRMED    ---    Does not compile with musl libc: drivers/bus/pci/linux/pci_uio.c    2019/6/26 10:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">37  DPDK    ethdev  shreyansh.jain@nxp.com  CONFIRMED    ---    DPAA / FSLMC do not compile on the musl libc    2018/5/4 10:04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">38  DPDK    ethdev  rahul.lakkireddy@chelsio.com    CONFIRMED    ---    Does not compile with musl libc: drivers/net/cxgbe/base/common.h    2018/7/15 6:33</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">39  DPDK    ethdev  hyonkim@cisco.com   RESOLVED    FIXED   dpdk/drivers/net/enic/base/vnic_devcmd.h does not compile on musl libc because of type `u_int32_t`  2018/10/2 10:34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">40  DPDK    ethdev  dev@dpdk.org    RESOLVED    FIXED   drivers/net/nfp/nfpcore/nfp-common/nfp_platform.h: does not compile with musl because it uses an internal glibc header  2019/10/3 5:52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">41  DPDK    testpmd dev@dpdk.org    RESOLVED    FIXED   testpmd failed with net_failsafe error  2018/5/10 19:16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">43  DPDK    ethdev  dev@dpdk.org    CONFIRMED    ---    &quot;rte_eth_tx_queue_setup&quot; will be failed if argument &quot;tx_conf&quot; not specified 2020/3/3 13:16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">44  DPDK    examples    pablo.de.lara.guarch@intel.com  RESOLVED    FIXED   examples/l2fwd-crypto : Wrong data length in case of AEAD ciphers   2018/7/17 10:14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">45  DPDK    other   thomas@monjalon.net RESOLVED    WONTFIX Test compilation fails at 2nd iteration after running resource_autotest 2020/6/18 22:37</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">47  DPDK    other   reshma.pattan@intel.com RESOLVED    WONTFIX Mempool performance autotest: Fail [Timeout]    2018/9/14 12:26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">48  DPDK    vhost/virtio    maxime.coquelin@redhat.com  CONFIRMED    ---    Unexpected performance regression since CVE-2018-1059 fix with vector path  2018/9/12 10:48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">50  DPDK    core    anatoly.burakov@intel.com   RESOLVED    FIXED   Secondary process launch is unreliable  2018/11/20 20:29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">51  DPDK    other   thomas@monjalon.net CONFIRMED    ---    make coverage aborts with core dump 2018/7/19 21:33</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">57  DPDK    ethdev  pablo.de.lara.guarch@intel.com  RESOLVED    FIXED   ixgbe crash on detach when no VF is created 2018/7/10 0:22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">58  DPDK    core    ferruh.yigit@intel.com  RESOLVED    FIXED   cppcheck static analyzer warnings   2020/4/26 2:46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">61  DPDK    core    erik.g.carrillo@intel.com   RESOLVED    FIXED   build fails when shared libs enabled and optimization turned off    2018/8/29 20:14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">62  DPDK    other   shreyansh.jain@nxp.com  RESOLVED    WONTFIX Rawdev autotest fails   2018/7/17 13:49</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64  DPDK    testpmd pablo.de.lara.guarch@intel.com  IN_PROGRESS  ---    Bound_promisc_opt:After the confounding mode is turned off, the port can receive data.  2018/10/1 11:37</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">67  DPDK    examples    bruce.richardson@intel.com  RESOLVED    INVALID multi_process/l2fwd_fork failed to compile  2018/11/29 15:39</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">68  DPDK    vhost/virtio    dev@dpdk.org    RESOLVED    INVALID virt    2018/7/19 21:31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">69  DPDK    ethdev  konstantin.ananyev@intel.com    RESOLVED    FIXED   Intel x550 SFP+ fails to update link state  2020/4/26 2:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">70  DPDK    ethdev  meijuanx.zhao@intel.com RESOLVED    FIXED   freebsd build dpdk18.08-rc1 issue   2018/8/3 10:10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">71  DPDK    ethdev  pablo.de.lara.guarch@intel.com  RESOLVED    FIXED   suse build dpdk 18.08-rc1 issue 2020/4/26 2:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">72  DPDK    core    dev@dpdk.org    RESOLVED    INVALID Unable to install dpdk on arm64 2018/7/18 10:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">73  DPDK    other   john.mcnamara@intel.com CONFIRMED    ---    Secondary processes can not set up ports: document limitation and return error in appropriate functions 2018/10/8 15:13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">74  DPDK    ethdev  beilei.xing@intel.com   CONFIRMED    ---    PMD: i40e_dcb_init_configure(): default dcb config fails. err = -53, aq_err = 3 2018/10/22 9:37</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">75  DPDK    core    ferruh.yigit@intel.com  RESOLVED    WONTFIX 16.11 compile fail on RHEL 6.9  2019/6/26 10:04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">76  DPDK    core    anatoly.burakov@intel.com   RESOLVED    FIXED   2MB hugepages with IOMMU and passthrough not working    2018/11/16 15:19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">79  DPDK    other   konstantin.ananyev@intel.com    RESOLVED    FIXED   ACL doesn&#x27;t match a rule with a first `TYPE_MASK` field with low mask when there&#x27;s a large number of rules  2018/9/26 16:57</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">81  DPDK    vhost/virtio    maxime.coquelin@redhat.com  RESOLVED    FIXED   Use of rte_memseg_contig_walk in vhost_kernel.c causes deadlock 2020/4/26 2:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">83  DPDK    ethdev  dev@dpdk.org    CONFIRMED    ---    For RSS flow actions, e1000_ethdev.h uses IGB_MAX_RX_QUEUE_NUM instead of IGB_MAX_RX_QUEUE_NUM_82576    2018/9/30 3:08</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">92  DPDK    ethdev  qi.z.zhang@intel.com    CONFIRMED    ---    i40e RX capabilities include scatter/gather on VF, but not on PF    2018/9/30 3:04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">94  DPDK    other   dev@dpdk.org    RESOLVED    INVALID librte_acl  library: First field in the rule definition can not be other types  2018/9/30 8:16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">95  DPDK    core    anatoly.burakov@intel.com   RESOLVED    FIXED   eal/memory: testpmd failed to start with --socket-mem &gt;  16384 with 2MB huge pages and with memory hotplug  2019/4/15 17:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">96  DPDK    ethdev  viacheslavo@mellanox.com    RESOLVED    FIXED   mlx5: TX error for multi-seg packet where first segment has 14~18 bytes 2020/5/12 15:52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">98  DPDK    cryptodev   declan.doherty@intel.com    RESOLVED    FIXED   wrongly assignment of digest_len    2019/1/9 13:03</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">99  DPDK    ethdev  dev@dpdk.org    CONFIRMED    ---    axgbe driver does not support 1G Copper 1000BASE-T SFPs (Unsupported AN_CL37)   2018/10/31 6:44</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">102 DPDK    core    alejandro.lucero@netronome.com  RESOLVED    FIXED   IOVA mode causes deadlock   2018/11/8 12:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">103 DPDK    testpmd alejandro.lucero@netronome.com  RESOLVED    FIXED   Testpmd with ixgbe device assignment doesn&#x27;t work   2018/11/8 12:46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">105 DPDK    cryptodev   dev@dpdk.org    RESOLVED    FIXED   Cannot create crypto_openssl after vdev_uninit  2019/9/12 18:42</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">107 DPDK    ethdev  rasland@nvidia.com  RESOLVED    INVALID Cannot set rte_flow QUEUE action for VF representor 2019/10/3 5:52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">108 DPDK    ethdev  anatoly.burakov@intel.com   RESOLVED    FIXED   There should be a NULL pointer check about the internal_config.hugefile_prefix  2019/2/22 17:15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">111 DPDK    ethdev  gaetan.rivet@6wind.com  UNCONFIRMED  ---    There maybe some risks to printf  the addr of the map page  2018/12/5 8:17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">112 DPDK    other   anandashish92@gmail.com CONFIRMED    ---    dpdk-18.05 not allowing to create bond interface with name &quot;lan_bond&quot;   2019/1/17 22:21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">113 DPDK    other   dev@dpdk.org    CONFIRMED    ---    pktgen -s option send pcap traffic once 2018/12/1 7:16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">117 DPDK    core    anatoly.burakov@intel.com   RESOLVED    INVALID in case of malloc_elem_alloc should we increment alloc_count (heap-&gt;alloc_count++)? 2018/12/5 17:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">118 DPDK    doc dev@dpdk.org    CONFIRMED    ---    conflicting information for &#x27;Running DPDK Applications Without Root Privileges&#x27; 2018/12/10 11:35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">119 DPDK    ethdev  dev@dpdk.org    RESOLVED    INVALID I210 Gigabit is returning with -22 when vfio-pci is used for bind   2018/12/6 17:07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">120 DPDK    core    dev@dpdk.org    RESOLVED    WONTFIX secondary fails failure without option &#x27;--legacy-mem&#x27;   2018/12/6 15:43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">121 DPDK    ethdev  konstantin.ananyev@intel.com    CONFIRMED    ---    In ixgbe_tx_free_bufs function the variable free on stack is used before initialization 2019/1/9 16:07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">139 lab dashboard   ci@dpdk.org CONFIRMED    ---    When measurements throws a 404, the dashboard throws a 500  2018/12/10 19:52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">142 lab UNH infra   ci@dpdk.org RESOLVED    WONTFIX Creating a user requires restarting sssd on leaf node for them to log in    2019/11/19 21:46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">162 lab dashboard   ci@dpdk.org CONFIRMED    ---    Private files can&#x27;t be downloaded via CLI easily    2018/12/10 20:19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">164 DPDK    ethdev  dev@dpdk.org    CONFIRMED    ---    configure rx queue for JUMBO frame returns warning as offload is 0x0, but eth_pcap_rx_jumbo is present  2018/12/11 17:21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">165 DPDK    other   arnon@qwilt.com RESOLVED    FIXED   checkpatches.sh doesn&#x27;t detect rte_exit() / rte_panic() instances   2020/4/26 2:46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">166 lab dashboard   dpdklab@iol.unh.edu RESOLVED    FIXED   patch may fail to apply when it targets different sub-tree other than main tree 2019/11/19 17:32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">174 DPDK    core    anatoly.burakov@intel.com   RESOLVED    FIXED   rte_vfio_dma_map issue in secondary process 2019/2/22 17:19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">175 DPDK    other   dev@dpdk.org    RESOLVED    INVALID DPDK on Azure using `intel-go/nff-go` fails using `hv_netvsc` driver    2020/5/12 15:54</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">176 DPDK    core    dev@dpdk.org    CONFIRMED    ---    secondary process cannot execute  iommu 2018/12/28 6:40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">177 DPDK    ethdev  dev@dpdk.org    RESOLVED    INVALID binding i40e with uio_pci_generic fails for DPDK 19.02.0-rc1    2019/1/10 3:41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">178 DPDK    examples    dev@dpdk.org    RESOLVED    WONTFIX l2fwd application does not work with option &#x27;-q&#x27;    2019/5/6 6:59</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">182 DPDK    doc dev@dpdk.org    RESOLVED    FIXED   make doc-guides-pdf fails with error &#x27;make[3]: latexmk: Command not found&#x27;  2019/5/6 6:32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">183 DPDK    other   dev@dpdk.org    CONFIRMED    ---    Problem using cloned rte_mbuf buffers with KNI interface    2019/9/10 21:24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">184 lab job scripts blo@iol.unh.edu CONFIRMED    ---    Update report emails for GA performance runs    2020/6/30 20:25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">185 DPDK    core    dev@dpdk.org    CONFIRMED    ---    PVP zero-loss performance degradation without --legacy-mem  2019/1/10 12:27</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">186 DPDK    core    maxime.coquelin@redhat.com  CONFIRMED    ---    Huge testpmd startup time without --legacy-mem option   2019/3/11 17:33</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">187 DPDK    core    dev@dpdk.org    CONFIRMED    ---    Merge linux and bsd eal_thread.c which are same 2020/6/10 8:19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">189 DPDK    eventdev    jerinjacobk@gmail.com   CONFIRMED    ---    RTE Timer Adapter Use After Free    2019/7/31 6:10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">190 lab dashboard   ci@dpdk.org RESOLVED    WONTFIX Investigate some apply errors with unclear root cause   2019/1/16 20:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192 DPDK    mk  thomas@monjalon.net CONFIRMED    ---    construct function miss for  build with static library  2019/1/18 3:28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">195 lab dashboard   ci@dpdk.org RESOLVED    FIXED   &quot;Applied on&quot; commit id and &quot;baseline&quot; commit id issues  2019/2/5 19:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">197 lab dashboard   ci@dpdk.org RESOLVED    FIXED   can we display deeper history   2019/2/11 9:48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">198 lab job scripts ci@dpdk.org RESOLVED    FIXED   sent patchwork reports on build failures too    2019/1/30 15:04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">200 dpdk-burst-replay   doc jonathan.ribas@fraudbuster.mobi RESOLVED    FIXED   mismatch in documentation and makefile  2019/2/1 9:35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">201 dpdk-burst-replay   app vipin.varghese@intel.com    RESOLVED    INVALID main.c uses &#x27;struct pcap_ctx&#x27;   2019/4/1 6:59</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">202 dpdk-burst-replay   app jonathan.ribas@fraudbuster.mobi RESOLVED    FIXED   in function check_needed_memory for dpdk-&gt;mbuf_sz does it get aligned?  2019/5/3 17:10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">203 dpdk-burst-replay   app jonathan.ribas@fraudbuster.mobi RESOLVED    FIXED   if user passes numa id, why is pcicards under the same not populated    2019/5/3 17:21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">205 DPDK    other   dev@dpdk.org    RESOLVED    FIXED   make test fails with DPDK 19.02 (KeyError: &#x27;Command&#x27;)   2019/3/9 12:32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">206 lab UNH infra   dpdklab@iol.unh.edu RESOLVED    FIXED   Set up systems for OVS ovs_perf testing at UNH  2019/11/19 20:10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">207 lab dashboard   ci@dpdk.org RESOLVED    WORKSFORME  JS homepage TypeError with Chrome   2019/11/19 17:28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">208 lab dashboard   ci@dpdk.org RESOLVED    FIXED   Some “Not Applicable” items looks wrong 2019/2/15 18:34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">209 lab dashboard   ci@dpdk.org CONFIRMED    ---    Main tree is not up to date when patch sent, which cause merge error    2019/2/12 18:10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">211 lab dashboard   ci@dpdk.org RESOLVED    INVALID Invalid link for &quot;applied on&quot; sha1  2019/2/13 17:13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">212 lab job scripts ferruh.yigit@intel.com  RESOLVED    FIXED   add a new testcase: autotest, which runs a defined set of unit tests    2020/7/1 20:06</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">213 DPDK    core    ferruh.yigit@intel.com  RESOLVED    WONTFIX Fix the problem of KNI device (Net Stack kthread) keeps dropping packets (stats.tx_dropped++) and TX thread logs &quot;KNI: Out of memory&quot;   2019/4/25 19:34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">214 DPDK    core    anatoly.burakov@intel.com   RESOLVED    INVALID There should be a NULL pointer check about the  malloc_elem_alloc   2019/2/25 12:57</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">215 DPDK    core    dev@dpdk.org    RESOLVED    INVALID IPC socket of 2 primary processes may conflict  2019/2/26 17:19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">217 DPDK    ethdev  debugnetiq1@yahoo.ca    RESOLVED    INVALID DPDK-19.02 will not build when MLX4/MLX5 is enabled. In comparison DPDK 18-11 builds fine   2019/7/11 10:16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">218 DPDK    ethdev  debugnetiq1@yahoo.ca    RESOLVED    FIXED   DPDK 18.02 (stable) won&#x27;t compile when MLX4/MLX5 support is enabled 2019/7/11 10:21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">219 DPDK    ethdev  debugnetiq1@yahoo.ca    RESOLVED    INVALID DPDK 18.11 builds with MLX4/MLX5 support but testpmd won&#x27;t recognize the device 2019/7/11 9:48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">221 DPDK    examples    ferruh.yigit@intel.com  RESOLVED    WONTFIX How to classifier ipv6 packets with  flow classification library    2019/4/8 15:31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">222 DPDK    other   reshma.pattan@intel.com RESOLVED    FIXED   When setting CONFIG_RTE_LIBRTE_PDUMP=n, build fails with &quot;undefined reference to `test_pdump&#x27;&quot;  2020/2/10 11:38</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">223 lab job scripts ci@dpdk.org RESOLVED    FIXED   Using wrong/old commit id of the tree to apply the patch    2019/11/19 18:07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">224 lab job scripts ci@dpdk.org RESOLVED    WONTFIX Possibly wrong regression report    2020/4/21 16:01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">225 DPDK    testpmd dev@dpdk.org    RESOLVED    FIXED   ethdev API for firmware version request is not tested   2020/4/26 2:18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">227 DPDK    ethdev  dev@dpdk.org    CONFIRMED    ---    Flow control mode on mac Intel Corporation I350 Gigabit Network Connection (rev 01) issues  2019/3/17 12:24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">229 lab job scripts ci@dpdk.org RESOLVED    DUPLICATE   lab scripts should be upstreamed to dpdk-ci repository  2020/4/21 15:57</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">230 lab job scripts ci@dpdk.org CONFIRMED    ---    publish a tutorial about how to deploy a DPDK lab   2019/3/26 15:40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">231 lab job scripts ferruh.yigit@intel.com  RESOLVED    WONTFIX when a sub-tree used as base, two different commit id displayed in logs 2020/7/1 15:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">232 lab dashboard   ci@dpdk.org RESOLVED    FIXED   Should we make it more visible when at least one of the platforms failed?   2019/6/26 16:21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">234 DPDK    core    anatoly.burakov@intel.com   RESOLVED    INVALID dma remapping failed with errno 22 when use &quot;--no-huge&quot; 2019/4/24 12:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">235 DPDK    doc vipin.varghese@intel.com    RESOLVED    FIXED   References section for Algorithms for Routing Lookups and Packet Classification is not working  2019/10/3 5:52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">237 DPDK    examples    dev@dpdk.org    RESOLVED    FIXED   Running test-build.sh Fails on ppc_64 fails due to hard-coded requirement for IXGBE_PMD in examples/vm_power_manager    2020/4/26 2:46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">239 DPDK    examples    dev@dpdk.org    CONFIRMED    ---    ipsec-secgw fails to initialize when librte_ipsec is enabled    2019/4/10 19:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">242 DPDK    core    olivier.matz@6wind.com  RESOLVED    INVALID repeat to calling &#x27;rte_pktmbuf_free&#x27; function, make the mempool exist the same &#x27;rte_mbuf&#x27; obj;  2019/4/9 12:56</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">243 lab UNH infra   ci@dpdk.org RESOLVED    FIXED   DPDK Compilation Coverage   2020/4/21 16:25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">244 lab UNH infra   ci@dpdk.org RESOLVED    FIXED   Running Unit Testing    2020/1/14 18:59</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">249 DPDK    core    ferruh.yigit@intel.com  RESOLVED    FIXED   kni cause a kernel crash on avx512 supported platform with gcc 8.3.1    2019/6/26 10:08</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">250 DPDK    ethdev  martin.weiser@allegro-packets.com   RESOLVED    FIXED   i40e: rte_eth_link_get_nowait() on X722 returns wrong link_speed value 20000 instead of 10000   2019/5/7 8:41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">251 dpdk-burst-replay   app jonathan.ribas@fraudbuster.mobi RESOLVED    FIXED   Infinite mode not working   2019/4/11 9:17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">252 DPDK    ethdev  keith.wiles@intel.com   RESOLVED    FIXED   Possible access to invalid FDs in rte_eth_tap   2020/4/26 2:46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">253 DPDK    other   dev@dpdk.org    RESOLVED    FIXED   Unable to run DPDK test with &quot;make test&quot; command    2020/4/26 2:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">255 DPDK    ethdev  dev@dpdk.org    RESOLVED    INVALID Mbuf leak when rte_port_ethdev_writer_tx_bulk is called with more than 32 packets   2019/5/22 21:49</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">257 DPDK    core    anatoly.burakov@intel.com   CONFIRMED    ---    ipc: rte_mp_request_sync return 0 on error. 2019/5/1 6:06</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">260 DPDK    other   pablo.de.lara.guarch@intel.com  RESOLVED    DUPLICATE   DPDK 18.11 lockfree 哈希表的 bug    2019/5/5 3:32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">261 DPDK    other   dharmik.thakkar@arm.com RESOLVED    FIXED   bug on lock-free hash API rte_hash_free_key_with_position   2019/5/16 18:35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">262 DPDK    vhost/virtio    maxime.coquelin@redhat.com  RESOLVED    FIXED   Error: Invalid memory for eth_virtio_dev_init() 2019/5/2 9:31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">263 DPDK    ethdev  konstantin.ananyev@intel.com    CONFIRMED    ---    ixgbe does not support 10GBASE-T copper SFP+    2019/5/1 20:23</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">264 DPDK    ethdev  yskoh@mellanox.com  RESOLVED    FIXED   ring_pmd fails to properly release used port on 17.11 branch    2020/6/18 22:16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">266 DPDK    other   security@dpdk.org   RESOLVED    FIXED   CVE-2019-14818  2020/5/18 14:03</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">267 DPDK    other   security@dpdk.org   RESOLVED    FIXED   librte_vhost: Interger overflow in vhost_user_set_log_base()    2020/5/18 16:34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">268 DPDK    other   security@dpdk.org   RESOLVED    FIXED   librte_vhost: Integer truncation in vhost_user_check_and_alloc_queue_pair() 2020/5/18 16:35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">269 DPDK    other   security@dpdk.org   RESOLVED    FIXED   librte_vhost: Missing inputs validation in Vhost-crypto 2020/5/18 16:36</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">270 DPDK    other   security@dpdk.org   RESOLVED    FIXED   librte_vhost: Malicious guest could cause segfault by sending invalid Virtio descriptor 2020/5/18 16:37</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">271 DPDK    other   security@dpdk.org   RESOLVED    FIXED   librte_vhost: VHOST_USER_GET_INFLIGHT_FD message flooding to result in a DOS    2020/5/18 16:38</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">276 DPDK    core    mattias.ronnblom@ericsson.com   RESOLVED    FIXED   rte_rand() bit 31 and 63 are always zero    2019/6/30 7:17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">277 DPDK    eventdev    nikhilprao@gmail.com    RESOLVED    FIXED   eventdev sw rx adapter enqueue buffer may store packets indefinitely    2020/4/26 2:46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">279 DPDK    examples    ferruh.yigit@intel.com  RESOLVED    FIXED   Unaligned memory access when reading ipv6 header    2020/4/26 2:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">281 DPDK    testpmd dev@dpdk.org    RESOLVED    INVALID BPF: Linking error in librte_bpf    2019/5/20 17:03</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">282 DPDK    core    dev@dpdk.org    RESOLVED    FIXED   Fix missing headers in FreeBSD CURRENT build    2019/7/12 18:07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">283 DPDK    other   michel@digirati.com.br  RESOLVED    FIXED   BPF: array ins_chk is missing an entry  2019/7/15 21:01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">286 lab job scripts ci@dpdk.org RESOLVED    FIXED   Run clang compilation on windows    2020/4/21 16:22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">287 DPDK    ethdev  stephen@networkplumber.org  IN_PROGRESS  ---    netvsc PMD/dpdk/azure: Driver lockup with multi-queue configuration 2020/5/12 15:59</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">289 DPDK    ethdev  dev@dpdk.org    RESOLVED    FIXED   mlx5: 100G interface capability not recognized  2019/7/11 10:23</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">290 DPDK    vhost/virtio    maxime.coquelin@redhat.com  RESOLVED    FIXED   RX packets in Virtio are corrupted in case of split to several mbufs    2019/6/6 11:30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">291 DPDK    ethdev  qi.z.zhang@intel.com    CONFIRMED    ---    FM10K dpdk driver - memory leak with KNI interface - interface up/down  2019/7/30 12:35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">293 lab dashboard   ci@dpdk.org CONFIRMED    ---    Can we add a filter for status, to be able to see only some patches with specific status    2019/6/26 9:55</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">294 DPDK    ethdev  dev@dpdk.org    RESOLVED    DUPLICATE   max_rx_pkt_len issues with i40e dpdk SRIOV driver (net_i40e_vf).    2019/9/12 7:07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">295 DPDK    ethdev  dev@dpdk.org    RESOLVED    DUPLICATE   max_rx_pkt_len issues with i40e dpdk SRIOV driver net_i40e_vf.  2019/9/12 7:07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">298 DPDK    other   konstantin.ananyev@intel.com    RESOLVED    FIXED   BPF: eval_call() is messing bounds of return types different of RTE_BPF_ARG_RAW 2019/7/15 20:50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">299 DPDK    ethdev  xiao.zhang@intel.com    RESOLVED    FIXED   Intel i219 reset hang   2019/7/24 4:32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">300 DPDK    ethdev  xiao.zhang@intel.com    RESOLVED    FIXED   Intel i219 buffer overrun errata fix    2019/7/19 8:16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">302 lab dashboard   ci@dpdk.org CONFIRMED    ---    Google&#x27;s Webcache version of the website does not work  2019/7/1 22:26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">303 DPDK    meson   ci@dpdk.org RESOLVED    FIXED   meson-0.51.0 isn&#x27;t building docs    2020/4/26 2:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">307 DPDK    other   ido@cgstowernetworks.com    RESOLVED    FIXED   ACL (librte_acl) field of type RANGE and size U32 is not working properly   2020/4/26 2:40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">308 DPDK    ethdev  donald_lee@trendmicro.com   RESOLVED    FIXED   Tap driver may leave some pending frame there but not retrieve  2019/11/12 11:09</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">316 DPDK    other   david.hunt@intel.com    RESOLVED    FIXED   livelock causes librte_distributor unit test to hang    2019/7/29 23:27</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">320 DPDK    ethdev  matan@mellanox.com  RESOLVED    FIXED   mlx4: info get fails in secondary process   2020/4/26 2:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">321 DPDK    examples    konstantin.ananyev@intel.com    RESOLVED    FIXED   BPF: Errors compiling example BPF programs  2020/4/26 2:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">322 DPDK    core    david.marchand@redhat.com   RESOLVED    FIXED   eal: ctrl thread calculation assumes 1:1 mapping between cpu and lcore id   2019/7/31 10:22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">323 DPDK    core    dev@dpdk.org    RESOLVED    DUPLICATE   eal: ctrl thread calculation assumes 1:1 mapping between cpu and lcore id   2019/7/29 15:52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">324 DPDK    examples    stephen@networkplumber.org  RESOLVED    FIXED   eal/cmdline_autotest failed 2020/3/17 0:52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">334 DPDK    ethdev  viacheslavo@mellanox.com    RESOLVED    INVALID ConnectX-4/mlx5 crashes under high load in rxq_cq_decompress_v()    2020/6/23 14:21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">335 DPDK    ethdev  hemant.agrawal@nxp.com  RESOLVED    FIXED   Compilation fails when HEADROOM is 0    2020/4/26 2:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">336 DPDK    other   ullas-d.bhat@hpe.com    CONFIRMED    ---    Unable to exit DPDK application when running as separate thread.    2019/8/14 16:34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">337 DPDK    vhost/virtio    maxime.coquelin@redhat.com  CONFIRMED    ---    Live migration with dpdk(in host)+vhost-user+dpdk(in guest) fails: Failed to load virtio-net:virtio 2019/9/17 9:44</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">338 DPDK    core    abhijeet080808@gmail.com    UNCONFIRMED  ---    IP Reassembly with more 4 packets Segfault  2019/8/15 16:44</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">339 DPDK    ethdev  abhishek.sachan@altran.com  RESOLVED    FIXED   net/af_packet: af_packet driver is leaving stale socket after device is removed 2020/4/26 2:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">340 DPDK    examples    dev@dpdk.org    RESOLVED    FIXED   Can&#x27;t build examples in Ubuntu 18 after commit 4131ad5db from 03/07/2019    2019/10/4 17:28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">343 DPDK    ethdev  3chas3@gmail.com    UNCONFIRMED  ---    Couldn&#x27;t receive LACP PDU when enable dedicated queue   2019/9/4 20:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">344 DPDK    meson   dev@dpdk.org    CONFIRMED    ---    Broken CPU feature discovery for armv8  2019/9/5 21:32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">345 DPDK    other   yipeng1.wang@intel.com  RESOLVED    FIXED   rte_hash returns invalid key if the number of entries is not a power of 2   2019/11/27 15:02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">347 DPDK    ethdev  rasland@nvidia.com  CONFIRMED    ---    TAPPMD frees buffers it fails to send   2020/6/23 14:24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">348 DPDK    ethdev  beilei.xing@intel.com   UNCONFIRMED  ---    i40e: packets greater than 1024B are dropped due to a integer overflow  2019/10/14 10:46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">349 DPDK    ethdev  beilei.xing@intel.com   UNCONFIRMED  ---    i40e/i40evf: Allow bad packets to reach application (SBP)   2019/9/25 10:54</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">350 DPDK    ethdev  konstantin.ananyev@intel.com    UNCONFIRMED  ---    ixgbe: incorrect speed capabilities advertised for X553 devices 2019/9/20 13:53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">351 DPDK    meson   dev@dpdk.org    RESOLVED    FIXED   When RTE_LIBRTE_PCAP_PMD is enabled RTE_PORT_PCAP is not enabled for rte_port_source_sink.c 2019/10/3 5:53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">353 DPDK    core    hemant.agrawal@nxp.com  RESOLVED    FIXED   Missing null checks 2020/4/25 23:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">354 DPDK    ethdev  dev@dpdk.org    UNCONFIRMED  ---    net/tap can not get rx packet drop stats when packets be dropped in kernel (net/driver/tun.c)   2020/5/13 14:08</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">357 DPDK    ethdev  dev@dpdk.org    RESOLVED    FIXED   ppc64: i40e not compiling on RHEL7/CentOS7  2020/6/16 12:40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">358 DPDK    ethdev  michael.pfeiffer@tu-ilmenau.de  RESOLVED    INVALID KNI packets dropped on Bluefield SDK    2020/6/23 14:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">359 DPDK    meson   bruce.richardson@intel.com  RESOLVED    WORKSFORME  Makefile calls &#x27;pkg-config --path&#x27;  2019/11/6 15:56</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">360 DPDK    examples    marko.kovacevic@intel.com   RESOLVED    FIXED   FIPS application fails for AES-GCM test vectors with non-zero AAD   2020/3/2 14:42</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">361 DPDK    ethdev  ferruh.yigit@intel.com  CONFIRMED    ---    device reset handling with igb_uio  2020/8/5 9:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">362 DPDK    core    xiao.zhang@intel.com    UNCONFIRMED  ---    rte_pktmbuf_attach_extbuf does not update pkt_len   2019/12/26 13:57</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">367 DPDK    doc ajit.khaparde@broadcom.com  RESOLVED    FIXED   extra character in document l2_forward_event.rst    2020/4/26 2:40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">368 DPDK    doc dev@dpdk.org    RESOLVED    DUPLICATE   missing character in document l2_forward_event.rst  2019/11/22 5:22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">370 DPDK    core    anatoly.burakov@intel.com   CONFIRMED    ---    Cannot hotplug VFIO devices if VFIO driver was not loaded at init   2019/11/27 11:19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">373 DPDK    ethdev  xiao.zhang@intel.com    UNCONFIRMED  ---    i40e: TSO breaks for packets larger than 16k    2020/5/28 13:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">374 DPDK    meson   alialnu@mellanox.com    IN_PROGRESS  ---    Meson build failure due to libibverbs-dev upgrade (version=45mlnx1-1.45101) 2020/6/23 14:24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">376 DPDK    testpmd jerryhao@os.amperecomputing.com RESOLVED    FIXED   mlx5 / DPDK 19.11 : single core throughput dropped at testpmd (VS DPDK 19.08)   2020/6/23 14:17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">377 DPDK    cryptodev   dev@dpdk.org    RESOLVED    FIXED   CRYPTODEV: set_sym_session_private_data() line 489: Set private data for driver 0 not allowed   2020/4/26 2:40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">380 DPDK    core    dev@dpdk.org    CONFIRMED    ---    memory subsystem leaks file descriptors 2020/1/7 11:29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">381 DPDK    core    dev@dpdk.org    UNCONFIRMED  ---    hugepages not detached on cleanup   2020/1/7 11:27</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">382 DPDK    ethdev  dev@dpdk.org    UNCONFIRMED  ---    rte_eth: rx/tx callbacks invoked without lock protection    2020/1/10 4:05</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">383 DPDK    vhost/virtio    eupm90@gmail.com    RESOLVED    FIXED   dpdk virtio_user lack of notifications make vhost_net+napi stops tx buffers 2020/2/6 9:02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">384 DPDK    ethdev  dev@dpdk.org    RESOLVED    FIXED   netvsc PMD crashes in secondary process in dev_info_get 2020/3/17 0:58</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">386 DPDK    core    siddsr@gmail.com    UNCONFIRMED  ---    Big spike in DPDK process VSZ since release 18.05.1 2020/2/5 20:53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">387 DPDK    ethdev  jerin.jacob@caviumnetworks.com  RESOLVED    FIXED   Disabling octeontx in meson leads to meson configure failure    2020/4/26 2:02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">388 DPDK    ethdev  qi.z.zhang@intel.com    RESOLVED    FIXED   ixgbe: link state race condition can occur when starting a fiber port   2020/5/12 4:25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">390 DPDK    ethdev  matan@mellanox.com  RESOLVED    WONTFIX netvsc: There are always too many packets in tx-drop queue in testpmd tx-side   2020/3/16 22:43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">391 DPDK    other   pierrick.louin@orange.com   UNCONFIRMED  ---    The dpdk-devbind.py tool crashes if some NIC property contains a unicode character - Patch proposal 2020/2/5 22:15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">392 DPDK    examples    dev@dpdk.org    RESOLVED    FIXED   l3fwd fails to run with eventdev    2020/2/7 11:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">394 DPDK    cryptodev   thomas@monjalon.net RESOLVED    FIXED   Build of librte_cryptodev with GCC 10.0.1 fails 2020/5/7 0:06</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">395 DPDK    other   dev@dpdk.org    RESOLVED    FIXED   Build of hinic with GCC 10.0.1 fails on aarch64 2020/3/20 13:42</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">396 DPDK    other   dev@dpdk.org    RESOLVED    FIXED   Build of octeontx2 with GCC 10.0.1 fails on armv7   2020/5/19 11:37</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">398 DPDK    ethdev  srn@nexatech.fr RESOLVED    FIXED   MLX5 device won&#x27;t start with no RX queue    2020/2/21 20:29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">399 DPDK    ethdev  konstantin.ananyev@intel.com    UNCONFIRMED  ---    ixgbe X540 PMD RSS is zero for NFSv3 NULL reply 2020/4/14 21:35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">400 DPDK    testpmd dev@dpdk.org    VERIFIED    FIXED   start testpmd with vmxnet3 can&#x27;t receive and forward packets    2020/5/12 9:41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">401 DPDK    other   olivier.matz@6wind.com  UNCONFIRMED  ---    unit_tests: mempool_autotest failed with shared mode library    2020/2/21 20:26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">402 DPDK    ethdev  wei.zhao1@intel.com RESOLVED    FIXED   i40e: cannot add rte_flow with ether_type = ARP 2020/4/29 10:12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">403 DPDK    ethdev  wei.zhao1@intel.com RESOLVED    FIXED   i40e: cannot add 2 rte_flows with one matching TCP sport and the other dport    2020/4/29 10:13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">404 DPDK    ethdev  wei.zhao1@intel.com RESOLVED    FIXED   i40e: &quot;i40e_res_pool_free(): Failed to find entry&quot; error when rte_flow are flushed  2020/4/29 10:14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">406 DPDK    examples    dev@dpdk.org    UNCONFIRMED  ---    ethtool doesn&#x27;t compile if you installed with ninja rather than make    2020/2/24 9:50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">409 DPDK    testpmd viacheslavo@mellanox.com    CONFIRMED    ---    testpmd sometimes does not correctly show RX-missed on Mellanox NICs    2020/6/23 14:12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">410 DPDK    other   ferruh.yigit@intel.com  UNCONFIRMED  ---    KNI deadlocks when used with Mellanox device    2020/2/26 19:14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">411 lab UNH infra   ci@dpdk.org RESOLVED    FIXED   Intel performance testing currently down    2020/4/7 15:22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">412 lab UNH infra   ci@dpdk.org RESOLVED    FIXED   NXP performance testing currently down  2020/4/21 15:12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">413 DPDK    core    dev@dpdk.org    RESOLVED    INVALID rte_ring: capacity was set incorrectly  2020/8/14 12:40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">414 DPDK    ethdev  alialnu@mellanox.com    UNCONFIRMED  ---    mlx5: test/debug_autotest failed when enable CONFIG_RTE_LIBRTE_MLX5_PMD=y   2020/6/18 22:28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">415 lab job scripts ci@dpdk.org RESOLVED    FIXED   [dpdk-ci] encoding issue when compiling ovs 2020/3/4 9:05</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">416 DPDK    ethdev  neruda@netcope.com  RESOLVED    FIXED   nfb build failed - missing rpms?    2020/3/18 9:15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">417 DPDK    cryptodev   pablo.de.lara.guarch@intel.com  RESOLVED    FIXED   CentOS7/RHEL7 nasm version too old for intel-ipsec-mb   2020/5/27 12:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">419 DPDK    other   thomas@monjalon.net UNCONFIRMED  ---    usertools/dpdk-setup.sh crashes on non-alphanumeric input   2020/3/20 19:12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">421 DPDK    core    thomas@monjalon.net RESOLVED    FIXED   gcc 10.0.1 stringops-overflow warnings  2020/5/7 0:06</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">422 DPDK    doc john.mcnamara@intel.com RESOLVED    FIXED   Typing error in patches.rst in doc/guides/contributing at line 177  2020/5/27 20:32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">424 DPDK    other   drc@linux.vnet.ibm.com  RESOLVED    FIXED   malloc_autotest fails with message &quot;Unexpected - ptr4 != ptr3&quot;  2020/4/26 2:40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">430 DPDK    ethdev  beilei.xing@intel.com   RESOLVED    INVALID i40e has wrong byte order in rte_flow_item_eth (ethdev) 2020/3/31 6:15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">432 DPDK    other   john.mcnamara@intel.com CONFIRMED    ---    Entering Non-numeric value for Setup hugepage mappings,  dpdk-setup.sh still goes to create_mnt_huge function and prints misleading info    2020/4/9 7:21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">434 DPDK    testpmd dev@dpdk.org    UNCONFIRMED  ---    bps calculation does not fit in 64 bit  2020/4/22 19:31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">436 DPDK    ethdev  jgrajcia@cisco.com  CONFIRMED    ---    rte_eth_promiscuous_enable fails for memif on l2fwd 2020/4/28 4:18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">437 DPDK    ethdev  dev@dpdk.org    CONFIRMED    ---    memif pmd, does not cleanup on primary application restart  2020/5/13 15:43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">438 DPDK    ethdev  dev@dpdk.org    UNCONFIRMED  ---    memif sock does not honor file-prefix   2020/7/28 11:22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">440 DPDK    ethdev  mohsinshaikh@niometrics.com RESOLVED    FIXED   net/mlx5: Read of &quot;out_of_buffer&quot; using fopen/fscanf/fclose causing TLB shootdowns due to mmap/munmap   2020/4/25 4:05</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">444 DPDK    core    stephen@networkplumber.org  IN_PROGRESS  ---    DPDK fails to receive packets in Azure when using more than 3 transmit queues   2020/4/16 18:56</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">445 SPP cli oda@valinux.co.jp   RESOLVED    FIXED   pipe can not be added by CLI if the spp_primary does not have the forwarder 2020/6/9 7:28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">446 DPDK    core    dev@dpdk.org    RESOLVED    FIXED   rte_lcore_index(-1) returns invalid data for non DPDK thread.   2020/7/9 9:01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">450 DPDK    testpmd honnappa.nagarahalli@arm.com    RESOLVED    FIXED   wrong report for cycles/pkt or pps  2020/7/9 9:01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">452 DPDK    core    yipeng1.wang@intel.com  RESOLVED    INVALID cuckoo hash gcc10 warning   2020/4/23 21:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">456 SPP ctl yasufum.o@gmail.com CONFIRMED    ---    spp with python2 has error  2020/4/24 4:18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">458 DPDK    meson   dev@dpdk.org    RESOLVED    FIXED   Windows server 2019 UNH CI fails    2020/4/22 10:26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">460 lab UNH infra   ci@dpdk.org RESOLVED    FIXED   Broadcom performance testing being setup    2020/5/28 23:15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">462 DPDK    other   dev@dpdk.org    VERIFIED    FIXED   command kvargs_autotest excute failed on freebsd with gcc and clang 2020/5/12 8:25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">464 DPDK    other   l.wojciechow@partner.samsung.com    RESOLVED    FIXED   In test app running mbuf_autotest after running service_autotest causes terminal to get stuck   2020/7/9 9:01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">465 DPDK    testpmd dev@dpdk.org    RESOLVED    INVALID app/test compile failed with gcc and clang  2020/5/13 10:41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">466 lab UNH infra   ci@dpdk.org RESOLVED    FIXED   Mellanox build errors occur randomly    2020/6/11 17:27</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">467 lab UNH infra   ci@dpdk.org RESOLVED    FIXED   Intel baseline pulling incorrect numbers    2020/4/30 16:07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">469 DPDK    cryptodev   hemant.agrawal@nxp.com  RESOLVED    FIXED   crypto/dpaa: gcc 10 linker fails for fno-common 2020/5/19 11:37</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">470 DPDK    ethdev  dev@dpdk.org    UNCONFIRMED  ---    vmxnet3 pmd cannot received icmp6 ns packet 2020/5/11 9:31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">475 DPDK    other   dev@dpdk.org    UNCONFIRMED  ---    failure in `EAL flags autotest` 2020/5/14 4:34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">477 DPDK    doc dev@dpdk.org    RESOLVED    FIXED   Typing error in index.rst of doc/guides/eventdevs at line 8 2020/5/23 7:46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">480 lab dashboard   ci@dpdk.org CONFIRMED    ---    No data points in Grafana dashboard 2020/5/19 15:59</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">481 DPDK    other   ferruh.yigit@intel.com  RESOLVED    DUPLICATE   [dpdk-20.05]kni/ifconfig:Failed to change vEth0_0 MTU on powerville and springville 2020/5/21 10:16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">482 DPDK    other   ferruh.yigit@intel.com  RESOLVED    FIXED   [dpdk-20.05]kni/ifconfig:Failed to change vEth0_0 MTU on powerville and springville 2020/5/25 7:15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">483 DPDK    ethdev  iobeyond@126.com    UNCONFIRMED  ---    Bond 8023ad lacp handshake sometimes fail   2020/5/31 4:37</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">487 DPDK    core    dev@dpdk.org    UNCONFIRMED  ---    Worse performance with DPDK driver when MTU is set to 2022 or less  2020/6/10 22:41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">490 lab UNH infra   blo@iol.unh.edu CONFIRMED    ---    Make scripts capture trex and dts version on test   2020/6/30 22:26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">491 DPDK    other   dev@dpdk.org    UNCONFIRMED  ---    Timers synchronously resetting or stopping other timers as part of their callback can cause hangs   2020/7/29 10:11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">493 lab Intel Lab   zhaoyan.chen@intel.com  RESOLVED    FIXED   Failures reported by Intel CI for series 10551  2020/7/16 15:27</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">494 DPDK    core    dev@dpdk.org    UNCONFIRMED  ---    rte_pktmbuf_pool_create returns EINVAL instead of ENOMEM in rte_errno when not enough huge pages memory 2020/7/2 7:50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">497 lab job scripts lylavoie@iol.unh.edu    RESOLVED    FIXED   Reporting format per patchset   2020/8/18 22:43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">498 DPDK    meson   beilei.xing@intel.com   RESOLVED    FIXED   can not start testpmd after use meson/ninja build 32-bit app on x86 system  2020/7/6 17:09</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">504 lab UNH infra   alialnu@mellanox.com    CONFIRMED    ---    Upgrade DTS version on Mellanox system  2020/7/9 15:40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">506 DPDK    ethdev  frederic.coiffier@6cure.com RESOLVED    FIXED   i40e: Fix for rte_eth_dev_get_module_eeprom()   2020/7/16 5:41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">507 DPDK    vhost/virtio    dev@dpdk.org    IN_PROGRESS  ---    virtio perf decrease and interrupt abnormal 2020/7/22 17:14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">508 lab Travis CI   aconole@bytheb.org  IN_PROGRESS  ---    Missing Reports from Travis CI  2020/7/16 15:16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">509 DPDK    mk  ajit.khaparde@broadcom.com  RESOLVED    FIXED   [dpdk-20.08] make failed with cflags -O1    2020/8/3 14:09</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">510 DPDK    vhost/virtio    dev@dpdk.org    UNCONFIRMED  ---    Virtio driver breaks all apps which use ETH_MQ_RX_RSS   2020/7/17 22:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">512 DPDK    cryptodev   roy.fan.zhang@intel.com UNCONFIRMED  ---    [dpdk-20.08]Crypto:fips_cryptodev test failed for TDES on aesni_mb, openssl and qat PMD 2020/8/7 5:06</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">513 DPDK    testpmd dev@dpdk.org    RESOLVED    DUPLICATE   [dpdk-20.08]tx_preparation/tx_preparation:IPV6/TCP packets TSO checksum incorrect   2020/7/23 7:26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">514 DPDK    testpmd arybchenko@solarflare.com   RESOLVED    FIXED   [dpdk-20.08]tx_preparation/tx_preparation:IPV6/TCP packets TSO checksum incorrect   2020/7/29 4:46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">516 DPDK    ethdev  jia.guo@intel.com   UNCONFIRMED  ---    Multiple Intel Ethernet drivers do not conform to rte_eth_rx_burst() API    2020/8/3 7:58</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">519 DPDK    meson   shahafs@mellanox.com    RESOLVED    FIXED   DPDK 20.08-rc3 meson build fails with MLNX_OFED_LINUX-5.1-0.6.6.0   2020/8/4 14:38</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">520 DPDK    ethdev  jia.guo@intel.com   UNCONFIRMED  ---    i40e: UDP PTPv2 packets sent to port 320 not timestamped    2020/8/3 19:32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">521 DPDK    ethdev  jia.guo@intel.com   UNCONFIRMED  ---    i40e: incorrect byte counters   2020/8/8 0:16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">522 DPDK    ethdev  mk@semihalf.com UNCONFIRMED  ---    Performance degradation on AWS ena driver   2020/8/17 17:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">523 DPDK    vhost/virtio    dev@dpdk.org    UNCONFIRMED  ---    vhost iotlb cache incorrectly assumes to be single consumer 2020/8/10 15:56</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">524 DPDK    ethdev  dev@dpdk.org    UNCONFIRMED  ---    mlx5 pmd  crash, mlx5_rxte_vec_sse.h# rxq_cq_decompress_v   2020/8/13 13:04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">525 lab Intel Lab   ci@dpdk.org UNCONFIRMED  ---    Change CI scripts due to branch name changed from &quot;master&quot; to &quot;main&quot;    2020/8/18 7:15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">526 DPDK    ethdev  dev@dpdk.org    UNCONFIRMED  ---    ixgbe: X550 flow type ETH / VLAN / RAW not supported    2020/8/14 12:06</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">527 lab UNH infra   blo@iol.unh.edu RESOLVED    FIXED   Update SPDK branch  2020/8/18 22:44</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">11  DPDK    cryptodev   dev@dpdk.org    RESOLVED    FIXED   crypto_preformance_test: core dumped    2018/2/7 13:10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">19  DPDK    core    solal.pirelli@gmail.com RESOLVED    FIXED   Crash on initialization if first RTE_MAX_LCORE cores are disabled   2019/2/1 11:56</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">23  DPDK    ethdev  konstantin.ananyev@intel.com    RESOLVED    WONTFIX Ixgbe driver writes to reserved bit in the EIMC register    2018/10/18 9:40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">24  DPDK    ethdev  konstantin.ananyev@intel.com    RESOLVED    WONTFIX Ixgbe driver sets unknown bit of the 82599&#x27;s SW_FW_SYNC register    2018/10/18 9:41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">30  DPDK    cryptodev   wisamm@mellanox.com RESOLVED    WONTFIX Compilation error while disabling crypto device library 2020/6/18 22:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">36  DPDK    ethdev  anatoly.burakov@intel.com   RESOLVED    FIXED   drivers/bus/pci/linux/pci_vfio.c does not compile when compilation strictly fails on warnings   2018/11/20 16:27</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">46  DPDK    other   dev@dpdk.org    CONFIRMED    ---    Reciprocal division: Fail [Crash]   2018/5/11 12:06</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">52  DPDK    ethdev  ferruh.yigit@intel.com  RESOLVED    FIXED   Bonding PMD may fail to accept new slaves in certain conditions 2019/6/26 10:21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">66  DPDK    ethdev  thomas@monjalon.net CONFIRMED    ---    Secondary process must have exact same whitelist &quot;-w&quot; list  2018/6/26 1:14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">78  DPDK    doc dev@dpdk.org    RESOLVED    FIXED   Mismatch between return value and documentation for `rte_hash_lookup_data` (cuckoo hashing implementation)  2018/8/7 19:34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">84  DPDK    core    anatoly.burakov@intel.com   RESOLVED    FIXED   Primary process broadcasts vdevs during each secondary&#x27;s vdev scan  2018/11/20 16:28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">109 DPDK    ethdev  ferruh.yigit@intel.com  IN_PROGRESS  ---    Using the environment variable to get the filepath  2019/6/26 10:30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">114 DPDK    core    dev@dpdk.org    RESOLVED    FIXED   rte_rand() is not thread-safe but not documented as such    2019/6/30 7:19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">226 DPDK    cryptodev   pablo.de.lara.guarch@intel.com  RESOLVED    FIXED   Cryptodevs instruction for Kasumi isn&#x27;t correct 2019/3/26 22:19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">228 DPDK    core    anatoly.burakov@intel.com   RESOLVED    FIXED   rte_mp_request_sync memleak with multiple recipients    2019/5/3 13:49</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">258 DPDK    ethdev  dev@dpdk.org    CONFIRMED    ---    Tap driver unnecessarily triggers timeout on failure    2019/5/1 6:07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">288 DPDK    mk  thomas@monjalon.net CONFIRMED    ---    Target name recorded wrong when try to build dpdk with x86_64-native-linux-gcc  2019/7/15 20:55</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">341 DPDK    other   dev@dpdk.org    CONFIRMED    ---    repeated execution of distributor_autotest fails    2020/5/18 13:58</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">342 DPDK    other   dev@dpdk.org    RESOLVED    FIXED   distributor_autotest execution gets suspended   2020/4/26 2:22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">356 DPDK    vhost/virtio    dev@dpdk.org    RESOLVED    FIXED   Building dpdk with rte_vhost sometimes fails due to missing rte_hash.h  2019/11/21 3:02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">365 DPDK    other   dev@dpdk.org    UNCONFIRMED  ---    Do not reimplement inet_pton    2019/11/13 9:10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">385 DPDK    other   reshma.pattan@intel.com UNCONFIRMED  ---    latency calculation has potential performance issues    2020/2/5 20:54</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">420 DPDK    doc thomas@monjalon.net RESOLVED    FIXED   Typing error in doc/guides/contributing/patches.rst 2020/5/27 20:31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">423 DPDK    other   thomas@monjalon.net UNCONFIRMED  ---    usertools/dpdk-setup.sh can not be used to run an application without compiling dpdk first  2020/3/26 2:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">448 DPDK    vhost/virtio    maxime.coquelin@redhat.com  UNCONFIRMED  ---    Post-copy-Live migration with 8 vhost queues succeeds with warning from QEMU    2020/4/25 2:49</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">492 DPDK    doc anatoly.burakov@intel.com   RESOLVED    FIXED   Fix references to /dev/huge 2020/7/31 1:36</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">80  DPDK    doc linville@tuxdriver.com  RESOLVED    FIXED   There is not any mention of AF_PACKET PMD in the doc    2019/3/10 8:07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">124 lab dashboard   ci@dpdk.org CONFIRMED    ---    Add previous/next navigation links to dashboard detail page 2018/12/10 19:32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">126 lab UNH infra   ci@dpdk.org RESOLVED    INVALID Rename dev cluster FQDN suffix to dpdkdev.iol.unh.edu   2020/2/25 22:28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127 lab dashboard   ci@dpdk.org CONFIRMED    ---    Add a favicon to the dashboard  2018/12/10 19:38</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">128 lab dashboard   ci@dpdk.org CONFIRMED    ---    [Epic] Display historical trend plots on dashboard  2018/12/10 20:29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">129 lab dashboard   ci@dpdk.org CONFIRMED    ---    [Epic] Add user management functionality to dashboard   2018/12/10 20:31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">130 lab dashboard   ci@dpdk.org CONFIRMED    ---    As an IOL employee, I would like to send a new user a token-based URL to set their password 2018/12/10 20:31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">131 lab dashboard   ci@dpdk.org CONFIRMED    ---    As an employee of a Member company, I would like to be able to request a dashboard account  2018/12/10 20:31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">132 lab dashboard   ci@dpdk.org RESOLVED    FIXED   As a primary contact for a Member company, I would like to manage the users in my organization  2019/11/19 18:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">133 lab dashboard   ci@dpdk.org CONFIRMED    ---    As an employee of a Member company, I would like to request/access my VPN credentials   2018/12/10 20:31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">134 lab dashboard   ci@dpdk.org CONFIRMED    ---    Investigate using OAuth or SAML for dashboard authentication to REST API    2018/12/10 20:31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">136 lab dashboard   ci@dpdk.org CONFIRMED    ---    Add a way for users to filter results   2018/12/10 19:48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">137 lab dashboard   ci@dpdk.org CONFIRMED    ---    [Epic] Patchwork 2.1 (API 1.1)  2018/12/10 19:50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">138 lab dashboard   ci@dpdk.org RESOLVED    FIXED   Delete old log files    2019/11/19 17:55</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">140 lab dashboard   ci@dpdk.org CONFIRMED    ---    Invalidate dashboard cache on database changes  2018/12/10 20:38</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">141 lab UNH infra   ci@dpdk.org RESOLVED    INVALID Restructure network 2020/2/25 22:27</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">143 lab dashboard   ci@dpdk.org RESOLVED    FIXED   Add a run button to run incomplete tests    2019/4/3 19:25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">144 lab dashboard   ci@dpdk.org CONFIRMED    ---    [Epic] Add hardware description page    2018/12/10 20:41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">145 lab dashboard   ci@dpdk.org RESOLVED    FIXED   Add API Key access to the preferences page  2019/11/19 17:44</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">146 lab dashboard   ci@dpdk.org CONFIRMED    ---    Add initial hardware description API    2018/12/10 20:41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">147 lab dashboard   ci@dpdk.org RESOLVED    FIXED   Add jenkins information to hardware api 2019/4/26 22:29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">148 lab dashboard   ci@dpdk.org CONFIRMED    ---    Add hardware description UI to the dashboard    2018/12/10 20:41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">150 lab dashboard   ci@dpdk.org CONFIRMED    ---    Add GA Performance deltas to the detailed view  2018/12/10 20:44</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">151 lab dashboard   ci@dpdk.org CONFIRMED    ---    Add graphing of GA over time to the dashboard   2018/12/10 20:44</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">152 lab dashboard   ci@dpdk.org CONFIRMED    ---    [Epic] Increase performance or perception of performance of the dashboard   2019/1/10 21:04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">153 lab dashboard   ci@dpdk.org CONFIRMED    ---    Add timezone to date times  2018/12/10 20:08</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">154 lab dashboard   ci@dpdk.org RESOLVED    FIXED   Add a way to select what branch a patchset was meant for    2019/2/5 19:14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">155 lab dashboard   ci@dpdk.org CONFIRMED    ---    Parse NIC speed into GbE    2018/12/10 20:10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">156 lab dashboard   ci@dpdk.org RESOLVED    FIXED   The primary contact should be able to update the configuration information pdf  2019/6/17 17:33</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">157 lab dashboard   ci@dpdk.org RESOLVED    FIXED   Allow primary contact to revoke access to accounts  2019/6/17 17:29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">158 lab dashboard   ci@dpdk.org CONFIRMED    ---    The primary contact should be able to set their environments public or private  2018/12/10 20:31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">160 lab dashboard   ci@dpdk.org CONFIRMED    ---    Add graphing of LTS over time to the dashboard  2018/12/10 20:29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">161 lab dashboard   ci@dpdk.org RESOLVED    FIXED   Create master to master overview and detail pages   2019/3/22 20:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">163 lab dashboard   ci@dpdk.org RESOLVED    FIXED   Add a way to download the tarball from the detailed view    2019/1/8 17:29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">167 lab job scripts ci@dpdk.org RESOLVED    WONTFIX Check hardware/software for changes on each test run    2020/4/21 16:13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">168 lab job scripts ci@dpdk.org RESOLVED    FIXED   Record pipeline CI issues   2019/3/13 19:41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">170 lab UNH infra   blo@iol.unh.edu CONFIRMED    ---    Send separate emails to users instead of CCing everyone 2020/6/30 20:21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">172 lab job scripts ci@dpdk.org RESOLVED    FIXED   Send updated reports after a rerun  2019/3/19 18:44</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">173 lab job scripts dpdklab@iol.unh.edu RESOLVED    FIXED   Filter branch instead of going directly to the branch (results api) 2019/1/9 16:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">180 lab job scripts ci@dpdk.org RESOLVED    FIXED   Add link to dashboard website in emailed reports    2019/1/8 20:10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">181 lab job scripts ci@dpdk.org RESOLVED    FIXED   Don&#x27;t run doc patches if only the doc folder has been changed   2019/1/9 15:17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">220 lab dashboard   ci@dpdk.org RESOLVED    FIXED   Add hardware usage status to the dashboard  2019/6/17 17:44</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">233 lab dashboard   ci@dpdk.org RESOLVED    FIXED   Create a way to share artifacts 2019/8/8 15:07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">254 lab dashboard   ci@dpdk.org CONFIRMED    ---    Auto create measurements and test cases as results are submitted    2019/4/15 19:44</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">292 lab dashboard   ci@dpdk.org CONFIRMED    ---    Allow members to stop future jobs from running on their host from the dashboard 2019/6/24 20:33</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">346 DPDK    ethdev  tohofman@cisco.com  RESOLVED    WORKSFORME  Set the link speed / duplex of a DPDK port  2020/5/12 16:08</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">364 DPDK    doc dev@dpdk.org    CONFIRMED    ---    Do not generate temporary doc files in the sources  2020/3/25 8:23</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">407 lab UNH infra   ci@dpdk.org RESOLVED    DUPLICATE   Add ether layer testing to the community lab    2020/4/21 16:20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">408 lab UNH infra   lylavoie@iol.unh.edu    CONFIRMED    ---    Add Arm hardware to the lab for general testing 2020/7/1 14:49</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">435 DPDK    testpmd dev@dpdk.org    UNCONFIRMED  ---    Proposed improvement to non-interactive loop timing 2020/4/4 3:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">496 DPDK    testpmd dev@dpdk.org    UNCONFIRMED  ---    Display link speed capabilities in testpmd  2020/7/22 9:37</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">511 lab job scripts ci@dpdk.org CONFIRMED    ---    Add check if performance tests are needed   2020/7/30 15:29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">91  DPDK    mk  thomas@monjalon.net RESOLVED    WONTFIX Unable to build on Ubuntu 18.04 2020/6/18 22:35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">245 lab UNH infra   ci@dpdk.org CONFIRMED    ---    Add virtio testing to the community lab 2020/4/21 16:24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">246 lab UNH infra   ci@dpdk.org CONFIRMED    ---    Add cryptodev testing to the community lab  2020/4/21 16:24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">247 lab UNH infra   ci@dpdk.org CONFIRMED    ---    Add compression testing to the community lab    2020/4/21 16:24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">306 DPDK    ethdev  lionel.fiat@atos.net    CONFIRMED    ---    Intel X722 chipset DPDK driver issue with WindRiver Titianium R18.03 platform - CentOS 7.4  2019/7/15 20:44</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">18  DPDK    core    nhorman@tuxdriver.com   RESOLVED    FIXED   mmap with MAP_ANONYMOUS should have fd == -1    2018/4/12 14:55</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">87  DPDK    other   jerin.jacob@caviumnetworks.com  RESOLVED    FIXED   build dpdk and example with different gcc version issue 2019/7/31 6:14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">479 lab job scripts blo@iol.unh.edu CONFIRMED    ---    Fedora 32  / gcc 10 build testing   2020/6/30 20:30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">123 lab UNH infra   ci@dpdk.org RESOLVED    FIXED   Add mechanism to periodically image nodes   2019/11/19 20:13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">125 lab UNH infra   ci@dpdk.org RESOLVED    INVALID Find a replacement for NFS for Jenkins filestore    2020/2/25 22:28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">135 lab dashboard   ci@dpdk.org CONFIRMED    ---    Consider using zxcvbn for client-side password validation   2018/12/10 19:47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">159 lab UNH infra   ci@dpdk.org RESOLVED    FIXED   Change VPN to use routed configuration instead of bridged   2019/11/19 20:16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">171 lab job scripts ci@dpdk.org RESOLVED    WONTFIX Create LTS performance Jenkins Job  2020/6/30 20:15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">238 DPDK    other   dev@dpdk.org    CONFIRMED    ---    [tree-wide] enhance getopt_long usage   2019/4/2 9:38</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">429 lab job scripts ci@dpdk.org CONFIRMED    ---    New Perf Test Case: Test above / below maximum throughput of NIC / system   2020/6/30 20:29</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 对 numa 的使用与多 numa 架构下性能调优的基础">dpdk/dpdk 对 numa 的使用与多 numa 架构下性能调优的基础</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->12 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="numa-是什么">numa 是什么？<a class="hash-link" href="#numa-是什么" title="标题的直接链接">​</a></h2><p>在 SMP 架构中，内存统一寻址（Uniform Memory Architecture)，处理器和内存之间通过一条总线连接起来。由于所有处理器都是通过一条总线连接起来的，<strong>随着处理器的增加，系统总线成为了系统瓶颈</strong>，另外，处理器和内存之间的通信延迟也较大。为了克服以上缺点，NUMA 架构应运而生。</p><p>numa 架构全称为非一致性内存架构 (Non Uniform Memory Architecture)，与 SMP 中的 UMA 统一寻址内存架构相对。在 numa 系统中有本地内存与远端内存的区别。访问本地内存有更小的延迟和更大的带宽，跨处理器内存访问速度会相对较慢一点，但是整个内存对于所有的处理器都是可见的。</p><p>numa 系统的一个示意图如下：</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/0353fb8e352648e1bbfe32cde4f3b2ed.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAbG9uZ3l1X3dseg==,size_13,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述" class="img_ev3q"></p><p>上图中有两个 cpu，CPU0 与 CPU1 都有自己的本地内存，访问这些内存的性能最优，这两个 cpu 也可以通过总线等架构跨处理器访问远端的内存，只不过性能相对会差一些。</p><p><strong>如上信息与图片摘自《深入浅出 DPDK》。</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-1604-中对-numa-的使用">dpdk-16.04 中对 numa 的使用<a class="hash-link" href="#dpdk-1604-中对-numa-的使用" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-如何获取-pci-网卡所在的-numa-节点">1. 如何获取 pci 网卡所在的 numa 节点？<a class="hash-link" href="#1-如何获取-pci-网卡所在的-numa-节点" title="标题的直接链接">​</a></h3><p>linux 系统中 pci 设备会在 /sys/bus/pci/devices/ 中创建独立的子目录，目录名称就是 pci 设备的 pci 号。dpdk eal 初始化时，会扫描此目录来获取当前设备上所有可用的 pci 设备。每个 pci 设备所在的 numa 节点在 /sys/bus/pci/devices/xxx/numa_node  文件中保存，dpdk 通过访问这些文件获取到每个 pci 网卡的 numa_node 信息。</p><p>一个示例：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> # cat </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sys</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bus</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pci</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">devices</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">0000</span><span class="token plain">\</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">\</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">00.0</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">numa_node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>dpdk 会为每个扫描到的 pci 设备创建一个 rte_pci_device 结构，并将解析 sys 目录得到的字段写入到此结构中，解析完成后将每个 rte_pci_device 链入到 pci_device_list 链表中。</p><p>dpdk 内部会为每个网卡接口分配一个 rte_eth_dev 结构，在网卡 probe 流程中，pci 网卡接口的 rte_eth_dev 结构中的 pci_dev 结构被设置为扫描 pci 时创建的 rte_pci_device 结构地址。</p><p>同时每个 pci 接口的 rte_eth_dev 的 data 结构中的 numa_node 字段也用于存储接口所在的 numa_node，这个字段能够在多进程间共享且能够通过每个接口的 rte_eth_dev 直接访问到。其拷贝过程是在驱动初始化函数中调用 rte_eth_copy_pci_info 完成的。</p><p>一个示例如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">eth_i40e_dev_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_eth_dev</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_pci_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pci_dev</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">i40e_pf</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">I40E_DEV_PRIVATE_TO_PF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev_private</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">i40e_hw</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">hw </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">I40E_DEV_PRIVATE_TO_HW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev_private</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">i40e_vsi</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vsi</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint32_t</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint8_t</span><span class="token plain"> aq_fail </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">PMD_INIT_FUNC_TRACE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev_ops </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">i40e_eth_dev_ops</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rx_pkt_burst </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i40e_recv_pkts</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">tx_pkt_burst </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i40e_xmit_pkts</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pci_dev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pci_dev</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">rte_eth_copy_pci_info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pci_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>dpdk 内部提供的获取接口所在 numa 节点的函数代码：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rte_eth_dev_socket_id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint8_t</span><span class="token plain"> port_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">rte_eth_dev_is_valid_port</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">port_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> rte_eth_devices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">port_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">numa_node</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到此函数将返回每个接口 rte_eth_dev 的 data 结构中的 numa_node 的值，这个值<strong>在每个接口初始化时调用驱动初始化函数从 rte_pci_device 中拷贝</strong>，缺少了这次拷贝就不能正确获取到网卡所在的 numa_node 的真实值。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-如何处理不同-numa-节点的大页内存">2. 如何处理不同 numa 节点的大页内存？<a class="hash-link" href="#2-如何处理不同-numa-节点的大页内存" title="标题的直接链接">​</a></h3><p>dpdk 程序运行依赖大页内存，在多 numa 结构的设备上，大页内存存在位于不同 numa 节点的情况。尽管分配大页所在的 numa 有几种规则，dpdk 内部并没有使用到这些规则来处理大页内存归属的 numa。</p><p>dpdk 仅仅<strong>映射所有的大页</strong>，在映射的过程中通过访问 <strong>/proc/self/numa_maps</strong> 文件来确定每个映射的大页所在的 numa 节点，这意味着在 dpdk 【分配前】大页内存归属的 numa 节点就已经确定下来了，这部分工作是内核在分配大页时控制的，默认所有的大页内存在每个 numa 上<strong>均分</strong>，也可以通过写入 sys 下的相关文件来手动控制。</p><p>如果你需要控制映射的大页所在的 numa 节点，在 Local allocation 内存分配策略下，修改线程绑核就可以完成这个工作。更多的信息可以阅读内核源码树根目录下的 <strong>Documentation/vm/numa_memory_policy.txt</strong> 文件。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-如何获取线程所在-numa-节点">3. 如何获取线程所在 numa 节点？<a class="hash-link" href="#3-如何获取线程所在-numa-节点" title="标题的直接链接">​</a></h3><p>dpdk 初始化时会扫描设备 cpu 信息，为每个核分配一个 <strong>lcore_config</strong> 结构，这个结构代表 dpdk 对一个<strong>逻辑核</strong>的抽象，同时也用于实现逻辑线程任务 <strong>pipeline</strong> 分发。</p><p>dpdk 提供 rte_socket_id 接口获取当前逻辑核所在的 numa 节点，此接口代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_socket_id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">RTE_PER_LCORE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_socket_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>dpdk 基于性能的考量，使用了【每线程数据】保存每个逻辑核所处的 numa 节点，dpdk 创建的 lcore 线程执行函数通过调用 <strong>eal_thread_set_affinity</strong> 来初始化 <strong>_socket_id</strong> 每线程数据。</p><p>dpdk 在初始化时通过扫描 /sys 下的文件确定当前逻辑核所在的 numa 节点，相关函数为 eal_cpu_socket_id，源码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">eal_cpu_socket_id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> lcore_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> socket</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">socket </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> socket </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> RTE_MAX_NUMA_NODES</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> socket</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> path</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">PATH_MAX</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">snprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;%s/node%u/cpu%u&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NUMA_NODE_PATH</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                socket</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lcore_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">access</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> F_OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> socket</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>/sys 目录中一个示例信息如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> # ls </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sys</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">devices</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">system</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">node</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">node0</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">cpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpu0</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">    cpu3</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">    cpu6</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">    cpu66</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">   cpu69</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">   cpu71</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpu1</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">    cpu4</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">    cpu64</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">   cpu67</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">   cpu7</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">    cpulist</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpu2</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">    cpu5</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">    cpu65</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">   cpu68</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">   cpu70</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">   cpumap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>dpdk 遍历 /sys/devices/system/node 下每个 node 的目录，cpuX 存在时表明与之对应的 lcore_id 位于当前 node。在示例信息中，0-7 与 64-71 核都位于 numa 0 上。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-dpdk-接口相关重要数据结构分配中对-numa-的使用">4. dpdk 接口相关重要数据结构分配中对 numa 的使用<a class="hash-link" href="#4-dpdk-接口相关重要数据结构分配中对-numa-的使用" title="标题的直接链接">​</a></h3><p><strong>4.1 rte_eth_dev_data 结构所在 numa</strong></p><p>位于 master_lcore 所在的 numa 节点</p><p><strong>4.2 rte_eth_dev_data 结构中的 </strong>dev_private<strong> 结构（用于驱动内部数据结构）所在 numa</strong></p><p>优先在 master_lcore 所在 numa 节点的大页内存上分配，分配失败后从小到大遍历每个 numa 上的大页内存（跳过 master_lcore 所在 numa）上分配。</p><p><strong>4.3 mempool 所在的 numa</strong></p><p>由调用 rte_pktmbuf_pool_create 时传递的 socket_id 参数值决定。</p><p><strong>4.4. rte_eth_dev_data 中的 rx queues、tx queues 指针数组所在的 numa</strong></p><p>优先在调用 rte_eth_dev_configure 函数配置队列的<strong>线程绑定的核所在的 numa 节点</strong>上分配，分配失败则继续从小到大遍历每个 numa（跳过已经分配失败的 numa）节点来分配。</p><p><strong>4.5 网卡 rx_queues、rx_queues 上绑定的收包描述符所在的 numa 节点</strong></p><p>使用 rte_eth_rx_queue_setup 函数 socket_id 参数传入的 numa 节点。</p><p><strong>4.6 网卡 tx_queues、tx_queues 上绑定的发包描述符所在的 numa 节点</strong></p><p>使用 rte_eth_tx_queue_setup 函数 socket_id 参数传入的 numa 节点。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-mempool-创建时对-numa-节点的使用">5. mempool 创建时对 numa 节点的使用<a class="hash-link" href="#5-mempool-创建时对-numa-节点的使用" title="标题的直接链接">​</a></h3><p>关键代码：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mz </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_memzone_reserve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mz_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mempool_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> socket_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mz_flags</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>socket_id 代表设定的 numa node，此值通过 rte_pktmbuf_pool_create 接口传入。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="6-dpdk-程序队列相关的数据结构创建对-numa-的使用">6. dpdk 程序队列相关的数据结构创建对 numa 的使用<a class="hash-link" href="#6-dpdk-程序队列相关的数据结构创建对-numa-的使用" title="标题的直接链接">​</a></h3><p>下面以 ice 驱动为例，列举网卡收发包队列重要结构创建时对 numa 节点的使用。</p><p><strong>tx_queue 与 tx desc 创建时在指定的 socket_id（表示 numa 号）上分配相关结构：</strong></p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Allocate the TX queue data structure. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    txq </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_zmalloc_socket</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ice_tx_queue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 RTE_CACHE_LINE_SIZE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 socket_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tz </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_eth_dma_zone_reserve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;tx_ring&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> queue_idx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ring_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ICE_RING_BASE_ALIGN</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      socket_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Allocate software ring */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    txq</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">sw_ring </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">rte_zmalloc_socket</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ice_tx_entry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> nb_desc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   RTE_CACHE_LINE_SIZE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   socket_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>rx_queue 与 rx desc 创建时在指定的 socket_id（表示 numa 号）上分配相关结构：</strong></p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Allocate the rx queue data structure */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rxq </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_zmalloc_socket</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ice_rx_queue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 RTE_CACHE_LINE_SIZE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 socket_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rz </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_eth_dma_zone_reserve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rx_ring&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> queue_idx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ring_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ICE_RING_BASE_ALIGN</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      socket_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Allocate the software ring. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rxq</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">sw_ring </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rte_zmalloc_socket</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ice_rx_entry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      RTE_CACHE_LINE_SIZE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      socket_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-1911-中网卡重要数据结构分配所在的-numa">dpdk-19.11 中网卡重要数据结构分配所在的 numa<a class="hash-link" href="#dpdk-1911-中网卡重要数据结构分配所在的-numa" title="标题的直接链接">​</a></h2><p><strong>4.1 rte_eth_dev_data 结构所在 numa</strong></p><p>位于 master_lcore 所在的 numa 节点。</p><p><strong>4.2 rte_eth_dev_data 结构中的 </strong>dev_private<strong> 结构（用于驱动内部数据结构）所在 numa</strong></p><p><strong>使用网卡所在的 numa 节点。</strong></p><p><strong>4.3 mempool 所在的 numa</strong></p><p>由调用 rte_pktmbuf_pool_create 时传递的 socket_id 参数值决定。</p><p><strong>4.4. rte_eth_dev_data 中的 rx queues、tx queues 指针数组所在的 numa</strong></p><p>优先在调用 rte_eth_dev_configure 函数配置队列的线程绑定的核所在的 numa 节点上分配，分配失败则继续从小到大遍历每个 numa（跳过已经分配失败的 numa）节点来分配。。</p><p><strong>4.5 网卡 rx_queues、rx_queues 上绑定的收包描述符所在的 numa 节点</strong></p><p>使用 rte_eth_rx_queue_setup 函数 socket_id 参数传入的 numa 节点。</p><p><strong>4.6 网卡 tx_queues、tx_queues 上绑定的发包描述符所在的 numa 节点</strong></p><p>使用 rte_eth_tx_queue_setup 函数 socket_id 参数传入的 numa 节点。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="对收发包性能影响显著的数据结构与多-numa-架构性能调优的一条规">对收发包性能影响显著的数据结构与多 numa 架构性能调优的一条规<a class="hash-link" href="#对收发包性能影响显著的数据结构与多-numa-架构性能调优的一条规" title="标题的直接链接">​</a></h2><p>dpdk 收发包进程核心逻辑是调用底层驱动实现的收发包函数，访问频繁的数据结构列举如下：</p><ol><li>从 mempool 中分配的 mbuf</li><li>tx_queue、rx_queue 及网卡 rx_desc、tx_desc 结构</li></ol><p>在多 numa 环境下，访问本地 numa 会有最高的性能，远程 numa 访问会造成性能的下降。收发包性能优化要以如下规则为基准：</p><p><strong>网卡所在的 numa 节点、mempool 分配自的 numa 节点、网卡队列与描述符分配自的 numa 节点、收发包线程绑定的核所在的 numa 节点完全一致。</strong></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/longyu.github.io/blog/dpdk/dpdk 收发包函数分析：dpdk-20.11 ice sse 向量收发包函数关键过程分析">收发包向量函数实现分析</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-06-21T00:32:49.000Z" itemprop="datePublished">2022年6月21日</time> · <!-- -->17 分钟阅读</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="收包函数主体逻辑">收包函数主体逻辑<a class="hash-link" href="#收包函数主体逻辑" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mbuf_initializer-字段用于初始化每个-mbuf">mbuf_initializer 字段用于初始化每个 mbuf<a class="hash-link" href="#mbuf_initializer-字段用于初始化每个-mbuf" title="标题的直接链接">​</a></h3><p>mbuf_initializer 字段初始化的内容：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* next 8 bytes are initialised on RX descriptor rearm */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RTE_MARKER64 rearm_data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint16_t</span><span class="token plain"> data_off</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Reference counter. Its size should at least equal to the size</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * of port field (16 bits), to support zero-copy broadcast.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * It should only be accessed using the following functions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * rte_mbuf_refcnt_update(), rte_mbuf_refcnt_read(), and</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * rte_mbuf_refcnt_set(). The functionality of these functions (atomic,</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * or non-atomic) is controlled by the RTE_MBUF_REFCNT_ATOMIC flag.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint16_t</span><span class="token plain"> refcnt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint16_t</span><span class="token plain"> nb_segs</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; Number of segments. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/** Input port (16 bits to support more than 256 virtual ports).</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * The event eth Tx adapter uses this field to specify the output port.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint16_t</span><span class="token plain"> port</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这部分值每个报文基本一致。</p><p><strong>mbuf_initialized 结构的内容：</strong></p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    mbuf_initialized </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> data_off             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> RTE_PKTMBUF_HEADROOM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> refcnt               </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> nb_segs              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> port_id              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> rxq</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">port_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>向量函数含义：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">__m128i </span><span class="token function" style="color:#d73a49">_mm_set_epi64x</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__int64 q1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __int64 q0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">设置两个 </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> bit 整型值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> q0 </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> q1 </span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>初始化 mbuf_init 结构：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> __m128i mbuf_init </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_set_epi64x</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rxq</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mbuf_initializer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行后 mbuf_init 的值 :</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    mbuf_init  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> data_off             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> RTE_PKTMBUF_HEADROOM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> refcnt               </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> nb_segs              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> port_id              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> rxq</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">port_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token number" style="color:#36acaa">32</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token number" style="color:#36acaa">32</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-设置-crc-掩码的值对一个-mbuf-进行处理同时将-pkt_len-与-data_len-减去-crc_len-长度">1. 设置 crc 掩码的值，对一个 mbuf 进行处理，同时将 pkt_len 与 data_len 减去 crc_len 长度<a class="hash-link" href="#1-设置-crc-掩码的值对一个-mbuf-进行处理同时将-pkt_len-与-data_len-减去-crc_len-长度" title="标题的直接链接">​</a></h3><p>向量函数含义：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">__m128i </span><span class="token function" style="color:#d73a49">_mm_set_epi16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> w7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> w6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> w5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> w4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> w3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> w2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">w1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> w0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">设置 </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> 个有符号 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">bit 整型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> w0 </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> w1 </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> … </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> w7 </span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>驱动掩码设置相关代码：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    __m128i crc_adjust </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_set_epi16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">/* ignore non-length fields */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rxq</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">crc_len</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* sub crc on data_len */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">/* ignore high-16bits of pkt_len */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rxq</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">crc_len</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* sub crc on pkt_len */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">/* ignore pkt_type field */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此处的掩码设置用于后续基于向量单位对多个报文同时计算。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-设置后续运行的掩码">2. 设置后续运行的掩码<a class="hash-link" href="#2-设置后续运行的掩码" title="标题的直接链接">​</a></h3><p>mbuf 中相关的字段结构：</p><table><thead><tr><th>变量名称</th><th>变量宽度</th></tr></thead><tbody><tr><td>pkt_type</td><td>32</td></tr><tr><td>pkt_len</td><td>64</td></tr><tr><td>data_len</td><td>80</td></tr><tr><td>vlan_macip</td><td>96</td></tr><tr><td>rss_hash</td><td>128</td></tr></tbody></table><p>向量函数代码：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> __m128i zero </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_setzero_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* mask to shuffle from desc. to mbuf */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> __m128i shuf_msk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_set_epi8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* rss hash parsed separately */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">/* octet 10~11, 16 bits vlan_macip */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* octet 4~5, 16 bits data_len */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* skip high 16 bits pkt_len, zero out */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* octet 4~5, low 16 bits pkt_len */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* pkt_type set as unknown */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">/* pkt_type set as unknown */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>0xFF 表示将对应字节的值清 0，最高位不为 1 表示选择 a<!-- -->[n &amp; 0xf]<!-- --> 字节值。</strong>
此掩码<strong>跳过 pkt_len 的高 16-bit</strong>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-设置-eop-掩码值dd-maskeop-mask">3. 设置 EOP 掩码值、dd mask、eop mask<a class="hash-link" href="#3-设置-eop-掩码值dd-maskeop-mask" title="标题的直接链接">​</a></h3><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> __m128i eop_shuf_mask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_set_epi8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           </span><span class="token number" style="color:#36acaa">0x04</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0C</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x08</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * compile-time check the above crc_adjust layout is correct.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * NOTE: the first field (lowest address) is given last in set_epi16</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * call above.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">RTE_BUILD_BUG_ON</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mbuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pkt_len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token function" style="color:#d73a49">offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mbuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rx_descriptor_fields1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">RTE_BUILD_BUG_ON</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mbuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data_len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token function" style="color:#d73a49">offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mbuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rx_descriptor_fields1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* 4 packets DD mask */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> __m128i dd_check </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_set_epi64x</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x0000000100000001LL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">0x0000000100000001LL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* 4 packets EOP mask */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> __m128i eop_check </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_set_epi64x</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x0000000200000002LL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         </span><span class="token number" style="color:#36acaa">0x0000000200000002LL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>dd_check 与 eop_check 针对 rx 描述符，同时对两个描述符进行操作，每个描述符占据 64-bit</strong>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-判断是否需要重整队列需要则执行队列重整操作">4. 判断是否需要重整队列，需要则执行队列重整操作<a class="hash-link" href="#4-判断是否需要重整队列需要则执行队列重整操作" title="标题的直接链接">​</a></h3><p>申请 <strong>ICE_RXQ_REARM_THRESH</strong> 个 mbuf，然后将 <strong>mbuf dataroom 的物理地址填充到空闲的描述符中。</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-获取当前软件可用描述符并预取描述符">5. 获取当前软件可用描述符并预取描述符<a class="hash-link" href="#5-获取当前软件可用描述符并预取描述符" title="标题的直接链接">​</a></h3><p><strong>普通函数逻辑，读取描述符中的标志，当没有可用描述符时，函数直接返回。</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="6-填充-mbuf-dataroom-物理地址到描述符函数主体向量指令">6. 填充 mbuf dataroom 物理地址到描述符<strong>函数主体向量指令</strong><a class="hash-link" href="#6-填充-mbuf-dataroom-物理地址到描述符函数主体向量指令" title="标题的直接链接">​</a></h3><p>向量函数代码：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Initialize the mbufs in vector, process 2 mbufs in one loop */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> ICE_RXQ_REARM_THRESH</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rxep </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __m128i vaddr0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vaddr1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mb0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rxep</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mbuf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mb1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rxep</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mbuf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* load buf_addr(lo 64bit) and buf_iova(hi 64bit) */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">RTE_BUILD_BUG_ON</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mbuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf_iova</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token function" style="color:#d73a49">offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mbuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf_addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vaddr0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_loadu_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__m128i </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mb0</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">buf_addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vaddr1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_loadu_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__m128i </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mb1</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">buf_addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* convert pa to dma_addr hdr/data */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dma_addr0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_unpackhi_epi64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vaddr0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vaddr0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dma_addr1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_unpackhi_epi64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vaddr1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vaddr1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* add headroom to pa values */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dma_addr0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_add_epi64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dma_addr0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hdr_room</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dma_addr1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_add_epi64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dma_addr1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hdr_room</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* flush desc with pa dma_addr */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">_mm_store_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__m128i </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">rxdp</span><span class="token operator" style="color:#393A34">++</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dma_addr0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">_mm_store_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__m128i </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">rxdp</span><span class="token operator" style="color:#393A34">++</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dma_addr1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>mbuf 中虚拟地址与物理地址结构如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token class-name">uint64_t</span><span class="token plain"> </span><span class="token class-name">rte_iova_t</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">buf_addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; Virtual address of segment buffer. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Physical address of segment buffer.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Force alignment to 8-bytes, so as to ensure we have the exact</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * same mbuf cacheline0 layout for 32-bit and 64-bit. This makes</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * working on vector drivers easier.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">rte_iova_t</span><span class="token plain"> buf_iova </span><span class="token function" style="color:#d73a49">__rte_aligned</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">rte_iova_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 <strong>128-bit</strong> 寄存器，一次将 <strong>buf_addr 与 buf_iova 地址加载到一个 128-bit 的变量中</strong>，<strong>低 64-bit 存储 buf_addr，高 64-bit 存储 buf_iova 地址</strong>。</p><p>6.1 <strong>每次处理两个 rxd，首先将第一组 rxep mbuf 地址分别加载到 mb0 与 mb1 两个 mbuf 结构中</strong></p><p>6.2 <strong>将 mb0 的虚拟地址加载到 vaddr0 128-bit 中，将 mb1 的虚拟地址加载到 vaddr1 128-bit 中</strong></p><p><strong>处理后 vaddr0 与 vaddr1 内容示例：</strong></p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        vaddr0 </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">      vaddr1 </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hi</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  mb0</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">buf_iova </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">     hi</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">b  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> mb1</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">buf_iova</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lo</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  mb0</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">buf_addr </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">     lo</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">b  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> mb1</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">buf_addr</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">                 </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>6.3 <strong>调整 vaddr0、vaddr1 中 buf_iova 的位置</strong></p><p>向量函数代码：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* convert pa to dma_addr hdr/data */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dma_addr0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_unpackhi_epi64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vaddr0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vaddr0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dma_addr1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_unpackhi_epi64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vaddr1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vaddr1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行后 vaddr0 与 vaddr1 结构：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        dma_addr0 </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">     dma_addr1 </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hi</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">b   </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  mb0</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">buf_iova </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">     hi</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">b     </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> mb1</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">buf_iova </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lo</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">b   </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  mb0</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">buf_iova </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">     lo</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">b     </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> mb1</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">buf_iova </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">                      </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>6.4 使用 dma_addr0 加上 hdr_room 将地址指向 dataroom 的物理地址</strong></p><p>向量函数代码：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* add headroom to pa values */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma_addr0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_add_epi64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dma_addr0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hdr_room</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma_addr1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_add_epi64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dma_addr1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hdr_room</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行上述操作后的值：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    dma_addr0 </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">        dma_addr</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hi</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">b   </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  mb0</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">buf_iova </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> hdr_room </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">      hi</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">b   </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> mb1</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">buf_iova </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> hdr_room </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lo</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">b   </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  mb0</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">buf_iova </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> hdr_room </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">      lo</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">b   </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> mb1</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">buf_iova </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> hdr_room </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">                   </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>6.5 将 dma_addr 存储到描述符中</strong></p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* flush desc with pa dma_addr */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">_mm_store_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__m128i </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">rxdp</span><span class="token operator" style="color:#393A34">++</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dma_addr0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">_mm_store_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__m128i </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">rxdp</span><span class="token operator" style="color:#393A34">++</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dma_addr1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>rx_desc 中报文地址相关定义：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        __le64 pkt_addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* Packet buffer address */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le64 hdr_addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* Header buffer address */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>普通收包函数中设置内容：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">         * fill the read format of descriptor with physic address in</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">         * new allocated mbuf: nmb</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">         */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rxdp</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hdr_addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rxdp</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pkt_addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dma_addr</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>普通收包函数中 <strong>hdr_addr 设置为 0，sse 中却设定为了 dma_addr，这里有机关！</strong></p><p><strong>6.6 更新软件变量值</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="7-判断当前描述符的-dd-位是否为-1为-1-表示至少有一个报文">7. 判断当前描述符的 dd 位是否为 1，为 1 表示至少有一个报文<a class="hash-link" href="#7-判断当前描述符的-dd-位是否为-1为-1-表示至少有一个报文" title="标题的直接链接">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="8-开始批量从-rx-desc-向-mbuf-转换">8. 开始批量从 rx desc 向 mbuf 转换<a class="hash-link" href="#8-开始批量从-rx-desc-向-mbuf-转换" title="标题的直接链接">​</a></h3><p><strong>转换前添加如下断言，确保 mbuf 中字段的偏移正确。</strong></p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Compile-time verify the shuffle mask</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * NOTE: some field positions already verified above, but duplicated</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * here for completeness in case of future modifications.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">RTE_BUILD_BUG_ON</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mbuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pkt_len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token function" style="color:#d73a49">offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mbuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rx_descriptor_fields1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">RTE_BUILD_BUG_ON</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mbuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data_len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token function" style="color:#d73a49">offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mbuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rx_descriptor_fields1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">RTE_BUILD_BUG_ON</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mbuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vlan_tci</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token function" style="color:#d73a49">offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mbuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rx_descriptor_fields1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">RTE_BUILD_BUG_ON</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mbuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token function" style="color:#d73a49">offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mbuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rx_descriptor_fields1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用向量指令从描述符转化为-mbuf-的关键过程"><strong>使用向量指令从描述符转化为 mbuf 的关键过程</strong><a class="hash-link" href="#使用向量指令从描述符转化为-mbuf-的关键过程" title="标题的直接链接">​</a></h2><p><strong>1. 进入 for 循环，每次处理 4 个描述符，填充 4 个 mbuf（此处假定为这种情况）</strong>
<strong>2. 加载描述符中的 mbuf 与描述符内容到 128-bit 变量中</strong></p><p><strong>一个 128-bit 加载两个 mbuf 地址</strong>：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     mbp1 </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     hi</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> sw_ring</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mbuf </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     lo</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> sw_ring</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mbuf     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     mbp2 </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     hi</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> sw_ring</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mbuf </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     lo</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> sw_ring</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mbuf </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>加载四个描述符到四个 128-bit 的 desc 变量中：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_loadu_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__m128i </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rxdp </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">rte_compiler_barrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* B.2 copy 2 64 bit or 4 32 bit mbuf point into rx_pkts */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">_mm_storeu_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__m128i </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">rx_pkts</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mbp1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_loadu_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__m128i </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rxdp </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">rte_compiler_barrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* B.1 load 2 mbuf point */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_loadu_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__m128i </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rxdp </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">rte_compiler_barrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_loadu_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__m128i </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rxdp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在每个 desc 加载时都添加了<strong>编译屏障，避免优化产生问题</strong>，加载后 desc 结构：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> rxdp</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> rxdp</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> rxdp</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> rxdp</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接收描述符定义：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">union</span><span class="token plain"> ice_32b_rx_flex_desc </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le64 pkt_addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* Packet buffer address */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le64 hdr_addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* Header buffer address */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic">/* bit 0 of hdr_addr is DD bit */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le64 rsvd1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le64 rsvd2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> read</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* Qword 0 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 rxdid</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* descriptor builder profile ID */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 mir_id_umb_cast</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* mirror=[5:0], umb=[7:6] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 ptype_flex_flags0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* ptype=[9:0], ff0=[15:10] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 pkt_len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* [15:14] are reserved */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 hdr_len_sph_flex_flags1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* header=[10:0] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">/* sph=[11:11] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">/* ff1/ext=[15:12] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* Qword 1 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 status_error0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 l2tag1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 flex_meta0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 flex_meta1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* Qword 2 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 status_error1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 flex_flags2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 time_stamp_low</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 l2tag2_1st</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 l2tag2_2nd</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* Qword 3 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 flex_meta2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 flex_meta3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">union</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                __le16 flex_meta4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                __le16 flex_meta5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> flex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __le32 ts_high</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> flex_ts</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> wb</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* writeback */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>单个 desc 加载后内容如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> Qword </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">   hi</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Qword </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">   lo</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">64</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>注意顺序为从高地址向低地址加载</strong>。</p><p><strong>3. 将 mbuf 地址填充到 rx_pkts 数组中</strong></p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* B.2 copy 2 64 bit or 4 32 bit mbuf point into rx_pkts */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">_mm_storeu_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__m128i </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">rx_pkts</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mbp1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* B.2 copy 2 mbuf point into rx_pkts  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">_mm_storeu_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__m128i </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">rx_pkts</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mbp2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4. 当设置了 split_packet 后，预取 mbuf 中的第二个 cache line</strong></p><p>   在 mbuf 结构中使用不占空间的变量标识每一个 cache line 的起始位置。</p><p><strong>5. 将 desc 中的字段填充到 pktmbuf 中</strong></p><p>向量函数代码：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* D.1 pkt 3,4 convert format from desc to pktmbuf */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pkt_mb3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_shuffle_epi8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shuf_msk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pkt_mb2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_shuffle_epi8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shuf_msk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* D.1 pkt 1,2 convert format from desc to pktmbuf */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pkt_mb1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_shuffle_epi8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shuf_msk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pkt_mb0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_shuffle_epi8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shuf_msk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* C.1 4=&gt;2 filter staterr info only */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sterr_tmp2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_unpackhi_epi32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* C.1 4=&gt;2 filter staterr info only */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sterr_tmp1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_unpackhi_epi32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>掩码值：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> __m128i shuf_msk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_set_epi8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* rss hash parsed separately */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">/* octet 10~11, 16 bits vlan_macip */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* octet 4~5, 16 bits data_len */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* skip high 16 bits pkt_len, zero out */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* octet 4~5, low 16 bits pkt_len */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* pkt_type set as unknown */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">/* pkt_type set as unknown */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>rx 描述符与 mbuf 中的相关字段定义摘录：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* Qword 0 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 rxdid</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* descriptor builder profile ID */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 mir_id_umb_cast</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* mirror=[5:0], umb=[7:6] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 ptype_flex_flags0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* ptype=[9:0], ff0=[15:10] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 pkt_len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* [15:14] are reserved */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 hdr_len_sph_flex_flags1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* header=[10:0] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">/* sph=[11:11] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">/* ff1/ext=[15:12] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* Qword 1 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 status_error0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 l2tag1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 flex_meta0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 flex_meta1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">union</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint32_t</span><span class="token plain"> packet_type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; L2/L3/L4 and tunnel information.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    ...................</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="display:inline-block;color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">uint32_t pkt_len;         /**&lt; Total pkt len: sum of all segments. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">uint16_t</span><span class="token plain"> data_len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; Amount of data in segment buffer. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/** VLAN TCI (CPU order), valid if PKT_RX_VLAN is set. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">uint16_t</span><span class="token plain"> vlan_tci</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">union</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">union</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">uint32_t</span><span class="token plain"> rss</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">/**&lt; RSS hash result if RSS enabled */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行 <strong>__mm_shuffle_epi8</strong> 函数，设置 <strong>pkt_len、data_len、vlan_tci，清空 packet_type、rss</strong>。</p><p>向量函数调用代码：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pkt_mb3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_shuffle_epi8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shuf_msk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>调用之后 pkt_mb3 的结构内容如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pkt_mb3 </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   mbuf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">packet_type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pkt_len low </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pkt_len high </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">b</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">   mbuf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pkt_len</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pkt_len low </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">b  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">   mbuf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data_len</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pkt_len hith </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">l2tag1 low </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">b   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">   mbuf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vlan_tci</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">l2tag1 low </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">b   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   mbuf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rss</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>pkt_mb2、pkt_mb1、pkt_mb0 结构类似</strong>。</p><p><strong>6. 过滤 staterr 信息</strong></p><p><strong>向量函数代码：</strong></p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* C.1 4=&gt;2 filter staterr info only */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sterr_tmp2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_unpackhi_epi32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* C.1 4=&gt;2 filter staterr info only */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sterr_tmp1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_unpackhi_epi32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>向量函数含义：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">__m128i </span><span class="token function" style="color:#d73a49">_mm_unpackhi_epi32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__m128i a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __m128i b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">交替高</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">位有符号或无符号</span><span class="token number" style="color:#36acaa">32</span><span class="token plain">bit整数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> a2 </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b2 </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> a3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b3 </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>rx desc 中相关结构：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* Qword 0 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 rxdid</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* descriptor builder profile ID */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 mir_id_umb_cast</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* mirror=[5:0], umb=[7:6] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 ptype_flex_flags0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* ptype=[9:0], ff0=[15:10] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 pkt_len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* [15:14] are reserved */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 hdr_len_sph_flex_flags1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* header=[10:0] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">/* sph=[11:11] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">/* ff1/ext=[15:12] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* Qword 1 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 status_error0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 l2tag1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 flex_meta0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 flex_meta1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行后 sterr_tmp2 结构如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     sterr_tmp2 </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">l2tag1 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> status_error0  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">l2tag1 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> status_error0  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flex_meta0 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> flex_meta1 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flex_meta0 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> flex_meta1 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>7. 将 rx olflags 映射到 mbuf 中</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="将四个描述符合并为一个的向量函数逻辑分析">将四个描述符合并为一个的向量函数逻辑分析<a class="hash-link" href="#将四个描述符合并为一个的向量函数逻辑分析" title="标题的直接链接">​</a></h2><p>ice_rx_desc 部分定义：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* Qword 0 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 rxdid</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* descriptor builder profile ID */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 mir_id_umb_cast</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* mirror=[5:0], umb=[7:6] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 ptype_flex_flags0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* ptype=[9:0], ff0=[15:10] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 pkt_len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* [15:14] are reserved */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 hdr_len_sph_flex_flags1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* header=[10:0] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">/* sph=[11:11] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">/* ff1/ext=[15:12] */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* Qword 1 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 status_error0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 l2tag1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 flex_meta0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 flex_meta1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* Qword 2 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 status_error1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 flex_flags2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 time_stamp_low</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 l2tag2_1st</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 l2tag2_2nd</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* Qword 3 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 flex_meta2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le16 flex_meta3</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>合并 4 个描述符标志信息的向量函数调用代码：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* merge 4 descriptors */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_unpackhi_epi32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tmp_desc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_unpackhi_epi32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> descs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tmp_desc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_unpacklo_epi64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tmp_desc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tmp_desc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_and_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tmp_desc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> desc_mask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第一步执行后 flags 的布局:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   flags </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status_error0 l2tag1  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status_error0 l2tag1  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flex_meta0 flex_meta1 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flex_meta0 flex_meta1 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第二步执行后 tmp_desc 的布局:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   tmp_desc </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status_error0 l2tag1  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status_error0 l2tag1  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flex_meta0 flex_meta1 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flex_meta0 flex_meta1 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第三步执行后 tmp_desc 的布局:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   tmp_desc </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status_error0 l2tag1  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status_error0 l2tag1  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status_error0 l2tag1  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status_error0 l2tag1  </span><span class="token operator" style="color:#393A34">|</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>desc_mask 内容：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* mask everything except checksum, RSS and VLAN flags.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * bit6:4 for checksum.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * bit12 for RSS indication.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * bit13 for VLAN indication.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> __m128i desc_mask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_set_epi32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x3070</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3070</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">0x3070</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3070</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>合并操作后，设置四个描述符中 checksum、rss、vlan 的值。</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="发包函数实现分析">发包函数实现分析<a class="hash-link" href="#发包函数实现分析" title="标题的直接链接">​</a></h2><p>tx 的逻辑非常简单，要用 mbuf 中的字段填充一个 ice_tx_desc 结构，使用到的 sse 向量函数逻辑：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ice_vtx1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">volatile</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ice_tx_desc</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">txdp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_mbuf</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pkt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint64_t</span><span class="token plain"> flags</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint64_t</span><span class="token plain"> high_qw </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ICE_TX_DESC_DTYPE_DATA </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint64_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">flags  </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> ICE_TXD_QW1_CMD_S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint64_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">pkt</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data_len </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> ICE_TXD_QW1_TX_BUF_SZ_S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __m128i descriptor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_mm_set_epi64x</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">high_qw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pkt</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">buf_iova </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> pkt</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data_off</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">_mm_store_si128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__m128i </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">txdp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> descriptor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ice_tx_desc 结构：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* Tx Descriptor */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ice_tx_desc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le64 buf_addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* Address of descriptor&#x27;s data buf */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __le64 cmd_type_offset_bsz</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>发包函数需要填充 <strong>mbuf dataroom 起始地址的物理地址以及一些发送标志到发送描述符中</strong>，ice_tx_desc 为 128bit，填充一次就能够存储这两个字段。</p><h1>总结</h1><p>dpdk 内部向量收发包函数使用<strong>硬件向量指令</strong>优化传统的收发包过程，主要的优化内容集中在<strong>收包逻辑上</strong>，发包的主要过程为 dma 操作，优化空间非常有限。</p><p>dpdk 收发包 burst 过程是一个非常代表性的批量化处理场景，将<strong>硬件向量指令集成到批量化上</strong>，带来了<strong>小包性能的显著提升</strong>以及程序 cpu 占用率的下降，是<strong>挖掘硬件特性</strong>达成性能优化的一个很好的案例。</p><p>同时需要说明的是 dpdk 使用向量收发包函数<strong>需要满足一定的条件</strong>，这个条件因<strong>网卡不同</strong>而有所区别，这些条件包括了 dpdk 接口初始化时配置的一些硬件卸载功能，需要非常注意！</p><p><strong>备注：dpdk 内部不直接使用向量指令而是通过使用一层封装函数来间接调用！</strong></p></div></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--next" href="/longyu.github.io/blog/page/2"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="footer__link-item">longyuwlz<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/longyu.github.io/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 龙瑜的文字世界, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/longyu.github.io/assets/js/runtime~main.9bcca1a9.js"></script>
<script src="/longyu.github.io/assets/js/main.4339af60.js"></script>
</body>
</html>