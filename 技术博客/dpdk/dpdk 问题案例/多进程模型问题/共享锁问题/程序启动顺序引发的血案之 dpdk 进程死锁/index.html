<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-技术博客/dpdk/dpdk 问题案例/多进程模型问题/共享锁问题/程序启动顺序引发的血案之 dpdk 进程死锁">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/longyu.github.io/blog/rss.xml" title="龙瑜的文字世界 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/longyu.github.io/blog/atom.xml" title="龙瑜的文字世界 Atom Feed"><title data-rh="true">程序启动顺序引发的血案之 dpdk 进程死锁 | 龙瑜的文字世界</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://longyuwlz.github.io/longyu.github.io/技术博客/dpdk/dpdk 问题案例/多进程模型问题/共享锁问题/程序启动顺序引发的血案之 dpdk 进程死锁"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="程序启动顺序引发的血案之 dpdk 进程死锁 | 龙瑜的文字世界"><meta data-rh="true" name="description" content="前言"><meta data-rh="true" property="og:description" content="前言"><link data-rh="true" rel="canonical" href="https://longyuwlz.github.io/longyu.github.io/技术博客/dpdk/dpdk 问题案例/多进程模型问题/共享锁问题/程序启动顺序引发的血案之 dpdk 进程死锁"><link data-rh="true" rel="alternate" href="https://longyuwlz.github.io/longyu.github.io/技术博客/dpdk/dpdk 问题案例/多进程模型问题/共享锁问题/程序启动顺序引发的血案之 dpdk 进程死锁" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://longyuwlz.github.io/longyu.github.io/技术博客/dpdk/dpdk 问题案例/多进程模型问题/共享锁问题/程序启动顺序引发的血案之 dpdk 进程死锁" hreflang="x-default"><link rel="stylesheet" href="/longyu.github.io/assets/css/styles.481fc3a6.css">
<link rel="preload" href="/longyu.github.io/assets/js/runtime~main.0ebe0f88.js" as="script">
<link rel="preload" href="/longyu.github.io/assets/js/main.14246a37.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/longyu.github.io/"><div class="navbar__logo"><img src="/longyu.github.io/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/longyu.github.io/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">龙瑜的文字世界</b></a><a class="navbar__item navbar__link" href="/longyu.github.io/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/longyu.github.io/category/大学的记录">大学的记录</a><button aria-label="打开/收起侧边栏菜单「大学的记录」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/longyu.github.io/">笔记本开篇序言</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/longyu.github.io/技术博客/RTOS/debug/实时操作系统中调试上下文切换与中断处理汇编的一些方法">技术博客</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/RTOS/debug/实时操作系统中调试上下文切换与中断处理汇编的一些方法">RTOS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 依赖知识/网卡驱动绑定/将网卡绑定到官方驱动测试过程">dpdk</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 依赖知识/网卡驱动绑定/将网卡绑定到官方驱动测试过程">dpdk 依赖知识</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 分类问题排查方法/初始化问题/dpdk 问题排查的第一关：基础环境的排查">dpdk 分类问题排查方法</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 功能移植与开发/功能移植/dpdk ebpf 库跨版本移植">dpdk 功能移植与开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 源码分析/igb_uio/dpdk-16.04 igb_uio 模块分析">dpdk 源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/rte_kni/dpdk 程序创建 kni 虚拟网络接口失败的问题">dpdk 问题案例</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/rte_kni/dpdk 程序创建 kni 虚拟网络接口失败的问题">rte_kni</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/多进程模型问题/dpdk 多进程模型共享收发包队列问题">多进程模型问题</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/多进程模型问题/dpdk 多进程模型共享收发包队列问题">多进程模型共享收发包队列问题</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/多进程模型问题/dpdk-16.04 虚拟化环境 virtio 网卡 secondary 进程段错误问题分析定位">dpdk-16.04 虚拟化环境 virtio 网卡 secondary 进程段错误问题分析定位</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/多进程模型问题/共享锁问题/dpdk 死锁问题后续之初始化假设不可迁移问题">共享锁问题</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-6 menu__list-item"><a class="menu__link" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/多进程模型问题/共享锁问题/dpdk 死锁问题后续之初始化假设不可迁移问题">dpdk 死锁问题后续之初始化假设不可迁移问题</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-6 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/多进程模型问题/共享锁问题/程序启动顺序引发的血案之 dpdk 进程死锁">程序启动顺序引发的血案之 dpdk 进程死锁</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/性能问题/dpdk 程序性能调优：不同网卡或槽位带来的时延差异问题排查思路">性能问题</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/接口问题/Unsupported SFP+ Module">接口问题</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/收发包问题/dpdk 不发包问题之排查上层软件发出报文的正确性">收发包问题</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/程序初始化问题/Failed to mmap 2MB hugepages 与 max_map_count limit">程序初始化问题</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/编译问题/dpdk库源码中包含内核头文件的问题">编译问题</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/网卡硬件/dpdk 问题分析：dpdk-20.11 ice 100G 网卡 rss_hash 配置无效问题">网卡硬件</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk-19.xx/dpdk-19.11 armv8 l2fwd 在某 arm 内核上无法运行问题">dpdk-19.xx</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/dpdk/上手 dpdk/功能使用/dpdk-pdump工具编译运行">上手 dpdk</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/gui/android/某安卓图形化界面运行异常问题分析">gui</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux 三剑客/awk/awk 实现批量化操作探讨">linux 三剑客</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-kernel/ethtool 命令指定的网络设备名在哪里被使用？">linux-kernel</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/Debian/在英文版 Debian 中添加中文拼音输入法">linux-system</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/perl/perl 中的 foreach 语句">perl</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/longyu.github.io/技术博客/写博客对我的意义">写博客的意义</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/命令行使用案例/linux 中文件批量重命名">命令行使用案例</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/嵌入式/ARM/汇编函数与 c 函数的互相调用问题">嵌入式</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/技术书籍/APUE/time 输出的程序执行时间">技术书籍</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/构建系统/Makefile/Makefile 中的 @true 与 @false 命令">构建系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/测试框架/unity/unity 单元测试框架的工作原理，及隐含问题">测试框架</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/笔记本电脑问题/惠普笔记本电池无法充满问题">笔记本电脑问题</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/策略/api 功能与实现的些许感想">策略</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/计算机系统/cpu/cpu 分支预测对性能的影响">计算机系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/软件开发技巧/使用取模与累加制造一个环">软件开发技巧</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/软件开发语言/C/c 语言中的封装">软件开发语言</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/那些年写的诗歌/龙瑜文赋">那些年写的诗歌</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/随笔/相遇的缘分">随笔</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/longyu.github.io/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">技术博客</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">dpdk</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">dpdk 问题案例</span><meta itemprop="position" content="3"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">多进程模型问题</span><meta itemprop="position" content="4"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">共享锁问题</span><meta itemprop="position" content="5"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">程序启动顺序引发的血案之 dpdk 进程死锁</span><meta itemprop="position" content="6"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>程序启动顺序引发的血案之 dpdk 进程死锁</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a class="hash-link" href="#前言" title="标题的直接链接">​</a></h2><p>在 <a href="https://editor.csdn.net/md/?articleId=124258534" target="_blank" rel="noopener noreferrer">程序启动顺序引发的血案</a> 这篇文章中，我描述了在某个场景中由启动顺序引发的程序无法启动的问题。问题的表象如下：</p><p>容器内的 dpdk secondary 进程初始化报了如下错误：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Detected </span><span class="token number" style="color:#36acaa">16</span><span class="token plain"> lcore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Detected </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> NUMA nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Multi-process socket /var/run/dpdk/rte/mp_socket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Selected IOVA mode </span><span class="token string" style="color:#e3116c">&#x27;PA&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Probing VFIO support</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: error allocating rte services array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: FATAL: rte_service_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> failed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: rte_service_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> failed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAL: Error - exiting with code: </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Cause: Invalid EAL arguments</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>报了上面的错误后涉案 dpdk secondary 进程没有直接退出，而是继续向下执行，然后调用了 rte_ring_lookup 接口来 attach 到 primary 进程中创建的 ring 中。</p><p>此时由于 hugepage 映射问题，在 rte_ring_lookup 中触发了段错误，相关代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">414</span><span class="token plain">     </span><span class="token function" style="color:#d73a49">rte_mcfg_tailq_read_lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">415</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">416</span><span class="token plain">     </span><span class="token function" style="color:#d73a49">TAILQ_FOREACH</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">te</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ring_list</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">417</span><span class="token plain">         r </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">rte_ring</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> te</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">418</span><span class="token plain">         </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">strncmp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> r</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> RTE_RING_NAMESIZE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">419</span><span class="token plain">             </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">420</span><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">421</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">422</span><span class="token plain">     </span><span class="token function" style="color:#d73a49">rte_mcfg_tailq_read_unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">423</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在遍历 ring_list 的时候触发了段错误，段错误的原因的确是 /dev/hugepages 映射异常。</p><p>表面看来问题很明确，但是由于此时正好处于临界区内，下一次再重新运行的时候会在 rte_eal_init 中获取 tailq 锁的时候卡住，同时由于 mcfg 的 tailq lock 在 dpdk 多进程之间共享，也间接的影响到了其它 dpdk 程序的正常运行，产生死锁现象，问题影响进一步扩大。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-内部对读写锁的使用场景">dpdk 内部对读写锁的使用场景<a class="hash-link" href="#dpdk-内部对读写锁的使用场景" title="标题的直接链接">​</a></h2><p>dpdk 架构支持<strong>多进程模型</strong>，一个独立的<strong>内存配置</strong>支持一个 <strong>primary</strong> 进程与多个 <strong>secondary</strong> 进程，这些进程间共享 dpdk 核心数据结构的示意图如下：
<img loading="lazy" src="https://img-blog.csdnimg.cn/109cca7ed65a4b5da134168f8c2217f1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAbG9uZ3l1X3dseg==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述" class="img_ev3q"></p><p>上图中，两个框中重叠的部分被多个进程共享，底层内存<strong>基于 hugepage 共享</strong>，dpdk 在 hugepage 上实现了内存操作接口，调用这些接口申请的内存理论上均可以在 <strong>dpdk primary</strong> 进程与 <strong>secondary</strong> 进程之间<strong>共享</strong>。</p><p>为了实现这种共享，dpdk 使用了 <strong>rte_config</strong> 结构来<strong>描述</strong>在大页上分配的共享内存信息，primary 进程与 secondary 进程通过 mmap 相同的文件来实现 rte_config 结构的共享。</p><p>真实的使用场景中，primary 进程主要负责<strong>创建共享内存结构</strong>，创建共享内存结构需要<strong>更新 rte_config 结构中的特定字段</strong>，而 secondary 进程通过 rte_config 结构来 <strong>loookup</strong> 到相关的结构来使用。就原理上来说，dpdk 并没有限定非要在 primary 进程中创建共享内存结构，secondary 也可以创建内存结构。</p><p>由于 primary 进程与 secondary 进程独立运行， rte_config 代表的这块共享内存需要在多进程间做互斥保护，新的 dpdk 版本中通过使用内部实现的读写锁来完成。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-内部的读写锁与死锁问题">dpdk 内部的读写锁与死锁问题<a class="hash-link" href="#dpdk-内部的读写锁与死锁问题" title="标题的直接链接">​</a></h2><p>dpdk 内部实现的读写锁的机制如下：</p><ol><li>一把锁由一个定义为 volatile 的计数值描述，定义为 volatile 限定每次都从内存中读取此计数值</li><li>计数值为 0 表明没有人占有锁，计数值大于 0 表明有读者占用，计数值小于 0 表明有写者占用</li><li>获取读锁通过原子操作给计数值加 1，获取写锁通过原子操作给计数值减 1</li><li>获取写锁的时候不能有人读、写，获取读锁的时候不能有人写，条件不成立则一直重试</li></ol><p><strong>获取写锁的一个简单流程如下：</strong></p><ol><li>使用原子操作加载锁计数到局部变量 x 中</li><li>判断 x 是否为 0，如果不为 0 则继续重试</li><li>当 x 为 0 时表明此时没有人占有锁，使用原子操作保证锁计数等于 x 值时对 CNT 的值减 1，操作失败则重试</li></ol><p><strong>获取读锁的一个简单流程如下：</strong></p><ol><li>使用原子操作加载锁计数到局部变量 x 中</li><li>判断 x 是否小于 0，小于 0 则继续重试</li><li>当 x 大于等于 0 时，使用原子操作保证锁计数等于 x 值时对 CNT 的值加 1，操作失败则重试</li></ol><p>dpdk 的读写锁实现至少有下面几个优点：</p><ol><li>在频繁读不频繁写的场景下有很好的性能</li><li>锁机制的申请与释放在用户态执行，避免了陷入内核带来的性能影响</li></ol><p>在上文的描述中，可以看出 dpdk 实现的读写锁实际是一种<strong>用户态的锁</strong>。当这种锁在多进程间共享时，某个 dpdk 程序在临界区内<strong>没有成功释放锁就因为某种异常情况而退出</strong>，就会造成其它进程无法获取到同一把锁，触发潜在的<strong>死锁问题</strong>。</p><p>这种异常情况主要包含两个方面：</p><ol><li>dpdk 程序在临界区中间可能被强制杀死</li><li>dpdk 程序在临界区中间可能触发异常如段错误等而直接退出</li></ol><p>当上述异常情况出现时就可能会触发死锁，根本原因在于 <strong>dpdk 程序在临界区内异常退出导致锁不被释放，后续重新获取锁的时候会一直失败，表现为死锁。</strong></p><p>这个问题也不局限于读写锁，当 dpdk 内部的自旋锁在多进程之间共享时也存在相同的问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="提问环节">提问环节<a class="hash-link" href="#提问环节" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-dpdk-高版本有没有相关改进">1. dpdk 高版本有没有相关改进？<a class="hash-link" href="#1-dpdk-高版本有没有相关改进" title="标题的直接链接">​</a></h3><p>git 更新最新的 dpdk 版本，阅读锁相关的代码，没有相关的修改。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-网上是否有相关的问题有解决方案">2. 网上是否有相关的问题有解决方案<a class="hash-link" href="#2-网上是否有相关的问题有解决方案" title="标题的直接链接">​</a></h3><p>关键词：“dpdk userspace rwlock deadlock”</p><p>搜索结果：无相关内容。</p><p>关键词：How can a process gracefully recover from a process crashing while holding a rwlock?</p><p>对搜索结果进行整理，有如下两个初步的结论：</p><ol><li>读写锁由于存在多<strong>个读者同时读取</strong>的情况，现有的实现中没有临界区异常退出锁回收机制</li><li>pthread mutex 互斥锁可以设置一个 <strong>robust</strong> 属性以支持在进程临界区内异常退出时<strong>回收锁</strong></li></ol><p>根据收集的信息看，要在读写锁上做异常回收是非常复杂的，可能需要引入一把新的锁，将读写锁降级为互斥锁问题就简化了，尽管性能会有所下降。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一些解决方案的尝试">一些解决方案的尝试<a class="hash-link" href="#一些解决方案的尝试" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-使用其它锁信号量来替换">1. 使用其它锁、信号量来替换<a class="hash-link" href="#1-使用其它锁信号量来替换" title="标题的直接链接">​</a></h3><p>梳理 linux 系统提供的一些锁，不同锁的支持情况见如下表格：</p><table><thead><tr><th>锁名称</th><th>支持多线程共享</th><th>支持多进程共享</th><th>支持异常回收</th><th>必须陷入内核</th></tr></thead><tbody><tr><td>pthread mutex</td><td>yes</td><td>yes</td><td>yes</td><td>否</td></tr><tr><td>pthread rwlock</td><td>yes</td><td>yes</td><td>no</td><td>-</td></tr><tr><td>BSD locks</td><td>yes</td><td>yes</td><td>yes</td><td>是</td></tr><tr><td>lockf function</td><td>no</td><td>yes</td><td>yes</td><td>是</td></tr><tr><td>POSIX record locks</td><td>no</td><td>yes</td><td>yes</td><td>是</td></tr><tr><td>Open file description locks</td><td>yes</td><td>yes</td><td>yes</td><td>是</td></tr><tr><td>System V Sempahore</td><td>yes</td><td>yes</td><td>yes</td><td>是</td></tr><tr><td>POSIX Semaphore</td><td>yes</td><td>yes</td><td>no</td><td>是</td></tr></tbody></table><p>文件锁更为具体的一些特征（摘自 <a href="https://gavv.github.io/articles/file-locks/" target="_blank" rel="noopener noreferrer">https://gavv.github.io/articles/file-locks/</a>）：
<img loading="lazy" src="https://img-blog.csdnimg.cn/cad9d97290bb4761bab2883b0143805f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAbG9uZ3l1X3dseg==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述" class="img_ev3q">
文件锁的主要特征总结如下：</p><ol><li>均支持进程异常终止时内核回收</li><li>均支持共享与互斥两种模式</li><li>与 fd 强相关，多线程使用需要谨慎处理</li><li>通过系统调用实现，必须陷入内核</li></ol><p>根据上面的表格，首先排除掉不能在多线程之间共享的锁与不支持异常回收的锁，剩下的锁有如下几个：</p><ol><li>pthread mutex</li><li>BSD locks </li><li>Open file description locks</li><li>System V Sempahore</li></ol><p>在上面四个锁中，pthread mutex 只有当获取不到锁的时候才会陷入内核，而其它的锁每次都会陷入内核，同时考虑文件锁与 System V 信号量在多线程之间相对复杂，故而优先选择 pthread_mutex。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-使用-pthread-mutex-锁替换-dpdk-多进程间共享的读写锁的实现方案">2. 使用 pthread mutex 锁替换 dpdk 多进程间共享的读写锁的实现方案<a class="hash-link" href="#2-使用-pthread-mutex-锁替换-dpdk-多进程间共享的读写锁的实现方案" title="标题的直接链接">​</a></h3><ol><li>确定 dpdk 内会在多进程之间共享的锁，集中在 rte_config 结构中</li><li>将找到的这些锁修改为 pthread mutex 锁，在初始化 pthread mutex 锁的时候设定 PTHREAD_PROCESS_SHARED 与 PTHREAD_MUTEX_ROBUST 属性以支持在多进程间共享且支持异常回收</li><li>修改这些共享锁的 lock 与 unlock 代码，核心在于执行 pthread_mutex_lock 并在返回值为 EOWNERDEAD 的时候执行 pthread_mutex_consistent 重新回收并占有锁</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-修改-dpdk-内部锁实现实现异常恢复">3. 修改 dpdk 内部锁实现，实现异常恢复<a class="hash-link" href="#3-修改-dpdk-内部锁实现实现异常恢复" title="标题的直接链接">​</a></h2><p>基于 dpdk 内部 spinlock 开发记录进程 pid 与死锁状态的自定义锁来替换，自定义锁的工作流程如下：</p><ol><li>获取 spinlock 前先获取进程 pid，成功获取到 spinlock 后使用进程 pid 更新自定义锁中的 pid 字段</li><li>申请自定义锁时判断锁的 deadlock 状态是否为真，为真则直接获取到锁，获取后将 deadlock 状态设置为假</li><li>使用 sigaction 注册 SIGTERM 与 SIGSEGV 信号处理函数，在信号处理函数中判断自定义锁的 pid 是否与当前进程 pid 一致，一致则设定自定义锁 deadlock 状态为真。</li><li>将 dpdk rte_config 中的 rwlock 修改为上述自定义 spinlock，</li><li>约束不能使用 kill -9 强制杀死程序</li></ol><p>存在的问题：</p><ol><li>在获取 spinlock 与记录进程 pid 之间跳转到 SIGTERM、SIGSEGV 信号处理函数时，无法检测到死锁（概率非常小）</li><li>性能有所下降</li></ol><p>引申的问题：用户态程序无法保证不被中断，更新自定义锁中的字段：pid、deadlock 的过程与获取锁的过程中可能被中断，导致判断失效，所以此方案不能从根本上解决问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="基于-dpdk-1911-实施-pthread-mutex-锁替换方案遇到的问题">基于 dpdk-19.11 实施 pthread mutex 锁替换方案遇到的问题<a class="hash-link" href="#基于-dpdk-1911-实施-pthread-mutex-锁替换方案遇到的问题" title="标题的直接链接">​</a></h2><ol><li>需要修改 rwlock 与 spinlock 的实现吗？
这里的场景是多进程之间共享 rwlock 与 spinlock，需要修改的是这些共享的锁而非锁机制本身。</li><li>lock 已经 lock 成功的 pthread mutex 卡住的问题</li></ol><p>修改完成后测试发现 dpdk 程序初始化卡在如下堆栈处：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00000000006ea099</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_mutex_lock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00000000006ebaa1</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_memseg_list_walk</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00000000006e53f0</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">eal_memalloc_init</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00000000006eb43e</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_eal_memory_init</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00000000006da785</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">rte_eal_init</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">6</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00000000004b0d1a</span><span class="token plain"> in </span><span class="token function" style="color:#d73a49">main</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>rte_mutex_lock 是底层封装的调用 pthread_mutex_lock 的接口。排查发现这里卡住的原因是获取了已经获取到的同一把 mutex 互斥锁。</p><p>搜索了下 pthread mutex 可以配置递归 lock 参数，但是测试确定在多次获取同一把 mutex 后在临界区中异常退出时内核不能回收锁，需要修改代码，将 rte_memseg_list_walk 替换为 rte_memseg_list_walk_thread_unsafe，修改点涉及几处同时也走查了其它锁，没有发现相同的现象。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="对-pthread-mutex-锁回收机制的一些粗浅认识">对 pthread mutex 锁回收机制的一些粗浅认识<a class="hash-link" href="#对-pthread-mutex-锁回收机制的一些粗浅认识" title="标题的直接链接">​</a></h2><p>初步的研究确定，它使用内核 robust_list 来保障程序退出时占有互斥锁检测的可靠性（不可中断性），内核在执行 do_exit 释放进程资源的时候会判断是否占有了 mutex 并设置相关的标记字段。</p><p>内核做上述判断需要依赖申请锁时记录的信息，而记录这些信息的过程与获取锁的过程仍旧存在一个窗口，pthread mutex 通过 glibc 与内核协同实现，保证了这一机制的可靠性。</p><p>真实的过程更复杂一些，在后续的文章中再来描述！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考链接">参考链接<a class="hash-link" href="#参考链接" title="标题的直接链接">​</a></h2><p><a href="https://stackoverflow.com/questions/51956715/robust-rwlock-in-posix" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/51956715/robust-rwlock-in-posix</a></p><p><a href="https://pgtux.wordpress.com/2014/08/12/linux-what-happens-if-process-crashes-while-holding-a-shared-lock/" target="_blank" rel="noopener noreferrer">https://pgtux.wordpress.com/2014/08/12/linux-what-happens-if-process-crashes-while-holding-a-shared-lock/</a></p><p><a href="https://gavv.github.io/articles/file-locks/" target="_blank" rel="noopener noreferrer">https://gavv.github.io/articles/file-locks/</a></p><p><a href="https://www.gnu.org/software/libc/manual/html_node/Open-File-Description-Locks-Example.html#Open-File-Description-Locks-Example" target="_blank" rel="noopener noreferrer">https://www.gnu.org/software/libc/manual/html_node/Open-File-Description-Locks-Example.html#Open-File-Description-Locks-Example</a></p><p><a href="https://docs.kernel.org/locking/robust-futexes.html" target="_blank" rel="noopener noreferrer">https://docs.kernel.org/locking/robust-futexes.html</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/longyuwlz/longyu.github.io/docs/技术博客/dpdk/dpdk 问题案例/多进程模型问题/共享锁问题/程序启动顺序引发的血案之 dpdk 进程死锁.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/多进程模型问题/共享锁问题/dpdk 死锁问题后续之初始化假设不可迁移问题"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">dpdk 死锁问题后续之初始化假设不可迁移问题</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/longyu.github.io/技术博客/dpdk/dpdk 问题案例/性能问题/dpdk 程序性能调优：不同网卡或槽位带来的时延差异问题排查思路"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">dpdk 程序性能调优：不同网卡或槽位带来的时延差异问题排查思路</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#dpdk-内部对读写锁的使用场景" class="table-of-contents__link toc-highlight">dpdk 内部对读写锁的使用场景</a></li><li><a href="#dpdk-内部的读写锁与死锁问题" class="table-of-contents__link toc-highlight">dpdk 内部的读写锁与死锁问题</a></li><li><a href="#提问环节" class="table-of-contents__link toc-highlight">提问环节</a><ul><li><a href="#1-dpdk-高版本有没有相关改进" class="table-of-contents__link toc-highlight">1. dpdk 高版本有没有相关改进？</a></li><li><a href="#2-网上是否有相关的问题有解决方案" class="table-of-contents__link toc-highlight">2. 网上是否有相关的问题有解决方案</a></li></ul></li><li><a href="#一些解决方案的尝试" class="table-of-contents__link toc-highlight">一些解决方案的尝试</a><ul><li><a href="#1-使用其它锁信号量来替换" class="table-of-contents__link toc-highlight">1. 使用其它锁、信号量来替换</a></li><li><a href="#2-使用-pthread-mutex-锁替换-dpdk-多进程间共享的读写锁的实现方案" class="table-of-contents__link toc-highlight">2. 使用 pthread mutex 锁替换 dpdk 多进程间共享的读写锁的实现方案</a></li></ul></li><li><a href="#3-修改-dpdk-内部锁实现实现异常恢复" class="table-of-contents__link toc-highlight">3. 修改 dpdk 内部锁实现，实现异常恢复</a></li><li><a href="#基于-dpdk-1911-实施-pthread-mutex-锁替换方案遇到的问题" class="table-of-contents__link toc-highlight">基于 dpdk-19.11 实施 pthread mutex 锁替换方案遇到的问题</a></li><li><a href="#对-pthread-mutex-锁回收机制的一些粗浅认识" class="table-of-contents__link toc-highlight">对 pthread mutex 锁回收机制的一些粗浅认识</a></li><li><a href="#参考链接" class="table-of-contents__link toc-highlight">参考链接</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="footer__link-item">longyuwlz<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/longyu.github.io/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 龙瑜的文字世界, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/longyu.github.io/assets/js/runtime~main.0ebe0f88.js"></script>
<script src="/longyu.github.io/assets/js/main.14246a37.js"></script>
</body>
</html>