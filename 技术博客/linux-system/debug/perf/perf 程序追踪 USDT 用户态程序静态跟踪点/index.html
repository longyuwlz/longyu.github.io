<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-技术博客/linux-system/debug/perf/perf 程序追踪 USDT 用户态程序静态跟踪点">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/longyu.github.io/blog/rss.xml" title="龙瑜的文字世界 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/longyu.github.io/blog/atom.xml" title="龙瑜的文字世界 Atom Feed"><title data-rh="true">perf 程序追踪 USDT 用户态程序静态跟踪点 | 龙瑜的文字世界</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://longyuwlz.github.io/longyu.github.io/技术博客/linux-system/debug/perf/perf 程序追踪 USDT 用户态程序静态跟踪点"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="perf 程序追踪 USDT 用户态程序静态跟踪点 | 龙瑜的文字世界"><meta data-rh="true" name="description" content="perf 中的 usdt"><meta data-rh="true" property="og:description" content="perf 中的 usdt"><link data-rh="true" rel="canonical" href="https://longyuwlz.github.io/longyu.github.io/技术博客/linux-system/debug/perf/perf 程序追踪 USDT 用户态程序静态跟踪点"><link data-rh="true" rel="alternate" href="https://longyuwlz.github.io/longyu.github.io/技术博客/linux-system/debug/perf/perf 程序追踪 USDT 用户态程序静态跟踪点" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://longyuwlz.github.io/longyu.github.io/技术博客/linux-system/debug/perf/perf 程序追踪 USDT 用户态程序静态跟踪点" hreflang="x-default"><link rel="stylesheet" href="/longyu.github.io/assets/css/styles.fd2463fc.css">
<link rel="preload" href="/longyu.github.io/assets/js/runtime~main.c878b670.js" as="script">
<link rel="preload" href="/longyu.github.io/assets/js/main.99377f63.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/longyu.github.io/"><div class="navbar__logo"><img src="/longyu.github.io/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/longyu.github.io/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">龙瑜的文字世界</b></a><a class="navbar__item navbar__link" href="/longyu.github.io/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/写给 hy 的文字/等待的珍贵">写给 hy 的文字</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/longyu.github.io/">笔记本开篇序言</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/大学的记录/2016 的成长">大学的记录</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/工作/少用鼠标">工作</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/思考/I believe">思考</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/longyu.github.io/技术博客/RTOS/debug/实时操作系统中调试上下文切换与中断处理汇编的一些方法">技术博客</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/RTOS/debug/实时操作系统中调试上下文切换与中断处理汇编的一些方法">RTOS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 依赖知识/网卡驱动绑定/将网卡绑定到官方驱动测试过程">dpdk</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/gui/android/某安卓图形化界面运行异常问题分析">gui</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux 三剑客/awk/awk 实现批量化操作探讨">linux 三剑客</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-kernel/ethtool 命令指定的网络设备名在哪里被使用？">linux-kernel</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/longyu.github.io/技术博客/linux-system/Debian/在英文版 Debian 中添加中文拼音输入法">linux-system</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/Debian/在英文版 Debian 中添加中文拼音输入法">Debian</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/EXSI/一次从 EXSI 移植 vmfstools 失败的过程记录">EXSI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/bash/bad interpreter">bash</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/chroot/chroot 命令帮助信息中的几个重要问题">chroot</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/longyu.github.io/技术博客/linux-system/debug/perf/perf 程序追踪 USDT 用户态程序静态跟踪点">debug</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/longyu.github.io/技术博客/linux-system/debug/perf/perf 程序追踪 USDT 用户态程序静态跟踪点">perf</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/longyu.github.io/技术博客/linux-system/debug/perf/perf 程序追踪 USDT 用户态程序静态跟踪点">perf 程序追踪 USDT 用户态程序静态跟踪点</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/debug/strace/strace 跟踪多线程程序不能打印系统调用的问题">strace</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/ebpf/tcpdump与 bpf 指令集">ebpf</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/gcc/ar/使用 ar 命令合并多个静态库">gcc</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/git/git 中子模块的使用">git</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/glibc/debug/ELF file OS ABI invalid 问题与 chroot 解决方案">glibc</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/grub/在 debian10 上编译 grub-legacy">grub</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/network/debug/at803x phy 驱动关闭节能模式">network</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/openEuler/openEuler 20.03 sp2 vmware 虚拟机启动 dmesg 信息">openEuler</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/systemd/max file descriptors for elasticsearch process is too low 问题定位">systemd</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/内核原理分析/netlink/cn_proc demo 中创建一个 netlink socket 背后的内核行为">内核原理分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/内核模块/network/iptables 与 ip6tables 命令依赖的内核模块">内核模块</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/包管理系统/LD_DEBUG 加 rpm -qf 帮你快速找到 undefined symbol 符号所在的动态库及 rpm 包">包管理系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/命令实现原理分析/bash 中捕获每一个输入字符如何实现？">命令实现原理分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/哲学/UNIX 哲学">哲学</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/文件系统/sysfs/open sys file report permission denied problem">文件系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/根文件系统/构建/上手 buildroot">根文件系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/登入 linux 系统/登录 linux 的过程">登入 linux 系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/系统日志/utmp/系统崩溃重启后 utmp 日志的回收过程">系统日志</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/虚拟化/kvm/使用 virsh-console 连接到 virt-manager 中运行的 linux 虚拟机串口中">虚拟化</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/问题案例/linux 中 xxx not found 问题的一般解决思路与 bibtex 无法找到依赖文件示例">问题案例</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/perl/perl 中的 foreach 语句">perl</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/longyu.github.io/技术博客/写博客对我的意义">写博客的意义</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/命令行使用案例/linux 中文件批量重命名">命令行使用案例</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/嵌入式/ARM/汇编函数与 c 函数的互相调用问题">嵌入式</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/技术书籍/APUE/time 输出的程序执行时间">技术书籍</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/构建系统/Makefile/Makefile 中的 @true 与 @false 命令">构建系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/测试框架/unity/unity 单元测试框架的工作原理，及隐含问题">测试框架</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/笔记本电脑问题/惠普笔记本电池无法充满问题">笔记本电脑问题</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/策略/api 功能与实现的些许感想">策略</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/计算机系统/cpu/cpu 分支预测对性能的影响">计算机系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/软件开发技巧/使用取模与累加制造一个环">软件开发技巧</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/软件开发语言/C/c 语言中的封装">软件开发语言</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/方法论/解决问题的一些方法">方法论</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/读书笔记/终身成长/成长型思维与固定型思维">读书笔记</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/那些年写的诗歌/到不了">那些年写的诗歌</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/随笔/元旦/在几本书中跨年">随笔</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/longyu.github.io/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">技术博客</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">linux-system</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">debug</span><meta itemprop="position" content="3"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">perf</span><meta itemprop="position" content="4"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">perf 程序追踪 USDT 用户态程序静态跟踪点</span><meta itemprop="position" content="5"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>perf 程序追踪 USDT 用户态程序静态跟踪点</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="perf-中的-usdt">perf 中的 usdt<a class="hash-link" href="#perf-中的-usdt" title="标题的直接链接">​</a></h2><p>在学习 ebpf 的 usdt 探针的时候遇到了问题，看了一些网上的链接，在 gregg 大神的博客中找到了 perf 中与 usdt 相关的内容，就研究了一下。</p><p>perf 程序源码在内核源码树中的 ./tools/perf/ 目录中，进入到这个目录执行 make 进行编译即可。</p><p>编译完成后我执行 make install 后直接执行发现会报 perf_5.0 找不到的错误，make install V=1 发现 perf 被安装到了我的家目录下的 bin 目录中，先配置下环境变量凑合用吧。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="上手-perf-的-usdt-追踪功能">上手 perf 的 usdt 追踪功能<a class="hash-link" href="#上手-perf-的-usdt-追踪功能" title="标题的直接链接">​</a></h2><p>如下命令从 <a href="http://www.brendangregg.com/perf.html#StaticUserTracing" target="_blank" rel="noopener noreferrer">Static User Tracing</a> 中摘录。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># perf buildid-cache --add `which node`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># perf list | grep sdt_node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sdt_node:gc__done                                  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SDT event</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sdt_node:gc__start                                 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SDT event</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sdt_node:http__client__request                     </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SDT event</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sdt_node:http__client__response                    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SDT event</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sdt_node:http__server__request                     </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SDT event</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sdt_node:http__server__response                    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SDT event</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sdt_node:net__server__connection                   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SDT event</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sdt_node:net__stream__end                          </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SDT event</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># perf record -e sdt_node:http__server__request -a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> perf record: Woken up </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token builtin class-name">times</span><span class="token plain"> to </span><span class="token function" style="color:#d73a49">write</span><span class="token plain"> data </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> perf record: Captured and wrote </span><span class="token number" style="color:#36acaa">0.446</span><span class="token plain"> MB perf.data </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> samples</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># perf script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">node</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">7646</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">002</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">361.012364</span><span class="token plain">: sdt_node:http__server__request: </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dc2e69</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">node</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">7646</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">002</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">361.204718</span><span class="token plain">: sdt_node:http__server__request: </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dc2e69</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">node</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">7646</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">002</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">361.363043</span><span class="token plain">: sdt_node:http__server__request: </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dc2e69</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>它使用了 node 程序的探测点，我想偷懒就用了一个简单的 hello_usdt 程序替换了 node 命令，程序代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;sys/sdt.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">DTRACE_PROBE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hello_usdt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> probe</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">main</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>perf list 报了如下错误：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Semantic error :sdt_hello-usdt is bad </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> event name -it must follow C symbol-naming rule.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>看上去应该是事件的名称不符合 c 的符号命令规则，于是将代码修改为如下内容：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;sys/sdt.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">DTRACE_PROBE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hello_usdt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> probe_main</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>修改完成后重新编译，重新执行上面的步骤，perf list 这次能够看到如下内容：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  sdt_hello_usdt:probe_main                          </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SDT event</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行 perf record 的时候报了如下错误：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@debian-10:10:30:33</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> usdt </span><span class="token comment" style="color:#999988;font-style:italic"># perf record -e sdt_hello_usdt:probe_main -a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">event syntax error: </span><span class="token string" style="color:#e3116c">&#x27;sdt_hello_usdt:probe_main&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">___ unknown tracepoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error:  File /sys/kernel/debug/tracing/events/sdt_hello_usdt/probe_main not found.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hint:   SDT event cannot be directly recorded on.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Please first use </span><span class="token string" style="color:#e3116c">&#x27;perf probe sdt_hello_usdt:probe_main&#x27;</span><span class="token plain"> before recording it.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Run </span><span class="token string" style="color:#e3116c">&#x27;perf list&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> a list of valid events</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Usage: perf record </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">options</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">command</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    or: perf record </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">options</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> -- </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">command</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">options</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -e, --event </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">event</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   event selector. use </span><span class="token string" style="color:#e3116c">&#x27;perf list&#x27;</span><span class="token plain"> to list available events</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>首先检查 tracing/events 子目录中确实不存在 sdt_hello_usdt，看后面的提示需要先执行一下 perf probe，就操作了一下。</p><p>操作后再次执行 perl list 并搜索 sdt 得到了如下信息：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  sdt_hello_usdt:probe_main                          </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Tracepoint event</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sdt_hello_usdt:probe_main                          </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SDT event</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后重新执行 perf record，这次没有报错，运行了这个 perf 命令后，在其它终端中执行一次 hello_usdt 程序，然后在 perf 所在的终端按 Ctrl+C 退出 perf。</p><p>操作记录如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@debian-10:10:37:31</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> usdt </span><span class="token comment" style="color:#999988;font-style:italic"># perf record -e sdt_hello_usdt:probe_main -a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> perf record: Woken up </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token builtin class-name">times</span><span class="token plain"> to </span><span class="token function" style="color:#d73a49">write</span><span class="token plain"> data </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> perf record: Captured and wrote </span><span class="token number" style="color:#36acaa">1.137</span><span class="token plain"> MB perf.data </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> samples</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最后的 1 samples 表示捕获到了一次事件，执行 perf script 来查看记录的内容，操作记录如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@debian-10:10:38:10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> usdt </span><span class="token comment" style="color:#999988;font-style:italic"># perf script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hello_usdt  </span><span class="token number" style="color:#36acaa">5457</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">005</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25700.337067</span><span class="token plain">: sdt_hello_usdt:probe_main: </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">563b1d927130</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>能够看到成功捕获到了！但是 USDT 真正生效了吗？</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="检查-usdt-是否生效">检查 USDT 是否生效<a class="hash-link" href="#检查-usdt-是否生效" title="标题的直接链接">​</a></h2><p>为了验证这点，我将上面的 hello_usdt 的代码修改为如下内容：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;sys/sdt.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;unistd.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">DTRACE_PROBE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hello_usdt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> probe_main</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;result is %d\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>添加跟踪点的过程与上面一致，这里我在 perf record 程序执行后，执行 hello_usdt 程序，在终端中打印了 <strong>result is 3</strong> 后我使用 gdb -p 跟踪 hello_usdt 程序，反汇编 add 函数，得到了如下信息：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> disass </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Dump of assembler code </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> add:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x0000565285243145 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">+</span><span class="token operator file-descriptor important" style="color:#393A34">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">: push   %rbp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x0000565285243146 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">+</span><span class="token operator file-descriptor important" style="color:#393A34">1</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">: mov    %rsp,%rbp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x0000565285243149 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">+</span><span class="token operator file-descriptor important" style="color:#393A34">4</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">: mov    %edi,-0x4</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">%rbp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x000056528524314c </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">+</span><span class="token operator file-descriptor important" style="color:#393A34">7</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">: mov    %esi,-0x8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">%rbp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x000056528524314f </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">+1</span><span class="token operator file-descriptor important" style="color:#393A34">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:    int3   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x0000565285243150 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">+1</span><span class="token operator file-descriptor important" style="color:#393A34">1</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:    mov    -0x4</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">%rbp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">,%edx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x0000565285243153 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">+1</span><span class="token operator file-descriptor important" style="color:#393A34">4</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:    mov    -0x8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">%rbp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">,%eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x0000565285243156 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">+1</span><span class="token operator file-descriptor important" style="color:#393A34">7</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:    </span><span class="token function" style="color:#d73a49">add</span><span class="token plain">    %edx,%eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x0000565285243158 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">+1</span><span class="token operator file-descriptor important" style="color:#393A34">9</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:    pop    %rbp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x0000565285243159 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">+2</span><span class="token operator file-descriptor important" style="color:#393A34">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:    retq   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">End of assembler dump.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到 10 偏移量处的指令被替换为了 int3，这表示 usdt 生效。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="perf-的其它功能">perf 的其它功能<a class="hash-link" href="#perf-的其它功能" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-追踪内核函数中某变量的值">1. 追踪内核函数中某变量的值<a class="hash-link" href="#1-追踪内核函数中某变量的值" title="标题的直接链接">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@debian-10:23:36:18</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> perf </span><span class="token comment" style="color:#999988;font-style:italic"># ./perf probe -a &#x27;dev_ethtool ifr-&gt;ifr_ifrn.ifrn_name[0]&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Added new event:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  probe:dev_ethtool    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">on dev_ethtool with </span><span class="token assign-left variable" style="color:#36acaa">ifrn_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ifr-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">ifr_ifrn.ifrn_name</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You can now use it </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> all perf tools, such as:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    perf record -e probe:dev_ethtool -aR </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@debian-10:23:36:31</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> perf </span><span class="token comment" style="color:#999988;font-style:italic"># ./perf record -e probe:dev_ethtool -aR sleep 100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> perf record: Woken up </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token builtin class-name">times</span><span class="token plain"> to </span><span class="token function" style="color:#d73a49">write</span><span class="token plain"> data </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> perf record: Captured and wrote </span><span class="token number" style="color:#36acaa">1.041</span><span class="token plain"> MB perf.data </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">25</span><span class="token plain"> samples</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@debian-10:23:36:48</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> perf </span><span class="token comment" style="color:#999988;font-style:italic"># ./perf report -n</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># To display the perf.data header info, please use --header/--header-only options.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Total Lost Samples: 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Samples: 25  of event &#x27;probe:dev_ethtool&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Event count (approx.): 25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Overhead       Samples  Trace output                    </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ........  ............  ................................</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">100.00</span><span class="token plain">%            </span><span class="token number" style="color:#36acaa">25</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ffffffff9f5ed470</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">ifrn_name</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">119</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述示例打印出了 dev_ethtool 函数中 ifr-&gt;ifr_ifrn.ifrn_name<!-- -->[0]<!-- --> 的值，这个数字为 119，表示的是小写字母 w，而我执行的命令就是 <strong>ethtool wlp0s20f3，ifrn_name 中存储的就是 wlp0s20f3 这个字符串</strong>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-perf-查看内核堆栈">2. perf 查看内核堆栈<a class="hash-link" href="#2-perf-查看内核堆栈" title="标题的直接链接">​</a></h3><p>这个功能可以用于研究内核，查看内核中某个函数的调用关系，示例如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@debian-10:23:41:21</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> perf </span><span class="token comment" style="color:#999988;font-style:italic"># ./perf record -e probe:dev_ethtool -a -g -- sleep 100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> perf record: Woken up </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token builtin class-name">times</span><span class="token plain"> to </span><span class="token function" style="color:#d73a49">write</span><span class="token plain"> data </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> perf record: Captured and wrote </span><span class="token number" style="color:#36acaa">1.094</span><span class="token plain"> MB perf.data </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> samples</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@debian-10:23:41:56</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> perf </span><span class="token comment" style="color:#999988;font-style:italic"># ./perf report --stdio</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># To display the perf.data header info, please use --header/--header-only options.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Total Lost Samples: 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Samples: 5  of event &#x27;probe:dev_ethtool&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Event count (approx.): 5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Children      Self  Trace output      </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ........  ........  ..................</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">100.00</span><span class="token plain">%   </span><span class="token number" style="color:#36acaa">100.00</span><span class="token plain">%  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ffffffff9f5ed470</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ---0x3d4c4c4548530033</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               0x3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               ioctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               entry_SYSCALL_64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               do_syscall_64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               __x64_sys_ioctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               ksys_ioctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               do_vfs_ioctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               sock_ioctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               sock_do_ioctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               dev_ioctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               dev_ethtool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其实这个示例与第一个示例操作过程大致相同，只是在 perf record 的时候添加了一个 -g 参数，执行 perf record -h 得到了如下描述信息：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    -g                    enables call-graph recording</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我觉得这个功能挺实用的，我以前用过 dump_stack 来打印内核堆栈信息，这种方式需要修改源码，有了 perf 的这个功能几行命令就可以看函数调用信息了！</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-perf-vs-strace">3. perf vs strace<a class="hash-link" href="#3-perf-vs-strace" title="标题的直接链接">​</a></h3><p>gregg 的博客中提到了 perf 与 strace 的对比，这个内容我有点兴趣。strace 命令的原理我是比较清楚的，但是 perf 的原理我还一知半解。不过对于两者对程序性能的影响这个问题倒是已经有些研究了。</p><p>strace 的原理在 《LINUX 内核源代码情景分析》中有非常详细的描述，它与 gdb 类似，都是使用了 ptrace 系统调用来完成工作。</p><p>strace 跟踪的子进程会在系统调用执行前后都停下来，并向 strace 进程发送信号，然后 strace 执行 ptrace 获取相关的信息，再发信号到子进程恢复其执行，这意味着 strace 将会对程序的性能带来直接的影响。</p><p>下面的测试方法来自于 <a href="http://www.brendangregg.com/perf.html#StaticUserTracing" target="_blank" rel="noopener noreferrer">Linux perf Examples</a> 这篇博客。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="正常状态下的性能测试">正常状态下的性能测试<a class="hash-link" href="#正常状态下的性能测试" title="标题的直接链接">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@debian-10:23:51:36</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> perf </span><span class="token comment" style="color:#999988;font-style:italic"># dd if=/dev/zero of=/dev/null bs=512 count=10000k</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">记录了10240000+0 的读入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">记录了10240000+0 的写出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5242880000</span><span class="token plain"> bytes </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5.2</span><span class="token plain"> GB, </span><span class="token number" style="color:#36acaa">4.9</span><span class="token plain"> GiB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> copied, </span><span class="token number" style="color:#36acaa">3.77995</span><span class="token plain"> s, </span><span class="token number" style="color:#36acaa">1.4</span><span class="token plain"> GB/s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>总共花了不到 4s 的时间，速度在 1.4GB/s</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="使用-strace-跟踪下的性能测试">使用 strace 跟踪下的性能测试<a class="hash-link" href="#使用-strace-跟踪下的性能测试" title="标题的直接链接">​</a></h4><p>strace -c 选项告诉 strace 在跟踪系统调用的同时统计不同类型系统调用的执行次数。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@debian-10:23:47:54</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> perf </span><span class="token comment" style="color:#999988;font-style:italic">#  strace -c dd if=/dev/zero of=/dev/null bs=512 count=10000k</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^Cstrace: Process </span><span class="token number" style="color:#36acaa">16264</span><span class="token plain"> detached</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">% </span><span class="token function" style="color:#d73a49">time</span><span class="token plain">     seconds  usecs/call     calls    errors syscall</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------ ----------- ----------- --------- --------- ----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">50.90</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">13.133820</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">5162749</span><span class="token plain">           </span><span class="token builtin class-name">read</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">49.10</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">12.671348</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">5162748</span><span class="token plain">           </span><span class="token function" style="color:#d73a49">write</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.00</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0.000000</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">           close</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.00</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0.000000</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">           fstat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.00</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0.000000</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           lseek</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.00</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0.000000</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">           mmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.00</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0.000000</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">           mprotect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.00</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0.000000</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">           munmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.00</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0.000000</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">           brk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.00</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0.000000</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">           rt_sigaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.00</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0.000000</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.00</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0.000000</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">           dup2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.00</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0.000000</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           execve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.00</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0.000000</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           arch_prctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.00</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0.000000</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">           openat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------ ----------- ----------- --------- --------- ----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">100.00</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">25.805168</span><span class="token plain">              </span><span class="token number" style="color:#36acaa">10325540</span><span class="token plain">           total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">记录了5162748+0 的读入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">记录了5162748+0 的写出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2643326976</span><span class="token plain"> bytes </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2.6</span><span class="token plain"> GB, </span><span class="token number" style="color:#36acaa">2.5</span><span class="token plain"> GiB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> copied, </span><span class="token number" style="color:#36acaa">110.966</span><span class="token plain"> s, </span><span class="token number" style="color:#36acaa">23.8</span><span class="token plain"> MB/s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述命令已经执行了快 2 分钟还没有结束，因此我就按了 Ctrl + C 终止了。可以看到它的性能急剧下降，拷贝速度只有 23.8 MB/s。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="使用-perf-跟踪下的性能测试">使用 perf 跟踪下的性能测试<a class="hash-link" href="#使用-perf-跟踪下的性能测试" title="标题的直接链接">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@debian-10:23:51:18</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> perf </span><span class="token comment" style="color:#999988;font-style:italic"># ./perf stat -e &#x27;syscalls:sys_enter_*&#x27; dd if=/dev/zero of=/dev/null bs=512 count=10000k</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">记录了10240000+0 的读入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">记录了10240000+0 的写出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5242880000</span><span class="token plain"> bytes </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5.2</span><span class="token plain"> GB, </span><span class="token number" style="color:#36acaa">4.9</span><span class="token plain"> GiB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> copied, </span><span class="token number" style="color:#36acaa">4.62303</span><span class="token plain"> s, </span><span class="token number" style="color:#36acaa">1.1</span><span class="token plain"> GB/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Performance counter stats </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;dd if=/dev/zero of=/dev/null bs=512 count=10000k&#x27;</span><span class="token builtin class-name">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      syscalls:sys_enter_socket                                   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      syscalls:sys_enter_socketpair                                   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      syscalls:sys_enter_bind                                     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      syscalls:sys_enter_listen                                   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到它花了快 5s 的时间就拷贝完了，速度在 1.1 GB/s。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="性能损耗总结">性能损耗总结<a class="hash-link" href="#性能损耗总结" title="标题的直接链接">​</a></h4><p>使用 strace 跟踪比正常情况慢了 60.2 倍左右，使用 perf 跟踪比正常情况慢了 1.2 倍左右。</p><p>当系统调用不太频繁时 strace 与 perf 跟踪程序对程序性能的影响不会这样大，系统调用越频繁差距将会拉的越大。</p><p>这里性能测试的结果反映出了 perf 与 strace 执行过程的不同。</p><p><strong>strace 会导致子进程在执行每一个系统调用的前后都停下来，并且 strace 自身调用 ptrace 获取信息也有很大的损耗，而 perf 使用了内核中的 tracepoint 来跟踪系统调用，其信息的采集完全在内核中完成，只在最后完成的时候才会输出到用户态中，对程序性能的影响相较 strace 要低很多！</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="perf-支持多少-tracepoint-点呢">perf 支持多少 tracepoint 点呢<a class="hash-link" href="#perf-支持多少-tracepoint-点呢" title="标题的直接链接">​</a></h3><p>执行如下程序统计我使用的 5.0 内核中 tracepoing 的数目，得到了如下信息：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@debian-10:23:59:51</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> perf </span><span class="token comment" style="color:#999988;font-style:italic"># ./perf list | awk -F: &#x27;/Tracepoint event/ { lib[$1]++ } END {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> lib</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token builtin class-name">printf</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;  %-16.16s %d</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain">, l, lib</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">l</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">&#x27; </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sort</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">column</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    alarmtimer     </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">        fib            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        intel-sst      </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">       mmc            </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">        probe          </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">        sdt_hello_usdt </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        udp            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    asoc           </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">       fib6           </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        iommu          </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">        module         </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">        probe_hello_us </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        signal         </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">        v4l2           </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    block          </span><span class="token number" style="color:#36acaa">18</span><span class="token plain">       filelock       </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">       irq            </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">        mpx            </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">        probe_libc     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        skb            </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">        vb2            </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bridge         </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">        filemap        </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">        irq_matrix     </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">       msr            </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">        qdisc          </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        smbus          </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">        vmscan         </span><span class="token number" style="color:#36acaa">16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    btrfs          </span><span class="token number" style="color:#36acaa">65</span><span class="token plain">       fs_dax         </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">       irq_vectors    </span><span class="token number" style="color:#36acaa">34</span><span class="token plain">       napi           </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        random         </span><span class="token number" style="color:#36acaa">15</span><span class="token plain">       sock           </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">        vsyscall       </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cfg80211       </span><span class="token number" style="color:#36acaa">164</span><span class="token plain">      ftrace         </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">        jbd2           </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">       net            </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">       ras            </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">        spi            </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">        wbt            </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cgroup         </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">        gpio           </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">        kmem           </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">       nfsd           </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">       raw_syscalls   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">        sunrpc         </span><span class="token number" style="color:#36acaa">36</span><span class="token plain">       workqueue      </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clk            </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">       hda            </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">        kvm            </span><span class="token number" style="color:#36acaa">70</span><span class="token plain">       nmi            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        rcu            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        swiotlb        </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        writeback      </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compaction     </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">       hda_controller </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">        kvmmmu         </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">       nvme           </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">        regmap         </span><span class="token number" style="color:#36acaa">15</span><span class="token plain">       syscalls       </span><span class="token number" style="color:#36acaa">640</span><span class="token plain">      x86_fpu        </span><span class="token number" style="color:#36acaa">12</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cpuhp          </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">        hda_intel      </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">        libata         </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">        oom            </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">        regulator      </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">        task           </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">        xdp            </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    devlink        </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        huge_memory    </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">        mac80211       </span><span class="token number" style="color:#36acaa">123</span><span class="token plain">      page_isolation </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        </span><span class="token function" style="color:#d73a49">rpm</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">        tcp            </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">        xen            </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma_fence      </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">        hwmon          </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">        mce            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        pagemap        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">        rseq           </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">        thermal        </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">        xhci-hcd       </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    drm            </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">        i2c            </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">        mdio           </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        percpu         </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">        rtc            </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">       timer          </span><span class="token number" style="color:#36acaa">13</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exceptions     </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">        i915           </span><span class="token number" style="color:#36acaa">36</span><span class="token plain">       mei            </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">        power          </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">       sched          </span><span class="token number" style="color:#36acaa">24</span><span class="token plain">       tlb            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ext4           </span><span class="token number" style="color:#36acaa">105</span><span class="token plain">      initcall       </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">        migrate        </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        printk         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        scsi           </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">        ucsi           </span><span class="token number" style="color:#36acaa">7</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到它基本上覆盖了内核代码中的主要子模块，支持的系统调用的 tracepoint 的数目是 320 个左右（一个系统调用有 enter 与 exit 两个，不确定是否有不成对存在的项目）。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="标题的直接链接">​</a></h2><p>perf 的功能比我们所了解的还要多出许多，很多功能是非常实用滴，下一次需要某些功能时就执行下 perf xx -h 命令吧！</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/longyuwlz/longyu.github.io/docs/技术博客/linux-system/debug/perf/perf 程序追踪 USDT 用户态程序静态跟踪点.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/longyu.github.io/技术博客/linux-system/chroot/chroot 命令帮助信息中的几个重要问题"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">chroot 命令帮助信息中的几个重要问题</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/longyu.github.io/技术博客/linux-system/debug/strace/strace 跟踪多线程程序不能打印系统调用的问题"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">strace 跟踪多线程程序不能打印系统调用的问题</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#perf-中的-usdt" class="table-of-contents__link toc-highlight">perf 中的 usdt</a></li><li><a href="#上手-perf-的-usdt-追踪功能" class="table-of-contents__link toc-highlight">上手 perf 的 usdt 追踪功能</a></li><li><a href="#检查-usdt-是否生效" class="table-of-contents__link toc-highlight">检查 USDT 是否生效</a></li><li><a href="#perf-的其它功能" class="table-of-contents__link toc-highlight">perf 的其它功能</a><ul><li><a href="#1-追踪内核函数中某变量的值" class="table-of-contents__link toc-highlight">1. 追踪内核函数中某变量的值</a></li><li><a href="#2-perf-查看内核堆栈" class="table-of-contents__link toc-highlight">2. perf 查看内核堆栈</a></li><li><a href="#3-perf-vs-strace" class="table-of-contents__link toc-highlight">3. perf vs strace</a></li><li><a href="#perf-支持多少-tracepoint-点呢" class="table-of-contents__link toc-highlight">perf 支持多少 tracepoint 点呢</a></li></ul></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="footer__link-item">longyuwlz<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/longyu.github.io/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 龙瑜的文字世界, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/longyu.github.io/assets/js/runtime~main.c878b670.js"></script>
<script src="/longyu.github.io/assets/js/main.99377f63.js"></script>
</body>
</html>