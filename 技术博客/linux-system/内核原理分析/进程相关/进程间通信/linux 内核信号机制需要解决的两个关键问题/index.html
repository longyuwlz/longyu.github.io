<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-技术博客/linux-system/内核原理分析/进程相关/进程间通信/linux 内核信号机制需要解决的两个关键问题">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/longyu.github.io/blog/rss.xml" title="龙瑜的文字世界 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/longyu.github.io/blog/atom.xml" title="龙瑜的文字世界 Atom Feed"><title data-rh="true">linux 内核信号机制需要解决的两个关键问题 | 龙瑜的文字世界</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://longyuwlz.github.io/longyu.github.io/技术博客/linux-system/内核原理分析/进程相关/进程间通信/linux 内核信号机制需要解决的两个关键问题"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="linux 内核信号机制需要解决的两个关键问题 | 龙瑜的文字世界"><meta data-rh="true" name="description" content="前言"><meta data-rh="true" property="og:description" content="前言"><link data-rh="true" rel="canonical" href="https://longyuwlz.github.io/longyu.github.io/技术博客/linux-system/内核原理分析/进程相关/进程间通信/linux 内核信号机制需要解决的两个关键问题"><link data-rh="true" rel="alternate" href="https://longyuwlz.github.io/longyu.github.io/技术博客/linux-system/内核原理分析/进程相关/进程间通信/linux 内核信号机制需要解决的两个关键问题" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://longyuwlz.github.io/longyu.github.io/技术博客/linux-system/内核原理分析/进程相关/进程间通信/linux 内核信号机制需要解决的两个关键问题" hreflang="x-default"><link rel="stylesheet" href="/longyu.github.io/assets/css/styles.fd2463fc.css">
<link rel="preload" href="/longyu.github.io/assets/js/runtime~main.c878b670.js" as="script">
<link rel="preload" href="/longyu.github.io/assets/js/main.99377f63.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/longyu.github.io/"><div class="navbar__logo"><img src="/longyu.github.io/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/longyu.github.io/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">龙瑜的文字世界</b></a><a class="navbar__item navbar__link" href="/longyu.github.io/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/写给 hy 的文字/等待的珍贵">写给 hy 的文字</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/longyu.github.io/">笔记本开篇序言</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/大学的记录/2016 的成长">大学的记录</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/工作/少用鼠标">工作</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/思考/I believe">思考</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/longyu.github.io/技术博客/RTOS/debug/实时操作系统中调试上下文切换与中断处理汇编的一些方法">技术博客</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/RTOS/debug/实时操作系统中调试上下文切换与中断处理汇编的一些方法">RTOS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/dpdk/dpdk 依赖知识/网卡驱动绑定/将网卡绑定到官方驱动测试过程">dpdk</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/gui/android/某安卓图形化界面运行异常问题分析">gui</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux 三剑客/awk/awk 实现批量化操作探讨">linux 三剑客</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-kernel/ethtool 命令指定的网络设备名在哪里被使用？">linux-kernel</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/longyu.github.io/技术博客/linux-system/Debian/在英文版 Debian 中添加中文拼音输入法">linux-system</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/Debian/在英文版 Debian 中添加中文拼音输入法">Debian</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/EXSI/一次从 EXSI 移植 vmfstools 失败的过程记录">EXSI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/bash/bad interpreter">bash</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/chroot/chroot 命令帮助信息中的几个重要问题">chroot</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/debug/perf/perf 程序追踪 USDT 用户态程序静态跟踪点">debug</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/ebpf/tcpdump与 bpf 指令集">ebpf</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/gcc/ar/使用 ar 命令合并多个静态库">gcc</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/git/git 中子模块的使用">git</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/glibc/debug/ELF file OS ABI invalid 问题与 chroot 解决方案">glibc</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/grub/在 debian10 上编译 grub-legacy">grub</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/network/debug/at803x phy 驱动关闭节能模式">network</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/openEuler/openEuler 20.03 sp2 vmware 虚拟机启动 dmesg 信息">openEuler</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/systemd/max file descriptors for elasticsearch process is too low 问题定位">systemd</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/longyu.github.io/技术博客/linux-system/内核原理分析/netlink/cn_proc demo 中创建一个 netlink socket 背后的内核行为">内核原理分析</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/内核原理分析/netlink/cn_proc demo 中创建一个 netlink socket 背后的内核行为">netlink</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/内核原理分析/文件系统/linux 内核情景分析之 chroot 命令背后的内核态行为">文件系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/内核原理分析/用户态优化/vdso 虚拟 elf 动态共享库">用户态优化</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/内核原理分析/设备驱动/linux 中 phy 驱动框架简析">设备驱动</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/longyu.github.io/技术博客/linux-system/内核原理分析/进程相关/内核情景分析：强制杀死一个进程的执行过程">进程相关</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/longyu.github.io/技术博客/linux-system/内核原理分析/进程相关/内核情景分析：强制杀死一个进程的执行过程">内核情景分析：强制杀死一个进程的执行过程</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/longyu.github.io/技术博客/linux-system/内核原理分析/进程相关/进程间通信/linux 内核信号机制需要解决的两个关键问题">进程间通信</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-6 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/longyu.github.io/技术博客/linux-system/内核原理分析/进程相关/进程间通信/linux 内核信号机制需要解决的两个关键问题">linux 内核信号机制需要解决的两个关键问题</a></li></ul></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/内核模块/network/iptables 与 ip6tables 命令依赖的内核模块">内核模块</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/包管理系统/LD_DEBUG 加 rpm -qf 帮你快速找到 undefined symbol 符号所在的动态库及 rpm 包">包管理系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/命令实现原理分析/bash 中捕获每一个输入字符如何实现？">命令实现原理分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/哲学/UNIX 哲学">哲学</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/文件系统/sysfs/open sys file report permission denied problem">文件系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/根文件系统/构建/上手 buildroot">根文件系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/登入 linux 系统/登录 linux 的过程">登入 linux 系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/系统日志/utmp/系统崩溃重启后 utmp 日志的回收过程">系统日志</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/虚拟化/kvm/使用 virsh-console 连接到 virt-manager 中运行的 linux 虚拟机串口中">虚拟化</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/linux-system/问题案例/linux 中 xxx not found 问题的一般解决思路与 bibtex 无法找到依赖文件示例">问题案例</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/perl/perl 中的 foreach 语句">perl</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/longyu.github.io/技术博客/写博客对我的意义">写博客的意义</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/命令行使用案例/linux 中文件批量重命名">命令行使用案例</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/嵌入式/ARM/汇编函数与 c 函数的互相调用问题">嵌入式</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/技术书籍/APUE/time 输出的程序执行时间">技术书籍</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/构建系统/Makefile/Makefile 中的 @true 与 @false 命令">构建系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/测试框架/unity/unity 单元测试框架的工作原理，及隐含问题">测试框架</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/笔记本电脑问题/惠普笔记本电池无法充满问题">笔记本电脑问题</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/策略/api 功能与实现的些许感想">策略</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/计算机系统/cpu/cpu 分支预测对性能的影响">计算机系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/软件开发技巧/使用取模与累加制造一个环">软件开发技巧</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/longyu.github.io/技术博客/软件开发语言/C/c 语言中的封装">软件开发语言</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/方法论/解决问题的一些方法">方法论</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/读书笔记/终身成长/成长型思维与固定型思维">读书笔记</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/那些年写的诗歌/到不了">那些年写的诗歌</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/longyu.github.io/随笔/元旦/在几本书中跨年">随笔</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/longyu.github.io/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">技术博客</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">linux-system</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">内核原理分析</span><meta itemprop="position" content="3"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">进程相关</span><meta itemprop="position" content="4"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">进程间通信</span><meta itemprop="position" content="5"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">linux 内核信号机制需要解决的两个关键问题</span><meta itemprop="position" content="6"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>linux 内核信号机制需要解决的两个关键问题</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a class="hash-link" href="#前言" title="标题的直接链接">​</a></h2><p>信号作为一种进程间通信的方式，在 linux 中被广泛使用。我一直对信号背后的工作原理非常好奇，在本文中我将对信号机制中的几个关键问题进行研究，以期揭开信号的神秘面纱。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="从不可靠信号入手">从不可靠信号入手<a class="hash-link" href="#从不可靠信号入手" title="标题的直接链接">​</a></h2><p>信号并不是从一开始就像今天一样可靠，正相反，它最初的设计有一些严重的问题，被称为不可靠的信号。</p><p>我第一次了解到可靠信号与不可靠信号的概念，是在啃 《APUE》的时候。本文中我只针对不可靠信号进行描述。为了准确的说明不可靠信号的特征，我将从一个例子着手进行描述。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="选自apue的例子">选自《APUE》的例子<a class="hash-link" href="#选自apue的例子" title="标题的直接链接">​</a></h2><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;unistd.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;signal.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">err_sys</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">S</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">  </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression keyword" style="color:#00009f">do</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">            </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">            </span><span class="token macro property expression function" style="color:#d73a49">fprintf</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression constant" style="color:#36acaa">stderr</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;%s\n&quot;</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> S</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">while</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sig_usr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* one handler for both signals */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">signal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SIGUSR1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sig_usr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> SIG_ERR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">err_sys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;can&#x27;t catch SIGUSR1&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">signal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SIGUSR2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sig_usr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> SIG_ERR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">err_sys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;can&#x27;t catch SIGUSR2&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">pause</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sig_usr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> signo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* argument is signal number */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">signo </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> SIGUSR1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;received SIGUSR1\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">signo </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> SIGUSR2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;received SIGUSR2\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;received signal %d\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> signo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>编译上述程序，后台运行生成的 a.out 文件，然后向这个进程发送三次 SIGUSR1 信号。</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ gcc </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">signal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kill </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">USR1 </span><span class="token number" style="color:#36acaa">6443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">received SIGUSR1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kill </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">USR1 </span><span class="token number" style="color:#36acaa">6443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">received SIGUSR1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kill </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">USR1 </span><span class="token number" style="color:#36acaa">6443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">received SIGUSR1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 debian 10 系统中，上面的测试结果并不符合预期。<strong>预期的效果是在第二次向程序发送 SIGUSR1 的时候程序被杀死</strong>。这就是不可靠信号的特点，<strong>信号处理函数执行一次后就会被重置为默认值</strong>，<strong>默认值的响应方式是杀死进程</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="为什么-signal-函数的行为变化了">为什么 signal 函数的行为变化了？<a class="hash-link" href="#为什么-signal-函数的行为变化了" title="标题的直接链接">​</a></h2><p>man signal 获取到如下相关信息：</p><div class="language-manual codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-manual codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       The situation on Linux is as follows:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       * The kernel&#x27;s signal() system call provides System V semantics.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       * By default, in glibc 2 and later, the signal() wrapper function does not invoke the kernel system call.  Instead, it calls sigaction(2) using flags that supply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         BSD semantics.  This default behavior is provided as long as a suitable feature test macro is defined: _BSD_SOURCE on glibc 2.19 and earlier or _DEFAULT_SOURCE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         in  glibc  2.19  and later.  (By default, these macros are defined; see feature_test_macros(7) for details.)  If such a feature test macro is not defined, then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         signal() provides System V semantics.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述内容说明了如下两点内容：</p><ol><li>linux 内核的 signal 系统调用与 System V 系统中的 signal 系统调用行为一致</li><li>glibc 2 以及之后的版本，libc 库中的 signal 函数与 BSD 系统中 signal 系统调用行为一致</li></ol><p>上面的说明指出如果 feature test macro 没有定义，libc 库中提供的 signal 函数的行为将与 System V 系统保持一致。</p><p>一通研究确定可以使用 -std=c90 选项编译来使用与 System V 中行为一致的 signal 函数：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ gcc signal.c -std</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">c90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./a.out </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7513</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">kill</span><span class="token plain"> -USR1 </span><span class="token number" style="color:#36acaa">7513</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">received SIGUSR1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">kill</span><span class="token plain"> -USR1 </span><span class="token number" style="color:#36acaa">7513</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">+  用户定义信号 </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">    ./a.out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ pgrep a.out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 -std=c90 指定使用 c90 标准来编译程序，第二次向程序发送 SIGUSR1 信号之后，程序被杀死，符合不可靠信号的特征。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="中断-vs-信号">中断 vs 信号<a class="hash-link" href="#中断-vs-信号" title="标题的直接链接">​</a></h2><p>信号是对硬件中断的模拟，中断有中断向量表，信号也有信号向量表，相应的中断处理需要考虑嵌套中断的情况，信号处理也需要考虑信号嵌套的情况。</p><p>中断处理过程中当一个本地中断的处理程序执行的时候会暂时性的关闭本地中断，保证中断程序的串行执行，但是这意味着在中断服务程序执行的这个窗口期间，<strong>新接收到的同级中断会被丢失</strong>，这就是为什么<strong>中断服务程序要写的尽可能短</strong>的主要原因。</p><p>信号嵌套也需要解决类似的问题，场景是在执行一个信号处理函数的窗口中再次接收到同一个信号处理函数的情况。</p><p>下面的内容摘自《Linux 内核源代码情景分析》：</p><blockquote><p>使用不可靠信号的实现时，由内<strong>核自动将&quot;信号向量表&quot; 中相应的函数指针设置成 SIG_DFL</strong>。从而在执行一个信号处理程序的时候如果又接收到了同种信号的话，就会因为此时的”信号向量“ 已经修改为了 SIG_DFL 而不会嵌套进入同一个处理程序。</p></blockquote><blockquote><p>这样这种信号的注册的信号处理函数就是&quot;一次性的&quot;，信号处理函数执行完信号处理过程后需要<strong>重新调用 signal 来再次设置信号向量</strong>，为下一次执行同一信号处理程序做好准备。</p></blockquote><blockquote><p>当信号非常密集的时候，可能在刚进入信号处理程序，还没有重新设置信号向量之前就又收到了一个同种类型的信号，这时信号处理程序已经被重置为 SIG_DFL默认行为，而对 SIG_DFL 的默认反应又是结束程序的运行，所以第二个相同类型的信号到来时就会把程序杀死，因为这样，这种信号机制被称为&quot;不可靠信号&quot;</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="strace-跟踪">strace 跟踪<a class="hash-link" href="#strace-跟踪" title="标题的直接链接">​</a></h2><p>执行 <code>strace ./a.out &amp;</code>命令跟踪程序的执行过程，发送信号给目标程序后，信号处理过程涉及下面几个系统调用：</p><div class="language-strace codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-strace codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kill -USR1 13225</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pause()                                 = ? ERESTARTNOHAND (To be restarted if no handler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- SIGUSR1 {si_signo=SIGUSR1, si_code=SI_USER, si_pid=5380, si_uid=1000} ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fstat(1, {st_mode=S_IFCHR|0620, st_rdev=makedev(0x88, 0x3), ...}) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brk(NULL)                               = 0x564512f26000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brk(0x564512f47000)                     = 0x564512f47000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">write(1, &quot;received SIGUSR1\n&quot;, 17received SIGUSR1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)      = 17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rt_sigreturn({mask=[]})                 = -1 EINTR (被中断的系统调用)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第一行的输出表示 pause 系统调用被打断，第二行的输出能够看到进程收到了一个 SIGUSR1 信号及发送者的信息。SI_USER 表示信号从用户态程序发送，si_pid 与 si_uid 表示发送信号的程序的 pid 与 uid，这两个字段用于信号的权限控制。</p><p>fstat、brk、write 这几个系统调用都是 printf 执行的过程中调用到的，write 系统调用执行后 printf 函数完成，最后一行输出表明程序调用了 <strong>rt_sigreturn</strong> 系统调用。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="信号处理的流程">信号处理的流程<a class="hash-link" href="#信号处理的流程" title="标题的直接链接">​</a></h2><p>在进一步的描述前，从《Linux 内核源代码情景分析》中摘录下图以说明信号处理的流程。
<img loading="lazy" src="https://img-blog.csdnimg.cn/20201219103839514.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xvbmd5dV93bHo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" class="img_ev3q">
从图 6.6 能够看出进程对信号的响应与执行是在从系统空间返回用户空间的过程中做的，信号处理程序在用户空间中执行，执行完成后会再次返回到内核中，恢复到之前正在执行的断点。</p><p><strong>关键的步骤在于跳转到信号处理程序执行以及信号程序执行完成后返回内核后恢复之前被中断的现场继续执行。</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何从内核态跳转到用户态信号处理程序开始执行">如何从内核态跳转到用户态信号处理程序开始执行<a class="hash-link" href="#如何从内核态跳转到用户态信号处理程序开始执行" title="标题的直接链接">​</a></h3><p>在继续阅读前，建议先阅读下 <a href="https://blog.csdn.net/Longyu_wlz/article/details/100130013?ops_request_misc=%25257B%252522request%25255Fid%252522%25253A%252522160838234716780271152002%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fblog.%252522%25257D&amp;request_id=160838234716780271152002&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v1~rank_blog_v1-1-100130013.pc_v1_rank_blog_v1&amp;utm_term=%E7%AC%AC%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1" target="_blank" rel="noopener noreferrer">移植实时操作系统到 risc-v 架构芯片时上下文切换的实现</a> 这篇博客。</p><p>进程的上下文切换与子函数调用类似，它从一个执行流切换到另外一个执行流，核心的栈帧的切换，而函数调用过程正是是由栈帧维持的。</p><p>更具体点讲，<strong>每个任务的栈帧都维持了任务当前执行的一个快照</strong>，恢复到某个任务开始执行，其实就是从栈帧中拿出一份<strong>机器的现场</strong>，<strong>一份寄存器集合的值</strong>，恢复这些值到相应的寄存器中即完成了切换的过程。</p><p>如果在寄存器集合的基础上再细化一下，那可以说改变执行流就是通过<strong>修改 pc 寄存器来完成的</strong>，这是物理机器的特征。</p><p>类比我们这里需要解决的问题，从内核中返回用户态并跳转到信号处理程序开始执行，一定要涉及对 pc 的修改，可是要怎么完成呢？</p><p>我们都知道用户态进入内核态需要通过系统调用来完成，但是系统调用本身属于一种同步异常，类比异常的执行流程，它也涉及保存用户态现场的工作，在 linux 中这个现场由 pt_regs 寄存器结构体集合来描述。</p><p>当进入内核态执行的时候 pt_regs 代表的进程的用户态 cpu 现场会保存到进程的内核态栈帧中，同时当进程返回内核态时，内核态栈帧中保存的 pt_regs 维持的现场会恢复到 cpu 寄存器中。</p><p>如下内容摘自《linux 内核源代码情景分析》</p><blockquote><p>在返回到用户空间前夕，系统空间堆栈的内容，也就是指针 regs 所指向的 pt_regs 数据结构，实际上就是一个框架。这个框架决定了当处理器返回到用户空间时从何处继续执行指令，用户空间堆栈在何处以及各个寄存器的内容。现在既然要求处理器在回到用户空间的时候要执行另一段程序，就得在用户空间堆栈中为之准备一个不同的框架。
可是，最终还是要会到当初做出系统调用或者被中断的地方去，所以原先的框架不能丢掉，要保存起来。保存在哪里呢？一个进程的系统空间堆栈大小是很有限的，所以最合理的就是把它作为信号处理程序的附加局部量，也就是保存在进程的用户空间堆栈中的因调用该处理程序而形成的框架中。这样，就有必要在进入用户空间执行信号处理程序之前，就准备好用户空间堆栈中的框架，只有如此才能先把原来的框架复制到用户空间的框架中作为局部量保存起来，回到系统空间中以后再从那里复制回来。
框架的形成是在程序运行过程中，特别是在子程序调用的过程中自然形成的，但是框架的形成有规律可循。现在尚未执行对信号处理程序的调用，当然也不存在调用该处理程序的框架，所以实际上是按照形成框架的规律先作好准备，预先在用户空间堆栈中打下一些埋伏。</p></blockquote><p>这段描述总结一下就是，我们首先需要将内核态现场保存到进程的用户态栈帧中，然后按照子函数调用的规律，插入一个对信号处理程序调用的框架，这样当返回到用户态时就能够执行信号处理程序。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="以-riscv-架构为例研究从内核态返回用户态信号处理程序前执行的关键流程">以 riscv 架构为例研究从内核态返回用户态信号处理程序前执行的关键流程<a class="hash-link" href="#以-riscv-架构为例研究从内核态返回用户态信号处理程序前执行的关键流程" title="标题的直接链接">​</a></h3><p>从内核源码树 arch/riscv/kernel/signal.c 文件中摘录如下代码：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">215</span><span class="token plain"> regs</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">sepc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">ksig</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ka</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sa_handler</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">216</span><span class="token plain"> regs</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">sp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">217</span><span class="token plain"> regs</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">a0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ksig</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                     </span><span class="token comment" style="color:#999988;font-style:italic">/* a0: signal number */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">218</span><span class="token plain"> regs</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">a1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">frame</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* a1: siginfo pointer */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">219</span><span class="token plain"> regs</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">frame</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">uc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">/* a2: ucontext pointer */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这段代码摘自 <strong>setup_rt_frame</strong> 函数中，它就是跳转到用户态信号处理程序执行前内核调整用户态堆栈的关键所在。</p><p>215 行将信号处理程序的地址赋值给 <strong>pt_regs</strong> 结构中的 <strong>sepc</strong> 字段，这个字段就是<strong>返回用户态时将会被赋值给 pc 的值</strong>。</p><p>216 行设定<strong>栈顶指针为调整后的 frame 的位置</strong>，这个 frame 中已经存放了内核态的断点现场。</p><p>217-219 行设定用户态信号处理程序的三个参数——信号 number，siginfo 的地址，ucontext 的地址。</p><p>pt_regs 中的内容在返回用户态前被恢复到 cpu 寄存器中，这样回到用户态就会从信号处理函数开始执行。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何从用户态信号处理函数中返回到内核态">如何从用户态信号处理函数中返回到内核态？<a class="hash-link" href="#如何从用户态信号处理函数中返回到内核态" title="标题的直接链接">​</a></h3><p>解决了上面的问题后，从用户态信号处理函数返回内核态又成为了下一个重点问题。《Linux内核源代码情景分析中》描述中提到，这一过程是通过内核自动向用户态栈帧中插入调用 sigreturn 系统调用的指令来实现的。</p><p>调整后的用户态堆栈内容如下：
<img loading="lazy" src="https://img-blog.csdnimg.cn/20201219224923968.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xvbmd5dV93bHo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" class="img_ev3q">
图 6.7 中，pretcode 指向内核自动插入的指令的起始位置，并且由于这里是返回到信号处理程序执行，而非 call 调用，则 pretcode 实际上就是信号处理程序执行完成后将取出的返回地址。</p><p>原书中相关的代码如下图：
<img loading="lazy" src="https://img-blog.csdnimg.cn/20201219225737506.png" alt="在这里插入图片描述" class="img_ev3q">
写到这里应该算已经解决了从用户态程序返回到内核态的问题，但是这里其实隐含了一个非常重要的点。</p><p>从图 6.7 中可以看出，内核自动插入的代码其位置是在<strong>用户空间栈帧中</strong>，而用户空间栈帧一般是<strong>没有执行权限的</strong>，也没有看到介绍设定页面执行权限的内容，我想肯定是原书中描述的内核版本没有这种严格的限定，故而能够这样玩，而高版本的内核中已经不能这样玩了。</p><p>高版本内核中 x86-64 架构使用如下玩法：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ksig</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ka</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sa_flags </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> SA_RESTORER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        restorer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ksig</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ka</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sa_restorer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Set up to return from userspace.  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    err </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__put_user</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">restorer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">frame</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pretcode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里的核心在于将 frame-&gt;pretcode 指向一个 restorer，这个 restorer 在我们这个情境中最终生效的将是 libc 中提供的版本，同时也由于 libc 库代码被 mmap 的页有执行权限，就解决了在栈中插入代码缺少执行权限的问题。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sa_restorer-是被谁注册的">sa_restorer 是被谁注册的？<a class="hash-link" href="#sa_restorer-是被谁注册的" title="标题的直接链接">​</a></h3><p>man rt_sigreturn 系统调用获取到了如下重要信息：</p><div class="language-manual codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-manual codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       Once upon a time, UNIX systems placed the signal trampoline code onto the user stack.  Nowadays, pages of the user stack are protected so as to disallow code ex‐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ecution.  Thus, on contemporary Linux systems, depending on the architecture, the signal trampoline code lives either in the vdso(7) or in the C library.  In the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       latter  case,  the  C library&#x27;s sigaction(2) wrapper function informs the kernel of the location of the trampoline code by placing its address in the sa_restorer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       field of the sigaction structure, and sets the SA_RESTORER flag in the sa_flags field.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这段内容首先说明了我在上文中提到的由于用户态栈帧不具有执行权限，导致插入在用户态栈帧中的代码无法执行的问题。</p><p>此后，它描述了当前 Linux 系统中解决这个问题的两种不同方式：</p><ol><li>使用 vdso 这个内核动态库中提供的代码</li><li>使用 c 库中提供的代码</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="c-库注册-sa_restorer-的方式">c 库注册 sa_restorer 的方式<a class="hash-link" href="#c-库注册-sa_restorer-的方式" title="标题的直接链接">​</a></h4><p>对于使用 c 库中提供的代码这种方式，c 库的 sigaction 封装函数将会将返回内核态的代码的起始地址放到 sigaction 结构体的 sa_restorer 字段中，并设定 sa_flags 的 SA_RESTORER 标志来完成。可以理解为，c 库替代用户隐藏了信号处理函数返回用户态函数的注册过程，实际上这个函数就是在注册信号处理函数的时候也随之注册的。</p><p>重新使用上文中选自《APUE》的例子来测试，使用 strace 跟踪 signal 函数执行的系统调用，得到了如下信息：</p><div class="language-strace codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-strace codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rt_sigaction(SIGUSR1, {sa_handler=0x5617d68341f2, sa_mask=[], sa_flags=SA_RESTORER|SA_INTERRUPT|SA_NODEFER|SA_RESETHAND, sa_restorer=0x7f451f401840}, {sa_handler=SIG_DFL, sa_mask=[], sa_flags=0}, 8) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rt_sigaction(SIGUSR2, {sa_handler=0x5617d68341f2, sa_mask=[], sa_flags=SA_RESTORER|SA_INTERRUPT|SA_NODEFER|SA_RESETHAND, sa_restorer=0x7f451f401840}, {sa_handler=SIG_DFL, sa_mask=[], sa_flags=0}, 8) = 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里 sa_restorer 的值为 0x7f451f401840，pmap 查看程序的虚拟内存空间，得到了如下信息：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ pmap -p </span><span class="token number" style="color:#36acaa">26267</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">26267</span><span class="token plain">:   ./a.out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00005617d6833000      4K r---- /tmp/a.out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00005617d6834000      4K r-x-- /tmp/a.out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00005617d6835000      4K r---- /tmp/a.out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00005617d6836000      4K r---- /tmp/a.out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00005617d6837000      4K rw--- /tmp/a.out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007f451f3ca000    136K r---- /usr/lib/x86_64-linux-gnu/libc-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007f451f3ec000   1312K r-x-- /usr/lib/x86_64-linux-gnu/libc-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007f451f534000    304K r---- /usr/lib/x86_64-linux-gnu/libc-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007f451f580000      4K ----- /usr/lib/x86_64-linux-gnu/libc-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007f451f581000     16K r---- /usr/lib/x86_64-linux-gnu/libc-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007f451f585000      8K rw--- /usr/lib/x86_64-linux-gnu/libc-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007f451f587000     24K rw---   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> anon </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007f451f5b1000      4K r---- /usr/lib/x86_64-linux-gnu/ld-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007f451f5b2000    120K r-x-- /usr/lib/x86_64-linux-gnu/ld-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007f451f5d0000     32K r---- /usr/lib/x86_64-linux-gnu/ld-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007f451f5d8000      4K r---- /usr/lib/x86_64-linux-gnu/ld-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007f451f5d9000      4K rw--- /usr/lib/x86_64-linux-gnu/ld-2.28.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007f451f5da000      4K rw---   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> anon </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007fffa1d1e000    136K rw---   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> stack </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007fffa1dd1000     12K r----   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> anon </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007fffa1dd4000      8K r-x--   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> anon </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> total             2148K</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以确定这个地址位于 libc 库中。使用 <a href="https://blog.csdn.net/Longyu_wlz/article/details/109397938?ops_request_misc=%25257B%252522request%25255Fid%252522%25253A%252522160839266216780276340278%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fblog.%252522%25257D&amp;request_id=160839266216780276340278&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v1~rank_blog_v1-1-109397938.pc_v1_rank_blog_v1&amp;utm_term=mtrace" target="_blank" rel="noopener noreferrer">使用 mtrace 追踪内存泄露问题</a> 这篇博客中提到的计算代码偏移量的方法，使用 0x7f451f401840 - 00007f451f3ca000 得到地址为 37840，反汇编 libc 库查找这个地址获取到如下信息：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ objdump -d /usr/lib/x86_64-linux-gnu/libc-2.28.so </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> -A </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;37840&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">37840</span><span class="token plain">:   </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"> c7 c0 0f 00 00 00    mov    </span><span class="token variable" style="color:#36acaa">$0xf</span><span class="token plain">,%rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">37847</span><span class="token plain">:   0f 05                   syscall </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>mov 指令设定系统调用号为 f，在我的机器上 <strong>/usr/include/asm/unistd_64.h</strong> 中 f 对应的系统调用定义如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">19</span><span class="token plain"> #define __NR_rt_sigreturn </span><span class="token number" style="color:#36acaa">15</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以确定这里使用的系统调用号对应的就是 sigreturn 系统调用，设定了系统调用号后，执行 syscall 进入内核就完成了所有的过程。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="vdso-注册-sa_restorer-的方式">vdso 注册 sa_restorer 的方式<a class="hash-link" href="#vdso-注册-sa_restorer-的方式" title="标题的直接链接">​</a></h4><p>vdso 是内核提供的一个加速系统调用执行过程的动态库，它由内核初始化的时候加载，并为所有的程序共享。</p><p>继续从内核源码树 arch/riscv/kernel/signal.c 文件中摘录如下代码：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Set up to return from userspace. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    regs</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ra </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">VDSO_SYMBOL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        current</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mm</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vdso</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rt_sigreturn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这行代码也同样出自 <strong>setup_rt_frame</strong> 函数中，在 riscv 架构中，<strong>ra</strong> 全称为 <strong>return address</strong>，它被用来保存返回地址，它与 x86 中 <strong>pretcode</strong> 字段的功能一致。</p><p>x86 没有这样设计的原因在于 x86 中没有专门设计一个保存返回地址的寄存器，只能够依靠栈帧来完成，所以其过程相对复杂。</p><p>VDSO_SYMBOL 类似于用户态的 dlsym 函数，可以从动态库中检索到函数的地址。</p><p>rt_sigreturn 函数位于 <strong>arch/riscv/kernel/vdso/rt_sigreturn.S</strong> 中，其代码如下：</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    .text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENTRY(__vdso_rt_sigreturn)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .cfi_startproc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .cfi_signal_frame</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    li a7, __NR_rt_sigreturn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scall</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .cfi_endproc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENDPROC(__vdso_rt_sigreturn)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>li 指令将 rt_sigreturn 系统调用的系统调用号加载到 a7 寄存器中，然后调用 scall 指令触发系统调用，与我上文描述的 c 库中的 x86 汇编代码功能类似。同时需要说明的是 vdso 这个内核提供的动态库也一定被映射到用户态空间中，这也是一个值得研究的点，后面可能会写文章专门研究下。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="标题的直接链接">​</a></h2><p>在完成本篇博文的过程中，着实遇到了一些问题。从 stackoverflow 中找的示例代码尝试编写自己的信号 restorer 函数，这个函数用汇编写的，写完后第一次测试发现没有啥问题。</p><p>可是当我在本文中描述到相关内容时，我发现我忽略了一个非常重要的点，其实我自己写的信号 restorer 函数根本没有生效，使用的还是 c 库中的版本，之后又尝试了一下使用 syscall 来调用结果也没成功，看了 glibc 里的相关代码，要比想象中复杂的多，只能先放弃了！</p><p>同时 x86 架构中信号的处理与用户态栈帧与内核态栈帧切换这些都有些过于复杂了，而 riscv 这种 RISC 架构就实现的非常简单。尽管指令集变化了，但是核心的过程是一致的，没必要死磕 x86，研究 riscv 架构马上海阔天空！</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/longyuwlz/longyu.github.io/docs/技术博客/linux-system/内核原理分析/进程相关/进程间通信/linux 内核信号机制需要解决的两个关键问题.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/longyu.github.io/技术博客/linux-system/内核原理分析/进程相关/内核情景分析：强制杀死一个进程的执行过程"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">内核情景分析：强制杀死一个进程的执行过程</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/longyu.github.io/技术博客/linux-system/内核模块/network/iptables 与 ip6tables 命令依赖的内核模块"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">iptables 与 ip6tables 命令依赖的内核模块</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#从不可靠信号入手" class="table-of-contents__link toc-highlight">从不可靠信号入手</a></li><li><a href="#选自apue的例子" class="table-of-contents__link toc-highlight">选自《APUE》的例子</a></li><li><a href="#为什么-signal-函数的行为变化了" class="table-of-contents__link toc-highlight">为什么 signal 函数的行为变化了？</a></li><li><a href="#中断-vs-信号" class="table-of-contents__link toc-highlight">中断 vs 信号</a></li><li><a href="#strace-跟踪" class="table-of-contents__link toc-highlight">strace 跟踪</a></li><li><a href="#信号处理的流程" class="table-of-contents__link toc-highlight">信号处理的流程</a><ul><li><a href="#如何从内核态跳转到用户态信号处理程序开始执行" class="table-of-contents__link toc-highlight">如何从内核态跳转到用户态信号处理程序开始执行</a></li><li><a href="#以-riscv-架构为例研究从内核态返回用户态信号处理程序前执行的关键流程" class="table-of-contents__link toc-highlight">以 riscv 架构为例研究从内核态返回用户态信号处理程序前执行的关键流程</a></li><li><a href="#如何从用户态信号处理函数中返回到内核态" class="table-of-contents__link toc-highlight">如何从用户态信号处理函数中返回到内核态？</a></li><li><a href="#sa_restorer-是被谁注册的" class="table-of-contents__link toc-highlight">sa_restorer 是被谁注册的？</a></li></ul></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="footer__link-item">longyuwlz<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/longyu.github.io/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/longyuwlz" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 龙瑜的文字世界, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/longyu.github.io/assets/js/runtime~main.c878b670.js"></script>
<script src="/longyu.github.io/assets/js/main.99377f63.js"></script>
</body>
</html>